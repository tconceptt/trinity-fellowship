/**
 * Reads data/members.csv and generates supabase/seed.sql
 * with INSERT statements for the members table.
 *
 * Usage: node scripts/generate-seed-sql.mjs
 */

import { readFileSync, writeFileSync, mkdirSync } from "fs";
import { dirname, join } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const root = join(__dirname, "..");

const csv = readFileSync(join(root, "data/members.csv"), "utf-8");
const lines = csv.split("\n").filter((l) => l.trim());

// Skip header row
const rows = lines.slice(1);

/**
 * Normalize an Ethiopian phone number to +251XXXXXXXXX format.
 * Returns null if the input can't be parsed.
 */
function normalizePhone(raw) {
  if (!raw) return null;

  // Strip all whitespace, dashes, dots, parentheses, and stray characters
  let digits = raw.replace(/[\s\-\.\(\)]/g, "").replace(/\.+/g, "");

  // Remove leading +
  if (digits.startsWith("+")) digits = digits.substring(1);

  // US number special case (Oksana): starts with 1 and has 11 digits
  if (digits.startsWith("1") && digits.length === 11) {
    return "+" + digits;
  }

  // Already has 251 prefix and correct length (12 digits total)
  if (digits.startsWith("251") && digits.length === 12) {
    return "+" + digits;
  }

  // Starts with 251 but has extra/fewer digits — still try
  if (digits.startsWith("251") && digits.length >= 12) {
    return "+" + digits.substring(0, 12);
  }

  // Starts with 0 and is 10 digits (local format 09XXXXXXXX)
  if (digits.startsWith("0") && digits.length === 10) {
    return "+251" + digits.substring(1);
  }

  // 9 digits starting with 9 (missing country code)
  if (digits.startsWith("9") && digits.length === 9) {
    return "+251" + digits;
  }

  // Fallback: if we have digits, return them prefixed
  if (digits.length >= 9) {
    // Assume Ethiopian
    if (!digits.startsWith("251")) {
      return "+251" + digits;
    }
    return "+" + digits;
  }

  return null;
}

/** Escape single quotes for SQL */
function esc(str) {
  return str.replace(/'/g, "''");
}

const members = [];

for (const row of rows) {
  // Parse CSV — simple split since no fields contain commas
  const cols = row.split(",");

  const name = (cols[1] || "").trim();
  let email = (cols[2] || "").trim().toLowerCase();
  const phoneRaw = (cols[3] || "").trim();

  if (!name) continue;

  // Remove spaces inside email addresses (e.g., "kenuya@ hotmail.com")
  email = email.replace(/\s+/g, "");

  // Skip clearly invalid emails (missing @, no dot after @)
  if (email && (!email.includes("@") || !email.split("@")[1]?.includes("."))) {
    // tibarekekjcagmail.com — missing @, skip email
    email = "";
  }

  const phone = normalizePhone(phoneRaw);

  members.push({ name, email: email || null, phone });
}

// Generate SQL
const sqlLines = [
  "-- Generated by scripts/generate-seed-sql.mjs",
  "-- Run this in the Supabase SQL Editor after creating the members table.",
  "",
  "INSERT INTO public.members (full_name, email, phone) VALUES",
];

const valueRows = members.map((m, i) => {
  const name = `'${esc(m.name)}'`;
  const email = m.email ? `'${esc(m.email)}'` : "NULL";
  const phone = m.phone ? `'${esc(m.phone)}'` : "NULL";
  const comma = i < members.length - 1 ? "," : ";";
  return `  (${name}, ${email}, ${phone})${comma}`;
});

sqlLines.push(...valueRows);

mkdirSync(join(root, "supabase"), { recursive: true });
const outPath = join(root, "supabase/seed.sql");
writeFileSync(outPath, sqlLines.join("\n") + "\n");

console.log(`Generated ${outPath} with ${members.length} members.`);

// Print summary
const withEmail = members.filter((m) => m.email).length;
const withPhone = members.filter((m) => m.phone).length;
const neither = members.filter((m) => !m.email && !m.phone).length;
console.log(`  ${withEmail} with email, ${withPhone} with phone, ${neither} with neither.`);
