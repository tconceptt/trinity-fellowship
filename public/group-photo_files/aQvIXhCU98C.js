;/*FB_PKG_DELIM*/

__d("ACTSanitizerApiTypes",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({Valid:0,UrlFailure:1,MessageTextFailure:2,CtaFailure:3});i.ACTSanitizerValidationResult=e}),66);
__d("ACTSanitizerApiWasm",["ACTSanitizerApiTypes","FBLogger","WAArmadilloXMA.pb","WAResolvable","WATagsLogger","WAWasmModuleCache","actsanitizer_api_v2","asyncToGeneratorRuntime","bx","encodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=r("bx").getURL(r("bx")("30948")),f=o("WATagsLogger").TAGS(["ACTSanitizerWasm"]);function g(){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=new(o("WAResolvable")).Resolvable,n=r("actsanitizer_api_v2")({instantiateWasm:function(a,i){return o("WAWasmModuleCache").loadWasmModule(_).then(function(e){return WebAssembly.instantiate(e,a)}).then(function(n){f.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["instantiateWasm succeeded"]))),i(n),t.resolve()}).catch(function(e){f.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["WebAssembly.instantiate failed with error: ",""])),r("getErrorSafe")(e).toString()),t.reject(e)}),{}}}).catch(function(e){throw f.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["initWasm failed with error: ",""])),r("getErrorSafe")(e).toString()),t.reject(e),e}),a=yield t.promise.then(function(){return n});return{getWasmMemorySize:function(){var e;return(e=a.wasmMemory)==null?void 0:e.buffer.byteLength},isMessageTextValid:function(t){try{var e=new TextEncoder,n=e.encode(t),i=a._malloc(n.byteLength);a.HEAPU8.set(n,i);var l=a._ACTSanitizer_isMessageTextValid(i,n.byteLength);a._free(i);var s=o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.cast(l);if(s==null)throw r("FBLogger")("messenger_web").mustfixThrow("ACT Sanitizer WASM module returned invalid validation result");return s}catch(e){throw f.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["isMessageTextValid runtime error: ",""])),r("getErrorSafe")(e).toString()),e}},isXMAValid:function(t){var e,n;try{n=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloXMA.pb").ExtendedContentMessageSpec,t).readByteArrayView(),e=a._malloc(n.byteLength),a.HEAPU8.set(n,e);var i=a._ACTSanitizer_isXMAValid(e,n.byteLength),l=o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.cast(i);if(l==null)throw f.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["module returned invalid validation result: ",""])),l),r("FBLogger")("messenger_web").mustfixThrow("ACTSanitizerWasm module returned invalid validation result");return f.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["isXMAValid succeeded with result: ",""])),l),l}catch(e){var s,u,c,_;throw f.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["isXMAValid runtime error: ",". Final memory allocation: ",". input page size: ",". xma target type: ",""])),r("getErrorSafe")(e).toString(),(s=y((u=a.wasmMemory)==null?void 0:u.buffer.byteLength))!=null?s:"unknown",(c=y((_=n)==null?void 0:_.byteLength))!=null?c:"unknown",t.targetType),e}finally{e!=null&&a._free(e)}}}}),h.apply(this,arguments)}function y(e){return e==null?null:Math.ceil(e/65536)}l.ACTSanitizerWasm=g}),98);
__d("ACTSanitizerApiLazyLoader",["ACTSanitizerApiWasm"],(function(t,n,r,o,a,i,l){"use strict";var e=null,s=1024*1024;function u(){e==null&&(e=o("ACTSanitizerApiWasm").ACTSanitizerWasm());var t=e;return t.then(function(t){var n=t.getWasmMemorySize();n!=null&&n>=s&&(e=o("ACTSanitizerApiWasm").ACTSanitizerWasm())}),t}l.loadACTSanitizerApi=u}),98);
__d("CoalescingLoader",["Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(){return new(e||(e=n("Promise")))(function(e){return globalThis.setTimeout(e,0)})}var s=(function(){function e(e,t){t===void 0&&(t=l),this.$1=e,this.$2=[],this.$3=null,this.$4=t}var t=e.prototype;return t.gen=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){this.$2.push(e);var t=this.$2.length-1,n=yield this.$5();return n[t]});function t(t){return e.apply(this,arguments)}return t})(),t.$5=function(){return this.$3!=null?this.$3:(this.$3=this.$6(),this.$3)},t.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield this.$4();var e=this.$2;return this.$2=[],this.$3=null,this.$1([].concat(e))});function t(){return e.apply(this,arguments)}return t})(),e})();i.CoalescingLoader=s}),66);
__d("EBAPI",["MAWEBCombinedSwitch","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(e=r("requireDeferred"))("EBAPIMinosVerifySingleEpoch").__setRef("EBAPI"),u=e("EBAPIWriteMinosPublicKeysForRecipient").__setRef("EBAPI"),c=e("EBGetContactEpochHead").__setRef("EBAPI"),d=e("EBGetMessageKeys").__setRef("EBAPI"),m=e("EBIsEbEnabled").__setRef("EBAPI"),p=e("EBMinosWriteKeyChangeAdminMessage").__setRef("EBAPI"),_=e("EBMinosWriteSecureStorageAlert").__setRef("EBAPI"),f={getContactEpochHead:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return c.load().then(function(e){return e.getContactEpochHead.apply(e,t)})},getMessageKeys:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return d.load().then(function(e){return e.getMessageKeys.apply(e,t)})},isEBEnabled:function(){return o("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled()},isEbEnabledEbSwitch:function(){return m.load().then(function(e){return e.isEbEnabledEbSwitch()})},minosVerifySingleEpoch:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return s.load().then(function(e){return e.minosVerifySingleEpoch.apply(e,t)})},writeMinosKeyChangeAdminMessage:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return p.load().then(function(e){return e.writeMinosKeyChangeAdminMessage.apply(e,t)})},writeMinosMailboxKeysForRecipientAPI:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return u.load().then(function(e){return e.writeMinosMailboxKeysForRecipientAPI.apply(e,t)})},writeMinosSecureStorageAlert:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return _.load().then(function(e){return e.writeMinosSecureStorageAlert.apply(e,t)})}},g=f;l.default=g}),98);
__d("EBAPIConvertNativeToLS",["I64","LSDict","LSShape","LSVec"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return{decrypted_protobuf:t.decryptedProtobuf,protobuf_timestamp_ms:(e||(e=o("I64"))).of_float(t.protobufTimestampMs)}}function u(e,t){var n=r("LSVec").ofArray(e.map(function(e){return e.value}).filter(Boolean)),o=r("LSVec").ofArray(t.map(function(e){return c(e)}).filter(Boolean));return{echo:n,protobuf:o}}function c(e){var t=e.topLevelProtobuf,n=e.supplementalProtobufs,a=e.otid;if(a!=null){var i=new Map;n.forEach(function(e,t){var n=o("LSShape").ofRecord(s(e));i.set(t,n)});var l={otid:a,supplemental_protobufs:new(r("LSDict"))(i),tags:e.messageTags.map(function(e){return e}),toplevel_protobuf:o("LSShape").ofRecord(s(t))};return o("LSShape").ofRecord(l)}}l.convertNativeProtobufToLSType=s,l.convertNativeDecryptionResponseToDecryptedMessageType=u,l.convertDecryptedProtobufMessageToLSNativeType=c}),98);
__d("MEBEncryptionVersion",[],(function(t,n,r,o,a,i){var e=Object.freeze({UNKNOWN:0,ENCRYPTION_KDF_WITH_VERSION:2,ENCRYPTION_KDF_WITH_NULL_SALT:3,ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY:4,TEST_VERSION:99});i.default=e}),66);
__d("EBCryptoUtils",["Base64Utils","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","MEBEncryptionVersion","SymmetricEncryptionCreateEncryptedData","SymmetricEncryptionPaddingUtils","XPlatReactCrypto","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=2147483647,u="message_key_in_epoch",c="_",d="cipher_version",m="thread",p="message_thread",_="supplemental_enc_aad",f="kdf_info:mailbox_root_key_v2>supplemental_enc_key";function g(t,n,o,a,i){var l=o>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?null:h(a),s=y(t,o,a);if(s==null)throw i.endFailWithError("failed_to_derive_message_symmetric_key"),r("err")("Error in derive message symmetric key. info is null");return b(s,l,n,[e],i)}function h(e){try{return new TextEncoder().encode(e).buffer}catch(e){throw r("err")("Error in get blob from string with exception: ",e)}}function y(e,t,n){var r=C(e,t,n);return h(r)}function C(e,t,n){return t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY||t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?[u,new TextDecoder().decode(e),d,t,m,n].join(c):t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION?[u,new TextDecoder().decode(e),d,t].join(c):[u,new TextDecoder().decode(e)].join(c)}function b(e,t,n,a,i){if(a.length<1||a.some(function(e){return e>s}))throw i==null||i.endFailWithError("invalid_key_lengths_for_derive_keys"),r("err")("Invalid key lengths for derive keys");var l=a.reduce(function(e,t){return e+t},0)*8;return o("XPlatReactCrypto").subtleImportKey("raw",n,"HKDF",!1,["deriveBits"]).then(function(n){return o("XPlatReactCrypto").subtleDeriveBits({hash:"SHA-256",info:e,name:"HKDF",salt:t!=null?t:new Uint8Array(10).buffer},n,l)}).then(function(e){for(var t=new Uint8Array(e),n=[],r=0,o=0,i=a.length;o<i;++o){var l=r+a[o];n.push(t.slice(r,l).buffer),r=l}return n}).catch(function(e){throw i==null||i.endFailWithError("exception_in_create_derived_keys",e),r("err")("Exception in create derived keys",e)})}function v(e,t,n,a,i){var l=o("Base64Utils").toArrayBuffer(n);return S(e,t,l).then(function(e){if(e==null)throw a==null||a.endFailWithError("symmetric_string_decryption_with_null_result"),r("err")("symmetric string decryption with null result");return e}).catch(function(e){throw a==null||a.endFailWithError("symmetric_string_decryption_failed_with_error",e),r("err")("symmetric string decryption failed with encryption version: "+(i!=null?i:"null")+" and error",e)})}function S(e,t,n){if(n.byteLength<o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)throw r("err")("cipher text is invalid");var a=new Uint8Array(n),i=a.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),l=new(o("HChaCha20")).HChaCha20,s=a.slice(o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer,u=l.hChaCha20Bytes(i.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,e);return o("XPlatReactCrypto").subtleImportKey("raw",u,"AES-GCM",!1,["decrypt"]).then(function(e){return o("XPlatReactCrypto").subtleDecrypt({additionalData:t,iv:new Uint8Array(i.slice(o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},e,s)}).then(function(e){var t=o("SymmetricEncryptionPaddingUtils").stripPadding(e);if(t==null)throw r("err")("Failed to strip padding for symmetric decryption");return t}).catch(function(e){throw r("err")("symmetric data decryption failed with error",e)})}function R(e,t,n){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield r("SymmetricEncryptionCreateEncryptedData")(t,new TextEncoder().encode([p,n].join(c)).buffer,e),i=a[0];return i!=null?o("Base64Utils").fromArrayBuffer(i):null}),L.apply(this,arguments)}l.KEY_LEN=e,l.MAX_INT_32=s,l.STRING_JOIN_SEPARATOR=c,l.MESSAGE_ENCYPTION_AAD=p,l.SUPPLEMENTAL_ENC_AAD=_,l.SUPPLEMENTAL_ENC_KEY_INFO=f,l.deriveMessageSymmetricKey=g,l.getBlobFromString=h,l.getInfoByEncryptionVersion=C,l.createDerivedKeys=b,l.symmetricEncryptionCreateDecryptedString=v,l.encryptThenBase64EncodeBlob=R}),98);
__d("EBDecryptQplFlow",["QPLUserFlow","Random","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.annotations,n=e.decryptionType,a=e.entryPoint,i=e.isMinos,l=e.source,u=e.threadId,c=r("qpl")._(521485751,"1118"),d=o("Random").uint32();return r("QPLUserFlow").start(c,{annotations:babelHelpers.extends({},t,{bool:babelHelpers.extends({},t==null?void 0:t.bool,{is_wasm_serializer_on:r("gkx")("18428"),isMinos:i,minos_rollout_enabled:r("gkx")("20911"),occam_only_mailbox_users:r("gkx")("16674")}),int:babelHelpers.extends({},t==null?void 0:t.int,{instanceKey:d,retryCount:0}),string:babelHelpers.extends({},t==null?void 0:t.string,{decryptionType:n,queryType:a,source:l!=null?l:"unknown",threadId:u})}),instanceKey:d}),s(c,d)}function s(e,t){return{addAnnotations:function(o){r("QPLUserFlow").addAnnotations(e,o,{instanceKey:t})},addPoint:function(o,a){a&&r("QPLUserFlow").addAnnotations(e,a,{instanceKey:t}),r("QPLUserFlow").addPoint(e,o,{instanceKey:t})},endFailWithError:function(o,a,i){var n=babelHelpers.extends({},i,{string:babelHelpers.extends({},i==null?void 0:i.string,{failReason:a})});r("QPLUserFlow").endFailure(e,o,{annotations:n,instanceKey:t})},endSuccess:function(o){r("QPLUserFlow").endSuccess(e,{annotations:o,instanceKey:t})},getInstanceKey:function(){return t}}}l.startDecryptQplFlow=e}),98);
__d("WACryptoPrimitives",["tweetnacl"],(function(t,n,r,o,a,i,l){"use strict";var e,s={scalarbase:(e=o("tweetnacl")).lowlevel.scalarbase,crypto_hash:e.lowlevel.crypto_hash,modL:e.lowlevel.modL,pack25519:e.lowlevel.pack25519,S:e.lowlevel.S,M:e.lowlevel.M,A:e.lowlevel.A,Z:e.lowlevel.Z,D:e.lowlevel.D,unpack25519:e.lowlevel.unpack25519,pow2523:e.lowlevel.pow2523,crypto_verify_32:e.lowlevel.crypto_verify_32,set25519:e.lowlevel.set25519,add:e.lowlevel.add,scalarmult:e.lowlevel.scalarmult};l.hash=e.hash,l.scalarMult=e.scalarMult,l.verify=e.verify,l.secretbox=e.secretbox,l.lowlevel=s,l.keypairFromSecretKey=e.box.keyPair.fromSecretKey,l.keyPair=e.box.keyPair,l.signDetachedVerify=e.sign.detached.verify}),98);
__d("WACryptoUtils",["WACryptoDependencies","WACryptoPrimitives","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return u(new Uint8Array(e),new Uint8Array(t))}function s(e,t){var n=new TextDecoder;return n.decode(e).toLowerCase()===n.decode(t).toLowerCase()}function u(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function c(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function d(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function m(e){if(e!==(e|0))throw r("err")("bound must be int32");if(e<=0)throw r("err")("bound must not be positive");for(var t=new Int32Array(1),n=-1>>>1,a=e*Math.floor(n/e),i=-1;i===-1;){o("WACryptoDependencies").getCrypto().getRandomValues(t);var l=t[0]>>>1;l<a&&(i=l%e)}return i}l.arrayBuffersEqual=e,l.arrayBuffersEqualCaseInsensitive=s,l.uint8ArraysEqual=u,l.rawKeysEqual=c,l.serializedPubKeysEqual=d,l.randomNumberLessThan=m}),98);
__d("EBEchoMessageDecryptor",["EBCryptoUtils","EBDecryptQplFlow","I64","LSAuthorityLevel","LSIntEnum","MEBEncryptionVersion","Promise","ReQL","WACryptoUtils","WALogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){if(t==null)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No backup id provided"]))),r("err")("no-backup-id-provided");var a=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_epochs));if(a.length===0)throw o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] SecureEncryptedBackupsEpoch table is empty"]))),r("err")("secure-epochs-table-empty");return a.filter(function(e){return(p||(p=o("I64"))).equal(e.authorityLevel,(_||(_=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))&&(p||(p=o("I64"))).equal(e.backupId,(p||(p=o("I64"))).of_string(t))&&n.equals(e[n.key])})}),g.apply(this,arguments)}function h(e,t){var n=t.epoch_id;return n!=null?f(e,t.backup_id,{equals:function(t){return t instanceof ArrayBuffer?!1:(p||(p=o("I64"))).equal(n,t)},key:"epochId",value:n}):f(e,t.backup_id,{equals:function(n){return n instanceof ArrayBuffer?o("WACryptoUtils").arrayBuffersEqual(t.epoch_anon_id,n):!1},key:"epochAnonIdBlob",value:t.epoch_anon_id})}var y=(function(){function t(){}var a=t.prototype;return a.decrypt=function(a,i,l,c,d){var t=l.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n,l,m=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"echo_message_decryptor",entryPoint:d,isMinos:!1,source:c,threadId:i});if(t.value==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Empty echo message string - cannot decrypt"]))),m.endFailWithError("empty_echo_message_string"),{otid:t.otid,value:void 0};var p=t.value;m.addPoint("get_epoch_keys_by_id_start");var _=yield h(a,t);if(_.length===0)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),m.endFailWithError("no_epoch_keys_found_for_message"),{otid:t.otid,value:void 0};m.addPoint("get_epoch_keys_by_id_end"),m.addPoint("derive_message_symmetric_key_start");var f=yield o("EBCryptoUtils").deriveMessageSymmetricKey(_[0].epochAnonIdBlob,_[0].epochRootKeyBlob,(n=t.encryption_version)!=null?n:r("MEBEncryptionVersion").UNKNOWN,i,m);if(f==null||f.length===0)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),m.endFailWithError("failed_to_derive_symmetric_key"),{otid:t.otid,value:void 0};m.addPoint("derive_message_symmetric_key_end"),m.addPoint("symmetric_encryption_create_decrypted_string_start");var g=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(f[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,i].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,p,m,(l=t.encryption_version)!=null?l:r("MEBEncryptionVersion").UNKNOWN);return m.addPoint("symmetric_encryption_create_decrypted_string_end"),m.endSuccess(),{otid:t.otid,value:g!=null?new TextDecoder().decode(g):void 0}});return function(e){return t.apply(this,arguments)}})());return(m||(m=n("Promise"))).all(t)},t})();l.getEpochKeysByID=h,l.EchoMessageDecryptor=y}),98);
__d("EBTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.unsafeCastToDecryptedLabyrinthMessage=e}),66);
__d("EBProtobufMessageDecryptor",["Base64Utils","EBCryptoUtils","EBDecryptQplFlow","EBEchoMessageDecryptor","EBTypes","MEBEncryptionVersion","MpsTypes","Promise","WALogger","WALongInt","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=(function(){function t(){}var a=t.prototype;return a.$1=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var m,p,_=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:l,isMinos:!1,source:i,threadId:n});_.addAnnotations({string:{message_id:a.otid}}),_.addPoint("get_epoch_keys_by_id_start");var f=yield o("EBEchoMessageDecryptor").getEpochKeysByID(t,a);if(f.length===0){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),_.endFailWithError("no_epoch_keys_found_for_message");return}_.addPoint("get_epoch_keys_by_id_end");var g=f[0];_.addPoint("derive_message_symmetric_key_start");var h=yield o("EBCryptoUtils").deriveMessageSymmetricKey(g.epochAnonIdBlob,g.epochRootKeyBlob,(m=a.encryption_version)!=null?m:r("MEBEncryptionVersion").UNKNOWN,n,_);if(h==null||h.length===0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),_.endFailWithError("failed_to_derive_symmetric_key");return}if(_.addPoint("derive_message_symmetric_key_end"),_.addPoint("symmetric_encryption_create_decrypted_string_start"),a.encryptedProtobufContent==null){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] encrypted protobuf content is null"]))),_.endFailWithError("encrypted_protobuf_content_is_null");return}var y=a.encryptedProtobufContent,C=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(h[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,n].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,y,_,(p=a.encryption_version)!=null?p:r("MEBEncryptionVersion").UNKNOWN),b;if(a.skCipherText!=null){var v,S,R=a.skCipherText,L=yield(S=o("EBCryptoUtils")).createDerivedKeys(new TextEncoder().encode(S.SUPPLEMENTAL_ENC_KEY_INFO).buffer,void 0,g.epochRootKeyBlob,[S.KEY_LEN],_);b=yield S.symmetricEncryptionCreateDecryptedString(L[0],new TextEncoder().encode(S.SUPPLEMENTAL_ENC_AAD).buffer,R,_,(v=a.encryption_version)!=null?v:r("MEBEncryptionVersion").UNKNOWN)}if(C==null){_.endFailWithError("failed_to_decrypt_protobuf"),o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf"])));return}_.addPoint("symmetric_encryption_create_decrypted_string_end"),_.addPoint("decrypt_supplemental_key_start");var E=b!=null?o("MpsTypes").toSupplementalKey(new TextDecoder().decode(b)):void 0;if(_.addPoint("decrypt_supplemental_key_end"),a.protobufTimestampMs==null){_.endFailWithError("protobuf_timestamp_is_null"),o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] protobuf timestamp is null"])));return}var k=o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(a.protobufTimestampMs));return _.endSuccess(),{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(C),decryptedSupplementalKey:E,protobufTimestampMs:k}});function a(e,n,r,o,a){return t.apply(this,arguments)}return a})(),a.$2=function(t){var e=t.topLevelProtobuf.encryptedProtobufContent,n=t.topLevelProtobuf.protobufTimestampMs,r=t.topLevelProtobuf.otid;if(!(e==null||n==null||r==null))return{messageTags:t.messageTags,otid:o("MpsTypes").toMessageId(r),supplementalProtobufs:new Map,topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(o("Base64Utils").toArrayBuffer(e)),decryptedSupplementalKey:void 0,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(n))}}},a.$3=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=r.topLevelProtobuf,u=r.supplementalProtobufs,c=yield this.$1(e,t,s,a,i);if(c==null){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt top level protobuf"])));return}var d=new Map;return yield(g||(g=n("Promise"))).all(u.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=yield l.$1(e,t,n,a,i);if(r==null){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt supplemental protobuf"])));return}var s=r.decryptedSupplementalKey;if(s==null){o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] decrypted supplemental key is null"])));return}d.set(s,r)});return function(e){return r.apply(this,arguments)}})())),{messageTags:r.messageTags,otid:r.topLevelProtobuf.otid!=null?o("MpsTypes").toMessageId(r.topLevelProtobuf.otid):void 0,supplementalProtobufs:d,topLevelProtobuf:c}});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),a.decrypt=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=[];return yield(g||(g=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){if(n.isUnencrypted===!0){var r=l.$2(n);r!=null&&s.push(r);return}var u=yield l.$3(e,t,n,a,i);if(u==null){o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf message for message with otid ",""])),n.topLevelProtobuf.otid);return}s.push(u)});return function(e){return r.apply(this,arguments)}})())),s});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),t})();l.ProtobufMessageDecryptor=h}),98);
__d("EBAPIDecryptionModule",["EBEchoMessageDecryptor","EBProtobufMessageDecryptor","WALogger","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,o,a){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l){o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Running native decryption"])));var u=new(o("EBEchoMessageDecryptor")).EchoMessageDecryptor,c=new(o("EBProtobufMessageDecryptor")).ProtobufMessageDecryptor;try{var d=a.length>0?yield u.decrypt(t,n,a,i,l):[],m=r.length>0?yield c.decrypt(t,n,r,i,l):[];return o("WAResultOrError").makeResult({decryptedEchoMessages:d,decryptedProtobufs:m})}catch(e){return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error thrown when running native decryption: ",""])),e),o("WAResultOrError").makeError(e)}}),c.apply(this,arguments)}l.decryptUsingNativeJS=u}),98);
__d("EBAPISharedTypes",[],(function(t,n,r,o,a,i){"use strict";var e=["ebls-not-initialized","no-client-state","runtime-error","invalid-client-state","invalid-graphql-response","empty-decryption-response","delete-mailbox","unsupported-context","eb-not-enabled","echo-to-protobuf-conversion-error","called-from-main-thread","missing-message-range-info","server-side-exception","thread-not-found-in-mi-act-mapping-table","thread-not-found-on-server","echo-decryption-failure","protobuf-decryption-failure","decryption-error","null-chat-jid","native-decryption-error","invalid-parameters","secure-epochs-table-empty","no-backup-id-provided"],l=new Set(e);i.EBAPIRestoreErrorValues=e,i.errorSet=l}),66);
__d("EBBase64Decode",["Base64Utils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=").replace("/,/","="),n=4-t.length%4;if(n<4)for(var r=0;r<n;r++)t+="=";return t}function s(t){return o("Base64Utils").toArrayBuffer(e(t))}l.default=s}),98);
__d("EBConvertMinosProtobufShape",["EBTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;return{messageTags:e.messageTags,otid:(t=e.otid)!=null?t:void 0,supplementalProtobufs:s(e.supplementalProtobufs),topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.topLevelProtobuf.decryptedProtobuf),decryptedSupplementalKey:e.topLevelProtobuf.decryptedSupplementalKey,protobufTimestampMs:e.topLevelProtobuf.protobufTimestampMs}}}function s(e){var t=new Map;return e.forEach(function(e,n){var r={decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.decryptedProtobuf),decryptedSupplementalKey:n,protobufTimestampMs:e.protobufTimestampMs};t.set(n,r)}),t}l.convertMinosProtobufShape=e}),98);
__d("EBDedupeEncryptedLabyrinthMessages",["MpsTypes"],(function(t,n,r,o,a,i,l){"use strict";var e=["supplemental_protobufs","supplemental_protobufs_v2","top_level_protobuf","top_level_protobuf_unencrypted","top_level_protobuf_v2"];function s(t,n,r){return t.map(function(t){var a,i,l=t.protobuf_stanzas,s=t.otid;if(!l||s==null)return t;var u=l.supplemental_protobufs,c=l.supplemental_protobufs_v2,d=l.top_level_protobuf,m=l.top_level_protobuf_unencrypted,p=l.top_level_protobuf_v2,_=babelHelpers.objectWithoutPropertiesLoose(l,e),f=o("MpsTypes").toMessageId(s),g=n.get(f);if(g==null)return t;var h=(a=u==null?void 0:u.length)!=null?a:0,y=(i=c==null?void 0:c.length)!=null?i:0,C=!0;if(h>0||y>0){var b=u==null?void 0:u.map(function(e){return e.supplemental_otid}).filter(function(e){return e!=null}),v=new Map;if(c)for(var S of c)S.supplemental_otid!=null&&S.supplemental_key!=null&&v.set(S.supplemental_otid,S.supplemental_key);for(var R of b){var L=v.get(R);if(L==null){C=!1;break}var E=g.supplementalProtobufs.get(o("MpsTypes").toSupplementalKey(L));if(g.supplementalProtobufs.size>0&&E==null){C=!1;break}}}if(C){var k=d==null;return r.addAnnotations({bool:{missing_message_minos_restore:k}}),babelHelpers.extends({},t,{protobuf_stanzas:babelHelpers.extends({},_,{supplemental_protobufs:[],supplemental_protobufs_v2:c,top_level_protobuf:null,top_level_protobuf_unencrypted:null,top_level_protobuf_v2:p})})}return t})}l.dedupeEncryptedLabyrinthMessages=s}),98);
__d("EBDedupeLabyrinthMessages",["EBConvertMinosProtobufShape","MpsTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=new Map;return e.forEach(function(e,n){var r=o("EBConvertMinosProtobufShape").convertMinosProtobufShape(e);t.set(n,r)}),t}function s(t,n){if(n==null)return t;var r=e(n),a=[];t.forEach(function(e){if(e.otid!=null){var t=o("MpsTypes").toMessageId(e.otid),n=r.get(t);if(n!=null){var i=u(e.supplementalProtobufs,n.supplementalProtobufs);n.supplementalProtobufs=i,a.push(n),r.delete(t)}else a.push(e)}});for(var i of r.values())a.push(i);return a}function u(e,t){var n=new Map;return e.forEach(function(e,r){var o=t.get(r);o!=null?(n.set(r,o),t.delete(r)):n.set(r,e)}),t.forEach(function(e,t){n.set(t,e)}),n}l.dedupeLabyrinthMessages=s}),98);
__d("PublicKeyEncryptionUtils",["Promise","UInt8Array","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){}function u(e){return e!=null?e:new Uint8Array(0).buffer}function c(e,t,n,r,a){return o("UInt8Array").concatBytes([e,t,n,r,a]).buffer}function d(e,t,n,r){return o("XPlatReactCrypto").subtleImportKey("raw",e.buffer,"HKDF",!1,["deriveKey"]).then(function(e){return o("XPlatReactCrypto").subtleDeriveKey({hash:"SHA-256",info:n,name:"HKDF",salt:t},e,{length:256,name:"AES-GCM"},!1,[r])})}var m="key length is not 32";function p(e,t){if(e.length!==32)return t(m)}function _(t){return new(e||(e=n("Promise")))(function(e,n){return p(t,n),e()})}var f=32;l.assertValidCurvePoint=s,l.getSalt=u,l.concatAad=c,l.getAesKey=d,l.testKeyLength=p,l.assertKeyLength=_,l.keyLength=f}),98);
__d("PublicEncryptionCreateDecryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateDecryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateDecryptedData");function c(e,t){var n=1+o("PublicKeyEncryptionUtils").keyLength+16,r=e.length;r<1+o("PublicKeyEncryptionUtils").keyLength+16&&t("CipherText length is "+r+", < "+n)}function d(e,t,n){var r=t[0];if(r!==e)return n("Unexpected version "+r)}function m(t){return new(e||(e=n("Promise")))(function(e,n){return d(1,t,n),c(t,n),e()})}function p(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(t,n),o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),e()})}function _(t,r,a,i,l,c){var d,_=new Uint8Array(l),f=new Uint8Array([1]),g=(d=o("PublicKeyEncryptionUtils")).getSalt(i),h=new Uint8Array(t),y=new Uint8Array(a),C=new Uint8Array(r),b=new Uint8Array(c);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(C),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return m(b)}).then(function(){return u.load()}).then(function(t){var r=b.slice(1,o("PublicKeyEncryptionUtils").keyLength+1),a=t.publicKeyFromBytes(r,t.KeyPurpose.Encryption);return p(a,y).then(function(){var i=o("PublicKeyEncryptionUtils").concatAad(f,y,h,r,_),l=function(o,i,l){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),s=t.publicKeyFromBytes(i,t.KeyPurpose.Encryption),u=t.secretKeyFromBytes(l,t.KeyPurpose.Encryption);return r==null||s==null||u==null||a==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,s,u,a])};return l(h,y,C).then(function(e){if(e!=null)return{ephemeralPub:e[3],innerAad:i,receiverPriv:e[2],receiverPub:e[0],senderPub:e[1]}})})}).then(function(e){if(e!=null){var t=e.ephemeralPub,n=e.receiverPriv,r=e.senderPub,a=e.innerAad;return s.load().then(function(e){return e.receiverDeriveSharedSecret(n,t,r)}).then(function(e){return e==null?null:o("PublicKeyEncryptionUtils").getAesKey(e,g,a,"decrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer,n=b.slice(o("PublicKeyEncryptionUtils").keyLength+1).buffer;return o("XPlatReactCrypto").subtleDecrypt({additionalData:a,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,n)}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_decrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of decrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=_}),98);
__d("PublicEncryptionCreateEncryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","UInt8Array","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateEncryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateEncryptedData");function c(e,t){if(e.byteLength>32)return t("PSK is too long")}function d(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),c(t,n),e()})}function m(t,r,a,i,l,c){var m,p=new Uint8Array([1]),_=new Uint8Array(l),f=(m=o("PublicKeyEncryptionUtils")).getSalt(i),g=new Uint8Array(t),h=new Uint8Array(r),y=new Uint8Array(a);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(g),o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return d(f,g)}).then(function(){return u.load()}).then(function(t){var r=t.generateKeys(t.KeyPurpose.Encryption),a=r.pk,i=o("PublicKeyEncryptionUtils").concatAad(p,h,g,a,_),l=function(o,a,i){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),l=t.publicKeyFromBytes(a,t.KeyPurpose.Encryption),s=t.secretKeyFromBytes(i,t.KeyPurpose.Encryption);return r==null||l==null||s==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,l,s])};return l(g,h,y).then(function(e){return e==null?null:{ephemeralPriv:r.sk,ephemeralPubBytes:r.pk,innerAad:i,receiverPub:e[0],senderPriv:e[2],senderPub:e[1]}})}).then(function(e){if(e!=null){var t=e.ephemeralPubBytes,n=e.ephemeralPriv,r=e.senderPriv,a=e.receiverPub,i=e.innerAad;return s.load().then(function(e){return e.senderDeriveSharedSecret(r,n,a)}).then(function(e){if(e!=null)return o("PublicKeyEncryptionUtils").getAesKey(e,f,i,"encrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer;return o("XPlatReactCrypto").subtleEncrypt({additionalData:i,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,c)}}).then(function(e){if(e!=null){var n=new Uint8Array(e);return o("UInt8Array").concatBytes([p,t,n]).buffer}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_encrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of encrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=m}),98);
__d("EBEpochUtils",["Base64Utils","EBCryptoUtils","FBLogger","I64","Promise","PublicEncryptionCreateDecryptedData","PublicEncryptionCreateEncryptedData","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u="epoch_chaining",c="epoch_root_key",d="epoch_data_storage",m="epoch_data_metadata",p=18;function _(e){var t=new TextEncoder().encode("0").buffer;if(e==null||e.byteLength===0)return t;var n=new TextDecoder,o=n.decode(e),a=Number.parseInt(o,10);if(Number.isNaN(a))throw r("FBLogger")("messenger_web").mustfixThrow("currentEpochInt is NaN");var i=a+1;return new TextEncoder().encode(i.toString()).buffer}function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=[(a=o("EBCryptoUtils")).KEY_LEN,a.KEY_LEN],l=a.getBlobFromString([u,e,(s||(s=o("I64"))).to_string(t)].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR));if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("infoForEpochChaining is empty");var c=yield o("EBCryptoUtils").createDerivedKeys(l,null,n,i);return{epoch_chaining_key:c[0],epoch_distribution_pre_shared_key:c[1]}}),g.apply(this,arguments)}function h(e,t,n,r,o,a){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateDecryptedData")(e,t,n,o,v(a),i);return l[0]}),y.apply(this,arguments)}function C(e,t,n,r,o,a){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateEncryptedData")(e,t,n,o,v(a),i);return l[0]}),b.apply(this,arguments)}function v(e){return new TextEncoder().encode(["epoch_",e].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer}function S(e,t,n,r){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a=yield o("EBCryptoUtils").createDerivedKeys(e,t,n,r);return a[0]}),R.apply(this,arguments)}function L(e,t){var n=o("EBCryptoUtils").getBlobFromString(c);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("epochRootKey is empty");return S(n,e,t,[o("EBCryptoUtils").KEY_LEN])}function E(e,t){var n=new TextEncoder().encode("meb/debug/fingerprint/"+t).buffer;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("blob type for which fingerprints are supported is empty");return S(n,null,e,[p])}function k(e,t,n){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a){var i=[o("EBCryptoUtils").KEY_LEN],l=o("Base64Utils").fromArrayBuffer(r),s=[t,l].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR),u=yield o("EBCryptoUtils").createDerivedKeys(new TextEncoder().encode(s).buffer,null,a,i);return u.length===0?(e||(e=n("Promise"))).resolve():u[0]}),I.apply(this,arguments)}function T(e){return k(d,e.epochAnonIdBlob,e.epochRootKeyBlob)}function D(e,t){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield $(t,e,m);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("symmetricDecryptAndBase64Decode output is empty while decrypting backward edge");return o("Base64Utils").toArrayBuffer(n)}),x.apply(this,arguments)}function $(e,t,n){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=new TextEncoder().encode(n).buffer;if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("aadBuffer is empty");var i=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(t,a,e);if(i==null)throw r("FBLogger")("messenger_web").mustfixThrow("decrypted_arraybuffer is empty");return new TextDecoder().decode(i)}),P.apply(this,arguments)}l.getNextEpochId=_,l.generateEpochChainingAndDistributionPreSharedKey=f,l.decryptEpochKey=h,l.generateEncryptedEpochKey=C,l.deriveKey=S,l.generateEpochRootKey=L,l.getFingerPrint=E,l.createDerivedKeysForEpoch=k,l.deriveBackwardEdgeKey=T,l.decryptBackwardEdge=D}),98);
__d("LSEpochStatus",[],(function(t,n,r,o,a,i){var e=Object.freeze({ES_OPEN:1,ES_CLOSE:2});i.default=e}),66);
__d("MEBEpochDerivationResult",[],(function(t,n,r,o,a,i){var e=Object.freeze({SUCCESS:0,UNKNOWN_ERROR:1,EDGE_NEITHER_FORWARD_NOR_BACKWARD:2,FORWARD_DECRYPTION_FAILED:3,FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:4,BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:5,BACKWARD_DECRYPTION_FAILED:6,MISSING_CLIENT_STATE:7,DEVICE_ID_MISMATCH:8,SOURCE_FINGERPRINT_MISMATCH:9,DEST_FINGERPRINT_MISMATCH:10,STORAGE_KEY_MISMATH:11,PSK_FINGERPRINT_MISMATCH:12,SOURCE_EPOCH_NOT_FOUND:13,FORWARD_EDGE_NOT_CONSECUTIVE:14,BACKWARD_EDGE_NOT_CONSECUTIVE:15,DERIVATION_DEST_EXISTS:16,DERIVATION_DEST_ANON_ID_EXISTS:17});i.default=e}),66);
__d("EBDeriveAndStoreEpochs",["Base64Utils","EBBase64Decode","EBEpochUtils","I64","LSAuthorityLevel","LSEpochStatus","MEBEpochDerivationResult","ReQL","WACryptoUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i){var l,s,u,c,d=yield o("EBEpochUtils").getNextEpochId(i.epochAnonIdBlob),m=a==null||(l=a.to_epoch)==null?void 0:l.epoch_anon_id;if(m==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var p=r("EBBase64Decode")(m);if(new TextDecoder().decode(d)!==new TextDecoder().decode(p))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge not consecutive",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var _=a==null||(s=a.from_epoch)==null?void 0:s.epoch_id,f=a==null||(u=a.from_epoch)==null?void 0:u.epoch_anon_id;if(_==null||f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f),h=new TextDecoder().decode(g),y=yield o("EBEpochUtils").generateEpochChainingAndDistributionPreSharedKey(h,(e||(e=o("I64"))).of_string(_),i.epochRootKeyBlob),C=y.epoch_distribution_pre_shared_key,b=yield o("EBEpochUtils").getFingerPrint(C,"MEBCryptoPreSharedKey");if((n==null?void 0:n.psk_fingerprint)!==o("Base64Utils").fromArrayBuffer(b))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge psk fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").PSK_FINGERPRINT_MISMATCH});var v=n==null?void 0:n.epoch_storage_public_key;if(o("Base64Utils").fromArrayBuffer(t.epochStoragePublicKeyBlob)!==v)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge storage key mismatch",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH});var S=n==null?void 0:n.auth_public_key;if(S==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var R=a==null||(c=a.to_epoch)==null?void 0:c.epoch_anon_id;if(R==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var L=n==null?void 0:n.encrypted_entropy;if(L==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var E=r("EBBase64Decode")(S);if(E==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var k=r("EBBase64Decode")(L);if(k==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var I=r("EBBase64Decode")(R),T=new TextDecoder().decode(I),D=yield o("EBEpochUtils").decryptEpochKey(t.epochStoragePublicKeyBlob,t.epochStoragePrivateKeyBlob,E,C,T,k);return D==null?o("WAResultOrError").makeError({errorMessage:"epoch forward edge entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_DECRYPTION_FAILED}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").generateEpochRootKey(y.epoch_chaining_key,D))}),u.apply(this,arguments)}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=t==null||(a=t.to_epoch)==null?void 0:a.epoch_anon_id;if(i==null)return o("WAResultOrError").makeError({errorMessage:"toEpochId is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var l=o("EBEpochUtils").getNextEpochId(r("EBBase64Decode")(i));if(!o("WACryptoUtils").arrayBuffersEqual(l,e.epochAnonIdBlob))return o("WAResultOrError").makeError({errorMessage:"epoch backward edge not consecutive",resultCode:r("MEBEpochDerivationResult").BACKWARD_EDGE_NOT_CONSECUTIVE});var s=yield o("EBEpochUtils").deriveBackwardEdgeKey(e);return s==null?o("WAResultOrError").makeError({errorMessage:"epoch backward edge storage key is null",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").decryptBackwardEdge(s,n))}),d.apply(this,arguments)}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a,l,u,d,m=yield t.runInTransaction(function(e){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.secure_encrypted_backups_client_state))},"readwrite",void 0,void 0,i.id+":224");if(m==null)return o("WAResultOrError").makeError({errorMessage:"client state is missing",resultCode:r("MEBEpochDerivationResult").MISSING_CLIENT_STATE});var p=n==null||(a=n.from_epoch)==null?void 0:a.epoch_id;if(p==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var _=yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.get((e||(e=o("I64"))).of_string(p))},"readwrite",void 0,void 0,i.id+":242");if(_==null)return o("WAResultOrError").makeError({errorMessage:"source epoch is missing",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var f=n==null||(l=n.from_epoch)==null?void 0:l.epoch_anon_id;if(f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f);if(new TextDecoder().decode(_.epochAnonIdBlob)!==new TextDecoder().decode(g))return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch anon id mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var h=n==null?void 0:n.from_epoch_fingerprint,y=yield o("EBEpochUtils").getFingerPrint(_.epochRootKeyBlob,"MEBEpochRootKey");if(o("Base64Utils").fromArrayBuffer(y)!==h)return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var C=n==null?void 0:n.forward_edge,b;if(C!=null)b=yield s(m,C,n,_);else{var v=n==null?void 0:n.backward_edge;if(v==null)return o("WAResultOrError").makeError({errorMessage:"backward edge is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});b=yield c(_,n,v)}var S=n==null?void 0:n.to_epoch_fingerprint,R=b.value,L=n==null||(u=n.to_epoch)==null?void 0:u.epoch_id,E=n==null||(d=n.to_epoch)==null?void 0:d.epoch_anon_id;if(L==null||E==null)return o("WAResultOrError").makeError({errorMessage:"target epoch id or anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});if(R==null)return b;var k=yield o("EBEpochUtils").getFingerPrint(R,"MEBEpochRootKey");if(S!==o("Base64Utils").fromArrayBuffer(k))return o("WAResultOrError").makeError({errorMessage:"epoch derivation target epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").DEST_FINGERPRINT_MISMATCH});var I=r("EBBase64Decode")(E);return yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.put({authorityLevel:(e||(e=o("I64"))).of_float(r("LSAuthorityLevel").AUTHORITATIVE),backupId:m.backupId,epochAnonIdBlob:I,epochId:e.of_string(L),epochRootKeyBlob:R,epochStatus:e.of_float(r("LSEpochStatus").ES_CLOSE)})},"readwrite",void 0,void 0,i.id+":331"),o("WAResultOrError").makeResult(R)}),p.apply(this,arguments)}function _(e,t){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if((t==null?void 0:t.epoch_edges)==null)return[];var n=[];for(var o of t.epoch_edges){var a,i,l,s,u,c=yield m(e,o),d={resultForEpochSync:{error_message:(a=c.error)==null?void 0:a.errorMessage,from:{epoch_anon_id:(i=o.from_epoch)==null?void 0:i.epoch_anon_id,epoch_id:o==null||(l=o.from_epoch)==null?void 0:l.epoch_id},has_backward_edge:(o==null?void 0:o.backward_edge)!=null,has_forward_edge:(o==null?void 0:o.forward_edge)!=null,result_code:c.success?r("MEBEpochDerivationResult").SUCCESS:c.error.resultCode,to:{epoch_anon_id:o==null||(s=o.to_epoch)==null?void 0:s.epoch_anon_id,epoch_id:o==null||(u=o.to_epoch)==null?void 0:u.epoch_id}}};n.push(d)}return n}),f.apply(this,arguments)}l.deriveAndStoreEpochsNonLS=_}),98);
__d("EBMinosEncryptedMekVersion",["$InternalEnum","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({V1:1,V2:2}),s=e.V1,u=r("gkx")("19417")?e.V2:e.V1;l.MinosEncryptedMekVersion=e,l.INITIAL_VERSION=s,l.MINOS_ENCRYPTED_MEK_CURRENT_VERSION=u}),98);
__d("EBMinosClientConfig",["EBMinosEncryptedMekVersion","EBMinosMessageEncryptionVersion"],(function(t,n,r,o,a,i,l){"use strict";var e={preferredMekEncryptionVersion:o("EBMinosEncryptedMekVersion").MINOS_ENCRYPTED_MEK_CURRENT_VERSION,preferredMessageEncryptionVersion:o("EBMinosMessageEncryptionVersion").MINOS_MESSAGE_ENCRYPTION_CURRENT_VERSION};l.MINOS_CLIENT_CONFIG=e}),98);
__d("EBMinosWasmEncryptMekForDistribution",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.version,a=o("WALongInt").maybeNumberOrThrowIfTooLarge(r);if(a==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var i=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),a),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMek:o("EBMinosTypes").unsafeCastToEncryptedMek(n),mekEncryptionVersion:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.fromKeypair,r=e.mek,a=e.senderEpochHead,i=e.toEpochHead,l=e.toMailboxPk;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMekForDistributionResultSpec,validateResult:t},{encryptMekForDistribution:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,fromKeypair:n,mek:r,senderEpochHead:a,toEpochHead:i,toMailboxPk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptMekForDistribution=u}),98);
__d("EBMinosWasmEncryptMeksForDistributionFromTransportSender",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.encryptedMeks,r=t.ephemeralEncryptionPk,a=t.signature,i=t.signingPk,l=t.version,s=o("WALongInt").maybeNumberOrThrowIfTooLarge(l);if(s==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var u=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(s);return u==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),s),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMeks:n.map(o("EBMinosTypes").unsafeCastToEncryptedMek),encryptedMekVersion:u,ephemeralEncryptionPk:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralPK(r),signature:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralKeySig(a),signingPk:o("EBMinosTypes").unsafeCastToTransportSigningPK(i)})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mek,r=e.recipientEpochHeads,a=e.recipientMailboxEncryptionPks,i=e.transportSigningKp;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMeksForDistributionFromTransportSenderResultSpec,validateResult:t},{encryptMeksForDistributionFromTransportSender:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,recipientEpochHeads:r,recipientMailboxEncryptionPks:a,transportSigningKp:i}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.createMinosWasmEncryptMeksForDistributionFromTransportSender=s,l.encryptMeksForDistributionFromTransportSender=u}),98);
__d("EBMinosWasmGenerateMek",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mek;return o("WAResultOrError").makeResult({key:o("EBMinosTypes").unsafeCastMekKey(t.key),mekId:o("EBMinosTypes").unsafeCastToMekId(t.mekId),rosterHash:o("EBMinosTypes").unsafeCastMekRosterHash(t.rosterHash)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekResultSpec,validateResult:e},{generateMek:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMek=s}),98);
__d("WAPromiseMap",["Promise"],(function(t,n,r,o,a,i){"use strict";var e;function l(t,r){return(e||(e=n("Promise"))).resolve(t).then(function(t){return(e||(e=n("Promise"))).all(t.map(function(e,t){return r(e,t)}))})}i.promiseMap=l}),66);
__d("EBGenerateAndUploadMek",["EBMinosEncryptedMekVersion","EBMinosWasmEncryptMekForDistribution","EBMinosWasmEncryptMeksForDistributionFromTransportSender","EBMinosWasmGenerateMek","WAErrorMessage","WAPromiseMap","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["mekEncryptionVersion","mekEnvelopes"],s,u,c,d,m,p,_,f,g,h,y,C,b;function v(e){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId,r=t.io,a=t.logger,i=t.msgUploadQpl,l=t.participantMailboxes,f=t.sender;a.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start generate and upload mek"]))),i.addPoint("generate_mek_start");var g=l.map(function(e){var t=e.epochHead;return t}),h=yield o("EBMinosWasmGenerateMek").generateMek({epochHeads:g});if(!h.success)return a.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["mek generated error: ",""])),h.error),o("WAResultOrError").makeError("generate-mek-error");i.addPoint("generate_mek_end"),a.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Sender type: ",". Epoch FBID: ",""])),f.senderType,f.senderEpochFbId),i.addPoint("get_minos_mailbox_key_end",{string:{senderType:f.senderType}}),a.DEV(d||(d=babelHelpers.taggedTemplateLiteralLoose(["start encrypy mek. senderType: ",""])),f.senderType),i.addPoint("encrypt_mek_envelopes_start");var y=h.value,C=yield f.senderType==="Minos"?R({fromKeypair:f.fromKeypair,logger:a,mek:y,participantMailboxes:l,senderEpochFbId:f.senderEpochFbId,senderEpochHead:f.senderEpochHead}):E({logger:a,mek:y,participantMailboxes:l,transportSigningKp:f.transportSigningKp});if(!C.success)return i.addPoint("encrypt_mek_envelopes_fail"),o("WAResultOrError").makeError("encrypt-mek-error");i.addPoint("encrypt_mek_envelopes_end");var b=C.value,v=b.mekEncryptionVersion,S=b.mekEnvelopes,L=babelHelpers.objectWithoutPropertiesLoose(b,e);i.addAnnotations({int:{mek_encryption_version:v}}),i.addPoint("register_mek_gql_start");var k=yield r.registerMinosMessageEncryptionKey({actThreadId:n,instanceKey:i.getInstanceKey(),mekEncryptionVersion:v,mekEnvelopes:S,mekId:y.mekId,mekRosterHash:y.rosterHash,sender:L}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return a.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["upload mek runtime-error: ",". ",""])),t,e),o("WAResultOrError").makeError({errorName:"runtime-error",failReason:t})});if(k.success!==!0){var I=k.error,T=I.errorName,D=I.failReason;return a.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["upload mek error: ",". Reason: ",""])),T,D),i.addPoint("register_mek_gql_fail"),o("WAResultOrError").makeError("distribute-mek-error")}return i.addPoint("register_mek_gql_end"),a.DEV(_||(_=babelHelpers.taggedTemplateLiteralLoose(["register minos message encryption key success"]))),o("WAResultOrError").makeResult({mek:y,mekFbid:k.value.mekFbid})}),S.apply(this,arguments)}function R(e){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.fromKeypair,r=e.logger,a=e.mek,i=e.participantMailboxes,l=e.senderEpochFbId,s=e.senderEpochHead,u=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,c=yield o("WAPromiseMap").promiseMap(i,(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.epochHead,i=e.mailboxKey,l=e.mailboxKeyFbid,c=e.participantId,d=yield o("EBMinosWasmEncryptMekForDistribution").encryptMekForDistribution({fromKeypair:t,mek:a,senderEpochHead:s,toEpochHead:n,toMailboxPk:i});if(!d.success)return r.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),d.error),null;var m=d.value.mekEncryptionVersion;if(m!=null)u=m;else return r.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),d.value.mekEncryptionVersion),null;return{encryptedMek:d.value.encryptedMek,mailboxKey:i,mailboxKeyFbid:l,participantId:c}});return function(t){return e.apply(this,arguments)}})()),d=c.filter(Boolean);return d.length===0?(r.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["no successful mek encryption results"]))),o("WAResultOrError").makeError("encrypt-mek-error")):o("WAResultOrError").makeResult({epochFbId:l,mekEncryptionVersion:u,mekEnvelopes:d,senderType:"Minos"})}),L.apply(this,arguments)}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mek,r=e.participantMailboxes,a=e.transportSigningKp,i=yield o("EBMinosWasmEncryptMeksForDistributionFromTransportSender").encryptMeksForDistributionFromTransportSender({mek:n,recipientEpochHeads:r.map(function(e){var t=e.epochHead;return t}),recipientMailboxEncryptionPks:r.map(function(e){var t=e.mailboxKey;return t}),transportSigningKp:a});if(!i.success)return t.ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),i.error),o("WAResultOrError").makeError("encrypt-mek-error");if(i.value.encryptedMeks.length!==r.length)return t.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["number of encrypted meks does not match number of participants"]))),o("WAResultOrError").makeError("encrypt-mek-error");var l=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,s=r.map(function(e,n){var r=i.value.encryptedMekVersion;if(r!=null)l=r;else return t.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),i.value.encryptedMekVersion),null;return{encryptedMek:i.value.encryptedMeks[n],mailboxKey:e.mailboxKey,mailboxKeyFbid:e.mailboxKeyFbid,participantId:e.participantId}}),u=s.filter(Boolean);return o("WAResultOrError").makeResult({ephemeralEncryptionPk:i.value.ephemeralEncryptionPk,mekEncryptionVersion:l,mekEnvelopes:u,senderType:"Transport",signature:i.value.signature,signingPk:i.value.signingPk})}),k.apply(this,arguments)}l.generateAndUploadMek=v}),98);
__d("IGDWEBUploadMessageUtils",["I64","MAWExtractMsFromExternalId","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){var r=o("MAWExtractMsFromExternalId").extractMsFromExternalId((s||(s=o("I64"))).of_string(t));return r==null&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Could not extract ms from externalId: ",""])),t),o("WATimeUtils").castToMillisTime(Number(n)*1e3+(r!=null?r:0))}l.generateProtobufServerTs=u}),98);
__d("EncryptedBackupsUploadEntity",["$InternalEnum","EncryptedBackupsUtils","IGDWEBUploadMessageUtils","WAArmadilloBackupMessage.pb","WAByteArray","WAGlobals","WAJids","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e instanceof ArrayBuffer?new Uint8Array(e):e}var s=n("$InternalEnum").Mirrored(["NEEDS_BACKUP","COMPLETED","NEEDS_BACKUP_RETRY","PERMANENT_FAILURE","EXPIRED","THREAD_DELETED","DELETION_PURGED","MESSAGE_DELETED","UPLOADING"]),u=n("$InternalEnum")({INVALID:"-1",IMAGE:"0",PTT:"1",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",XMA:"22",MESSENGER_PREVIEW:"25"});function c(e){return e}function d(e){var t=e.messageApplication,n=e.msgId,r=e.reportingMeta,a=e.sortOrderMs,i=o("WAJids").authorToUserId(n.author,o("WAJids").extractUserId(o("WAGlobals").getMyUserJid()));return o("encodeProtobuf").encodeProtobuf(o("WAArmadilloBackupMessage.pb").BackupMessageSpec,o("EncryptedBackupsUtils").asBackupMessage(i,n.externalId,a,r!=null?r:{frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},t)).readByteArrayView()}function m(e){return o("WAByteArray").uint8ArrayToBuffer(e)}function p(e){var t=e.attachmentContext,n=e.backupDirective,r=e.dbMsgType,a=e.instanceKey,i=e.isOpenEB,l=e.isRetroactiveUpload,u=e.legacyAttachmentContext,c=e.messageApplication,m=e.msgId,p=e.originalMsgProtocolId,_=e.reportingMeta,f=e.retryCount,g=e.senderId,h=e.serverTs,y=e.sortOrderMs,C=e.tags,b=e.triggerSource,v=d({messageApplication:c,msgId:m,reportingMeta:_,sortOrderMs:n.actionType===4?o("IGDWEBUploadMessageUtils").generateProtobufServerTs(m.externalId,h):y}),S={backupActionType:n.actionType,backupDirective:n,dbMsgType:r,failTsMs:o("WATimeUtils").castToMillisTime(0),instanceKey:a,isOpenEB:i,isRetroactiveUpload:l,msgId:m,msgIdKey:o("EncryptedBackupsUtils").convertWAMsgIdToStringId(m),msgType:"text",originalMsgProtocolId:p,protobuf:v,retryCount:f,senderId:g,serverTs:h,sortOrderMs:y,supplementalKey:n.supplementalKey,tags:C,triggerSource:b,uploadStatus:s.NEEDS_BACKUP,uploadTsSec:o("WATimeUtils").unixTime()};return t!=null&&(S=babelHelpers.extends({},S,{attachmentContext:t,legacyAttachmentContext:u,msgType:"media"})),S}l.toEbBackupMessageBytes=e,l.EbUploadStatus=s,l.AttachmentContextMediaType=u,l.castToEBQueueId=c,l.encodeBackupMessage=d,l.getEbBackupMessageBytesBuffer=m,l.asEBUploadEntity=p}),98);
__d("EBGenerateMessageTags",["EncryptedBackupsUploadEntity","MSGDataclassTypes.flow"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return o("MSGDataclassTypes.flow").MpsMessageTag.Photo;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return o("MSGDataclassTypes.flow").MpsMessageTag.Video;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return o("MSGDataclassTypes.flow").MpsMessageTag.Gif;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return o("MSGDataclassTypes.flow").MpsMessageTag.Audio;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return o("MSGDataclassTypes.flow").MpsMessageTag.File;default:return null}}l.generateEBMessageTags=e}),98);
__d("EBGetClientState",["EBLogger","EBMinosInterfaceTypes","I64","LSAuthorityLevel","LSIntEnum","ReQL","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a=n!=null?yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_client_state)):yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_client_state)),i=n!=null?yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_epochs)):yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_epochs)),l=i.filter(function(e){return(s||(s=o("I64"))).equal(e.authorityLevel,(u||(u=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))}).map(function(e){return(s||(s=o("I64"))).to_string(e.epochId)});if(a==null){o("EBLogger").EBLogger("wmi").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web Client state is null - unable to proceed with GQL restore"])));return}var c=(a==null?void 0:a.deviceId)!=null?o("EBMinosInterfaceTypes").unsafeCastToDeviceId((s||(s=o("I64"))).to_string(a==null?void 0:a.deviceId)):null,d=a.mailboxRootKeyBlob,m=a.ocmfClientStateBlob,p=o("EBMinosInterfaceTypes").unsafeCastToBackupFbid((s||(s=o("I64"))).to_string(a.backupId)),_=a.encryptionVersion;return{backupId:p,deviceId:c,encryptionVersion:_,locally_available_epochs:l,mailboxRootKey:d,ocmfClientStateBlob:m}}),d.apply(this,arguments)}l.getClientState=c}),98);
__d("EBGetMinosAttachmentPayloadFromMpsMessage",["EBMinosTypes","EBMinosWasmDeriveAttachmentAccessTokenSecret","EBMinosWasmDeriveAttachmentPrimaryKeySecret","MpsMessageToBridgeWrapper","Promise","WAMediaUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e){var t,r,a=e.logger,i=e.message,l=e.qplFlow,s=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(i),u=s.deserialize(),c=(t=u.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(c!=null)return f({consumerApplication:c,logger:a,qplFlow:l});var d=(r=u.encryptedTransportMessage())==null||(r=r.armadillo())==null?void 0:r.extendedContentMessage();return d!=null?h({extendedContentMessage:d,logger:a,qplFlow:l}):(p||(p=n("Promise"))).resolve([])}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n,r,a,i,l,s=e.consumerApplication,u=e.logger,c=e.qplFlow,d=s.attachmentMessage();if(d==null||((t=d.payload.integral)==null?void 0:t.receiverFetchId)!=null)return[];var m=d.kind,p=d.payload.integral,_=(n=p==null||(r=p.transport)==null?void 0:r.integral)!=null?n:{},f=_.mediaKey,g=(a=p==null||(i=p.transport)==null?void 0:i.ancillary)!=null?a:{},h=g.objectId,y=yield C({logger:u,maybeMediaKey:f,maybeObjectId:h}),b=p==null||(l=p.transport)==null||(l=l.ancillary)==null||(l=l.thumbnail)==null?void 0:l.downloadableThumbnail,S=b==null?null:yield C({logger:u,maybeMediaKey:b.mediaKey,maybeObjectId:b.objectId}),R=c.getInstanceKey().toString();return[y.success===!0?babelHelpers.extends({},y.value,{attachmentTraceId:R,mediaType:v(m)}):null,(S==null?void 0:S.success)===!0?babelHelpers.extends({},S.value,{attachmentTraceId:R,mediaType:o("EBMinosTypes").MinosAttachmentMediaType.MESSENGER_PREVIEW}):null].filter(Boolean)}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r=t.extendedContentMessage,a=t.logger,i=t.qplFlow,l=[r.favicon(),r.headerImage()].concat(r.previews()).filter(Boolean);if(l.length===0)return[];var u=yield(p||(p=n("Promise"))).all(l.map(function(e){var t,n;return C({logger:a,maybeMediaKey:(t=e.integral)==null||(t=t.transport)==null||(t=t.integral)==null?void 0:t.mediaKey,maybeObjectId:(n=e.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId})})),c=u.filter(function(e){return e.success===!0}),d=u.filter(function(e){return e.success===!1});return d.forEach(function(t){a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse an attachment in XMA message: ",""])),t.error)}),c.length===0&&a.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse all attachments in XMA message"]))),c.map(function(e){return babelHelpers.extends({},e.value,{attachmentTraceId:i.getInstanceKey().toString(),mediaType:o("EBMinosTypes").MinosAttachmentMediaType.XMA})})}),y.apply(this,arguments)}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.maybeMediaKey,r=e.maybeObjectId;if(n==null)return t.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing mediaKey in media message protobuf"]))),o("WAResultOrError").makeError("missing-media-key");if(r==null)return t.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Missing objectId in media message protobuf"]))),o("WAResultOrError").makeError("missing-object-id");var a=o("WAMediaUtils").castToMediaKey(n),i=yield o("EBMinosWasmDeriveAttachmentPrimaryKeySecret").deriveAttachmentPrimaryKeySecret({mediaKey:a});if(!i.success)return t.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment primary key secret"]))),o("WAResultOrError").makeError("derive-primary-key-secret-error");var l=yield o("EBMinosWasmDeriveAttachmentAccessTokenSecret").deriveAttachmentAccessTokenSecret({mediaKey:a});return l.success?o("WAResultOrError").makeResult({accessTokenSecret:l.value,primaryKeySecret:i.value,zippyObjectId:o("WAMediaUtils").stringToDeliveryObjectId(r)}):(t.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment access token secret"]))),o("WAResultOrError").makeError("derive-access-token-secret-error"))}),b.apply(this,arguments)}function v(e){return e==="audioTransport"?o("EBMinosTypes").MinosAttachmentMediaType.PTT:e==="imageTransport"?o("EBMinosTypes").MinosAttachmentMediaType.IMAGE:e==="videoTransport"?o("EBMinosTypes").MinosAttachmentMediaType.VIDEO:e==="stickerTransport"?o("EBMinosTypes").MinosAttachmentMediaType.STICKER:e==="documentTransport"?o("EBMinosTypes").MinosAttachmentMediaType.DOCUMENT:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}l.getMinosAttachmentPayloadFromMpsMessage=_}),98);
__d("EBGraphQLRestoreDefinition",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.toMpsMessageQueryForGraphQLQuery=e}),66);
__d("EBMessageEncryptionKeyStorage",["WABase64","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return o("WABase64").encodeB64(e)+"|"+o("WABase64").encodeB64(t)}function u(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekCreatorEpochHead,i=t.minosThreadId,l=t.rosterHash,u=s(l,i),c=a.get(u);if(c!=null)return{cacheStatus:"cached-by-memory",registeredMek:c};var d=yield r.loadMessageEncryptionKey(i,l,n).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKey runtime-error: ",""])),t),null});return d!=null?(a.set(u,d),{cacheStatus:"cached-by-db",registeredMek:d}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.createdBySelf,n=e.lastUsedTsMs,o=e.mekCreatorEpochHead,i=e.minosThreadId,l=e.registeredMek,u=e.rosterHash,c=s(u,i);a.set(c,l),yield r.saveNewMessageEncryptionKey(i,l.mek,l.mekFbid,t,n,o)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKey:i,setNewMessageEncryptionKey:l}}l.createMessageEncryptionKeyStorage=u}),98);
__d("EBMessageEncryptionKeyStorageDecrypt",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekId,i=a.get(n);if(i!=null)return{cacheStatus:"cached-by-memory",registeredMek:i};var l=yield r.loadMessageEncryptionKeyForDecryption(n).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKeyForDecryption runtime-error: ",""])),t),null});return l!=null?(a.set(n,l),{cacheStatus:"cached-by-db",registeredMek:l}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.createdBySelf,n=e.lastUsedTsMs,o=e.minosThreadId,i=e.registeredMek,l=i.mek.mekId;a.set(l,i),yield r.saveNewMessageEncryptionKey(o,i.mek,i.mekFbid,t,n,null)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKeyDecrypt:i,setNewMessageEncryptionKeyDecrypt:l}}i.createMessageEncryptionKeyStorageDecrypt=l}),66);
__d("EBMessagePointQuery_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="32643898351892811"}),null);
__d("EBMessagePointQuery.graphql",["EBMessagePointQuery_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={defaultValue:null,kind:"LocalArgument",name:"app_id"},t={defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"},r={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},o={defaultValue:null,kind:"LocalArgument",name:"restore_type"},a=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],i={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},C={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},b={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},v={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},S={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},R={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},L={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},E=[l,s],k={alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null};return{fragment:{argumentDefinitions:[e,t,r,o],kind:"Fragment",metadata:null,name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{args:[{kind:"Variable",name:"minos_gk_enabled",variableName:"minos_gk_enabled"}],kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[r,o,e,t],kind:"Operation",name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},i,l,s,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[u,i,l,s,c,d],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[u,i,l,s,c,d,m,p],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},c],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[_,f,g,h,y,C,b,v,S,R,L],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[_,f,y,g,h,m,p,C,b,v,S,R,L],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[k,{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[h,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},l,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],storageKey:null}],storageKey:null},k],storageKey:null}],storageKey:null}]},params:{id:n("EBMessagePointQuery_facebookRelayOperation"),metadata:{},name:"EBMessagePointQuery",operationKind:"query",text:null}}})();a.exports=e}),null);
__d("EBMinosWasmDecryptAndVerifyMessage",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToDecryptedMessage(e.success.plaintext)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.cipherText,r=t.mekKey,a=t.messageEncryptionVersion,i=t.metadata,l=t.signature,s=t.transportSigningPK;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosDecryptAndVerifyMessageResultSpec,validateResult:e},{decryptAndVerifyMessage:{encryptedMessageCiphertext:n,encryptedMessageSignature:l,mek:r,messageEncryptionVersion:a,metadata:i,transportSigningPk:s}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptAndVerifyMessage=s}),98);
__d("EBMinosWasmDecryptMekForDistribution",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.encryptedMek,r=t.mailboxAuthPk,a=t.mailboxEncSk,i=t.mekEncryptionVersion,l=t.mekId,s=t.recipientEpochHead,u=t.rosterHash,c=t.senderEpochHead;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionResultSpec,validateResult:e},{decryptMekForDistribution:{ciphertext:n,fromPk:r,mekEncryptionVersion:i,mekId:l,rosterHash:u,senderEpochHead:c,toEpochHead:s,toMailboxSk:a}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptMekForDistribution=s}),98);
__d("EBMinosWasmDecryptMekForDistributionFromTransportSender",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekDistribution,r=t.mekEncryptionVersion,a=t.mekId,i=t.recipientEncSk,l=t.rosterHash;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionFromTransportSenderResultSpec,validateResult:e},{decryptMekForDistributionFromTransportSender:{mekDistribution:n,mekId:a,recipientEncSk:i,rosterHash:l,version:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.createMinosWasmDecryptMekForDistributionFromTransportSender=e,l.decryptMekForDistributionFromTransportSender=s}),98);
__d("EBMinosWasmDeriveMailboxAuthKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxAuthPrivateKey,n=e.mailboxAuthPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxAuthPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxAuthSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxAuthKeypairResultSpec,validateResult:e},{deriveMailboxAuthKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxAuthKeypair=s}),98);
__d("EBMinosWasmDeriveMailboxEncryptionKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxEncryptionPrivateKey,n=e.mailboxEncryptionPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxEncryptionPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxEncryptionSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxEncryptionKeypairResultSpec,validateResult:e},{deriveMailboxEncryptionKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxEncryptionKeypair=s}),98);
__d("EBMinosWasmEncryptAndSignMessage",["EBMinosClientConfig","EBMinosLogger","EBMinosMessageEncryptionVersion","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.signature,a=t.version,i=o("EBMinosMessageEncryptionVersion").MinosMessageEncryptionVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast message encryption version: ",""])),a),o("WAResultOrError").makeError("invalid-message-encryption-version")):o("WAResultOrError").makeResult({encryptedMsg:o("EBMinosTypes").unsafeCastToEncryptedMessage(n),signature:o("EBMinosTypes").unsafeCastToEncryptedMessageSignature(r),version:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mekKey,r=e.metadata,a=e.plaintext,i=e.transportSigningPK,l=e.transportSigningSK;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosEncryptAndSignMessageResultSpec,validateResult:t},{encryptAndSignMessage:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,metadata:r,plaintext:a,transportSigningPk:i,transportSigningSk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptAndSignMessage=u}),98);
__d("EBMinosWasmGenerateMekRosterHash",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.rosterHash;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekRosterHash(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekRosterHashResultSpec,validateResult:e},{generateMekRosterHash:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMekRosterHash=s}),98);
__d("EBMinosWasmWrapTransportSigningPublicKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningPK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPublicKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningPublicKeyResultSpec,validateResult:e},{wrapTransportSigningPublicKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningPublicKey=s}),98);
__d("EBMinosWasmWrapTransportSigningSecretKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningSK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPrivateKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningSecretKeyResultSpec,validateResult:e},{wrapTransportSigningSecretKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningSecretKey=s}),98);
__d("EBMinosWrapTransportSigningKeypair",["EBMinosLogger","EBMinosWasmWrapTransportSigningPublicKey","EBMinosWasmWrapTransportSigningSecretKey","WAByteArray","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.privateKey,r=t.publicKey,a=o("EBMinosWasmWrapTransportSigningPublicKey").wrapTransportSigningPublicKey({signalIdentityPublicKey:o("WAByteArray").uint8ArrayToBuffer(r)}),i=yield a,l=o("EBMinosWasmWrapTransportSigningSecretKey").wrapTransportSigningSecretKey({signalIdentityPrivateKey:o("WAByteArray").uint8ArrayToBuffer(n)}),u=yield l;if(!i.success)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing public key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");if(!u.success)return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing secret key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");var c={pk:i.value,sk:u.value};return o("WAResultOrError").makeResult(c)}),c.apply(this,arguments)}l.wrapTransportSigningKeypair=u}),98);
__d("EBMinosWasmMinosThreadIdFromActThreadId",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromActThreadIdResultSpec,validateResult:e},{minosThreadIdFromActThreadId:{actThreadId:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromActThreadId=s}),98);
__d("EBMinosWasmMinosThreadIdFromOneToOneThread",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId,r=t.selfFbid;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromOneToOneThreadResultSpec,validateResult:e},{minosThreadIdFromOneToOneThread:{actThreadId:n,selfFbid:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromOneToOneThread=s}),98);
__d("MpsThreadIdToMinosThreadId",["EBMinosLogger","EBMinosWasmMinosThreadIdFromActThreadId","EBMinosWasmMinosThreadIdFromOneToOneThread","Promise","WAJids","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,r){var a=o("WAJids").validateUserJid(t);if(a!=null){var i=o("WAJids").userIdFromJid(a);return o("EBMinosWasmMinosThreadIdFromOneToOneThread").minosThreadIdFromOneToOneThread({actThreadId:i,selfFbid:r}).then(function(t){return t.success?o("WAResultOrError").makeResult(t.value):(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId UserJid error: ",""])),t.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}var l=o("WAJids").validateGroupJid(t);if(l!=null){var c=o("WAJids").groupIdFromJid(l);return o("EBMinosWasmMinosThreadIdFromActThreadId").minosThreadIdFromActThreadId({actThreadId:c}).then(function(e){return e.success?o("WAResultOrError").makeResult(e.value):(o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId GroupJid error: ",""])),e.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}return(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("invalid-mps-thread-id"))}l.mpsThreadIdToMinosThreadId=c}),98);
__d("MpsThreadIdToWaThreadId",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=o("WAJids").validateUserJid(e);if(t!=null)return o("WAJids").userIdFromJid(t);var n=o("WAJids").validateGroupJid(e);return n!=null?o("WAJids").groupIdFromJid(n):null}l.mpsThreadIdToWaThreadId=e}),98);
__d("EBMinosCryptoLibrary",["Base64Utils","EBDecryptQplFlow","EBDeps","EBGenerateAndUploadMek","EBGetMinosAttachmentPayloadFromMpsMessage","EBMessageEncryptionKeyStorage","EBMessageEncryptionKeyStorageDecrypt","EBMinosCheckWasmFeatureSupport","EBMinosLogger","EBMinosMessageMetadataVersion","EBMinosProcessMessages","EBMinosTypes","EBMinosWasmDecryptAndVerifyMessage","EBMinosWasmDecryptMekForDistribution","EBMinosWasmDecryptMekForDistributionFromTransportSender","EBMinosWasmDeriveMailboxAuthKeypair","EBMinosWasmDeriveMailboxEncryptionKeypair","EBMinosWasmEncryptAndSignMessage","EBMinosWasmGenerateMekRosterHash","EBMinosWrapTransportSigningKeypair","MAWProtobufDeserializers","MpsThreadIdToMinosThreadId","MpsThreadIdToWaThreadId","MpsTypes","WAFrankingTypes","WAGetPlatformFromStanzaId","WAGlobals","WAResultOrError","WAStanzaUtils","asyncToGeneratorRuntime","err","gkx","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E;function k(e){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.io,a=t.loadMessageEncryptionKey,i=t.loadMessageEncryptionKeyForDecryption,l=t.loadMostRecentSelfMinosEpoch,s=t.loadSelfMinosEpochForDecryption,u=t.registerMinosMessageEncryptionKey,c=t.saveNewMessageEncryptionKey,d=e.logger,R=e.transportSigningKeypair,L=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupportAndGK();d.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["gk minos_rollout_enabled: ",""])),L);var E=o("EBMessageEncryptionKeyStorage").createMessageEncryptionKeyStorage({io:{loadMessageEncryptionKey:a,saveNewMessageEncryptionKey:c},logger:d}),k=o("EBMessageEncryptionKeyStorageDecrypt").createMessageEncryptionKeyStorageDecrypt({io:{loadMessageEncryptionKeyForDecryption:i,saveNewMessageEncryptionKey:c},logger:d}),I=yield o("EBMinosWrapTransportSigningKeypair").wrapTransportSigningKeypair(R);if(I.success===!1)return o("WAResultOrError").makeError("transport-signing-keypair-error");var T=I.value,D=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.qplFlow,n=e.uploadEntity,a=n.deletionOfflineThreadingId,i=n.directive,s=n.isEphemeral,c=n.mailboxKeys,m=n.messageId,y=n.payload,C=n.senderId,b=n.supplementalOpToken,v=n.tags,S=n.threadId,R=n.timestampMs;t.addAnnotations({bool:{mek_reuse_enabled:r("gkx")("7918")}}),t.addPoint("generate_mek_roster_hash_start");var L=c.map(function(e){var t=e.epochHead;return t}),k=yield o("EBMinosWasmGenerateMekRosterHash").generateMekRosterHash({epochHeads:L});if(!k.success)return t.addPoint("generate_mek_roster_hash_fail"),o("WAResultOrError").makeError("generate-mek-roster-hash-error");var I=k.value;t.addPoint("generate_mek_roster_hash_end"),t.addPoint("get_or_generate_mek_start");var D=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(D==null)return d.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["selfFbid is invalid"]))),o("WAResultOrError").makeError("invalid-self-fbid");var x=yield o("MpsThreadIdToMinosThreadId").mpsThreadIdToMinosThreadId(S,D);if(!x.success)return d.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId error: ",""])),x.error),o("WAResultOrError").makeError("create-minos-thread-id-error");var P=x.value,N=yield M({actThreadId:r("nullthrows")(o("MpsThreadIdToWaThreadId").mpsThreadIdToWaThreadId(S),"invalid MPS threadId"),io:{loadMostRecentSelfMinosEpoch:l,registerMinosMessageEncryptionKey:u},logger:d,mailboxKeys:c,mekStorage:E,minosThreadId:P,msgUploadQpl:t,rosterHash:I,transportSigningKeypair:T});if(!N.success)return d.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["get or generate mek error: ",""])),N.error),t.addPoint("get_or_generate_mek_fail"),o("WAResultOrError").makeError("get-mek-error");t.addPoint("get_or_generate_mek_end",{string:{mekCacheStatus:N.value.cacheStatus}});var w=N.value.registeredMek,A=w.mek,F=w.mekFbid,O=o("EBMinosMessageMetadataVersion").MESSAGE_METADATA_CURRENT_VERSION;t.addAnnotations({int:{message_metadata_version:O}});var B=o("EBMinosProcessMessages").createMessageTimestamp(R,O,m);t.addPoint("encrypt_message_start");var W=yield o("EBMinosWasmEncryptAndSignMessage").encryptAndSignMessage({mekKey:A.key,metadata:{mekId:A.mekId,messageId:m,threadId:P,timestamp:B},plaintext:new Uint8Array(y),transportSigningPK:T.pk,transportSigningSK:T.sk});if(!W.success)return d.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["message encryption error: ",""])),W.error),t.addPoint("encrypt_message_fail"),o("WAResultOrError").makeError("encrypt-message-error");t.addAnnotations({int:{message_encryption_version:W.value.version}}),t.addPoint("encrypt_message_end");var q=yield o("EBGetMinosAttachmentPayloadFromMpsMessage").getMinosAttachmentPayloadFromMpsMessage({logger:d,message:{messageId:m,payload:y,senderId:C,threadId:S,timestampMs:R},qplFlow:t});d.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose([""," attchmentSecrets generated"])),q.length);var U=$(a,y),V=U.frankingTag,H=U.reportingTag;return o("WAResultOrError").makeResult({attachmentPayload:q,backupActionType:i.actionType,backupFbid:n.backupFbid,deletionOfflineThreadingId:a,encryptedMsg:W.value.encryptedMsg,encryptedMsgSignature:W.value.signature,frankingTag:V,isEphemeral:s,mekFbid:F,mekId:A.mekId,messageEncryptionVersion:W.value.version,messageMetadataVersion:O,messageTimestampMs:R,otid:m,reportingTag:H,supplementalOpToken:b,tags:v,toplevelOfflineThreadingId:o("MpsTypes").toMessageId(i.originalMsgProtocolId.externalId),transportSigningPK:T.pk,waThreadId:S})});return function(n){return e.apply(this,arguments)}})(),x=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.encryptedMessage,a=e.encryptedMsgSignature,i=e.entryPoint,l=e.mekCreatorInfo,u=e.mekFbid,c=e.mekInfo,m=e.messageEncryptionVersion,p=e.messageInfo,_=e.messageMetadataVersion,f=e.recipientInfo,g=e.source,h=e.threadId,R=e.transportSigningPK,L=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:i,isMinos:!0,source:g,threadId:h});L.addAnnotations({bool:{mek_reuse_enabled:r("gkx")("7918")},int:{mek_creation_time_sec:c.mekCreationTimestamp,mek_encryption_version:c.mekEncryptionVersion,message_encryption_version:m,metadata_version:_,timestamp_ms:p.timestamp},string:{mek_fbid:u,message_id:p.messageId,platform_type:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(o("WAStanzaUtils").toStanzaId(p.messageId)),sender_type:l.senderType}}),L.addPoint("load_self_minos_epoch_for_decryption_start");var E=yield s(f.epochFbId,c.mekEncryptionVersion);if(!E.success&&r("gkx")("269")&&E.error==="no-self-epoch-found"){d.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["no self epoch found - will try to sync epochs"]))),L.addPoint("sync_epochs_start");var I=yield o("EBDeps").getDeps().getEBSMAPI(),T=yield I.repairEpochs();T.success?(L.addPoint("sync_epochs_end"),E=yield s(f.epochFbId,c.mekEncryptionVersion)):(d.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["sync epochs error: ",""])),T.error),L.addAnnotations({string:{sync_epochs_error:T.error.message,sync_epochs_error_code:T.error.errorCode}}),L.addPoint("sync_epochs_fail"))}if(!E.success)return d.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["epoch decryption error for message ID ",": ",""])),p.messageId,E.error),L.endFailWithError("load_self_minos_epoch_for_decryption_fail",E.error),o("WAResultOrError").makeError(E.error);L.addPoint("load_self_minos_epoch_for_decryption_end"),L.addPoint("derive_mailbox_encryption_key_pair_start");var D=yield o("EBMinosWasmDeriveMailboxEncryptionKeypair").deriveMailboxEncryptionKeypair({epochNumber:f.epochAnonId,exportRootKey:E.value.exportRootKey});if(!D.success)return d.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["mailbox encryption key pair derivation error for message ID ",": ",""])),p.messageId,D.error),L.endFailWithError("derive_mailbox_encryption_key_pair_fail",D.error),o("WAResultOrError").makeError("derive-mailbox-keys-error");var x=D.value.sk;L.addPoint("derive_mailbox_encryption_key_pair_end"),L.addPoint("get_or_decrypt_message_encryption_key_start");var $=yield P({logger:d,mailboxEncryptionSK:x,mekCreatorInfo:l,mekFbid:u,mekInfo:c,mekStorageDecrypt:k,minosThreadId:p.threadId,qplFlow:L,recipientEpochHead:(t=f.epochHead)!=null?t:E.value.exportEpochHead,transportSigningPK:R});if(!$.success){var N;return L.endFailWithError($.error.errorName,(N=$.error.failReason)!=null?N:"decrypt-mek-error"),o("WAResultOrError").makeError("decrypt-mek-error")}L.addPoint("get_or_decrypt_mailbox_encryption_key_end",{string:{mekCacheStatus:$.value.cacheStatus}}),L.addPoint("decrypt_and_verify_message_start");var M=yield o("EBMinosWasmDecryptAndVerifyMessage").decryptAndVerifyMessage({cipherText:n,mekKey:$.value.mekKey,messageEncryptionVersion:m,metadata:{mekId:c.mekId,messageId:p.messageId,threadId:p.threadId,timestamp:p.timestamp},signature:a,transportSigningPK:R});if(!M.success){var w=M.error,A=w.errorName,F=w.failReason;return d.ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["message decryption error for message ID ",": ",""])),p.messageId,F!=null?F:A),L.endFailWithError("decrypt_and_verify_message_fail",F!=null?F:A),o("WAResultOrError").makeError("decrypt-message-error")}return L.addPoint("decrypt_and_verify_message_end"),L.endSuccess(),o("WAResultOrError").makeResult(M.value)});return function(n){return e.apply(this,arguments)}})();return o("WAResultOrError").makeResult({decryptMessage:x,encryptMessage:D})}),I.apply(this,arguments)}var T=null;function D(t){if(T!=null){o("EBMinosLogger").minosLogger.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is already set"])));return}o("EBMinosLogger").minosLogger.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is initialized"]))),T=t}function x(){if(T==null)throw o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is not set"]))),r("err")("Minos crypto library is not set");return T}function $(e,t){var n=null,r=null;if(e==null){var a,i,l=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),s=(a=l.proto.metadata)==null||(a=a.frankingMetadata)==null?void 0:a.frankingTag;s==null?o("EBMinosLogger").minosLogger.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["missing frankingTag in upload"]))):n=o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s));var u=(i=l.proto.metadata)==null||(i=i.frankingMetadata)==null?void 0:i.reportingTag;u==null?o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["missing reportingTag in upload"]))):r=o("WAFrankingTypes").castToReportingTag(new Uint8Array(u))}return{frankingTag:n,reportingTag:r}}function P(e){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mailboxEncryptionSK,a=e.mekCreatorInfo,i=e.mekFbid,l=e.mekInfo,s=e.mekStorageDecrypt,u=e.minosThreadId,c=e.qplFlow,d=e.recipientEpochHead,m=e.transportSigningPK;if(r("gkx")("7918")){var p=yield s.getMessageEncryptionKeyDecrypt({mekId:l.mekId});if(c.addAnnotations({bool:{mek_reuse:p!=null}}),p!=null)return o("WAResultOrError").makeResult({cacheStatus:p.cacheStatus,mekKey:p.registeredMek.mek.key})}c.addPoint("decrypt_mek_start");var _=a.senderType==="Transport"?yield o("EBMinosWasmDecryptMekForDistributionFromTransportSender").decryptMekForDistributionFromTransportSender({mekDistribution:{encryptedMek:l.encryptedMek,ephemeralEncryptionPk:a.transportSenderEphemeralPK,recipientEpochHead:d,signature:a.transportSenderEphemeralKeySig,signingPk:m},mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEncSk:n,rosterHash:l.mekRosterHash}):yield o("EBMinosWasmDecryptMekForDistribution").decryptMekForDistribution({encryptedMek:l.encryptedMek,mailboxAuthPk:a.senderMailboxAuthPK,mailboxEncSk:n,mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEpochHead:d,rosterHash:l.mekRosterHash,senderEpochHead:a.senderEpochHead});if(c.addPoint("decrypt_mek_end"),!_.success)return t.ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["mek decryption error: ",""])),_.error),_;if(r("gkx")("7918")&&a.senderType!=="Transport"){var f={key:_.value,mekId:l.mekId,rosterHash:l.mekRosterHash},g={mek:f,mekFbid:i};yield s.setNewMessageEncryptionKeyDecrypt({createdBySelf:!1,lastUsedTsMs:o("MpsTypes").toTimestamp(Date.now()),minosThreadId:u,registeredMek:g})}return o("WAResultOrError").makeResult({cacheStatus:"new",mekKey:_.value})}),N.apply(this,arguments)}function M(e){return w.apply(this,arguments)}function w(){return w=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.actThreadId,r=e.io,a=e.logger,i=e.mailboxKeys,l=e.mekStorage,s=e.minosThreadId,u=e.msgUploadQpl,c=e.rosterHash,d=e.transportSigningKeypair,m=yield r.loadMostRecentSelfMinosEpoch().then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e==null)return o("WAResultOrError").makeError("unable-to-get-latest-epoch");var t=yield o("EBMinosWasmDeriveMailboxAuthKeypair").deriveMailboxAuthKeypair({epochNumber:e.epochNumber,exportRootKey:e.exportRootKey});return t.success?(u.addAnnotations({string:{epoch_fbid:e.epochFbId,epoch_head:o("Base64Utils").fromArrayBuffer(e.epochHead)}}),o("WAResultOrError").makeResult({epochFbId:e.epochFbId,epochHead:e.epochHead,mailboxAuthKeyPair:t.value})):(a.ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["Unable to get mailbox auth key pair for sender - failed with exception ",""])),t.error),o("WAResultOrError").makeError("unable-to-get-sender-mailbox-auth-key-pair"))});return function(t){return e.apply(this,arguments)}})()),p=m.success?{fromKeypair:m.value.mailboxAuthKeyPair,senderEpochFbId:m.value.epochFbId,senderEpochHead:m.value.epochHead,senderType:"Minos"}:{senderType:"Transport",transportSigningKp:d};if(p.senderType!=="Transport"){var _=yield l.getMessageEncryptionKey({mekCreatorEpochHead:p.senderEpochHead,minosThreadId:s,rosterHash:c});if(_!=null)return o("WAResultOrError").makeResult(_)}var f=yield o("EBGenerateAndUploadMek").generateAndUploadMek({actThreadId:t,io:{registerMinosMessageEncryptionKey:r.registerMinosMessageEncryptionKey},logger:a,msgUploadQpl:u,participantMailboxes:i,sender:p});if(!f.success)return a.ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["mek register error: ",""])),f.error),o("WAResultOrError").makeError("register-mek-error");var g={mek:f.value.mek,mekFbid:f.value.mekFbid};return p.senderType!=="Transport"&&(yield l.setNewMessageEncryptionKey({createdBySelf:!0,lastUsedTsMs:o("MpsTypes").toTimestamp(Date.now()),mekCreatorEpochHead:p.senderEpochHead,minosThreadId:s,registeredMek:g,rosterHash:c})),o("WAResultOrError").makeResult({cacheStatus:"new",registeredMek:g})}),w.apply(this,arguments)}l.createMinosCryptoLibrary=k,l.setMinosCryptoLibrary=D,l.getMinosCryptoLibrary=x}),98);
__d("EBMinosSaveNewMinosMessageEpochHead",["EBMinosDb","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield o("EBMinosDb").getEBMinosDb();yield r.runInTransaction(["secure_minos_message_epoch_heads"],"readwrite",function(r){return r.stores.secure_minos_message_epoch_heads.bulkPut([{epoch_head:e,message_id:t,thread_id:n}])},"SaveNewMinosMessageEpochHead")});return function(n,r,o){return e.apply(this,arguments)}})();l.saveNewMinosMessageEpochHead=e}),98);
__d("EBMinosDecryptMessages",["EBMinosCryptoLibrary","EBMinosLogger","EBMinosProcessMessages","EBMinosSaveNewMinosMessageEpochHead","EBMinosTypes","MpsThreadIdToMinosThreadId","MpsTypes","Promise","WAGlobals","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e){var t=e.keys.mekCreatorInfo.minosKeys,n=e.keys.mekCreatorInfo.transportKeys;return t!=null?{senderEpochHead:t.senderEpochHead,senderMailboxAuthPK:t.senderAuthPk,senderType:"Minos"}:n?{senderType:"Transport",transportSenderEphemeralKeySig:n.ephmSignature,transportSenderEphemeralPK:n.ephmHpkePk}:null}function d(e,t,n,r,o,a,i){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l,s){var u=r.get(a.mekFbid);if(u==null)return o("WAResultOrError").makeError("missing-encrypted-mek");var d=c(u);if(d==null)return o("WAResultOrError").makeError("missing-mek-creator-info");var m=o("EBMinosProcessMessages").createMessageTimestamp(a.protobufTimestamp,a.messageMetadataVersion,n),p=yield o("EBMinosCryptoLibrary").getMinosCryptoLibrary().decryptMessage({encryptedMessage:a.encryptedProtobuf,encryptedMsgSignature:a.transportSenderMessageSignature,entryPoint:s,mekCreatorInfo:d,mekFbid:a.mekFbid,mekInfo:u.keys.mekInfo,messageEncryptionVersion:a.messageEncryptionVersion,messageInfo:{messageId:n,threadId:t,timestamp:m},messageMetadataVersion:a.messageMetadataVersion,recipientInfo:u.keys.recipientInfo,source:l,threadId:i,transportSigningPK:a.transportSenderSigningPk});if(!p.success)return o("WAResultOrError").makeError(p.error);var _={decryptedProtobuf:p.value,decryptedSupplementalKey:null,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(a.protobufTimestamp)};return d.senderType==="Minos"&&(yield o("EBMinosSaveNewMinosMessageEpochHead").saveNewMinosMessageEpochHead(d.senderEpochHead,n,i).catch(function(t){return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["saveNewMinosMessageEpochHead failed with error: ",""])),t),o("WAResultOrError").makeError("failed-to-save-epoch-head")})),o("WAResultOrError").makeResult(_)}),m.apply(this,arguments)}function p(e,t,n,r,o,a,i){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l){var u=n.supplementalOtid,d=t.get(n.mekFbid);if(d==null)return o("WAResultOrError").makeError("missing-encrypted-mek");var m=c(d);if(m==null)return o("WAResultOrError").makeError("missing-mek-creator-info");if(u==null)return o("WAResultOrError").makeError("missing-supplemental-otid");var p=o("MpsTypes").toMessageId(u),_=o("EBMinosProcessMessages").createMessageTimestamp(n.protobufTimestamp,n.messageMetadataVersion,p),f=yield o("EBMinosCryptoLibrary").getMinosCryptoLibrary().decryptMessage({encryptedMessage:n.encryptedProtobuf,encryptedMsgSignature:n.transportSenderMessageSignature,entryPoint:l,mekCreatorInfo:m,mekFbid:n.mekFbid,mekInfo:d.keys.mekInfo,messageEncryptionVersion:n.messageEncryptionVersion,messageInfo:{messageId:p,threadId:e,timestamp:_},messageMetadataVersion:n.messageMetadataVersion,recipientInfo:d.keys.recipientInfo,source:i,threadId:a,transportSigningPK:n.transportSenderSigningPk});if(!f.success)return o("WAResultOrError").makeError(f.error);var g={decryptedProtobuf:f.value,decryptedSupplementalKey:r,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(n.protobufTimestamp)};return m.senderType==="Minos"&&(yield o("EBMinosSaveNewMinosMessageEpochHead").saveNewMinosMessageEpochHead(m.senderEpochHead,p,a).catch(function(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["saveNewMinosMessageEpochHead failed with error: ",""])),e),o("WAResultOrError").makeError("save-epoch-head-error")})),o("WAResultOrError").makeResult(g)}),_.apply(this,arguments)}function f(e,t,n,r,o){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=new Map,s=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(s==null)return o("WAResultOrError").makeError("invalid-self-fbid");var c=yield o("MpsThreadIdToMinosThreadId").mpsThreadIdToMinosThreadId(e,s);if(!c.success)return o("WAResultOrError").makeError("create-minos-thread-id-error");var m=[];return yield(u||(u=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(r){var s=r.messageTags,_=r.otid,f=r.supplementalProtobufsV2,g=r.topLevelProtobufV2,h=yield d(c.value,_,t,g,e,a,i);if(!h.success)return m.push("failed_to_decrypt_top_level_protobuf_"+h.error);var y=new Map;f!=null&&(yield(u||(u=n("Promise"))).all(f.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.supplementalKey;if(r!=null){var l=yield p(c.value,t,n,r,e,a,i);if(l.success)y.set(o("MpsTypes").toSupplementalKey(r),l.value);else return m.push("failed_to_decrypt_supplemental_level_protobuf_"+l.error)}});return function(e){return r.apply(this,arguments)}})()))),l.set(_,{messageTags:s,otid:_,supplementalProtobufs:y,topLevelProtobuf:h.value})});return function(e){return r.apply(this,arguments)}})())),o("WAResultOrError").makeResult({decryptionResult:l,errorMessages:m})}),g.apply(this,arguments)}l.minosDecryptMessages=f}),98);
__d("WATypedArraysCast",["WABase64"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return t instanceof e?t:typeof t=="string"?new e(o("WABase64").decodeB64(t)):new e(t)}l.castTypedArrays=e}),98);
__d("WACryptoHmac",["WACryptoDependencies","WATypedArraysCast"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=new Uint8Array(e),u={name:"HMAC",hash:"SHA-256"},c={name:"HMAC",hash:"SHA-512"},d={name:"HMAC",hash:"SHA-1"};function m(e,t){var n=o("WATypedArraysCast").castTypedArrays(Uint8Array,t);return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",n,e,!1,["sign"]).then(function(t){return{key:t,algo:e}})}function p(e){return m(u,e)}function _(e,t,n){var r=e.algo,a=e.key;return o("WACryptoDependencies").getCrypto().subtle.sign(r,a,t).then(function(e){return n!=null&&n!==0?e.slice(0,n):e})}function f(e,t){return m(u,e!=null?e:s).then(function(e){return _(e,t)})}function g(e,t,n){return m(u,e).then(function(e){return _(e,t,n)})}function h(e,t,n){return m(c,e).then(function(e){return _(e,t,n)})}function y(e,t,n){return m(d,e).then(function(e){return _(e,t,n)})}l.SHA256_BYTE_LENGTH=e,l.DEFAULT_SALT=s,l.encodeKeySha256=p,l.sign=_,l.extractSha256=f,l.hmacSha256=g,l.hmacSha512=h,l.hmacSha1=y}),98);
__d("WAFranking",["$InternalEnum","QPLFlow","WACryptoDependencies","WACryptoHmac","WACryptoUtils","WAFrankingTypes","WAGlobals","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=0,u=n("$InternalEnum").Mirrored(["KEEP","DROP"]);function c(){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WAFrankingTypes").castToFrankingKey(t)}function d(e){return e!=null?e:s}function m(e,t){return o("WACryptoHmac").hmacSha256(e,t).then(function(e){return o("WAFrankingTypes").castToFrankingTag(new Uint8Array(e))})}function p(e,t,n,r){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){switch(r){case void 0:case 0:{var a=yield o("WACryptoHmac").hmacSha256(t,e);return o("WACryptoUtils").uint8ArraysEqual(new Uint8Array(a),n)}default:return!0}}),_.apply(this,arguments)}function f(e,t){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n,r,a,i=o("WAGlobals").getConfig().isFrankingDropOnInvalid(),l=o("QPLFlow").startQPLFlow(o("WAGlobals").getWaQpl().franking);if((t==null?void 0:t.frankingTag)!=null&&((n=e.metadata)==null?void 0:n.frankingKey)==null){var s;return t.frankingTag=null,t.reportingTag=null,l.endFail("missingFrankingKey",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((s=e.metadata)==null?void 0:s.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),{decision:u.KEEP,updatedReportingMeta:t}}if((t==null?void 0:t.frankingTag)!=null&&e.version==="v3"&&e.type==="subprotocol"&&((r=e.metadata)==null?void 0:r.frankingKey)!=null&&e.frankingContent!=null){var c=t.frankingTag,d=e.frankingContent,m=e.metadata.frankingVersion,_=o("WAFrankingTypes").castToFrankingKey(new Uint8Array(e.metadata.frankingKey));return _==null?(l.endFail("tagButNoKey"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}):(yield p(new Uint8Array(d),_,c,m))?(t.frankingKey=_,t.reportingContent=d,l.endSuccess(),{decision:u.KEEP,updatedReportingMeta:t}):(l.endFail("tagMismatch"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t})}return l.endFail("potentialDropCandidate",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((a=e.metadata)==null?void 0:a.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),o("WAGlobals").getConfig().isFrankingDropOnMissing()?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}}),g.apply(this,arguments)}l.FrankingDecision=u,l.createFrankingKey=c,l.getFrankingVersion=d,l.genFrankingTag=m,l.validateFrankingTag=p,l.handleAndValidateFrankingFromIncomingMsg=f}),98);
__d("EBValidateMinosMessages",["EBMinosLogger","EBMinosProcessMessages","EBMinosTypes","MAWProtobufDeserializers","MpsTypes","Promise","WAArmadilloXMA.pb","WACryptoUtils","WAFranking","WAFrankingTypes","WAGlobals","WALongInt","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n,r){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a,i){var l=yield(c||(c=n("Promise"))).all(e.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.otid,i=e.topLevelProtobufV2.protobufTimestamp,l=e.topLevelProtobufV2.actorToken,c=t.get(n);if(c==null)return t.delete(n),"message-id-not-found";var d=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(c.topLevelProtobuf.decryptedProtobuf);if(d==null)return t.delete(n),"failed-to-deserialize-decrypted-protobuf";var m=d.proto.metadata;if(m==null)return t.delete(n),"protobuf-message-metadata-null";var g=m.timestampMs;if(g==null)return t.delete(n),"minos-protobuf-timestamps-mismatch";try{var h=o("WALongInt").numberOrThrowIfTooLarge(g);if(o("MpsTypes").toTimestamp(h)!==i)return t.delete(n),"minos-protobuf-timestamps-mismatch"}catch(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["timestamp-convert-error-",""])),r("getErrorSafe")(e).message),t.delete(n),"timestamp-covert-error"}if(m.senderId==null||o("EBMinosTypes").unsafeCastToUserFbId(m.senderId)!==l)return t.delete(n),"sender-id-actor-token-mismatch";var y=d.payload();if(y==null)return t.delete(n),"protobuf-message-payload-null";if(p(d,l))return t.delete(n),"peer-only-protobuf-message-validation-failure";if(_(d))return t.delete(n),"calling-xma-protobuf-message-validation-failure";var C=yield f(d,a);if(!C.success)return t.delete(n),o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["act sanitizer validation failed: ",""])),C.error),"act_sanitizer_validation_failed";if(y.kind==="messageApplication"){var b,v,S,R,L=y.consumerMessage(),E=L==null||(b=L.payload)==null||(b=b.applicationData)==null?void 0:b.revoke;if(E!=null)return;var k=(v=y.proto.metadata)==null?void 0:v.frankingKey,I=y.bytes,T=e.topLevelProtobufV2.frankingTag,D=(S=y.proto.metadata)==null?void 0:S.frankingVersion;if(k==null)return t.delete(n),"franking-key-null";if(T==null)return r("gkx")("704")&&t.delete(n),"franking-tag-null";var x=yield o("WAFranking").validateFrankingTag(new Uint8Array(I),o("WAFrankingTypes").castToFrankingKey(new Uint8Array(k)),o("WAFrankingTypes").castToFrankingTag(new Uint8Array(T)),D);if(x===!1)return r("gkx")("704")&&t.delete(n),"franking-tag-validation-failed";var $=e.topLevelProtobufV2.reportingTag,P=(R=m.frankingMetadata)==null?void 0:R.reportingTag;if($==null||P==null)return r("gkx")("704")&&t.delete(n),"reporting-tag-null";if(!o("WACryptoUtils").arrayBuffersEqual($.buffer,P))return r("gkx")("704")&&t.delete(n),"reporting-tag-mismatch";var N=m.clientTimestampMs;if(N!=null?N=o("WALongInt").numberOrThrowIfTooLarge(N):N=o("EBMinosProcessMessages").extractTimestampFromOtid(n),Math.abs(N-i)>36e5)return t.delete(n),"client_server_timestamp_delta_over_1_hour"}});return function(t){return e.apply(this,arguments)}})())),d=l.filter(Boolean);return i.addAnnotations({bool:{minos_validation_success:d.length===0},string_array:{minos_validation_errors:d}}),t}),m.apply(this,arguments)}function p(t,n){var r,a=(r=t.encryptedTransportMessage())==null||(r=r.armadillo())==null||(r=r.payload)==null||(r=r.applicationData)==null||(r=r.metadataSync)==null?void 0:r.actions;if(a==null)return!1;var i=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(i==null)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed-to-get-userFbid"]))),!0;for(var l of a!=null?a:[])if((l.attachmentInterventionAction!=null||l.chatAction!=null||l.messageAction!=null||l.spectraAction!=null)&&i!==n)return!0;return!1}function _(e){var t,n=(t=e.encryptedTransportMessage())==null||(t=t.armadillo())==null||(t=t.extendedContentMessage())==null||(t=t.payload)==null?void 0:t.targetType;return!r("gkx")("5782")||n==null?!1:n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_ONGOING_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_ONGOING_VIDEO_CALL}function f(e,t){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n,r=(n=e.encryptedTransportMessage())==null||(n=n.armadillo())==null||(n=n.payload)==null||(n=n.content)==null?void 0:n.extendedContentMessage;if(r==null)return o("WAResultOrError").makeResult();var a=yield t(r);return a}),g.apply(this,arguments)}l.validateMinosMessages=d}),98);
__d("EBMinosDecryptAndValidateMessages",["Base64Utils","EBMinosDecryptMessages","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBValidateMinosMessages","MpsTypes","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(t){if(t==null)return null;var n=t.id,r=t.keys;if(n==null||r==null)return null;var a=o("EBMinosTypes").unsafeCastToMekFbId(n),i=r.mek_creator_info,l=r.mek_info,s=r.recipient_info;if(l==null||i==null||s==null)return null;var u=l.encrypted_mek,c=l.mek_creation_timestamp,d=l.mek_encryption_version,m=l.mek_id,p=l.roster_hash;if(u==null||d==null||m==null||p==null||c==null)return null;var _=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(d);if(_==null)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast mek encryption version: ",""])),d),null;var f={encryptedMek:o("EBMinosTypes").unsafeCastToEncryptedMek(o("Base64Utils").toArrayBuffer(u)),mekCreationTimestamp:o("MpsTypes").toTimestamp(parseInt(c,10)),mekEncryptionVersion:_,mekId:o("EBMinosTypes").unsafeCastToMekId(o("Base64Utils").toArrayBuffer(m)),mekRosterHash:o("EBMinosTypes").unsafeCastMekRosterHash(o("Base64Utils").toArrayBuffer(p))},g=s.epoch_anon_id,h=s.epoch_fbid,y=s.epoch_head;if(g==null||h==null||y==null)return null;var C={epochAnonId:o("EBMinosTypes").unsafeCastToEpochNumber(o("WALongInt").decimalStringToLongInt(new TextDecoder().decode(o("Base64Utils").toArrayBuffer(g)))),epochFbId:o("EBMinosTypes").unsafeCastToEpochFbId(h),epochHead:o("EBMinosTypes").unsafeCastToEpochHead(o("Base64Utils").toArrayBuffer(y))},b=i.minos_keys,v=i.transport_keys;if(b==null&&v==null)return null;var S=b!=null?b:{},R=S.sender_auth_pk,L=S.sender_epoch_head,E=R!=null&&L!=null?{senderAuthPk:o("EBMinosTypes").unsafeCastToMailboxAuthPK(o("Base64Utils").toArrayBuffer(R)),senderEpochHead:o("EBMinosTypes").unsafeCastToEpochHead(o("Base64Utils").toArrayBuffer(L))}:null,k=v!=null?v:{},I=k.ephm_hpke_pk,T=k.ephm_signature,D=k.mek_creator_transport_signing_pk,x=I!=null&&T!=null&&D!=null?{ephmHpkePk:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralPK(o("Base64Utils").toArrayBuffer(I)),ephmSignature:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralKeySig(o("Base64Utils").toArrayBuffer(T)),mekCreatorTransportSigningPk:o("EBMinosTypes").unsafeCastToTransportSigningPK(o("Base64Utils").toArrayBuffer(D))}:null;return E==null&&x==null?null:{id:a,keys:{mekCreatorInfo:{minosKeys:E,transportKeys:x},mekInfo:f,recipientInfo:C}}}function p(e){var t=new Map((e!=null?e:[]).map(function(e){return e.id==null?null:[o("EBMinosTypes").unsafeCastToMekFbId(e.id),m(e)]}).filter(Boolean));return t}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.encryptedMinosMessages,n=e.entryPoint,r=e.minosDecryptionKeys,a=e.qplFlow,i=e.source,l=e.threadId,m=e.validator;if(t.length===0)return o("WAResultOrError").makeResult({decryptionResult:new Map,errorMessages:[]});try{var _=p(r),f=yield o("EBMinosDecryptMessages").minosDecryptMessages(l,_,t,i,n);if(!f.success)return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["decrypt msgs failed: "," }"])),f.error),f;if(o("EBMinosLogger").minosLogger.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["decrypt msgs completed. total: ",", success: ",", failed: ",""])),t.length,f.value.decryptionResult.size,f.value.errorMessages.length),f.value.decryptionResult.size===0)return f;var g=yield o("EBValidateMinosMessages").validateMinosMessages(t,f.value.decryptionResult,m,a);return o("EBMinosLogger").minosLogger.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["validate msgs completed. total: ",", success: ",""])),t.length,g.size),o("WAResultOrError").makeResult({decryptionResult:g,errorMessages:f.value.errorMessages})}catch(e){return o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to decrypt messages: ",""])),e),o("WAResultOrError").makeError("runtime-error")}}),f.apply(this,arguments)}l.minosDecryptAndValidateMessages=_}),98);
__d("EBgenerateMPSMessageQuery",["EBGraphQLRestoreDefinition","MSGDataclassTypes.flow"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return{__typename:"MPSMessageQuery",ctx:{__typename:"MPSQueryContext",caller:o("MSGDataclassTypes.flow").MpsQueryCaller.HistoryRestore},query:{__typename:"MPSMessagePointQuery",include_deleted:!1,otids:t,thread_id:e}}}function s(t,n){return o("EBGraphQLRestoreDefinition").toMpsMessageQueryForGraphQLQuery(JSON.stringify(e(t,n)))}l.generateMPSMessageQuery=e,l.generateMPSMessageQueryForGraphQLQuery=s}),98);
__d("EchoConstants",[],(function(t,n,r,o,a,i){"use strict";var e=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);i.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=e}),66);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","FBLogger","MAWMsgType","WABase64"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set(['"',"\\","\n","\r","\0"]),s=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"',"\\"]);function u(e,t){for(var n of t)if(e.indexOf(n)>=0)return!0;return!1}function c(t,n,o){if(o===void 0&&(o=new Set),t.length<=0)throw r("FBLogger")("wmi_eb").mustfixThrow("The input string must be non-empty");var a=n;if(n==="conditional"&&(u(t,o)?a="always":a="never"),a==="never")return t;for(var i='"',l=0;l<t.length;l++){var s=t[l];e.has(s)?(i+="\\",s==="\r"?i+="r":s==="\n"?i+="n":i+=s):i+=s}return i+'"'}function d(e){if(!Number.isSafeInteger(e))throw r("FBLogger")("wmi_eb").mustfixThrow("The input value must be a safe integer");return e.toString()}function m(e){var t="",n=e.displayName,r=e.localKey,a=e.transportKey;return n!=null&&n.length>0&&(t+=c(n,"always")+" <"),t+=c(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a,n!=null&&n.length>0&&(t+=">"),t}function p(e,t,n){n!=null&&n.length!==0&&e.set(t,c(n,"conditional",s))}function _(e,t,n){if(n!=null){var r=d(n);p(e,t,r)}}function f(e,t,n){if(n!=null){var r=d(n?1:0);p(e,t,r)}}function g(e,t,n){n!=null&&e.set(t,m(n))}function h(e,t,n){if(n!=null){var r="";n.forEach(function(e,t){r+=m(e),t<n.length-1&&(r+=", ")}),e.set(t,r)}}function y(e){var t="";return e.forEach(function(e,n){t=t+n+": "+e+"\r\n"}),t}function C(e){return o("WABase64").encodeB64UrlSafe(e)}function b(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("EchoMessage").EchoXMessageContentType.TEXT;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("EchoMessage").EchoXMessageContentType.IMAGE;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("EchoMessage").EchoXMessageContentType.VIDEO;case o("MAWMsgType").MSG_TYPE.PTT:return o("EchoMessage").EchoXMessageContentType.AUDIO;case o("MAWMsgType").MSG_TYPE.STICKER:return o("EchoMessage").EchoXMessageContentType.STICKER;case o("MAWMsgType").MSG_TYPE.GIF:return o("EchoMessage").EchoXMessageContentType.GIF;case o("MAWMsgType").MSG_TYPE.XMA:return o("EchoMessage").EchoXMessageContentType.XMA;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("EchoMessage").EchoXMessageContentType.DOCUMENT;case o("MAWMsgType").MSG_TYPE.REACTION:return o("EchoMessage").EchoXMessageContentType.REACTION;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("EchoMessage").EchoXMessageContentType.UNSEND;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("EchoMessage").EchoXMessageContentType.BUMP;default:return o("EchoMessage").EchoXMessageContentType.UNKNOWN}}l.echoSetStringField=p,l.echoSetIntField=_,l.echoSetBooleanField=f,l.echoSetAddressField=g,l.echoSetAddressListField=h,l.echoEncodeFields=y,l.convertMediaKeyToString=C,l.convertDbMsgTypeToXMessageContentType=b}),98);
__d("EchoCommonUtils",[],(function(t,n,r,o,a,i){"use strict";var e="Echo-Doc-Version";function l(e,t){var n=e.localKey,r=e.transportKey;return n+"@"+r+"-"+t}function s(e,t,n){return e==null?{localKey:t,transportKey:n}:{displayName:e,localKey:t,transportKey:n}}i.ECHO_COMMON_FIELD_DOCUMENT_VERSION=e,i.getEchoAddressFieldNameWithSuffix=l,i.craftEchoAddress=s}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(t,n,r,o,a,i,l,s){"use strict";var e,u,c,d,m,p,_,f,g,h,y,C,b,v=new Set([]);function S(t,n){if(t.length!==0){var r=t.indexOf(":");if(r===-1){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."])));return}var a=t.substring(0,r).trim(),i=t.substring(r+1).trim();if(a.length===0){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"])));return}if(i.length===0){n.has(a)&&n.delete(a);return}n.set(a,i)}}function R(e,t,n,r){n===void 0&&(n=new Set);for(var a=!1,i=t==="conditional"&&e[0]==='"',l="",s=i?1:0;s<e.length;){var u=e[s];if(t==="conditional"&&!i&&u==='"'||!i&&n.has(u))break;if(i&&!a&&u==='"'){i=!1,s++;break}if(i&&!a&&u==="\\"){if(s===e.length-1)break;a=!0}else a&&u==="r"?l+="\r":a&&u==="n"?l+="\n":l+=u,a=!1;s++}if(i||l.length===0){var d=r!=null?r:"unknown";return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""])),d),{remainder:e,result:null,success:!1}}return{remainder:e.substring(s),result:l,success:!0}}function L(e,t){if(e.length===0)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"]))),{remainder:e,result:null,success:!1};var n=e.trimLeft(),r=R(n,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,t);if(!r.success)return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"]))),{remainder:e,result:null,success:!1};if(r.result!=null||s(0,47923),r.remainder[0]==="@"){var a=E(r.remainder,r.result,t);return{remainder:a.remainder,result:a.result,success:a.success}}var i=r.result,l=r.remainder.trimLeft();if(l.startsWith("<")){var u=E(l.substring(1),void 0,t),c=u.result,_=u.remainder;if(u.success&&c!=null&&_.startsWith(">"))return i.length===0?{remainder:_.substring(1),result:c,success:!0}:{remainder:_.substring(1),result:babelHelpers.extends({},c,{displayName:i}),success:!0}}return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"]))),{remainder:e,result:null,success:!1}}function E(e,t,n){var r=t==null?e.trimLeft():e,a=t;if(a==null){var i=R(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n);if(!i.success)return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"]))),{remainder:e,result:null,success:!1};a=i.result,r=i.remainder}if(a==null||a.length===0||r[0]!=="@")return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"]))),{remainder:e,result:null,success:!1};var l=R(r.substring(1),"never",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n),s=l.result;return l.success&&s!=null&&s.length>0?{remainder:l.remainder,result:{localKey:a,transportKey:s},success:!0}:(o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"]))),{remainder:e,result:null,success:!1})}function k(e,t){if(e.length===0)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"]))),{result:null,success:!1};var n=L(e,t);if(!n.success)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""])),e),{result:null,success:!1};n.result!=null||s(0,47927);for(var r=[n.result],a=n.remainder;a.startsWith(",");){var i=L(a.substring(1).trimLeft(),t);if(i.success)i.result!=null&&r.push(i.result),a=i.remainder;else break}return{result:r,success:!0}}function I(e){var t=new Map,n=e.split("\r\n");return n.length===1&&n[0]===e?(o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"]))),t):(n.forEach(function(e){return S(e,t)}),t)}function T(e,t){var n=e.get(t);if(n==null||n.length===0||n==='""')return{result:null,success:!1};var r=R(n,"conditional",v,t),o=r.result,a=r.success;return{result:o,success:a}}function D(e,t){var n,r=x(e,t);return{result:(n=r.result)!=null?n:0,success:r.success}}function x(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=parseInt(n,10);return isNaN(r)?(o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"])),t),{result:null,success:!1}):Number.isSafeInteger(r)?{result:r,success:!0}:{result:r>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function $(e,t){var n,r=P(e,t);return{result:(n=r.result)!=null?n:!1,success:r.success}}function P(e,t){var n=x(e,t);return!n.success||n.result!==0&&n.result!==1?{result:null,success:!1}:{result:n.result===1,success:!0}}function N(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=L(n,t),o=r.result,a=r.success;return{result:o,success:a}}function M(e,t){var n=e.get(t);return n==null||n.length===0?{result:null,success:!1}:k(n,t)}function w(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=n.split(",").map(function(e){return e.trim()}).filter(Boolean);return r.length===0?{result:null,success:!1}:{result:r,success:!0}}l.echoDecodeFields=I,l.echoDecodeStringField=T,l.echoDecodeIntField=D,l.echoDecodeNullableIntField=x,l.echoDecodeBooleanField=$,l.echoDecodeNullableBooleanField=P,l.echoDecodeAddressField=N,l.echoDecodeAddressListField=M,l.echoDecodeObjectIdListField=w}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f="Message-ID",g="Thread-ID",h="Sort-Order",y="Display-Timestamp",C="Authoritative-Timestamp",b="From",v="Text",S="Text-Size",R="Send-Error",L="Is-Tombstoned",E="Expire-Timestamp",k="Delete-Timestamp",I="Ephemeral-Duration",T="Message-Content-Type",D="X-Message-Content-Type",x="Message-Content-Subtype",$="Is-Forwarded",P="X-Offline-Threading-ID",N="X-Thread-ID",M="X-Message-Placeholder-Type",w="Reactions",A="Reaction-Authoritative-Timestamps",F="X-Reaction-Offline-Threading-IDs",O="Echo-Serialization-Origin",B="Revoke-Sent-Timestamp",W="Revoke-Unsent-Timestamp",q="Edit-Count",U="Edit-Contents-",V="Edit-Timestamps-",H="Group-ID",G="Group-Index",z="Group-Size",j="Receiver-Fetch-Id",K="Message-Ephemerality-Type",Q=1,X=(_=n("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),Y=_({NONE:"none",UNSEND:"unsend"}),J=_({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),Z=_({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),ee=_({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),te=_({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function ne(e){var t=new Map;return de(t,e),"mediaData"in e&&e.mediaData&&o("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(t,e.mediaData),o("EchoEncodingUtils").echoEncodeFields(t)}function re(e,t){var n,r=[],a=0,i=new Set;return t.forEach(function(n,a,l){var s=a.startsWith(U),u=a.startsWith(V);if(s||u){var c=a.slice(s?U.length:V.length);if(!i.has(c)){var d,m;i.add(c);var p=(d=o("EchoDecodingUtils").echoDecodeStringField(t,""+U+c).result)!=null?d:"",_=((m=o("EchoDecodingUtils").echoDecodeIntField(t,""+V+c).result)!=null?m:0)/1e3;r.push({messageId:c,originalMessageId:e,text:p,timestamp:_})}}}),a=(n=o("EchoDecodingUtils").echoDecodeIntField(t,q).result)!=null?n:0,{editCount:a,editHistory:r}}function oe(t){var n=o("EchoDecodingUtils").echoDecodeFields(t);if(n.size===0)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"]))),null;var a=o("EchoDecodingUtils").echoDecodeStringField(n,f),i=o("EchoDecodingUtils").echoDecodeStringField(n,g),l=o("EchoDecodingUtils").echoDecodeIntField(n,h),_=o("EchoDecodingUtils").echoDecodeIntField(n,y),q=o("EchoDecodingUtils").echoDecodeStringField(n,T),U=o("EchoDecodingUtils").echoDecodeStringField(n,D),V=o("EchoDecodingUtils").echoDecodeStringField(n,x);if(a.success&&i.success&&l.success){var H=a.result;if(H==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded messageId cannot be null");var G=i.result;if(G==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded threadId cannot be null");var z=q==null?void 0:q.result;if(z==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded contentTypeString cannot be null");var X=re(H,n),Z=X.editCount,ee=X.editHistory,te={contentSubtype:se(V.result),contentType:ie(z),displayTimestampMs:_.success?_.result:l.result,editCount:Z,editHistory:ee,messageId:H,sortOrderMs:l.result,threadId:G},ne=le(U.result);ne!=null&&(te.xContentType=ne);var oe=o("EchoDecodingUtils").echoDecodeAddressField(n,b);oe.success&&oe.result!=null&&(te.from=oe.result);var de=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,L);de.success&&de.result!=null&&(te.isTombstoned=de.result);var me=o("EchoDecodingUtils").echoDecodeStringField(n,v);me.success&&me.result!=null&&(te.text=me.result);var pe=o("EchoDecodingUtils").echoDecodeStringField(n,S);if(pe.success&&pe.result!=null){var _e=ae(pe.result);te.textSize=_e}var fe=o("EchoDecodingUtils").echoDecodeStringField(n,M);if(fe.success&&fe.result!=null){var ge=ue(fe.result);te.xMessagePlaceholderType=ge}var he=o("EchoDecodingUtils").echoDecodeStringField(n,R);he.success&&he.result!=null&&(te.sendError=he.result);var ye=o("EchoDecodingUtils").echoDecodeNullableIntField(n,E);ye.success&&ye.result!=null&&(te.expireTimestampMs=ye.result);var Ce=o("EchoDecodingUtils").echoDecodeNullableIntField(n,k);Ce.success&&Ce.result!=null&&(te.deleteTimestampMs=Ce.result);var be=o("EchoDecodingUtils").echoDecodeNullableIntField(n,I);be.success&&be.result!=null&&(te.ephemeralDurationInSec=be.result);var ve=o("EchoDecodingUtils").echoDecodeStringField(n,K);ve.success&&ve.result!=null&&ve.result==="view_once"&&(te.viewOnce=!0);var Se=o("EchoDecodingUtils").echoDecodeNullableIntField(n,C);Se.success&&Se.result!=null&&(te.authoritativeTimestampMs=Se.result);var Re=o("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(n);Re.length>0&&(te.receiptStatusList=Re);var Le=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,$);Le.success&&Le.result!=null&&(te.isForwarded=Le.result),o("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(n,te);var Ee=o("EchoDecodingUtils").echoDecodeStringField(n,P);Ee.success&&Ee.result!=null&&(te.xOfflineThreadingId=Ee.result);var ke=o("EchoDecodingUtils").echoDecodeStringField(n,N);ke.success&&ke.result!=null&&(te.xThreadId=ke.result);var Ie=o("EchoDecodingUtils").echoDecodeStringField(n,O);Ie.success&&Ie.result!=null&&(te.serializationOrigin=ce(Ie.result));var Te=o("EchoDecodingUtils").echoDecodeNullableIntField(n,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);te.version=Te.success&&Te.result!=null?Te.result:Q;var De=o("EchoDecodingUtils").echoDecodeAddressListField(n,w);De.success&&De.result!=null&&(te.reactions=De.result);var xe=o("EchoDecodingUtils").echoDecodeAddressListField(n,A);xe.success&&xe.result!=null&&(te.reactionAuthoritativeTimestampMs=xe.result);var $e=o("EchoDecodingUtils").echoDecodeAddressListField(n,F);$e.success&&$e.result!=null&&(te.reactionXOfflineThreadingIds=$e.result);var Pe=o("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(n);Pe!=null&&(te.quoteData=Pe);var Ne=(te==null?void 0:te.contentType)===J.XMA&&n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS)),Me=n.has(j);if(n.has(j)){var we=o("EchoMessageMediaFieldUtils").decodeReceiverFetchData(n),Ae=o("EchoDecodingUtils").echoDecodeStringField(n,j),Fe=Ae.result,Oe=Ae.success;we==null||!Oe||Fe==null?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode media data for Receiver Fetch, Message origin: ",""])),te.serializationOrigin):(te.receiverFetchData=we,te.receiverFetchId=Fe)}if(((te==null?void 0:te.contentType)===J.MEDIA||Ne)&&!Me){var Be=o("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(n,te==null?void 0:te.contentType,te==null?void 0:te.xContentType),We="[labyrinth_web] mandatory media data is missing from media message, msgId: "+te.messageId+".";Be!=null?(Be.length!==1&&Be.length!==2&&((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin)),te.mediaData=Be[0],Be.length===2&&(te.previewMediaData=Be[1])):((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin))}if(te.contentType===J.PLACEHOLDER&&te.contentSubtype===Y.UNSEND){var qe=o("EchoDecodingUtils").echoDecodeNullableIntField(n,B);qe.success&&qe.result!=null&&(te.revokeSentTimestampMs=qe.result);var Ue=o("EchoDecodingUtils").echoDecodeNullableIntField(n,W);Ue.success&&Ue.result!=null&&(te.revokeUnsentTimestampMS=Ue.result)}if(te.contentType===J.XMA){var Ve=o("EchoMessageXMAFieldUtils").decodeXMAFields(n);if(Ve!=null)te.xmaData=Ve;else return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""])),te.messageId),null}return te}else return null}function ae(e){var t;return(t=X.cast(e))!=null?t:X.NONE}function ie(e){var t;return(t=J.cast(e))!=null?t:J.TEXT}function le(e){return Z.cast(e)}function se(e){var t;return(t=Y.cast(e))!=null?t:Y.NONE}function ue(e){var t;return(t=ee.cast(e))!=null?t:ee.NO_PLACEHOLDER}function ce(e){var t;return(t=te.cast(e))!=null?t:te.UNKNOWN}function de(e,t){var n,r;(r=o("EchoEncodingUtils")).echoSetStringField(e,f,t.messageId),r.echoSetStringField(e,g,t.threadId),r.echoSetIntField(e,h,t.sortOrderMs),r.echoSetIntField(e,y,t.displayTimestampMs),r.echoSetIntField(e,C,t.authoritativeTimestampMs),r.echoSetAddressField(e,b,t.from),r.echoSetStringField(e,v,t.text),t.textSize!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.textSize),t.xMessagePlaceholderType!=null&&o("EchoEncodingUtils").echoSetStringField(e,M,t.xMessagePlaceholderType),o("EchoEncodingUtils").echoSetStringField(e,R,t.sendError),o("EchoEncodingUtils").echoSetBooleanField(e,L,t.isTombstoned),o("EchoEncodingUtils").echoSetIntField(e,E,t.expireTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,k,t.deleteTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,I,t.ephemeralDurationInSec),t.contentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.contentType),t.xContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,D,t.xContentType),o("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(e,t.receiptStatusList),o("EchoEncodingUtils").echoSetBooleanField(e,$,t.isForwarded),o("EchoEncodingUtils").echoSetStringField(e,P,t.xOfflineThreadingId),o("EchoEncodingUtils").echoSetStringField(e,N,t.xThreadId),o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,t.version),t.contentSubtype!=null&&o("EchoEncodingUtils").echoSetStringField(e,x,t.contentSubtype),o("EchoEncodingUtils").echoSetAddressListField(e,w,t.reactions),o("EchoEncodingUtils").echoSetAddressListField(e,A,t.reactionAuthoritativeTimestampMs),o("EchoEncodingUtils").echoSetAddressListField(e,F,t.reactionXOfflineThreadingIds),o("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(e,t),t.serializationOrigin!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.serializationOrigin),t.revokeSentTimestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,B,t.revokeSentTimestampMs),t.revokeUnsentTimestampMS!=null&&o("EchoEncodingUtils").echoSetIntField(e,W,t.revokeUnsentTimestampMS),o("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(e,t);var a=t.xmaData;a!=null&&o("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(e,a),((n=t.editHistory)==null?void 0:n.length)>0&&(o("EchoEncodingUtils").echoSetIntField(e,q,t.editCount),t.editHistory.forEach(function(t){var n=t.messageId;n!=null&&(o("EchoEncodingUtils").echoSetStringField(e,U+n,t.text),o("EchoEncodingUtils").echoSetIntField(e,V+n,t.timestamp*1e3))})),t.receiverFetchId!=null&&o("EchoEncodingUtils").echoSetStringField(e,j,t.receiverFetchId)}l.ECHO_SERIALIZATION_ORIGIN=O,l.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=q,l.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=U,l.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=V,l.ECHO_MESSAGE_FIELD_GROUP_ID=H,l.ECHO_MESSAGE_FIELD_GROUP_INDEX=G,l.ECHO_MESSAGE_FIELD_GROUP_SIZE=z,l.ECHO_MESSAGE_FIELD_RECEIVER_FETCH_ID=j,l.ECHO_MESSAGE_FIELD_NAME_EPHEMERALITY_TYPE=K,l.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=Q,l.MessageTextSize=X,l.EchoMessageContentSubtype=Y,l.EchoMessageContentType=J,l.EchoXMessageContentType=Z,l.EchoMessagePlaceholderType=ee,l.EchoSerializationOriginType=te,l.encodeEchoMessage=ne,l.decodeEchoMessage=oe}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R="X-Object-Id",L="X-Attachment-Object-Ids",E="Attachment-Type",k="Content-Type",I="X-Encrypted-Hash",T="X-Attachment-Type",D="X-Backup-Ent-Fbid",x="X-Backup-Status",$="X-Content-Type",P="X-Direct-Path",N="Height",M="X-Media-Key",w="X-Media-Key-Timestamp",A="Playable-Duration",F="Preview-Height",O="Preview-Content-Type",B="Preview-Width",W="Size",q="Width",U="X-Plaintext-Hash",V="File-Name",H="Header-Attribution-Content-Type",G=(S=n("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),z=S({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),j=S({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),K=S({FULL:"full",PREVIEW:"preview"});function Q(t,n){var r=t.attachmentObjectId,a=t.attachmentType,i=t.backupEntFbid,l=t.directPath,p=t.filename,_=t.encryptedHash,f=t.height,g=t.mediaBackupStatus,h=t.mediaContentType,y=t.mediaKey,C=t.mediaKeyTimestamp,b=t.mediaPlayableDuration,v=t.plaintextHash,S=t.previewContentHeight,R=t.previewContentType,L=t.previewContentWidth,E=t.size,k=t.width,I=t.xAttachmentType,T=t.xContentType,D=t.xmaData,x=t.mediaEntryData;if(r==null)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields, msgId: ",""])),n);else if(a==null)o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields, msgId: ",""])),n);else if(l==null)o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields, msgId: ",""])),n);else if(v==null)o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields, msgId: ",""])),n);else if(T==null)o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields, msgId: ",""])),n);else if(I==null)o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields, msgId: ",""])),n);else return{attachmentObjectId:r,attachmentType:a,backupEntFbid:i,directPath:l,encryptedHash:_,filename:p,height:f,mediaBackupStatus:g,mediaContentType:h,mediaEntryData:x,mediaKey:y,mediaKeyTimestamp:C,mediaPlayableDuration:b,plaintextHash:v,previewContentHeight:S,previewContentType:R,previewContentWidth:L,size:E,width:k,xAttachmentType:I,xContentType:T,xmaData:D}}function X(e,t){var n;(n=o("EchoEncodingUtils")).echoSetStringField(e,R,t.attachmentObjectId),n.echoSetStringField(e,E,t.attachmentType),n.echoSetStringField(e,U,t.plaintextHash),n.echoSetStringField(e,I,t.encryptedHash),n.echoSetIntField(e,W,t.size),n.echoSetStringField(e,M,t.mediaKey),n.echoSetIntField(e,w,t.mediaKeyTimestamp),n.echoSetStringField(e,P,t.directPath),t.mediaContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.mediaContentType),o("EchoEncodingUtils").echoSetIntField(e,q,t.width),o("EchoEncodingUtils").echoSetIntField(e,N,t.height),t.previewContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.previewContentType),t.headerAttributionContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,H,t.headerAttributionContentType),o("EchoEncodingUtils").echoSetIntField(e,B,t.previewContentWidth),o("EchoEncodingUtils").echoSetIntField(e,F,t.previewContentHeight),o("EchoEncodingUtils").echoSetIntField(e,A,t.mediaPlayableDuration),t.xAttachmentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.xAttachmentType),o("EchoEncodingUtils").echoSetStringField(e,$,t.xContentType),o("EchoEncodingUtils").echoSetStringField(e,D,t.backupEntFbid),o("EchoEncodingUtils").echoSetStringField(e,x,t.mediaBackupStatus),o("EchoEncodingUtils").echoSetStringField(e,V,t.filename)}function Y(e,t,n){var r={},a=!1,i=!1,l=!1;if(ne(e)){var s=re(e,t,n);if(s==null)return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""])),t,n),null;s.length!==2&&o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"])));var u=!1,c=!1,d=!1,m=s[0],f=s[1],g={};if(a=ee(e,r,m),u=ee(e,g,f),i=Z(e,r,t,m,m),c=Z(e,g,t,f,m),l=J(e,r,m),d=J(e,g,f),!a||!i||!l||!u||!c||!d)return null;var h=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,y=Q(r,h),C=Q(g,h);if(y!=null&&C!=null)return[y,C]}else{if(a=ee(e,r),i=Z(e,r,t),l=J(e,r),!a||!i||!l)return null;var b=Q(r);if(b!=null)return[b]}return null}function J(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=[{fieldName:"height",id:N},{fieldName:"width",id:q},{fieldName:"size",id:W},{fieldName:"previewContentHeight",id:F},{fieldName:"previewContentWidth",id:B},{fieldName:"mediaKeyTimestamp",id:n!=null?n+"-"+w:w}],s=[{attachmentTypes:[j.VIDEO,j.AUDIO],fieldName:"mediaPlayableDuration",id:A}];for(var u of s){var c=u.attachmentTypes,d=u.fieldName,m=u.id,p=o("EchoDecodingUtils").echoDecodeIntField(e,m),_=p.result,g=p.success;if(g&&_!=null)t[d]=_;else if(!(t.xAttachmentType!=null&&!te(c,t.xAttachmentType)||t.attachmentType===G.XMA))return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: "," xOfflineThreadingId: ",""])),d,t.xAttachmentType,t.attachmentType,i,a),!1}return l.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeIntField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function Z(e,t,n,r,a){var i,l=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,s,u,c,d=(i=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?i:"",m=[{fieldName:"filename",id:V}];r!=null&&a!=null?(t.attachmentObjectId=r,s=[{fieldName:"plaintextHash",id:r+"-"+U},{fieldName:"directPath",id:r+"-"+P},{fieldName:"xContentType",id:r+"-"+$}],m.push({fieldName:"mediaKey",id:r+"-"+M}),u=a+"-"+D,c=r+"-"+I):(s=[{fieldName:"attachmentObjectId",id:R},{fieldName:"plaintextHash",id:U},{fieldName:"directPath",id:P},{fieldName:"xContentType",id:$}],m.push({fieldName:"mediaKey",id:M}),u=D,c=I),m.push({fieldName:"backupEntFbid",id:u}),m.push({fieldName:"mediaContentType",id:k}),m.push({fieldName:"encryptedHash",id:c});var p=a!=null?a+"-"+x:x;m.push({fieldName:"mediaBackupStatus",id:p});var _=[];for(var f of s){var y=f.fieldName,C=f.id,b=o("EchoDecodingUtils").echoDecodeStringField(e,C),v=b.result,S=b.success;S&&v!=null?t[y]=v:_.push(y)}if(_.length>0){var L=_.join(", ");return n===o("EchoMessage").EchoMessageContentType.XMA?o("WALogger").WARN(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""])),L,t.attachmentType,d):o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),L,t.attachmentType,d,l),!1}return m.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeStringField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function ee(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=o("EchoDecodingUtils").echoDecodeStringField(e,E),s=l.result==="file"?G.DOCUMENT:G.cast(l.result);s!=null&&(t.attachmentType=s);var u=o("EchoDecodingUtils").echoDecodeStringField(e,O),c=z.cast(u.result);c!=null&&(t.previewContentType=c);var d=o("EchoDecodingUtils").echoDecodeStringField(e,H),m=d.result;m!=null&&(t.headerAttributionContentType=m);var p=o("EchoDecodingUtils").echoDecodeStringField(e,n!=null?n+"-"+T:T),_=null;return p.success&&p.result!=null&&(_=oe(p.result),_!=null&&(t.xAttachmentType=_)),s!=null&&(c!=null||s===G.DOCUMENT||s===G.PTT)?!0:(o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),s,c,p,i,a),!1)}function te(e,t){return e.reduce(function(e,n){return e||n===t},!1)}function ne(e){return e.has(L)}function re(e,t,n){var r=o("EchoDecodingUtils").echoDecodeObjectIdListField(e,L),a=r.result,i=r.success;if(!i||a==null||a.length!==2)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""])),a,t,n),null;var l=a.find(function(t){var n=t+"-"+x,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null)return!0});if(l!=null){var s=l===a[0]?a[1]:a[0];return[l,s]}if(l=a.find(function(t){var n=t+"-"+$,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null&&K.cast(a)===K.FULL)return!0}),l!=null){var u=l===a[0]?a[1]:a[0];return[l,u]}return a}function oe(e){var t=j.cast(e);return t==null&&o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""])),e),t!=null?t:j.INVALID}function ae(e){var t={},n=ee(e,t);if(!n)return null;var r=o("EchoDecodingUtils").echoDecodeStringField(e,k),a=o("EchoDecodingUtils").echoDecodeIntField(e,N),i=o("EchoDecodingUtils").echoDecodeIntField(e,q),l=o("EchoDecodingUtils").echoDecodeStringField(e,E);return!r.success||!a.success||!i.success||!l.success||r.result==null||a.result==null||i.result==null||l.result==null?(o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing media fields for receiver fetch"]))),null):{mimetype:r.result,previewHeight:a.result,previewWidth:i.result,type:l.result}}l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=R,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=L,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=E,l.AttachmentType=G,l.EchoMessageMediaPreviewType=z,l.EchoMessageActMediaAttachmentType=j,l.convertMediaMetadataDetailsToMediaMetadata=Q,l.echoMessageSetMediaMetadataFields=X,l.echoMessageDecodeMediaDataFields=Y,l.setMediaIntFields=J,l.setMediaEnumFields=ee,l.getAttachmentObjectIdsFromMultiBlobMediaMsg=re,l.decodeReceiverFetchData=ae}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){t.groupId!=null&&o("EchoEncodingUtils").echoSetStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,t.groupId),t.groupIndex!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,t.groupIndex),t.groupSize!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,t.groupSize)}function s(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);n.success&&n.result!=null&&(t.groupId=n.result);var r=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);r.success&&r.result!=null&&(t.groupIndex=r.result);var a=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);a.success&&a.result!=null&&(t.groupSize=a.result)}l.echoMessageSetMediaGroupFields=e,l.decodeMessageMediaGroupFields=s}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(t,n,r,o,a,i,l){"use strict";var e="Reply-Message-Id",s="Reply-Message-Sender",u="Reply-Sort-Order",c="Reply-Type",d="Reply-Status",m=n("$InternalEnum").Mirrored(["BUMP"]),p=n("$InternalEnum")({VALID:"valid"});function _(e){var t={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},n=g(e,t),r=h(e,t),o=y(e,t),a=C(e,t);return!n||!r||!o||!a?null:t}function f(t,n){var r=n.quoteData;r!=null&&(o("EchoEncodingUtils").echoSetStringField(t,e,r.quoteMessageId),o("EchoEncodingUtils").echoSetAddressField(t,s,r.quoteMessageSender),o("EchoEncodingUtils").echoSetIntField(t,u,r.quoteSortOrderInMs),r.status!=null&&o("EchoEncodingUtils").echoSetStringField(t,d,r.status),r.replyType!=null&&o("EchoEncodingUtils").echoSetStringField(t,c,r.replyType))}function g(e,t){var n=[{fieldName:"quoteMessageSender",id:s}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeAddressField(e,i),u=l.result,c=l.success;if(c&&u!=null)t[a]=u;else return!1}return!0}function h(t,n){var r=[{fieldName:"quoteMessageId",id:e}];for(var a of r){var i=a.fieldName,l=a.id,s=o("EchoDecodingUtils").echoDecodeStringField(t,l),u=s.result,c=s.success;if(c&&u!=null)n[i]=u;else return!1}return!0}function y(e,t){var n=[{fieldName:"quoteSortOrderInMs",id:u}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeIntField(e,i),s=l.result,c=l.success;if(c&&s!=null)t[a]=s;else return!1}return!0}function C(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,c),r=m.cast(n.result);r!=null&&(t.replyType=r);var a=o("EchoDecodingUtils").echoDecodeStringField(e,d),i=p.cast(a.result);return i!=null&&(t.status=i),!0}l.EchoMessageQuoteReplyType=m,l.EchoMessageQuoteStatus=p,l.echoMessageDecodeQuoteFields=_,l.echoMessageSetQuoteFields=f}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s="Receipt-Status",u="Receipt-Timestamp",c=n("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function d(e,t){t==null||t.length===0||t.forEach(function(t){o("EchoEncodingUtils").echoSetStringField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,s),t.status),t.timestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,u),t.timestampMs)})}function m(e){var t=[];return p(e).forEach(function(n){var r=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,s),a=o("EchoDecodingUtils").echoDecodeStringField(e,r);if(a.success){var i,l=(i=c.cast(a.result))!=null?i:c.UNKNOWN,d=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,u),m=o("EchoDecodingUtils").echoDecodeNullableIntField(e,d);m.result!=null?t.push({address:n,status:l,timestampMs:m.result}):t.push({address:n,status:l})}}),t}function p(t){var n=new Set;for(var r of t.keys())if(r.includes(s))try{var a=r.split("@"),i=a[0],l=_(a[1]);n.add({localKey:i,transportKey:l})}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""])),t)}return Array.from(n)}function _(e){var t=e.split(s);return t[0].split("-")[0]}l.MessageReceiptStatus=c,l.echoMessageSetReceiptStatusDataFields=d,l.echoMessageDecodeReceiptStatusDataFields=m}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="XMA-Default-CTA",m="XMA-Gating-Type",p="XMA-Header-Subtitle",_="XMA-Header-Title",f="XMA-Is-Tombstoned",g="XMA-Layout-Type",h="XMA-Max-Subtitle-Num-Lines",y="XMA-Max-Title-Num-Lines",C="XMA-Subtitle-Text",b="XMA-Target-Expiry",v="XMA-Target-ID",S="XMA-Target-Type",R="XMA-Target-Username",L="XMA-Title-Text",E="XMA-Content-Ref",k="XMA-Dataclass",I=n("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT","STANDARD_DXMA","LIST_DXMA","GRID"]),T=n("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","FB_PROFILE_DIRECTORY_ITEM","FB_FEED_POST_REACTION_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT","FB_SHORT","MSG_LOCATION_SHARING","MSG_LOCATION_SHARING_V2","MSG_MEMORIES_SHARE"]),D=n("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function x(e,t){t.xmaLayoutType!=null&&o("EchoEncodingUtils").echoSetStringField(e,g,t.xmaLayoutType),t.xmaTargetType!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.xmaTargetType),o("EchoEncodingUtils").echoSetStringField(e,R,t.xmaTargetUsername),o("EchoEncodingUtils").echoSetStringField(e,v,t.xmaTargetId),t.xmaTargetExpiry!=null&&o("EchoEncodingUtils").echoSetIntField(e,b,t.xmaTargetExpiry),o("EchoEncodingUtils").echoSetStringField(e,d,t.xmaDefaultCTA),o("EchoEncodingUtils").echoSetStringField(e,_,t.xmaHeaderTitle),o("EchoEncodingUtils").echoSetStringField(e,p,t.xmaHeaderSubtitle),o("EchoEncodingUtils").echoSetStringField(e,L,t.xmaTitleText),o("EchoEncodingUtils").echoSetStringField(e,C,t.xmaSubtitleText),t.xmaMaxTitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,y,t.xmaMaxTitleNumLines),t.xmaMaxSubtitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,h,t.xmaMaxSubtitleNumLines),t.xmaGatingType!=null&&o("EchoEncodingUtils").echoSetStringField(e,m,t.xmaGatingType),t.xmaDataclass!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.xmaDataclass),o("EchoEncodingUtils").echoSetBooleanField(e,f,t.xmaIsTombstoned),t.xmaContentRef!=null&&o("EchoEncodingUtils").echoSetStringField(e,E,t.xmaContentRef)}function $(t){var n=M(t,f);if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"]))),null;var r=D.cast(o("EchoDecodingUtils").echoDecodeStringField(t,m).result),a=I.cast(o("EchoDecodingUtils").echoDecodeStringField(t,g).result),i=T.cast(o("EchoDecodingUtils").echoDecodeStringField(t,S).result);return{xmaContentRef:P(t,E),xmaDataclass:P(t,k),xmaDefaultCTA:P(t,d),xmaGatingType:r,xmaHeaderSubtitle:P(t,p),xmaHeaderTitle:P(t,_),xmaIsTombstoned:n,xmaLayoutType:a,xmaMaxSubtitleNumLines:N(t,h),xmaMaxTitleNumLines:N(t,y),xmaSubtitleText:P(t,C),xmaTargetExpiry:N(t,b),xmaTargetId:P(t,v),xmaTargetType:i,xmaTargetUsername:P(t,R),xmaTitleText:P(t,L)}}function P(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"])),t)}function N(e,t){var n=o("EchoDecodingUtils").echoDecodeIntField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}function M(e,t){var n=o("EchoDecodingUtils").echoDecodeBooleanField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}l.XMALayoutType=I,l.XMAContentType=T,l.XMAGatingType=D,l.echoMessageSetXMAFields=x,l.decodeXMAFields=$}),98);
__d("validateMAWMediaAndComposeEntryForProtoMsg",["FBLogger","WAMediaUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbMedia is null in validateMediaAndComposeEntryForProtoMsg");var n=null;if(e!=null&&t.mediaId!=null){if(!t.msgIds.includes(e))throw r("FBLogger")("messenger_web").mustfixThrow("the media ("+t.mediaId+") is not linked to the msg ("+e+")");n=t.mediaEntries.get(e)}else n=t.mediaEntry;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media entry not found in validateMediaAndComposeEntryForProtoMsg");var o=t.plaintextHash,a=s(o,n);return[t,a]}function s(e,t){var n=o("WAMediaUtils").mediaEntryDataToRawData(e,t);if(n.fileSha256==null||n.mediaKey==null||n.fileEncSha256==null||n.directPath==null||n.mediaKeyTimestamp==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing fields in mediaEntryData");return babelHelpers.extends({},n,{directPath:n.directPath,fileEncSha256:n.fileEncSha256,fileSha256:n.fileSha256,mediaKey:n.mediaKey,mediaKeyTimestamp:n.mediaKeyTimestamp})}l.validateMAWMediaAndComposeEntryForProtoMsg=e,l.validateMediaEntry=s}),98);
__d("MAWAsArmadilloApplication",["FBLogger","MAWEncodeMediaTransportProtocol","MAWMsg","MAWMsgType","MAWVault","MAWXMAEncodeUtils","WAArmadilloApplication.pb","WAGlobals","WAJids","WATimeUtils","getErrorSafe","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.XMA:{if((t==null?void 0:t.xma)==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA content should have XMA payload");var i=o("MAWXMAEncodeUtils").encodeXMA(e,t);return i}case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return u(e,n);case o("MAWMsgType").MSG_TYPE.RAVEN:return p(e,a);case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d(e);default:throw r("FBLogger")("messenger_web").mustfixThrow(e.type+" should not be handled as ArmadilloApplication")}}function u(e,t){var n;if(e.type!==o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE||((n=e.quote)==null?void 0:n.content)==null||t==null)return null;var r=e.quote.content,a=o("WAJids").interpretAndValidateJid(t),i=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author,l=o("WAJids").isAuthorMe(r.author)?o("WAGlobals").getMyUserJid():r.author;function s(){return a.jidType==="msgrUser"?l:a.jidType==="group"?a.groupJid:null}function u(){return i===l?null:a.jidType==="group"?l:null}var c=s(),d=u();if(c==null)return null;if(e)return{payload:{content:{bumpExistingMessage:{key:{fromMe:i===l,id:r.externalId,participant:d,remoteJid:c}}}}}}function c(e){var t,n,r,a=(t=e.quote)==null?void 0:t.content,i=a==null||(n=a.msgContent)==null?void 0:n.content,l=a==null?void 0:a.expirationTs,s=e==null||(r=e.msgContent)==null?void 0:r.content;if(a==null||i==null||s==null)return null;var u=l!=null?o("WATimeUtils").castUnixTimeToMillisTime(l):void 0;return{payload:{content:{noteReplyMessage:{noteText:{text:o("MAWVault").unvault(i)},noteTimestampMs:u,textContent:{text:o("MAWVault").unvault(s)}}}}}}function d(e){var t=e.ravenActionToMsgExternalId;if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg ravenActionToMsgExternalId is null in encodeRavenActionMessage");var n=Number(e.actionType),a;if(n===0)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.PLAYED;else if(n===1)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.SCREENSHOT;else if(n===2)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.FORCE_DISABLE;else throw r("FBLogger")("messenger_web").mustfixThrow("msg actionType is not in enum in encodeRavenActionMessage");var i=e.actionTimestamp==null?Date.now():o("WATimeUtils").castUnixTimeToMillisTime(e.actionTimestamp),l={actionTimestamp:i,actionType:a,key:{id:t}};return{payload:{content:{ravenActionNotifMessage:l}}}}function m(e){return e===o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE?0:e===o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY?1:e===o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?2:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}function p(t,n){if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media is null in encodeRavenMessage");var a,i;try{var l=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(t.msgId,n);a=l[0],i=l[1]}catch(t){var s=r("getErrorSafe")(t);r("FBLogger")("messenger_web").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media entry is invalid, fallback to the placeholder: ",""])),s.message),a=void 0,i=void 0}if(a==null||i==null)return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType)}}}};switch(t.ravenMediaType){case o("MAWMsg").MAWRavenMsgMediaType.IMAGE:{var u=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),imageMessage:{payload:u,version:1}}}}}}case o("MAWMsg").MAWRavenMsgMediaType.VIDEO:{var c=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToVideoTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),videoMessage:{payload:c,version:1}}}}}}}}l.asArmadilloApplication=s,l.encodeNoteReplyMessage=c}),98);
__d("MAWAsConsumerApplication",["FBLogger","I64","LSIntEnum","MAWDbMedia","MAWEncodeMediaTransportProtocol","MAWJids","MAWMsgType","MAWVault","WAAssertUnreachable","WAConsumerApplication.pb","WAGlobals","WAJids","WAMediaTransport.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.TEXT:return p(e);case o("MAWMsgType").MSG_TYPE.IMAGE:return _(e,t);case o("MAWMsgType").MSG_TYPE.VIDEO:return C(e,t);case o("MAWMsgType").MSG_TYPE.PTT:return v(e,t);case o("MAWMsgType").MSG_TYPE.REVOKED:return R(e.revokedExternalId);case o("MAWMsgType").MSG_TYPE.GIF:return C(e,t);case o("MAWMsgType").MSG_TYPE.STICKER:return h(e,t);case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return x(e,t);case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return null;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:throw r("FBLogger")("messenger_web").mustfixThrow("Implemented ephemeral setting message in MAWAsConsumerApplication");case o("MAWMsgType").MSG_TYPE.XMA:throw r("FBLogger")("messenger_web").mustfixThrow("XMA content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support converting to protoMsg with "+e.type+" type","maw_db");case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("Raven content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.EDIT_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support editing messages right now since the sending flow is not implemented yet. ");case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return E(e,n);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:throw r("FBLogger")("messenger_web").mustfixThrow("Bump message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return T(e,a);case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll creation messages yet as the sending flow is not implemented.");case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll update messages yet as the sending flow is not implemented.");default:return r("WAAssertUnreachable")(e.type)}}function c(e,t){if(t==null)return d(e);switch(t.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return f(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.PTT:return S(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.GIF:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.STICKER:return y(e.msgId,t);default:return null}}function d(e){var t=null;if(e.type===o("MAWMsgType").MSG_TYPE.REVOKED&&e.msgContent!=null&&e.msgContent.content!=null)t=e.msgContent.content;else if(e.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME&&e.msgContent!=null)t=e.msgContent;else return null;return{payload:{content:{messageText:{mentionedJid:[],text:o("MAWVault").unvault(t)}}}}}function m(e){if(e!=null){var t=e===1?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:e===2?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;return{specialTextSize:t}}}function p(e){var t={payload:{content:{messageText:{commands:e.msgContent.commands,mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)}}}},n=m(e.specialTextSize);return n!=null&&(t.metadata=n),t}function _(e,t){return f(e.msgId,t,e)}function f(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedImageMessage(a,i,n)}function g(e){function t(){var t=o("WAJids").validateGroupJid(e.threadJid);return t!=null?t:o("WAJids").isAuthorMe(e.author)?e.threadJid:o("WAGlobals").getMyUserJid()}var n=t();return{payload:{content:{editMessage:{key:{fromMe:!0,id:e.originalMsgExternalId,remoteJid:n},message:{mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)},timestampMs:e.editTs*1e3}}}}}function h(e,t){return y(e.msgId,t)}function y(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedStickerMessage(r,a)}function C(e,t){return b(e.msgId,t)}function b(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedVideoMessage(r,a)}function v(e,t){return S(e.msgId,t)}function S(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedAudioMessage(r,a)}function R(e){return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:e}}}}}}function L(e){var t=o("WAJids").isAuthorMe(e.reactToAuthor)?o("WAGlobals").getMyUserJid():e.reactToAuthor;function n(){var n=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author;return n===t}var r=n(),a=o("WAJids").interpretAsGroupJid(e.threadJid)!=null,i={groupingKey:e.groupingKey==null?void 0:e.groupingKey,key:{fromMe:r,id:e.reactToExternalId,participant:a&&!r?t:void 0,remoteJid:e.threadJid},senderTimestampMs:e.senderTimestampMs,text:e.reaction==null?void 0:e.reaction};return{payload:{content:{reactionMessage:i}}}}function E(e,t){if(e.threadJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg threadJid is null in encodeGroupInviteMessage");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbGroupInvite is null in encodeGroupInviteMessage");var n=o("WAJids").interpretAsGroupJid(e.threadJid);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("groupJid is null in encodeGroupInviteMessage");return{payload:{content:{groupInviteMessage:{groupJid:n,groupName:e.groupName,inviteCode:t.inviteCode,inviteExpiration:t.inviteExpirationTs}}}}}function k(t){return(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(1))||(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(256))||t.textHasLinks||t.isUnsent?I(t):null}function I(e){var t,n=(t=e.mentionIds)==null||(t=t.split(","))==null?void 0:t.map(o("MAWJids").toUserJid);return{payload:{content:{messageText:{mentionedJid:n!=null?n:[],text:e.text}}}}}function T(e,t){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch id");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch info");switch(t.type){case"sticker":return D(t);default:throw r("FBLogger")("messenger_web").mustfixThrow("Unsupported receiver fetch type: "+t.type)}}function D(e){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch sticker message without receiver fetch id");var t={ancillary:{accessibilityLabel:e.accessibilitySummaryText,height:e.previewHeight,isThirdParty:!1,receiverFetchId:e.receiverFetchId,width:e.previewWidth},integral:{receiverFetchId:e.receiverFetchId,transport:{ancillary:{mimetype:o("MAWEncodeMediaTransportProtocol").STICKER_MIME_TYPE,thumbnail:{thumbnailHeight:e.previewHeight,thumbnailWidth:e.previewWidth}},integral:{}}}},n=o("encodeProtobuf").encodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,t);return{payload:{content:{stickerMessage:{sticker:{payload:n.readBuffer(),version:1}}}}}}function x(e,t){return $(e.msgId,t)}function $(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedFileMessage(r,a)}l.asConsumerApplication=u,l.deletedMsgAsConsumerApplicationForSpamReporting=c,l.encodeConsumerApplicationMetadata=m,l.encodeEditMessage=g,l.encodeReactionMessage=L,l.asConsumerApplicationLSDb=k,l.encodeReceiverFetchStickerMessage=D,l.encodeFileMessage=x}),98);
__d("WAAsMessageApplication",["WAAsConsumerApplication","WAConsumerApplication.pb","WAFranking","WAMsgApplication.pb","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;switch(e.type){default:t=o("WAAsConsumerApplication").asConsumerApplication(e)}var n=e.forwardingScore!=null?e.forwardingScore:0,r=e.isForwarded!=null?e.isForwarded:!1,a={metadata:{chatEphemeralSetting:null,forwardingScore:n,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),isForwarded:r,quotedMessage:null}};if(t!=null){var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);a.payload={subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}return o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()}function s(e){return e}function u(e){return e.buffer}l.asMessageApplication=e,l.castToMessageApplicationBytes=s,l.castMessageApplicationBytesToBytes=u}),98);
__d("MAWAsMessageApplication",["I64","LSIntEnum","LSMessageReplySourceTypeV2","MAWAsArmadilloApplication","MAWAsConsumerApplication","MAWJids","MAWMsgType","WAArmadilloApplication.pb","WAAsMessageApplication","WAConsumerApplication.pb","WAFranking","WAGlobals","WAJids","WAMsgApplication.pb","encodeProtobuf","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,a,i){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,c(e,t,n,r,a,i)).readByteArrayView())}function c(e,t,n,a,i,l){r("vulture")("KFRrvBwtdcykFmtCIrPF1uyGgJU=");var s,u;switch(e.type){case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:s=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,void 0,t);break;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:s=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,i);break;case o("MAWMsgType").MSG_TYPE.XMA:s=o("MAWAsArmadilloApplication").asArmadilloApplication(e,a);break;default:u=o("MAWAsConsumerApplication").asConsumerApplication(e,t,n,l)}var c,d,m=e.forwardingScore!=null?e.forwardingScore:0,p=e.isForwarded!=null?e.isForwarded:!1;if(e.quote!=null){var _=e.quote;c={participant:_.content.author===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():_.content.author,stanzaId:_.content.externalId}}if(e.ephemeralSetting){var f=e.ephemeralSetting;e.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?d={ephemeralExpiration:f.ephemeralExpirationInSec,isEphemeralSettingReset:e.isEphemeralSettingReset}:d={ephemeralExpiration:f.ephemeralExpirationInSec,ephemeralSettingTimestamp:f.ephemeralLastUpdatedOrSetTimestamp*1e3}}var g={metadata:{chatEphemeralSetting:d,forwardingScore:m,frankingKey:y(e.reportingMeta),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:p,quotedMessage:c}};if(u!=null){var h=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,u);g.payload={subProtocol:{consumerMessage:{payload:h.readBuffer(),version:1}}}}else if(s!=null){var C=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,s);g.payload={subProtocol:{armadillo:{payload:C.readBuffer(),version:1}}}}return g}function d(t){var n,a=o("MAWAsConsumerApplication").asConsumerApplicationLSDb(t),i,l,u=t.isForwarded!=null?t.isForwarded:!1,c=u?1:0;t.replySourceTypeV2&&!(e||(e=o("I64"))).equal(t.replySourceTypeV2,(s||(s=o("LSIntEnum"))).ofNumber(r("LSMessageReplySourceTypeV2").NONE))&&t.replyToUserId!=null&&(i={participant:t.replyToUserId===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():o("MAWJids").toUserJid((e||(e=o("I64"))).to_string(t.replyToUserId)),stanzaId:t.messageId});var d={metadata:{chatEphemeralSetting:l,forwardingScore:c,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:(n=t==null?void 0:t.groupId)!=null?n:void 0,groupIndex:t.groupIndex!=null?(e||(e=o("I64"))).to_float(t.groupIndex):void 0,groupSize:t.groupSize!=null?(e||(e=o("I64"))).to_float(t.groupSize):void 0,isForwarded:u,quotedMessage:i}};if(a!=null){var m=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);d.payload={subProtocol:{consumerMessage:{payload:m.readBuffer(),version:1}}}}return d}function m(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,p(e)).readByteArrayView())}function p(e){var t=o("MAWAsConsumerApplication").encodeReactionMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function _(e){var t=o("MAWAsArmadilloApplication").encodeNoteReplyMessage(e);if(t==null)return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()}};var n=e.ephemeralSetting,r=n?{ephemeralExpiration:n.ephemeralExpirationInSec,ephemeralSettingTimestamp:n.ephemeralLastUpdatedOrSetTimestamp*1e3}:void 0,a=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,t);return{metadata:{chatEphemeralSetting:r,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{armadillo:{payload:a.readBuffer(),version:1}}}}}function f(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,g(e)).readByteArrayView())}function g(e){var t=o("MAWAsConsumerApplication").encodeEditMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function h(e,t){var n,r,a=o("MAWAsConsumerApplication").deletedMsgAsConsumerApplicationForSpamReporting(e,t);if(a==null)return null;var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);return{metadata:{frankingKey:y(e.reportingMeta),frankingVersion:((n=e.reportingMeta)==null?void 0:n.frankingVersion)!=null?(r=e.reportingMeta)==null?void 0:r.frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}}function y(e){return(e==null?void 0:e.frankingKey)!=null?e.frankingKey:o("WAFranking").createFrankingKey()}l.encodeMessageApplication=u,l.asMessageApplication=c,l.asMessageApplicationLSDb=d,l.encodeReactionMessageApplication=m,l.asReactionMessageApplication=p,l.asNoteReplyMessageApplication=_,l.encodeEditMessageApplication=f,l.asEditMessageApplication=g,l.deletedMsgAsMessageApplicationForSpamReporting=h}),98);
__d("MAWParseSubprotocolVersionConsts",[],(function(t,n,r,o,a,i){"use strict";var e=2,l=2,s=1,u=2,c=1,d=1;i.ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION=e,i.XMA_PREVIEW_SUBPROTOCOL_VERSION=l,i.XMA_FAVICON_SUBPROTOCOL_VERSION=s,i.XMA_HEADER_SUBPROTOCOL_VERSION=u,i.RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION=c,i.RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION=d}),66);
__d("MAWXMAEncodeUtils",["MAWAsMessageApplication","MAWEncodeMediaTransportProtocol","MAWMsgType","MAWParseSubprotocolVersionConsts","MAWVault","WALogger","WAMsgApplication.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return{payload:o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i),version:n}}function u(t,n){var r=t.msgContent,a=t.msgId,i=r||{},l=i.commands,u=i.content,c=i.mentionedJids,d=n.associatedMessage,m=n.favicon,p=n.header,_=n.previews,f=n.xma,g=null;if(d!=null)if(d.type!==o("MAWMsgType").MSG_TYPE.TEXT)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Non-text associated message for the XMA content is not supported"])));else{var h=o("MAWAsMessageApplication").asMessageApplication(d),y=o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,h);g={payload:y.readBuffer(),version:o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION}}var C=p!=null&&a!=null?s(a,p,o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION):null,b=m!=null&&a!=null?s(a,m,o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION):null,v=_!=null&&a!=null?_.map(function(e){return s(a,e,o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)}):null,S=f.defaultCTA==null?void 0:[f.defaultCTA].concat(f.ctas).filter(Boolean);return{payload:{content:{extendedContentMessage:{associatedMessage:g!=null?g:void 0,commands:l,contentRef:f.contentRef,ctas:S,favicon:b!=null?b:void 0,headerImage:C!=null?C:void 0,headerTitle:f.headerTitle,maxSubtitleNumOfLines:f.maxSubtitleNumOfLines,maxTitleNumOfLines:f.maxTitleNumOfLines,mentionedJid:c,messageText:u==null?void 0:o("MAWVault").unvault(u),overlayDescription:f.overlayDescription,overlayIconGlyph:f.overlayIconGlyph,overlayTitle:f.overlayTitle,previews:v!=null?v:[],sentWithMessageId:g?f.externalId:void 0,subtitleText:f.subtitleText,targetExpiringAtSec:f.targetExpiringAtSec,targetId:f.targetId,targetType:f.targetType,targetUsername:f.targetUsername,titleText:f.titleText,xmaDataclass:f.xmaDataclass,xmaLayoutType:f.xmaLayoutType}}}}}l.encodeXMA=u}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWVault","MWFBLogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbEditMsgHistoryTxns"]);function m(t,n){var r=[];if(n.length===0)return o("MAWDexieTable").dexieResolve(r);var a=n.filter(function(e){return e.editCount!=null&&e.editCount>0}),i=a.map(function(e){return[e.externalId,e.threadJid]});if(i.length===0)return o("MAWDexieTable").dexieResolve([]);var l=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t.msgId),e},new Map),u=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t),e},new Map);return p(t,i).then(function(t){if(t.length===0)return d.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No edit history found for the messages despite there being an editCount greater than 0"]))),[];for(var n of t){var a=l.get(n.originalMsgExternalId);a!=null&&r.push(babelHelpers.extends({},n,{editMsgHistoryId:o("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(n.editMsgHistoryId),originalMsgId:a}));var i=u.get(n.originalMsgExternalId);i!=null&&n.threadJid!==i.threadJid&&d.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Edit history threadJid does not match original message threadJid"])))}return r})}function p(e,t){return e.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(t).toArray()}function _(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.editMsgHistory.get({editMsgHistoryId:t})}function f(e,t,n){return e.editMsgHistory.where("originalMsgExternalId").equals(n).filter(function(e){return e.editExternalId===t.externalId&&e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){if(e.length>1){var t=e.map(function(e){return""+e.editTs.toString()}),n=new Set(t).size===1;n?d.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"]))):d.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"])),e.length)}return e[0]})}function g(e,t){return t==null?o("MAWDexieTable").dexieResolve([]):e.editMsgHistory.where("originalMsgExternalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){var t=[];return e.forEach(function(e){e!=null&&t.push(e)}),t})}function h(e,t){return e.editMsgHistory.bulkGet(t)}function y(e,t){return e.editMsgHistory.bulkAdd(t,{allKeys:!0}).then(function(e){return o("MAWDexieTable").dexieResolve(e)})}function C(e,t,n,r){return r.then(function(r){return b(e,t,n,r)})}function b(e,t,n,r){var a=[];return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===r&&e.author===n&&(e.sendStatus==null||e.sendStatus>=o("MAWAckLevel").ACK.sent)}).toArray().then(function(e){return e.forEach(function(e){a.push({messageId:e.editExternalId,originalMessageId:e.originalMsgExternalId,text:o("MAWVault").unvault(e.msgContent.content),timestamp:e.editTs})}),a})}function v(e,t,n,o){return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===o&&e.author===n}).delete().then(r("emptyFunction"))}var S=function(t,n){return t.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(n).delete().then(function(){return o("MAWDexieTable").dexieResolve(n.length)})};function R(e,t,n){return e.editMsgHistory.put(babelHelpers.extends({},t,{msgContent:n.msgContent})).then(function(){})}l.loadEditMsgHistory=m,l.getEditHistoryByOriginalMsgExternalIdAndThreadJid=p,l.maybeGetEditMsgHistoryFromEditMsgHistoryId=_,l.getEditHistoryMsgByEditedProtocolMsgId=f,l.maybeGetEditMsgHistoryFromProtocolMsgId=g,l.bulkGetEditMsgHistorys=h,l.bulkAddEditMsgHistory=y,l.getEditHistoryAsEchoWithJidPromise=C,l.getEditHistoryAsEcho=b,l.bulkRemoveEditHistory=v,l.deleteExpiredEditMsgHistory=S,l.updateEditMsgHistoryWithNewIncomingMsg=R}),98);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","WAJids","WAMsgMap","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=new Set,r=[];return t.forEach(function(e){var t=e.chatJid,o=e.msg;n.add(t),r.push(o.originalMsgExternalId)}),o("MAWDexieTable").dexieAll([e.messages.where("externalId").anyOf(r).toArray(),e.messages.where("quoteExternalId").anyOf(r).toArray(),e.editMsgHistory.where("originalMsgExternalId").anyOf(r).toArray()]).then(function(e){var t=e[0],n=e[1],r=e[2];return{editMsgHistory:r,originalMsgs:t,quoteMessages:n}})}function s(e,t,n){var a=n.editMsgHistory,i=n.originalMsgs,l=n.quoteMessages,s=i.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),u=a.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),d=c(t,{messageHistoriesToEdit:u,messagesToEdit:s}),m=d[0],p=d[1],_=d[2];return o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,m).then(function(){var t=new(o("WAMsgMap")).MsgMap;p.entries().forEach(function(e){var n,a,i=e[0],l=e[1],u=s.get(i);if(u==null){r("FBLogger")("messenger_web").warn("Cannot find the original msg for the edit action.");return}if(u.type!==o("WAMsgType").MSG_TYPE.TEXT&&u.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",u.type);var c=babelHelpers.extends({},u,{editCount:((n=u.editCount)!=null?n:0)+((a=_.get(i))!=null?a:0),msgContent:l.editMsgContent,type:o("WAMsgType").MSG_TYPE.TEXT});t.set(i,c)});var n=l.map(function(e){var n=e.quote,a=e.quoteExternalId,i=e.threadJid;if(n==null){r("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",e.externalId);return}var l=n.content.author,s=o("MAWJidUtils").maybeToProtocolMsgId(l==="@me"?o("MAWUserJidWrapper").getMyUserJid():l,i,a);if(s!=null){var u=t.get(s);if(u!=null)return babelHelpers.extends({},e,{quote:babelHelpers.extends({},n,{content:babelHelpers.extends({},n.content,{msgContent:babelHelpers.extends({},u.msgContent)})})})}}).filter(Boolean);return e.messages.bulkPut(t.values().concat(n)).then(function(){t.values().forEach(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(){n.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})})}function u(e,t){var n,a,i,l;switch(e.type){case o("WAMsgType").MSG_TYPE.TEXT:case o("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:e.author,editExternalId:e.externalId,editTs:(n=e.serverTs)!=null?n:e.ts,msgContent:(a=e.editMsgContent)!=null?a:o("MAWUnsafeCoerce").unsafeCoerce(e.msgContent),originalMsgExternalId:(i=e.originalMsgExternalId)!=null?i:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};case o("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:e.author,editExternalId:e.externalId,editTs:(l=e.serverTs)!=null?l:e.ts,msgContent:{content:""},originalMsgExternalId:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};default:throw e.type,r("FBLogger")("messenger_web").mustfixThrow("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function c(e,t){var n=t.messageHistoriesToEdit,a=t.messagesToEdit,i=[],l=new(o("WAMsgMap")).MsgMap,s=new(o("WAMsgMap")).MsgMap;return e.forEach(function(e){var t=e.chatJid,c=e.msg,d=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.originalMsgExternalId);if(d==null)throw r("FBLogger")("messenger_web").mustfixThrow("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.originalMsgExternalId);var m=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.externalId);if(m==null)throw r("FBLogger")("messenger_web").mustfixThrow("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.externalId);if(n.get(m)==null){var p;i.push(u(c,t));var _=(p=s.get(d))!=null?p:0,f=a.get(d);if(s.set(d,_+1),n.get(d)==null&&_===0&&f!=null){if(f.type!==o("WAMsgType").MSG_TYPE.TEXT&&f.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",f.type);i.push(u(f,t))}}var g=l.get(d),h=g==null?void 0:g.serverTs,y=c==null?void 0:c.serverTs;(h==null||y==null||h<y)&&l.set(d,c)}),[i,l,s]}l.prepareDataForMessageEdit=e,l.bulkEditMsgs=s,l.getMessageHistory=u}),98);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case o("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case o("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case o("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}l.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=s}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case o("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;case o("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL;case o("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.GRID:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}l.convertXMALayoutTypeToExtendedContentXMLLayoutType=s}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_POST_REACTION_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}l.convertXMATargetTypeToExtendedContentTargetType=s}),98);
__d("MAWEchoToProtobufConversionLoggingUtils",["QPLUserFlow","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){r("QPLUserFlow").start(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function s(e,t,n){r("QPLUserFlow").endFailure(r("qpl")._(521484676,"2684"),t,{annotations:n,instanceKey:e})}function u(e,t){r("QPLUserFlow").endSuccess(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function c(e,t,n){n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521484676,"2684"),n,{instanceKey:e}),r("QPLUserFlow").addPoint(r("qpl")._(521484676,"2684"),t,{instanceKey:e})}l.startQplUserFlow=e,l.endFailure=s,l.endSuccess=u,l.addPoint=c}),98);
__d("MAWCastToMsgrServerMediaType",["EncryptedBackupsUploadEntity","MAWDbMedia","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n){if(n===void 0&&(n=!1),n&&t==="image")return"xma";switch(t){case"image":case"video":case"gif":case"sticker":return t;case"document":return"file";case"ptt":return"audio";case"xma-image":return"xma";case"preview":return"preview";default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"])),t),null}}function d(e,t){if(t===void 0&&(t=!1),t&&e===o("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(e){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"file";case"Ptt":return"audio";default:return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"])),e),null}}function m(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return"image";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return"video";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return"gif";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER:return"sticker";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return"file";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return"audio";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA:return"xma";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW:return"preview";default:return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["invalid attachment mediaType: "," for castMediaAttachmentTypeToServerMediaType method"])),e),null}}l.castToMsgrServerMediaType=c,l.castClientMediaTypeToServerMediaType=d,l.castMediaAttachmentTypeToServerMediaType=m}),98);
__d("WADbDeviceRegistration",["gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=25,s=6,u=s,c="https://reg-e2ee.facebook.com",d=r("gkx")("13108")?"https://reg-e2ee.messenger.com":c,m="https://v.whatsapp.net",p="https://reg-e2ee.instagram.com",_="/v2/fb_icdc_fetch",f="/v2/fb_register_v2",g="Device has already been registered to WA servers",h="Device registration finished successfully",y="Device registration retries failed "+s+" times. No longer attempting registration.",C="Device registration response was null",b="Current user id is zero",v="CryptoAuthToken is empty",S="CryptoAuthToken is expired",R={failed:"failed",finished:"finished"};l.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=e,l.MAX_DEVICE_REGISTRATION_RETRIES=s,l.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=u,l.REG_FB_DOMAIN=c,l.REG_MSGR_DOMAIN=d,l.REG_WA_DOMAIN=m,l.REG_IGD_DOMAIN=p,l.ICDC_ENDPOINT=_,l.REGISTRATION_ENDPOINT=f,l.DEVICE_ALREADY_REGISTERED=g,l.DEVICE_SUCCESSFULLY_REGISTERED=h,l.FAILED_REGISTRATION_RETRIES=y,l.NULL_RESPONSE_FROM_SERVER=C,l.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=b,l.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=v,l.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=S,l.RegistrationStatesEnum=R}),98);
__d("WorkerUtils",[],(function(t,n,r,o,a,i){"use strict";function e(){try{return"WorkerGlobalScope"in t&&t instanceof t.WorkerGlobalScope}catch(e){return!1}}function l(){try{return"SharedWorkerGlobalScope"in t&&t instanceof t.SharedWorkerGlobalScope}catch(e){return!1}}i.isWorkerContext=e,i.isSharedWorkerContext=l}),66);
__d("getOrchestratorVersion",["qex"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e;return(e=r("qex")._("263"))!=null?e:"default"}l.default=e}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=1,u={armadilloWebProcessFutureproof:function(){return r("MAWGK").armadillo_web_process_futureproof},getSignalFutureMessagesMax:function(){return r("justknobx")._("847")},icdcAlertTriggerFailureCounter:function(){return r("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return r("justknobx")._("1971")},icdcIntervalInMinutes:function(){return r("justknobx")._("1972")},isDocumentReceiveEnabled:function(){return!r("gkx")("23924")},isFrankingDropOnInvalid:function(){return r("gkx")("23973")},isFrankingDropOnMissing:function(){return r("gkx")("23974")},isICDCErrorEnabled:function(){return r("gkx")("23975")},isMetaAiInvocationMessageRenderEnabled:function(){return r("gkx")("12661")},isPollsEnabled:function(){return!1},isProgressiveJpegSendEnabled:function(){return!0},isSharedWorkerContext:function(){return(e||(e=o("WorkerUtils"))).isSharedWorkerContext()},jpegThumbnailTargetByteSizeKB:function(){return r("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return o("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},newClockSkewCalculation:function(){return r("gkx")("18494")},orchestratorVersion:function(){return r("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return!0},sessionDropIfTooOld:function(){return r("justknobx")._("2240")},skipProcessingGroupInvite:function(){return!0},waDanglingQueue:function(){return!0}},c={productTypeForEBAttachments:"msgr",supportedTypesVersion:function(){return r("MAWGK").armadillo_web_process_futureproof?s+1:s},supportedXMATargetTypes:function(){return o("MAWParseXMAFBConfig").FB_FULLY_SUPPORTED_TARGET_TYPES}};l.waConfig=u,l.mawConfig=c}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWMainWebWorkerConfig").mawConfig;function s(){return e}function u(t){e=t}l.getConfig=s,l.setConfig=u}),98);
__d("MAWGetMsgForProtocolMsgIdTxn",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"getMsgForProtocolMsgIdTxn",function(e){return function(t){return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(e){return e!=null?o("WAResultOrError").makeResult(e):o("WAResultOrError").makeError("message-not-found")})}});l.getMsgForProtocolMsgIdTxn=e}),98);
__d("MAWBridgeTrace",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i,l,s){var u=e.ack,c=e.externalId,d=e.ts,m=e.type,p=o("WAJids").switchOnMsgrChatJidType(t,{group:function(t){return"Group"},user:function(t){return"User"}});return{ack:u,externalId:c,isFirstMsg:!!a,openMessageOtid:r,openMessageParticipantCount:i,participantCount:l,threadJid:t,threadKey:s,threadType:p,traceType:n,ts:d,type_:m}}function s(e,t,n){return{traceContext:n,traceId:t,traceType:e}}function u(e,t,n,r){return{errorMessage:r,event:t,externalIds:e,traceType:n}}function c(e,t,n,r,o,a){return{checkPointId:e,dataTraceId:t,errorMessage:n,shouldFlush:r,syncChannel:o,tags:a}}l.createBridgeStartTraceData=e,l.createBridgeStartTraceWithTraceIdData=s,l.createBridgeUpdateTraceData=u,l.createBridgeTraceRecordCheckpointData=c}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum")({MSGR:"msgr",IGD:"igd"}),l=e;i.default=l}),66);
__d("MAWMainTraceUtils",["LSRequestId"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("LSRequestId").generate()}l.createTraceId=e}),98);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.actionType,n=e.attachmentContext,r=e.attachmentContextArray,o=e.authTs,a=e.echoDocument,i=e.echoEncodingLatencyNs,l=e.errorCode,s=e.errorMessage,c=e.messageId,d=e.messageType,m=e.productType,p=e.protoMsg,_=e.sortOrderMs,f=e.threadId,g=e.traceId,h=e.uploadTrackingInstanceKey,y=u(n,m!=null?m:"msgr",r);return{actionType:t,attachmentBackupContext:y,authTs:o,echoDocument:a,echoEncodingLatencyNs:i,errorCode:l,errorMessage:s,messageId:c,messageType:d,protoMsg:p,sortOrderMs:_,threadId:f,traceId:g,uploadTrackingInstanceKey:h}}function s(e,t,n,r,o,a){return{actionType:a,echoDocument:o,folderType:t,threadId:e,transportKey:n,ts:r}}function u(e,t,n){if(n!=null){var r=n.map(function(e){return{attachmentTraceId:o("MAWMainTraceUtils").createTraceId(),mediaType:e.mediaType,zippyObjectId:e.mediaObjectId}}),a={attachmentInfos:r,productType:t};return a}}l.createBridgeUploadMessage=e,l.createBridgeDeleteMessagesOfThread=s,l.createBridgeUploadAttachmentBackupContext=u}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function s(t){switch(t){case o("MAWFolderTypes").FOLDER_ID.INBOX:return e.INBOX;case o("MAWFolderTypes").FOLDER_ID.PENDING:return e.PENDING;case o("MAWFolderTypes").FOLDER_ID.ARCHIVED:return e.ARCHIVED;default:return e.INBOX}}function u(e){return s(e).toString()}l.FolderType=e,l.getFolderTypeAsText=u}),98);
__d("MAWMsgCleaner",["MAWLoggerUtils","MWFBLogger","Promise","WAAssertUnreachable","WAShiftTimer","WATimeUtils","WorkerScheduler","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="Unsend",m="Ephemeral",p="DeleteForMe",_="PendingStanza",f="Xma",g="IGDDM",h="Quote",y=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerUpdate]),C={DELETE_FOR_ME:p,EPHEMERAL:m,IGDDM:g,PENDING_STANZA:_,QUOTE:h,UNSEND:d,XMA:f},b;function v(){return b==null&&(b=o("WorkerScheduler").makeScheduler("cleaner",{concurrency:1,maxTaskLimit:1,maxThrottleMs:8e3})),b}var S=(function(){function t(e,t){var n=this;this.$1=new(o("WAShiftTimer")).ShiftTimer(function(){r("promiseDone")(n.$2())}),this.getNextTs=e.getNextTs,this.removeExpired=e.removeExpired,this.cleanerType=t,this.purgeEnabled=e.purgeEnabled,this.$1.forceRunNow()}var a=t.prototype;return a.update=function(n){var t=R(this.cleanerType);y.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""])),t,n),this.$1.onOrBefore(o("WATimeUtils").cappedMillisecondsUntil(n))},a.$2=function(){var e=this,t=function(){if(!e.purgeEnabled())return(c||(c=n("Promise"))).resolve();var t=R(e.cleanerType);return y.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"])),t),e.removeExpired().then(function(n){return n>0&&y.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"])),t,n),e.getNextTs()}).then(function(t){t!=null&&e.update(t)})};return this.$3!=null?(c||(c=n("Promise"))).resolve():(this.$3=v().task({fn:t,name:this.cleanerType,priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),this.$3.run().finally(function(){e.$3=null}))},t})();function R(e){switch(e){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";case"Quote":return"QuoteCleaner";default:return r("WAAssertUnreachable")(e)}}var L=S;l.CLEANER_TYPE=C,l.MsgCleaner=S,l.MSG_CLEANER_FOR_TESTING_ONLY=L}),98);
__d("MpsDeletedCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new MpsDeletedTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MpsDeletedCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startMpsDeletedCleaner=c,l.addNewMpsDeletedTimestamp=d,l.getMpsDeletedCleaner_FOR_TESTING_ONLY=m,l.resetMpsDeletedCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"purgeDeletions"]);function c(e){s==null&&(s=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.EPHEMERAL))}function d(t){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",")"])),t),s.update(t)}function m(){return s}function p(){s=null}l.startMpsEphemeralCleaner=c,l.addNewMpsEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsReverbDbDump",["WebReverbDB","WormDump"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t=o("WebReverbDB").getWebReverbDB();return t.dump({dbMetadata:{customFields:{mawDBMigrationCurrentMessageId:(e=o("WormDump")).wormNonSensitiveField,mawDBMigrationCurrentThread:e.wormNonSensitiveField,mawDBMigrationStartMs:e.wormNonSensitiveField,mawDBMigrationState:e.wormNonSensitiveField,pk:e.wormNonSensitiveField}},deleted:{customFields:{deletedMessageId:e.wormNonSensitiveField,deletionMessageId:e.wormNonSensitiveField,deletionTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},message:{customFields:{debugFlags:e.wormNonSensitiveField,expiryTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,isTransportErrorPlaceholder:e.wormNonSensitiveField,messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,senderId:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:2500},supplemental:{customFields:{messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},tags:{customFields:{messageId:e.wormNonSensitiveField,messagePk:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:1e3}})}l.debugGetReverbDbDump=e}),98);
__d("QPLMultiplexedFlow",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=Array.from(new Set(e));return{addAnnotations:function(n){t.forEach(function(e){return e.addAnnotations(n)})},addPoint:function(n,r){t.forEach(function(e){return e.addPoint(n,r)})},endCancel:function(n,r){t.forEach(function(e){return e.endCancel(n,r)})},endFail:function(n,r){t.forEach(function(e){return e.endFail(n,r)})},endSuccess:function(n){t.forEach(function(e){return e.endSuccess(n)})},getQPLAttrs:function(){return t.map(function(e){return e.getQPLAttrs()})[0]},isActive:function(){return t.some(function(e){return e.isActive()})},start:function(){}}}i.makeQplMultiplexedFlow=e}),66);
__d("WebMpsGetDistinctSupplementals",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=new Map(e),r=new Map;return t.forEach(function(e,t){var o=n.get(t);if(o==null)n.set(t,e),r.set(t,e);else{var a=o.timestampMs,i=e.timestampMs;i>a&&(n.set(t,e),r.set(t,e))}}),{supplementals:n,supplementalsToWriteToReverb:r}}i.getDistinctSupplementals=e}),66);
__d("WebMpsGetDistinctMessages",["WebMpsGetDistinctSupplementals"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"],s=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function u(t,n){var r=new Map,a=new Map;t.forEach(function(t){var n=t.reverbTopLevel,o=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=babelHelpers.objectWithoutPropertiesLoose(n,e);a.set(t.reverbTopLevel.messageId,t),r.set(t.reverbTopLevel.messageId,{expiryTimestampMs:i,supplementalProtobufs:t.supplementalProtobufs,tags:t.tags,toplevelProtobuf:c})});var i=new Map,l=new Map,u=new Map;return n.forEach(function(e){var t=e.supplementalProtobufs,n=e.tags,c=e.toplevelProtobuf,d=c.messageId,m=a.get(d);if(m==null||m.reverbTopLevel.isTransportErrorPlaceholder===!0)r.set(d,e),i.set(d,c),l.set(d,new Map(t)),u.set(d,n);else{var p=m.supplementalProtobufs,_=o("WebMpsGetDistinctSupplementals").getDistinctSupplementals(p,t),f=_.supplementals,g=_.supplementalsToWriteToReverb,h=m.reverbTopLevel,y=h.debugFlags,C=h.expiryTimestampMs,b=h.isLocalOnlyMessage,v=h.isTransportErrorPlaceholder,S=h.pk,R=babelHelpers.objectWithoutPropertiesLoose(h,s);r.set(d,{expiryTimestampMs:C,supplementalProtobufs:f,tags:m.tags,toplevelProtobuf:R}),g.size>0&&l.set(d,new Map(g))}}),{messages:Array.from(r.values()),supplementalMessagesToWriteToReverb:l,tagsToWriteToReverb:u,topLevelMessagesToWriteToReverb:i}}l.getDistinctMessages=u}),98);
__d("WebMpsGetIsMessageExpired",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e!=null&&o("WATimeUtils").cappedMillisecondsUntil(o("WATimeUtils").castMilliSecondsToUnixTime(e))<=0}l.getIsMessageExpired=e}),98);
__d("WebMpsReverbWrites",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";function e(e,t,r,o,a,i,l){var s=[a,o,r];return l((function(){var l=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var l,u=yield n.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",s);if(!(((l=u==null?void 0:u.timestampMs)!=null?l:0)>=i)){var c={messageId:e,payload:t,supplementalKey:r,threadId:a,timestampMs:i,topLevelMessageId:o};yield n.stores.supplemental.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:c,selector:s}])}});return function(e){return l.apply(this,arguments)}})())}function l(e,t,r){var o=e.messageId,a=e.threadId;return r((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r,i=yield n.stores.message.getByIndex("[threadId+messageId]",[a,o]);if(!(i!=null&&!i.isTransportErrorPlaceholder)&&!(i!=null&&i.isTransportErrorPlaceholder&&t.isTransportErrorPlaceholder)){var l=yield n.stores.deleted.getByIndex("[threadId+deletedMessageId]",[e.threadId,e.messageId]),s=babelHelpers.extends({},e,{debugFlags:t.debugFlags,expiryTimestampMs:t.expiryTimestampMs,isLocalOnlyMessage:t.isLocalOnly,isTransportErrorPlaceholder:t.isTransportErrorPlaceholder,timestampMs:(r=i==null?void 0:i.timestampMs)!=null?r:e.timestampMs});if(l)l.payload=s.payload,yield n.stores.deleted.bulkPut([l]),i!=null&&(i.timestampMs=e.timestampMs,yield n.stores.message.bulkPut([i]));else{var u=yield n.stores.message.bulkUpsert("[threadId+messageId]",[{item:s,selector:[a,o]}]),c=u[0],d=yield n.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[a,o]});d.length>0&&(yield n.stores.tags.bulkDelete(d.map(function(e){return e.pk}))),t.tags.length>0&&(yield n.stores.tags.bulkAdd(t.tags.map(function(e){return{messageId:s.messageId,messagePk:c,tag:e,threadId:s.threadId,timestampMs:s.timestampMs}})))}}});return function(e){return r.apply(this,arguments)}})())}i.upsertSupplementalToReverb=e,i.upsertTopLevelToReverb=l}),66);
__d("WebMpsPersistMessagesFromEb",["FBLogger","MpsLogger","MpsTypes","Promise","WebMpsReverbWrites","WebReverbDB","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(!(t.length===0||t.every(function(e){return e.topLevelProtobufs.size===0&&e.supplementalProtobufs.size===0&&e.tags.size===0})))try{yield o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(o){var a=t.map(function(t){var n=t.supplementalProtobufs,a=t.tags,i=t.threadId,l=t.topLevelProtobufs;return r("FBLogger")("mps").INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Persisting EB messages thread: "," topLevelProtobufs: "," supplementalProtobufs: ",""])),i,Array.from(l.keys()).join(","),Array.from(n.keys()).join(",")),d(l,n,a,i,function(e){return e(o)})}).flat();return(s||(s=n("Promise"))).all(a)},"mps-persist-messages-from-eb")}catch(e){var a=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(a).mustfix("Runtime error performing persistMessagesFromEB"),a}}),c.apply(this,arguments)}function d(e,t,n,r,a){var i=[];return e.forEach(function(e,t){var r;i.push(o("WebMpsReverbWrites").upsertTopLevelToReverb(e,{actionType:o("MpsTypes").ActionType.UpsertTopLevel,debugFlags:["EB"],isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:(r=n.get(t))!=null?r:[],targetMessageId:t},a))}),t.forEach(function(e,t){e.forEach(function(e,n){i.push(o("WebMpsReverbWrites").upsertSupplementalToReverb(e.messageId,e.payload,n,t,r,e.timestampMs,a))})}),i}l.persistMessagesFromEB=u}),98);
__d("WebMpsBatchLoadMessage",["CoalescingLoader","MpsLogger","Promise","QPLMultiplexedFlow","WebMpsGetDistinctMessages","WebMpsGetIsMessageExpired","WebMpsPersistMessagesFromEb","WebReverbDB","asyncToGeneratorRuntime","getErrorSafe","getSafeQplErrorMessage","groupBy"],(function(t,n,r,o,a,i,l){"use strict";var e=["messageId"],s=["config","ctx","messageId","threadId"],u=["pk","supplementalKey","threadId","topLevelMessageId"],c,d=(function(){function t(t){var a=this;this.$3=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var i=r("groupBy")(t,function(e){return a.$4(e)}),l=new Map;return yield(c||(c=n("Promise"))).all(Object.entries(i).map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t[0],r=t[1],i=r.map(function(e){return e.ctx.metric}),s=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(i);s.addAnnotations({int:{coalesced_batch_size:r.length}});var u=r[0],c=u.messageId,d=babelHelpers.objectWithoutPropertiesLoose(u,e),m=babelHelpers.extends({},d,{ctx:{metric:s},messageIds:r.map(function(e){return e.messageId})}),p=yield a.batchLoad(m);l.set(n,p)});return function(e){return t.apply(this,arguments)}})())),t.map(function(e){var t=l.get(a.$4(e));return t==null?void 0:t.find(function(t){return(t==null?void 0:t.toplevelProtobuf.messageId)===e.messageId})})});return function(e){return t.apply(this,arguments)}})(),this.$1=t,this.$2=new(o("CoalescingLoader")).CoalescingLoader(this.$3)}var a=t.prototype;return a.$4=function(t){var e=t.config,n=t.ctx,r=t.messageId,o=t.threadId,a=babelHelpers.objectWithoutPropertiesLoose(t,s);return JSON.stringify({config:e,threadId:o})},a.$5=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a,i){try{i.metric.addPoint("load-message-from-reverb_start");var l=o("WebReverbDB").getWebReverbDB(),s=yield l.runInTransaction(["message","supplemental","tags"],"readonly",function(r){return(c||(c=n("Promise"))).all(t.map(function(t){var o=r.stores.message.readIndex("[threadId+messageId]",[e,t],{limit:1}),i=a.shouldFetchTags?r.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[e,t]}):[],l=a.shouldFetchSupplementals?r.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[e,t]}):[];return(c||(c=n("Promise"))).all([t,o,l,i])}))},"mps-load-message");i.metric.addPoint("load-message-from-reverb_end");var d=new Map;return s.forEach(function(e){var t=e[0],n=e[1],r=n[0],a=e[2],i=e[3];if(r==null||o("WebMpsGetIsMessageExpired").getIsMessageExpired(r.expiryTimestampMs))return null;var l=new Map;a.forEach(function(e){var t=e.pk,n=e.supplementalKey,r=e.threadId,o=e.topLevelMessageId,a=babelHelpers.objectWithoutPropertiesLoose(e,u);l.set(n,a)});var s=i.map(function(e){var t=e.tag;return t});d.set(t,{reverbTopLevel:r,supplementalProtobufs:l,tags:s})}),d}catch(e){return i.metric.addPoint("load-message-from-reverb_fail"),o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Runtime error performing loadMessageFromReverb"),new Map}});function t(t,n,r,o){return e.apply(this,arguments)}return t})(),a.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){try{var a=this.$1,i=a.decryptedProtobufToFullMessage,l=a.eb,s=l.isEbEnabled(),u=s===!0?"true":s===!1?"false":"unset";if(n.metric.addAnnotations({string:{ebEnabled:u}}),s!==!0)return new Map;n.metric.addPoint("load-message-from-eb_start");var c=l.messagePointQuery,d=yield c({ctx:n,messageIds:t,threadId:e});if(d.success===!1)return new Map;var m=i(d.value,e);return n.metric.addPoint("load-message-from-eb_end"),new Map(m.map(function(e){return[e.toplevelProtobuf.messageId,e]}))}catch(e){n.metric.addPoint("load-message-from-eb_fail");var p=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(p).mustfix("Runtime error performing loadFromEB"),new Map}});function t(t,n,r){return e.apply(this,arguments)}return t})(),a.batchLoad=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=this,a=e.config,i=e.ctx,l=e.messageIds,s=e.threadId;try{i.metric.addPoint("load-message_start");var u=function(){return t.$5(s,l,a,i)},d=function(){return t.$6(s,l,i)},m=a.strategy==="local-first"?n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield u(),t=e.size===l.length;return t?[e,new Map]:[e,yield d()]}):a.strategy==="full-fetch"?function(){return(c||(c=n("Promise"))).all([u(),d()])}:a.strategy==="local-only"?n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return[yield u(),new Map]}):a.strategy==="remote-only"?n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return[new Map,yield d()]}):(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+a.strategy)})(),p=yield m(),_=p[0],f=p[1],g=l.map(function(e){var t=_.get(e),n=f.get(e);return o("WebMpsGetDistinctMessages").getDistinctMessages([t].filter(Boolean),[n].filter(Boolean))});return a.persistToReverb==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(g.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:s,topLevelProtobufs:r}})),i.metric.addPoint("load-message_end"),g.map(function(e){return e.messages[0]})}catch(e){var h=r("getErrorSafe")(e);throw i.metric.addPoint("load-message_fail",{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(h)}}),o("MpsLogger").MpsLogger().catching(h).mustfix("Runtime error performing loadMessage"),h}});function t(t){return e.apply(this,arguments)}return t})(),a.load=function(t){return this.$2.gen(t)},t})();l.WebMpsPointQueryApi=d}),98);
__d("PackedMpsRange",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.packMpsRange=e}),66);
__d("WebMpsBatchLoadFromReverb",["MpsLogger","Promise","WebMpsGetIsMessageExpired","WebReverbDB","WormRangeIterator","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"],s;function u(e,t,n,r,o,a,i,l,s,u,d){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a,i,l,u,c,d,m,p,_){var f,g=a[0],h=a[1],y=d?function(e){return e.isLocalOnlyMessage===!1}:function(e){return!0},C=function(t){return!o("WebMpsGetIsMessageExpired").getIsMessageExpired(t.expiryTimestampMs)},b=function(t){return y(t)&&C(t)};function v(){var e=t.stores.message.getIndexRangeIterator("[threadId+timestampMs+messageId]",i,{greaterThanOrEqual:[r],lessThanOrEqual:[r]},b),n=h==null?[r,g]:[r,g,h];return e.read(n,l)}function S(e){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var a="[threadId+tag+timestampMs]",u=yield(s||(s=n("Promise"))).all(Array.from(e).map(function(e){return t.stores.tags.getIndexRangeIterator(a,i,{greaterThanOrEqual:[r,e],lessThanOrEqual:[r,e]}).read([r,e,g],l)})),c=o("WormRangeIterator").mergeRanges(u,["timestampMs","messageId"],i,l),d=yield s.all(c.data.map(function(e){return t.stores.message.getByIndex("[threadId+messageId]",[e.threadId,e.messageId],{filter:b})})).then(function(e){return e.filter(Boolean)}),m=o("WormRangeIterator").makeCursorInfoFromList(d,["threadId","timestampMs","messageId"],c.cursorInfo.hasNext,c.cursorInfo.hasPrevious);return{cursorInfo:m,data:d}}),R.apply(this,arguments)}var L;m!=="all"?(p.metric.addPoint("load_messages_with_tags_"+_+"_start"),L=yield S(m),p.metric.addPoint("load_messages_with_tags_"+_+"_end")):(p.metric.addPoint("load_messages_canoincal_"+_+"_start"),L=yield v(),p.metric.addPoint("load_messages_canonical_"+_+"_end"));var E=L,k=E.cursorInfo,I=E.data;p.metric.addPoint("load_message_results_"+_+"_start"),p.metric.addAnnotations({bool:{shouldFetchTags:c}});var T=yield(s||(s=n("Promise"))).all(I.map((function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=u?yield t.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[r,n.messageId]}):[],a=new Map;o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,i=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e);a.set(r,l)});var i=c?yield t.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[r,n.messageId]}):[],l=i.map(function(e){var t=e.tag;return t});return{reverbTopLevel:n,supplementalProtobufs:a,tags:l}});return function(e){return o.apply(this,arguments)}})())),D=T.reduce(function(e,t){return e+t.supplementalProtobufs.size},0);return p.metric.addAnnotations({int:(f={},f["supplementalCount_"+_]=D,f)}),p.metric.addPoint("load_message_results_"+_+"_end"),{cursorInfo:{endCursor:k.endCursor!=null?[k.endCursor[1],k.endCursor[2]]:null,hasNext:k.hasNext,hasPrevious:k.hasPrevious,startCursor:k.startCursor!=null?[k.startCursor[1],k.startCursor[2]]:null},messages:T,threadId:r}}),c.apply(this,arguments)}function d(e,t,n,r,o,a){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a,i,l,c){try{l.metric.addPoint("reverb_fetch_start");var d=o("WebReverbDB").getWebReverbDB(),m=new Map(yield d.runInTransaction(["message","supplemental","tags"],"readonly",function(r){return(s||(s=n("Promise"))).all(e.map(function(e,n){return u(r,e.threadId,e.from,e.direction,e.numMessages,t,a,i,c,l,n).then(function(t){return[e,t]})}))},"mps-load-messages"));return l.metric.addPoint("reverb_fetch_end"),m}catch(e){var p=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(p).mustfix("Runtime error performing WebMpsBatchLoadFromReverb"),l.metric.addPoint("reverb_fetch_end",{bool:{reverbFail:!0}}),new Map}}),m.apply(this,arguments)}l.batchLoadMessagesFromReverb=d}),98);
__d("WebMpsLoadMessagesFromEb",["MpsLogger","WAPromiseDelays","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe","getSafeQplErrorMessage","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e={endCursor:null,hasNext:!1,hasPrevious:!1,startCursor:null};function s(e,t,n,r,o,a){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a,i,l){function s(){throw a.metric.addPoint("eb_fetch_timeout"),o("MpsLogger").MpsLogger().mustfixThrow("Timed out waiting for EB Fetch")}var u=e.reduce(function(e,t){return e+t.numMessages},0),c=Math.min(Math.max((u-20)/180,0),1),d=r("justknobx")._("3429")*(1+c*2),m=yield o("WAPromiseDelays").withTimeout(t.messageRangeQuery({ctx:a,ranges:e,source:l,tagsFilter:i}),d,s),p=m.map(function(t,r){var a=e[r],i=a.threadId;if(t.success===!1)return t;var l=t.value,s=l.cursorInfo,u=l.messages,c=n(u,i);return o("WAResultOrError").makeResult({cursorInfo:s,messages:c,threadId:i})});return a.metric.addPoint("eb_fetch_end"),p}),u.apply(this,arguments)}function c(e,t,n,r,o){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var u=n.decryptedProtobufToFullMessage,c=n.eb;try{var d=c.isEbEnabled(),m=d===!0?"true":d===!1?"false":"unset";if(a.metric.addAnnotations({string:{ebEnabled:m}}),d!==!0)return new Map(t.map(function(t){return[t,o("WAResultOrError").makeResult({cursorInfo:e,messages:[],threadId:t.threadId})]}));var p=!1;a.metric.addPoint("load-messages-from-eb_start");var _=yield s(t,c,u,a,i,l),f=new Map(t.map(function(e,t){var n=_[t];return n.success===!1&&(p=!0),[e,n]}));return p&&a.metric.addAnnotations({bool:{ebFetchFailed:!0}}),a.metric.addPoint("load-messages-from-eb_end"),f}catch(e){var g=r("getErrorSafe")(e);return a.metric.addPoint("load-messages-from-eb_fail",{string:{ebFetchFailReason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}}),o("MpsLogger").MpsLogger().catching(g).mustfix("Error fetching from EB"),new Map}}),d.apply(this,arguments)}l.loadMessagesFromEb=c}),98);
__d("WebMpsMergeMessageRangesFromDifferentSources",["WebMpsGetDistinctMessages","err","first","last"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function s(t,n,a,i,l){var s,u,c=o("WebMpsGetDistinctMessages").getDistinctMessages((s=n==null?void 0:n.messages)!=null?s:[],(u=t==null?void 0:t.messages)!=null?u:[]),d=c.messages,m=c.supplementalMessagesToWriteToReverb,p=c.tagsToWriteToReverb,_=c.topLevelMessagesToWriteToReverb;if(n==null||t==null){var f=n!=null?babelHelpers.extends({},n,{messages:n.messages.map(function(t){var n=t.reverbTopLevel,r=t.supplementalProtobufs,o=n.debugFlags,a=n.expiryTimestampMs,i=n.isLocalOnlyMessage,l=n.isTransportErrorPlaceholder,s=n.pk,u=babelHelpers.objectWithoutPropertiesLoose(n,e);return{expiryTimestampMs:a,supplementalProtobufs:r,tags:[],toplevelProtobuf:u}})}):t;if(f==null)throw r("err")("data-fetching-error");return{range:f,supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}var g=t,h=[].concat(d).sort(function(e,t){return a==="asc"?e.toplevelProtobuf.timestampMs-t.toplevelProtobuf.timestampMs:t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}),y=h.slice(0,i),C=r("first")(y),b=r("last")(y),v=C!=null?[C.toplevelProtobuf.timestampMs,C.toplevelProtobuf.messageId]:void 0,S=b!=null?[b.toplevelProtobuf.timestampMs,b.toplevelProtobuf.messageId]:void 0,R=S!=null?g.cursorInfo.hasNext||n.cursorInfo.hasNext:!1,L=v!=null?g.cursorInfo.hasPrevious||n.cursorInfo.hasPrevious:!1;return{range:{cursorInfo:{endCursor:S,hasNext:R,hasPrevious:L,startCursor:v},messages:y,threadId:l},supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}l.mergeMessageRangesFromDifferentSources=s}),98);
__d("WebMpsEbCache",["MpsTypes","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i){var l=o("WAJids").validateChatJid(t);if(l==null)return[];var s=e.getMetadataFromCache({chatJid:l,direction:n,numberOfMessages:r,referenceMessage:i,referenceTimestamp:a==null?null:o("WATimeUtils").castToMillisTime(a)});return s.success===!1?[]:s.value.map(function(e){var t=e.offlineThreadingId,n=e.sortOrderMs;return{offlineThreadingId:t,sortOrderMs:o("MpsTypes").toTimestamp(n)}})}function s(e,t){if(e==null||t.length===0)return"no-match";if(e.cursorInfo.hasNext!==!0)return"reverb-cursor-ended";var n=new Set(e.messages.map(function(e){return e.reverbTopLevel.messageId})),r=new Set(t.map(function(e){return e.offlineThreadingId}));if(n.size!==r.size)return"no-match";if(Array.from(n).every(function(e){return r.has(e)}))return"match";for(var o=e.messages.map(function(e){return e.reverbTopLevel.timestampMs}).sort(function(e,t){return t-e}),a=t.map(function(e){return e.sortOrderMs}).sort(function(e,t){return t-e}),i=0,l=0;l<o.length;l++){var s=o[l],u=a[i];if(s<u)return"no-match";s>u||i++}return"reverb-newer"}l.loadEBMetadataCache=e,l.compareReverbVsMetadataCache=s}),98);
__d("WebMpsValidateReverbViaCacheAndFetchFromEb",["MpsLogger","WebMpsEbCache","WebMpsLoadMessagesFromEb","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,o){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a){var i=yield t;if(a!=="all")return r.metric.addAnnotations({string:{ebMetadataCache:"skip"}}),{eb:yield o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(e,n,r,a),reverb:i};var l=e.filter(function(e){var t=e.direction,a=e.from,l=e.numMessages,s=e.threadId,u=o("WebMpsEbCache").loadEBMetadataCache(n.eb,s,t,l,a[0],a[1]),c=o("WebMpsEbCache").compareReverbVsMetadataCache(i.get(e),u);return r.metric.addAnnotations({string:{ebMetadataCache:c}}),o("MpsLogger").MpsLogger().debug("MPS Range query metadata comparison: ",c),!(c==="match"||t==="desc"&&c==="reverb-newer")});return l.length===0?{eb:new Map,reverb:i}:{eb:yield o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(l,n,r,a),reverb:i}}),s.apply(this,arguments)}l.validateReverbViaCacheAndFetchFromEb=e}),98);
__d("WebMpsBatchLoadMessages",["MpsLogger","PackedMpsRange","WebMpsBatchLoadFromReverb","WebMpsLoadMessagesFromEb","WebMpsMergeMessageRangesFromDifferentSources","WebMpsPersistMessagesFromEb","WebMpsValidateReverbViaCacheAndFetchFromEb","asyncToGeneratorRuntime","err","getErrorSafe","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a){var i=n.persistToReverb,l=n.shouldFetchSupplementals,s=n.shouldFetchTags,u=n.shouldIgnoreLocalOnly,c=n.source,d=n.strategy,m=n.tagsFilter,p=e.map(function(e){return o("PackedMpsRange").packMpsRange(e)});try{a.metric.addPoint("mps_fetch_start");var _=function(){return o("WebMpsBatchLoadFromReverb").batchLoadMessagesFromReverb(p,l,s,u,a,m)},f,g;switch(d){case"full-fetch":{var h=yield o("WebMpsValidateReverbViaCacheAndFetchFromEb").validateReverbViaCacheAndFetchFromEb(p,_(),t,a,m);f=h.reverb,g=h.eb;break}case"local-only":f=yield _(),g=new Map;break;case"remote-only":g=yield o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(p,t,a,m,c),f=new Map;break;default:throw r("err")("empty strategy")}var y=p.map(function(e){var t,n=e.direction,r=e.numMessages,a=e.threadId,i=f.get(e),l=(t=g.get(e))==null?void 0:t.value;if(!(i==null&&l==null)){var s=o("WebMpsMergeMessageRangesFromDifferentSources").mergeMessageRangesFromDifferentSources(l,i,n,r,a),u=s.range,c=s.supplementalMessagesToWriteToReverb,d=s.tagsToWriteToReverb,m=s.topLevelMessagesToWriteToReverb;return{range:u,supplementalMessagesToWriteToReverb:c,tagsToWriteToReverb:d,threadId:a,topLevelMessagesToWriteToReverb:m}}}).filter(Boolean);return i==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(y.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.threadId,o=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:r,topLevelProtobufs:o}})),y.map(function(e){var t=e.range;return t})}catch(e){var C=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(C).mustfix("Runtime error performing loadMessages"),a.metric.addAnnotations({string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(C)}}),C}}),s.apply(this,arguments)}l.batchLoadMessages=e}),98);
__d("MAWMpsCleanersContants",["DateConsts"],(function(t,n,r,o,a,i,l){"use strict";var e=30*o("DateConsts").MS_PER_DAY,s=6*o("DateConsts").MS_PER_HOUR;l.PURGE_DELETED_MESSAGES_WINDOW_IN_MS=e,l.REPORTING_WINDOW_IN_MS=s}),98);
__d("WebMpsInsertionCleaners",["MAWMpsCleanersContants","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsTypes","Promise","WATimeUtils","asyncToGeneratorRuntime","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){try{yield(e||(e=n("Promise"))).all(t.map(c)),yield e.all(t.map(m))}catch(e){var a=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(a).mustfix("Failed to run side effects")}}),u.apply(this,arguments)}function c(t){return t.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevel||t.directive.actionType===o("MpsTypes").ActionType.DeleteSupplemental||t.directive.actionType===o("MpsTypes").ActionType.DeleteThread?d(t.message.timestampMs):t.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel||t.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental||t.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder||t.directive.actionType===o("MpsTypes").ActionType.Noop?(e||(e=n("Promise"))).resolve():t.directive.actionType===o("MpsTypes").ActionType.Unknown||t.directive.actionType===o("MpsTypes").ActionType.Preprocess?(e||(e=n("Promise"))).reject(r("err")("this should not happen")):(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+t.directive.actionType)})()}function d(t){var r=o("WATimeUtils").castToUnixTime(Math.ceil((t+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)/1e3));return o("MpsDeletedCleaner").addNewMpsDeletedTimestamp(r),(e||(e=n("Promise"))).resolve()}function m(t){var r,a=(r=t.directive)==null?void 0:r.expiryTimestampMs;if(a==null)return(e||(e=n("Promise"))).resolve();var i=o("WATimeUtils").castToUnixTime(Math.ceil(a/1e3));return o("MpsEphemeralCleaner").addNewMpsEphemeralTimestamp(i),(e||(e=n("Promise"))).resolve()}l.scheduleCleaners=s}),98);
__d("WebMpsInsertionFlow",["MpsLogger","MpsTypes","Promise","WebMpsReverbWrites","WebReverbDB","asyncToGeneratorRuntime","err","getErrorSafe","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{return yield o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){for(var n of e)yield m(n,function(e){return e(t)})});return function(e){return t.apply(this,arguments)}})(),"mps-insertion-flow-shared"),new Map}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Failed to persist messages")}return c(e)}),u.apply(this,arguments)}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=new Map,n=function*(n){yield m(n,function(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(t){return e(t)},"mps-insertion-flow-separate")}).catch(function(e){t.set(n.message.messageId,e)})};for(var r of e)yield*n(r);return t}),d.apply(this,arguments)}function m(t,a){switch(t.directive.actionType){case o("MpsTypes").ActionType.UpsertTopLevel:return p(t,a);case o("MpsTypes").ActionType.UpsertSupplemental:return f(t,a);case o("MpsTypes").ActionType.DeleteTopLevel:return h(t,a);case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return y(t,a);case o("MpsTypes").ActionType.DeleteSupplemental:return C(t,a);case o("MpsTypes").ActionType.DeleteThread:return b(t,a);case o("MpsTypes").ActionType.Noop:return(e||(e=n("Promise"))).resolve();case o("MpsTypes").ActionType.Unknown:case o("MpsTypes").ActionType.Preprocess:return(e||(e=n("Promise"))).reject(r("err")("this should not happen"))}}function p(e,t){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=e.directive,r=e.message;yield o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}),_.apply(this,arguments)}function f(e,t){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=e.directive,a=e.message,i=r("nullthrows")(n.supplementalKey);yield o("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,i,n.targetMessageId,a.threadId,a.timestampMs,t)}),g.apply(this,arguments)}function h(e,t){var r=e.message,o=e.directive.targetMessageId,a=[r.threadId,o];return t((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=yield e.stores.message.getByIndex("[threadId+messageId]",a),i=yield e.stores.deleted.getByIndex("[threadId+deletedMessageId]",a);if(!(((t=i==null?void 0:i.deletionTimestampMs)!=null?t:0)>=r.timestampMs)){var l={deletedMessageId:o,deletionMessageId:r.messageId,deletionMessagePayload:r.payload,deletionTimestampMs:r.timestampMs,isLocalOnlyMessage:!1,payload:n==null?void 0:n.payload,threadId:r.threadId,timestampMs:n==null?void 0:n.timestampMs};yield e.stores.deleted.bulkUpsert("[threadId+deletedMessageId]",[{item:l,selector:a}]),n&&(yield e.stores.message.bulkDelete([n.pk]))}});return function(t){return e.apply(this,arguments)}})())}function y(e,t){var n=e.directive,r=e.message;return o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}function C(e,t){var o=e.message,a=r("nullthrows")(e.directive.supplementalKey),i=e.directive.targetMessageId,l=[o.threadId,i,a];return t((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",l);if(n!=null){var r=yield t.stores.deleted.getByIndex("[threadId+topLevelMessageId+supplementalKey]",l,{filter:function(t){return t.deletionTimestampMs>=o.timestampMs}});if(!r){var s={deletedMessageId:n.messageId,deletionMessageId:o.messageId,deletionMessagePayload:o.payload,deletionTimestampMs:o.timestampMs,isLocalOnlyMessage:e.directive.isLocalOnly,payload:n.payload,supplementalKey:a,threadId:o.threadId,timestampMs:n.timestampMs,topLevelMessageId:i};yield t.stores.deleted.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:s,selector:l}]),yield t.stores.supplemental.bulkDelete([n.pk])}}});return function(e){return t.apply(this,arguments)}})())}function b(e,t){var r=e.message;return t((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield e.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[r.threadId]});yield e.stores.supplemental.bulkDelete(t);var n=yield e.stores.message.readIndexRange("[threadId+messageId]",{only:[r.threadId]});yield e.stores.message.bulkDelete(n.map(function(e){return e.pk}));var o=yield e.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:[r.threadId]});yield e.stores.tags.bulkDelete(o);var a=yield e.stores.deleted.readKeysByIndexRange("[threadId+deletedMessageId]",{only:[r.threadId]});yield e.stores.deleted.bulkDelete(a),yield e.stores.deleted.bulkAdd(n.map(function(e){return{deletedMessageId:e.messageId,deletionMessageId:r.messageId,deletionMessagePayload:r.payload,deletionTimestampMs:r.timestampMs,isLocalOnlyMessage:e.isLocalOnlyMessage,payload:e.payload,threadId:e.threadId,timestampMs:e.timestampMs}}))});return function(t){return e.apply(this,arguments)}})())}l.persistNewMessages=s}),98);
__d("WebMpsLoadDeletedMessages",["MpsTypes","Promise","WebReverbDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"],s;function u(e,t){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r){var a=o("WebReverbDB").getWebReverbDB(),i=yield a.runInTransaction(["deleted","supplemental"],"readonly",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(r){var a=yield r.stores.deleted.readIndexRange("[threadId+timestampMs+deletedMessageId]",{lessThanOrEqual:[t.threadId,o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER)]},{limit:t.numMessages});return(s||(s=n("Promise"))).all(a.map((function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=yield r.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[t.threadId,n.deletedMessageId]}),a=new Map;return o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,i=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e);a.set(r,l)}),{deletedEntity:n,supplementalProtobufs:a}});return function(e){return o.apply(this,arguments)}})()))});return function(e){return r.apply(this,arguments)}})(),"get-deleted-messages-for-spam-report"),l=i.map(function(e){if(e.deletedEntity.payload!=null){var n=e.deletedEntity.payload;if(e.deletedEntity.timestampMs!=null){var o=e.deletedEntity.timestampMs;return r([{otid:e.deletedEntity.deletedMessageId,supplementalProtobufs:new Map(e.supplementalProtobufs.entries().map(function(e){var t=e[0],n=e[1];return[t,{decryptedProtobuf:n.payload,protobufTimestampMS:n.timestampMs}]})),tags:[],toplevelProtobuf:{decryptedProtobuf:n,protobufTimestampMS:o}}],t.threadId)[0]}}}).filter(Boolean);return{messages:l,tombstones:new Set(i.map(function(e){return e.deletedEntity.deletionMessageId}))}}),c.apply(this,arguments)}l.loadDeletedMessages=u}),98);
__d("WebMpsPostprocess",["MpsLogger","Promise","asyncToGeneratorRuntime","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a){yield(e||(e=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(r){var i=r.process(t,a),l=i instanceof(e||(e=n("Promise")))?yield i.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):i;l!=null&&l.size>0&&l.forEach(function(e,t){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessor fails %s",t)})});return function(e){return r.apply(this,arguments)}})())).catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessors runtime failure")})}),u.apply(this,arguments)}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a){var i=new Map,l=function*(l){a.messageToQpl.all(t.map(function(e){return e.message.messageId})).addPoint(l.name+"_start");var r=l.process(t,a),s=r instanceof(e||(e=n("Promise")))?yield r.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):r;s!=null&&s.size>0&&s.forEach(function(e,t){i.set(t,e),o("MpsLogger").MpsLogger().catching(e).mustfix("Critical postprocessor fails %s",t),a.messageToQpl.endFail(t,l.name.toLowerCase()+"-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e))}),a.messageToQpl.all(t.map(function(e){return e.message.messageId})).addPoint(l.name+"_end")};for(var s of r)yield*l(s);return i}),d.apply(this,arguments)}l.runNonCriticalPostprocessor=s,l.runCriticalPostprocessor=c}),98);
__d("WebMpsPurgeDeletedPayload",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),r=yield t.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[n]}),a=r.filter(function(e){return e.payload!=null});return e.metric.addAnnotations({int:{num_deletions:a.length}}),yield t.stores.deleted.bulkPut(a.map(function(e){return babelHelpers.extends({},e,{payload:null,timestampMs:null})})),a.length});return function(e){return t.apply(this,arguments)}})(),"web-mps-purge-deletions")}function s(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted"],"readonly",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),n=yield e.stores.deleted.readIndexRange("deletionTimestampMs",{greaterThan:[t]},{order:"asc"}),r=n.filter(function(e){return e.payload!=null});if(!(r.length===0||r[0].deletionTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(r[0].deletionTimestampMs+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)});return function(t){return e.apply(this,arguments)}})(),"web-mps-next-deletion-timestamp-ms")}catch(e){throw e}}l.purgeDeletedPayload=e,l.getNextDeletionTimestampMs=s}),98);
__d("WebMpsPurgeDeletions",["MAWMpsCleanersContants","MpsTypes","Promise","WATimeUtils","WebReverbDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(r){var a=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").PURGE_DELETED_MESSAGES_WINDOW_IN_MS),i=yield r.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[a]}),l=i.map(function(e){return[e.threadId,e.deletedMessageId]});t.metric.addAnnotations({int:{num_deletions:i.length}});var s=(e||(e=n("Promise"))).all(l.map(function(e){return r.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return r.stores.supplemental.bulkDelete(e)}),u=e.all(l.map(function(e){return r.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return r.stores.tags.bulkDelete(e)}),c=r.stores.deleted.bulkDelete(i.map(function(e){return e.pk}));return yield e.all([s,u,c]),i.length});return function(e){return r.apply(this,arguments)}})(),"web-mps-purge-deletions")}l.purgeDeletions=s}),98);
__d("WebMpsScheduler",["WorkerScheduler","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){if(e==null){var t;e=o("WorkerScheduler").makeScheduler("MPS",{concurrency:(t=r("justknobx"))._("4338"),defaultSamplingRate:t._("4540"),maxTaskLimit:t._("4338"),maxThrottleMs:t._("4339"),timeoutMs:t._("4337")})}return e}l.mpsScheduler=s}),98);
__d("WmiMultiQplTracker",["QPLMultiplexedFlow"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map,s=(function(){function e(e){var t=this;this.$1=new Map,e.forEach(function(e){t.$1.set(e[0],e[1])})}e.from=function(n){return new e(n)};var t=e.prototype;return t.addAnnotations=function(t,n){var e;(e=this.$1.get(t))==null||e.addAnnotations(n)},t.addPoint=function(t,n,r){var e;(e=this.$1.get(t))==null||e.addPoint(n,r)},t.endSuccess=function(t){var e=this.$1.get(t);e!=null&&(e.endSuccess(),this.$1.delete(t),this.$2=null)},t.endFail=function(t,n,r){var e=this.$1.get(t);e!=null&&(e.endFail(n,{string:{errorDescription:r}}),this.$1.delete(t),this.$2=null)},t.size=function(){return this.$1.size},t.all=function(t){var e=this;if(t!=null){var n=t.map(function(t){return e.$1.get(t)}).filter(Boolean);return o("QPLMultiplexedFlow").makeQplMultiplexedFlow(n)}if(!this.$2){var r=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(Array.from(this.$1.values()));return this.$2=r,r}return this.$2},t.failAllPending=function(t){this.$1.forEach(function(e){return e.endFail(t)}),this.$1.clear(),this.$2=null},e.empty_TEST_ONLY=function(){return new e([])},e})();function u(t,n){e.set(t,n)}function c(t){return e.get(t)}l.WmiMultiQplTracker=s,l.trackQplForSeqId=u,l.getQplForSeqId=c}),98);
__d("schedulePeriodicTask",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";function e(e,t){var r=(function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{yield e()}finally{globalThis.setTimeout(r,t)}});return function(){return o.apply(this,arguments)}})();globalThis.setTimeout(r,0)}i.schedulePeriodicTask=e}),66);
__d("WebMps",["DateConsts","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsReverbDbDump","MpsReverbInit","MpsTypes","Promise","QPLFlow","WAPromiseQueue","WAResultOrError","WATimeUtils","WAWaitForUserUnblocked","WebMpsBatchLoadMessage","WebMpsBatchLoadMessages","WebMpsInsertionCleaners","WebMpsInsertionFlow","WebMpsLoadDeletedMessages","WebMpsPostprocess","WebMpsPurgeDeletedPayload","WebMpsPurgeDeletions","WebMpsPurgeExpiredMessages","WebMpsScheduler","WmiMultiQplTracker","WorkerScheduler","asyncToGeneratorRuntime","err","getErrorSafe","getSafeQplErrorMessage","justknobx","memoizeWithArgsLFUCache","mergeMaps","qpl","schedulePeriodicTask"],(function(t,n,r,o,a,i,l){"use strict";var e=["debug"],s=["config"],u=["debug"],c,d;function m(e){return JSON.stringify(e)}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.db,n=e.dependencies,a=e.getMpsExtensionConfiguration;if(d!=null)throw r("err")("MPS already initialised");yield o("MpsReverbInit").initReverb(t);var i=new f(a(),n);return d=i,i}),_.apply(this,arguments)}var f=(function(){function t(t,a){var i=this;this.$3=[],this.$6=new(o("WAPromiseQueue")).PromiseQueue,this.batchLoadMessage=function(e){var t,n,a,l,s=e.config,u=e.debug,c=e.messageIds,d=e.threadId,m={persistToReverb:(t=s==null?void 0:s.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=s==null?void 0:s.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(a=s==null?void 0:s.shouldFetchTags)!=null?a:!0,strategy:(l=s==null?void 0:s.strategy)!=null?l:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:u.purpose,strategy:m.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return i.$2.batchLoad({config:m,ctx:t,messageIds:c,threadId:d})},name:"batch-load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY}).then(function(e){return i.$10(e.filter(Boolean),m),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in batchLoadMessage"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$11=r("memoizeWithArgsLFUCache")(function(e){var t,a,l,s,u=e.config,c=e.debug,d=e.messageId,m=e.threadId,p={persistToReverb:(t=u==null?void 0:u.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(a=u==null?void 0:u.shouldFetchSupplementals)!=null?a:!0,shouldFetchTags:(l=u==null?void 0:u.shouldFetchTags)!=null?l:!0,strategy:(s=u==null?void 0:u.strategy)!=null?s:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:c.purpose,strategy:p.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4536"),fn:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield i.$2.load({config:p,ctx:e,messageId:d,threadId:m});return t!=null&&i.$10([t],p),t});function t(t){return e.apply(this,arguments)}return t})(),name:"load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY})},function(t){var n=t.debug,r=babelHelpers.objectWithoutPropertiesLoose(t,e);return m(babelHelpers.extends({},r,{ebEnabled:i.$1.eb.isEbEnabled()}))},1,function(e){i.$3.push(e)}),this.loadMessage=function(e){return i.$11(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){i.$7();var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in loadMessage"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$12=function(e){var t,n,a=e.config,l=e.debug,s=e.ranges;return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:l.purpose,strategy:(t=a==null?void 0:a.strategy)!=null?t:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages(s.map(function(e){var t=e.direction,n=e.from,r=e.numMessages,a=e.threadId;return{direction:t,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(n[0])),n[1]],numMessages:r,threadId:a}}),i.$1,a,t)},name:"batch-load-messages",priority:(n=a.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY})},this.batchLoadMessages=function(e){var t,n,a,l,u,c,d,m=e.config,p=babelHelpers.objectWithoutPropertiesLoose(e,s),_={persistToReverb:(t=m==null?void 0:m.persistToReverb)!=null?t:"persist",priority:(n=m==null?void 0:m.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY,shouldFetchSupplementals:(a=m==null?void 0:m.shouldFetchSupplementals)!=null?a:!0,shouldFetchTags:(l=m==null?void 0:m.shouldFetchTags)!=null?l:!0,shouldIgnoreLocalOnly:(u=m==null?void 0:m.shouldIgnoreLocalOnly)!=null?u:!1,strategy:(c=m==null?void 0:m.strategy)!=null?c:"full-fetch",tagsFilter:(d=m==null?void 0:m.tagsFilter)!=null?d:"all"};return i.$12(babelHelpers.extends({},p,{config:_})).then(function(e){var t=e.flatMap(function(e){return e.messages});return i.$10(t,_),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in batchLoadMessages"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$13=r("memoizeWithArgsLFUCache")(function(e){var t,n,a,l,s,u,c,d=e.config,m=e.debug,p=e.direction,_=e.from,f=e.numMessages,g=e.source,h=e.threadId,y={persistToReverb:(t=d==null?void 0:d.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=d==null?void 0:d.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(a=d==null?void 0:d.shouldFetchTags)!=null?a:!0,shouldIgnoreLocalOnly:(l=d==null?void 0:d.shouldIgnoreLocalOnly)!=null?l:!1,source:g,strategy:(s=d==null?void 0:d.strategy)!=null?s:"full-fetch",tagsFilter:(u=d==null?void 0:d.tagsFilter)!=null?u:"all"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:m.purpose,strategy:y.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages([{direction:p,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(_[0])),_[1]],numMessages:f,threadId:h}],i.$1,y,t).then(function(e){e.length>1&&o("MpsLogger").MpsLogger().mustfix("loadMessages returned more than one range");var t=e.at(0);if(t==null)throw r("err")("loadMessages returned no result. Likely this is the result of both reverb and EB queries failing");return i.$10(t.messages,y),t})},name:"load-messages",priority:(c=d==null?void 0:d.priority)!=null?c:o("WorkerScheduler").BLOCKING_PRIORITY})},function(e){var t,n=e.debug,r=babelHelpers.objectWithoutPropertiesLoose(e,u);return m(babelHelpers.extends({},r,{config:babelHelpers.extends({},r.config,{tagsFilter:(function(e){if(e==="all"||e===void 0)return"all";{var t=e;return Array.from(t.values())}})((t=r.config)==null?void 0:t.tagsFilter)}),ebEnabled:i.$1.eb.isEbEnabled()}))},10/60,function(e){i.$3.push(e)}),this.loadMessages=function(e){return i.$13(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){i.$7();var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in loadMessages"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.extensionConfiguration=t,this.$1=a,this.$2=new(o("WebMpsBatchLoadMessage")).WebMpsPointQueryApi(a),this.$4(),this.$5(function(e){return a.generateDeletionMessage(e)})}var a=t.prototype;return a.saveNewMessages=function(t,a){var e=this,i=o("WebMpsScheduler").mpsScheduler().task({annotations:{string:{source:a.source}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4535"),fn:(function(){var a=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){e.$7();var n={messageToQpl:o("WmiMultiQplTracker").WmiMultiQplTracker.from(t.map(function(e){return[e.message.messageId,o("QPLFlow").startQPLFlow(r("qpl")._(1056834650,"494"),{annotations:{string:{messageId:e.message.messageId,senderId:e.message.senderId,threadId:e.message.threadId}}})]}))};n.messageToQpl.all(t.map(function(e){return e.message.messageId})).addPoint("preprocess_start");var a=yield e.extensionConfiguration.preprocessors.run({ctx:n,payloadList:t}),i=a.errors,l=a.payloadList;n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("preprocess_end"),i.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"preprocess-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_start"),yield o("WebMpsInsertionCleaners").scheduleCleaners(l),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_end"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_start");var s=yield o("WebMpsInsertionFlow").persistNewMessages(l);n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_end"),s.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"persist-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persisted"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_start");var u=yield e.$8(l,n);return n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_end"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_start"),e.$9(l,n),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_end"),l.forEach(function(e){n.messageToQpl.endSuccess(e.message.messageId)}),r("mergeMaps")(i,s,u)});function i(){return a.apply(this,arguments)}return i})(),name:"save-new-messages",priority:o("WorkerScheduler").BLOCKING_PRIORITY});return this.$6.enqueue(function(){return i.run()})},a.$9=function(t,n){o("WebMpsPostprocess").runNonCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.nonCritical,n).catch(function(e){var t=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(t).mustfix("Non-critical postprocessor failed with runtime error")})},a.$8=function(t,n){return o("WebMpsPostprocess").runCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.critical,n).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Critical postprocessor failed with runtime error"),new Map})},a.purgeDeletions=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{return yield o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletions").purgeDeletions,name:"purge-deletions",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletions"),0}});function t(){return e.apply(this,arguments)}return t})(),a.purgeDeletedPayload=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{return yield o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").purgeDeletedPayload,name:"purge-deleted-payload",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletedPayload"),0}});function t(){return e.apply(this,arguments)}return t})(),a.getNextDeletionTimestampMs=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{return yield o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").getNextDeletionTimestampMs,name:"get-next-deletion-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextDeletionTimestampMs")}});function t(){return e.apply(this,arguments)}return t})(),a.purgeExpiredMessages=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{return yield o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:function(n){return o("WebMpsPurgeExpiredMessages").purgeExpiredMessages(e,n)},name:"purge-expired-messages",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeExpiredMessages"),0}});function t(t){return e.apply(this,arguments)}return t})(),a.getNextExpiryTimestampMs=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{return yield o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:o("WebMpsPurgeExpiredMessages").getNextExpiryTimestampMs,name:"get-next-expire-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextExpiryTimestampMs")}});function t(){return e.apply(this,arguments)}return t})(),a.debugDbDump=function(){return o("MpsReverbDbDump").debugGetReverbDbDump()},a.spamReportLoadMessages=function(t){var e=this;return o("WebMpsScheduler").mpsScheduler().runTask({fn:(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var r=yield(c||(c=n("Promise"))).all([e.$13({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!0,shouldFetchTags:!1,shouldIgnoreLocalOnly:!1,strategy:"local-only",tagsFilter:"all"},debug:{purpose:"get-latest-msgs-for-spam-report"},direction:"desc",from:[o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),null],numMessages:t.numMessages,threadId:t.threadId}),o("WebMpsLoadDeletedMessages").loadDeletedMessages(t,e.$1.decryptedProtobufToFullMessage)]),a=r[0],i=r[1],l=a.messages.filter(function(e){return!i.tombstones.has(e.toplevelProtobuf.messageId)});return[].concat(l,i.messages).toSorted(function(e,t){return t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}).slice(0,t.numMessages)});function a(){return r.apply(this,arguments)}return a})(),name:"get-latest-msgs-for-spam-report"})},a.$7=function(){this.$3.forEach(function(e){return e()})},a.$10=function(t,n){var e=this.extensionConfiguration.readSideEffects;if(!(e==null||t.length===0))try{e(t,n)}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("readSideEffects failed")}},a.$4=function(){var e=this;o("schedulePeriodicTask").schedulePeriodicTask(function(){return e.purgeDeletions()},o("DateConsts").MS_PER_MIN*20)},a.$5=function(t){var e=this;o("MpsEphemeralCleaner").startMpsEphemeralCleaner({getNextTs:function(){return e.getNextExpiryTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeExpiredMessages(t)}}),o("MpsDeletedCleaner").startMpsDeletedCleaner({getNextTs:function(){return e.getNextDeletionTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeDeletedPayload()}})},t})();function g(){if(d==null)throw r("err")("MPS not initialised");return d}function h(){d=void 0}l.makeMps=p,l.mps=g,l.resetMps_TEST_ONLY=h}),98);
__d("WebMpsPurgeExpiredMessages",["MpsTypes","WATimeUtils","WebMps","WebReverbDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk","timestampMs"];function s(e,t){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r){var a=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),i=yield o("WebReverbDB").getWebReverbDB().runInTransaction(["message","deleted"],"readonly",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield e.stores.message.readIndexRange("expiryTimestampMs",{lessThanOrEqual:[a]});return r.metric.addAnnotations({int:{num_expired_messages:t.length}}),t});return function(t){return e.apply(this,arguments)}})(),"web-mps-purge-deletions");if(i.length===0)return 0;var l=i.map(function(n){var r=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=n.timestampMs,d=babelHelpers.objectWithoutPropertiesLoose(n,e);return{directive:null,insertionSource:o("MpsTypes").InsertionSource.Send,message:t(babelHelpers.extends({},d,{timestampMs:a}))}});return yield o("WebMps").mps().saveNewMessages(l,{source:"purge-expired-messages"}),i.length}),u.apply(this,arguments)}function c(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["message"],"readonly",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),n=yield e.stores.message.readIndexRange("expiryTimestampMs",{greaterThan:[t]},{limit:1,order:"asc"});if(!(n.length===0||n[0].expiryTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(n[0].expiryTimestampMs)});return function(t){return e.apply(this,arguments)}})(),"web-mps-next-expiry-timestamp-ms")}catch(e){throw e}}l.purgeExpiredMessages=s,l.getNextExpiryTimestampMs=c}),98);
__d("MAWBridgeEventTransmitter",["EBAPI","EBLogger","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWJobDefinitions","MAWUploadThreadTxns","MpsTypes","WAJids","WALogger","WATimeUtils","WebMps"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n,a){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Issuing point query for message: ",""])),t),r("EBAPI").isEBEnabled()!==!1&&o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"full-fetch"},debug:{purpose:"issuePointQueryOutsideTxn"},messageId:o("MpsTypes").toMessageId(t),threadId:o("MpsTypes").toThreadId(a)}).then(function(e){var t=e.value;t!=null&&o("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:a,decryptedMessagesProtobufs:[o("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage(t)],isPointQuery:!0,taskSource:(s||(s=o("LSIntEnum"))).ofNumber(n!=null?n:r("LSMEBTaskCreationSource").UNKNOWN)}}]}).catch(function(e){return o("EBLogger").EBLogger().tags(["eventTransmitter","mps"]).catching(e).warn("failure while executing UI update")})})}function c(e,t){o("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:o("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(o("WAJids").threadIdForChatJid(e.jid),o("MAWUploadThreadTxns").getFolderTypeAsText(e.folder),"AdvancedCrypto",t!=null?t:o("WATimeUtils").castToMillisTime(1),null,2)})}function d(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(e,t,n)}]})}function m(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e,folder:t,threadJid:n})}]})}l.issuePointQueryOutsideTxn=u,l.deleteMessagesOfThreadAfterTxn=c,l.startTraceOutsideTxn=d,l.updateThreadOutsideTxn=m}),98);
__d("MAWQuotedMsgUtils",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.content.type==="NoteReply"?e.content.msgContent==null?e:babelHelpers.extends({},e,{content:babelHelpers.extends({},e.content,{msgContent:void 0})}):e}function s(t){return t.content.expirationTs==null||t.content.expirationTs>o("WATimeUtils").unixTime()?t:e(t)}l.dbQuotedMsgWithoutExpirableContent=e,l.dbQuotedMsgWithoutExpiredContent=s}),98);
__d("MAWGetMsgQuoteTxn",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWQuotedMsgUtils","MAWTransactionMode","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return t==null||t===o("WAJids").AUTHOR_SYSTEM?null:o("WAJids").authorAsUserJid(t)};function s(t,n,a,i){var l=n.quote,s=(l==null?void 0:l.content)||{},u=s.author,c=s.externalId;if(u==null)return o("MAWDexieTable").dexieResolve(null);var d=o("WAJids").isAuthorMe(u)?o("WAJids").AUTHOR_ME:e(u);if(l==null||d==null||c==null)return o("MAWDexieTable").dexieResolve(null);var m={author:d,chat:a,externalId:c};if(l.content.type==="NoteReply")return o("MAWDexieTable").dexieResolve({quote:o("MAWQuotedMsgUtils").dbQuotedMsgWithoutExpiredContent(l),quoteExternalId:l.content.externalId});var p=i!=null&&i==="ebrestore"?r("LSMEBTaskCreationSource").EB_POINT_QUERY_RESTORE_PROTOBUF:r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT;return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,m).then(function(e){if(o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(m.externalId,p,m.chat),e==null||!o("MAWMsgType").isQuotedMsgType(e.type))return{quote:l,quoteExternalId:l.content.externalId};o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(e,null,!0)});var t=e.author,n=e.externalId,r=e.mediaId,a=e.msgContent,i=e.msgId,s=e.plaintextHash,u=e.specialTextSize,c=e.ts,d=e.type,_=e.xmaMessageType,f={author:t,externalId:n,mediaId:r,msgContent:a,msgId:i,plaintextHash:s,specialTextSize:u,ts:c,type:d,xmaMessageType:_};return e.messageExpirationTs!=null&&e.messageExpirationTs<o("WATimeUtils").unixTime()&&(f=babelHelpers.extends({},f,{mediaId:void 0,msgContent:void 0,type:o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})),{quote:babelHelpers.extends({},l,{content:f}),quoteExternalId:e.externalId}})}function u(e,t,n){return s(e,t,n).then(function(e){return babelHelpers.extends({},t,{quote:e==null?void 0:e.quote,quoteExpirationTs:e==null?void 0:e.quote.content.expirationTs,quoteExternalId:e==null?void 0:e.quoteExternalId})})}function c(e,t){return e.messages.where("quoteExternalId").anyOf(t).toArray()}var d=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"maybeBatchGetMsgsByQuoteExternalId",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return c.apply(void 0,[e].concat(n))})});l.getMsgQuoteInfo=s,l.enhanceMsgWithQuoteInfo=u,l.maybeBatchGetMsgsByQuoteExternalId=c,l.maybeBatchGetMsgsByQuoteExternalIdWithTransaction=d}),98);
__d("MAWDexieCastToPromise",["Promise","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return(e||(e=n("Promise"))).resolve(t)}function u(e){return r("vulture")("Fs7u2qpGsgGUHBjaeXKvgOwLL5I="),e}l.dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING=s,l.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=u}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=!1;return e!=null&&t.defaultPreviewMediaId===e.mediaId&&(n=yield f(e)),o("MAWBridgeXMA").createBridgeXMA(e,t,{hasMedia:n,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}),s.apply(this,arguments)}function u(e,t,n){return c(e,t,n).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function c(e,t,n){var r=n==null?o("MAWDexieTable").dexieResolve(!1):o("MAWDbChunkTxns").hasMediaChunk(e,n.hashedPlaintextHash);return r.then(function(e){return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:e,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})}function d(e,t,n,r,a){return m(e,t,n,r,a).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function m(e,t,n,r,a){var i=p(n,r,a,e);return i.then(function(e){var r=e.hasMedia,a=e.hasXmaFaviconMedia,i=e.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:r,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})})}function p(e,t,n,r){if(e!=null||t!=null||n!=null){var a=[e,t,n].filter(Boolean).map(function(e){return e.hashedPlaintextHash});return o("MAWDbChunkTxns").hasMediaChunks(r,a).then(function(r){return{hasMedia:e!=null&&r.get(e.hashedPlaintextHash)===!0,hasXmaFaviconMedia:t!=null&&r.get(t.hashedPlaintextHash)===!0,hasXmaHeaderMedia:n!=null&&r.get(n.hashedPlaintextHash)===!0}})}else return o("MAWDexieTable").dexieResolve({hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function _(e,t,n,r,a){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(p(e,t,n,a).then(function(t){var n=t.hasMedia,a=t.hasXmaFaviconMedia,i=t.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(e,r,{hasMedia:n,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})}))}var f=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(e){return(function(t){return o("MAWDbChunkTxns").hasMediaChunk(e,t.hashedPlaintextHash)})});l.checkMediaChunkTransactionAndCreatedBridgeXma=e,l.checkMediaChunkAndHandleXmaAfterTransaction=u,l.checkMediaChunkAndCreatedBridgeXma=c,l.checkAllMediaChunksAndHandleXmaAfterTransaction=d,l.checkAllMediaChunksAndCreateBridgeXma=m,l.verifyAllMediaChunksForXMA=p,l.checkAllMediaChunksAndCreateBridgeXma_DEPRECATED=_}),98);
__d("MAWLegacyDownloadManager",[],(function(t,n,r,o,a,i){"use strict";var e=1e4,l=(function(){function t(){this.$1=[],this.$2=new Map}var n=t.prototype;return n.setToDownloadManager=function(t,n){this.$3(),this.$2.set(t,n),this.$1.push(t)},n.getFromDownloadManager=function(t){return this.$2.get(t)},n.removeFromMediaDownloadManager=function(t){this.$2.delete(t);var e=this.$1.filter(function(e){return e!==t});this.setDownloadManagerQueue(e)},n.setDownloadManagerQueue=function(t){this.$1=t},n.$3=function(){if(this.$1.length>=e){var t=this.$1.shift();this.$2.delete(t)}},t})();i.LegacyDownloadManager=l}),66);
__d("MAWLegacyMediaDownloadManager",["MAWLegacyDownloadManager"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager,s=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager;function u(t,n){e.setToDownloadManager(t,n)}function c(t){return e.getFromDownloadManager(t)}function d(t){e.removeFromMediaDownloadManager(t)}function m(e,t){s.setToDownloadManager(e,t)}function p(e){return s.getFromDownloadManager(e)}function _(e){s.removeFromMediaDownloadManager(e)}l.setToMediaDownloadManager=u,l.getFromMediaDownloadManager=c,l.removeFromMediaDownloadManager=d,l.setToMediaPlaintextDownloadManager=m,l.getFromMediaPlaintextDownloadManager=p,l.removeFromMediaPlaintextDownloadManager=_}),98);
__d("MAWMediaType",["WAServerMediaType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"XMA":return"xma-image";case"EphemeralScreenshotAction":case"Raven":case"RavenAction":case"EditAction":case"NoteReply":case"BumpExistingMessage":return null;default:return o("WAServerMediaType").getMediaType(e)}}l.getMediaType=e}),98);
__d("MpsMediaEntryCache",["FBLogger","MpsMessageToBridgeWrapper","WADirectPath","WAHashUtils","WALongInt","WAMediaUtils","WAProgressiveJpegGetScanLengths","WATimeUtils","getErrorSafe","getMediaTypeFromConsumerMessage","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t){var n,r,o=e.get(t.plaintextHash);if(((n=t.mediaKeyTimestamp)!=null?n:0)>=((r=o==null?void 0:o.mediaKeyTimestamp)!=null?r:0))return e.set(t.plaintextHash,t),t}function u(e){try{var t=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(e);return[c(t),p(t)].concat(m(t)).filter(Boolean)}catch(e){var n=r("getErrorSafe")(e);if(n.message.includes("FormatError"))return r("FBLogger")("mps").catching(n).warn("Error in hydrateCache"),[];throw r("FBLogger")("mps").catching(n).mustfixThrow("Error in hydrateCache")}}function c(e){var t,n=e.deserialize(),r=(t=n.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(r!=null)return d(e,r)}function d(e,t){var n,r,a,i,l,s,u,c,d,m=(n=(r=(a=(i=(l=t.audioMessage())==null?void 0:l.payload)!=null?i:(s=t.documentMessage())==null?void 0:s.payload)!=null?a:(u=t.imageMessage())==null?void 0:u.payload)!=null?r:(c=t.stickerMessage())==null?void 0:c.payload)!=null?n:(d=t.videoMessage())==null?void 0:d.payload;if(m!=null){var p=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(t.proto);return _(m,p,e)}}function m(e){var t,n,r=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),o=r==null?void 0:r.extendedContentMessage();if(o==null||r==null)return[];var a="xma-image",i=o.previews().map(function(t){return _(t,a,e)}),l=o.headerImage();l!=null&&i.push(_(l,a,e));var s=o.favicon();s!=null&&i.push(_(s,a,e));var u=(n=o.associatedMessage())==null?void 0:n.consumerMessage();return u!=null&&i.push(d(e,u)),i.filter(Boolean)}function p(e){var t,n=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),a=n==null?void 0:n.noteReply(),i=a==null?void 0:a.stickerContent(),l=a==null?void 0:a.videoContent(),s=i!=null?i:l;if(s!=null){var u=l!=null?o("getMediaTypeFromConsumerMessage").getMediaTypeForVideo(l):void 0,c=i!=null?"sticker":void 0,d=r("nullthrows")(u!=null?u:c);return _(s,d,e)}}function _(e,t,n){var a,i,l,u,c,d,m,p,_,f,g,h,y,C=e.ancillary,b=e.integral;if(C==null||b==null){var v=Object.entries({ancillary:C,integral:b}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("invalid media entry, missing %s. type %s",v,t);return}var S=o("WADirectPath").validateDirectPath((a=b.transport)==null||(a=a.integral)==null?void 0:a.directPath).value,R=(i=b.transport)==null||(i=i.integral)==null?void 0:i.mediaKeyTimestamp,L=R!=null?o("WATimeUtils").castLongIntToUnixTime(R):void 0,E=(l=b.transport)==null||(l=l.integral)==null?void 0:l.fileSha256,k=E!=null?o("WAHashUtils").toPlaintextHash(E):void 0;if(S==null||E==null||k==null||t==null){var I=Object.entries({directPath:S,fileSha256:E,mediaType:t,plaintextHash:k}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("Missing media entry fields: %s. type :%s",I,t);return}var T=null,D=C.scanLengths,x=C.scansSidecar;x!=null&&D!=null&&(T={scanLengths:D.map(o("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength),sidecar:x});var $=void 0,P=(u=b.transport)==null||(u=u.ancillary)==null||(u=u.thumbnail)==null?void 0:u.downloadableThumbnail;if(P!=null){var N;$={directPath:o("WADirectPath").validateDirectPath(P.directPath).value,fileEncSha256:P.fileEncSha256,fileSha256:P.fileSha256,mediaKey:P.mediaKey==null?void 0:o("WAMediaUtils").castToMediaKey(P.mediaKey),mediaKeyTimestamp:o("WATimeUtils").castLongIntToUnixTime((N=P.mediaKeyTimestamp)!=null?N:0),objectId:P.objectId==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(P.objectId)}}var M={directPath:S,downloadableThumbnail:$,fileEncSha256:(c=b.transport)==null||(c=c.integral)==null?void 0:c.fileEncSha256,filename:null,fileSha256:E,mediaKey:((d=b.transport)==null||(d=d.integral)==null?void 0:d.mediaKey)==null?void 0:o("WAMediaUtils").castToMediaKey((m=b.transport)==null||(m=m.integral)==null?void 0:m.mediaKey),mediaKeyTimestamp:L,objectId:(b==null||(p=b.transport)==null||(p=p.ancillary)==null?void 0:p.objectId)==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(b==null||(_=b.transport)==null||(_=_.ancillary)==null?void 0:_.objectId),progressiveJpegDetails:T,serverMediaType:t,size:o("WALongInt").numberOrThrowIfTooLarge((f=b==null||(g=b.transport)==null||(g=g.ancillary)==null?void 0:g.fileLength)!=null?f:0),uploadToken:void 0},w=o("WAMediaUtils").encodeMediaEntryWithUpdatedPath(M,S);return s({decodedMediaEntry:M,mediaEntry:w,mediaKeyTimestamp:L,message:{messageId:n.message.messageId,threadId:n.message.threadId},plaintextHash:k,serverMediaType:t,thumbnailHash:((h=$)==null?void 0:h.fileSha256)!=null?o("WAHashUtils").toPlaintextHash((y=$)==null?void 0:y.fileSha256):void 0})}function f(t){return e.get(t)}function g(){e.clear()}l.storeEntry=s,l.hydrateCache=u,l.getEntry=f,l.clear__TEST_ONLY=g}),98);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieTable","MAWIndexedDb","MAWMediaType","MAWMediaUtils","MAWMpsGating","MAWRavenUtils","MpsMediaEntryCache","MpsTypes","WAHashUtils","WAMediaUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a,i,l,u){return a.messages.where("msgId").anyOf(t.msgIds).toArray().then(function(c){var d=e.threadJid,m=o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(c,d),p=o("MAWMediaUtils").createHdTypesForBridgeMedia(c),_=e.ravenEphemeralType!=null&&e.ravenEphemeralMediaState!=null?o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,ravenSettings:o("MAWRavenUtils").deriveRavenSettings(e.ravenEphemeralType,e.ravenEphemeralMediaState),sortOrderMs:e.sortOrderMs,transportKey:l}):o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,sortOrderMs:e.sortOrderMs,transportKey:l});if(o("MAWMpsGating").isMpsMessageRendering()&&u===!0){var f,g,h,y=r("nullthrows")(t.mediaEntries.get(e.msgId)),C=o("WAMediaUtils").decodeMediaEntryData(y),b=(f=(g=t.validatedImageInfo)==null?void 0:g.thumbnailPlaintextHash)!=null?f:(h=t.validatedVideoInfo)==null?void 0:h.thumbnailPlaintextHash;if(b==null){var v=C.downloadableThumbnail;(v==null?void 0:v.fileSha256)!=null&&(b=o("WAHashUtils").toPlaintextHash(v.fileSha256))}o("MpsMediaEntryCache").storeEntry({decodedMediaEntry:C,mediaEntry:y,mediaKeyTimestamp:t.ts,message:{messageId:o("MpsTypes").toMessageId(e.externalId),threadId:o("MpsTypes").toThreadId(e.threadJid)},plaintextHash:t.plaintextHash,serverMediaType:r("nullthrows")(o("MAWMediaType").getMediaType(t.mediaType)),thumbnailHash:b})}return s(a,babelHelpers.extends({},_,{skipShouldUpdateHasMore:i}),void 0,u)})}function s(e,t,n,r){return u(t)?o("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(e,t,n).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e},r)}):(o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:t},r),o("MAWDexieTable").dexieResolve())}function u(e){if(e.ephemeralMediaState!=null||e.ephemeralMediaViewMode!=null)return!1;switch(e.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:case o("MAWDbMedia").MEDIA_TYPE.VIDEO:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}l.handleNewMediaAfterTxn=e,l.handleNewMediaAfterTxnWithBridgeMedia=s}),98);
__d("MAWVideoAudioValidationUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return{audioAvgBitsPerSecond:e.audioAvgBitsPerSecond!=null?Math.round(e.audioAvgBitsPerSecond):null,audioNumberOfChannels:e.audioNumberOfChannels!=null?Math.round(e.audioNumberOfChannels):null,audioSamplingRate:e.audioSamplingRate!=null?Math.round(e.audioSamplingRate):null,audioStreamType:e.audioStreamType,validatedMimeType:e.validatedMimeType,videoAvgBitsPerSecond:e.videoAvgBitsPerSecond!=null?Math.round(e.videoAvgBitsPerSecond):null,videoCalculatedFps:e.videoCalculatedFps!=null?Math.round(e.videoCalculatedFps):null,videoDuration:e.videoDuration!=null?Math.round(e.videoDuration):null,videoHeight:e.videoHeight!=null?Math.round(e.videoHeight):null,videoNominalFps:e.videoNominalFps!=null?Math.round(e.videoNominalFps):null,videoStreamType:e.videoStreamType,videoWidth:e.videoWidth!=null?Math.round(e.videoWidth):null}}i.normalizeValidationResult=e}),66);
__d("MAWHandleMediaDownloadApi",["MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLegacyMediaDownloadManager","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaUtils","MAWMpsGating","MAWMsgType","MAWTransactionMode","MAWVideoAudioValidationUtils","MAWXMAUtils","MWFBLogger","MpsMediaEntryCache","Promise","WAArmadilloXMA.pb","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function p(t,r,a,i,l,c){m.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start persisting media blob"])));var p=t.db,_=o("MAWMediaUtils").genHMACPlaintextHash(r),f=t.persistChunk?o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(t.db,r,i,a):null;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(p,l),p.media.where("hashedPlaintextHash").equals(_).first(),f]).then(function(e){var t=e[0],l=e[1],_=e[2];if(l==null)return m.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"]))),o("WAResultOrError").makeError("missing-media-on-save");var f,g=!1;return f=o("MAWLegacyMediaDownloadManager").getFromMediaPlaintextDownloadManager(r),f==null&&(f=o("MAWLegacyMediaDownloadManager").getFromMediaDownloadManager(l.mediaId),g=!0),f!=null&&(m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["resolve MediaPlaintextDownloadManager promise"]))),f((d||(d=n("Promise"))).resolve(new Blob([i],{type:a}))),o("MAWLegacyMediaDownloadManager").removeFromMediaPlaintextDownloadManager(r),g&&o("MAWLegacyMediaDownloadManager").removeFromMediaDownloadManager(l.mediaId)),h(p,t).then(function(e){return e?p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return o("MAWDbXMATxns").getXMAFromMsgs(p,e).then(function(e){return o("MAWDexieTable").dexieAll(e.map(function(e){if(!o("MAWXMAUtils").isXMAStoryReply(e.targetType)&&e.defaultPreviewMediaId===l.mediaId)return o("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(p,e,l)}))}).then(function(){return e})}).then(function(e){return y(p,e)}):p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return p.threads.where("jid").anyOf(e.map(function(e){return e.threadJid})).toArray().then(function(n){return o("MAWDexieTable").dexieAll(n.map(function(n){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(e),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.jid,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(e,n.jid),hasMediaForUI:!0,hdTypes:r,media:l,sortOrderMs:t==null?void 0:t.sortOrderMs});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(p,a,e)}))}).then(function(){return e})}).then(function(e){return y(p,e)})}).then(function(){var e,t,n,r,a,s,u,d,m,_,f,g=l.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO?o("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:c==null||(e=c.audioStreamReport)==null?void 0:e.avgBitsPerSecond,audioNumberOfChannels:c==null||(t=c.audioStreamReport)==null?void 0:t.numberOfChannels,audioSamplingRate:c==null||(n=c.audioStreamReport)==null?void 0:n.samplingRate,audioStreamType:c==null||(r=c.audioStreamReport)==null?void 0:r.streamType,validatedMimeType:c==null?void 0:c.mimeType,videoAvgBitsPerSecond:c==null||(a=c.videoStreamReport)==null?void 0:a.avgBitsPerSecond,videoCalculatedFps:c==null||(s=c.videoStreamReport)==null?void 0:s.calculatedFps,videoDuration:c==null||(u=c.videoStreamReport)==null?void 0:u.duration,videoHeight:c==null||(d=c.videoStreamReport)==null?void 0:d.videoHeight,videoNominalFps:c==null||(m=c.videoStreamReport)==null?void 0:m.nominalFps,videoStreamType:c==null||(_=c.videoStreamReport)==null?void 0:_.streamType,videoWidth:c==null||(f=c.videoStreamReport)==null?void 0:f.videoWidth}):void 0,h=o("MAWDbMediaTxns").updateMedia(p,l,{size:i.byteLength,validatedResult:g});return h}).then(function(){return o("WAResultOrError").makeResult()})})}var _=o("MAWIndexedDb").makeMsgrTransactor({chunk:(c=o("MAWTransactionMode")).READWRITE,media:c.READWRITE,messages:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READONLY,xma:c.READONLY},"handleMediaDownload",function(e){return(function(t,n,r,o,a){return p({db:e,persistChunk:!0},t,n,r,o,a)})}),f=o("MAWIndexedDb").makeMsgrTransactor({chunk:c.READONLY,media:c.READWRITE,messages:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READONLY,xma:c.READONLY},"handleMediaDownloadWithoutPersistChunk",function(e){return(function(t,n,r,o,a){return p({db:e,persistChunk:!1},t,n,r,o,a)})}),g=function(){var e=o("MpsMediaEntryCache").getEntry(arguments.length<=0?void 0:arguments[0])!=null&&o("MAWMpsGating").isMpsMediaGalleryEnabled();return o("MAWMpsGating").isMpsMessageRendering()||e?f.apply(void 0,arguments):_.apply(void 0,arguments)};function h(e,t){var n;return t==null?o("MAWDexieTable").dexieResolve(!1):t.type===o("MAWMsgType").MSG_TYPE.XMA?o("MAWDexieTable").dexieResolve(!0):((n=t.quote)==null?void 0:n.content.xmaMessageType)===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?o("MAWDexieTable").dexieResolve(t.type===o("MAWMsgType").MSG_TYPE.TEXT):o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(e){return e!=null})}function y(e,t){return o("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalId(e,t.map(function(e){return e.externalId})).then(function(t){return t.map(function(t){return t.source="eb_restore",o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})})}l.handleMediaDownload=g}),98);
__d("MAWJobsIndexedDb",["FBLogger","MAWCurrentUser","MAWErrorObject","MAWIndexedDbMetadata","MAWQplProxy","MAWTransactionMode","Promise","WAExceededStorageQuota","WALogger","WAWorkerGlobalScope","emptyFunction","promiseDone","qex","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null,c=null,d="jobs";function m(){return r("qex")._("940")}function p(){if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return u}function _(){if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return c.then(function(){return p()})}function f(){return u!=null}var g=[function(e){var t=e.target.result,n=t.createObjectStore(d,{autoIncrement:!0,keyPath:"jobId"});n.createIndex("uniqKey","uniqKey")},r("emptyFunction"),r("emptyFunction")];function h(e){return c=null,u=null,y(e).then(function(){return u.version})}function y(t){var a;if(c!=null)return c;if(u!=null)return(s||(s=n("Promise"))).resolve();var i=o("MAWCurrentUser").getID(),l=o("MAWIndexedDbMetadata").jobsDbName(i),d=(a=t!=null?t:m())!=null?a:g.length,p=r("qpl")._(25310776,"6155");return c=new(s||(s=n("Promise")))(function(t,n){var r=indexedDB.open(l,d);r.onupgradeneeded=function(e){for(var t=0;t<g.length;t++){var n=g[t],r=t+1;C(e,r)&&n(e)}},r.onsuccess=function(n){var r=n.target.result;r.onversionchange=function(){var t;o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_versionchange"),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[JobsDb initialization] upgradeneeded is triggered in another worker. This should not happen."]))),r.close(),(t=o("WAWorkerGlobalScope").workerGlobalScope.location)==null||t.reload==null||t.reload()},u=r,o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_ready"),t()},r.onerror=function(){o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_failed"),n(r.error)}}),c}function C(e,t){var n=e.newVersion,r=e.oldVersion;return r<t&&n>=t}function b(e){return e===o("MAWTransactionMode").READWRITE?"readwrite":"readonly"}function v(e,t,n,a){var i=b(t);return function(t){return function(){for(var l=arguments.length,s=new Array(l),d=0;d<l;d++)s[d]=arguments[d];var m=a!=null?o("MAWQplProxy").startQplUserFlow(a):null,p=function(l){return _().then(function(n){var r=function(r){var t=n.transaction(e,r!=null?b(r):i,{durability:"relaxed"});return o("WAExceededStorageQuota").listenToQuotaExceededError(t),t.objectStore(e)};return t.apply(void 0,[r].concat(s))}).then(function(e){return m==null||m.endSuccess(),e}).catch(function(t){m==null||m.endFail("job_transaction_fail");var a=o("MAWErrorObject").getErrorObject(t);if((a==null?void 0:a.name)==="InvalidStateError"&&l===1)return c=null,u=null,r("promiseDone")(y()),p(l-1);throw a instanceof Error?r("FBLogger")("maw_db").catching(a).mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e):r("FBLogger")("maw_db").mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e)})};return p(1)}}}l.getJobsDbVersion=m,l.getJobDB=p,l.isJobDBInitted=f,l.dbMigrations=g,l.makeJobsDbIgnoringPreviousCreations=h,l.makeJobsDb=y,l.makeJobsTransactor=v}),98);
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t,n;return{deletePersistedJob:(e=o("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(t=o("MAWTransactionMode")).READWRITE,"deletePersistedJob")((n=o("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:e.makeJobsTransactor("jobs",t.READONLY,"loadAllJobs")(n.readAllPersistedJobs),maybeCreateJob:e.makeJobsTransactor("jobs",t.READWRITE,"maybeCreateJob")(n.maybeCreateJob),readPersistedJob:e.makeJobsTransactor("jobs",t.READONLY,"readPersistedJob")(n.readPersistedJob),updatePersistedJob:e.makeJobsTransactor("jobs",t.READWRITE,"updatePersistedJob")(n.updatePersistedJob)}}l.getJobPersistenceAccessors=e}),98);
__d("WAJobRequirement",["Promise","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t=this;this.$1=(s||(s=n("Promise"))).resolve(),this.$2=!0,this.$3=null,this.$4=function(){var e=t.$3;if(e!=null)return t.$3=null,(s||(s=n("Promise"))).all(e).then(t.$4);t.$2=!0},this.name=e}var r=t.prototype;return r.addBlocker=function(r){var t=this,a=r.catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["JobRequirement[","] blocker errored ",""])),t.name,n).sendLogs("job-blocker-rejected")});if(this.$2)this.$2=!1,this.$1=(s||(s=n("Promise"))).all([this.$1,a]).then(this.$4);else{var i=this.$3;i!=null?i.push(a):this.$3=[a]}},r.waitUntilSatisfied=function(){return this.$1},r.isSatisfied=function(){return this.$2},r.isSatisfiable=function(){return!0},t})(),c=(function(e){function t(t){var r;return r=e.call(this,t)||this,e.prototype.addBlocker.call(r,new(s||(s=n("Promise")))(function(){})),r}babelHelpers.inheritsLoose(t,e);var r=t.prototype;return r.addBlocker=function(){},r.isSatisfiable=function(){return!1},t})(u);function d(e,t){var r=e.filter(function(e){return!e.isSatisfiable()});if(r.length>0){var o=r.map(function(e){return e.name});return function(e){return t==null||t("unsatisfiable",o,e),r[0].waitUntilSatisfied()}}var a=e.map(function(){return(s||(s=n("Promise"))).resolve()}),i=(s||(s=n("Promise"))).resolve(),l=null,u=function(){if(a.every(function(t,n){return t===e[n].waitUntilSatisfied()})){l=null;return}var t=[],r=e.map(function(e){var n=e.waitUntilSatisfied();return e.isSatisfied()||(t.push(e.name),n.then(function(){var n=t.indexOf(e.name);t.splice(n,1)})),n});return a=r,l=t,(s||(s=n("Promise"))).all(r).then(u)};return function(e){if(l==null){var n=u();n!=null&&(i=i.then(function(){return n}))}return t==null||t(l==null?"satisfied":"unsatisfied",l,e),i}}l.JobRequirement=u,l.UnsatisfiableJobRequirement=c,l.joinRequirements=d}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t;this.tasks=[],this.pendingTasks=[],this.lastJobStartedTimestampMs=null,this.jobMaxConcurrency=(t=e.jobMaxConcurrencyMap)!=null?t:{}}var n=t.prototype;return n.updateConfig=function(t){var e;this.jobMaxConcurrency=(e=t.jobMaxConcurrencyMap)!=null?e:{}},n.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(e,t){var n,r=(n=e[t.jobName])!=null?n:0;return e[t.jobName]=r+1,e},{})},n.next=function(){var e=this;if(this.tasks.length===0)return null;var t=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.tasks.filter(function(n){var r,a;return((r=t.get(n.jobName))!=null?r:0)<((a=e.jobMaxConcurrency[n.jobName])!=null?a:o("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return n.length>0?[n[0]]:null},n.add=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.tasks.push(e),e},n.markJobTaskPending=function(n){this.pendingTasks.includes(function(e){return e.jobId===n.jobId})&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),n.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(n),this.tasks=this.tasks.filter(function(e){return e.jobId!==n.jobId})},n.markJobTaskDone=function(t){this.pendingTasks=this.pendingTasks.filter(function(e){return e.jobId!==t}),this.tasks.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},n.count=function(){return this.tasks.length},n.pendingCount=function(){return this.pendingTasks.length},n.clearWaitingTasks=function(){this.tasks=[]},n.clear=function(){this.tasks=[],this.pendingTasks=[]},n.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs},t})(),c=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.next=function(){var e=this,t,n;if(this.tasks.length===0)return null;var r=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),o=this.tasks.filter(function(t){var n,o;return((n=r.get(t.jobName))!=null?n:0)<((o=e.jobMaxConcurrency[t.jobName])!=null?o:1)});if(o.length===0)return null;var a=(t=this.jobMaxConcurrency[o[0].jobName])!=null?t:1,i=(n=r.get(o[0].jobName))!=null?n:0;if(a>1&&i<a){var l=o.filter(function(e){return e.jobName===o[0].jobName}),s=Math.min(l.length,a-i);return l.slice(0,s)}return[o[0]]},t})(u);l.BaseJobBucket=u,l.LowJobBucket=c}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=o("WATimeUtils").performanceAbsoluteNow();return new(e||(e=n("Promise")))(function(e){setTimeout(function(){e(o("WATimeUtils").performanceAbsoluteNow()-t)},0)})}l.getEventLoopDelay=s}),98);
__d("WAConcurrentBucketJobQueue",["Promise","WABase64","WACryptoDependencies","WACustomError","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=30,d=new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);function m(e){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WABase64").encodeB64(t)}var p=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map,this.$6=new Map,this.$7=new Map,this.$9=0}var a=t.prototype;return a.init=function(t,n){var e,a,i,l,s,u;if(this.$1)throw r("err")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=t==null?void 0:t.bestEffortWaitTimeoutSec)!=null?e:c,this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$8=n,this.$7=this.$11(t==null?void 0:t.jobPrioritiesQuota),this.$6=new Map(this.$7),this.$5=new Map,this.$9=Date.now();var d=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(a=t.maxConcurrencyPerJob)!=null?a:{}}),m=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(i=t.maxConcurrencyPerJob)!=null?i:{}}),p=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(l=t.maxConcurrencyPerJob)!=null?l:{}}),_=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(s=t.maxConcurrencyPerJob)!=null?s:{}}),f=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(u=t.maxConcurrencyPerJob)!=null?u:{}});this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,_),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,f),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,m),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,p),this.$1=!0},a.updateConfig=function(n){this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$5.forEach(function(e){var t;return e.updateConfig({jobMaxConcurrencyMap:(t=n.maxConcurrencyPerJob)!=null?t:{}})}),this.$7=this.$11(n==null?void 0:n.jobPrioritiesQuota),o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"])))},a.isInitialized=function(){return this.$1},a.clearQueue=function(){if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(e){return e.clear()})},a.clearQueueByPriority=function(t){var e;if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");(e=this.$5.get(t))==null||e.clearWaitingTasks()},a.getIntStats=function(){var e=this,t=function(n){var t,r,o=e.$5.get(n);return((t=o==null?void 0:o.count())!=null?t:0)+((r=o==null?void 0:o.pendingCount())!=null?r:0)};return{highPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},a.getStringStats=function(){var e=this,t=function(n){var t,r,o=(t=(r=e.$5.get(n))==null?void 0:r.getStats())!=null?t:{},a=Object.keys(o).reduce(function(e,t){var n=e[0],r=e[1],a=o[t];return a>n?[a,t]:[n,r]},[0,null]),i=a[1];return i};return{highPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},a.enqueue=function(t,a,i,l){var e,s,c=this;if(!this.$1)return(u||(u=n("Promise"))).reject(r("err")("WAConcurrentBucketJobQueue not initialized"));var d,p,_=new(u||(u=n("Promise")))(function(e,t){d=e,p=t}),f=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},i),g=this.getJobBucketByType(f.priority);if(!g)return(u||(u=n("Promise"))).reject(r("err")("WAConcurrentBucketJobQueue no bucket for job with name "+t+" was found."));o("WAMetrics").getEventLoopDelay().then(function(e){l!=null&&l.isActive()&&(l==null||l.addPoint("measure_event_loop_delay",{int:{eventLoopDelay:e}}))}),l==null||l.addPoint("scheduling_job",{string:babelHelpers.extends({},this.getStringStats(),{priority:f.priority}),int:babelHelpers.extends({},this.getIntStats(),{maxTimeoutMs:(e=i==null?void 0:i.maxTimeoutMs)!=null?e:0})});var h=f.priority+"-"+t+"-"+((s=i==null?void 0:i.jobId)!=null?s:m(8)),y=g.add(t,f,h,n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{c.$8.logJobStarted(h);var e=yield c.$12(a(),i==null?void 0:i.maxTimeoutMs);c.$8.logJobCompleted(h),d(e)}catch(e){e instanceof o("WACustomError").TimeoutError?c.$8.logJobTimeout(h):c.$8.logJobError(h),p(e)}}));return this.$8.logJobCreated({jobId:h,jobName:t,jobPriority:f.priority,pendingJobsCount:g.count()}),i&&i.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$13(y),this.$14(),_},a.getAvailableThreadsCount=function(){return this.$3},a.getJobQuotaConfig=function(){return this.$7},a.getRemainingJobCountMap=function(){return this.$6},a.getJobBucketByType=function(t){return this.$5.get(t)},a.getSnapshot=function(t){var e=this.getJobBucketByType(t);return e?e.getStats():null},a.$11=function(t){var e;return t?e=new Map(t):e=new Map(d),e.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0),e},a.$15=function(t){var e;return(e=this.$6.get(t))!=null?e:0},a.$16=function(){this.$6=new Map(this.$7)},a.$17=function(t){var e=this;t===void 0&&(t=!0);var n=0,r=null,a=0;this.$5.forEach(function(t,o){n+=t==null?void 0:t.count(),a+=e.$15(o),r==null&&t.count()>0&&e.$15(o)>0&&(r=t)});var i=r==null||a===0;return i&&this.$16(),this.$18(n,i)?this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT):r==null&&t?this.$17(!1):r},a.$18=function(t,n){var e,r=this;function a(e,t){var n=Date.now();return e>n?!1:n-e<t*1e3}function i(e,t){var n=Math.ceil(e-Date.now())+t*1e3;return n>0?n:0}var l=this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT),s=t-((e=l==null?void 0:l.count())!=null?e:0),u=l==null?void 0:l.getLastJobStartedTimestamp();if((l==null?void 0:l.count())===0)return!1;if(u==null&&a(this.$9,this.$4)){if(this.$10==null){var c=i(this.$9,this.$4);this.$10=setTimeout(function(){r.$14(),r.$10=null},c)}return!1}return s>0&&u!=null&&a(u,this.$4)?!1:n},a.$19=function(t){var e=this.$20(t);return r("WANullthrows")(this.$5.get(e))},a.$20=function(t){var e=t.split("-")[0],n=o("WAJobOrchestratorTypes").JOB_PRIORITY.cast(e);if(!n)throw r("err")("ConcurrentBucketQueue cannot extract known job priority type from id: "+t);return n},a.$21=function(t){var e=this.$20(t);this.$15(e)>0?this.$6.set(e,this.$15(e)-1):this.$6.set(e,0)},a.$14=function(){for(var e=this;this.$3>0;){var t=this.$17(),n=t==null?void 0:t.next();if(n==null)break;n.forEach(function(t){e.$21(t.jobId),e.$13(t)})}},a.$12=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},a.$13=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=this,n=this.$19(e.jobId);this.$3--,n.markJobTaskPending(e);var r=e.jobId,a=e.jobName,i=e.run;try{var l;yield this.$12(i(),((l=e.jobInfo)==null?void 0:l.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$8.logJobTimeout(r),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),a);else throw e}finally{this.$3++,n.markJobTaskDone(r),this.$3>0&&setTimeout(function(){return t.$14()},0)}});function t(t){return e.apply(this,arguments)}return t})(),t})();l.WAConcurrentBucketJobQueue=p}),98);
__d("WAConcurrentPreemptiveJobQueue",["Promise","WACustomError","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","WARandomHex","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var a=t.prototype;return a.init=function(t,n){var e;if(this.$1)throw r("err")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$4=(e=t.maxConcurrencyPerJob)!=null?e:{},this.$7=n,this.$1=!0},a.updateConfig=function(n){var t;this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$4=(t=n.maxConcurrencyPerJob)!=null?t:{},o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"])))},a.isInitialized=function(){return this.$1},a.clearQueueByPriority=function(t){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(e){var n;return((n=e.jobInfo)==null?void 0:n.priority)!==t})},a.clearQueue=function(){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[],this.$6=[]},a.enqueue=function(t,a,i){var e,l=this;if(!this.$1)return(d||(d=n("Promise"))).reject(r("err")("ConcurrentPreemptiveJobQueue not initialized"));var s,u,c=new(d||(d=n("Promise")))(function(e,t){s=e,u=t}),m=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},i),p=(e=i==null?void 0:i.jobId)!=null?e:o("WARandomHex").randomHex(8).substr(0,64),_=this.$8(t,m,p,n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{l.$7.logJobStarted(p);var e=yield l.$9(a(),i==null?void 0:i.maxTimeoutMs);l.$7.logJobCompleted(p),s(e)}catch(e){e instanceof o("WACustomError").TimeoutError?l.$7.logJobTimeout(p):l.$7.logJobError(p),u(e)}}));return i&&i.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(_),this.$11(),c},a.getAvailableThreadsCount=function(){return this.$3},a.getJobMaxConcurrency=function(){return this.$4},a.getSnapshot=function(t){},a.$11=function(){for(;this.$3>0;){var e=this.$12();if(e==null)break;this.$10(e)}},a.$9=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},a.$10=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=this;this.$3--,this.$13(e);var n=e.jobId,r=e.jobName,a=e.run;try{var i;yield this.$9(a(),((i=e.jobInfo)==null?void 0:i.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$7.logJobTimeout(n),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),r);else throw e}finally{this.$3++,this.$14(n),setTimeout(function(){return t.$11()},0)}});function t(t){return e.apply(this,arguments)}return t})(),a.$8=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.$7.logJobCreated({jobId:r,jobName:t,jobPriority:n.priority,pendingJobsCount:this.$5.length}),this.$5.push(e),e},a.$13=function(t){this.$6.includes(function(e){return e.jobId===t.jobId})&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),t.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(t),this.$5=this.$5.filter(function(e){return e.jobId!==t.jobId})},a.$14=function(t){this.$6=this.$6.filter(function(e){return e.jobId!==t}),this.$5.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},a.$12=function(){var e=this;if(this.$5.length===0)return null;var t=this.$6.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.$5.filter(function(n){var r,o;return((r=t.get(n.jobName))!=null?r:0)<((o=e.$4[n.jobName])!=null?o:1)});return n[0]},t})();l.WAConcurrentPreemptiveJobQueue=m}),98);
__d("WADefaultJobNoQueue",["WAJobOrchestratorTypes","WARandomHex","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(){this.$2=!1}var t=e.prototype;return t.init=function(t,n){if(this.$2)throw r("err")("DefaultNoQueue has already initialized");this.$1=n,this.$2=!0},t.updateConfig=function(t){},t.isInitialized=function(){return this.$2},t.clearQueue=function(){},t.clearQueueByPriority=function(t){},t.getSnapshot=function(){throw r("err")("getSnapshot is not implemented for DefaultNoQueue")},t.enqueue=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r,a,i=(r=n==null?void 0:n.jobId)!=null?r:o("WARandomHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:i,jobName:e,jobPriority:(a=n==null?void 0:n.priority)!=null?a:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});try{this.$1.logJobStarted(i);var l=yield t();return this.$1.logJobCompleted(i),l}catch(e){throw this.$1.logJobError(i),e}});function t(t,n,r){return e.apply(this,arguments)}return t})(),e})();l.WADefaultJobNoQueue=e}),98);
__d("WAOrchestratorJobStatsLogger",["QPLFlow"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n){this.jobName=e,this.pendingJobsCount=n,this.jobPriority=t}var t=e.prototype;return t.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=o("QPLFlow").startNoopQPLFlow()},t.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{int:{startedAt:this.webcJobStartedT}})},t.logJobCompleted=function(t){this.webcJobCompletedT=Date.now(),this.jobResultType=t;var e={int:{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};t==="completed"?this.eventFlow.endSuccess(e):this.eventFlow.endFail(t,e)},e})(),s=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.logJobCreated=function(n){var t=n.jobId,r=n.jobName,o=n.jobPriority,a=n.pendingJobsCount,i=new e(r,o,a);i.logJobAdded(),this.$1.set(t,i)},n.logJobStarted=function(t){var e=this.$1.get(t);e==null||e.logJobStarted()},n.logJobCompleted=function(t){this.$2(t,"completed")},n.logJobError=function(t){this.$2(t,"error")},n.logJobTimeout=function(t){this.$2(t,"timeout")},n.logJobAborted=function(t){this.$2(t,"aborted")},n.$2=function(t,n){var e=this.$1.get(t);e==null||e.logJobCompleted(n),this.$1.delete(t)},t})();l.JobInfoEvent=e,l.JobStatsLogger=s}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e={maxConcurrency:1},t="default",n={},r=e,a=new(o("WAOrchestratorJobStatsLogger")).JobStatsLogger;return function(i,l){var c,d,m,p,_;i===void 0&&(i=!1);var f=i?t:o("WAGlobals").getConfig().orchestratorVersion(),g=(c=u())!=null?c:e,h;if(l==null||l.addPoint("get_orchestrator",{string:{orchestrator:f},int:{maxConcurrency:g.maxConcurrency,highPriorityQuota:(d=(m=g.jobPrioritiesQuota)==null?void 0:m.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?d:0,lowPriorityQuota:(p=(_=g.jobPrioritiesQuota)==null?void 0:_.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?p:0}}),n[f])return s(r,g)&&(r=g,n[f].updateConfig(g)),n[f];switch(f){case"preemptive":{h=new(o("WAConcurrentPreemptiveJobQueue")).WAConcurrentPreemptiveJobQueue;break}case"bucket":{h=new(o("WAConcurrentBucketJobQueue")).WAConcurrentBucketJobQueue;break}default:h=new(o("WADefaultJobNoQueue")).WADefaultJobNoQueue;break}return h.init(g,a),n[f]=h,r=g,h}}function s(e,t){var n,r,o,a;return e.maxConcurrency!==t.maxConcurrency||((n=e.jobPrioritiesQuota)==null?void 0:n.size)!==((r=t.jobPrioritiesQuota)==null?void 0:r.size)||Object.keys((o=e.maxConcurrencyPerJob)!=null?o:{}).length!==Object.keys((a=t.maxConcurrencyPerJob)!=null?a:{}).length?!0:JSON.stringify(e)!==JSON.stringify(t)}function u(){var e={jobPrioritiesQuota:new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return e}l.getInstanceDelegate=e}),98);
__d("WAPromiseBackoffs",["Promise","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){if(e===0)return 0;for(var n=g(t.algo),r=1;r<e;r++)n();return d(t,n())}function u(e){var t=e.relativeDelay,n=t===void 0?!1:t,r=null,o=g(e.algo);return function(){var t=r;if(t==null)return r=n?Date.now():0,0;var a=d(e,o());if(n){var i=Date.now(),l=i-t;l>0&&(a=Math.max(0,a-l)),r=i}return a}}function c(t){var r=u(t);return function(o){return new(e||(e=n("Promise")))(function(e){var t=r();t>0?setTimeout(e,t,o):e(o)})}}function d(e,t){var n=e.jitter,r=n===void 0?.1:n,o=e.max,a=e.min,i=t;return o!=null&&i>o&&(i=o),a!=null&&i<a&&(i=a),r!==0&&(i=Math.ceil(i*(1+r*Math.random()))),i}function m(e){var t=e.second-e.first,n=e.first-t;return function(){var e=t+n;return n=t,t=e,e}}function p(e){var t=e.base,n=t===void 0?2:t,r=e.first;return function(){var e=r;return r*=n,e}}function _(e){var t=e.delay;return function(){return t}}function f(e){var t=e.backoff,n=e.toMs,r=g(t);return function(){return n(r())}}function g(e){switch(e.type){case"fibonacci":return m(e);case"exponential":return p(e);case"constant":return _(e);case"adjust":return f(e);default:throw r("err")("makeTimeFunc unrecognized backoff "+e.type)}}l.getDelay=s,l.createTimer=u,l.createPromiseTimer=c}),98);
__d("WAPersistedJobManager",["Promise","WAJobRequirement","WALogger","WAPromiseBackoffs","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w=1,A=(function(){function e(e){this.feature=e}var t=e.prototype;return t.toString=function(){return"RequiresPage: "+this.feature},e})(),F=(function(){function e(e){this.backoffOptions=e}var t=e.prototype;return t.toString=function(){return"RetryOnBackoff"},e})(),O=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"NonRetryableError"},t})(babelHelpers.wrapNativeSuper(Error)),B=function(t){this.result=t},W="$unstarted",q="$finished",U=(function(){function t(t){var r=this,a=t.accessors,i=t.isRestartAfterCrash,l=t.unfinishedJobEntries,u=new Map,c=l.then(function(t){var l=[],c=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?l.push(e):c.push(e)}),(M||(M=n("Promise"))).all(l.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),H(t),t.step).sendLogs("job-stuck-"+t.type),a.deletePersistedJob(t.jobId)})).then(function(){c.forEach(function(e){u.has(e.jobId)||(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": restarting"])),V(e)),u.set(e.jobId,r.$1(e,i)))})})});this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=a,this.activeJobs=u,this.initialJobsPromise=c,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs}var r=t.prototype;return r.loadAndRunJobFromId=function(t){var e=this.activeJobs.get(t);if(e!=null)return e;var n=this.$2(t);return this.activeJobs.set(t,n),n},r.$2=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=this.accessors,n=this.initialJobsPromise;yield n;var r=yield t.readPersistedJob(e);return r?this.$1(r,!1):(o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))),null)});function t(t){return e.apply(this,arguments)}return t})(),r.$3=function(t){var e=this.implementationLoaders,n=this.implementations,r=n.get(t);if(r)return r;var o=e.get(t);if(!o)return null;var a=o();return n.set(t,a),a},r.$4=function(t,r){if(r==null||r.length===0)return(M||(M=n("Promise"))).resolve();var e=this.stepBlockers,a=e.get(r);return a==null&&(a=o("WAJobRequirement").joinRequirements(r.map(function(e){return e()}),z),e.set(r,a)),a(t)},r.$5=function(t,n,r,a){var e=this;r===void 0&&(r=!1);var i=t.step,l=n.findIndex(function(e){return e.stepName===i}),s=n[l].info(t.current,t.original,j(t,r)),u=s.code,m=s.requirements,p=this.$4(t,m);return a&&(p=p.then(a)),p.then(function(){return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),G(t)),u(t.current,t.original,j(t,r))}).then(function(a){if(a instanceof B)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),G(t)),a.result;var i=l+1;if(i>=n.length)return a;var s=n[i];return t.step=s.stepName,t.current=a,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,e.accessors.updatePersistedJob(t).then(function(){return e.$5(t,n,r)})})},r.$1=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var r,a=this,i=this.accessors,l=this.activeJobs,s=this.deprecatedJobs,u=this.listeners,c=u.onJobFinished,d=u.onJobStarted,D=yield this.$3(e.type),x=s[e.type];if(!D){if(x){if(x==="NOOP")return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),e.type),yield i.deletePersistedJob(e.jobId),null}else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),e.type).sendLogs("missing-job-implementation"),yield i.deletePersistedJob(e.jobId),null;D=yield x()}var $=D;x&&o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),e.type);var P=(r=e.stepFirstStartTime)!=null?r:o("WATimeUtils").unixTime();if(e.stepFirstStartTime=P,e.stepUnexpectedErrorCount=e.stepUnexpectedErrorCount||0,e.backedOffCount=e.backedOffCount||0,e.step===q){var N=e.waitUntil,O=o("WATimeUtils").secondsUntil(P);return N!=null&&o("WATimeUtils").isInFuture(N)&&O>0&&(o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),V(e)),N=o("WATimeUtils").castToUnixTime(N-O),o("WATimeUtils").isInFuture(N)&&(e.stepFirstStartTime=o("WATimeUtils").castToUnixTime(P-O),e.waitUntil=N,yield this.accessors.updatePersistedJob(e))),(N==null||!o("WATimeUtils").isInFuture(N))&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),V(e)),yield i.deletePersistedJob(e.jobId)),l.delete(e.jobId),e.current}var B=e.step!==W?D.find(function(t){return t.stepName===e.step}):D[0];if(!B)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),e.type,e.step).sendLogs("missing-job-step"),yield i.deletePersistedJob(e.jobId),null;e.step=B.stepName;var U=function(){var r=e.waitUntil,i=(M||(M=n("Promise"))).resolve();if(r!=null){var l=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);r>l?(o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),G(e),r,l),e.waitUntil=l,i=a.accessors.updatePersistedJob(e).then(function(){return o("WATimeUtils").delayUntil(l)})):(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),G(e),r),i=o("WATimeUtils").delayUntil(r))}return i.then(function(){var r=function(){return e.waitUntil=null,o("WATimeUtils").happenedWithin(P,o("WATimeUtils").DAY_SECONDS)||e.stepHardStartCountAfterTimeout++,a.accessors.updatePersistedJob(e)};return a.$5(e,$,t,r).catch(function(t){if(t instanceof A)return o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": requires page"])),G(e)),e.stepHardStartCountAfterTimeout>0&&(--e.stepHardStartCountAfterTimeout,a.accessors.updatePersistedJob(e)),new(M||(M=n("Promise")))(function(){});if(t instanceof F){o("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),G(e));var r=o("WAPromiseBackoffs").getDelay(++e.backedOffCount,t.backoffOptions);return e.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(r/1e3)),e.stepHardStartCountAfterTimeout>0&&--e.stepHardStartCountAfterTimeout,a.accessors.updatePersistedJob(e).then(U)}else if(e.stepUnexpectedErrorCount<w)return o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),G(e),e.stepUnexpectedErrorCount),o("WALogger").WARN(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),G(e),t),e.stepUnexpectedErrorCount++,a.accessors.updatePersistedJob(e).then(U);throw t})})},H=U(),z=H.then((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){o("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),G(e));var n=null;try{n=c(e.jobId,e.type,e.original,t)}catch(t){o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),e.type,t).sendLogs("onJobFinished-threw")}n!=null&&n>0?(e.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(n/1e3)),e.step=q,e.current=t,e.stepFirstStartTime=o("WATimeUtils").unixTime(),yield a.accessors.updatePersistedJob(e)):(yield i.deletePersistedJob(e.jobId),l.delete(e.jobId))});return function(e){return t.apply(this,arguments)}})(),(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),e.type,n).sendLogs("job-threw-exception-"+e.type);var r=$.find(function(t){return t.stepName===e.step});if(!r)o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),e.type,e.step);else{var a=r.info(e.current,e.original,j(e,t));a.stopRetryIf!=null&&(yield a.stopRetryIf.onStopRetry(e.current,e.original,j(e,t)))}yield i.deletePersistedJob(e.jobId),l.delete(e.jobId)});return function(e){return r.apply(this,arguments)}})());try{d(e.jobId,e.type,e.original)}catch(t){o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),e.type,t).sendLogs("onJobStarted-threw")}return z.then(function(){return H})});function t(t,n){return e.apply(this,arguments)}return t})(),r.addPersistedJobImplementation=function(t,n){var e=this.deprecatedJobs,r=this.implementationLoaders;if(r.has(t)){o("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}e&&e[t],r.set(t,n)},r.fireAndForget=function(t){var e=this;this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},r.waitUntilPersisted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;e.loadAndRunJobFromId(n)})},r.waitUntilCompleted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},r.fireAndForgetNonPersisted=function(t){o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["fireAndForgetNonPersisted not implemented in PersistedJobManager"])))},r.waitUntilCompletedNonPersisted=function(t){return(M||(M=n("Promise"))).resolve(function(){return o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["waitUntilCompletedNonPersisted not implemented in PersistedJobManager"])))})},t})();function V(e){return"Job["+e.jobId+"] ("+e.type+")"}function H(e){return"[Job "+e.type+"] "}function G(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function z(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),G(n),t):e==="unsatisfied"&&o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),G(n),t)}function j(e,t){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:K}}function K(e){return new B(e)}l.RequiresPage=A,l.RetryOnBackoff=F,l.NonRetryableError=O,l.InterruptJob=B,l.UNSTARTED_JOB=W,l.FINISHED_JOB=q,l.PersistedJobManager=U}),98);
__d("WaJobInMemoryAccessors",["Promise","WARandomHex","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=-1,r=new Map;return{deletePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.delete(o))},loadAllJobs:function(){return(e||(e=n("Promise"))).resolve(Array.from(r.values()))},maybeCreateJob:function(i){var a,l=JSON.stringify([i.type,(a=i.uniqKey)!=null?a:o("WARandomHex").randomHex(32)]),s={backedOffCount:0,current:i.args,original:i.args,startTime:o("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:i.type,uniqKey:l,version:i.version,waitUntil:null,scheduleConfig:i.scheduleConfig},u=function(){var o=t--,a=babelHelpers.extends({},s,{jobId:o});return r.set(o,a),(e||(e=n("Promise"))).resolve({id:o,newlyCreated:!0})};if(i.uniqKey!=null){var c=Array.from(r.values()).filter(function(e){return e.uniqKey===l});if(c.length===0)return u();var d=null;return c.forEach(function(e){e.step!=="$finished"?d=e:r.delete(e.jobId)}),d!=null?(e||(e=n("Promise"))).resolve({id:d.jobId,newlyCreated:!1}):u()}return u()},readPersistedJob:function(o){var t=r.get(o);return(e||(e=n("Promise"))).resolve(t&&babelHelpers.extends({},t))},updatePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.set(o.jobId,babelHelpers.extends({},o)))}}}l.getJobInMemoryAccessors=s}),98);
__d("WAPersistedJobManagerV2",["Promise","QPLFlow","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O=1;function B(e){var t=e.code,n=e.annotations,r=n===void 0?{}:n,o=e.eventFlow,a=o===void 0?W(r):o;return t(a).then(function(e){return a.endSuccess(),e}).catch(function(e){throw a.endFail("error",{string:{error:""+e}}),e})}function W(e){return e===void 0&&(e={}),o("QPLFlow").startNoopQPLFlow()}var q=(function(){function t(t){var r=this;this.$1=[];var a=t.accessors,i=t.ignoreForceNonPersistedJobList,l=t.isRestartAfterCrash,u=t.unfinishedJobEntries;this.getOrchestratorDelegate=o("WAOrchestrator").getInstanceDelegate(),this.activeJobs=new Map,this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=a,this.isRestartAfterCrash=l||!1,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs,this.inMemoryAccessors=o("WaJobInMemoryAccessors").getJobInMemoryAccessors(),this.offlineQueueMode=!0,this.$1=i,t.offlineQueueCompletePromise!=null?t.offlineQueueCompletePromise.finally(function(){r.offlineQueueMode=!1}):this.offlineQueueMode=!1,this.initialJobsPromise=u.then(function(t){var a=[],i=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?a.push(e):i.push(e)}),(F||(F=n("Promise"))).all(a.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),V(t),t.step).sendLogs("job-stuck-"+t.type),r.accessors.deletePersistedJob(t.jobId)})).then(function(){i.forEach(function(e){var t=r.$2(e.jobId);if(t.alreadyActive===!0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"])));return}t.deferred.resolve(B({code:function(n){return r.$3(e,r.accessors,{eventFlow:n})},annotations:{string:{name:e.type},bool:{offlineQueueMode:r.offlineQueueMode}}}))})})})}var a=t.prototype;return a.$4=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a;n===void 0&&(n={});var i=this.$2(e);if((a=n.eventFlow)==null||a.addPoint("start_load_and_run",{bool:{skipped:i.alreadyActive}}),i.alreadyActive===!0)return i.deferred;var l=yield t.readPersistedJob(e);if(l==null)throw o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))).sendLogs("missing-job-entry"),r("err")("Persisted job missing for given ID "+e);return i.deferred.resolve(this.$3(l,t,n)),i.deferred.promise});function t(t,n,r){return e.apply(this,arguments)}return t})(),a.$3=function(t,n,r){var e,a;return r===void 0&&(r={}),(e=r.eventFlow)==null||e.addPoint("enqueueing_job",{string:{name:t.type}}),this.getOrchestratorDelegate(((a=t.scheduleConfig)==null?void 0:a.priority)===o("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,r.eventFlow).enqueue(t.type,this.$5(t,n,r),t.scheduleConfig,r.eventFlow)},a.$6=function(t,n,r){var e=this;return r===void 0&&(r={}),n.maybeCreateJob(t).then(function(t){var o,a=t.id;return(o=r.eventFlow)==null||o.addPoint("job_persisted",{int:{jobId:a},bool:{nonPersisted:n===e.inMemoryAccessors}}),a})},a.$2=function(t){var e=this.activeJobs.get(t);if(e!=null)return{alreadyActive:!0,deferred:e};var n=new(o("WAResolvable")).Resolvable;return this.activeJobs.set(t,n.promise),{alreadyActive:!1,deferred:n}},a.$5=function(t,n,r){var e=this;return function(){return e.$7(t,n,r)}},a.$8=function(t){var e=this.implementationLoaders,n=this.implementations,r=n.get(t);if(r)return r;var o=e.get(t);if(!o)return null;var a=o();return n.set(t,a),a},a.$9=function(t,r){if(r==null||r.length===0)return(F||(F=n("Promise"))).resolve();var e=this.stepBlockers,a=e.get(r);return a==null&&(a=o("WAJobRequirement").joinRequirements(r.map(function(e){return e()}),G),e.set(r,a)),a(t)},a.$10=function(t,n,r,a,i){var e,l=this;i===void 0&&(i={});var s=t.step;(e=i.eventFlow)==null||e.addPoint("start_step");var u=n.findIndex(function(e){return e.stepName===s}),m=n[u].info(t.current,t.original,z(t,this.isRestartAfterCrash)),p=m.code,_=m.requirements,f=this.$9(t,_);return a&&(f=f.then(a)),f.then(function(){var e;return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),H(t)),(e=i.eventFlow)==null||e.addPoint("run_step"),p(t.current,t.original,z(t,l.isRestartAfterCrash,i.eventFlow))}).then(function(e){var a;if((a=i.eventFlow)==null||a.addPoint("step_is_complete"),e instanceof o("WAPersistedJobManager").InterruptJob)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),H(t)),e.result;var s=u+1;if(s>=n.length)return e;var c=n[s];return t.step=c.stepName,t.current=e,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,r.updatePersistedJob(t).then(function(){return l.$10(t,n,r,void 0,i)})})},a.$7=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r){var a,i,l=this;r===void 0&&(r={});var s=this.activeJobs,u=this.deprecatedJobs,c=this.listeners,d=c.onJobFinished,T=c.onJobStarted;(a=r.eventFlow)==null||a.addPoint("run_job");var D=yield this.$8(e.type),x=u[e.type];if(!D){if(x){if(x==="NOOP")return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),e.type),yield t.deletePersistedJob(e.jobId),null}else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),e.type).sendLogs("missing-job-implementation"),yield t.deletePersistedJob(e.jobId),null;D=yield x()}var $=D;x&&o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),e.type);var P=(i=e.stepFirstStartTime)!=null?i:o("WATimeUtils").unixTime();if(e.stepFirstStartTime=P,e.stepUnexpectedErrorCount=e.stepUnexpectedErrorCount||0,e.backedOffCount=e.backedOffCount||0,e.step===o("WAPersistedJobManager").FINISHED_JOB){var N=e.waitUntil,M=o("WATimeUtils").secondsUntil(P);return N!=null&&o("WATimeUtils").isInFuture(N)&&M>0&&(o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),U(e)),N=o("WATimeUtils").castToUnixTime(N-M),o("WATimeUtils").isInFuture(N)&&(e.stepFirstStartTime=o("WATimeUtils").castToUnixTime(P-M),e.waitUntil=N,yield t.updatePersistedJob(e))),(N==null||!o("WATimeUtils").isInFuture(N))&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),U(e)),yield t.deletePersistedJob(e.jobId)),s.delete(e.jobId),e.current}var w=e.step!==o("WAPersistedJobManager").UNSTARTED_JOB?D.find(function(t){return t.stepName===e.step}):D[0];if(!w)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),e.type,e.step).sendLogs("missing-job-step"),yield t.deletePersistedJob(e.jobId),null;e.step=w.stepName;var A=function(){var a=e.waitUntil,i=(F||(F=n("Promise"))).resolve();if(a!=null){var s=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);a>s?(o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),H(e),a,s),e.waitUntil=s,i=t.updatePersistedJob(e).then(function(){return o("WATimeUtils").delayUntil(s)})):(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),H(e),a),i=o("WATimeUtils").delayUntil(a))}return i.then(function(){var n=function(){return e.waitUntil=null,o("WATimeUtils").happenedWithin(P,o("WATimeUtils").DAY_SECONDS)||e.stepHardStartCountAfterTimeout++,t.updatePersistedJob(e)};return l.$10(e,$,t,n,r).catch(function(n){if(n instanceof o("WAPersistedJobManager").RetryOnBackoff){var a;o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),H(e)),(a=r.eventFlow)==null||a.addPoint("retry_on_backoff");var i=o("WAPromiseBackoffs").getDelay(++e.backedOffCount,n.backoffOptions);return e.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(i/1e3)),e.stepHardStartCountAfterTimeout>0&&--e.stepHardStartCountAfterTimeout,t.updatePersistedJob(e).then(A)}else{if(!(n instanceof o("WAPersistedJobManager").NonRetryableError)&&e.stepUnexpectedErrorCount<O){var l;return(l=r.eventFlow)==null||l.addPoint("retry_on_unexpected_error"),o("WALogger").WARN(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),H(e),e.stepUnexpectedErrorCount),o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),H(e),n),e.stepUnexpectedErrorCount++,t.updatePersistedJob(e).then(A)}throw n}})})},B=A(),W=B.then((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){o("WALogger").LOG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),H(e));var r=null;try{r=d(e.jobId,e.type,e.original,n)}catch(t){o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),e.type,t).sendLogs("onJobFinished-threw")}r!=null&&r>0?(e.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(r/1e3)),e.step=o("WAPersistedJobManager").FINISHED_JOB,e.current=n,e.stepFirstStartTime=o("WATimeUtils").unixTime(),yield t.updatePersistedJob(e)):(yield t.deletePersistedJob(e.jobId),s.delete(e.jobId))});return function(e){return r.apply(this,arguments)}})(),(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),e.type,n).sendLogs("job-threw-exception-"+e.type);var r=$.find(function(t){return t.stepName===e.step});if(!r)o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),e.type,e.step);else{var a=r.info(e.current,e.original,z(e,l.isRestartAfterCrash));a.stopRetryIf!=null&&(yield a.stopRetryIf.onStopRetry(e.current,e.original,z(e,l.isRestartAfterCrash)))}yield t.deletePersistedJob(e.jobId),s.delete(e.jobId)});return function(e){return r.apply(this,arguments)}})());try{T(e.jobId,e.type,e.original)}catch(t){o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),e.type,t).sendLogs("onJobStarted-threw")}return W.then(function(){return B})});function t(t,n,r){return e.apply(this,arguments)}return t})(),a.addPersistedJobImplementation=function(t,n){var e=this.deprecatedJobs,r=this.implementationLoaders;if(r.has(t)){o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}e&&e[t],r.set(t,n)},a.fireAndForget=function(t){var e=this;if(this.$1.indexOf(t.type)===-1){o("WALogger").LOG(D||(D=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.fireAndForgetNonPersisted(t);return}o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),B({code:(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r={eventFlow:n};return yield e.initialJobsPromise,n.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,r).then(function(t){return e.$4(t,e.accessors,r)})});function o(e){return r.apply(this,arguments)}return o})(),annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},a.waitUntilPersisted=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=this;if(this.$1.indexOf(e.type)===-1)return o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),e.type),this.fireAndForgetNonPersisted(e),(F||(F=n("Promise"))).resolve();o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),e.type);var r=W({string:{name:e.type},bool:{offlineQueueMode:this.offlineQueueMode}});return yield this.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),this.$6(e,this.accessors,{eventFlow:r}).then(function(e){B({code:function(r){var n={eventFlow:r};return t.$4(e,t.accessors,n)},eventFlow:r})}).catch(function(e){throw r.endFail("error",{string:{error:""+e}}),e})});function t(t){return e.apply(this,arguments)}return t})(),a.waitUntilCompleted=function(t){var e=this;return this.$1.indexOf(t.type)===-1?(o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.waitUntilCompletedNonPersisted(t)):(o("WALogger").LOG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),B({code:(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r={eventFlow:n};return yield e.initialJobsPromise,n.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,r).then(function(t){return e.$4(t,e.accessors,r)})});function o(e){return r.apply(this,arguments)}return o})(),annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}}))},a.fireAndForgetNonPersisted=function(t){var e=this;B({code:(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r={eventFlow:n};return yield e.initialJobsPromise,n.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,r).then(function(t){return e.$4(t,e.inMemoryAccessors,r)})});function o(e){return r.apply(this,arguments)}return o})(),annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},a.waitUntilCompletedNonPersisted=function(t){var e=this;return B({code:(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r={eventFlow:n};return yield e.initialJobsPromise,n.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,r).then(function(t){return e.$4(t,e.inMemoryAccessors,r)})});function o(e){return r.apply(this,arguments)}return o})(),annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},t})();function U(e){return"Job["+e.jobId+"] ("+e.type+")"}function V(e){return"[Job "+e.type+"] "}function H(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function G(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),H(n),t):e==="unsatisfied"&&o("WALogger").LOG(A||(A=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),H(n),t)}function z(e,t,n){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:j,eventFlow:n}}function j(e){return new(o("WAPersistedJobManager")).InterruptJob(e)}l.PersistedJobManager=q}),98);
__d("WACommsConnectionState",["WAGenericStateManager"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(e){function t(){return e.call(this,!1)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.isConnected=function(){return this.get()},n.waitForConnection=function(){return this.waitForValue(!0)},t})(o("WAGenericStateManager").WAGenericStateManager),s=new e;l.WACommsConnectionState=s}),98);
__d("WAWaitForComms",["WACommsConnectionState","WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAResolvable")).Resolvable;function s(){return e.promise}function u(){o("WACommsConnectionState").WACommsConnectionState.set(!1),e.isSettled&&(e=new(o("WAResolvable")).Resolvable)}function c(){o("WACommsConnectionState").WACommsConnectionState.set(!0),e.resolve()}function d(){return!e.resolveWasCalled()}function m(t){return e.reject(t)}l.waitForComms=s,l.commsConnectionLost=u,l.unblockComms=c,l.isStillWaitingForComms=d,l.failComms=m}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAPersistedJobManagerV2")).PersistedJobManager({accessors:o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendBumpMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(t,n,r,a){return o("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:t,originalArgs:r,result:a,type:n},!0),null},onJobStarted:r("emptyFunction")},offlineQueueCompletePromise:o("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:o("WAWaitForComms").waitForComms().then(function(){return o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function s(){return o("MAWDefinePersistedJob").persistedJobsApi}function u(){return e}l.getPersistedJobsApi=s,l.getJobManager=u}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function e(e){this.steps=e}var t=e.prototype;return t.step=function(t,n){return this.$1(t,typeof n=="function"?{code:n}:n)},t.$1=function(n,r){var t=r.code,a=r.requirements,i=r.stopRetryIf,l=d(a,t,i);if(i){var s=i.appCrashed,u=i.onStopRetry,p=i.timePassedSeconds,_=d(null,m(u),i);p!=null&&(l=c(function(e,t,n){var r=n.jobStartTime;return o("WATimeUtils").happenedWithin(r,p)},l,_)),s&&(l=c(function(e,t,n){var r=n.afterCrash;return!r},l,_))}return new e([].concat(this.steps,[{stepName:n,info:l}]))},t.finalStep=function(t,n){var e=this.step(t,n);return{end:function(){return e.steps}}},e})();function u(){return new s([])}function c(e,t,n){return function(r,o,a){return e(r,o,a)?t(r,o,a):n(r,o,a)}}function d(e,t,n){var r={requirements:e,code:t,stopRetryIf:n};return function(){return r}}function m(t){return function(r,a,i){return(e||(e=n("Promise"))).resolve(t(r,a,i)).then(function(e){return e instanceof o("WAPersistedJobManager").InterruptJob?e:new(o("WAPersistedJobManager")).InterruptJob(e)})}}l.JobBuilder=s,l.definePersistedJob=u}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(t,n,r,o,a,i,l){"use strict";var e,s={definePersistedJob:function(){return o("WAJobBuilder").definePersistedJob()}};function u(t){var r=o("MAWJobManager").getJobManager();Object.keys(t).forEach(function(o){var a=t[o];r.addPersistedJobImplementation(o,function(){return(e||(e=n("Promise"))).resolve(a)})})}function c(e){var t=o("MAWJobManager").getJobManager();Object.keys(e).forEach(function(n){var r=e[n];t.addPersistedJobImplementation(n,r)})}l.persistedJobsApi=s,l.setMsgrJobImplementations=u,l.setMsgrDeferredJobImplementations=c}),98);
__d("MAWMediaDownloadStatusForUI",["MAWBridge","MAWLoggerUtils","MAWMediaDownloadStatus","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function u(e){var t=e.details,n=e.hash,r=e.status,o=e.type,a=e.validationResult;c({details:t,hash:n,status:r,type:o,validationResult:a})}function c(e){var t=e.details,n=e.hash,r=e.status,a=e.type,i=e.validationResult;o("MAWBridge").getBridge().fireAndForget("event","updateMediaStatus",{details:t,key:n,status:r,type:a,validationResult:i})}function d(t){switch(t){case"disconnected":case"backoff":case"body-network-error":case"no-host":case"download-throttled":case"max-attempts-exceeded":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":return r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE;case"request-error":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":case"signature-expired":return r("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE;default:return s.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["getStatusTypeFromWAAPIDownloadMediaError: Unknown error type ",""])),String(t)),r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE}}l.sendMediaDownloadStatusToUI=u,l.getStatusFromWAAPIDownloadMediaError=d}),98);
__d("MAWMediaBackupTxns",["FBLogger","MAWDbMediaTxns","MAWDexieTable","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=1;function m(t,n,a,i,l,p){return p===void 0&&(p=0),i==null?o("MAWDexieTable").dexieResolve():o("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(t,i).then(function(_){if(_==null){var f={mediaId:n,msgId:a,objectId:i};return l!=null&&(f=babelHelpers.extends({},f,{fbid:l})),t.mediaBackup.add(f).then(function(e){return babelHelpers.extends({},f,{mediaBackupId:e})}).catch(function(u){if(u.name==="ConstraintError"){if(p<d)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""])),u),m(t,n,a,i,l,p+1);throw r("FBLogger")("messenger_web").mustfixThrow("Failed to add mediaBackup entry. Original error: %s, %s",u.name,u.message)}throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""])),u),u})}else{if(_.mediaId!==n||_.msgId!==a)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]))),_;if(_.fbid==null&&l!=null){var g=babelHelpers.extends({},_,{fbid:l});return t.mediaBackup.put(g).then(function(e){return g})}else o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"])));return _}})}l.linkMediaBackup=m}),98);
__d("MAWSupportedDocumentTypes",[],(function(t,n,r,o,a,i){"use strict";var e=["apk","pyc","7z","z","gz","xz","rar","zip","zipx","ace","arc","zpaq","quad","balz","cab","arj","lzh","uue","bz","bz2","bzip2","jar","iso","tar","ade","adp","air","app","application","bas","bat","chm","cmd","com","command","cpl","crt","dll","dmg","dpkg","exe","hlp","hta","inf","ins","isp","jnlp","js","jse","lib","lnk","lua","mde","msc","msi","msp","mst","ocx","pcd","pif","pkg","ps1","reg","scr","sct","sh","shb","shs","sys","term","url","vb","vbe","vbs","vxd","webarchive","wsc","wsf","wsh","xbap"];function l(t){if(t==null)return!1;var n=t.includes(".")?t.split(".").pop():null;return n!=null&&!e.includes(n)}i.isAllowedType=l}),66);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(t){return!0},user:function(t){return!1}});return{authoritativeThreadKey:n,cannotReplyReason:e.cannotReplyReason,clientThreadKey:t,description:r,folder:e.folder,instanceKey:a,isGroup:i,jid:e.jid,lastReadTs:o("MAWTimeUtils").ensureValidMillisTime(e.lastReadMsgTs)||o("WATimeUtils").castToMillisTime(0)}}l.createBridgeThread=e}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWQplProxy","MAWThreadMappingQPL","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(e!=null&&t!=null){var n=o("WATimeUtils").fromMillisTime(e),r=o("WATimeUtils").fromMillisTime(t);return o("WATimeUtils").castToMillisTime(Math.max(n,r))}return e!=null?e:t}function s(e,t){return e.threads.get({jid:t})}function u(e,t){return(r("gkx")("10029")?o("MAWDexieTable").dexieAll(t.map(function(t){return e.threads.get({jid:t})})).then(function(e){return e.filter(Boolean)}):e.threads.where("jid").anyOf(t).toArray()).then(function(e){var n=new Map;for(var r of e)n.set(r.jid,r);return t.map(function(e){return n.get(e)})})}function c(e,t,n){var a=t.instanceKey,i=t.jid;return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_start",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_start",{instanceKey:n}),s(e,i).then(function(a){return a==null?(n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"create-1-1-thread-start",{instanceKey:n}),p(e,t,n).then(function(e){return{created:!0,thread:e}})):g(e,t,a).then(function(e){return{created:!1,thread:e}})}).then(function(e){return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_end",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_end",{instanceKey:n}),e})}function d(e,t,n){var r=n===void 0?{}:n,a=r.logState;return u(e,t.map(function(e){var t=e.jid;return t})).then(function(n){a==null||a("threadMapping2FetchedThreads");var r={},i=[],l=[];for(var s of n.entries()){var u=s[0],c=s[1];c==null?i.push(t[u]):l.push({params:t[u],thread:c})}return o("MAWDexieTable").dexieAll([i.length?_(e,i):o("MAWDexieTable").dexieResolve([]),l.length?h(e,l):o("MAWDexieTable").dexieResolve([])]).then(function(e){var n=e[0],o=e[1];a==null||a("threadMapping3ThreadsUpdated");for(var i of n){var l=i.adminMsgParams,s=i.thread;r[s.jid]={adminMsgParams:l,created:!0,thread:s}}for(var u of o)r[u.jid]={adminMsgParams:null,created:!1,thread:u};return t.map(function(e){var t=e.jid;return r[t]})})})}function m(e){var t,n=e.authoritativeThreadKey,r=e.clientThreadKey,a=e.createTs,i=e.deduplicationKey,l=e.folder,s=e.jid,u=e.lastActivityTimestamp,c=o("WATimeUtils").millisTime(),d=(t=u!=null?u:a)!=null?t:c,m={authoritativeThreadKey:n!=null?n:void 0,deduplicationKey:i,folder:l!=null?l:o("MAWFolderTypes").FOLDER_ID.INBOX,jid:s,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsgTs:d,oldestMsg:null,optimisticThreadKey:r!=null?r:void 0,threadOrder:o("MAWDbThread").craftThreadOrder(d,s)};return m}function p(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread,u=m(t);return e.threads.add(u).then(function(t){var c=babelHelpers.extends({},u,{chatId:t});return s!==!0&&(l!=null&&o("MAWThreadMappingQPL").addPoint("create_thread_verify_thread_exists",l),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)})),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-e2ee-admin-msg-in-new-thread",{instanceKey:n}),o("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(e,c,n)}).catch(function(e){var t=r("getErrorSafe")(e);throw l!=null&&o("MAWThreadMappingQPL").endFailureInWorker("create_thread_failed",l,{string:{createThreadFailureReason:t.message}}),t.message="Error creating thread: "+t.message,t})}function _(e,t){var n=t.map(m);return e.threads.bulkAdd(n,{allKeys:!0}).then(function(r){var a=r.map(function(e,r){return{data:babelHelpers.extends({},n[r],{chatId:e}),params:t[r]}});for(var i of a)i.params.skipVerifyThread!==!0&&(i.params.instanceKey!=null&&o("MAWThreadMappingQPL").addPoint("bulk_create_thread_verify_thread_exists",i.params.instanceKey),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(i.data,i.data.optimisticThreadKey,i.params.authoritativeThreadKey,i.params.description,i.params.instanceKey)}));return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns(e,a.map(function(e){return e.data}))}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk creating threads: "+t.message,t})}function f(t,n,r){var o=n.authoritativeThreadKey,a=n.clientThreadKey,i=n.deduplicationKey,l=n.folder,s=n.lastActivityTimestamp,u={authoritativeThreadKey:o!=null?o:t.authoritativeThreadKey,cannotReplyReason:l!=null||a!=null?null:t.cannotReplyReason,deduplicationKey:l!=null||a!=null?i:t.deduplicationKey,folder:l!=null?l:t.folder,newestMsgTs:e(r,s),optimisticThreadKey:a!=null?a:t.optimisticThreadKey};return babelHelpers.extends({},t,u)}function g(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,n.jid).then(function(u){var c=f(n,t,u);return e.threads.update(n.chatId,c).then(function(){var e;return s!==!0&&(l!=null&&o("MAWThreadMappingQPL").addPoint("update_thread_verify_thread_exists",l),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)})),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(e=c==null?void 0:c.folder)!=null?e:o("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:c.jid})}),c}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error updating thread: "+t.message,t})})}function h(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.params,r=t.thread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,r.jid).then(function(e){var t=f(r,n,e);return{params:n,thread:t}})})).then(function(t){return e.threads.bulkUpdate(t.map(function(e){var t=e.thread;return{changes:t,key:t.chatId}})).then(function(){for(var e of t){var n=e.params,r=n.authoritativeThreadKey,a=n.description,i=n.instanceKey,l=n.skipVerifyThread,s=e.thread;l!==!0&&(i!=null&&o("MAWThreadMappingQPL").addPoint("bulk_update_thread_verify_thread_exists",i),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(s,s.optimisticThreadKey,r,a,i)}))}return t.map(function(e){var t=e.thread;return t})})}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk updating threads: "+t.message,t})}l.getExistingThread=s,l.bulkGetExistingThread=u,l.getOrCreateThread=c,l.bulkGetOrCreateThread=d,l.createThread=p,l.prepareUpdatedThreadData=f}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=e.ts,a=o("WATimeUtils").castUnixTimeToMillisTime(r),i=o("MAWTimeUtils").ensureValidMillisTime(n)||o("WATimeUtils").castToMillisTime(0),l=a>i?a:i;return babelHelpers.extends({},t,{newestMsgTs:l,oldestMsg:e.msgId,snippetMsg:e.msgId,snippetMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(e)),threadOrder:o("MAWDbThread").craftThreadOrder(l,t.jid)})}function u(t,n){return o("MAWDbThreadTxns").getThread(t,n).then(function(n){if(!n.success){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"])));return}var a=n.value,i=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},a.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castMillisTimeToUnixTime(o("WATimeUtils").millisTime()));return o("MAWWriteMsgTxns").writeMsg(t,i,a).then(r("emptyFunction"))})}function c(e,t,n){return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(e,[t],n).then(function(e){var t=e[0];return t})}function d(e){var t=o("MAWDbMsg").craftE2eeAdminMsgAltIndex(e.chatId),n=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},e.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castToUnixTime(0),t);return babelHelpers.extends({},n,{msgId:o("MAWDbMsg").craftMsgIdV2(e.chatId,1,n),sortOrderMs:0})}l.getUpdatedThreadForAdminMsg=s,l.writeReachabilityErrorAdminMsg=u,l.writeE2EEThreadDescriptionMsg=c,l.buildE2EEThreadDescriptionMsg=d}),98);
__d("MAWAfterWriteMsgUtil",["$InternalEnum","ArmadilloDataTraceType","MAWBridgeMsg","MAWBridgeTrace","MAWDbMsg","MAWIndexedDb","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","BUMP_LOCAL_ONLY","BUMP_LOCAL_AND_SERVER"]);function s(e){var t=e.dbMsg,n=e.isFirstMsg,r=e.openMessageOtid,a=e.openMessageParticipantCount,i=e.participantCount,l=e.quotedReplyAttachmentMeta,s=e.updatedThread,u=s.authoritativeThreadKey,c=s.jid;t.altIndex===o("MAWDbMsg").SPAM_ALT_INDEX||t.altIndex===o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX||(o("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(t,c,o("ArmadilloDataTraceType").armadilloMessageSend,r,n,a,i,u)}),o("MAWXMAUtils").isXMAStoryReply(t.xmaMessageType)||o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t,l)}))}l.WriteMsgAfterTxnBumpThreadOption=e,l.writeMsgAfterTransaction=s}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMsgTxns","MAWDexieTable","MAWQplProxy","WALogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){var r=[],a=[],i=[],l=new Map,s=new Map,u=n.map(function(e){return o("MAWDbMsgTxns").getThreadOldestMessageId(t,e.jid).then(function(t){return l.set(e.jid,t)})}),c=n.map(function(e){return o("MAWDbMsgTxns").getThreadNewestMessageMs(t,e.jid).then(function(t){return s.set(e.jid,t)})});return o("MAWDexieTable").dexieAll([u,c]).then(function(){return n.forEach(function(t){t==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"])));var n=o("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(t),l=o("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(n,t,s.get(t.jid));r.push(n),i.push(l),a.push({dbMsg:n,isFirstMsg:!1,updatedThread:l})}),{afterTransactionSyncMsgsData:a,e2eeThreadAdminMsgs:r,threadsToUpdate:i}})}function u(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate,r=new Map;return t.forEach(function(e){var t=e.updatedThread.jid;r.set(t,{externalId:e.dbMsg.externalId,msgId:e.dbMsg.msgId})}),n.map(function(e){return{adminMsgParams:r.get(e.jid),thread:e}})})}function c(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate;return t.forEach(function(e){return o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(e)}),n})}function d(e,t,n){return s(e,t).then(function(t){var a=t.afterTransactionSyncMsgsData,i=t.e2eeThreadAdminMsgs,l=t.threadsToUpdate;return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-start",{instanceKey:n}),o("MAWDexieTable").dexieAll([e.messages.bulkAdd(i),e.threads.bulkPut(l)]).then(function(){return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-end",{instanceKey:n}),{afterTransactionSyncMsgsData:a,threadsToUpdate:l}})})}l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns=u,l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns=c}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS;function s(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function u(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.failed,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(t,n){var r;return{ack:t.ack,author:t.author,externalId:t.externalId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e),msgContent:(r=o("MAWDbMsg").getMsgContent(t))==null?void 0:r.content,threadJid:n.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function d(t,n,r){return{ack:t.ack,altIndex:void 0,author:t.author,externalId:r.externalId,msgContent:o("MAWDbMsg").getMsgContent(t),originalTs:t.ts,revokedExternalId:r.revokedExternalId,threadJid:n.jid,ts:r.ts,type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e)}}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.buildUnstoredCiphertextMsg=s,l.buildUnstoredUnavailableMsg=u,l.buildUnstoredDeleteForMeMsg=c,l.buildUnstoredRevokedMsg=d}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(t,n,r,o,a,i,l){"use strict";var e="revoked",s="deleteForMe",u="deleteThread",c="Revoked",d="DeleteForMe",m="DeleteThread",p={DELETE_FOR_ME:d,DELETE_THREAD:m,REVOKED:c};function _(t){switch(t){case"Revoked":return e;case"DeleteForMe":return s;case"DeleteThread":return u;default:return r("WAAssertUnreachable")(t)}}l.PENDING_REVOKED=e,l.PENDING_DELETE_FOR_ME=s,l.REVOKED=c,l.DELETE_FOR_ME=d,l.PENDING_TYPE=p,l.getPendingSuffix=_}),98);
__d("MAWDeleteThreadUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[];if(e.forEach(function(e){if(e.pendingContent.type==="DeleteThread"){var n=e.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;n!=null&&t.push(n)}}),t.length===0)return null;t.sort(function(e,t){return t-e});var n=t[0];return{lastMessageTimestamp:n}}function l(e,t){return t!=null&&t.lastMessageTimestamp>=e}i.getLatestDeleteThreadInfo=e,i.isMsgDeletedViaDeleteThread=l}),66);
__d("MAWPendingStanzaCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function d(t){if(u==null){var n="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startPendingStanzaCleaner=c,l.addNewPendingStanzaCleanerTimestamp=d,l.getPendingStanzaCleaner_FOR_TESTING_ONLY=m,l.resetPendingStanzaCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+i).filter(function(e){var t=e.pendingContent;return t.type===a&&t.content.author===n&&t.content.threadJid===r}).first()}function s(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function u(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function c(e,t){var n=t.map(function(e){var t=e.expirationInSeconds;return o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+t)}),a=t.map(function(e,t){var r=e.content,a=e.externalId,i=e.pendingStanzaType;return{deleteTs:n[t],externalIdWithType:a+"_"+o("MAWDbPendingStanza").getPendingSuffix(i),pendingContent:r}});return e.pendingStanzas.bulkAdd(a).then(function(){return n.forEach(o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(r("emptyFunction"))}function d(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a),l=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+n),s={deleteTs:l,externalIdWithType:r+"_"+i,pendingContent:t};return e.pendingStanzas.add(s).then(function(){o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(l)})}function m(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+n).toArray().then(function(e){return o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e)})}function p(e){return e.pendingStanzas.toArray()}function _(e,t){var n=t.map(function(e){return e.rowId});return e.pendingStanzas.bulkDelete(n)}function f(e){var t,n;return(e==null||(t=e.pendingContent)==null?void 0:t.type)===o("MAWDbPendingStanza").PENDING_TYPE.REVOKED?e==null||(n=e.pendingContent)==null?void 0:n.content:null}function g(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD),r=t.map(function(e){return e+"_"+n});return e.pendingStanzas.where("externalIdWithType").anyOf(r).toArray().then(function(e){var t=e.reduce(function(e,t){var n=e.get(t.externalIdWithType);return n==null?e.set(t.externalIdWithType,[t]):n.push(t),e},new Map),n=new Map;return t.forEach(function(e,t){var r=o("WAJids").unsafeCoerceToChatJid(t.split("_")[0]),a=o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e);a!=null&&n.set(r,a)}),n})}l.maybeGetPendingStanzaByExternalId=e,l.maybeGetPendingRevokedStanza=s,l.maybeGetPendingDeletedStanza=u,l.bulkPutPendingStanzas=c,l.putPendingStanza=d,l.maybeGetDeleteThreadFromPendingStanza=m,l.getAllPendingStanzas=p,l.deletePendingStanzas=_,l.getRevokedContent=f,l.bulkGetDeleteThreadPendingStanzas=g}),98);
__d("MAWDeleteForMeMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function d(t){if(u==null){var n="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startDeleteForMeMsgContentCleaner=c,l.addNewDeleteForMeMsgContentCleanerTimestamp=d,l.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","MWFBLogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MWFBLogger").MWLogger().tags(["bridge",o("MAWLoggerUtils").Tag.Countdown]);function c(t){return{msgs:t.map(function(t){var n,r=t.messageExpirationTs,a=(n=t.ephemeralSetting)==null?void 0:n.ephemeralExpirationInSec;if(!(r==null||a==null)){var i=o("WATimeUtils").cappedMillisecondsUntil(r);if(i<=0){u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"])));return}var l=a*1e3;return i>l&&(i=l),u.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""])),t.msgId,r,i,a),{countdownTs:r,millisecondsUntilCountdownTs:i,msgId:t.msgId,threadJid:t.threadJid,ts:o("MAWDbMsg").getCanonicalTsFromMsg(t)}}}).filter(Boolean)}}function d(e,t){return{countdownTs:t,msgId:e}}l.createBridgeMsgsStartCountdown=c,l.createBridgeMsgClearCountdown=d}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"backend"]);function c(e){var t=e.expiryFns,n=e.purgeDeletionsFns;if(s==null){var r;s={expiry:new(r=o("MAWMsgCleaner")).MsgCleaner(t,r.CLEANER_TYPE.EPHEMERAL),purgeDeletions:new r.MsgCleaner(n,r.CLEANER_TYPE.EPHEMERAL)}}}function d(t,n){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");var r=s,o=r.expiry,a=r.purgeDeletions;u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",") and deletion(",")"])),t,n),o.update(t),a.update(n)}function m(){return s}function p(){s=null}l.startEphemeralCleaner=c,l.addNewEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t,n){e.set(t,n)}function u(t){var n,r={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};return(n=e.get(t))!=null?n:r}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};if(!e.has(t)){var r=yield o("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:t});s(t,r!=null?r:n)}}),d.apply(this,arguments)}l.setEphemeralSettingCache=s,l.getEphemeralSettingCache=u,l.requestLSDBCacheForJid=c}),98);
__d("MAWEphemeralUtil",["FBLogger","MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){var n=t.ephemeralExpirationInSec!==e.ephemeralExpirationInSec&&t.ephemeralLastUpdatedOrSetTimestamp===e.ephemeralLastUpdatedOrSetTimestamp;return n||e.ephemeralLastUpdatedOrSetTimestamp>t.ephemeralLastUpdatedOrSetTimestamp}function c(t,n,r){if(t==null)return!0;var a=t.ephemeralSetting;return a!=null&&a.ephemeralExpirationInSec===n?(o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"]))),!1):a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>r?(o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"]))),!1):!0}function d(e){var t={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:t,unstoredDbReaction:null}}function m(e,t){var n;switch(t){case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type")}var a={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:n},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:void 0}}function p(e){return o("WAJids").switchOnMsgrChatJidType(e,{group:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(t){return t}})}function _(e){e!=null&&e.messageExpirationTs!=null&&e.ephemeralCounterStarted===!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(e.msgId,e.messageExpirationTs)})}l.isLocalSettingOutdated=u,l.shouldUpdateForOutgoingUserEphemeralSettingChange=c,l.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=d,l.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=m,l.getUserJidForEphemeralSetting=p,l.maybeClearEphemeralMsgCountdown=_}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","MAWUserJidWrapper","MWFBLogger","WAJids","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MWFBLogger").MWLogger().tags(["maw_db","txn",(_=o("MAWLoggerUtils")).Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Incoming]),g=o("MWFBLogger").MWLogger().tags(["maw_db","txn",_.Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Outgoing]),h=null,y=90*o("DateConsts").SEC_PER_DAY;function C(t,n,r,a,i,l,d,m,p){if(r<0||r>y){var _=o("WAJids").interpretAndValidateJid(l.jid).toString();throw f.mustfixThrow("EphemeralSetting duration is invalid "+r+", jidType: "+_)}var g={ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:a};f.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",". Thread: ",", Author: ",""])),r,a,String(l),n);var C=o("WAJids").interpretAsUserJid(l.jid);if(C==null)return f.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"]))),o("MAWDexieTable").dexieResolve(h);var b=o("WAJids").isAuthorMe(n)?o("MAWUserJidWrapper").getMyUserJid():n,v=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(l.jid),S=v==null?void 0:v.ephemeralExpirationInSec,R=v==null?void 0:v.ephemeralLastUpdatedOrSetTimestamp;if(p)return v!=null&&!o("MAWEphemeralUtil").isLocalSettingOutdated(g,v)?a!==R?(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sending Sync Response with duration ",", timestamp ",""])),S,R),o("MAWDexieTable").dexieResolve({outOfSyncEphemeralSetting:{chatJid:l.jid,correctEphemeralExpirationInSec:v.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:v.ephemeralLastUpdatedOrSetTimestamp}})):(f.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Ephemeral setting in sync"]))),o("MAWDexieTable").dexieResolve(h)):(o("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:o("WAJids").userIdFromJid(b),chatJid:l.jid,ephemeralSettingArgs:g,isEphemeralSettingReset:i}}),o("MAWDexieTable").dexieResolve(h));var L={ephemeralSetting:g,ephemeralSyncResponseBackoffInfo:void 0,userJid:C};return t.ephemeralSettings.put(L).then(function(){return h})}function b(e,t,n,r,a){var i=n;if(i<0)throw g.mustfixThrow("Ephemeral duration should be 0 or more");var l=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return o("MAWDbThreadTxns").getThread(e,t).then(function(t){return t.success?e.ephemeralSettings.get({userJid:l}).then(function(t){if(!o("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(t,i,r))return o("WAResultOrError").makeResult({shouldUpdateSetting:!1});var n=t==null?{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r},userJid:l}:babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r}});return e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult({shouldUpdateSetting:!0})})}):o("WAResultOrError").makeResult({shouldUpdateSetting:!1})})}function v(e,t,n){var a=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return e.ephemeralSettings.get({userJid:a}).then(function(t){if(t==null||t.ephemeralSetting==null)throw g.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"])),a,String(t),String(t==null?void 0:t.ephemeralSetting)),g.mustfixThrow("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change");var o=babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:t.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:n}});return e.ephemeralSettings.put(o).then(r("emptyFunction"))})}function S(e,t){var n=o("WAJids").interpretAsUserJid(t);n==null&&g.mustfixThrow("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");var r=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(t);return r.ephemeralLastUpdatedOrSetTimestamp===o("WATimeUtils").castToUnixTime(0)?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting")):r!=null&&r.ephemeralExpirationInSec>0?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:t,correctEphemeralExpirationInSec:r.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:r.ephemeralLastUpdatedOrSetTimestamp}})):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting"))}function R(e,t){return e.ephemeralSettings.get({userJid:t}).then(function(n){return(n==null?void 0:n.ephemeralSyncResponseBackoffInfo)==null?(f.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""])),t),o("WAResultOrError").makeResult()):(n.ephemeralSyncResponseBackoffInfo=void 0,f.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""])),t),e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult()}))})}l.handleAndWriteIncomingEphemeralSetting=C,l.handleAndWriteOutgoingUserEphemeralSettingChange=b,l.updateContactWhenEphemeralSettingChangeMarkedSent=v,l.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=S,l.maybeResetEphemeralSyncResponseBackoffInfo=R}),98);
__d("MAWEphemeralMsgTxns",["EBLogger","MAWBridgeMsgCountdown","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLoggerUtils","MAWODSProxy","MAWThreadSnippetUtils","MWFBLogger","WAJids","WAOdsEnums","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("MWFBLogger").MWLogger().tags([(p=o("MAWLoggerUtils")).Tag.Ephemeral,p.Tag.SettingSync,p.Tag.Incoming]),f=o("MWFBLogger").MWLogger().tags([p.Tag.Ephemeral,p.Tag.OnRead,p.Tag.Countdown]);function g(e,t,n){return n===void 0&&(n=function(){return!0}),o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,t,!1,!0).filter(n).limit(1).toArray().then(function(e){var t;return{needsUpdate:!0,value:(t=e[0])!=null?t:null}})}function h(e,t,n){return n.size===0?o("MAWDexieTable").dexieResolve():o("MAWDbThreadTxns").getThread(e,t).then(function(t){if(t.success){var r=t.value;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").getThreadOldestMessageId(e,r.jid),o("MAWDbMsgTxns").getThreadNewestMessageId(e,r.jid)]).then(function(t){var a=t[0],i=t[1];if(!(a==null||i==null)){var l=o("MAWEphemeralMsgUtils").filterNonExpiredMsg(n),s=n.has(a)?g(e,r.jid,l):o("MAWDexieTable").dexieResolve({needsUpdate:!1}),u=n.has(i)?o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,r.jid,!0,!1).filter(l).reverse().limit(1).toArray().then(function(t){var a=t[0];return a!=null&&o("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(a)?o("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(e,r,n).then(function(e){return{needsUpdate:!0,value:e!=null?e:null}}):{needsUpdate:!0,value:a!=null?a:null}}):o("MAWDexieTable").dexieResolve({needsUpdate:!1});return o("MAWDexieTable").dexieAll([s,u]).then(function(t){var n,l,s,u,c=t[0],d=t[1];if(!(!c.needsUpdate&&!d.needsUpdate)){var m=d.needsUpdate?(n=(l=d.value)==null?void 0:l.msgId)!=null?n:void 0:i,p=d.needsUpdate?d.value!=null?o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(d.value)):void 0:r.snippetMsgTs,_=babelHelpers.extends({},r,{oldestMsg:c.needsUpdate?(s=(u=c.value)==null?void 0:u.msgId)!=null?s:null:a,snippetMsg:m,snippetMsgTs:p});e.threads.put(_)}})}})}})}function y(t,n,r){if(r===void 0&&(r=!0),n==null||n.ephemeralSetting==null||n.ephemeralSetting.ephemeralExpirationInSec===0)return o("MAWDexieTable").dexieResolve(n);var a=o("WATimeUtils").castToUnixTime(n.ts+n.ephemeralSetting.ephemeralExpirationInSec),i=o("WATimeUtils").castToUnixTime(a+o("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);return n.ebTimestampMs!=null&&(o("EBLogger").EBLogger().tags(["eb_restore"]).WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Delete DM backup - S472027 follow up"]))),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"restore_dm_s472027"})),C(t,[{messageDeleteTs:i,messageExpirationTs:a,msgId:n.msgId,readTsForLogging:n.ts}]).then(function(e){var t=e[0],n=e[1],a=e[2];return a.length>0&&(f.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""])),String(a.map(function(e){return e.msgId}))),r&&o("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)})),t!=null&&n!=null&&o("MAWEphemeralCleaner").addNewEphemeralTimestamp(t,n),a[0]})}function C(e,t){var n=t.map(function(e){return e.msgId});return o("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(e,n).then(function(r){var o=new Map;t.forEach(function(e){o.set(e.msgId,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging});var t=r.get(e.msgId);t!=null&&o.set(t,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging})});var a=null,i=null,l=[],s=Array.from(new Set(n.concat(Array.from(r.values()))));return e.messages.where("msgId").anyOf(s).toArray().then(function(t){if(t.length!==0)return t.forEach(function(e){var t=e.messageExpirationTs,n=e.messageDeleteTs,r=o.get(e.msgId),s=r==null?void 0:r.messageExpirationTs,c=r==null?void 0:r.messageDeleteTs;if(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""])),e.msgId,t,n,s,c),!(s==null||c==null)&&e.ephemeralCounterStarted!==!0){(a==null||s<a)&&(a=s),(i==null||c<i)&&(i=c);var d=babelHelpers.extends({},e,{ephemeralCounterStarted:!0,messageDeleteTs:c,messageExpirationTs:s});l.push(d)}}),e.messages.bulkPut(l)}).then(function(){return[a,i,l]})})}function b(e,t){if(t.size===0)return o("MAWDexieTable").dexieResolve();var n=[];return t.forEach(function(t,r){n.push(h(e,r,t))}),o("MAWDexieTable").dexieAll(n).then(r("emptyFunction"))}function v(e,t,n,a,i){if(t==null)return o("MAWDexieTable").dexieResolve();_.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""])),n,a.jid,t.type);var l=o("MAWDexieTable").dexieResolve();if(t.ephemeralSetting==null)o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(){return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))},user:function(){o("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(t)&&(l=o("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(e,a.jid).then(function(e){var t;return e==null||(t=e.value)==null?void 0:t.outOfSyncEphemeralSetting}))}});else if(t.messageExpirationTs!=null&&t.messageDeleteTs!=null){var s=t.ephemeralSetting,u=t.messageDeleteTs,p=t.messageExpirationTs;_.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""])),s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp),o("MAWEphemeralCleaner").addNewEphemeralTimestamp(p,u),l=o("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(e,n,s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp,!1,a,i,null,!0).then(function(e){return e==null?void 0:e.outOfSyncEphemeralSetting})}return l.then(function(t){if(t!=null)_.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""])),t.correctEphemeralExpirationInSec,t.correctEphemeralLastUpdatedOrSetTimestamp);else return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))})}l.markEphemeralMessageAsSent=y,l.bulkUpdateEphemeralMessageTimestamps=C,l.updateThreadsOnMessagesExpiredFromUi=b,l.syncEphemeralSettingOnIncomingMsg=v}),98);
__d("MAWExpiredQuoteCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.QUOTE))}function d(t){if(u==null){var n="Trying to add new addNewExpiredQuoteCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ExpiredQuoteCleaner: Adding timestamps backend(",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startExpiredQuoteCleaner=c,l.addNewExpiredQuoteCleanerTimestamp=d,l.getExpiredQuoteCleaner_FOR_TESTING_ONLY=m,l.resetExpiredQuoteCleaner_FOR_TESTING_ONLY=p}),98);
__d("isE2EEConversationSearchEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("4741")}l.default=e}),98);
__d("isMAWUniversalSearchEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("4741")}l.default=e}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isMAWUniversalSearchEnabled"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("isE2EEConversationSearchEnabled")()||r("isMAWUniversalSearchEnabled")()}l.default=e}),98);
__d("MAWFTSTxns",["MAWDexieTable","isWAFTSContentSearchEnabled","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("1146");function s(e,t){return r("isWAFTSContentSearchEnabled")()?e.ftsPurgeBacklog.put({externalId:t}):o("MAWDexieTable").dexieResolve(null)}function u(t,n){return!r("isWAFTSContentSearchEnabled")()||!e?o("MAWDexieTable").dexieResolve(null):t.ftsBackloggedMessages.put({rowId:n})}function c(t,n){return!r("isWAFTSContentSearchEnabled")()||!e?o("MAWDexieTable").dexieResolve(null):t.ftsBackloggedMessages.bulkPut(n.map(function(e){return{rowId:e}}))}function d(e,t){return r("isWAFTSContentSearchEnabled")()?e.ftsPurgeThreadBacklog.put({chatJid:t}):o("MAWDexieTable").dexieResolve(null)}l.maybePutMessageToPurgeBacklog=s,l.maybePutMessageToBacklog=u,l.maybePutMessagesToBacklog=c,l.maybePutThreadToPurgeBacklog=d}),98);
__d("MAWThreadEventConst",[],(function(t,n,r,o,a,i){"use strict";var e="placeholderConvertSubscription";i.PLACEHOLDER_CONVERT_SUBSCRIPTION=e}),66);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,r,a,i,l,s){var e=o("MAWAuthor").getAuthorUserJid(a);return t.messages.where("quoteExternalId").equals(r).toArray().then(function(r){if(r.length!==0){var a=r;(s==null||!s)&&(a=r.filter(function(t){var r=t.quote,a=t.threadJid;return o("MAWAuthor").getAuthorUserJid(r==null?void 0:r.content.author)===e&&a===n}));var u=a.map(function(e){var t,n=Object.assign({},(t=e.quote)==null?void 0:t.content,i.content),r=babelHelpers.extends({},e.quote,i,{content:n});return r.content.msgId==null&&l!=null&&(r.content.msgId=l),babelHelpers.extends({},e,{quote:r})});return t.messages.bulkPut(u).then(function(){return u})}})},s=function(n,r,a,i,l){l===void 0&&(l=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var t={content:{mediaId:void 0,msgContent:void 0,type:l}};return e(n,r,a,i,t).then(function(e){e!=null&&e.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})},u=function(t,n,r){r===void 0&&(r=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=n.author,a=n.chat,i=n.externalId;return t.threads.get({jid:a}).then(function(n){if(n!=null)return s(t,n.jid,i,e,r)})},c=function(n,r,a,i){var t=a.author,l=a.externalId,s=a.mediaId,u=a.msgContent,c=a.msgId,d=a.plaintextHash,m=a.ts,p=a.type;if(o("WAJids").isAuthorSystem(t))return o("MAWDexieTable").dexieResolve();var _={author:t,chat:r,externalId:l};if(!o("MAWMsgType").isQuotedMsgType(p))return o("MAWDexieTable").dexieResolve();var f=o("MAWDexieTable").dexieResolve(null);return a.type===o("MAWMsgType").MSG_TYPE.XMA&&(f=o("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(n,_).then(function(e){return e.success===!1?o("MAWDexieTable").dexieResolve(null):o("MAWDexieTable").dexieResolve(e.value)})),f.then(function(o){var a,_,f,g,h,y={author:t,externalId:l,mediaId:(a=o==null||(_=o.defaultPreview)==null?void 0:_.mediaId)!=null?a:s,msgContent:u,plaintextHash:(f=o==null||(g=o.defaultPreview)==null?void 0:g.plaintextHash)!=null?f:d,ts:m,type:p,xmaMessageType:o==null||(h=o.xma)==null?void 0:h.targetType};return e(n,r,l,t,{content:y},c,i)})};function d(e,t,n){return o("MAWDexieTable").dexieAll([c(e,n,t),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)]).then(function(n){var r=n[0],a=n[1];return r!=null?o("MAWDexieTable").dexieResolve(m(t,a)).then(function(){o("MAWDexieTable").dexieAll(r.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){return m(t,e),t})}))}):o("MAWDexieTable").dexieResolve([])})}function m(e,t){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,t)})}l.disassociateQuotedMsg=s,l.disassociateQuotedMessageByProtocolMsgId=u,l.associateQuotedMessage=c,l.associateAllReplies=d,l.issueReplyMsgUpdate=m}),98);
__d("MAWUseProtocolMsgIdForMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(){return!0}i.shouldUseProtocolMsgIdForMsgId=e}),66);
__d("MAWBridgeParticipants",["MAWBridgeParticipantsUpdatedHandler","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.deliveredWatermarkTs,n=e.threadJid,r=e.type,a=e.userJid;return babelHelpers.extends({deliveredWatermarkTs:t||o("WATimeUtils").castToUnixTime(0),fbid:o("WAJids").extractUserId(a)},o("MAWBridgeParticipantsUpdatedHandler").mawToLsParticipantTypeConversion(r),{lastReadActionTs:o("WATimeUtils").castToUnixTime(0),readWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n})}function s(t){return{participants:t.map(function(t){return e(t)})}}l.createBridgeParticipant=e,l.createBridgeParticipants=s}),98);
__d("MAWDbParticipantTxns",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWUserJidWrapper","MWFBLogger","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t,n,r){return r===void 0&&(r=!0),p(e,n.map(function(e){return babelHelpers.extends({},e,{chatJid:t})}),r)}function d(e,t){o("WAJids").switchOnMsgrChatJidType(e.threadJid,{group:r("emptyFunction"),user:function(r){e.userJid!==r&&e.userJid!==o("MAWUserJidWrapper").getMyUserJid()&&o("MWFBLogger").MWLogger().tags(["db","txn"]).mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",t)}})}function m(e){var t=e.addressable,n=e.chatJid,r=e.type,a=e.userJid;return{addressable:t,deliveredWatermarkTs:o("WATimeUtils").castToUnixTime(0),id:o("MAWDbParticipant").craftParticipantId(n,a),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n,type:r!=null?r:"participant",userJid:a}}function p(e,t,n){if(n===void 0&&(n=!0),t.length===0)return o("MAWDexieTable").dexieResolve([]);var r=t.map(function(e){return m(e)});return r.forEach(function(e){return d(e,"bulkAddParticipantsInThreads")}),e.participants.bulkPut(r).then(function(){return n&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(r)}),r})}function _(e,t,n,r){r===void 0&&(r=!0);var a=new Set([t,o("MAWUserJidWrapper").getMyUserJid()]),i=n.filter(function(e){var t=e.userJid;return!a.has(t)}).map(function(e){var t=e.threadJid,n=e.userJid;return[t,n]});return i.length>0&&o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:o("MAWCurrentUser").isEmployee()?"employee":"public"}),b(e,i,r)}function f(e,t,n,r){r===void 0&&(r=!0);var a=Array.from(new Set([t,o("MAWUserJidWrapper").getMyUserJid()])),i=new Set(n.map(function(e){return e.userJid})),l=a.filter(function(e){return!i.has(e)}),s=l.map(function(e){return{type:"participant",userJid:e}});return c(e,t,s,r).then(function(e){var t=a.reduce(function(t,r){var o=e.find(function(e){return e.userJid===r}),a=n.find(function(e){return e.userJid===r});return o!=null&&a==null?t.push(o):a!=null&&t.push(a),t},[]);return t})}function g(e,t,n){return n===void 0&&(n=!0),L(e,t).then(function(r){return _(e,t,r,n).then(function(o){return f(e,t,r,n)})})}function h(e,t){return t.forEach(function(e){return d(e,"bulkUpdateParticipants")}),e.participants.bulkPut(t).then(function(){return t.length>0&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(t)}),t})}function y(e,t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve();var r=n.map(function(e){return[t,e]});return b(e,r)}function C(e,t,n){if(t.length===0)return o("MAWDexieTable").dexieResolve();var r=t.map(function(e){return[e,n]});return b(e,r)}function b(e,t,n){return n===void 0&&(n=!0),e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(t){return e.participants.bulkDelete(t.map(function(e){return e.id})).then(function(){n&&t.forEach(function(e){var t=e.threadJid,n=e.userJid;return o("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:t,userId:o("WAJids").extractUserId(n)}})})})})}function v(e,t){return e.participants.where("threadJid").equals(t).delete()}function S(e,t,n,r,o){return R(e,[{deliveredWatermarkTs:n,lastReadActionTs:o,lastReadWatermarkTs:r,participantKey:t}]).then(function(e){return e[0]})}function R(t,n,r){if(n.length===0)return o("MAWDexieTable").dexieResolve([]);var a=new Map,i=[];return n.forEach(function(e){i.push(e.participantKey),a.set(JSON.stringify(e.participantKey),e)}),t.participants.where(["threadJid","userJid"]).anyOf(i).toArray().then(function(n){n.length!==i.length&&r!=null&&r.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing participants "," vs ",""])),n.length,i.length);var l=[],c=[];return n.forEach(function(e){var t=a.get(JSON.stringify([e.threadJid,e.userJid]));if(t==null){r!=null&&r.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing tsData for participant ",", ",""])),e.threadJid,e.userJid);return}var n=t.deliveredWatermarkTs,o=t.lastReadActionTs,i=t.lastReadWatermarkTs,d=e.deliveredWatermarkTs,m=e.lastReadWatermarkTs,p=e.lastReadActionTs,_=n>d,f=i>m,g=p==null||o>p;if(r!=null&&r.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: participant ",", "," deliveredWatermarkTs: ",", lastReadWatermarkTs: ",", lastReadActionTs: ",""])),e.threadJid,e.userJid,n,i,o),!_&&!f&&!g){c.push(e);return}l.push(babelHelpers.extends({},e,{deliveredWatermarkTs:_?n:d,lastReadActionTs:g?o:p,lastReadWatermarkTs:f?i:m}))}),l.forEach(function(e){return d(e,"bulkUpdateParticipantTimestamps")}),t.participants.bulkPut(l).then(function(){return l.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:o("MAWBridgeTypesCreators").createBridgeReceivedReceipt(e.threadJid,o("WAJids").extractUserId(e.userJid),e.deliveredWatermarkTs)})}),[].concat(l,c)})})}function L(e,t){return e.participants.where("threadJid").equals(t).toArray()}function E(e,t){return e.participants.where("threadJid").anyOf(t).toArray()}function k(e,t){return L(e,t).then(function(e){return e.filter(function(e){return e.type==="invitedParticipant"})})}function I(e,t,n){return e.participants.where(["threadJid","userJid"]).equals([t,n]).first().then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function T(e,t){return e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(e){var n=new Map(e.map(function(e){return[JSON.stringify([e.threadJid,e.userJid]),e]}));return t.map(function(e){return n.get(JSON.stringify(e))})})}l.bulkAddParticipants=c,l.logIfIllegalParticipant=d,l.bulkAddParticipantsInThreads=p,l.deleteIncorrectParticipantsInOneToOneThread=_,l.addMissingParticipantsInOneToOneThread=f,l.bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread=g,l.bulkUpdateParticipants=h,l.bulkDeleteParticipantsInThread=y,l.bulkDeleteParticipantAcrossThreads=C,l.bulkDeleteParticipants=b,l.deleteAllParticipantsForThread=v,l.updateParticipantTimestamps=S,l.bulkUpdateParticipantTimestamps=R,l.getParticipantsInThread=L,l.getParticipantsInThreads=E,l.getInvitedParticipantsInThread=k,l.getParticipant=I,l.bulkGetParticipants=T}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=o("MAWDbMsg").getCanonicalTsFromMsg(t),r=t.author;return r!=="@me"&&r!=="@system"?o("MAWDbParticipantTxns").updateParticipantTimestamps(e,[t.threadJid,r],n,n,n):o("MAWDexieTable").dexieResolve()}l.updateParticipantTimestampsForMsg=e}),98);
__d("MAWWriteMsgTxns",["FBLogger","MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBuildIncomingMsgs","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEphemeralMsgTxns","MAWExpiredQuoteCleaner","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWLocalizationType","MAWLocalizationUtils","MAWMessageSortOrderUtils","MAWMsgType","MAWThreadEventConst","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWUseProtocolMsgIdForMsgId","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","ODS","WAJids","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["rowId"],s,u,c;function d(e,t,n,a){var i=n.ts,l=[o("WATimeUtils").castUnixTimeToMillisTime(i),n.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN],s=l[0],u=l[1];return o("MAWGetOrCreateThreadTxns").getExistingThread(e,t.jid).then(function(t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");var i=o("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(e,t.jid),l=o("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(e,t.jid);return o("MAWDexieTable").dexieAll([i,l]).then(function(e){var r,i,l,c=e[0],d=e[1],m=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?null:d==null?1:o("MAWDbMsg").getInChatMsgIdFromMsgId(d.msgId)+1,p=o("WATimeUtils").castToMillisTime((r=d==null?void 0:d.sortOrderMs)!=null?r:0),_=s>p&&!u?s:p,f=(i=o("MAWTimeUtils").ensureValidMillisTime(t.lastReadMsgTs))!=null?i:0,g=o("WATimeUtils").castToMillisTime((l=d==null?void 0:d.sortOrderMs)!=null?l:0),h=f<g,y=n.author===o("WAJids").AUTHOR_ME||n.type===o("MAWMsgType").MSG_TYPE.ADMIN&&o("MAWLocalizationUtils").isParticipantChangeAdminMsg(n.msgContent.adminType)&&!h,C=babelHelpers.extends({},n,{msgId:m!=null?o("MAWDbMsg").craftMsgIdV2(t.chatId,m,n):o("MAWJidUtils").formatProtocolMsgIdFromMsg(n)}),b=o("MAWDbMsgTxns").calculateOldestMsg(c,d,C,a),v=b.oldestMsg;return{isOldestMsgUpdated:c!=null&&v!==c.msgId,msgId:C.msgId,prevOldestMsg:c,updatedSnippet:void 0,updatedThread:babelHelpers.extends({},t,{lastReadMsg:y?C.msgId:t.lastReadMsg,lastReadMsgTs:y?_:t.lastReadMsgTs,newestMsgTs:_,oldestMsg:v,snippetMsg:t.snippetMsg,snippetMsgTs:t.snippetMsgTs,threadOrder:o("MAWDbThread").craftThreadOrder(_,t.jid)})}})})}function m(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN&&e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION?!1:e.type===t.type&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?r:g(e,t,n)})}function p(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?((c||(c=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):g(e,t,n)})}function _(e,t,n){return e.messages.where("threadJid").equals(n.jid).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&(e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED||e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT)}).first().then(function(r){return r!=null?((c||(c=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):g(e,t,n)})}function f(e,t){return e.messages.add(t).then(function(e){return babelHelpers.extends({},t,{rowId:e})})}function g(e,t,n,r){r===void 0&&(r={});var a=r,i=a.isFirstMsg,l=i===void 0?!1:i,u=a.isOutgoing,c=u===void 0?!1:u,m=a.openMessageOtid,p=a.openMessageParticipantCount,_=a.optimisticMsg,g=a.participantCount,h=a.quotedReplyAttachmentMeta,y=a.shouldUpdateUi,C=y===void 0?!0:y,b=a.sortOrderMs;return d(e,n,t,b).then(function(n){var r=n.isOldestMsgUpdated,a=n.msgId,i=n.prevOldestMsg,u=n.updatedThread,d=babelHelpers.extends({},t,{msgId:a,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t)});return o("MAWDexieTable").dexieAll([f(e,d),e.threads.put(u),o("MAWFTSTxns").maybePutMessageToBacklog(e,d.externalId)]).then(function(e){var t=e[0],n=e[1];return c&&o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""])),t.sortOrderMs),C&&o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({dbMsg:t,isFirstMsg:l,openMessageOtid:m,openMessageParticipantCount:p,optimisticMsg:_,participantCount:g,quotedReplyAttachmentMeta:h,updatedThread:u}),t})})}function h(e,t,n){return o("MAWGetOrCreateThreadTxns").getExistingThread(e,n.jid).then(function(a){if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");return(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?o("MAWDexieTable").dexieResolve(null):o("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(e,a)).then(function(r){var i=babelHelpers.extends({},t,{msgId:r!=null?o("MAWDbMsg").craftUnrenderedMsgId(a.chatId,r):o("MAWJidUtils").formatProtocolMsgIdFromExternalId(n.jid,t.externalId)});return o("MAWDexieTable").dexieAll([e.unrenderedMessages.add(i),e.threads.put(a)]).then(function(e){var t=e[0],n=e[1];return babelHelpers.extends({},i,{rowId:t})})})})}function y(e,t,n){return o("MAWDexieTable").dexieAll([C(e,t,n),o("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(e,[[t.externalId,n.jid]]).then(function(e){return{editMsgHistories:e,originalEditMsgHistory:e.find(function(e){return e.editExternalId===t.externalId})}})]).then(function(e){var t=e[0],n=e[1],r=n.editMsgHistories,o=n.originalEditMsgHistory;return babelHelpers.extends({},t,{editMsgHistories:r,existingEditMsgHistory:o!=null?o:null})})}function C(e,t,n){var r=[t.externalId,n.jid,t.author],a=r[0],i=r[1],l=r[2];return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,a,l,i),o("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(e,a,l,i),o("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(e,i).then(function(e){return o("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(t.ts,e)})]).then(function(e){var t=e[0],n=e[1],r=e[2],o=e[3],a=e[4];return{existingMsg:t!=null?t:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:o,pendingDeleteForMeStanza:r!=null?r:null,pendingRevokedStanza:n!=null?n:null}})}function b(e,t,n,r,a){return r===void 0&&(r=!0),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,t.externalId,t.author,n.jid).then(function(i){if(i!=null)return R(e,t,n,i,!0);var l=t.author;o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""])),t.type,l,n.jid);var s=babelHelpers.extends({},babelHelpers.extends({},t,{threadJid:n.jid}));return n.folder===o("MAWFolderTypes").FOLDER_ID.OTHER&&(s.altIndex=s.altIndex===o("MAWDbMsg").FUTUREPROOF_ALT_INDEX?o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:o("MAWDbMsg").SPAM_ALT_INDEX),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(e,s,n.jid,a).then(function(t){t!=null&&(s=babelHelpers.extends({},s,{quote:t==null?void 0:t.quote,quoteExpirationTs:t==null?void 0:t.quote.content.expirationTs,quoteExternalId:t==null?void 0:t.quoteExternalId}));var a=s.quoteExpirationTs;return a!=null&&a>o("WATimeUtils").unixTime()&&o("MAWExpiredQuoteCleaner").addNewExpiredQuoteCleanerTimestamp(a),o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,n.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(e,s)]).then(function(t){var a=t[0],i=t[1],l=t[2];return g(e,s,n,{quotedReplyAttachmentMeta:i,shouldUpdateUi:r}).then(function(t){return o("MAWDexieTable").dexieAll([o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(e,s),o("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(e,t,r)]).then(function(e){var n=e[1];return a!=null&&r&&a.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,l)})}),n||t})})})})})}function v(t,n,r,a,i,l){var s=babelHelpers.extends({},babelHelpers.extends({},n,{msgId:r.msgId,protocolMsgId:r.protocolMsgId,rowId:r.rowId,serverTs:r.serverTs,sortOrderMs:r.sortOrderMs,threadJid:a.jid,ts:r.ts}));return o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(t,a.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(t,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(t,s),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(t,s,a.jid,l),o("MAWDbMsgTxns").getThreadNewestMessageId(t,a.jid)]).then(function(l){var u,c=l[0],d=l[1],m=l[2],p=l[3],_=l[4];return s=babelHelpers.extends({},s,{quote:p==null?void 0:p.quote,quoteExternalId:p==null?void 0:p.quoteExternalId}),((u=r.editCount)!=null?u:0)>0&&i!=null&&n.type===o("MAWMsgType").MSG_TYPE.TEXT?o("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(t,i,n).then(function(){return r}):t.messages.put(s).then(function(){return o("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(t,s)}).then(function(e){if(e)return s.altIndex=o("MAWDbMsg").craftToBeReadAltIndex(a.chatId),t.messages.put(s)}).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,m)}),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,d)}),o("MAWIndexedDb").afterTransactionThreadEvent({chatJid:a.jid,msgId:s.msgId},o("MAWThreadEventConst").PLACEHOLDER_CONVERT_SUBSCRIPTION),c!=null&&c.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,m)})}),s.msgId===_){var n=s,r=n.rowId,i=babelHelpers.objectWithoutPropertiesLoose(n,e);o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(t,i)}return s})})}function S(e,t,n,r){var a=o("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(t,n);return o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:a.author,chatJid:a.threadJid,externalId:a.externalId}]),h(e,a,n),e.pendingStanzas.delete(r.rowId),o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,t.externalId)]).then(function(e){var t=e[0],n=e[1];return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(a.messageDeleteForMeTs),babelHelpers.extends({},a,{msgId:n.msgId,rowId:n.rowId})})}function R(e,t,n,a,i){i===void 0&&(i=!1);var l=o("MAWDbPendingStanzaTxns").getRevokedContent(a);if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing revoked content");var s=o("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(t,n,l);return o("MAWDexieTable").dexieAll([g(e,s,n),e.pendingStanzas.delete(a.rowId)]).then(function(t){var r=t[0];return o("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(e,r,n).then(function(){return r})})}l.writeDedupedEphemeralSettingAdminMessage=m,l.writeDedupedAdminMessage=p,l.writeDedupedUsersConnectedAdminMessage=_,l.writeMsg=g,l.writeUnrenderedMsg=h,l.prepareTextMsgWriteData=y,l.prepareMsgWriteData=C,l.writeNewIncomingMsg=b,l.writeCiphertextUpdate=v,l.handleDeleteForMeMessage=S,l.handleOutOfOrderRevokedMessage=R}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});i.DbDeletedMsgReasonEnum=e}),66);
__d("MAWMediaManagerDeferred",["promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("MAWMediaManager").__setRef("MAWMediaManagerDeferred");function s(t){r("promiseDone")(e.load().then(function(e){e.getMawMediaManager().dequeueDownload(t)}))}l.dequeueDownload=s}),98);
__d("MAWUnsendMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startUnsendMsgContentCleaner=c,l.addNewUnsendMsgContentCleanerTimestamp=d,l.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWWriteDeleteMessageTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWXMAUtils","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS,s=30*o("WATimeUtils").DAY_SECONDS;function u(e,t){var n=t.protocolMsgId,r=n.author,a=n.chat,i=n.externalId;return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(e,a),e.unrenderedMessages.get({externalId:i}),o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,i)]).then(function(t){var a=t[0],l=t[1];return a.success?l!=null&&l.threadJid===a.value.jid&&l.author===r?o("WAResultOrError").makeError("duplicate_delete_for_me"):o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,n).then(function(t){if(t==null){var l={ack:o("MAWAckLevel").ACK.received,author:r,externalId:i,threadJid:a.value.jid,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},u=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s),d={deleteTs:u,externalIdWithType:i+"_"+o("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:l,type:o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return e.pendingStanzas.add(d).then(function(){return o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(u),o("WAResultOrError").makeResult()})}return o("MAWDexieTable").dexieResolve(c(e,t,r,n.chat,a.value)).then(function(){return o("WAResultOrError").makeResult()})}):o("WAResultOrError").makeError("missing_thread")})}function c(t,n,a,i,l){var s,u,c=o("MAWDexieTable").dexieResolve();o("MAWXMAUtils").isXMAStoryReply((s=n.quote)==null?void 0:s.content.xmaMessageType)&&(c=d(t,n));var p={ack:n.ack,author:a,externalId:n.externalId,mediaId:n.mediaId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e),msgContent:(u=o("MAWDbMsg").getMsgContent(n))==null?void 0:u.content,msgId:n.msgId,quote:n.quote,reportingMeta:n.reportingMeta,serverTs:void 0,threadJid:i,ts:n.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:n.xmaMessageType},_=o("MAWDexieTable").dexieAll([m(t,n.author,n.externalId,n.threadJid),o("MAWDbMsgTxns").deleteDbMsg(t,n.rowId),c]).then(function(){if(o("MAWDbMsg").isMediaMsg(n)){var e=n.mediaId,a=n.plaintextHash;e!=null&&(a!=null?(o("MAWMediaManagerDeferred").dequeueDownload(a),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:n.msgId,plaintextHash:a,threadJid:n.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:n.msgId,threadJid:n.threadJid}}))}return o("MAWDexieTable").dexieAll([o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(t,l)]).then(r("emptyFunction"))});return _.then(function(){return o("MAWDexieTable").dexieAll([t.unrenderedMessages.add(p),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(t,[{author:a,chatJid:n.threadJid,externalId:n.externalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(t,n.threadJid,n.externalId,n.author,o("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return o("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(t,l.jid,n.msgId,n.sortOrderMs).then(function(){return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(p.messageDeleteForMeTs),o("WAResultOrError").makeResult()})})})}function d(e,t){return o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(t){return o("MAWDbMsgTxns").maybeGetMsg(e,t==null?void 0:t.msgId).then(function(t){if(t!=null)return o("MAWDbMsgTxns").deleteDbMsg(e,t.rowId)})})}function m(e,t,n,r){return e.messages.where("quoteExternalId").equals(n).filter(function(e){var n;return e.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE&&((n=e.quote)==null?void 0:n.content.author)===t&&e.threadJid===r}).toArray().then(function(t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.map(function(e){return e.rowId});return o("MAWDbMsgTxns").bulkDeleteDbMsg(e,n).then(function(){return t})})}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.handleDeleteForMe=u,l.deleteXMAStoryReplyMsg=d,l.deleteBumpMsgs=m}),98);
__d("MAWWriteRevokeMessageTxns",["FBLogger","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbProtocolMsgIdMiddleware","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWWriteDeleteMessageTxns","MAWWriteMsgTxns","MAWXMAUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS,s=30*o("WATimeUtils").DAY_SECONDS;function u(e,t,n,a,i,l){if(l!=null&&a==null){var u,d=babelHelpers.extends({},t,{originalTs:o("WATimeUtils").castMilliSecondsToUnixTime(l),threadJid:n.jid,unsendMsgContentDeleteTs:(u=t.serverTs)!=null?u:t.ts});return o("MAWWriteMsgTxns").writeMsg(e,d,n).then(function(e){return e.type==="Revoked"?e:null})}var m=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s),_=t.author,f=t.externalId,g=t.revokedExternalId,h=i!=null?p(e,i):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([a==null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,t.revokedExternalId,n.jid,t.author):o("MAWDexieTable").dexieResolve(a),o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,f)]).then(function(i){var l=i[0];if((a==null||l!=null)&&r("FBLogger")("messenger_web").warn("Revoked message missing originalMsg incorrectly"),l==null){var s={deleteTs:m,externalIdWithType:g+"_"+o("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:_,externalId:f,revokedExternalId:g,threadJid:n.jid,ts:t.ts,type:"Revoked"},type:o("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return o("MAWDexieTable").dexieAll([e.pendingStanzas.add(s),h]).then(function(t){var a=t[0],i=t[1];o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(m),o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(g,r("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,n.jid),i===!0&&o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,n)})}return h.then(function(){return c(e,l,n,t.externalId,t.revokedExternalId,t.serverTs,t.ts,!1)})})}function c(t,n,r,a,i,l,s,u){var c,m=babelHelpers.extends({},n,{altIndex:void 0,externalId:a,msgContent:o("MAWDbMsg").getMsgContent(n),originalTs:(c=n.serverTs)!=null?c:n.ts,revokedExternalId:i,serverTs:l,threadJid:r.jid,ts:s,type:"Revoked",unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e)});return o("MAWDbProtocolMsgIdMiddleware").appendProtocolMsgId(m),u?o("MAWDexieTable").dexieResolve(m):d(t,n,m,r).then(function(){return m})}function d(e,t,n,r){var a,i=o("MAWXMAUtils").isXMAStoryReply((a=t.quote)==null?void 0:a.content.xmaMessageType)?o("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(e,t):o("MAWDexieTable").dexieResolve(),l=o("MAWJidUtils").toProtocolMsgId(t),s=l!=null?e.deletedMessages.add(babelHelpers.extends({},l,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(e,t.author,t.externalId,t.threadJid).then(function(){return o("MAWDexieTable").dexieAll([e.messages.put(n),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:n.author,chatJid:n.threadJid,externalId:n.revokedExternalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(e,n.threadJid,n.revokedExternalId,n.author,o("MAWMsgType").MSG_TYPE.REVOKED),i,s,o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,t.externalId)]).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(n)}),t!=null&&o("MAWDbMsg").isMediaMsg(t)){var a=t.mediaId,i=t.plaintextHash;a!=null&&(i!=null?(o("MAWMediaManagerDeferred").dequeueDownload(i),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:t.msgId,plaintextHash:i,threadJid:t.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:t.msgId,threadJid:t.threadJid}}))}return o("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(t),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,r)})})}function m(e,t,n){if(t.type!==o("MAWMsgType").MSG_TYPE.REVOKED)throw r("FBLogger")("messenger_web").mustfixThrow("Cant mark unrevoked message revoked");var a=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.revokedExternalId),i=a!=null?e.deletedMessages.add(babelHelpers.extends({},a,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(e,t.author,t.revokedExternalId,t.threadJid).then(function(r){return r.length>0&&o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,r)}),o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:t.author,chatJid:t.threadJid,externalId:t.revokedExternalId}]),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,n),i]).then(function(){o("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(t.unsendMsgContentDeleteTs),o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t)})})})}function p(e,t){return t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?e.messages.delete(t.rowId).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,[t])}),!0}):o("MAWDexieTable").dexieResolve(!1)}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.writeIncomingRevokeMsg=u,l.revokeUnstoredMsg=c,l.markExistingMsgRevoked=d,l.markIncomingMessageRevoked=m}),98);
__d("WASortedLists",[],(function(t,n,r,o,a,i){"use strict";function e(){return[]}function l(){return[]}function s(e,t){return e.filter(t)}function u(e,t){return g(e.map(t))}function c(e,t){for(var n=e.length===t.length,r=0;n&&r<e.length;r++)e[r]!==t[r]&&(n=!1);return n}function d(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return e;return e.concat([t]).sort()}function m(e,t){if(e.length<t.length)return!1;for(var n=!0,r=0,o=0;n&&o<t.length;o++)do n=e[r]===t[o];while(!n&&++r<e.length);return n}function p(e,t){for(var n=[],r=0,o=0;r<e.length;r++){for(var a=e[r];o<t.length&&a>t[o];)o++;(o===t.length||a<t[o])&&n.push(a)}return n}function _(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;){var a=e[r],i=t[o];a<i?r++:(a===i&&(n.push(a),r++),o++)}return n}function f(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;)e[r]<t[o]?n.push(e[r++]):e[r]===t[o]?(n.push(e[r++]),o++):n.push(t[o++]);for(;r<e.length;)n.push(e[r++]);for(;o<t.length;)n.push(t[o++]);return n}function g(e){return h(e.slice().sort())}function h(e){for(var t=!1,n=0;n<e.length-1;n++)e[n]===e[n+1]&&(t=!0);if(!t)return e;for(var r=[],o=0;o<e.length-1;o++)e[o]!==e[o+1]&&r.push(e[o]);return r.push(e[e.length-1]),r}function y(e){return Array.from(e).sort()}function C(e){return e.slice().sort()}function b(e,t,n){for(var r=null,o=0;!r&&o<e.length;o++)e[o]===t&&(r=e.slice(),r[o]=n,r=h(r.sort()));return r||e}function v(e){return[e]}function S(e){return e.length<1}function R(e,t,n){return e.slice(t,n)}i.emptySet=e,i.emptyList=l,i.filter=s,i.map=u,i.areEqual=c,i.addToSet=d,i.contains=m,i.subtract=p,i.intersect=_,i.joinUniq=f,i.sortAndDedupe=g,i.asSortedSet=y,i.sort=C,i.swapIn=b,i.singleElement=v,i.isEmpty=S,i.slice=R}),66);
__d("MAWMediaManagementTxns",["EBLogger","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWODSProxy","MAWSupportedDocumentTypes","MAWWriteMsgTxns","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaUtils","WAOdsEnums","WASortedLists","WATimeUtils","emptyFunction","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=o("MWFBLogger").MWMediaLogger().tags(["MAWMediaManagementTxns"]),h=r("gkx")("23924");function y(e,t,n,r){var a,i=n==null||t.type===o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(h||!o("MAWSupportedDocumentTypes").isAllowedType((a=n.validatedDocumentFileInfo)==null?void 0:a.filename));return o("MAWWriteMsgTxns").prepareMsgWriteData(e,t,r).then(function(e){return babelHelpers.extends({},e,{shouldDropDocument:i})})}function C(e,t,n,r,a){a===void 0&&(a=!1);var i={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},l=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),s=l.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(l.objectId):null;return R(e,n,r,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,i,s,void 0,a,void 0,t.accessibilitySummaryText)}function b(e,t,n,r,a,i,l){a===void 0&&(a=!1),l===void 0&&(l=!0);var s=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),u=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),c=u.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(u.objectId):null;return o("MAWDexieTable").dexieAll([L(e,n,r,c,void 0,a),o("MAWDbChunkTxns").hasMediaChunk(e,s)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,i,l,o)})}function v(e,t,n,r,a,i,l,s){a===void 0&&(a=!1),i===void 0&&(i=!1),s===void 0&&(s=!0);var u={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},c=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),d=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),m=d.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(d.objectId):null;return o("MAWDexieTable").dexieAll([S(e,n,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,u,m,void 0,a,t.accessibilitySummaryText),o("MAWDbChunkTxns").hasMediaChunk(e,c)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,l,s,o)})}function S(e,t,n,r,o,a,i,l,s,u,c){return u===void 0&&(u=!1),R(e,t.msgId,t.type,n,r,o,a,i,l,s,u,void 0,c).then(function(n){return L(e,t,n,l,void 0,u)})}function R(t,n,r,a,i,l,d,m,p,_,f,h,y){return f===void 0&&(f=!1),h===void 0&&(h=0),y===void 0&&(y=null),o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(t,a).then(function(C){var b=new Map(C==null?void 0:C.mediaEntries),v=x(d,p,_);if(v!=null&&b.set(n,v),C){var S;h>0&&g.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(a)),C.msgIds||g.mustfix("Media missing msgIds: media type=%s",C.mediaType),C.mediaType||g.mustfix("Media missing mediaType: type=%s ; msg type=%s",i,r);var L=babelHelpers.extends({},C,m,{accessibilitySummaryText:y!=null?y:void 0,mediaEntries:b,mediaType:(S=C.mediaType)!=null?S:i,msgIds:o("WASortedLists").addToSet(C.msgIds||o("WASortedLists").emptySet(),n)});return t.media.put(L).then(function(){return L})}else{var E=o("MAWMediaUtils").genHMACPlaintextHash(a),k=babelHelpers.extends({accessibilitySummaryText:y!=null?y:void 0,fbid:_!=null?_:void 0,hashedPlaintextHash:E,mediaEntries:b,mediaType:i,msgIds:o("WASortedLists").singleElement(n),objectId:p!=null?p:void 0,plaintextHash:a,size:l,ts:o("WATimeUtils").unixTime()},m);return t.media.add(k).then(function(e){return babelHelpers.extends({},k,{mediaId:e})}).catch(function(e){var C=o("WAErrorMessage").maybeGetMessageFromError(e);if(h>0)throw g.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry: plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),g.catching(e).MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry."]))),e;return g.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_MEDIA,key:"retry"}),R(t,n,r,a,i,l,d,m,p,_,f,h+1,y)})}})}function L(e,t,n,r,a,i){i===void 0&&(i=!1);var l=i?o("MAWDexieTable").dexieResolve():o("MAWDbMsgTxns").updateMediaId(e,t,n.mediaId,n.plaintextHash);return l.then(function(){return o("MAWMediaBackupTxns").linkMediaBackup(e,n.mediaId,t.msgId,r,a).then(function(){return n})})}function E(e,t,n,r,a,i,l){return r===void 0&&(r=!1),i===void 0&&(i=!0),o("EBLogger").EBLogger().tags(["restore","handleUnstoredDbMedia"]).DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Inserted media with plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(n.plaintextHash)),t.type!==o("MAWMsgType").MSG_TYPE.REVOKED&&!r&&i?o("MAWMediaAfterTxns").handleNewMediaAfterTxn(t,n,l,e,void 0,a).then(function(){return n}):o("MAWDexieTable").dexieResolve(n)}var k=function(t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n).then(function(e){if(e==null)throw g.mustfixThrow("Do not have the media message in db when attachHashToMediaMsg");return S(t,e,r,l,s,m,u,a,i,c,d)})},I=function(t,n,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=babelHelpers.extends({},e);return a.validatedAudioInfo!=null&&(n.validatedAudioInfo=babelHelpers.extends({},e.validatedAudioInfo,a.validatedAudioInfo)),a.validatedVideoInfo!=null&&(n.validatedVideoInfo=babelHelpers.extends({},e.validatedVideoInfo,a.validatedVideoInfo)),a.validatedImageInfo!=null&&(n.validatedImageInfo=babelHelpers.extends({},e.validatedImageInfo,a.validatedImageInfo)),a.validatedDocumentFileInfo!=null&&(n.validatedDocumentFileInfo=babelHelpers.extends({},e.validatedDocumentFileInfo,a.validatedDocumentFileInfo)),t.media.update(n.mediaId,n).then(r("emptyFunction"))}else g.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"])))})},T=function(t,n,r,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=a?e.mediaEntries.set(r,a):e.mediaEntries,i=babelHelpers.extends({},e,{mediaEntries:n});return t.media.update(i.mediaId,i)}else return g.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]))),o("MAWDexieTable").dexieResolve()})};function D(e,t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDexieTable").dexieAll([k(e,t,r,a,i,l,u.size,s,c,d,m),o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(e,r,n,u.type)]).then(function(e){var t=e[0];return t})}function x(e,t,n){var r,a=e;return a!=null&&t!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(r,t)),a!=null&&n!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(r,n)),a}function $(e,t,n){var r=new Map;return e.mediaEntries.forEach(function(e,a){var i=o("WAMediaUtils").decodeMediaEntryData(e),l=i.objectId===t?o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(i,n):e;r.set(a,l)}),r}function P(e,t,n,r,a){a===void 0&&(a=!0);var i=new Map;return t.forEach(function(e){var t,n=(t=i.get(e.hashedPlaintextHash))!=null?t:[];n.push(e),i.set(e.hashedPlaintextHash,n)}),o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,[].concat(Array.from(i.keys()))).then(function(l){var s=new Map(l.map(function(e){return[e.hashedPlaintextHash,e]})),u=new Map;t.forEach(function(e){var t=s.get(e.hashedPlaintextHash);if(e!=null){var n=x(e==null?void 0:e.entry,e==null?void 0:e.objectId,e==null?void 0:e.fbId);if(t){var r=n?t.mediaEntries.set(e.msgId,n):t.mediaEntries,a=babelHelpers.extends({},t,{mediaEntries:r,msgIds:o("WASortedLists").addToSet(t.msgIds,e.msgId)});s.set(e.hashedPlaintextHash,a)}else B(u,e,n)}});var c=new Map,d=new Map,m=Array.from(u.values()).filter(function(e){return N(e,c,d)});return o("MAWDexieTable").dexieAll([e.media.bulkAdd(m),e.media.bulkPut(Array.from(s.values()))]).then(function(){return M(e,[].concat(Array.from(i.keys())),i,n,r,a)})})}function N(e,t,n){if(e.objectId!=null){var r=t.get(e.objectId);if(r!=null&&r!==e.hashedPlaintextHash)return g.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""])),e.objectId,r,e.hashedPlaintextHash),!1}if(e.fbid!=null){var o=n.get(e.fbid);if(o!=null&&o!==e.hashedPlaintextHash)return g.MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""])),e.fbid,o,e.hashedPlaintextHash),!1}return e.objectId!=null&&t.set(e.objectId,e.hashedPlaintextHash),e.fbid!=null&&n.set(e.fbid,e.hashedPlaintextHash),!0}function M(e,t,n,r,a,i){return o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,t).then(function(t){return o("MAWDexieTable").dexieAll([F(e,t,n)]).then(function(){return i&&w(t,n,r,e,a),t})})}function w(e,t,n,a,i){e.forEach(function(e){var l=t.get(e.hashedPlaintextHash);l!=null&&!A(l)&&r("promiseDone")(o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(a.messages.where("msgId").anyOf(e.msgIds).toArray().then(function(t){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(t),l=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(t,n),hasMediaForUI:!1,hdTypes:r,media:e,transportKey:i});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,l)})))})}function A(e){return e.reduce(function(e,t){return e||t.isXMAShare},!1)}function F(e,t,n){var r=t.reduce(function(e,t){var r;return(r=n.get(t.hashedPlaintextHash))==null||r.filter(function(e){return e!=null&&!e.isXMAShare}).forEach(function(n){return e.set(n.msgId,t.mediaId)}),e},new Map);return o("MAWDbMsgTxns").bulkUpdateMediaId(e,r)}function O(e,t){var n,r,a=e?new Map([[t.msgId,e]]):new Map;return babelHelpers.extends({fbid:(n=t.fbId)!=null?n:void 0,hashedPlaintextHash:t.hashedPlaintextHash,mediaEntries:a,mediaType:t.mediaType,msgIds:o("WASortedLists").singleElement(t.msgId),objectId:(r=t.objectId)!=null?r:void 0,plaintextHash:t.plaintextHash,size:t.size,ts:o("WATimeUtils").unixTime()},t.mediaInfo)}function B(e,t,n){var r=e.get(t.hashedPlaintextHash);r==null?e.set(t.hashedPlaintextHash,O(n,t)):(n!=null&&r.mediaEntries.set(t.msgId,n),r.msgIds.push(t.msgId))}l.prepareMediaWriteData=y,l.handleUnstoredDbMediaCreation=C,l.handleUnstoredDbMediaLinking=b,l.handleUnstoredDbMedia=v,l.linkMedia=S,l.createOrUpdateMediaRow=R,l.attachHashToMediaMsg=k,l.updateMediaEntryWithValidatedMediaInfo=I,l.updateMediaWithEncodedMediaEntryData=T,l.attachHashAndSaveMedia=D,l.updateBackupFbidInMediaEntries=$,l.bulkLinkMedia=P,l.linkMessageAndMediaBackupForMediaList=M}),98);
__d("MAWMediaRetryInfo",[],(function(t,n,r,o,a,i){"use strict";var e=new Map;function l(t,n){e.set(t,n)}function s(t){return e.get(t)}function u(t){e.has(t)&&e.delete(t)}i.setRetriedMediaInfo=l,i.getRetriedMediaInfo=s,i.clearRetriedMediaInfo=u}),66);
__d("WAAPI",["cr:21048"],(function(t,n,r,o,a,i,l){"use strict";l.default=n("cr:21048")}),98);
__d("WAGetAgeBucketForMediaKeyTimestamp",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e==null)return"Missing";if(o("WATimeUtils").isInFuture(e))switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day in future";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days in future";default:return"> 7 days in future"}switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days";case o("WATimeUtils").happenedWithin(e,14*o("WATimeUtils").DAY_SECONDS):return"7-14 days";case o("WATimeUtils").happenedWithin(e,21*o("WATimeUtils").DAY_SECONDS):return"14-21 days";case o("WATimeUtils").happenedWithin(e,30*o("WATimeUtils").DAY_SECONDS):return"21-30 days";case o("WATimeUtils").happenedWithin(e,40*o("WATimeUtils").DAY_SECONDS):return"30-40 days";case o("WATimeUtils").happenedWithin(e,50*o("WATimeUtils").DAY_SECONDS):return"40-50 days";case o("WATimeUtils").happenedWithin(e,60*o("WATimeUtils").DAY_SECONDS):return"50-60 days";default:return"> 60 days"}}l.getAgeBucketForMediaKeyTimestamp=e}),98);
__d("WAIsMediaExpiredError",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){switch(t){case"signature-expired":return!0;case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return!1;default:return!0}};i.isMediaExpiredError=e}),66);
__d("WAStartMediaDownloadQplFlow",["QPLFlow","WAGetPlatformFromStanzaId","WAGetStorageQplAnnotations","WAJids","WAMediaUtils","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=6e5;function s(t){var n=t.downloadEntry,a=t.isPreview,i=t.msgType,l=t.protocolMsgId,s=t.triggerUIView,u=t.xmaMediaType,c=o("QPLFlow").startQPLFlow(r("qpl")._(25312150,"83"),{annotations:{bool:{isTransformStreamSupported:o("WAMediaUtils").isTransformStreamSupported()},string:{chat_type:l==null?null:o("WAJids").switchOnMsgrChatJidType(l.chat,{group:function(){return"group"},user:function(){return"user"}}),downloadEntry:a===!0?n+"-preview":n,e2eePlatform:l==null?null:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(l.externalId),msgType:i,trigger_ui_view:s,xmaMediaType:u!=null?u:void 0}},timeoutInMs:e});return o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){c.addAnnotations(e)}),babelHelpers.extends({},c,{downloadEntry:n,triggerUIView:s})}l.QPL_MEDIA_DOWNLOAD_TIMEOUT_IN_MS=e,l.startMediaDownloadQplFlow=s}),98);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EBLogger","EchoMessage","EchoMessageMediaFieldUtils","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWEncodeMediaTransportProtocol","MAWFrontendMediaUtils","MAWGetMsgForProtocolMsgIdTxn","MAWHandleMediaDownloadApi","MAWIndexedDb","MAWJids","MAWJobDefinitions","MAWJobManager","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWSupportedDocumentTypes","MAWTransactionMode","Promise","WAAPI","WAArmadilloXMA.pb","WABase64","WAGetAgeBucketForMediaKeyTimestamp","WAGetStorageQplAnnotations","WAHashUtils","WAIsMediaExpiredError","WAJids","WAJobOrchestratorTypes","WAMediaUtils","WAStartMediaDownloadQplFlow","WATimeUtils","asyncToGeneratorRuntime","cr:10071","getErrorSafe","gkx","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O,B,W,q,U,V,H=o("EBLogger").EBLogger().tags(["restore"]);function G(e){var t=X(e);return t.then(function(t){var r=new Map;return e.forEach(function(e){var n=t.get(e),o=n==null?void 0:n.blobData;r.set(e,o)}),(V||(V=n("Promise"))).resolve(r)})}function z(e){return e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG?"image/jpeg":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG?"image/png":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER?"image/webp":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF?"image/gif":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4?"audio/mp4":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV?"audio/wav":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA?"xma":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}function j(e,t,n){return K.apply(this,arguments)}function K(){return K=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a){if(e.length===0)return(V||(V=n("Promise"))).resolve();var i=[],l=[],s=new Map,u=new Map;e.map(function(e){var t,a=e.mediaData,c=e.messageTimestamp,d=J(a.plaintextHash),m=a.attachmentObjectId,p=a.attachmentType,_=a.backupEntFbid,f=a.directPath,g=a.filename,h=a.height,y=a.mediaContentType,D=a.mediaKeyTimestamp,x=a.mediaPlayableDuration,$=a.previewContentHeight,P=a.previewContentType,N=a.previewContentWidth,M=a.size,w=a.width,A=o("WAHashUtils").stringToPlaintextHash(d),F=o("MAWMediaUtils").genHMACPlaintextHash(A);l.push(F);var O=y!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(y,e.isXMA):P!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(z(P)):null;if(O==null)return H.DEBUG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null, msg id: ",""])),e.externalId),H.MUSTFIX(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null"]))),(V||(V=n("Promise"))).resolve();if(p===o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!o("MAWSupportedDocumentTypes").isAllowedType(g))return H.DEBUG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - document extension is disallowed, msg id: ",""])),e.externalId),(V||(V=n("Promise"))).resolve();var B=e.mediaData.encryptedHash;if(B==null)return H.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null, msg id: ",""])),e.externalId),H.MUSTFIX(R||(R=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null"]))),(V||(V=n("Promise"))).resolve();var W=e.mediaData.mediaKey;if(W==null)return H.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null, msg id: ",""])),e.externalId),H.MUSTFIX(E||(E=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null"]))),(V||(V=n("Promise"))).resolve();var q=O.mediaType,U=O.serverMediaType,G=o("WAMediaUtils").stringToDeliveryObjectId(m),j=_!=null?o("WAMediaUtils").stringToBackupEntFbid(_):void 0,K=e.threadJId,Q=Z({filename:g,height:h,mediaPlayableDuration:x,mediaType:q,previewContentHeight:$,previewContentWidth:N,width:w});u.set(G,{filename:g,height:h,mediaPlayableDuration:x,mediaType:q,messageTimestamp:c,plaintextHash:A,previewContentHeight:$,previewContentWidth:N,serverMediaType:U,threadJId:K,width:w});var X=null;if(e.previewMediaData!=null)try{X=te(e.previewMediaData),X!=null&&X.objectId==null&&H.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["downloadableThumbnail was created without metadata, source: echo"])))}catch(t){var Y=r("getErrorSafe")(t);H.catching(Y).DEBUG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData, msg id: ",""])),e.externalId),H.catching(Y).MUSTFIX(T||(T=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData"])))}if(B!=null){var ne=ee(d,B,W,f,D,U,g,j,G,X,M);i.push({entry:ne,fbId:j,hashedPlaintextHash:F,isXMAShare:e.isXMA,mediaInfo:Q,mediaType:q,msgId:e.msgId,objectId:G,plaintextHash:A,size:M!=null?M:0})}var re=(t=s.get(F))!=null?t:[];re.push(e),s.set(F,re)});var c=a!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,d=yield Q(i,t,c),m=yield G(l),p=[];m.forEach(function(e,n){var l=s.get(n);l==null||l.forEach(function(l){if(l!=null){if(e!=null){H.DEBUG(D||(D=babelHelpers.taggedTemplateLiteralLoose(["media for message: "," is already downloaded on the device"])),l.externalId);var s=d.find(function(e){return e.plaintextHash===l.mediaData.plaintextHash});if(s==null){H.DEBUG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message with mediaKey ",""])),l.mediaData.mediaKey);return}return Y(s.msgIds).then(function(e){var n=e.filter(function(e){return o("MAWDbMsg").isMediaMsg(e)});if(n.length>0){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(n),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:l.threadJId,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(n,t),hasMediaForUI:!0,hdTypes:r,media:s,transportKey:"EncryptedBackups"}),i=o("MAWMediaUtils").annotateBridgeMediaForDisplay(a,n);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:i}]})}})}var c=u.get(o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId));if(!(l==null||c==null)){var m=c.filename,_=c.height,f=c.mediaPlayableDuration,g=c.mediaType,h=c.messageTimestamp,y=c.plaintextHash,C=c.previewContentHeight,b=c.previewContentWidth,v=c.serverMediaType,S=c.threadJId,R=c.width,L=o("WAJids").extractUserId(o("MAWJids").toUserJid(l.threadJId)),E=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(v,l.isXMA);if(E!=null){var k={attachmentObjectId:o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId),mediaType:E,messageId:l.externalId,messageTimeStamp:l.messageTimestamp,msgId:l.msgId,plaintextHash:y,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,threadId:L,threadJid:S},I=i.find(function(e){return e.hashedPlaintextHash===n}),T=I==null?void 0:I.entry;if(T==null){H.DEBUG($||($=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message, plaintextHash: ",", msg id: ",""])),o("WAHashUtils").sanitisePlaintextHash(o("WAHashUtils").stringToPlaintextHash(l.mediaData.plaintextHash)),l.externalId),H.MUSTFIX(P||(P=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message"])));return}if(a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)return;var N=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:{author:l.author,chat:l.threadJId,externalId:l.externalId},triggerUIView:null});p.push(ne({author:l.author,directPath:l.mediaData.directPath,echoMsg:l.echoMsg,externalId:l.externalId,filename:m,hashedPlaintextHash:n,height:_,isXMA:l.isXMA,mediaPlayableDuration:f,mediaType:g,messageTimestamp:h,plaintextHash:y,previewContentHeight:C,previewContentWidth:b,threadJId:S,width:R},void 0,k,void 0,o("WAMediaUtils").decodeMediaEntryData(T),N))}}}})}),yield(V||(V=n("Promise"))).all(p)}),K.apply(this,arguments)}var Q=(q=o("MAWIndexedDb")).makeMsgrTransactor({media:(U=o("MAWTransactionMode")).READWRITE,mediaBackup:U.READWRITE,messages:U.READWRITE},"restoreLinkMedias",function(e){return(function(t,n,r){return o("MAWMediaManagementTxns").bulkLinkMedia(e,t,n,"EncryptedBackups",r)})}),X=q.makeMsgrTransactor({chunk:U.READONLY},"getChunksByHash",function(e){return function(t){return o("MAWDbChunkTxns").maybeBulkGetChunksFromHash(e,t)}}),Y=q.makeMsgrTransactor({messages:U.READONLY},"getMessagesForMsgIds",function(e){return function(t){return e.messages.where("msgId").anyOf(t).toArray()}});function J(e){if(e.endsWith("="))for(var t="",n=0;n<e.length;n++){var r=e.charAt(n);if(r==="=")return t;t+=r}return e}function Z(e){var t=e.height,n=e.mediaType,r=e.width,a=e.previewContentHeight,i=e.previewContentWidth,l=e.mediaPlayableDuration,s=e.filename;return{validatedAudioInfo:n==="Ptt"&&l!=null?{duration:ae(l),mimetype:o("MAWEncodeMediaTransportProtocol").AUDIO_WAV_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:n==="DocumentFile"?{filename:s,mimetype:o("MAWEncodeMediaTransportProtocol").FILE_MIME_TYPE}:null,validatedImageInfo:n==="Image"?{height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,width:r}:n==="Gif"||n==="Sticker"?{height:t,jpegThumbnailHeight:t,jpegThumbnailWidth:r,width:r}:null,validatedVideoInfo:n==="Video"?{duration:l,height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,mimetype:o("MAWEncodeMediaTransportProtocol").VIDEO_MIME_TYPE,width:r}:null}}function ee(e,t,n,r,a,i,l,s,u,c,d){var m=o("WABase64").decodeB64UrlSafe(e,!0),p=o("WABase64").decodeB64UrlSafe(t,!0),_=o("WABase64").decodeB64UrlSafe(n,!0);return o("WAMediaUtils").rawDataToMediaEntry({directPath:r,downloadableThumbnail:c!=null?c:void 0,fbid:s!=null?s:void 0,fileEncSha256:p,filename:l,fileSha256:m,mediaKey:_,mediaKeyTimestamp:a!=null?o("WATimeUtils").castToUnixTime(a):void 0,objectId:u!=null?u:void 0,serverMediaType:i,size:d!=null?d:void 0})}function te(t){var n=t.attachmentObjectId,r=t.directPath,a=t.encryptedHash,i=t.mediaKey,l=t.mediaKeyTimestamp,s=t.plaintextHash;if(a==null){H.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"])));return}else{var u=l!=null?o("WATimeUtils").castToUnixTime(l):void 0,c=i!=null?o("WAMediaUtils").castToMediaKey(o("WABase64").decodeB64UrlSafe(i,!0)):void 0,d=o("WABase64").decodeB64UrlSafe(s,!0),m=o("WABase64").decodeB64UrlSafe(a,!0);return{directPath:r,fileEncSha256:m,fileSha256:d,mediaKey:c,mediaKeyTimestamp:u,objectId:n}}}var ne=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a,i,l){var g,h,y,C,b,v;H.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start media download from whatsapp infra. traceId: ",""])),t);var S=e.author,R=e.externalId,L=e.filename,E=e.hashedPlaintextHash,k=e.height,I=e.mediaPlayableDuration,T=e.mediaType,D=e.messageTimestamp,x=e.plaintextHash,$=e.previewContentHeight,P=e.previewContentWidth,N=e.threadJId,M=e.width,w={author:S,chat:N,externalId:R},A=l!=null?l:o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:w,triggerUIView:null});o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore",hash:x,status:r("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});var F=((g=(h=o("MAWMediaRetryInfo").getRetriedMediaInfo(R))==null?void 0:h.isXMA)!=null?g:!1)||((y=e==null?void 0:e.isXMA)!=null?y:!1),O=((C=o("MAWMediaRetryInfo").getRetriedMediaInfo(R))==null||(C=C.echoMsg)==null?void 0:C.serializationOrigin)||(e==null||(b=e.echoMsg)==null?void 0:b.serializationOrigin)||o("EchoMessage").EchoSerializationOriginType.UNKNOWN,B=r("gkx")("23960");if(A.addPoint("download_media_start",{bool:{isEBDownloadEnforced:n==null&&B,isRetryFromMI:n==null,isXMA:F,pathMismatch:a!==i.directPath},int:{mediaEntrySize:i.size},string:{oldDirectPath:(v=e==null?void 0:e.oldDirectPath)!=null?v:"",origin:O,restorationCdnUrl:a!=null?a:""}}),o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){A.addAnnotations(e)}),n!=null&&B)return H.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["downloading media from MI directly. externalId ","."])),w.externalId),le({decodedMediaEntry:i,isEBDownloadEnforced:B,mediaDownloadRequest:e,protocolMsgId:w,retryPayload:n});var W=o("WAMediaUtils").validateDecodedMediaEntryForDownload(i);if(!W.success){H.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. externalId ",". traceId: ",". error: ","."])),w.externalId,t,W.error),H.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. error: ","."])),W.error),A.endFail("download_media_fail",{string:{failReason:W.error}});return}var q=yield r("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:A,hash:x,mediaEntry:W.value});if(q.success){A.addPoint("download_media_end");var U=q.value,V=U.mimeType,G=U.plaintext;yield o("MAWHandleMediaDownloadApi").handleMediaDownload(x,V,G,w),o("MAWMediaRetryInfo").clearRetriedMediaInfo(R);var z=Z({filename:L,height:k,mediaPlayableDuration:I,mediaType:T,previewContentHeight:$,previewContentWidth:P,width:M});yield oe(E,z),H.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["media download complete. externalId ",". traceId: ",""])),w.externalId,t),A.endSuccess(),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore_success",hash:x,status:r("MAWMediaDownloadStatus").SUCCESS,type:"main"})}else{var j=q.error;if(o("WAIsMediaExpiredError").isMediaExpiredError(j)&&n)A.addPoint("eb_resign_requested"),A.endSuccess(),H.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Retry download media as signature has expired and should be renewed. externalId ",". traceId: ",""])),w.externalId,t),yield le({decodedMediaEntry:i,isEBDownloadEnforced:!1,mediaDownloadRequest:e,protocolMsgId:w,retryPayload:n});else{H.DEBUG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: "," "," when downloading. Message timestamp: ",". traceId: ",""])),R,j,D,t),H.MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: ",""])),j);var K={string:{directPath:i.directPath,error:"media_download_failure",restorationCdnUrl:a!=null?a:""}};A.endFail(j,K),o("MAWMediaRetryInfo").clearRetriedMediaInfo(R),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:j,hash:x,status:o("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(j),type:"main"})}}});return function(n,r,o,a,i,l){return e.apply(this,arguments)}})(),re=q.makeMsgrTransactor({media:U.READONLY,mediaBackup:U.READONLY,messages:U.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(e){return(function(t,n,r){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,n.plaintextHash).then(function(a){if(a){H.DEBUG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["start resign cdn url through sproc"])));var i=ue(a,n.attachmentObjectId);return o("MAWDbMsgTxns").getMsgsByMsgIds(e,i).then(function(e){var i,l=e.find(function(e){return e.externalId===t});r.addPoint("resign_cdn_url_bridge_call",{bool:{isForwarded:(i=l==null?void 0:l.isForwarded)!=null?i:!1},int:{duplicateMsgsCount:e.length,msgXMAType:l==null?void 0:l.xmaMessageType,totalMediaEntries:a.mediaEntries.size},int_array:{duplicateXMATypes:e.map(function(e){var t;return(t=e.xmaMessageType)!=null?t:0})},string:{msgType:l==null?void 0:l.type},string_array:{duplicateMsgs:e.map(function(e){return e.externalId}),duplicateMsgTypes:e.map(function(e){return e.type})}}),o("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:n.attachmentObjectId,mediaType:n.mediaType,messageId:t,msgId:n.msgId,plaintextHash:n.plaintextHash,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:n.messageTimeStamp,threadId:n.threadId,threadJid:n.threadJid,traceId:r.getQPLAttrs().instanceKey}})})}else H.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ",". traceId: ",""])),t,r.getQPLAttrs().instanceKey),H.MUSTFIX(y||(y=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ","."])),t),r.endFail("missing-media")})})}),oe=q.makeMsgrTransactor({media:U.READWRITE,messages:U.READWRITE},"updateMediaWithDownloadedChunkBlob",function(e){return(function(t,n){return o("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(e,t,n)})});function ae(e){var t=Math.floor(e/1e3);return t>0?t:e}function ie(e){return e==null?!1:e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY||e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION}function le(e){return se.apply(this,arguments)}function se(){return se=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,a=e.decodedMediaEntry,i=e.isEBDownloadEnforced,l=e.mediaDownloadRequest,s=e.protocolMsgId,u=e.retryPayload,c=yield o("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn(s);if(c.success===!0&&ie(c.value.xmaMessageType))return H.DEBUG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Skipping media restore for expirable XMA. externalId ",". xmamessageType: ",""])),s.externalId,c.value.xmaMessageType),(V||(V=n("Promise"))).resolve();var d=s.externalId;o("MAWMediaRetryInfo").setRetriedMediaInfo(s.externalId,l);var m=((t=a.mediaKeyTimestamp)!=null?t:0)>1725105600,p={bool:{is_after_S441705_fix:m,isEBDownloadEnforced:i},int:{mediaKeyTimestamp:a.mediaKeyTimestamp},string:{externalId:d,mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(a.mediaKeyTimestamp),mediaType:u.mediaType,objectId:u.attachmentObjectId,restoreEntry:"EB",restoreMethod:n("cr:10071")==null?"sproc":"gql"}},_=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:s,triggerUIView:null});_.addAnnotations(p),H.DEBUG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["start restore media from backup. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey);var f=a.mediaKey;if(f==null){H.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["media key is missing from media entry. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),_.endFail("missing-media-key");return}return n("cr:10071")!=null?(H.DEBUG(A||(A=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [gql]. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:s.chat,deliveryObjectId:u.attachmentObjectId,externalId:d,mediaKey:f,mediaType:u.mediaType,sortOrderMs:u.messageTimeStamp}).then(function(e){if(r("vulture")("zP4BquwZMLWLp2xHPcGqA0y9_YQ="),e.success===!1){H.DEBUG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". hash: ",". externalId ",""])),e.error,o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d),_.endFail(e.error);return}H.DEBUG(O||(O=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. hash: ",". externalId ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d);var t=o("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:u.attachmentObjectId,msgId:u.msgId,plaintextHash:u.plaintextHash,restorationCdnUrl:e.value,scheduleConfig:{priority:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW},traceId:_.getQPLAttrs().instanceKey});return o("MAWJobManager").getJobManager().fireAndForget(t)}).catch(function(e){var t=r("getErrorSafe")(e);H.catching(t).MUSTFIX(B||(B=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error"]))),_.endFail("runtime-error",{string:{restoreError:t.toString()}})})):(H.DEBUG(W||(W=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [sproc]. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),re(d,u,_))}),se.apply(this,arguments)}function ue(e,t){var n,r=[];return(n=e.mediaEntries)==null||n.forEach(function(e,n){var a=o("WAMediaUtils").decodeMediaEntryData(e);a.objectId===t&&r.push(n)}),r}l.downloadMediaAndWriteToMediaStore=j,l.getBase64WithoutPadding=J,l.getMediaInfo=Z,l.constructMediaEntry=ee,l.constructRawDownloadableThumbnail=te,l.handleDownloadMedia=ne,l.invokeRestoreAccessCheckSprocToDownloadAttachment=re}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EBLogger","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWEBRestoreTrackingUtils","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("EBLogger").EBLogger().tags(["restore"]),g=n("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function h(t,n){var r=n==null?f:f.tags([n]),a=t.contentType;switch(a){case o("EchoMessage").EchoMessageContentType.TEXT:return t.xContentType===o("EchoMessage").EchoXMessageContentType.BUMP?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE):o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.TEXT);case o("EchoMessage").EchoMessageContentType.MEDIA:return t.receiverFetchId!=null&&t.receiverFetchData!=null?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH):t.mediaData==null?o("WAResultOrError").makeError("media_mandatory_fields_missing"):o("WAResultOrError").makeResult(y(t.mediaData));case o("EchoMessage").EchoMessageContentType.PLACEHOLDER:return t.contentSubtype===o("EchoMessage").EchoMessageContentSubtype.UNSEND?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.REVOKED):(r.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""])),o("EchoMessage").EchoMessageContentType.getName(a),t.xContentType!=null?o("EchoMessage").EchoXMessageContentType.getName(t.xContentType):"unknown",o("EchoMessage").EchoMessageContentSubtype.getName(t.contentSubtype),t.serializationOrigin!=null?o("EchoMessage").EchoSerializationOriginType.getName(t.serializationOrigin):"unknown"),o("WAResultOrError").makeError("unsupported_message_type"));case o("EchoMessage").EchoMessageContentType.XMA:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.XMA);case o("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.CIPHERTEXT);default:return r.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",""])),o("EchoMessage").EchoMessageContentType.getName(a)),o("WAResultOrError").makeError("unsupported_message_type")}}function y(e){switch(e.attachmentType){case o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return o("MAWMsgType").MSG_TYPE.IMAGE;case o("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return o("MAWMsgType").MSG_TYPE.STICKER;case o("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return o("MAWMsgType").MSG_TYPE.VIDEO;case o("EchoMessageMediaFieldUtils").AttachmentType.GIF:return o("MAWMsgType").MSG_TYPE.GIF;case o("EchoMessageMediaFieldUtils").AttachmentType.PTT:return o("MAWMsgType").MSG_TYPE.PTT;case o("EchoMessageMediaFieldUtils").AttachmentType.XMA:return o("MAWMsgType").MSG_TYPE.XMA;case o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}}function C(e,t,n,r,a,i){var l,s=e.from;if(s==null)return f.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Author info is missing from msg: ",""])),r),o("WAResultOrError").makeError("author_missing");var d=h(e,a);if(d.success===!1)return o("WAResultOrError").makeError(d.error);if(d==null)return o("WAResultOrError").makeError("unsupported_message_type");var m=d.value;if((l=e.isTombstoned)!=null&&l)return o("WAResultOrError").makeError("message_tombstoned");switch(m){case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return k(e,t,n,s,m,r,a,i);case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return b(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.XMA:return S(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("WAResultOrError").makeResult(D(e,t,n,s,m,r));case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return R(e,t,n,s,m,r);default:return f.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Encountered unsupported media type: ",""])),m),o("WAResultOrError").makeError("unsupported_message_type")}}function b(e,t,n,r,o,a){var i=I(e,t,n,r,o,a);return v(o,i)}function v(e,t){switch(e){case o("MAWMsgType").MSG_TYPE.IMAGE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.IMAGE}));case o("MAWMsgType").MSG_TYPE.STICKER:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.STICKER}));case o("MAWMsgType").MSG_TYPE.VIDEO:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.VIDEO}));case o("MAWMsgType").MSG_TYPE.GIF:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.GIF}));case o("MAWMsgType").MSG_TYPE.PTT:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.PTT}));case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}));default:return f.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unsupported media message type: ",""])),e),o("WAResultOrError").makeError("unsupported_media_type")}}function S(e,t,n,r,a,i){var l;if(((l=e.xmaData)==null?void 0:l.xmaTargetType)==null)return f.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Mandatory XMA Data missing for XMA message: ",""])),i),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var s=e.xmaData.xmaTargetType,u=I(e,t,n,r,a,i),c=babelHelpers.extends({},u,{type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(s)}),d=e.text;return d!=null&&(c.msgContent={content:d}),o("WAResultOrError").makeResult(c)}function R(e,t,n,r,a,i){if(e.receiverFetchData==null)return f.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Mandatory receiver fetch data missing for receiver fetch message: ",""])),i),o("WAResultOrError").makeError("receiver_fetch_mandatory_fields_missing");var l=I(e,t,n,r,a,i);return o("WAResultOrError").makeResult(babelHelpers.extends({},l,{receiverFetchId:e.receiverFetchId,type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}))}function L(e){if(e!=null)switch(e){case o("EchoMessage").MessageTextSize.SMALL:return 1;case o("EchoMessage").MessageTextSize.MEDIUM:return 2;case o("EchoMessage").MessageTextSize.LARGE:return 3;default:return}}function E(e){return e.text==null?null:e.editHistory.length===0?e.text:e.editHistory.sort(function(e,t){return e.timestamp-t.timestamp})[0].text}function k(e,t,n,r,a,i,l,s){var u=l==null?f:f.tags([l]),c=s==="first_edit_content"?E(e):e.text;if(c==null)return o("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{empty_content_msg_type:a}},pointName:"unstored_text_message_empty",traceId:l}),u.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",", type: ",""])),i,a),o("WAResultOrError").makeError("text_message_content_empty");var d=I(e,t,n,r,a,i,l);if(a===o("MAWMsgType").MSG_TYPE.REVOKED)return c!=null&&(d.msgContent={content:c}),e.revokeSentTimestampMs!=null&&(d.originalTs=o("WATimeUtils").castToUnixTime(e.revokeSentTimestampMs)),o("WAResultOrError").makeResult(babelHelpers.extends({},d,{revokedExternalId:o("WAStanzaUtils").toStanzaId("0"),type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:e.revokeUnsentTimestampMS!=null?o("WATimeUtils").castToUnixTime(e.revokeUnsentTimestampMS):d.ts}));if(a===o("MAWMsgType").MSG_TYPE.CIPHERTEXT)return o("WAResultOrError").makeResult(babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}));var m=babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.TEXT});return o("WAResultOrError").makeResult(babelHelpers.extends({},m,{editCount:Math.max(e.editHistory.length-1,0),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize}))}function I(e,t,n,r,a,i,l){var s=T(r,n),u={ack:s===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s,externalId:i,groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:e.isForwarded,sortOrderMs:e.sortOrderMs,threadJid:t,ts:o("WATimeUtils").castToUnixTime(e.displayTimestampMs/1e3),type:a};if(e.authoritativeTimestampMs!=null?u.serverTs=o("WATimeUtils").castToUnixTime(e.authoritativeTimestampMs/1e3):u.serverTs=o("WATimeUtils").castToUnixTime(e.sortOrderMs/1e3),e.quoteData!=null){var c=o("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(e,n);c!=null&&(u.quote=c,u.quoteExternalId=c.content.externalId)}return u}function T(e,t){var n=o("MAWJids").toUserJid(e.localKey);return n===t?o("WAJids").AUTHOR_ME:n}function D(e,t,n,r,a,i){var l=I(e,t,n,r,a,i);return babelHelpers.extends({},l,{type:o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}l.MAWRestoreType=g,l.getDbMsgTypeFromEchoMessage=h,l.getUnstoredDbMessageFromEchoMessage=C,l.resolveAuthorFromEchoAddress=T}),98);
__d("MAWRepliesRestoreUtils",["FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e=["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"],s,u;function c(e,t){if(t==null||!o("MAWMsgType").isQuotedMsgType(t.type))return e;var n={author:t.author,externalId:t.externalId,ts:t.ts,type:t.type},r={content:n,remoteJid:null};return babelHelpers.extends({},e,{quote:r})}function d(e,t){if(e.quoteData!=null&&e.quoteData.quoteMessageId!=null&&e.quoteData.quoteMessageSender!=null){var n,r={author:o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(e.quoteData.quoteMessageSender,t),externalId:(n=e.quoteData)==null?void 0:n.quoteMessageId,ts:e.displayTimestampMs,type:o("MAWMsgType").MSG_TYPE.TEXT};return{content:r,remoteJid:null}}else o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""])),e.messageId);return null}var m=o("MAWIndexedDb").makeMsgrTransactor({chunk:(u=o("MAWTransactionMode")).READONLY,media:u.READONLY,messages:u.READWRITE,threads:u.READWRITE,xma:u.READONLY},"updateQuoteDataForReplyMessages",function(e){return(function(t,n,r){n==null||n.addPoint("replies_restore_start");var a=t.restoredMsgsData;if(a){var i=a.existingMsgs,l=a.newlyAddedMsgs,s=l.concat(i);return o("MAWDexieTable").dexieAll(s.map(function(t){return o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,t.threadJid,t).then(function(e){var n=[];return t.quoteExternalId!=null&&n.push(t),e!=null&&n.push.apply(n,e),n})})).then(function(t){var n=t.flat();return p(e,n,r)}).then(function(e){return n==null||n.addPoint("replies_restore_end",{int:{replies:e}}),e})}return o("MAWDexieTable").dexieResolve(0)})});function p(e,t,n){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=_(t);if(t.threadJid!=null)return o("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(e,n,t.threadJid).then(function(e){return babelHelpers.extends({},e,{msgId:t.msgId,originalTs:t.originalTs,protocolMsgId:t.protocolMsgId,rowId:t.rowId,threadJid:t.threadJid,unsendMsgContentDeleteTs:t.unsendMsgContentDeleteTs})});r("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(e){return e.filter(Boolean).filter(function(e){return e.quote!=null})}).then(function(e){return e.map(function(e){return e.source="eb_restore",e})}).then(function(t){return e.messages.bulkPut(t).then(function(r){return t.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){n!==!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(e){var n;return(n=t==null?void 0:t.length)!=null?n:0})})}function _(t){var n=t.msgId,r=t.originalTs,o=t.rowId,a=t.threadJid,i=t.unsendMsgContentDeleteTs,l=babelHelpers.objectWithoutPropertiesLoose(t,e);return l}l.addQuoteDataToReplyMessage=c,l.getQuoteDataFromEchoMessage=d,l.updateQuoteDataForReplyMessages=m,l.enhanceAndPersistReplyMessagesWithQuoteData=p}),98);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["FBLogger","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","WAArrayGroupBy","WAJids","WAMsgMap","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.reduce(function(e,t){var n=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.reactToExternalId);return n==null||e.set(n,o("MAWDbReactionsTxns").coerceToReaction(t)),e},new(o("WAMsgMap")).MsgMap).values()}function s(t,n,a){if(n.length===0)return o("MAWDexieTable").dexieResolve();var i=e(n),l=i.map(function(e){var t=a.get(e.threadJid);if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Should not have got here - expect thread to exist for flow");return e}),s=o("WAArrayGroupBy").groupBy(l,function(e){var t=e.threadJid;return t}),u=s.map(function(e){var n=e[0],r=e[1],i=a.get(n);if(i==null||r.length===0)return null;for(var l=null,s=r.length-1;s>=0&&(l=o("MAWDbReaction").maybeCastToIncomingDbReaction(r[s]),l==null);s--);var u=r.filter(function(e){return e.reaction==null}),c=o("WAJids").interpretAsGroupJid(i.jid)!=null;return o("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(t,i,{newestReaction:l,reactionsToClear:u},c)}).filter(Boolean);return o("MAWDexieTable").dexieAll(u).then(function(e){return o("MAWDexieTable").dexieAll([t.threads.bulkPut(e.map(function(e){var t=e.thread;return t})),t.reactions.bulkPut(l)]).then(r("emptyFunction"))})}l.bulkPutReactionsWithThreadUpdates=s}),98);
__d("MAWDeletedReactionsCache",["WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAMsgMap")).MsgMap;l.DeletedReactionsCache=e}),98);
__d("MAWBulkWriteReactionsTxns",["FBLogger","LSMEBTaskCreationSource","MAWAuthor","MAWBridgeEventTransmitter","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWJidUtils","MAWODSProxy","MAWUseProtocolMsgIdForMsgId","WAArrayGroupBy","WAJids","WAOdsEnums","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],a=[];return t.forEach(function(e){var t=e.chatJid,r=e.unstoredReaction,o=r.reactToExternalId;n.push(t),a.push(o)}),o("MAWDexieTable").dexieAll([e.threads.where("jid").anyOf(n).toArray(),e.messages.where("externalId").anyOf(a).toArray(),e.reactions.where("reactToExternalId").anyOf(a).toArray()]).then(function(n){var a=n[0],i=n[1],l=n[2],u=new Map(a.map(function(e){return[e.jid,e]})),c=new Map(o("WAArrayGroupBy").groupBy(i,function(e){return e.externalId})),d=new Map(o("WAArrayGroupBy").groupBy(l,function(e){return e.reactToExternalId})),m=[],p=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId(),_=function(n){return t.forEach(function(e){var t=e.chatJid,a=e.unstoredReaction,i=a.author,l=a.externalId,_=a.groupingKey,f=a.reaction,g=a.reactToAuthor,h=a.reactToExternalId,y=a.senderTimestampMs,C=a.ts,b=u.get(t);if(b==null)return"missing_thread";var v=null;if(!p&&n!=null){var S=new Map(n),R=S.get(b.jid);if(R==null)throw r("FBLogger")("messenger_web").mustfixThrow("nextInChatReactionId should not be null");S.set(b.jid,R+1),v=o("MAWDbMsg").craftReactionId(b.chatId,R)}else v=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,l);var L=d.get(a.reactToExternalId)||[],E=o("MAWDbReaction").findMatchingReaction(L,b.jid,i);if(E!=null&&o("MAWDbReaction").getReactionTimeMs(E)>o("MAWDbReaction").getReactionTimeMs(a))return"newer_reaction_exists";if(E!=null&&a.reaction==null){var k={author:a.author,chat:a.threadJid,externalId:a.externalId};o("MAWDeletedReactionsCache").DeletedReactionsCache.set(k,E)}var I=o("MAWAuthor").getAuthorUserJid(g),T=c.get(a.reactToExternalId);T==null&&(a.reactToExternalId===a.externalId?r("FBLogger")("messenger_web").warn("reactToExternalId is same as externalId"):r("gkx")("16596")||o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.reactToExternalId,r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT_REACTIONS,b.jid));var D=s(b,I,T),x=o("MAWDbReaction").formatReactionForDb(b.jid,l,v,h,f,_,g,D==null&&p?o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,h):D==null?void 0:D.msgId,C,i!=null?i:o("WAJids").AUTHOR_ME,E==null?void 0:E.rowId,void 0,y);m.push(x)}),{chatJidToDbThread:u,unstoredDbReactionsForInsertion:m}};if(!p){var f=a.map(function(t){return o("MAWDbReactionsTxns").getNextReactionIdNumberForThread(e,t).then(function(e){return[t.jid,e]})});return o("MAWDexieTable").dexieAll(f).then(_)}return _(null)})}function s(e,t,n){var a,i=(a=n==null?void 0:n.filter(function(n){return n.threadJid===e.jid&&t===o("MAWAuthor").getAuthorUserJid(n.author)}))!=null?a:[];return i.length>1&&(r("FBLogger")("maw_mutation_validator").warn("%s matching duplicate messages found for a reaction",i.length),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MUTATION_VALIDATOR,key:"match_reaction_to_message.invalid"})),i[0]}function u(e,t){var n=t.chatJidToDbThread,r=t.unstoredDbReactionsForInsertion;return o("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(e,r,n)}l.prepareReactionsData=e,l.bulkWriteReactions=u}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(e,t,r){r==null||r.addPoint("reactions_restore_start");var o=e.echoMsgMap,a=e.restoredMsgsData,i=0;if(a){var l=a.existingMsgs,s=a.newlyAddedMsgs,u=s.concat(l),c=a.threadJid,d=u.filter(function(e){var t=o.get(e.externalId);return y(o,e)&&t!=null&&C(t)});if(d.length===0)return(f||(f=n("Promise"))).resolve();var m=d.flatMap(function(e){var n=o.get(e.externalId),r=S(a.threadJid,t,e.externalId,e.msgId,e.author,n);return r.map(function(e){return{chatJid:c,unstoredReaction:e}})});return m.length===0?(f||(f=n("Promise"))).resolve():h(m).then(function(e){i+=m.length,r==null||r.addPoint("reactions_restore_end",{int:{reactions:i}})})}return(f||(f=n("Promise"))).resolve()}var h=o("MAWIndexedDb").makeMsgrTransactor({groupInfo:(_=o("MAWTransactionMode")).READWRITE,messages:_.READWRITE,reactions:_.READWRITE,threads:_.READWRITE},"restoreWriteReactionsToDb",function(e){return(function(t){return o("MAWBulkWriteReactionsTxns").prepareReactionsData(e,t).then(function(t){return o("MAWBulkWriteReactionsTxns").bulkWriteReactions(e,t)})})});function y(t,n){var r=t.get(n.externalId);return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]))),!1):o("WAJids").isAuthorSystem(n.author)?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]))),!1):o("MAWAuthor").getAuthorUserJid(n.author)==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]))),!1):!0}function C(e){return e.reactions!=null&&e.reactions.length!==0&&e.reactionXOfflineThreadingIds!=null&&e.reactionXOfflineThreadingIds.length!==0&&e.reactionAuthoritativeTimestampMs!=null&&e.reactionAuthoritativeTimestampMs.length!==0}function b(e,t,n){return(e==null?void 0:e.length)===0?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]))),!1):t==null?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]))),!1):n==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]))),!1):!0}function v(e,t,n){return(e||[]).map(function(e,r){return n==null||t==null||(n==null?void 0:n.length)<=r||(t==null?void 0:t.length)<=r?(o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]))),[]):[e,t[r],n[r]]})}function S(e,t,n,r,a,i){var l=o("MAWAuthor").getAuthorUserJid(a);if(i==null||l==null)return[];var s=i.reactionAuthoritativeTimestampMs,u=s===void 0?[]:s,c=i.reactionXOfflineThreadingIds,d=c===void 0?[]:c,m=i.reactions;return v(m,d,u).filter(function(e){var t=e[0],n=e[1];return n!=null&&b(t.displayName,n.displayName,o("MAWAuthor").getAuthorUserJid(a))}).map(function(a){var i=a[0],s=a[1],u=a[2],c=i.displayName,d=o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(i,t),m={ack:d===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,author:d,externalId:o("WAStanzaUtils").toStanzaId(s.displayName||""),groupingKey:c,reaction:c,reactToAuthor:l,reactToExternalId:n,senderTimestampMs:null,threadJid:e,ts:o("WATimeUtils").castToUnixTime(Number(u.displayName)/1e3)};return r!=null?babelHelpers.extends({},m,{reactToMsgId:r}):m})}l.writeEchoReactionsToReactionsStore=g,l.getReactionsForReactionStore=S}),98);
__d("MAWMessageParseError",[],(function(t,n,r,o,a,i){"use strict";var e=(function(e){function t(t){var n;return n=e.call(this,t)||this,n.name="MAWMessageParseError",n.message=t,n}return babelHelpers.inheritsLoose(t,e),t})(babelHelpers.wrapNativeSuper(Error));i.MAWMessageParseError=e}),66);
__d("WAMessageKey",["WAGlobals","WAJids","WAStanzaUtils","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e===o("WAJids").AUTHOR_ME||e==o("WAGlobals").getMyUserJid()}function s(t,n,a){if(a==null)throw r("err")("messageKey is null");var i=a.id,l=a.remoteJid;if(i==null)throw r("err")("messageKey.id is null");if(l==null)throw r("err")("messageKey.remoteJid is null");var s=o("WAJids").interpretAndValidateJid(l);if(s.jidType==="unknown")throw r("err")("messageKey.remoteJid is invalid");var u,c=o("WAJids").AUTHOR_ME;if(s.jidType==="group")if(u=s.groupJid,e(n)&&a.fromMe===!0)c=o("WAJids").AUTHOR_ME;else if(a.fromMe==!0)c=n;else{var d=a.participant;if(d==null)throw r("err")("key.participant is null");var m=o("WAJids").interpretAndValidateJid(d);if(m.jidType==="msgrUser")c=m.userJid;else throw r("err")("key.participant is invalid")}else if(s.jidType==="msgrUser"||s.jidType==="msgrDevice"){var p=o("WAJids").interpretAndValidateJid(t);if(p.jidType!=="msgrUser")throw r("err")("expected user type jid.");u=p.userJid,e(n)?a.fromMe===!0?c=o("WAJids").AUTHOR_ME:c=p.userJid:a.fromMe===!0&&(c=p.userJid)}else throw r("err")("Unsupported jidtype type");return{chat:u,author:e(c)?o("WAJids").AUTHOR_ME:c,externalId:o("WAStanzaUtils").toStanzaId(i)}}l.extractProtocolMessageId=s}),98);
__d("WAParseConsumerMessagePollCreation",["WAGlobals","WAHex","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){var a={unstoredMsg:{type:o("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:o("WAHex").bytesToBuffer(e),subtype:"pollCreationMessage"},id:t.id,ts:t.ts,sentTs:t.sentTs,serverTs:t.serverTs,ack:t.ack,reportingMeta:n},unstoredMedia:null,unstoredQuotedMedia:null};if(!r||!o("WAGlobals").getConfig().isPollsEnabled())return a;var i=r.encKey,l=r.name,s=r.options,u=r.selectableOptionsCount,c=t.ack,d=t.id,m=t.ts;if(i==null||l==null||u==null)return a;var p=s.map(function(e){return e.optionName}).filter(Boolean);return{unstoredMsg:{ack:c,id:d,ts:m,type:o("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE},unstoredGroupPollCreateInfo:{encKey:i,name:l,selectableOptionsCount:u,options:p},unstoredMedia:null,unstoredQuotedMedia:null}}l.default=e}),98);
__d("WAParseConsumerMessagePollUpdate",["WAGlobals","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){var a=t.ack,i=t.id,l=t.ts;return r==null||!o("WAGlobals").getConfig().isPollsEnabled()?{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}:{unstoredMsg:{ack:a,id:i,ts:l,type:o("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredGroupPollUpdateInfo:{pollUpdateMessage:r,type:o("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredMedia:null,unstoredQuotedMedia:null}}l.default=e}),98);
__d("WAParseProtocolUtils",["WAGlobals","WALogger","WALongInt","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){var n=c(t,e.serverTs),r=n==null?void 0:n.expirationTs,o=n==null?void 0:n.deleteTs,a=n==null?void 0:n.ephemeralSetting;return{expirationTs:r,deleteTs:o,ephemeralSetting:a}}function u(e,t){var n=d(t);return n!=null&&(e.reportingMeta=n),n}function c(e,t){var n,r,a=e==null||(n=e.chatEphemeralSetting)==null?void 0:n.ephemeralExpiration,i=e==null||(r=e.chatEphemeralSetting)==null?void 0:r.ephemeralSettingTimestamp;if(a==null||i==null||a===0)return null;var l=o("WATimeUtils").castToUnixTime(t+o("WAGlobals").getDependencies().ephemeralMaxDeletionWindowForUnseenMessage()),s=l,u=null;try{var c=o("WALongInt").numberOrThrowIfTooLarge(i)/1e3;u=o("WATimeUtils").castToUnixTime(c)}catch(e){return null}return{expirationTs:l,deleteTs:s,ephemeralSetting:{expirationTs:a,updatedTs:u}}}function d(t){var n=t==null?void 0:t.frankingVersion;return n!=null&&n!==0&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unsupported franking version ",""])),n),{frankingKey:void 0,frankingTag:void 0,frankingVersion:n,reportingContent:void 0,reportingTag:void 0}}l.parseEphemerality=s,l.enhanceReportingMeta=u}),98);
__d("WAParseConsumerMessageProtocol",["WACommon.pb","WAConsumerApplication.pb","WAGlobals","WAHex","WAJids","WALogger","WAMediaTransport.pb","WAMessageKey","WAMsgType","WAParseConsumerMessagePollCreation","WAParseConsumerMessagePollUpdate","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassUtils","WAResultOrError","WAStanzaUtils","WATimeUtils","decodeProtobuf","err","maybeConvertMessageTextMentionsV2ToV1"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=90*o("WATimeUtils").DAY_SECONDS,c=1,d=0,m=1,p=o("WAGlobals").getConfig().armadilloWebProcessFutureproof()?m+1:m;function _(t,n,a,i,l,c){var d,m,p,_,f=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAConsumerApplication.pb").ConsumerApplicationSpec,n),g=(d=f.payload)==null||(d=d.applicationData)==null||(d=d.revoke)==null||(d=d.key)==null?void 0:d.id;if(g!=null)return{unstoredMsg:{type:o("WAMsgType").MSG_TYPE.REVOKED,id:a.id,ts:a.ts,sentTs:a.sentTs,serverTs:a.serverTs,ack:a.ack,reportingMeta:a.reportingMeta,revokedExternalId:o("WAStanzaUtils").toStanzaId(g),unsendMsgContentDeleteTs:null,msgContent:null,ebTimestampMs:c},unstoredMedia:null,unstoredQuotedMedia:null};var h=(l==null?void 0:l.isForwarded)||!1,k=o("WAParseProtocolUtils").parseEphemerality(a,l),I=k.deleteTs,T=k.ephemeralSetting,D=k.expirationTs;if(T!=null&&(T.expirationTs<0||T.expirationTs>u)){var x=o("WAJids").interpretAndValidateJid(t),$=x.jidType,P=T.expirationTs;o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["WAParseConsumerMessageProtocol - ephemeralSetting duration is invalid ",", jidType: ",""])),P,$)}var N=o("WAParseProtocolUtils").enhanceReportingMeta(a,l),M=(m=C(l))!=null?m:void 0,w=(p=f.payload)==null?void 0:p.content;if(!w)return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};var A=(_=f.metadata)==null?void 0:_.specialTextSize,F=L(w),O={contentTypeForLogging:F,unstoredMsg:{type:o("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:o("WAHex").bytesToBuffer(i),subtype:null},id:a.id,ts:a.ts,sentTs:a.sentTs,serverTs:a.serverTs,ack:a.ack,reportingMeta:N},unstoredMedia:null,unstoredQuotedMedia:null},B=function(t){return babelHelpers.extends({},O,{unstoredMsg:babelHelpers.extends({},O.unstoredMsg,{msgContent:babelHelpers.extends({},O.unstoredMsg.msgContent,{subtype:t})})})},W=(function(){try{switch(F){case"messageText":{var e,n=w[F]&&r("maybeConvertMessageTextMentionsV2ToV1")(w[F]);if(n==null)throw r("err")("consumerMessage has no messageText");var u=((e=n.commands)==null?void 0:e.some(function(e){return e.commandType===o("WACommon.pb").COMMAND_COMMAND_TYPE.AI}))===!0;if(u&&!o("WAGlobals").getConfig().isMetaAiInvocationMessageRenderEnabled())return B("metaAiMessage");if(o("WAParseReadOnlyMetadataDataclassUtils").isNoteMention(l))return B("noteMention");if(n.text==null)throw r("err")("consumerMessage has no messageText");return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:n.text,mentionedJids:n.mentionedJid.map(o("WAJids").validateUserJid).filter(Boolean),commands:n.commands},quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h},a,{specialTextSize:A,ebTimestampMs:c}),unstoredMedia:null,unstoredQuotedMedia:null}}case"reactionMessage":return{unstoredMsg:y(t,a,w[F]),unstoredMedia:null,unstoredQuotedMedia:null};case"imageMessage":{var d=b(w,a.ts);return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.IMAGE,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,mediaId:d.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:d,unstoredQuotedMedia:null}}case"videoMessage":{var m,p,_,f,g=w[F];if(g==null)throw r("err")("consumerMessage has no videoMessage");var C=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").VideoTransportSpec,g==null||(m=g.video)==null?void 0:m.payload),L=C==null||(p=C.integral)==null||(p=p.transport)==null||(p=p.ancillary)==null?void 0:p.mimetype,k=(C==null||(_=C.ancillary)==null?void 0:_.gifPlayback)===!0&&L==="image/gif",x=o("WAParseMediaTransportProtocol").parseVideoMsg(C,a.ts,k);if(x==null)throw r("err")("consumerMessage has no video media info");if(o("WAParseReadOnlyMetadataDataclassUtils").isPowerUp(l)&&((f=g.caption)==null?void 0:f.text)!=null){var $;return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:($=g.caption)==null?void 0:$.text,mentionedJids:g.caption.mentionedJid.map(o("WAJids").validateUserJid).filter(Boolean)},quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h},a,{specialTextSize:A,ebTimestampMs:c}),unstoredMedia:null,unstoredQuotedMedia:null}}return{unstoredMsg:k?babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.GIF},a,{quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N,mediaId:x.plaintextHash}):babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.VIDEO},a,{quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,mediaId:x.plaintextHash}),unstoredMedia:x,unstoredQuotedMedia:null}}case"audioMessage":{var P=v(w,a.ts);return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.PTT,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,mediaId:P.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:P,unstoredQuotedMedia:null}}case"stickerMessage":{var W,q,U=S(w),V=o("WAParseMediaTransportProtocol").parseStickerMsg(U,a.ts),H=((W=U.integral)==null?void 0:W.receiverFetchId)!=null||((q=U.ancillary)==null?void 0:q.receiverFetchId)!=null;if(V==null){if(H){var G=o("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(U);if(G==null)throw r("err")("consumerMessage has no sticker receiver fetch info");return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.RECEIVER_FETCH,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N},a,{ebTimestampMs:c}),unstoredMedia:null,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:G}}throw r("err")("consumerMessage has no sticker media info")}return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.STICKER,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N,mediaId:V.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:V,unstoredQuotedMedia:null}}case"documentMessage":{if(o("WAGlobals").getConfig().isDocumentReceiveEnabled()){var z=R(w,a.ts);return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.DOCUMENT_FILE,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N,mediaId:z.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:z,unstoredQuotedMedia:null}}return O}case"groupInviteMessage":return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null,unstoredIncomingGroupInvite:E(a,w)};case"editMessage":{var j,K=w[F],Q=K==null?void 0:K.message,X=Q==null?void 0:Q.text,Y=K==null||(j=K.key)==null?void 0:j.id;if(K==null||Q==null||X==null)throw r("err")("consumerMessage with editMessage type has no editMessage");if(Y==null)throw r("err")("consumerMessage with editMessage type has no original Msg External Id.");var J=o("WAStanzaUtils").toStanzaId(Y);return{unstoredEditMsg:{type:o("WAMsgType").MSG_TYPE.EDIT_ACTION,editMsgContent:{content:X,mentionedJids:Q.mentionedJid.map(o("WAJids").validateUserJid).filter(Boolean),commands:Q.commands},originalMsgExternalId:J,id:a.id,ts:a.ts,sentTs:a.sentTs,serverTs:a.serverTs,ack:a.ack,reportingMeta:N,specialTextSize:A},unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}case"pollCreationMessage":return r("WAParseConsumerMessagePollCreation")(i,a,N,w[F]);case"pollUpdateMessage":return r("WAParseConsumerMessagePollUpdate")(i,a,N,w[F]);case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return O}}catch(e){return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["parseConsumerMessageProtocol error :",""])),e),{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}})();return babelHelpers.extends({},W,{contentTypeForLogging:F})}function f(e){if(o("WAJids").isAuthorSystem(e))throw r("err")("Got system author");return e}var g=30;function h(e){return e==null?o("WAResultOrError").makeResult(null):e.length>g?o("WAResultOrError").makeError("invalid-reaction-text-length"):o("WAResultOrError").makeResult(e)}function y(e,t,n){if(n==null)throw r("err")("consumerMessage has no reactionMessage");var a=f(t.id.author),i=o("WAMessageKey").extractProtocolMessageId(e,a,n.key),l=n.groupingKey,s=n.senderTimestampMs,u=n.text,c=h(u);if(!c.success)throw r("err")('"'+(u!=null?u:"")+'" is not a valid reaction ['+c.error+"]");return{type:o("WAMsgType").MSG_TYPE.REACTION,ack:t.ack,id:t.id,reactToExternalId:i.externalId,reactToAuthor:i.author,reaction:c.value,groupingKey:l,ts:t.ts,senderTimestampMs:s}}function C(e){var t,n,a,i=e==null||(t=e.quotedMessage)==null?void 0:t.stanzaId,l=e==null||(n=e.quotedMessage)==null?void 0:n.participant,s=e==null||(a=e.quotedMessage)==null?void 0:a.remoteJid,u=l!=null?o("WAJids").interpretAndValidateJid(l):null,c;if((u==null?void 0:u.jidType)==="msgrUser"&&u.userJid===o("WAGlobals").getMyUserJid()?c=o("WAJids").AUTHOR_ME:(u==null?void 0:u.jidType)==="msgrUser"?c=u.userJid:c=o("WAJids").AUTHOR_ME,i==null)return null;var d={type:o("WAMsgType").MSG_TYPE.UNAVAILABLE,author:c,externalId:o("WAStanzaUtils").toStanzaId(i),ts:null};if(s!=null){var m=o("WAJids").interpretAndValidateJid(s);if(m.jidType==="group")return{remoteJid:m.groupJid,content:d};throw r("err")("not supported")}else return{remoteJid:null,content:d}}function b(e,t){var n,a=e.imageMessage;if(a==null)throw r("err")("consumerMessage has no imageMessage");return o("WAParseMediaTransportProtocol").decodeImageTransport(a==null||(n=a.image)==null?void 0:n.payload,t,"image")}function v(e,t){var n,a=e.audioMessage;if(a==null)throw r("err")("consumerMessage has no audioMessage");var i=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").AudioTransportSpec,a==null||(n=a.audio)==null?void 0:n.payload),l=o("WAParseMediaTransportProtocol").parseAudioMsg(i,(a==null?void 0:a.ptt)||!1,t);if(l==null)throw r("err")("consumerMessage has no audio media info");return l}function S(e){var t,n=e.stickerMessage;if(n==null)throw r("err")("consumerMessage has no stickerMessage");return o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").StickerTransportSpec,n==null||(t=n.sticker)==null?void 0:t.payload)}function R(e,t){var n,a=e.documentMessage;if(a==null)throw r("err")("consumerMessage has no documentMessage");var i=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").DocumentTransportSpec,a==null||(n=a.document)==null?void 0:n.payload),l=a==null?void 0:a.fileName,s=o("WAParseMediaTransportProtocol").parseDocumentMsg(i,l,t);if(s==null)throw r("err")("consumerMessage has no document media info");return s}function L(e){var t=Object.keys(e).filter(function(e){return e!=="$$unknownFieldCount"});if(t.length!==1)throw r("err")(JSON.stringify(e)+" consumerMessage payload content should have exactly one field, instead found "+JSON.stringify(t));return t[0]}function E(e,t){var n=t.groupInviteMessage;if(n==null)throw r("err")("consumerMessage has no GroupInvite Data");return babelHelpers.extends({ack:e.ack,author:e.id.author,externalId:e.id.externalId,ts:e.ts},n)}l.MINIMAL_MEDIA_DURATION=c,l.DEFAULT_FILE_SIZE=d,l.SUPPORTED_TYPES_VERSION=p,l.parseConsumerMessageProtocol=_,l.interpretAsNonSystemAuthor=f,l.validReactionMessageText=h,l.parseReactionMessage=y,l.parsedQuotedConsumerMessage=C,l.parseOneOfContentType=L}),98);
__d("WAParseMediaTransportProtocol",["WAHashUtils","WALogger","WALongInt","WAMedia","WAMediaHdType","WAMediaTransport.pb","WAMediaUtils","WAMsgMap","WAParseConsumerMessageProtocol","WAProgressiveJpegGetScanLengths","WATimeUtils","decodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n,r,a){var i,l,c,d,m,p,_,f,g,h,y,C,b,v;if(!((i=t.integral)!=null&&i.transport))return null;var S=(l=t.integral)==null?void 0:l.transport;if(o("decodeProtobuf").getUnknownFields(S.integral)!=null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["There is unknown fileds in integral of VideoTransport"]))),null;var R=(c=S.integral)==null?void 0:c.fileSha256;if(!R)return r||o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with no plaintext hash"]))),null;var L=null;if(((d=t.ancillary)==null?void 0:d.scansSidecar)!=null&&((m=t.ancillary)==null?void 0:m.scanLengths)!=null){var E,k;L={sidecar:(E=t.ancillary)==null?void 0:E.scansSidecar,scanLengths:(k=t.ancillary)==null||(k=k.scanLengths)==null?void 0:k.map(o("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength)}}if(((p=S.integral)==null?void 0:p.fileSha256)==null||((_=S.integral)==null?void 0:_.fileEncSha256)==null||((f=S.integral)==null?void 0:f.mediaKey)==null||((g=S.integral)==null?void 0:g.directPath)==null||((h=S.integral)==null?void 0:h.mediaKeyTimestamp)==null||((y=S.ancillary)==null?void 0:y.objectId)==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]))),null;var I=(C=S.ancillary)==null?void 0:C.fileLength,T=(b=S.ancillary.thumbnail)==null?void 0:b.downloadableThumbnail,D=o("WAMediaUtils").rawDataToMediaEntry({fileSha256:S.integral.fileSha256,fileEncSha256:S.integral.fileEncSha256,mediaKey:S.integral.mediaKey,directPath:S.integral.directPath,mediaKeyTimestamp:o("WATimeUtils").castLongIntToUnixTime(S.integral.mediaKeyTimestamp),serverMediaType:n,objectId:(v=S.ancillary)==null?void 0:v.objectId,fbid:void 0,downloadableThumbnail:{directPath:T==null?void 0:T.directPath,fileEncSha256:T==null?void 0:T.fileEncSha256,fileSha256:T==null?void 0:T.fileSha256,mediaKey:T==null?void 0:T.mediaKey,mediaKeyTimestamp:(T==null?void 0:T.mediaKeyTimestamp)==null?null:o("WATimeUtils").castLongIntToUnixTime(T==null?void 0:T.mediaKeyTimestamp),objectId:T==null?void 0:T.objectId},filename:a,progressiveJpegDetails:L,size:I==null?I:o("WALongInt").numberOrThrowIfTooLarge(I)});return{size:I==null?o("WAParseConsumerMessageProtocol").DEFAULT_FILE_SIZE:o("WALongInt").numberOrThrowIfTooLarge(I),plaintextHash:o("WAHashUtils").toPlaintextHash(new Uint8Array(R)),mediaEntry:D}}function d(e){switch(e){case o("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.NONE:return o("WAMediaHdType").HD_TYPE_NONE;case o("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.LQ_4K:return o("WAMediaHdType").HD_TYPE_LQ_4K;case o("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.HQ_4K:return o("WAMediaHdType").HD_TYPE_HQ_4K;default:return o("WAMediaHdType").HD_TYPE_NONE}}function m(e,t,n){var r,a,i,l,s,u,m=c(e,n,!1);if(!m)return null;var p=C(m,t),_=(r=e.ancillary)==null?void 0:r.width,f=(a=e.ancillary)==null?void 0:a.height;e.ancillary!=null&&(e.ancillary.width!=null&&e.ancillary.width===4294967295&&(_=void 0),e.ancillary.height!=null&&e.ancillary.height===4294967295&&(f=void 0));var g=babelHelpers.extends({},p,{mediaType:o("WAMedia").MEDIA_TYPE.IMAGE,validatedVideoInfo:null,validatedImageInfo:{width:_,height:f,jpegThumbnail:(i=e.integral)==null||(i=i.transport)==null||(i=i.ancillary)==null||(i=i.thumbnail)==null?void 0:i.jpegThumbnail,jpegThumbnailHeight:(l=e.integral)==null||(l=l.transport)==null||(l=l.ancillary)==null||(l=l.thumbnail)==null?void 0:l.thumbnailHeight,jpegThumbnailWidth:(s=e.integral)==null||(s=s.transport)==null||(s=s.ancillary)==null||(s=s.thumbnail)==null?void 0:s.thumbnailWidth,hdType:d((u=e.ancillary)==null?void 0:u.hdType)},validatedAudioInfo:null,validatedDocumentFileInfo:null});return g}function p(e,t,n){var a=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").ImageTransportSpec,e),i=m(a,t,n);if(i==null)throw r("err")("consumerMessage has no image media info");return i}function _(e,t,n){var r,a,i,l,s,u,d,m,p,_,f,g,h,y,b,v,S;if(!((r=e.integral)!=null&&r.transport))return null;var R=c(e,n?"gif":"video",!1);if(!R)return null;var L=C(R,t),E=babelHelpers.extends({},L,{accessibilitySummaryText:(a=e.ancillary)==null?void 0:a.accessibilityLabel,mediaType:n?o("WAMedia").MEDIA_TYPE.GIF:o("WAMedia").MEDIA_TYPE.VIDEO,validatedVideoInfo:n?null:{duration:(e==null||(i=e.ancillary)==null?void 0:i.seconds)!=null&&(e==null||(l=e.ancillary)==null?void 0:l.seconds)>o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?e==null||(s=e.ancillary)==null?void 0:s.seconds:o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,width:e==null||(u=e.ancillary)==null?void 0:u.width,height:e==null||(d=e.ancillary)==null?void 0:d.height,mimetype:e==null||(m=e.integral)==null||(m=m.transport)==null||(m=m.ancillary)==null?void 0:m.mimetype,jpegThumbnail:(p=e.integral)==null||(p=p.transport)==null||(p=p.ancillary)==null||(p=p.thumbnail)==null?void 0:p.jpegThumbnail,jpegThumbnailHeight:(_=e.integral)==null||(_=_.transport)==null||(_=_.ancillary)==null||(_=_.thumbnail)==null?void 0:_.thumbnailHeight,jpegThumbnailWidth:(f=e.integral)==null||(f=f.transport)==null||(f=f.ancillary)==null||(f=f.thumbnail)==null?void 0:f.thumbnailWidth,gifPlayback:(g=e.ancillary)==null?void 0:g.gifPlayback},validatedImageInfo:n?{width:(h=e.ancillary)==null?void 0:h.width,height:(y=e.ancillary)==null?void 0:y.height,jpegThumbnail:(b=e.integral)==null||(b=b.transport)==null||(b=b.ancillary)==null||(b=b.thumbnail)==null?void 0:b.jpegThumbnail,jpegThumbnailHeight:(v=e.integral)==null||(v=v.transport)==null||(v=v.ancillary)==null||(v=v.thumbnail)==null?void 0:v.thumbnailHeight,jpegThumbnailWidth:(S=e.integral)==null||(S=S.transport)==null||(S=S.ancillary)==null||(S=S.thumbnail)==null?void 0:S.thumbnailWidth}:null,validatedAudioInfo:null,validatedDocumentFileInfo:null});return E}function f(e,t,n){var r,a,i,l,s,u;if(!((r=e.integral)!=null&&r.transport))return null;var d=c(e,"ptt",!1);if(!d)return null;var m=C(d,n),p=babelHelpers.extends({},m,{mediaType:o("WAMedia").MEDIA_TYPE.PTT,validatedVideoInfo:null,validatedImageInfo:null,validatedDocumentFileInfo:null,validatedAudioInfo:{duration:(e==null||(a=e.ancillary)==null?void 0:a.seconds)!=null&&(e==null||(i=e.ancillary)==null?void 0:i.seconds)>o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?e==null||(l=e.ancillary)==null?void 0:l.seconds:o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,mimetype:e==null||(s=e.integral)==null||(s=s.transport)==null||(s=s.ancillary)==null?void 0:s.mimetype,played:!1,waveform:e==null||(u=e.ancillary)==null?void 0:u.waveform}});return p}function g(e,t){var n,r,a,i,l,s,u,d;if(!((n=e.integral)!=null&&n.transport))return null;var m=((r=e.integral)==null?void 0:r.receiverFetchId)!=null,p=c(e,"sticker",m);if(!p)return null;var _=C(p,t),f=babelHelpers.extends({},_,{accessibilitySummaryText:(a=e.ancillary)==null?void 0:a.accessibilityLabel,mediaType:o("WAMedia").MEDIA_TYPE.STICKER,validatedVideoInfo:null,validatedImageInfo:{width:(i=e.ancillary)==null?void 0:i.width,height:(l=e.ancillary)==null?void 0:l.height,jpegThumbnail:(s=e.integral)==null||(s=s.transport)==null||(s=s.ancillary)==null||(s=s.thumbnail)==null?void 0:s.jpegThumbnail,jpegThumbnailHeight:(u=e.integral)==null||(u=u.transport)==null||(u=u.ancillary)==null||(u=u.thumbnail)==null?void 0:u.thumbnailHeight,jpegThumbnailWidth:(d=e.integral)==null||(d=d.transport)==null||(d=d.ancillary)==null||(d=d.thumbnail)==null?void 0:d.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return f}function h(e){var t,n,r,o,a,i,l;if(!((t=e.integral)!=null&&t.transport))return null;var s=(n=e.ancillary)==null?void 0:n.width,u=(r=e.ancillary)==null?void 0:r.height,c=(o=(a=e.integral)==null?void 0:a.receiverFetchId)!=null?o:(i=e.ancillary)==null?void 0:i.receiverFetchId,d=e==null||(l=e.integral)==null||(l=l.transport)==null||(l=l.ancillary)==null?void 0:l.mimetype;if(s==null||u==null||c==null||d==null)return null;var m={receiverFetchId:c,previewWidth:s,previewHeight:u,mimetype:d,type:"sticker"};return m}function y(e,t,n){var r,a;if(!((r=e.integral)!=null&&r.transport))return null;var i=c(e,"document",!1,t);if(!i)return null;var l=C(i,n);return babelHelpers.extends({},l,{mediaType:o("WAMedia").MEDIA_TYPE.DOCUMENT_FILE,validatedVideoInfo:null,validatedImageInfo:null,validatedAudioInfo:null,validatedDocumentFileInfo:{mimetype:e==null||(a=e.integral)==null||(a=a.transport)==null||(a=a.ancillary)==null?void 0:a.mimetype,filename:t!=null?t:void 0}})}function C(e,t){return{mediaEntry:e.mediaEntry,plaintextHash:e.plaintextHash,size:e.size,msgIds:[],mediaEntries:new(o("WAMsgMap")).MsgMap,ts:t}}l.getMediaMeta=c,l.decodeImageTransport=p,l.parseVideoMsg=_,l.parseAudioMsg=f,l.parseStickerMsg=g,l.parseStickerReceiverFetchInfo=h,l.parseDocumentMsg=y}),98);
__d("MAWParseBumpExistingMessageMsg",["FBLogger","WAMessageKey","WAParseConsumerMessageProtocol","WAParseProtocolUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.chat,n=e.content,a=e.meta,i=e.metadata,l=n.bumpExistingMessage;if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no content");var s=l.key;if(s==null)throw r("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no message key");var u=o("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.id.author),c=o("WAMessageKey").extractProtocolMessageId(t,u,s),d=c.author,m=c.externalId,p=o("WAParseProtocolUtils").parseEphemerality(a,i),_=p.deleteTs,f=p.ephemeralSetting,g=p.expirationTs,h={ack:a.ack,deleteTs:_,ephemeralSetting:f,expirationTs:g,id:{author:a.id.author,chat:a.id.chat,externalId:a.id.externalId},quote:{content:{author:d,externalId:m,ts:null,type:"Unavailable"},remoteJid:t},reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"BumpExistingMessage"};return{contentTypeForLogging:"bumpExistingMessage",unstoredMedia:null,unstoredMsg:h,unstoredQuotedMedia:null,unstoredXMA:null}}l.default=e}),98);
__d("MAWMessageDropError",[],(function(t,n,r,o,a,i){"use strict";var e=(function(e){function t(t){var n;return n=e.call(this,t)||this,n.name="MAWMessageDropError",n.message=t,n}return babelHelpers.inheritsLoose(t,e),t})(babelHelpers.wrapNativeSuper(Error));i.MAWMessageDropError=e}),66);
__d("MAWParseNetworkVerificationMsg",["MAWMessageDropError","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){throw o("WALogger").EXPECTED_ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Web does not support network verification code"]))),new(o("MAWMessageDropError")).MAWMessageDropError("Web does not support network verification")}l.parseNetworkVerificationMsg=s}),98);
__d("MAWParseNoteReplyMsg",["FBLogger","MAWJids","MAWMsgType","WAJids","WALongInt","WAMediaTransport.pb","WAMsgType","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassUtils","WATimeUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t,n,a=e.content,i=e.ebTimestampMs,l=e.meta,s=e.metadata,u=a.noteReplyMessage;if(o("WAParseReadOnlyMetadataDataclassUtils").isNoteMention(s))return"noteMention";if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no content");var c=(t=u.noteText)==null?void 0:t.text;if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no note text");var d=u.noteTimestampMs!=null?o("WATimeUtils").castMilliSecondsToUnixTime(o("WALongInt").numberOrThrowIfTooLarge(u.noteTimestampMs)):void 0,m=o("MAWJids").toUserJid(l.id.author),p=o("MAWJids").toUserJid(l.id.chat),_=p===m?o("WAJids").AUTHOR_ME:p,f=o("WAParseProtocolUtils").parseEphemerality(l,s),g=f.deleteTs,h=f.ephemeralSetting,y=f.expirationTs,C={ack:l.ack,deleteTs:g,ebTimestampMs:i,ephemeralSetting:h,expirationTs:y,forwardingScore:l.forwardingScore,id:{author:l.id.author,chat:l.id.chat,externalId:l.id.externalId},quote:{content:{author:_,expirationTs:d,externalId:l.id.externalId,msgContent:{content:c},ts:l.serverTs,type:o("WAMsgType").NOTE_REPLY},remoteJid:l.id.chat},ts:l.serverTs},b,v,S,R=(n=u.textContent)==null?void 0:n.text,L=u.stickerContent,E=u.videoContent;if(R!=null){var k=babelHelpers.extends({msgContent:{content:R},type:o("MAWMsgType").MSG_TYPE.TEXT},C);b=k}else if(L!=null){var I=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,L==null?void 0:L.payload);if(v=o("WAParseMediaTransportProtocol").parseStickerMsg(I,l.ts),v){var T=babelHelpers.extends({mediaId:v.plaintextHash,type:o("MAWMsgType").MSG_TYPE.STICKER},C);b=T}else{var D;if(((D=I.integral)==null?void 0:D.receiverFetchId)!=null){if(S=o("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(I),S==null)throw r("FBLogger")("messenger_web").mustfixThrow("consumerMessage has no sticker receiver fetch info");var x=babelHelpers.extends({type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH},C);b=x}else throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage sticker has no media")}}else if(E!=null){var $,P,N=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").VideoTransportSpec,E==null?void 0:E.payload),M=N==null||($=N.integral)==null||($=$.transport)==null||($=$.ancillary)==null?void 0:$.mimetype,w=(N==null||(P=N.ancillary)==null?void 0:P.gifPlayback)===!0&&M==="image/gif";if(v=o("WAParseMediaTransportProtocol").parseVideoMsg(N,l.ts,w),v&&w){var A=babelHelpers.extends({mediaId:v.plaintextHash,type:o("MAWMsgType").MSG_TYPE.GIF},C);b=A}else throw v?r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video is not a gif"):r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video has no media")}else throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no valid content");return{contentTypeForLogging:"noteReplyMessage",unstoredMedia:v,unstoredMsg:b,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:S,unstoredXMA:null}}l.default=e}),98);
__d("MAWParseRavenActionNotificationMsg",["FBLogger","MAWMsg","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t,n,a,i,l=e.content,s=e.meta,u=(t=l.ravenActionNotifMessage)==null?void 0:t.actionType,c=o("MAWMsg").MAWRavenActionNotifType.cast(u),d=(n=l.ravenActionNotifMessage)==null?void 0:n.actionTimestamp,m;if(d!=null){var p=Number(d);p>o("WATimeUtils").MAX_INT?m=o("WATimeUtils").castMilliSecondsToUnixTime(p):m=o("WATimeUtils").castToUnixTime(p)}var _=((a=l.ravenActionNotifMessage)==null||(a=a.key)==null?void 0:a.id)!=null?o("WAStanzaUtils").toStanzaId((i=l.ravenActionNotifMessage)==null||(i=i.key)==null?void 0:i.id):null;if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when getting actionType for RavenNotificationMessage "+s.id.externalId);if(m==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when getting actionTimestamp for RavenNotificationMessage "+s.id.externalId);if(_==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when getting ravenActionToMsgExternalId for RavenNotificationMessage "+s.id.externalId);var f={ack:s.ack,actionTimestamp:m,actionType:c,id:s.id,ravenActionToMsgExternalId:_,sentTs:s.sentTs,serverTs:s.serverTs,ts:s.serverTs,type:"RavenAction"};return{unstoredMedia:null,unstoredMsg:f,unstoredQuotedMedia:null,unstoredXMA:null}}l.parseRavenActionNotificationMessage=e}),98);
__d("MAWParseRavenMsg",["FBLogger","MAWMsg","MAWMsgType","MAWParseSubprotocolVersionConsts","WALogger","WAMediaTransport.pb","WAParseMediaTransportProtocol","WAParseProtocolUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){var n=t.content,a=t.ebTimestampMs,i=t.meta,l=t.metadata,u=n.ravenMessageMsgr;if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("Raven message payload has no content");var c=o("MAWMsg").MAWRavenMsgEphemeralType.cast(u.ephemeralType);if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when casting ephemeralType for Raven message");var d=void 0,m=void 0;if(u.imageMessage)(u.imageMessage.version==null||u.imageMessage.version<o("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["\n        received image messsage version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION),d=o("WAParseMediaTransportProtocol").decodeImageTransport(u.imageMessage.payload,i.ts,"image"),m=o("MAWMsg").MAWRavenMsgMediaType.IMAGE;else if(u.videoMessage){(u.videoMessage.version==null||u.videoMessage.version<o("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["\n        received video messsage version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION);var p=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").VideoTransportSpec,u.videoMessage.payload);d=o("WAParseMediaTransportProtocol").parseVideoMsg(p,i.ts,!1),m=o("MAWMsg").MAWRavenMsgMediaType.VIDEO}else throw r("FBLogger")("messenger_web").mustfixThrow("Error unsupported Raven message type");if(d==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error Raven message has no associated image or video");var _=o("WAParseProtocolUtils").parseEphemerality(i,l),f=_.deleteTs,g=_.ephemeralSetting,h=_.expirationTs,y={ack:i.ack,deleteTs:f,ebTimestampMs:a,ephemeralSetting:g,expirationTs:h,id:i.id,mediaId:d.plaintextHash,ravenEphemeralMediaState:c===o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?o("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:c,ravenMediaType:m,reportingMeta:i.reportingMeta,sentTs:i.sentTs,serverTs:i.serverTs,ts:i.ts,type:o("MAWMsgType").MSG_TYPE.RAVEN};return{unstoredMedia:d,unstoredMsg:y,unstoredQuotedMedia:null,unstoredXMA:null}}l.parseRavenMessage=u}),98);
__d("MAWParseScreenshotActionMsg",["FBLogger","MAWExternalId","MAWMsgType","WAAckLevel","WAArmadilloApplication.pb","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.content,n=e.meta,a=t.screenshotAction;if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("screenshotAction has no content");var i=a.screenshotType;if(i==null)throw r("FBLogger")("messenger_web").mustfixThrow("Missing screenshot type in payload");if(![o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE,o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING].includes(i))throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type");var l={ack:o("WAAckLevel").ACK.SENT,id:{author:o("WAJids").AUTHOR_SYSTEM,chat:n.id.chat,externalId:o("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:[],adminType:"youEphemeralTakeScreenshot",screenshotActionType:i},ts:n.serverTs,type:o("MAWMsgType").EPHEMERAL_SCREENSHOT_ACTION};return{contentTypeForLogging:"screenshotAction",unstoredMedia:null,unstoredMsg:l,unstoredQuotedMedia:null,unstoredXMA:null}}l.parseEphemeralScreenshotActionProtocol=e}),98);
__d("MAWParseArmadilloProtocol",["FBLogger","MAWMessageParseError","MAWMsgType","MAWParseBumpExistingMessageMsg","MAWParseNetworkVerificationMsg","MAWParseNoteReplyMsg","MAWParseRavenActionNotificationMsg","MAWParseRavenMsg","MAWParseScreenshotActionMsg","MAWParseXMAProtocol","WAArmadilloApplication.pb","WAHex","WALogger","decodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null},c=new Map([["screenshotAction",o("MAWParseScreenshotActionMsg").parseEphemeralScreenshotActionProtocol],["extendedContentMessage",o("MAWParseXMAProtocol").parseXMAProtocol],["paymentsTransactionMessage",o("MAWParseXMAProtocol").parseXMAProtocol],["noteReplyMessage",r("MAWParseNoteReplyMsg")],["bumpExistingMessage",r("MAWParseBumpExistingMessageMsg")],["ravenMessageMsgr",o("MAWParseRavenMsg").parseRavenMessage],["ravenActionNotifMessage",o("MAWParseRavenActionNotificationMsg").parseRavenActionNotificationMessage],["networkVerificationMessage",o("MAWParseNetworkVerificationMsg").parseNetworkVerificationMsg]]);function d(t,n,a,i,l,u){var d,_=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAArmadilloApplication.pb").ArmadilloSpec,n),f=(d=_.payload)==null?void 0:d.content;if(!f)throw new(o("MAWMessageParseError")).MAWMessageParseError("parse_armadillo_protocol_error:: empty_payload_content");var g=p(f);try{var h=c.get(g),y=null;if(h!=null){var C=h({chat:t,content:f,ebTimestampMs:u,meta:a,metadata:l,protobuf:i});if(typeof C!="string")return C;y=C}return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - handling futureproof message for contentType: ",""])),g),{contentTypeForLogging:g,unstoredMedia:null,unstoredMsg:{ack:a.ack,id:a.id,msgContent:{protobuf:o("WAHex").bytesToBuffer(i),subtype:y!=null?y:m(g)},reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.ts,type:o("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null}}catch(e){var b=r("getErrorSafe")(e);throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - Dropping message. contentType: ",", reason: ",""])),g,b.message),new(o("MAWMessageParseError")).MAWMessageParseError("parse_armadillo_protocol_error:: contentType:: "+g+" reason:: "+b.message)}}function m(e){switch(e){case"bumpExistingMessage":return"bumpMessage";default:return null}}function p(e){var t=Object.keys(e).filter(function(e){return e!=="$$unknownFieldCount"});if(t.length!==1)throw r("FBLogger")("messenger_web").mustfixThrow(JSON.stringify(e)+" armadillo payload content should only have one field");var n=t[0];return n}l.EMPTY_CONTENT=u,l.parseArmadilloProtocol=d,l.parseOneOfContentType=p}),98);
__d("MAWXMALoggingUtils",["WAArmadilloXMA.pb","objectEntries"],(function(t,n,r,o,a,i,l){"use strict";var e=r("objectEntries")(o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE).reduce(function(e,t){var n=t[0],r=t[1];return e.set(r,n),e},new Map);function s(t){return t!=null?e.get(t):void 0}l.getXmaTargetTypeStringFromEnum=s}),98);
__d("MAWParseXMAProtocol",["FBLogger","MAWMsgType","MAWODSProxy","MAWParseArmadilloProtocol","MAWParseCollapsibleIdFromXMADataClass","MAWParseSubprotocolVersionConsts","MAWParseXMAFBConfig","MAWParseXMAUnsupportedMessageType","MAWXMALoggingUtils","MWXMAV2IsCollapsibleXMA","MWXMAV2XmaDataClass","WAArmadilloXMA.pb","WAGetPlatformFromStanzaId","WAHex","WAJids","WALogger","WAMedia","WAMsgApplication.pb","WAOdsEnums","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAParseProtocolUtils","WAStanzaUtils","WATimeUtils","decodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["actionContentBlob"],s,u,c,d,m,p,_,f,g,h,y,C,b,v=new Set([o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY]);function S(e,t){if(!(e==null||e.payload==null))return o("WAParseMediaTransportProtocol").decodeImageTransport(e.payload,t,"xma-image")}function R(e,t,n,a,i){if(t==null||t.payload==null)return null;t.version!==o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[XMA] received associated message with incorrect version ",""])),t.version);var l=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgApplication.pb").MessageApplicationSpec,t.payload),u=o("WAParseMessageApplication").parseMessageApplication(l);if(u.type==="error")throw r("FBLogger")("messenger_web").mustfixThrow("XMA contains unparseable message application.");var c=u;if(c.subprotocolType!=="consumerMessage")throw r("FBLogger")("messenger_web").mustfixThrow("XMA contains incorrect message application type: "+c.subprotocolType);return o("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(e,c.payload,n,a,i)}var L="https://www.instagram.com/stories/",E="https://www.instagram.com/reel/",k="https://www.instagram.com/tv/",I="https://www.instagram.com/_n/profile_shop?",T="https://www.instagram.com/",D="https://www.alpha.facebook.com/share/",x="https://m.facebook.com/share/",$="https://www.facebook.com/share/",P="https://m.alpha.facebook.com/share/",N="https://facebook.com/share/",M="https://www.alpha.facebook.com/stories/",w="https://www.facebook.com/stories/",A="https://fb.gg/",F="https://www.facebook.com/",O="https://m.facebook.com/",B="https://www.alpha.facebook.com/",W="https://m.alpha.facebook.com/",q="https://facebook.com/",U="https://fb.watch/",V="https://www.facebook.com/l.php",H="https://m.facebook.com/l.php",G="https://www.alpha.facebook.com/l.php",z="https://m.alpha.facebook.com/l.php",j="https://facebook.com/l.php",K="https://l.facebook.com/l.php",Q="https://facebook.com/events/",X="https://www.facebook.com/events/",Y="https://www.alpha.facebook.com/events/",J="https://m.facebook.com/events/",Z="https://m.alpha.facebook.com/events/",ee="fb-messenger://payments/receipt?product_id=",te="messenger://location_share",ne="http://m.me/",re=":",oe="http://",ae="https://";function ie(t){var n,a,i,l,s,_=t.chat,f=t.content,g=t.ebTimestampMs,h=t.meta,y=t.metadata,C=t.protobuf,b=o("MAWParseArmadilloProtocol").parseOneOfContentType(f),L=b==="paymentsTransactionMessage",E=null;if(L){var k;E=(k=f.paymentsTransactionMessage)==null?void 0:k.extendedContentMessage}else E=f.extendedContentMessage;if(E==null&&L)return"paymentsTransactionMessage";if(E==null)throw r("FBLogger")("messenger_web").mustfixThrow("extendedContentMessage has no content");var I=E,T=I.targetType,D=I.xmaDataclass,x=o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(h.id.externalId);if(D!=null&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_dataclass.exists."+(T!=null?T:"null")}),T==null||!o("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:T,xmaDataclass:D}))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:{ack:h.ack,id:h.id,msgContent:{protobuf:o("WAHex").bytesToBuffer(C),subtype:o("MAWParseXMAUnsupportedMessageType").getXMAUnsupportedMessageType(T,D,L)},reportingMeta:h.reportingMeta,sentTs:h.sentTs,serverTs:h.serverTs,ts:h.ts,type:o("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null,xmaTargetTypeForLogging:T};var $=o("WAParseProtocolUtils").parseEphemerality(h,y),P=$.deleteTs,N=$.ephemeralSetting,M=$.expirationTs,w=o("WAParseProtocolUtils").enhanceReportingMeta(h,y),A=E,F=A.associatedMessage,O=A.commands,B=A.contentRef,W=A.ctas,q=A.favicon,U=A.headerImage,V=A.headerTitle,H=A.maxSubtitleNumOfLines,G=A.maxTitleNumOfLines,z=A.mentionedJid,j=A.messageText,K=A.overlayDescription,Q=A.overlayIconGlyph,X=A.overlayTitle,Y=A.previews,J=A.sentWithMessageId,Z=A.subtitleText,ee=A.targetId,te=A.targetUsername,ne=A.titleText,re=A.xmaLayoutType;F!=null&&(F.version==null||F.version<o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["\n      received associatedMessage version is older than expected "," as expected. "])),o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION),U!=null&&(U.version==null||U.version<o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["\n    received headerImage version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION),q!=null&&(q.version==null||q.version<o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["\n    received favicon version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION),Y.every(function(e){(e.version==null||e.version<o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["\n      received previews version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)});var oe=E.targetExpiringAtSec!=null?o("WATimeUtils").castLongIntToUnixTime(E.targetExpiringAtSec):void 0,ae=F!=null&&J!=null?[o("WAStanzaUtils").toStanzaId(J),h.id.externalId]:[h.id.externalId,void 0],ie=ae[0],le=ae[1],se=[];if(Y!=null)for(var ue=0;ue<Y.length;ue++){var ce,de,me=S(Y[ue],h.ts);me!=null&&!((T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE||T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE)&&me.mediaType===o("WAMedia").MEDIA_TYPE.IMAGE&&((ce=me.validatedImageInfo)==null?void 0:ce.height)===1&&((de=me.validatedImageInfo)==null?void 0:de.width)===1)&&se.push(me)}var pe=S(U,h.ts),_e=S(q,h.ts),fe=(n=o("WAParseConsumerMessageProtocol").parsedQuotedConsumerMessage(y))!=null?n:void 0,ge=o("MWXMAV2XmaDataClass").parseXmaDataClass(D),he;if(o("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(ge))try{he=o("MAWParseCollapsibleIdFromXMADataClass").parseCollapsibleIdFromXMADataClass(ge)}catch(e){var ye=r("getErrorSafe")(e);throw o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation."+x+"."+(T||0)+".error"}),r("FBLogger")("messenger_web").mustfixThrow("Unexpected error trying to parse collapsible ID: "+ye.message)}var Ce=babelHelpers.extends({collapsibleId:he,deleteTs:P,ebTimestampMs:g,ephemeralSetting:N,expirationTs:M,id:babelHelpers.extends({},h.id,{externalId:ie}),quote:fe,reportingMeta:w,type:o("MAWMsgType").MSG_TYPE.XMA},h),be=W.map(function(t){var n=t.actionContentBlob,r=babelHelpers.objectWithoutPropertiesLoose(t,e);return r}),ve=be.slice(1);T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE&&W.length===1&&(ve=be);var Se=T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT,Re={author:h.id.author,commands:O,contentRef:B,ctas:ve,defaultCTA:be[0],externalId:ie,faviconMediaId:Se?pe==null?void 0:pe.plaintextHash:_e==null?void 0:_e.plaintextHash,headerMediaId:Se?_e==null?void 0:_e.plaintextHash:pe==null?void 0:pe.plaintextHash,headerTitle:V,isTombstoned:oe!=null?o("WATimeUtils").unixTime()>oe:!1,maxSubtitleNumOfLines:H,maxTitleNumOfLines:G,mentionedJids:z.map(o("WAJids").validateUserJid).filter(Boolean),overlayDescription:K,overlayIconGlyph:Q,overlayTitle:X,previewMediaIds:se.length>0?se.map(function(e){return e.plaintextHash}):void 0,sentWithMessage:j,subtitleText:Z,targetExpiringAtSec:oe,targetId:ee,targetType:T,targetUsername:te,threadJid:_,titleText:ne,xmaDataclass:D,xmaLayoutType:re},Le;if(F!=null&&J==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA associatedMessage cannot be received without sentWithMessageId field");F!=null&&le!=null&&(Le=R(_,F,h,C,y));var Ee=(a=(i=Le)==null?void 0:i.unstoredMedia)!=null?a:null,ke=v.has(T);if(Ee!=null&&!ke){var Ie=o("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(T);throw o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"assoc_msg_media_"+(Ie!=null?Ie:"unknown")}),r("FBLogger")("messenger_web").mustfixThrow("XMA associated msg cannot have additioinal dbMedia")}var Te=(l=(s=Le)==null?void 0:s.unstoredMsg)!=null?l:null;if(le!=null&&Te!=null&&(o("WALogger").DEV(p||(p=babelHelpers.taggedTemplateLiteralLoose(["ExternalId: "," textId: ",""])),ie,le),Te.id=babelHelpers.extends({},Te.id,{externalId:le}),Ce.id=babelHelpers.extends({},Te.id,{externalId:ie}),Re.externalId=ie),ke&&Ee!=null&&((Te==null?void 0:Te.type)==="Gif"||(Te==null?void 0:Te.type)==="Sticker"))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:Ce,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:Ee,unstoredAssociatedMsg:Te,unstoredFavicon:Se?se[0]:_e,unstoredHeaderMedia:pe,unstoredPreviews:se.length>0?se:void 0,xma:Re},xmaTargetTypeForLogging:T};if(Te!=null&&Te.type!=="Text")throw r("FBLogger")("messenger_web").mustfixThrow('XMA associated msg cannot have type different from "Text". Received type: '+Te.type);return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:Ce,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:Te,unstoredFavicon:Se?se[0]:_e,unstoredHeaderMedia:pe,unstoredPreviews:se.length>0&&!Se?se:void 0,xma:Re},xmaTargetTypeForLogging:T}}function le(e){var t=e.ebRestore,n=e.hasActionUrl,r=e.hasNativeUrl,a=e.isActionUrlValid,i=e.isNativeUrlValid,l=e.targetType;!i&&!a?o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action and native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),t!=null&&t?"[labyrinth_web]":"[S410301][transport]",l,r,n):i&&!a?o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),t!=null&&t?"[labyrinth_web]":"[S410301][transport]",l,r,n):a&&!i&&o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),t!=null&&t?"[labyrinth_web]":"[S410301][transport]",l,r,n)}function se(e,t,n){var r=e.nativeUrl,o=e.actionUrl,a=ue(r,t,n),i=ue(o,t,n);return le({ebRestore:n,hasActionUrl:o!=null,hasNativeUrl:r!=null,isActionUrlValid:i,isNativeUrlValid:a,targetType:t}),a&&i}function ue(e,t,n,r){return r===void 0&&(r=!1),e==null?!0:_e(e,t)===!1?(n!=null&&n&&!r&&o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid url prefix during XMA restore"]))),!1):fe(e)?!0:(n!=null&&n&&!r&&o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid message text during XMA restore"]))),!1)}function ce(e){return e.startsWith(D)||e.startsWith(x)||e.startsWith($)||e.startsWith(P)||e.startsWith(N)}function de(e){return e.startsWith(V)||e.startsWith(H)||e.startsWith(G)||e.startsWith(z)||e.startsWith(j)||e.startsWith(K)}function me(e){return e.startsWith(F)||e.startsWith(O)||e.startsWith(B)||e.startsWith(W)||e.startsWith(q)}function pe(e){return e.startsWith(Q)||e.startsWith(X)||e.startsWith(Y)||e.startsWith(J)||e.startsWith(Z)}function _e(e,t){if(e==null)return!0;switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REACTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:return e.startsWith(L);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return e.startsWith(E);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return e.startsWith(k);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return e.startsWith(I);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_IG_MEDIA_SHARE:return e.startsWith(T);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return e.startsWith(w)||e.startsWith(M)||ce(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:return me(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return e.startsWith(A);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:return(me(e)||e.startsWith(U))&&!de(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return e.startsWith(te);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_LOCAL_EVENT_REPLY:return pe(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return pe(e)||ce(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:return me(e)||e.startsWith(ne);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_EXTERNAL_LINK:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL:if(e.includes(re)&&!e.startsWith(oe)&&!e.startsWith(ae)){var n=e.indexOf("://");return n===-1&&o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(['S410301 The url is invalid. It contains a colon separator, but not "://"']))),!1}break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_RECEIVER_FETCH:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.DATACLASS_SENDER_COPY:return!0;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_P2P_PAYMENT:return e.startsWith(ee)}return!0}function fe(e){for(var t=0;t<e.length;t++){var n=e.charAt(t);switch(n){case"\u202C":case"\u202D":case"\u202E":return o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["S410301 The url contains RTL characters"]))),!1;default:break}}return!0}l.SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES=v,l.kIGStoryCtaPrefix=L,l.kIGClipsCtaPrefix=E,l.kIGTVCtaPrefix=k,l.kIGShopCtaPrefix=I,l.kIGDefaultCtaPrefix=T,l.kFBStoryCtaPrefix=w,l.kFBGamingCustomUpdateCtaPrefix=A,l.kFBDefaultWWWCtaPrefix=F,l.kFBEventCtaPrefix=Q,l.kMSGP2PPaymentUrlPrefix=ee,l.kMessengerLocationSharePrefix=te,l.kHttpPrefix=oe,l.parseXMAProtocol=ie,l.isValidCTA=se,l.isURLValid=ue}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","MAWBridge","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTransactionMode","Promise","WAArmadilloXMA.pb","WAHashUtils","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y=function(t,r,a){r==null||r.addPoint("xma_restore_start");var e=t.restoredMsgsData;if(e){var i=e.newlyAddedMsgs,l=i.concat(e.existingMsgs),s=[];return l.map(function(e){var n=e.externalId,r=t.echoMsgMap.get(n);r!=null&&r.contentType===o("EchoMessage").EchoMessageContentType.XMA&&s.push(e)}),s.length===0?(h||(h=n("Promise"))).resolve():C(s,t.echoMsgMap,a).then(function(e){return r==null||r.addPoint("xma_restore_end",{int:{xma:e.length}}),(h||(h=n("Promise"))).resolve()})}return r==null||r.addPoint("xma_restore_end",{int:{xma:0}}),(h||(h=n("Promise"))).resolve()};function C(t,r,a){var i=new Map,l=new Map;t.forEach(function(e){var t,n,a=r.get(e.externalId),s=a==null||(t=a.mediaData)==null?void 0:t.attachmentObjectId;s!=null&&i.set(o("WAMediaUtils").stringToDeliveryObjectId(s),e);var u=a==null||(n=a.mediaData)==null?void 0:n.plaintextHash;if(u!=null){var c=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(u)),d=l.get(c);l.set(c,d!=null?[].concat(d,[e.msgId]):[e.msgId])}});var u=Array.from(i.keys()),c=new Map;return b(l).then(function(l){var d=[];return u.forEach(function(e){var t,n=(t=i.get(e))==null?void 0:t.externalId;n!=null&&c.set(n,e)}),t.filter(function(e){return o("MAWDbMsg").isXMAMsg(e)}).forEach(function(t){var n=r.get(t.externalId);if(n){var a=c.get(t.externalId),i;if(a!=null){var u=l.get(a);u!=null&&(i=u.mediaId)}var m=n.serializationOrigin;m==null&&(m=o("EchoMessage").EchoSerializationOriginType.UNKNOWN);var p=S(t,n,i,m);p==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""])),m):(p.targetType===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&t.msgContent==null&&(o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""])),m),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),d.push(p))}}),v(d).then(function(e){return e.length>0&&e.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=c.get(e.externalId);if(a!==!0){var n;t!=null&&(n=l.get(t));var r=yield o("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(n,e);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:r}]})}});return function(t){return e.apply(this,arguments)}})()),e})})}var b=o("MAWIndexedDb").makeMsgrTransactor({media:o("MAWTransactionMode").READONLY,mediaBackup:o("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(e){return function(t){var n=Array.from(t.keys());return o("MAWDbMediaTxns").maybeBulkGetMediaFromPlaintextHash(e,n).then(function(e){var n=new Map;return e.forEach(function(e){var r=t.get(e.plaintextHash);r==null||r.forEach(function(t){var r=e==null?void 0:e.mediaEntries.get(t);if(e!=null&&r!=null){var a=o("WAMediaUtils").decodeMediaEntryData(r);a.objectId!=null&&n.set(o("WAMediaUtils").stringToDeliveryObjectId(a.objectId),e)}else o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][getMediaForXMAByObjectIds] mediaEntry is null for media restore"])))})}),n})}}),v=o("MAWIndexedDb").makeMsgrTransactor({xma:o("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(e){return function(t){return e.xma.bulkAdd(t,{allKeys:!0}).then(function(e){return e.map(function(e,n){return babelHelpers.extends({},t[n],{xmaId:e})})})}});function S(e,t,n,r){var a,i,l,s,u,h,y,C,b,v,S,L,E,k,I,T;if(t.xmaData==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""])),r),null;var D;if(t.xmaData.xmaDefaultCTA!=null){var x;D=R((x=t.xmaData)==null?void 0:x.xmaDefaultCTA)}else o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""])),r);var $;if(((a=t.xmaData)==null?void 0:a.xmaTargetType)!=null)$=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(t.xmaData.xmaTargetType);else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""])),r),null;var P;((i=t.xmaData)==null?void 0:i.xmaGatingType)!=null?P=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(t.xmaData.xmaGatingType):o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""])),r);var N;((l=t.xmaData)==null?void 0:l.xmaLayoutType)!=null?N=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(t.xmaData.xmaLayoutType):o("WALogger").WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""])),r);var M;if(e.threadJid!=null)M=e.threadJid;else return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""])),r),null;if(D!=null&&!o("MAWParseXMAProtocol").isValidCTA(D,$,!0))return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""])),r),null;var w;return((s=t.xmaData)==null?void 0:s.xmaContentRef)!=null&&(w=t.xmaData.xmaContentRef),{author:e.author,contentRef:w,ctas:[],defaultCTA:D,defaultPreviewMediaId:n!=null?n:void 0,externalId:e.externalId,headerTitle:t==null||(u=t.xmaData)==null?void 0:u.xmaHeaderTitle,isTombstoned:t==null||(h=t.xmaData)==null?void 0:h.xmaIsTombstoned,maxSubtitleNumOfLines:t==null||(y=t.xmaData)==null?void 0:y.xmaMaxSubtitleNumLines,maxTitleNumOfLines:t==null||(C=t.xmaData)==null?void 0:C.xmaMaxTitleNumLines,msgId:e.msgId,overlayIconGlyph:P,overlayTitle:t==null||(b=t.xmaData)==null?void 0:b.xmaHeaderSubtitle,previewMediaIds:n!=null?[n]:[],subtitleText:t==null||(v=t.xmaData)==null?void 0:v.xmaSubtitleText,targetExpiringAtSec:((S=t.xmaData)==null?void 0:S.xmaTargetExpiry)!=null?o("WATimeUtils").castToUnixTime(Number((L=t.xmaData)==null?void 0:L.xmaTargetExpiry)):void 0,targetId:t==null||(E=t.xmaData)==null?void 0:E.xmaTargetId,targetType:$,targetUsername:t==null||(k=t.xmaData)==null?void 0:k.xmaTargetUsername,threadJid:M,titleText:(I=t.xmaData)==null?void 0:I.xmaTitleText,xmaDataclass:(T=t.xmaData)==null?void 0:T.xmaDataclass,xmaLayoutType:N}}function R(e){return{actionUrl:e,buttonType:o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:e}}l.writeXMAToXMAStore=y,l.getMediaForXMAByObjectIds=b,l.writeXMAsToDb=v,l.getDefaultCTA=R}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum","MAWJids","WAGlobals","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message"}),s=":";function u(e,t){return""+e+s+t}function c(e){return e.split(s)[1]}function d(e,t){var n=t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),r=new RegExp("^"+n,"i");return r.test(e)}function m(t){return d(t,e.REACTION)}function p(t){return d(t,e.EDIT)}function _(t){return d(t,e.RAVEN_ACTION_MESSAGE)}function f(t){var n=t.split(s);if(n.length===1)return{rawIdentifierString:t,type:"poll_update"};var r=n[0];if(n.length<2||n.length>3)return{prefix:r,rawIdentifierString:t,type:"unknown"};var a=n[1],i=o("MAWJids").toUserJid(a);if(r===e.REACTION)return{senderJid:i,type:"reaction"};var l=n.length===3?o("WATimeUtils").castToMillisTime(Number(n[2])):null;return r===e.RAVEN_ACTION_MESSAGE?{senderJid:i,type:"raven_action_message"}:l==null?{prefix:r,rawIdentifierString:t,type:"unknown"}:r===e.EDIT?{senderJid:i,ts:l,type:"edit"}:{prefix:r,rawIdentifierString:t,type:"unknown"}}function g(t){switch(t.type){case"edit":return""+e.EDIT+s+o("WAJids").extractUserId(t.senderJid)+s+t.ts.toString();case"reaction":return""+e.REACTION+s+o("WAJids").extractUserId(t.senderJid);case"raven_action_message":return""+e.RAVEN_ACTION_MESSAGE+s+o("WAJids").extractUserId(t.senderJid);case"poll_update":return t.rawIdentifierString}}function h(t){var n;if(o("WAJids").isAuthorMe(t))n=o("WAGlobals").getMyUserJid();else{var r=o("WAJids").interpretAndValidateJid(t);if(r.jidType==="msgrUser")n=r.userJid;else return null}var a=o("WAJids").userIdFromJid(n);return""+e.REACTION+s+a}function y(t,n){var r;if(o("WAJids").isAuthorMe(t))r=o("WAGlobals").getMyUserJid();else{var a=o("WAJids").interpretAndValidateJid(t);if(a.jidType==="msgrUser")r=a.userJid;else return null}var i=o("WAJids").userIdFromJid(r);return""+e.EDIT+s+i+s+n.toString()}l.SupplementalKeyPrefix=e,l.SUPPLEMENTAL_KEY_DELIMITER=s,l.createMessageSupplementalKey_DEPRECATED=u,l.getSupplementalSenderId_DEPRECATED=c,l.isSupplementalProtobufAReaction=m,l.isSupplementalProtobufAnEdit=p,l.isSupplementalProtobufARavenAction=_,l.parseIdentifierString=f,l.toIdentifierString=g,l.createReactionSupplementalKey=h,l.createEditSupplementalKey=y}),98);
__d("PersistedQueuesSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";var e={autoIncrement:!0,indexes:{"[jid+priority+stanzaId]":{fields:["jid","priority","stanzaId"],unique:!1},priority:{fields:["priority"],unique:!1}},nonEncryptedFields:["priority","stanzaId"],primaryKey:"stanzaQueueId",secure:!0},s={autoIncrement:!0,indexes:{},nonEncryptedFields:["uploadStatus","uploadTsSec","backupActionType"],primaryKey:"queueId",secure:!0},u={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},c={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},d={danglingQueue:u,ebSenderUploadQueueV3:c,ebUploadQueue:s,stanzaQueue:e};function m(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="pqdb",u=new(o("WormEAR")).WormEAR(d,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,d,u,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.makePersistedQueueSchema=m}),98);
__d("PersistedQueueDB",["FBLogger","PersistedQueuesSchema","Promise","WAResolvable","WormEAR","asyncToGeneratorRuntime","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new(o("WAResolvable")).Resolvable;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.blockingErrorThreshold,i=t.dbName,l=t.onBlockingError,c=t.qplEvent,d=t.strEncKey;try{var m=o("PersistedQueuesSchema").makePersistedQueueSchema(i,d,a,l,function(t){if(t instanceof o("WormEAR").DecryptionError){var a,i,l=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",l.store),r("promiseDone")((a=(i=s)==null?void 0:i.runInTransaction([l.store],"readwrite",function(e){var t=e.stores[l.store];return l.maybeHashedPk!=null?t.delete(l.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?a:(e||(e=n("Promise"))).resolve())}},c);return s=m,yield m.init(),u.resolve(m),m}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing PersistedQueue init"),e}}),d.apply(this,arguments)}function m(){if(s==null)throw r("err")("PersistedQueue is not initialized");return s}function p(){return u.promise}l.makePersistedQueues=c,l.getPersistedQueues=m,l.getDbPromise=p}),98);
__d("WAThrottle",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=0,r=null,o;function a(){for(var a=Date.now(),i=a-n,l=arguments.length,s=new Array(l),u=0;u<l;u++)s[u]=arguments[u];o=s,i>=t?(clearTimeout(r),r=null,e.apply(void 0,s),n=Date.now()):r==null&&(r=setTimeout(function(){return e.apply(void 0,o)},t-i))}return a}i.throttle=e}),66);
__d("PersistedQueueApi",["PersistedQueueDB","WALogger","WAThrottle","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=36e5,u=function(t,n){return"PersistedQueue:"+t+":"+n};function c(){return{ack:p,clear:_,count:b,delete:f,get:d,index:m,keys:h,read:g,write:y}}function d(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){var r=n.stores[e];return r.get(t)},u(e,"get"))}function m(e,t){return{equals:function(r){return{read:function(a){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexRange(t,{only:r},a)},u(e,"index-equal"))}}},keys:function(){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexKeys(t)},"index-keys")},read:(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=yield o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(r){return r.stores[e].readIndex(t,void 0,n)},u(e,"index-read"));return r});function a(e){return r.apply(this,arguments)}return a})()}}function p(e,t){return f(e,t)}function _(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(t){return t.stores[e].clear()},u(e,"clear"))}function f(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e];yield r.bulkDelete(t),v(e)});return function(e){return r.apply(this,arguments)}})(),u(e,"delete"))}function g(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readAll(t)},u(e,"read"))}function h(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].readKeys()},u(e,"keys"))}function y(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(n){return n.stores[e].bulkAdd(t)},u(e,"write"))}function C(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.stores[e],r=yield n.readAll({limit:1});r.length===0&&(yield n.clear())});return function(e){return t.apply(this,arguments)}})(),u(e,"ClearIfEmpty"))}function b(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].count()},u(e,"count"))}var v=o("WAThrottle").throttle(function(t){C(t).catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueueV2] Error during PQ clear operation of ",": ",""])),t,n)})},s);l.persistedQueueApi=c,l.persistedQueueGet=d,l.persistedQueueIndex=m,l.persistedQueueAck=p,l.persistedQueueClear=_,l.persistedQueueDelete=f,l.persistedQueueRead=g,l.persistedQueueKeys=h,l.persistedQueueWrite=y,l.clearIfEmpty=C,l.persistedQueueCount=b}),98);
__d("WAMapContentTypeToFbType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"text":return"text";case"media":return"media";case"reaction":return"reaction";case"live_location":case"pay":case"product_list":case"poll_creation":case"poll_vote":case"scheduled_call":return"text";default:return"text"}}i.mapContentTypeToFbType=e}),66);
__d("WAPersistedQueueCache",["WAResolvable","WAShiftTimer","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,r,a){var i=o("WATagsLogger").TAGS(["PersistedQueue",t,"cache"]),l=[],s=new(o("WAResolvable")).Resolvable,u=a!=null?a:{},c=new(o("WAShiftTimer")).ShiftTimer(function(){p()});return{commit:function(){return p()},add:function(t){l.push(t);var e=s;return d(),m(),e.promise},config:function(t){u=t}};function d(){u.cacheSize!=null&&l.length>=u.cacheSize&&p()}function m(){if(u.maxDelay!=null){var e=u.maxDelay;c.cancel(),c.onOrAfter(e)}}function p(){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(l.length!==0){c.cancel();var t=l;l=[];var n=s;s=new(o("WAResolvable")).Resolvable;try{yield r(t),n.resolve()}catch(t){throw i.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during flush: ",""])),t),n.reject(t),t}}}),_.apply(this,arguments)}}l.makePersistedQueueCache=s}),98);
__d("WAPersistedQueue",["WAPersistedQueueCache","WAPubSub"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n){var r=this;this.$1=o("WAPubSub").simplePubSub(),this.$3=e,this.$4=t,this.$2=o("WAPersistedQueueCache").makePersistedQueueCache(e,function(n){return t.write(e,n).then(function(e){r.$1.publish({type:"flush"})})},n)}var t=e.prototype;return t.subscribe=function(t){return this.$1.subscribe(t)},t.index=function(e){return this.$4.index(this.$3,e)},t.keys=function(){return this.$4.keys(this.$3)},t.get=function(t){return this.$4.get(this.$3,t)},t.read=function(t){return this.$4.read(this.$3,t)},t.addAndCommit=function(t){var e=this;return this.$1.publish({type:"new_entity"}),this.$4.write(this.$3,t).then(function(t){return e.$1.publish({type:"flush"}),t})},t.commit=function(){return this.$2.commit()},t.ack=function(t){return this.$4.ack(this.$3,t)},t.delete=function(t){return this.$4.delete(this.$3,t)},t.clear=function(){return this.$4.clear(this.$3)},t.count=function(){return this.$4.count(this.$3)},e})();function s(t,n,r){return new e(t,n,r)}l.PersistedQueue=e,l.initPersistedQueue=s}),98);
__d("WAProtocolQueue",["PersistedQueueApi","WAGlobals","WAJids","WALogger","WAMapContentTypeToFbType","WAPersistedQueue"],(function(t,n,r,o,a,i,l){"use strict";var e,s=5e3,u=null;function c(t){if(u!=null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Protocol Queue is already initialized"]))),u;var n=o("WAPersistedQueue").initPersistedQueue("stanzaQueue",t,{cacheSize:null,maxDelay:s});return u=n,u}function d(){return u||c(o("PersistedQueueApi").persistedQueueApi())}var m=(function(){function e(){this.$1=[],this.$2=[],this.$3=[]}var t=e.prototype;return t.enqueue=function(t,n,r){this.$1.push(t),n&&this.$2.push(n),r&&this.$3.push(r)},t.flush=function(t,n,r,o){var e=this.$1,a=this.$2,i=this.$3;return this.$1=[],this.$2=[],this.$3=[],d().addAndCommit(e).then(function(){return a.forEach(function(e){return e()})}).catch(function(e){return i.forEach(function(t){return t(e)})})},e})(),p=new m;function _(e){return e.map(function(e){return e.type==="message"?f(e):babelHelpers.extends({},e)})}function f(e){switch(e.subtype){case"unavailable":{var t=e,n=o("WAJids").extractUserJid(t.from),r={id:{author:o("WAGlobals").getMyUserJid()===n?"@me":n,chat:t.jid,externalId:t.stanzaId},ts:t.serverTs,type:"UnavailableMsg"};return{incomingType:"wa-incoming",jid:t.jid,message:{decrypted:r,details:{count:null,externalId:t.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(t.jid,{group:function(n){return{author:t.from,chat:n,groupJid:n,type:"group"}},user:function(n){return{author:t.from,chat:n,deviceJid:t.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:t.offline,recipient:t.recipient,reportingMeta:t.reportingMeta,retryCount:t.retryCount,ts:t.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(t.contentType)}},priority:t.priority,stanzaId:t.stanzaId,stanzaQueueId:e.stanzaQueueId,type:t.type}}case"armadillo":{var a=e,i=o("WAJids").extractUserJid(a.from),l={folder:a.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===i?"@me":i,chat:a.jid,externalId:a.stanzaId},msg:a.message,recipientsCount:null,reportingMeta:a.reportingMeta,ts:a.serverTs,type:"IncomingMsg"};return{incomingType:e.incomingType,jid:a.jid,message:{decrypted:l,details:{count:null,externalId:a.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(t){return{author:a.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:a.from,chat:t,deviceJid:a.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:a.offline,recipient:a.recipient,reportingMeta:a.reportingMeta,retryCount:a.retryCount,ts:a.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(a.contentType)}},priority:a.priority,stanzaId:a.stanzaId,stanzaQueueId:e.stanzaQueueId,type:a.type,ebTimestampMs:a.ebTimestampMs}}case"instamadillo":{var s=e,u=o("WAJids").extractUserJid(s.from),c={folder:s.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===u?"@me":u,chat:s.jid,externalId:s.stanzaId},msg:s.message,recipientsCount:null,reportingMeta:s.reportingMeta,ts:s.serverTs,type:"InstamadilloMsg"};return{incomingType:"wa-incoming",jid:s.jid,message:{decrypted:c,details:{count:null,externalId:s.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(s.jid,{group:function(t){return{author:s.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:s.from,chat:t,deviceJid:s.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!0,offline:s.offline,recipient:s.recipient,reportingMeta:s.reportingMeta,retryCount:s.retryCount,ts:s.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(s.contentType)}},priority:s.priority,stanzaId:s.stanzaId,stanzaQueueId:e.stanzaQueueId,type:s.type}}case"ciphertext":{var d=function(){return!(m.contentType==="reaction"||m.hideDecryptionFailure===!0)},m=e,p=o("WAJids").extractUserJid(m.from),_={createPlaceholder:d(),id:{author:o("WAGlobals").getMyUserJid()===p?"@me":p,chat:m.jid,externalId:m.stanzaId},ts:m.serverTs,type:"IncomingCiphertextMsg"};return{incomingType:"wa-incoming",jid:m.jid,message:{decrypted:_,details:{count:null,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(m.contentType),externalId:m.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(m.jid,{group:function(t){return{author:m.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:m.from,chat:t,deviceJid:m.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:m.offline,recipient:m.recipient,reportingMeta:m.reportingMeta,retryCount:m.retryCount,ts:m.serverTs}},priority:m.priority,stanzaId:m.stanzaId,stanzaQueueId:e.stanzaQueueId,type:m.type}}default:return babelHelpers.extends({},e)}}var g=9,h=7,y=5,C=2;function b(e){return e}function v(e){return e}function S(e){return e}l.initProtocolQueue=c,l.protocolQueue=d,l.PQFlushable=m,l.pqFlushable=p,l.mapProtocolEntriesV2toV1=_,l.mapProcolQueueMessageV2toV1=f,l.WAProtocolQueuePriorityHigh=g,l.WAProtocolQueuePriorityMid=h,l.WAProtocolQueuePriorityLow=y,l.WAProtocolQueuePriorityBackground=C,l.appdataApplicationProtocol=b,l.extractSubProtocolFromAppdataProtocol=v,l.numberToStanzaQueueId=S}),98);
__d("MAWHandleEBRestoreWithHIM",["EBAPIWorkerCheck","EchoMessage","EncryptedBackupsUploadEntity","FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWBulkEditMsgsTxns","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMsg","MAWEchoToProtobufConversionLoggingUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWJids","MAWMsgType","MAWODSProxy","MAWParseXMAProtocol","MAWUnsafeCoerce","MAWUserJidWrapper","MessageBackupSupplementalKeyGenerator","MpsTags","Random","WAGlobals","WAHashUtils","WAJids","WALogger","WALongInt","WAOdsEnums","WAProtocolQueue","WAResultOrError","WASortedLists","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["originalTs","threadJid","unsendMsgContentDeleteTs"],s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k;function I(e,t){return e==="@me"||e==="@system"?t:e}function T(e,t,n,r,a){var i=[];if(e.reactionXOfflineThreadingIds!=null)for(var l=0;l<e.reactionXOfflineThreadingIds.length;++l){var s=o("MAWHandleEchoReactionsRestore").getReactionsForReactionStore(t,n,r,null,a,e),u=s.map(function(e){return{decodedMsg:{unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:e,unstoredDbReceiverFetchInfo:void 0},stanza:P(e.externalId,e.ts,I(e.author,n),t,"reaction")}});i.push.apply(i,u)}return i}function D(e,t,n,r,a){return r.map(function(r){if(r.messageId==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] messageId is null in edit, original externalId: ",""])),e),a!=null&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(a,"getUnstoredDbEditsFromEcho_messageId_missing"),null;var i=r.messageId;return{decodedMsg:{unstoredDbEditActionMsg:{ack:o("MAWAckLevel").ACK.sent,author:n,editMsgContent:{content:r.text},externalId:o("WAStanzaUtils").toStanzaId(i),originalMsgExternalId:e,serverTs:o("WATimeUtils").castToUnixTime(r.timestamp),ts:o("WATimeUtils").castToUnixTime(r.timestamp),type:o("MAWMsgType").MSG_TYPE.EDIT_ACTION},unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:void 0},stanza:P(o("WAStanzaUtils").toStanzaId(i),o("WATimeUtils").castToUnixTime(r.timestamp),n,t,"text")}}).filter(Boolean)}function x(e,t){return e.map(F).filter(Boolean).map(function(e){return $(e,t)})}function $(e,t){var n,a=o("MAWUserJidWrapper").getMyUserJid(),i=e.from,l=o("MAWHandleEchoMsgsRestoreApiUtils").getDbMsgTypeFromEchoMessage(e);if(i==null||l==null)return[];var s=e.xOfflineThreadingId;if(s==null)return r("FBLogger")("wmi_eb").warn("xOfflineThreadingId is null for Echo message"),[];var u=o("WAStanzaUtils").toStanzaId(s),c=o("WATimeUtils").castToUnixTime(((n=e.authoritativeTimestampMs)!=null?n:e.sortOrderMs)/1e3),d=o("MAWJids").toUserJid(i.localKey),m=A(e,t,a,u,"echo_content");if(m.success===!1)return[];var p=m.value,_=T(e,t,a,u,d),f=e.contentType===o("EchoMessage").EchoMessageContentType.TEXT||e.contentType===o("EchoMessage").EchoMessageContentType.PLACEHOLDER?"text":"media",g=D(u,t,d,e.editHistory);return[{decodedMsg:p,stanza:P(u,c,d,t,f)}].concat(_,g)}function P(e,t,n,r,a){var i={applicationPayload:new Uint8Array(0).buffer,backupDirective:null,icdc:null,metadata:null,protobuf:new Uint8Array(0),subprotocol:new Uint8Array(0),subprotocolType:"consumerMessage",type:"subprotocol",version:"v3"},l={folder:null,id:{author:n,chat:r,externalId:e},msg:i,recipientsCount:null,reportingMeta:null,ts:t,type:"IncomingMsg"};return{incomingType:"ebrestore",jid:r,message:{decrypted:l,details:{count:0,externalId:e,from:o("WAJids").switchOnMsgrChatJidType(r,{group:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,groupJid:t,type:"group"}},user:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,deviceJid:o("WAJids").defaultDeviceJidForUser(n),type:"device"}}}),hideDecryptionFailure:!0,isInstamadillo:!1,offline:null,recipient:null,reportingMeta:null,retryCount:0,ts:t,type:a}},priority:o("WAProtocolQueue").WAProtocolQueuePriorityLow,stanzaId:e,stanzaQueueId:o("MAWUnsafeCoerce").unsafeCoerce(-1),type:"message"}}function N(e){if(e.mediaData==null)return o("WAResultOrError").makeResult(null);var t=e.previewMediaData,n=e.sortOrderMs,r=e.xOfflineThreadingId,a=e.mediaData,i=a.attachmentObjectId,l=a.backupEntFbid,s=a.directPath,d=a.encryptedHash,m=a.filename,p=a.height,_=a.mediaContentType,f=a.mediaKey,g=a.mediaKeyTimestamp,h=a.mediaPlayableDuration,y=a.plaintextHash,C=a.previewContentHeight,b=a.previewContentWidth,v=a.size,S=a.width,R=e.contentType===o("EchoMessage").EchoMessageContentType.XMA,L=o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(_||"",R),E=L.mediaType,k=L.serverMediaType,I=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(y)),T=null;if(t!=null)try{T=o("MAWHandleEchoMediaMsgsRestoreV2").constructRawDownloadableThumbnail(t),T!=null&&T.objectId==null&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloadableThumbnail was created without metadata, source: protobuf"])))}catch(t){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",". Echo message origin ",""])),t,r,e.serializationOrigin)}if(f==null)return o("WAResultOrError").makeError("missing_media_key");if(d==null)return o("WAResultOrError").makeError("missing_encrypted_hash");var D=o("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(I,d,f,s,g,k,m,l,i,T,v),x=o("MAWHandleEchoMediaMsgsRestoreV2").getMediaInfo({filename:m,height:p,mediaPlayableDuration:h,mediaType:E,previewContentHeight:C,previewContentWidth:b,width:S}),$=x.validatedAudioInfo,P=x.validatedDocumentFileInfo,N=x.validatedImageInfo,M=x.validatedVideoInfo;return o("WAResultOrError").makeResult({mediaEntry:D,mediaType:E,msgIds:o("WASortedLists").asSortedSet(new Set),plaintextHash:o("WAHashUtils").stringToPlaintextHash(y),size:v||0,ts:g!=null?o("WATimeUtils").castToUnixTime(g):o("WATimeUtils").castMilliSecondsToUnixTime(n),validatedAudioInfo:$,validatedDocumentFileInfo:P,validatedImageInfo:N,validatedVideoInfo:M})}function M(e,t){if(e.xmaData==null||e.from==null||e.xOfflineThreadingId==null)return o("WAResultOrError").makeResult(null);var n=e.from,r=e.serializationOrigin,a=e.xmaData,i=e.xOfflineThreadingId,l=a.xmaContentRef,s=a.xmaDataclass,u=a.xmaDefaultCTA,c=a.xmaGatingType,p=a.xmaHeaderSubtitle,_=a.xmaHeaderTitle,f=a.xmaIsTombstoned,g=a.xmaLayoutType,h=a.xmaMaxSubtitleNumLines,y=a.xmaMaxTitleNumLines,C=a.xmaSubtitleText,b=a.xmaTargetExpiry,v=a.xmaTargetId,S=a.xmaTargetType,R=a.xmaTargetUsername,L=a.xmaTitleText;if(S==null)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Mandatory XMA Data missing for XMA message. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var E=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(S),k;if(u!=null&&(k=o("MAWHandleEchoXMARestoreV2").getDefaultCTA(u)),k!=null&&!o("MAWParseXMAProtocol").isValidCTA(k,E,!0))return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] defautlCTA failed validation check. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_cta_validation_failure");var I;c!=null&&(I=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(c));var T;b!=null&&(T=o("WATimeUtils").castToUnixTime(b));var D;return g!=null&&(D=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(g)),o("WAResultOrError").makeResult({unstoredDbXMA:{author:o("MAWJids").toUserJid(n.localKey),contentRef:l,ctas:[],defaultCTA:k,externalId:o("WAStanzaUtils").toStanzaId(i),headerTitle:_,isTombstoned:f,maxSubtitleNumOfLines:h,maxTitleNumOfLines:y,overlayDescription:p,overlayIconGlyph:I,overlayTitle:_,subtitleText:C,targetExpiringAtSec:T,targetId:v,targetType:E,targetUsername:R,threadJid:t,titleText:L,xmaDataclass:s,xmaLayoutType:D}})}function w(e){if(e.receiverFetchId==null||e.receiverFetchData==null)return o("WAResultOrError").makeResult(null);var t=e.receiverFetchData,n=e.receiverFetchId;return t.type!=="sticker"?(o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unsupported receiver fetch message type: ",". Echo message origin ",""])),t.type,e.serializationOrigin),o("WAResultOrError").makeError("unsupported_message_type")):o("WAResultOrError").makeResult({mimetype:t.mimetype,previewHeight:t.previewHeight,previewWidth:t.previewWidth,receiverFetchId:n,type:t.type})}function A(t,n,r,a,i){var l=o("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(t,n,r,a,void 0,i);if(l.success===!1)return o("WAResultOrError").makeError(l.error);var s=l.value,u=s.originalTs,c=s.threadJid,d=s.unsendMsgContentDeleteTs,m=babelHelpers.objectWithoutPropertiesLoose(s,e);m.sortOrderMs=t.sortOrderMs;var p=N(t);if(p.success===!1)return p;var _=M(t,n);if(_.success===!1)return o("WAResultOrError").makeError(_.error);var f=_.value,g=w(t);if(g.success===!1)return o("WAResultOrError").makeError(g.error);var h=g.value;return o("WAResultOrError").makeResult({unstoredDbMedia:p.value,unstoredDbMsg:m,unstoredDbReaction:void 0,unstoredDbReceiverFetchInfo:h!=null?h:void 0,unstoredXMA:f!=null?f:void 0})}function F(e){try{return o("EchoMessage").decodeEchoMessage(e)}catch(e){return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode echo message: ",""])),e),null}}function O(e,t){if(!o("EBAPIWorkerCheck").runningInWorker())throw r("FBLogger")("messenger_web").mustfixThrow("convertEchoMessagesToEBProtobufs should be called from the worker thread");var n=e.map(function(e){return B(e,t)}).filter(Boolean);return o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.success"}),n.length!==e.length&&(o("WALogger").WARN(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to convert all echo messages to protobuf. Chat: ",", echo messages count: ",", converted echo messages count: ",""])),t,e.length,n.length),o("MAWODSProxy").odsBumpEntityKey({amount:e.length-n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.fail"})),n}function B(e,t){var n=r("Random").uint32();o("MAWEchoToProtobufConversionLoggingUtils").startQplUserFlow(n);var a=F(e);if(a==null)return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to decode echo message"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_decode_failure"),null;var i=o("WAGlobals").getMyUserJid(),l=a.from,s=a.sortOrderMs,u=a.xOfflineThreadingId,c=o("WATimeUtils").castToMillisTime(s);if(u==null||l==null)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] One of the mandatory fields is null for Echo message. Echo message origin ",""])),a.serializationOrigin),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"mandatory_fields_missing"),null;var d=o("MAWJids").toUserJid(l.localKey),m=o("WAStanzaUtils").toStanzaId(u),p=A(a,t,i,m,"first_edit_content");if(p.success===!1)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: ",""])),p.error),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_message_parsing_failure_"+p.error),null;if(p.value.unstoredDbMsg==null)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: unstoredDbMsg missing in UnstoredDbContent"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"unstoredDbMsg_conversion_failure_unstoredDbMsg_missing"),null;var _=p.value,f=_.unstoredDbMedia,I=_.unstoredDbMsg,x=_.unstoredDbReceiverFetchInfo,$=_.unstoredXMA,P={author:d,chat:t,externalId:m};I!=null&&(I.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),($==null?void 0:$.unstoredDbXMA)!=null&&($.unstoredDbXMA.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),f!=null&&(f.msgIds=o("WASortedLists").asSortedSet(new Set([o("MAWDbMsg").stanzaIdToMsgId(m)])));var N;($==null?void 0:$.unstoredDbXMA)!=null&&(N={associatedMessage:null,defaultPreview:f!=null?f:null,favicon:null,header:f!=null?f:null,previews:f!=null?[f]:null,xma:$.unstoredDbXMA});var M={frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},w;try{w={decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeMessageApplication(I,f,null,N,t,x),msgId:P,reportingMeta:M,sortOrderMs:c})),protobufTimestampMS:c}}catch(e){return o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"top_level_protobuf_encoding_failure"),o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Exception when trying to encode top-level protobuf: ",""])),e),null}var O=new Map,B=D(m,t,d,a.editHistory).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbEditActionMsg}).filter(Boolean).filter(function(e){return e.externalId!==e.originalMsgExternalId}).map(function(e){return o("MAWBulkEditMsgsTxns").getMessageHistory(e,t)});B.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_edits"),B.forEach(function(e){var r=e.author,a=e.editTs,i=o("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(r,o("WATimeUtils").castUnixTimeToMillisTime(a));if(i==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create edit supplemental key"])));return}if(e.editExternalId==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to fetch edit external id"])));return}var l=e.editExternalId;try{O.set(i,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeEditMessageApplication(e),msgId:{author:d,chat:t,externalId:l},reportingMeta:M,sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(e.editTs)})),protobufTimestampMS:o("WATimeUtils").castUnixTimeToMillisTime(a)})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode edit supplemental protobuf: ",""])),e)}});var W=T(a,t,i,m,d).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbReaction}).filter(Boolean);W.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_reactions"),W.forEach(function(e){var r=e.author,a=e.senderTimestampMs,i=e.ts,l=a!=null?o("WATimeUtils").castToMillisTime(o("WALongInt").numberOrThrowIfTooLarge(a)):o("WATimeUtils").castUnixTimeToMillisTime(i),s=o("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(r);if(s==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_key_generation_failure"),o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create reaction supplemental key"])));return}try{O.set(s,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeReactionMessageApplication(e),msgId:{author:d,chat:t,externalId:e.externalId},reportingMeta:M,sortOrderMs:l})),protobufTimestampMS:l})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode reaction supplemental protobuf: ",""])),e)}}),o("MAWEchoToProtobufConversionLoggingUtils").endSuccess(n);var q;try{q=o("MpsTags").getTagFromProto(w.decryptedProtobuf)}catch(e){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get tag from proto: ",""])),e)}return{otid:m,supplementalProtobufs:O,tags:q!=null?[q]:[],toplevelProtobuf:w}}l.convertEchoMessages=x,l.convertEchoMessagesToEBProtobufs=O}),98);
__d("MAWMpsXMAValidationPreprocessor",["ACTSanitizerApiLazyLoader","ACTSanitizerApiTypes","FBLogger","MAWParseXMAFBConfig","MAWParseXMAProtocol","MAWProtobufDeserializers","MpsPreprocessor","Promise","WAResultOrError","asyncToGeneratorRuntime","err","getErrorSafe","getMediaTypeFromConsumerMessage"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){if(e.payload!=null){var t=new(o("MAWProtobufDeserializers")).DeserializedMessageApplication(e.payload),n=t.subProtocol();if((n==null?void 0:n.kind)==="consumerApplication")return n.proto}}function u(){var e=null;return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){try{if(e==null){var n=yield o("ACTSanitizerApiLazyLoader").loadACTSanitizerApi();e=n.isXMAValid}var a=e,i=a(t);if(i!==o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid)throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - extendedContentMessage does not have valid XMA content");var l=t.associatedMessage,u=t.sentWithMessageId,c=t.targetType,d=t.xmaDataclass;if(c==null||!o("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:c,xmaDataclass:d}))return r("FBLogger")("mps").warn("XMA Validation - found futureproof message"),o("WAResultOrError").makeResult();if(l!=null&&u==null)throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associatedMessage cannot be received without sentWithMessageId field");if(l!=null){var m=s(l);if(o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(m)!=null&&!o("MAWParseXMAProtocol").SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES.has(c))throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associated msg has unsupported media type")}return o("WAResultOrError").makeResult()}catch(e){var p=r("getErrorSafe")(e);return r("FBLogger")("mps").catching(r("getErrorSafe")(p)).mustfix("XMA Validation failed for message"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",p)}});return function(e){return t.apply(this,arguments)}})()}var c=o("MpsPreprocessor").preprocessor((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.ctx,i=t.payloadList,l=new Map,s=new Array(i.length),c=u(),d=i.map(function(e,t){var n,a=(n=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(e.message.payload).encryptedTransportMessage())==null||(n=n.armadillo())==null||(n=n.payload)==null||(n=n.content)==null?void 0:n.extendedContentMessage;if(a==null){s[t]=e;return}return c(a).then(function(n){if(n.success)s[t]=e;else{var o;l.set(e.message.messageId,(o=n.payload)!=null?o:r("err")("XMA validation failed for message - runtime error"))}})}).filter(Boolean);return d.length>0&&(yield(e||(e=n("Promise"))).all(d)),{ctx:a,errors:l,payloadList:s.filter(Boolean)}});return function(e){return t.apply(this,arguments)}})(),"xma_validator");l.xmaValidator=u,l.MAWMpsXMAValidationPreprocessor=c}),98);
__d("XFBLSRestoreOperationType.facebook",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum").Mirrored(["DELTA_GENERIC_MESSAGE_SYNC","INITIAL_RESTORE","MESSAGE_QUERY_RESTORE","POINT_QUERY_RESTORE","RANGE_QUERY_RESTORE","SNAPSHOT_RESTORE","SURROUNDING_RESTORE","THREAD_POINT_QUERY_RESTORE","UNKNOWN"]),l=e;i.default=l}),66);
__d("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},t={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},n={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},r={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},o={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},a={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},C=[t,n];return{argumentDefinitions:[{defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"}],kind:"Fragment",metadata:null,name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages",selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},e,t,n,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[r,e,t,n,o,a],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[r,e,t,n,o,a,i,l],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},o],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[s,u,c,d,m,p,_,f,g,h,y],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[s,u,m,c,d,i,l,p,_,f,g,h,y],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null},{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[d,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},t,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],type:"XFBEncryptedBackupMessages",abstractKey:null}})();a.exports=e}),null);
__d("handleRestoreMessagesGraphQLResponse",["EBMinosInterfaceTypes","I64","MEBEncryptionVersion","QPLUserFlow","WALogger","handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(e){if(e==null)return r("MEBEncryptionVersion").UNKNOWN;switch(e){case"ENCRYPTION_KDF_WITH_NULL_SALT":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT;case"ENCRYPTION_KDF_WITH_VERSION":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION;case"ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY;case"TEST_VERSION":return r("MEBEncryptionVersion").TEST_VERSION;default:return r("MEBEncryptionVersion").UNKNOWN}}function p(e,t,n,a){var i,l=((i=e==null?void 0:e.map(function(e){var n,r,a,i,l,c,p,f,g;if(e==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message is null in the GraphQL range restore response"]))),null;var h=e.otid;if(h==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] otid is null for a message in the GraphQL range restore response"]))),null;var y=(n=e.echo_document)==null?void 0:n.echo_document_string,C=(r=e.echo_document)==null?void 0:r.epoch_anon_id,b=(a=e.echo_document)==null?void 0:a.epoch_fingerprint,v=e.protobuf_stanzas,S=v==null||(i=v.top_level_protobuf)==null?void 0:i.encrypted_protobuf_stanza,R=v==null||(l=v.top_level_protobuf)==null?void 0:l.epoch_anon_id,L=v==null||(c=v.top_level_protobuf)==null?void 0:c.epoch_id,E=v==null||(p=v.top_level_protobuf)==null?void 0:p.protobuf_timestamp_ms,k=v==null?void 0:v.supplemental_protobufs,I=v==null?void 0:v.message_tags,T=(f=e.protobuf_stanzas)==null?void 0:f.top_level_protobuf_v2,D=(g=e.protobuf_stanzas)==null?void 0:g.top_level_protobuf_unencrypted;if(D!=null&&D.unencrypted_protobuf!=null&&D.protobuf_timestamp_ms!=null){var x=D.unencrypted_protobuf,$=D.protobuf_timestamp_ms;return{message:{isUnencrypted:!0,messageTags:o("EBMinosInterfaceTypes").convertArrayToMpsMessageTags(I),otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:x,encryption_version:void 0,epoch_anon_id:new ArrayBuffer(0),epoch_id:void 0,otid:h,protobufTimestampMs:$,value:void 0}},type:"protobuf"}}if(S==null||R==null||L==null||E==null){var P,N;if(y==null||C==null||y.length===0)return T==null&&_(S,R,L,E),null;var M=m((P=e.echo_document)==null?void 0:P.encryption_version);return{message:{backup_id:t,encryption_version:M,epoch_anon_id:new TextEncoder().encode(C).buffer,epoch_fingerprint:b!=null?new TextEncoder().encode(b).buffer:void 0,epoch_id:((N=e.echo_document)==null?void 0:N.epoch_id)!=null?(d||(d=o("I64"))).of_string(e.echo_document.epoch_id):void 0,otid:h,value:y},type:"echo"}}if(v!=null){var w,A=m(v==null||(w=v.top_level_protobuf)==null?void 0:w.encryption_version),F={messageTags:o("EBMinosInterfaceTypes").convertArrayToMpsMessageTags(I),otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:S,encryption_version:A,epoch_anon_id:new TextEncoder().encode(R).buffer,epoch_id:(d||(d=o("I64"))).of_string(L),otid:h,protobufTimestampMs:E,value:void 0}};return k==null||k.forEach(function(e){var n=e==null?void 0:e.supplemental_key,r=e==null?void 0:e.encrypted_protobuf_stanza,a=e.epoch_anon_id,i=e==null?void 0:e.epoch_id,l=e==null?void 0:e.protobuf_timestamp_ms;if(!(r==null||a==null||i==null||l==null||n==null)){var s=m(e==null?void 0:e.encryption_version);F.supplementalProtobufs.push({backup_id:t,encryptedProtobufContent:r,encryption_version:s,epoch_anon_id:new TextEncoder().encode(a).buffer,epoch_id:(d||(d=o("I64"))).of_string(i),protobufTimestampMs:l,skCipherText:e==null?void 0:e.sk_ciphertext,supplementalKey:n,value:void 0})}}),{message:F,type:"protobuf"}}return null}))!=null?i:[]).filter(Boolean),c=l.filter(function(e){return e.type==="echo"}).map(function(e){return e.message}),p=l.filter(function(e){return e.type==="protobuf"}).map(function(e){return e.message});return a!=null&&n!=null&&r("QPLUserFlow").addPoint(n,"processing_encrypted_messages_complete",{instanceKey:a}),{encryptedNonLSEchoMessages:c,encryptedNonLSProtobufs:p}}function _(e,t,n,r){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message with no echo document and no protobuf data, more details: encrypted_protobuf_content: ",", protobuf_epoch_anon_id: ",", protobuf_epoch_id: ",", protobuf_timestamp_ms: ",""])),e==null?"null/empty":"not empty",t==null?"null/empty":"not empty",n==null?"null/empty":"not empty",r==null?"null/empty":"not empty")}e!==void 0||(e=n("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql")),l.processMessageArray=p}),98);
__d("EBMessagePointQuery",["Base64Utils","EBAPIConvertNativeToLS","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPISharedTypes","EBAPIWorkerCheck","EBDedupeEncryptedLabyrinthMessages","EBDedupeLabyrinthMessages","EBDeriveAndStoreEpochs","EBGetClientState","EBLS","EBMessagePointQuery.graphql","EBMinosCheckWasmFeatureSupport","EBMinosDecryptAndValidateMessages","EBMinosInterfaceTypes","EBgenerateMPSMessageQuery","FBLogger","I64","LSVec","MAWCurrentUser","MAWEncryptedBackupUtils","MAWHandleEBRestoreWithHIM","MAWJobDefinitions","MAWMpsXMAValidationPreprocessor","MpsTypes","Promise","QPLFlow","WAJids","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=e!==void 0?e:e=n("EBMessagePointQuery.graphql");function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.chatJid,a=e.messageIds,i=e.source,l=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupportAndGK(),d=o("QPLFlow").startQPLFlow(r("qpl")._(521474469,"2612"),{annotations:{bool:{is_wasm_serializer_on:r("gkx")("18428"),minos_rollout_enabled:l,occam_only_mailbox_users:r("gkx")("16674")},string:{source:i!=null?i:"unknown"}}});try{var m,_,f,g,h;if(!o("EBAPIWorkerCheck").runningInWorker())return d.endFail(o("EBAPIQPLPoints").EBAPIQPLCommonErrorPoints.UNSUPPORTED_CONTEXT),o("WAResultOrError").makeError("unsupported-context");var y=(yield o("EBLS").init()).db;d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.LSDB_SINGLETON_RETRIEVED);var C=yield o("EBGetClientState").getClientState(y);if(d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CLIENT_STATE_RETRIEVED,{string:{device_id:(m=C==null?void 0:C.deviceId)!=null?m:(u||(u=o("I64"))).to_string((u||(u=o("I64"))).zero)}}),C==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}}),o("WAResultOrError").makeError("no-client-state");var b=o("WAJids").threadIdForChatJid(t),v=C.backupId,S=C.deviceId,R=C.locally_available_epochs,L=C.mailboxRootKey,E=C.ocmfClientStateBlob;if(v==null||S==null||L==null||E==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}}),o("WAResultOrError").makeError("invalid-client-state");var k=""+((_=o("MAWCurrentUser").getAppID())!=null?_:0),I={restore_context:{act_thread_id:b,site:"www",tam_thread_subtype:0},success:{device_context:{device_id:S,locally_available_epochs:R,raw_tokens:{mailbox_root_key:o("Base64Utils").fromArrayBuffer(L),ocmf_client_state_blob:o("Base64Utils").fromArrayBuffer(E)}},mps_message_query:o("EBgenerateMPSMessageQuery").generateMPSMessageQueryForGraphQLQuery(b,[].concat(a))}},T={app_id:k,minos_gk_enabled:l,restore_payload_string:JSON.stringify(I),restore_type:"MESSAGE_QUERY_RESTORE"};d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_START),yield o("WorkerRelayNetwork").createWorkerNetworkExecute(),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_END),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);var D=yield o("WorkerRelay").createWorkerQuery(c,T);d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END);var x=D==null||(f=D.viewer)==null||(f=f.encrypted_backup)==null||(f=f.mailbox)==null?void 0:f.messages_point_restore;if(x==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var $=x;if(($==null?void 0:$.encrypted_messages)==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var P=$.backup_id,N=$.encrypted_messages,M=$.epoch_derivation_set,w=$.exception_string,A=$.minos_decryption_keys,F=p(N,d);if(d.addAnnotations({int:{encrypted_messages_with_content_count:F}}),w!=null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:w}}),o("WAResultOrError").makeError("server-side-exception");P==null&&d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);var O=M;d.addAnnotations({bool:{hasEpochs:O!=null&&O.epoch_edges.length>0}}),yield o("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(y,O),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END),d.addPoint("decryption_start");var B=N,W=l?o("EBMinosInterfaceTypes").processMinosMessages(B):[],q=l?yield o("EBMinosDecryptAndValidateMessages").minosDecryptAndValidateMessages({encryptedMinosMessages:W,entryPoint:"point_query",minosDecryptionKeys:A,qplFlow:d,source:i!=null?i:"unknown",threadId:o("MpsTypes").toThreadId(t),validator:r("gkx")("5782")?o("MAWMpsXMAValidationPreprocessor").xmaValidator():function(){return(s||(s=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}):o("WAResultOrError").makeResult({decryptionResult:new Map,errorMessages:[]}),U=q.success===!0&&q.value.decryptionResult.size>0?q.value.decryptionResult:null,V=q.success===!0?q.value.errorMessages:[(g=q.error)!=null?g:"unknown-error"];d.addAnnotations({bool:{minos_decrypt_success:V.length===0},int:{minos_decrypted_messages_count:(h=U==null?void 0:U.size)!=null?h:0},string_array:{minos_decrypt_errors:V}});var H=U!=null&&l?o("EBDedupeEncryptedLabyrinthMessages").dedupeEncryptedLabyrinthMessages(B,U,d):B;d.addAnnotations({int:{deduped_encrypted_messages:p(H)}});var G=o("handleRestoreMessagesGraphQLResponse").processMessageArray(H,P!=null?o("EBMinosInterfaceTypes").unsafeCastToBackupFbid(P):v),z=G.encryptedNonLSEchoMessages,j=G.encryptedNonLSProtobufs;d.addPoint("native_decryption_start");var K=yield o("EBAPIDecryptionModule").decryptUsingNativeJS(y,b,j,z,i,"point_query");if(!K.success){var Q,X=K.error,Y=X.message,J=o("EBAPISharedTypes").EBAPIRestoreErrorValues.find(function(e){return e===Y});return d.endFail("decrypt_labyrinth10_messages_failure",{string:{error_description:X.message,errorStackTrace:(Q=X.stack)!=null?Q:""}}),J!=null?o("WAResultOrError").makeError(J):o("WAResultOrError").makeError("native-decryption-error")}d.addAnnotations({bool:{labyrinth_10_toplevel_decrypt_success:K.value.decryptedEchoMessages.length===z.length&&K.value.decryptedProtobufs.length===j.length}}),d.addPoint("native_decryption_end");var Z=K.value.decryptedEchoMessages,ee=K.value.decryptedProtobufs,te=l?o("EBDedupeLabyrinthMessages").dedupeLabyrinthMessages(ee,U):ee,ne=Z.length+te.length;d.addAnnotations({bool:{decrypted_count_equals_encrypted_count:F===ne},int:{decrypted_echo_count:Z.length,decrypted_messages_count:te.length+Z.length,decrypted_protobuf_count:te.length}}),d.addPoint("convert_native_to_decrypted_type_start");var re=o("EBAPIConvertNativeToLS").convertNativeDecryptionResponseToDecryptedMessageType(Z,te);d.addPoint("convert_native_to_decrypted_type_end");var oe=r("LSVec").toArray(re.echo),ae=re.protobuf,ie=oe.map(function(e){return o("MAWJobDefinitions").toEncodedEchoMessage(e)}),le=o("MAWHandleEBRestoreWithHIM").convertEchoMessagesToEBProtobufs(ie,t).concat(o("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(ae)),se=new Map(le.map(function(e){return[e.otid,e]})),ue=Array.from(se.values()),ce=a.reduce(function(e,t){return e+(se.get(t)==null?1:0)},0);return d.addAnnotations({int:{decrypted_message_result_count:ue.length,missing_message_count:ce}}),d.addPoint("decryption_end"),d.endSuccess(),o("WAResultOrError").makeResult(ue)}catch(e){var de,me=r("getErrorSafe")(e);return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:me.message,errorStackTrace:(de=me.stack)!=null?de:""}}),r("FBLogger")("wmi_eb").catching(me).mustfix("Runtime error performing messagePointQuery: %s",me.message),o("WAResultOrError").makeError("runtime-error")}}),m.apply(this,arguments)}function p(e,t){var n=0,r=!1,o=!1,a=!1,i=!1;for(var l of e){var s,u=l.protobuf_stanzas,c=(u==null?void 0:u.top_level_protobuf)!=null,d=(u==null?void 0:u.top_level_protobuf_unencrypted)!=null,m=(u==null?void 0:u.top_level_protobuf_v2)!=null,p=((s=l.echo_document)==null?void 0:s.echo_document_string)!=null;r=r||c,o=o||m,a=a||p,i=i||d,(c||d||m||p)&&(n+=1)}return t!=null&&t.addAnnotations({bool:{has_echo_document:a,has_lab1_messages:r,has_lab11_messages:o,has_unencrypted_protobuf:i}}),n}l.messagePointQuery=d}),98);
__d("EBProbe",["FBLogger","MAWODSProxy","Promise","WAOdsEnums","WAShiftTimer","WATimeUtils","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e,t,n){this.$5=!1,this.$1=e,this.$2=t,this.$3=n}var a=t.prototype;return a.sample=function(t){var e=this.$1.sample(t);return e&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"sampled"}),e},a.start=function(){var e=this;this.$4==null&&(this.$4=new(o("WAShiftTimer")).ShiftTimer(function(){e.$6()}),this.$4.onOrBefore(this.$3.validationIntervalMs,void 0))},a.stop=function(){this.$4!=null&&(this.$4.cancel(),this.$4=null)},a.hasStarted=function(){return this.$4!=null},a.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield this.$7(),this.$4!=null&&this.$4.onOrBefore(this.$3.validationIntervalMs,void 0)});function t(){return e.apply(this,arguments)}return t})(),a.$7=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(!this.$5){this.$5=!0;try{var t=o("WATimeUtils").castToMillisTime(Date.now()-this.$3.sampleAgeThresholdMs),n=this.$2.fetchOlderThan({consume:!0,cutOffTimestamp:t});if(n.length>0)try{o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"validated"}),yield this.validateSamples(n)}catch(t){var a=t instanceof Error?t:r("err")(String(t));r("FBLogger")("wmi_eb").catching(a).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Exception in validateSamples()"])))}}finally{this.$5=!1}}});function a(){return t.apply(this,arguments)}return a})(),a.addMarkerToItem=function(t,n,r){return!1},a.updateSample=function(t,n){var e=this.getSamplingDB();if(e==null)return!1;var r=e.getItemByPrimaryKey(t);return r==null?!1:(n(r),!0)},a.getConfig=function(){return this.$3},a.getSamplingDB=function(){return this.$2},a.validateSamples=function(t){return(s||(s=n("Promise"))).reject(r("err")("validateSamples() must be implemented by concrete probe classes"))},t})();l.EBProbe=u}),98);
__d("EBSampler",["Random"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n,r){this.$1=e,this.$2=t,this.$3=n,this.$4=r}var t=e.prototype;return t.sample=function(t){var e,n=this.$3(t),r=((e=this.$2.get(n))!=null?e:0)*this.$1,a=o("Random").random(),i=a<r;return i&&this.$4.append(t),i},t.setSamplingMultipler=function(t,n){this.$2.set(t,n)},t.setSamplingRate=function(t){this.$1=t},e})();l.EBSampler=e}),98);
__d("EBMinosDisableLabyrinth10Uploads",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("16675")}l.disableLabyrinth10Uploads=e}),98);
__d("MWEBODSUtils",["CurrentMessengerUser","MWEBODSCategory","ODS"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,a){var i=o("CurrentMessengerUser").getAppID(),l=i!=null?i.toString():"unknown",s=t+"."+l;(e||(e=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),s,n,a!=null?a:1),e.bumpEntityKey(r("MWEBODSCategory"),t,n,a!=null?a:1)}l.markODSForEB=s}),98);
__d("EncryptedBackupsUploadQueue",["EBMinosDisableLabyrinth10Uploads","EncryptedBackupsUploadEntity","MWEBODSEntityName.enum","MWEBODSUtils","PersistedQueueApi","Promise","QPLUserFlow","WAPersistedQueue","WATagsLogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["EbUploadQueue"]),d=null;function m(){return d==null?p():d}function p(){d!=null&&c.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebUploadQueue",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){if(e.length===0||o("EBMinosDisableLabyrinth10Uploads").disableLabyrinth10Uploads())return(u||(u=n("Promise"))).resolve();o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.put",e.length);var t=m();return t.addAndCommit(e.map(o("EncryptedBackupsUploadEntity").asEBUploadEntity)).then(function(){e.forEach(function(e){(e==null?void 0:e.instanceKey)!=null&&r("QPLUserFlow").endSuccess(r("qpl")._(521477113,"2698"),{instanceKey:e.instanceKey})})}).catch(function(e){return c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)})}l.logger=c,l.ebUploadQueue=m,l.initEbUploadQueue=p,l.putMsgsToEbUpload=_}),98);
__d("InMemorySamplingDB",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.$1=[],this.$4=new Map,this.$2=e,this.$3=t}var t=e.prototype;return t.append=function(t){var e=this.$3(t);this.$1.push([this.$2(t),t]),this.$4.set(e,t)},t.fetchOlderThan=function(t){var e=t.consume,n=e===void 0?!1:e,r=t.cutOffTimestamp,o=t.limit,a=o===void 0?50:o,i=[];if(a<=0)return i;var l=0,s=[];for(var u of this.$1){var c=u[0],d=u[1];if(c<=r&&(i.push(d),n===!0&&(l++,s.push(d))),i.length>=a)break}if(n===!0&&l>0){this.$1.splice(0,l);for(var m of s){var p=this.$3(m);this.$4.delete(p)}}return i},t.getItemByPrimaryKey=function(t){var e;return(e=this.$4.get(t))!=null?e:null},t.size=function(){return this.$1.length},t.pruneOlderThan=function(t){var e=[];this.$1=this.$1.filter(function(n){var r=n[0],o=n[1];return r<=t?(e.push(o),!1):!0});for(var n of e){var r=this.$3(n);this.$4.delete(r)}},t.purgeAll=function(){this.$1=[],this.$4.clear()},e})();i.InMemorySamplingDB=e}),66);
__d("EBMessageProbe",["EBDeps","EBGetClientState","EBMessagePointQuery","EBProbe","EBSampler","EncryptedBackupsUploadQueue","EncryptedBackupsUploadQueueV3Scheduler","FBLogger","I64","InMemorySamplingDB","MAWEBLSInWorkerSwitch","MAWODSProxy","MpsTypes","Promise","QPLFlow","WAOdsEnums","WAResultOrError","WATimeUtils","WebMps","asyncToGeneratorRuntime","getErrorSafe","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){var n={};for(var r of e){var o=t(r);n[o]==null&&(n[o]=[]),n[o].push(r)}return n}var m={qplEvent:r("qpl")._(521475573,"3232"),sampleAgeThresholdMs:(c=r("justknobx"))._("3485"),validationIntervalMs:c._("3949")},p=c._("3573")/1e4,_=new Map([["text",c._("3952")],["image",c._("3957")],["video",c._("3969")],["audio",c._("3970")],["document",c._("3973")],["sticker",c._("3977")],["gif",c._("3981")],["xma",c._("1505")]]),f=function(t){return t.timestampMs},g=function(t){return t.messageType},h=function(){return new(o("InMemorySamplingDB")).InMemorySamplingDB(f,function(e){return e.messageId})},y=function(t){return new(o("EBSampler")).EBSampler(p,_,g,t)},C=(function(t){function a(e,n,r){return r===void 0&&(r=m),t.call(this,e,n,r)||this}babelHelpers.inheritsLoose(a,t),a.getInstance=function(){if(!a.$EBMessageProbe$p_1){var e=h(),t=y(e);a.$EBMessageProbe$p_1=new a(t,e,m)}return a.$EBMessageProbe$p_1},a.reset=function(){a.$EBMessageProbe$p_1=null};var i=a.prototype;return i.addMarkerToItem=function(t,n,r){return this.addMarker(t,n,r)},i.addMarker=function(t,n,r){var e=this.getSamplingDB();if(e==null)return!1;var a=e.getItemByPrimaryKey(t);if(a==null)return!1;var i={event:n,metadata:r,timestampMs:o("WATimeUtils").castToMillisTime(Date.now())};return a.markers.push(i),!0},i.getMarkersForMessage=function(t){var e=this.getSamplingDB();if(e==null)return null;var n=e.getItemByPrimaryKey(t);return n==null?null:[].concat(n.markers)},i.getMessageSample=function(t){var e=this.getSamplingDB();return e==null?null:e.getItemByPrimaryKey(t)},i.$EBMessageProbe$p_2=function(t){return t.length===0?"":t.map(function(e){return e.event}).join(",")},i.$EBMessageProbe$p_3=function(t){var e={bool:{},int:{},string:{}};for(var n of t){var r=n.metadata;if(r!=null)for(var o of Object.entries(r)){var a=o[0],i=o[1];typeof i=="string"?e.string!=null&&(e.string[a]=i):typeof i=="number"?e.int!=null&&(e.int[a]=i):typeof i=="boolean"&&e.bool!=null&&(e.bool[a]=i)}}return e},i.$EBMessageProbe$p_4=function(t){if(t===0)return"0";if(t>=1e3)return"1000+";var e=Math.floor(t/50)*50,n=e+50;return e+"-"+n},i.$EBMessageProbe$p_5=function(t){if(t<0)return"never";var e=t/(1e3*60);return e<1?"<1min":e>=1&&e<5?"1-5min":e>=5&&e<10?"5-10min":e>=10&&e<20?"10-20min":e>=20&&e<60?"20-60min":">60min"},i.validateSamples=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(t.length!==0){var a=o("EncryptedBackupsUploadQueue").ebUploadQueue(),i=-1,l="unknown";try{i=yield a.count(),l=this.$EBMessageProbe$p_4(i),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"upload_queue_count_bucket_"+l})}catch(e){r("FBLogger")("wmi").catching(r("getErrorSafe")(e)).warn("Failed to get upload queue count for probe annotation")}var c=o("EncryptedBackupsUploadQueueV3Scheduler").getLastSuccessfulAckTimestampMs(),m=c!=null?Date.now()-c:-1,p=this.$EBMessageProbe$p_5(m),_=new Set,f=[];for(var g of t){var h,y,C=g.chatJid+"_"+g.messageId;if(!_.has(C)){_.add(C);var b=Date.now()-g.timestampMs,v=b/(1e3*60),S=function(t){return t<5?"<5min":t>=5&&t<10?"5-10min":">10min"},R=void 0,L=void 0;if(g.queueId!=null){var E,k=yield a.get(g.queueId);if(R=k!=null,(k==null||(E=k.msgId)==null?void 0:E.externalId)!=null){var I;L=o("MpsTypes").toMessageId(k==null||(I=k.msgId)==null?void 0:I.externalId)===g.messageId}}var T=o("QPLFlow").startQPLFlow(this.getConfig().qplEvent,{annotations:babelHelpers.extends({},this.$EBMessageProbe$p_3(g.markers),{bool:{eb_state:r("MAWEBLSInWorkerSwitch").isEnabled(),ebUploadTaskScheduled:o("EncryptedBackupsUploadQueueV3Scheduler").isUploadTaskScheduled(),isProtobufOnlyUpload:!0,queueItemExists:R,queueItemMessageIdMatches:L},int:{markerCount:g.markers.length,queueCount:i,queueId:(h=g.queueId)!=null?h:-1,sampleSize:t.length,sampleTimestampMs:g.timestampMs,validationIntervalMs:b,validationTimestampMs:Date.now()},string:{bucketizedQueueCount:l,bucketizedTimeSinceLastAck:p,chatJid:g.chatJid,insertionSource:(y=g.insertionSource)!=null?y:"unknown",markerEvents:this.$EBMessageProbe$p_2(g.markers),messageId:g.messageId,messageType:g.messageType,validationIntervalBucket:S(v),version:"v1"}})});f.push({qplFlow:T,sample:g})}}try{var D=r("justknobx")._("4947"),x=d(f,function(e){return e.sample.chatJid}),$=Object.entries(x).map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e[0],n=e[1],r=n.map(function(e){return e.sample.messageId}),a=n[0].sample.chatJid,i={chatJid:a,messageIds:r,source:"message_probe"};n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_start")});var l=yield o("EBMessagePointQuery").messagePointQuery(i),s=D?yield o("WebMps").mps().batchLoadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"eb-message-probe"},messageIds:r,threadId:o("MpsTypes").toThreadId(a)}):o("WAResultOrError").makeResult([]);return n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_end")}),{chatJid:a,mpsLocalResult:s,result:l,samplesWithQplFlow:n}});return function(t){return e.apply(this,arguments)}})()),P=yield o("EBDeps").getDeps().getLSDB(),N=yield o("EBGetClientState").getClientState(P),M=N==null?void 0:N.encryptionVersion,w=M!=null?(u||(u=o("I64"))).to_string(M):"unknown",A=yield(s||(s=n("Promise"))).all($);for(var F of A){var O,B=F.mpsLocalResult,W=F.result,q=F.samplesWithQplFlow,U=new Set((O=B.value)==null?void 0:O.map(function(e){var t;return e==null||(t=e.toplevelProtobuf)==null?void 0:t.messageId}));if(W.success){var V=new Set(W.value.map(function(e){return e.otid}));for(var H of q){var G=H.qplFlow;V.has(H.sample.messageId)?G.endSuccess({bool:{messageFound:!0,mpsLocalMessageFound:D?U.has(H.sample.messageId):void 0}}):G.endFail("message_not_found",{bool:{messageFound:!1,mpsLocalMessageFound:D?U.has(H.sample.messageId):void 0},string:{encryption_version:w,error:"message-not-found"}})}}else for(var z of q){var j=z.qplFlow;if(j!=null){var K;j.endFail("query_failed",{bool:{messageFound:!1,mpsLocalMessageFound:D?U.has(z.sample.messageId):void 0},string:{encryption_version:w,error:(K=W.error)!=null?K:"unknown-query-failure"}})}}}}catch(t){var Q=r("getErrorSafe")(t);r("FBLogger")("wmi").catching(Q).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to validate samples"])));for(var X of f){var Y;X.qplFlow.endFail("validation_exception",{bool:{messageFound:!1},string:{error:(Y=Q.message)!=null?Y:"unknown-validation-exception"}})}}}});function a(e){return t.apply(this,arguments)}return a})(),a})(o("EBProbe").EBProbe),b=C.getInstance,v=C.reset;l.EBMessageProbe=C,l.getEBMessageProbeInstance=b,l.resetEBMessageProbeInstance=v}),98);
__d("EBUploadMessagesFromWorkerMutationDeferred",["requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("EBUploadMessagesFromWorkerMutation").__setRef("EBUploadMessagesFromWorkerMutationDeferred");function s(t,n){return e.load().then(function(e){return e.uploadMessagesFromWorker(t,n)})}l.uploadMessagesFromWorker=s}),98);
__d("EncryptedBackupsCreateAttachmentContext",["EBLogger","EncryptedBackupsUploadEntity","MAWProtobufDeserializers","WAMediaTransport.pb","WAMediaUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["labyrinth_web","CreateAttachmentContext"]);function s(t){var n=new Map;try{var r=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),a=r.encryptedTransportMessage();if(a==null)return e.warn("transport message subprotocol is undefined"),[];var i=d(a);if(i!=null)if(i.type!==o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)c(i,n);else{var l=i.payload;u(l.favicon,n),u(l.headerImage,n),l.previews!=null&&l.previews.forEach(function(e){u(e,n)});var s=l.associatedMessage;if(s!=null&&s.payload!=null){var m=new(o("MAWProtobufDeserializers")).DeserializedMessageApplication(s.payload),p=d(m);p!=null&&c(p,n)}}}catch(t){e.warn("Unable to create attachment context for message")}return Array.from(n.entries()).map(function(e){var t=e[0],n=e[1];return{mediaObjectId:t,mediaType:n}})}function u(e,t){var n;if(e!=null){var r=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,e.payload),a=(n=r.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId;a!=null&&t.set(o("WAMediaUtils").stringToDeliveryObjectId(a),o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}}function c(t,n){var r,a,i,l=t.type,s=t.payload,u=s.integral;if((u==null||(r=u.transport)==null||(r=r.ancillary)==null?void 0:r.objectId)==null){e.warn("object id for attachment is null");return}var c=o("WAMediaUtils").stringToDeliveryObjectId(u==null||(a=u.transport)==null||(a=a.ancillary)==null?void 0:a.objectId);n.set(c,l);var d=u==null||(i=u.transport)==null||(i=i.ancillary)==null||(i=i.thumbnail)==null||(i=i.downloadableThumbnail)==null?void 0:i.objectId;if(d!=null&&d!==c){var m=o("WAMediaUtils").stringToDeliveryObjectId(d);n.set(m,o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW)}}function d(e){var t=e.consumerMessage(),n=e.armadillo();if(t!=null){var r,a,i,l,s,u=t.payload;if((u==null||(r=u.content)==null?void 0:r.imageMessage)!=null){var c;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,u==null||(c=u.content)==null||(c=c.imageMessage.image)==null?void 0:c.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE}}if((u==null||(a=u.content)==null?void 0:a.videoMessage)!=null){var d,m,p,_=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").VideoTransportSpec,u==null||(d=u.content)==null||(d=d.videoMessage.video)==null?void 0:d.payload);return{payload:_,type:(_==null||(m=_.ancillary)==null?void 0:m.gifPlayback)!==!0||(_==null||(p=_.ancillary)==null?void 0:p.gifAttribution)!=null?o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO}}if((u==null||(i=u.content)==null?void 0:i.stickerMessage)!=null){var f;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,u==null||(f=u.content)==null||(f=f.stickerMessage.sticker)==null?void 0:f.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER}}if((u==null||(l=u.content)==null?void 0:l.audioMessage)!=null){var g;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").AudioTransportSpec,u==null||(g=u.content)==null||(g=g.audioMessage.audio)==null?void 0:g.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT}}if((u==null||(s=u.content)==null?void 0:s.documentMessage)!=null){var h;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").DocumentTransportSpec,u==null||(h=u.content)==null||(h=h.documentMessage.document)==null?void 0:h.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT}}}if(n!=null){var y,C=n.payload;if((C==null||(y=C.content)==null?void 0:y.extendedContentMessage)!=null){var b;return{payload:C==null||(b=C.content)==null?void 0:b.extendedContentMessage,type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA}}}}l.createAttachmentContext=s}),98);
__d("EncryptedBackupsMediaRestoreProbeQpl",["MAWQplProxy","WAGetAgeBucketForMediaKeyTimestamp","WAGetPlatformFromStanzaId","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.isRetroactiveUpload,n=e.mediaType,a=e.msgType,i=e.objectId,l=e.probeDelayMs,s=e.restoreMethod,u=e.sampleRate,c=e.stanzaId,d=e.timestamp,m=e.triggerSource,p=e.version,_=e.xmaType;return o("MAWQplProxy").startQplUserFlow(r("qpl")._(521473213,"27"),{bool:{isRetroactiveUpload:t,isUnifiedAttachmentUpload:!0},int:{probeDelayMs:l,sampleRate:u},string:{e2eePlatform:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(c),mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(d),mediaType:n,msgType:a,objectId:i,restoreMethod:s,triggerSource:m,version:p,xmaType:_==null?"<null>":_}},{providedTimeoutInMs:r("justknobx")._("3047")})}l.startMediaRestoreProbeQPLFlow=e}),98);
__d("MAWCastToMsgType",["MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"image":return o("MAWMsgType").MSG_TYPE.IMAGE;case"video":return o("MAWMsgType").MSG_TYPE.VIDEO;case"gif":return o("MAWMsgType").MSG_TYPE.GIF;case"sticker":return o("MAWMsgType").MSG_TYPE.STICKER;case"file":return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;case"audio":return o("MAWMsgType").MSG_TYPE.PTT;case"xma":return o("MAWMsgType").MSG_TYPE.XMA}}l.castMsgrServerMediaTypeToMsgType=e}),98);
__d("MAWCastToServerMediaType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"document":case"image":case"xma-image":case"video":case"ptt":case"gif":case"sticker":return e;default:return null}}function l(e){switch(e){case"image":case"video":case"gif":case"sticker":case"preview":return e;case"audio":return"ptt";case"xma":return"xma-image";case"file":return"document"}}i.castToServerMediaType=e,i.castMsgrServerMediaTypeToServerMediaType=l}),66);
__d("EncryptedBackupsMediaRestoreProbeV2",["$InternalEnum","EncryptedBackupsMediaRestoreProbeQpl","MAWCastToMsgType","MAWCastToServerMediaType","Promise","Random","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=n("$InternalEnum")({DEFAULT_PREVIEW:"defaultPreview",FAVICON:"favicon",HEADER:"header",PREVIEWS:"previews"}),g=r("justknobx")._("2045"),h=o("WATagsLogger").TAGS(["MediaRestoreProbeV2"]);function y(e){switch(e){case"video":return 13;case"sticker":return 10;case"audio":return 8;case"gif":return 40;case"file":return 40;case"xma":return 2;case"image":case"preview":return 1}}function C(){return r("gkx")("2067")?100:r("justknobx")._("2722")}function b(e){return v.apply(this,arguments)}function v(){return v=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.backupMessage,i=t.chatJid,l=t.sortOrderMs,f=t.stanzaId,b=t.triggerSource;if(n("cr:10071")==null)return o("WAResultOrError").makeResult("not-in-gk");var v=S(a);if(v.success===!1)return v;var R=h.TAGS([f]),L=v.value;if(L==="no-attachment-with-msg")return R.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult(L);var E=L.map(function(e){return e.serverMediaType}).filter(function(e){return e!=="preview"}).find(Boolean);if(E==null)return R.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult("no-attachment-with-msg");var k=C(),I=y(E),T=o("Random").coinflip(100/(k*I));if(!T)return(_||(_=n("Promise"))).resolve(o("WAResultOrError").makeResult("not-sampled"));R.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sampling before delay from source: "," "])),b),yield o("WAPromiseDelays").delayMs(r("gkx")("2067")?5e3:g);var D=yield(_||(_=n("Promise"))).all(L.map(function(e){var t=o("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({isRetroactiveUpload:!1,mediaType:o("MAWCastToServerMediaType").castMsgrServerMediaTypeToServerMediaType(e.serverMediaType),msgType:o("MAWCastToMsgType").castMsgrServerMediaTypeToMsgType(E),objectId:e.objectId,probeDelayMs:g,restoreMethod:"gql",sampleRate:k,stanzaId:f,timestamp:e.timestamp,triggerSource:b,version:"protobuf",xmaType:e.xmaType});return R.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["start probing. triggerSource: ",", serverMediaType: ",", xmaType: ",", objectId: "," "])),b,e.serverMediaType,e.xmaType,e.objectId),n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:i,deliveryObjectId:e.objectId,externalId:f,mediaDownloadFlow:{addAnnotations:function(n){t.addAnnotations(babelHelpers.extends({},n))},addPoint:function(n,r){t.addPoint(n,babelHelpers.extends({},r))}},mediaKey:e.mediaKey,mediaType:e.serverMediaType,sortOrderMs:l}).then(function(n){return n.success?(R.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Probe success"]))),{error:null,qpl:t,v2Payload:e}):(R.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.error),{error:n.error,qpl:t,v2Payload:e})}).catch(function(n){return R.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.toString()),{error:"runtime-error",qpl:t,v2Payload:e}})}));for(var x of D)x.error!=null?x.qpl.endFail(x.error,{string:{failReason:x.error}}):x.qpl.endSuccess();return o("WAResultOrError").makeResult("restore-media-success")}),v.apply(this,arguments)}function S(e){var t,n=e.encryptedTransportMessage();if(n==null)return o("WAResultOrError").makeError("missing-transport");var r=n.consumerMessage();if(r!=null){var a=r.imageMessage();if(a!=null)return E(a,"image");var i=r.videoMessage();if(i!=null){var l,s,u=((l=i.payload.ancillary)==null?void 0:l.gifPlayback)===!0||((s=i.payload.ancillary)==null?void 0:s.gifAttribution)!=null;return E(i,u?"gif":"video")}var c=r.audioMessage();if(c!=null){var d=L(c,"audio");return d.success===!1?d:o("WAResultOrError").makeResult([d.value])}var m=r.stickerMessage();if(m!=null){var p=L(m,"sticker");return p.success===!1?p:o("WAResultOrError").makeResult([p.value])}var _=r.documentMessage();if(_!=null){var g=L(_,"file");return g.success===!1?g:o("WAResultOrError").makeResult([g.value])}}var h=(t=n.armadillo())==null?void 0:t.extendedContentMessage();if(h!=null){var y=h.previews();return o("WAResultOrError").makeResult([R({transport:h.favicon(),xmaType:f.FAVICON}),R({transport:h.headerImage(),xmaType:f.FAVICON}),y.length>0?R({transport:y[0],xmaType:f.DEFAULT_PREVIEW}):null].concat(y.map(function(e){return R({transport:e,xmaType:f.PREVIEWS})})).filter(Boolean))}return o("WAResultOrError").makeResult("no-attachment-with-msg")}function R(e){var t,n,r,a=e.transport,i=e.xmaType,l=a==null||(t=a.integral)==null||(t=t.transport)==null||(t=t.ancillary)==null?void 0:t.objectId;if(l==null)return null;var s=a==null||(n=a.integral)==null||(n=n.transport)==null||(n=n.integral)==null?void 0:n.mediaKeyTimestamp,u=a==null||(r=a.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKey;return u==null?null:{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"xma",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null,xmaType:i}}function L(e,t){var n,r,a,i=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId,l=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,s=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return s==null?o("WAResultOrError").makeError("missing-media-key"):i!=null?o("WAResultOrError").makeResult({mediaKey:o("WAMediaUtils").castToMediaKey(s),objectId:o("WAMediaUtils").stringToDeliveryObjectId(i),serverMediaType:t,timestamp:l!=null?o("WATimeUtils").castLongIntToUnixTime(l):null}):o("WAResultOrError").makeError("missing-object-id")}function E(e,t){var n,r,a,i=L(e,t);if(i.success===!1)return i;var l=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null||(n=n.thumbnail)==null||(n=n.downloadableThumbnail)==null?void 0:n.objectId,s=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,u=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return u==null?o("WAResultOrError").makeError("missing-media-key"):l!=null?o("WAResultOrError").makeResult([i.value,{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"preview",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null}]):o("WAResultOrError").makeResult([i.value])}l.ProbeXmaType=f,l.sampleProbeMediaRestoreV2=b}),98);
__d("MAWMPSCreateBackupDirective",["EBLogger","MpsMessageToBridgeWrapper","MpsTypes","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["mps"]);function s(t){switch(t){case o("MpsTypes").ActionType.UpsertTopLevel:return 1;case o("MpsTypes").ActionType.UpsertSupplemental:return 2;case o("MpsTypes").ActionType.DeleteTopLevel:return 3;case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return 4;case o("MpsTypes").ActionType.DeleteSupplemental:case o("MpsTypes").ActionType.Preprocess:case o("MpsTypes").ActionType.Noop:case o("MpsTypes").ActionType.DeleteThread:case o("MpsTypes").ActionType.Unknown:return e.warn("Action type %d not supported on EB upload",t),0}}function u(t,n){var r=s(t.actionType);if(r===0){e.warn("Unknown EB upload action type - cannot upload message");return}var o={actionType:r,originalMsgProtocolId:n};return t.supplementalKey!=null&&(o=babelHelpers.extends({},o,{supplementalKey:t.supplementalKey})),o}function c(e,t){var n=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(t);return{author:n.getAuthor(),chat:n.getChatJid(),externalId:o("WAStanzaUtils").toStanzaId(e.targetMessageId)}}l.createBackupDirectiveFromMPSMessage=u,l.getTargetProtocolMsgIdForMessage=c}),98);
__d("WormPersistedQueueSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e}var s={autoIncrement:!1,primaryKey:"queueId",secure:!0},u={ebUploadQueueV3:babelHelpers.extends({},s,{indexes:{"[attemptCount+addedAtMs]":{fields:["attemptCount","addedAtMs"],unique:!1}},nonEncryptedFields:["attemptCount","addedAtMs"]}),mediaDownloadQueue:babelHelpers.extends({},s,{indexes:{attemptCount:{fields:["attemptCount"],unique:!1}},nonEncryptedFields:["attemptCount"]})};function c(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="worm_pqdb",c=new(o("WormEAR")).WormEAR(u,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,u,c,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.toWormPersistedQueueId=e,l.makePersistedQueueSchema=c}),98);
__d("WormPersistedQueueDb",["FBLogger","Promise","WAResolvable","WormEAR","WormPersistedQueueSchema","asyncToGeneratorRuntime","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new(o("WAResolvable")).Resolvable;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.blockingErrorThreshold,i=t.dbName,l=t.onBlockingError,c=t.qplEvent,d=t.strEncKey;try{var m=o("WormPersistedQueueSchema").makePersistedQueueSchema(i,d,a,l,function(t){if(t instanceof o("WormEAR").DecryptionError){var a,i,l=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",l.store),r("promiseDone")((a=(i=s)==null?void 0:i.runInTransaction([l.store],"readwrite",function(e){var t=e.stores[l.store];return l.maybeHashedPk!=null?t.delete(l.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?a:(e||(e=n("Promise"))).resolve())}},c);return s=m,yield m.init(),u.resolve(m),m}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing WORM PersistedQueue init"),e}}),d.apply(this,arguments)}function m(){if(s==null)throw r("err")("PersistedQueue is not initialized");return s}function p(){return u.promise}l.makePersistedQueueDb=c,l.getPersistedQueues=m,l.getDbPromise=p}),98);
__d("WormPersistedQueue",["FBLogger","WAPubSub","WormPersistedQueueDb","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(){return r("FBLogger")("wmi").tags(["worm-persisted-queue"])},u=36e5,c=(function(){function t(e){this.$1=o("WAPubSub").simplePubSub(),this.$4=0,this.$2=o("WormPersistedQueueDb").getPersistedQueues(),this.$3=e}var a=t.prototype;return a.$5=function(t){return"WormPersistedQueue:"+this.$3+":"+t},a.$6=function(){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.stores[e.$3],r=yield n.readAll({limit:1});r.length===0&&(yield n.clear())});return function(e){return t.apply(this,arguments)}})(),this.$5("clearIfEmpty"))},a.$7=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(Date.now()-this.$4>u)try{yield this.$6(),this.$4=Date.now()}catch(n){var t=r("getErrorSafe")(n);s().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during PersistedQueue cleanup: ",""])),t.message)}});function o(){return t.apply(this,arguments)}return o})(),a.subscribe=function(t){return this.$1.subscribe(t)},a.ack=function(t){return this.delete(t)},a.delete=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];yield r.bulkDelete(t),e.$7()});return function(e){return r.apply(this,arguments)}})(),this.$5("delete"))},a.read=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readonly",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];return yield r.readAll(t)});return function(e){return r.apply(this,arguments)}})(),this.$5("read"))},a.readFromIndex=function(t,r){var e=this;return this.$2.runInTransaction([this.$3],"readonly",(function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=n.stores[e.$3];return yield o.readIndex(t,void 0,r)});return function(e){return o.apply(this,arguments)}})(),this.$5("readIndex"))},a.add=function(t){return this.put(t)},a.put=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];yield r.bulkPut(t),e.$1.publish({type:"new_entities"})});return function(e){return r.apply(this,arguments)}})(),this.$5("put"))},t})();l.WormPersistedQueue=c}),98);
__d("EncryptedBackupsUploadQueueV3",["EncryptedBackupsMediaRestoreProbeV2","FBLogger","MAWEBSwitch","MAWMPSCreateBackupDirective","MAWProtobufDeserializers","MpsTypes","WAJids","WAStanzaUtils","WATimeUtils","WormPersistedQueue","WormPersistedQueueSchema"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t+"."+n.toString())}function u(e){var t=e.directive,n=e.insertionSource,a=e.message,i=o("WATimeUtils").millisTime(),l=o("MAWMPSCreateBackupDirective").getTargetProtocolMsgIdForMessage(t,a),u=o("MAWMPSCreateBackupDirective").createBackupDirectiveFromMPSMessage(t,l);if(u==null)throw r("FBLogger")("wmi").mustfixThrow("invalid-protobuf-no-backup-directive");var c=n===o("MpsTypes").InsertionSource.Send?"upload-sent-message":n===o("MpsTypes").InsertionSource.Receive?"upload-received-message":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n)})();return babelHelpers.extends({},a,{addedAtMs:i,attemptCount:0,backupDirective:u,debugInfo:{isRetroactive:!r("MAWEBSwitch").isEnabled(),triggerSource:c},queueId:s(a.messageId,a.threadId,i)})}var c=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3"])},d=null;function m(){return d==null&&(d=new(o("WormPersistedQueue")).WormPersistedQueue("ebUploadQueueV3")),d}function p(t){var n;if(t.backupDirective.actionType===1){var r=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t.payload);o("EncryptedBackupsMediaRestoreProbeV2").sampleProbeMediaRestoreV2({backupMessage:r,chatJid:o("WAJids").unsafeCoerceToChatJid(t.threadId),sortOrderMs:t.timestampMs,stanzaId:o("WAStanzaUtils").toStanzaId(t.messageId),triggerSource:(n=t.debugInfo.triggerSource)!=null?n:"unknown"}).catch(function(t){c().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestoreV2: ",""])),t)})}}l.uploadEntityFromIncomingPayload=u,l.getUploadQueue=m,l.queryMediaRestoreProbe=p}),98);
__d("WAGetHashFromProtocolMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e.externalId+"_"+e.author+"_"+e.chat}i.getHashFromProtocolMsgId=e}),66);
__d("MAWEBUploadTrackingUtils",["MAWAckLevel","MAWEBSwitch","MAWExternalId","MAWMsgType","MWEBODSEntityKey.enum","MWEBODSEntityName.enum","MWEBODSUtils","ODS","QPLUserFlow","QuickPerformanceLogger","WACommsConnectionState","WAExceededStorageQuota","WAGetHashFromProtocolMsgId","WAGlobals","WAHashStringToNumber","gkx","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={ERROR_FETCHING_DB_MESSAGE:"error_fetching_db_message",FAILED_TO_ACK_MESSAGE:"failed_to_ack_message",FAILED_TO_CONSTRUCT_ECHO_MESSAGE:"failed_to_construct_echo_message",MESSAGE_UPLOAD_TIMEOUT:"message_upload_timeout",RUNTIME_ERROR:"runtime_error"};function c(e,t,n,a,i,l,u,c,d,m){var _;if(l===void 0&&(l=!1),u===void 0&&(u=!1),d===void 0&&(d="unknown"),m===void 0&&(m=0),!!r("MAWEBSwitch").isEnabled()){r("QPLUserFlow").start(r("qpl")._(521481602,"829"),{annotations:{bool:{eb_switch:r("MAWEBSwitch").isEnabled(),eb_upload_queue:!0,fromUploadQueue:l,is_retroactive_upload:u,is_unified_attachment_upload:!0,is_wasm_serializer_on:r("gkx")("18428"),middleware_init:!1},int:{attachmentsSize:(_=c==null?void 0:c.attachmentInfos.length)!=null?_:0,instanceKey:i,retryCount:m},string:{comms_status:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected",externalId:e,msgType:n,payloadType:d,threadId:t,triggerType:a,userJid:o("WAGlobals").getMyUserJid()},string_array:{attachment_trace_ids:c==null?void 0:c.attachmentInfos.map(function(e){var t;return(t=e.attachmentTraceId)!=null?t:"null"}),media_types:c==null?void 0:c.attachmentInfos.map(function(e){return e.mediaType})}},instanceKey:i,timeoutInMs:r("justknobx")._("1405")}),p(i,"upload_tracking_started"),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").START),o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+(n!=null?n:"unknown"));var f=o("MAWMsgType").isMAWSupportedMediaType(n!=null?n:"Text")?"media":"non-media";o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+f)}}function d(e){return e==null?{string:{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected"}}:babelHelpers.extends({},e,{string:babelHelpers.extends({},e.string,{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected"})})}function m(e,t,n,r){switch(e){case"success":h(t,n,r);break;case"fail":g(t,n,r);break;case"point":p(t,n,r);break}}function p(e,t,n){n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),n,{instanceKey:e}),r("QPLUserFlow").addPoint(r("qpl")._(521481602,"829"),t,{instanceKey:e})}function _(e,t){r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),t,{instanceKey:e})}function f(e,t){var n;r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),d(t),{instanceKey:e}),r("QPLUserFlow").endCancel(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:t==null||(n=t.string)==null?void 0:n.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").CANCEL)}function g(e,t,n){var a;r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),d(n),{instanceKey:e}),r("QPLUserFlow").endFailure(r("qpl")._(521481602,"829"),t,{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:n==null||(a=n.string)==null?void 0:a.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").FAIL)}function h(e,t,n){p(e,t),y(e,n)}function y(e,t){t&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),t,{instanceKey:e}),r("QPLUserFlow").endSuccess(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").SUCCESS)}function C(e,t,n){var a;p(e,t),n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),n,{instanceKey:e}),r("QPLUserFlow").endTimeout(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:n==null||(a=n.string)==null?void 0:a.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").TIMEOUT)}function b(t,n,o){var a=r("qpl")._(521481602,"829");p(t,n),o&&(e||(e=r("QuickPerformanceLogger"))).markerAnnotate(a,o,{instanceKey:t}),(e||(e=r("QuickPerformanceLogger"))).markerEnd(a,52,t,e.currentTimestamp())}function v(){return o("WAHashStringToNumber").hashStringToNumber(o("MAWExternalId").generateExternalId())}function S(e,t){return t===void 0&&(t=0),o("WAHashStringToNumber").hashStringToNumber(o("WAGetHashFromProtocolMsgId").getHashFromProtocolMsgId(e)+"_"+o("WAGlobals").getMyDeviceJid()+"_"+t)}function R(e){return r("MAWEBSwitch").isEnabled()&&o("MAWMsgType").isEBSupportedMsgType(e.type)&&e.ack>=o("MAWAckLevel").ACK.sent&&e.serverTs!=null&&!(e.ephemeralSetting!=null&&e.ephemeralSetting.ephemeralExpirationInSec>0)}function L(e){return{addAnnotations:function(n){_(e,n)},addPoint:function(n,r){p(e,n,r)},endCancel:function(n,r){f(e,r)},endFail:function(n,r){g(e,n,r)},endSuccess:function(n){y(e,n)},getQPLAttrs:function(){return{instanceKey:e}},isActive:function(){return!0},start:function(){}}}function E(e,t){return e.get(t)}function k(e,t,n,r,o){var a=E(t,n);if(a!=null)switch(e){case"success":h(a,r,o);break;case"fail":g(a,r,o);break;case"point":p(a,r,o);break}}l.EBUploadTrackingWorkerFailurePoints=u,l.startUploadTracking=c,l.handleBridgeEbUploadTrackingQPL=m,l.addPointWorkerOnly=p,l.addAnnotationsWorkerOnly=_,l.endCancelWorkerOnly=f,l.endFailWorkerOnly=g,l.endSuccessWorkerOnly=h,l.endTimeoutWorkerOnly=C,l.endRetryWorkerOnly=b,l.genInstanceKeyOnly=v,l.genInstanceKeyForUploadQueue=S,l.isUploadSupported=R,l.makeEBWorkerQplFlowFromInstanceKey=L,l.getUploadTrackingInstanceKey=E,l.addUploadTrackingByType=k}),98);
__d("EncryptedBackupsUploadQueueV3Scheduler",["EBGenerateMessageTags","EBMessageProbe","EBUploadMessagesFromWorkerMutationDeferred","EncryptedBackupsCreateAttachmentContext","EncryptedBackupsUploadEntity","EncryptedBackupsUploadQueueV3","FBLogger","I64","MAWBridgeUpload","MAWEBLSInWorkerSwitch","MAWEBUploadTrackingUtils","MAWProtobufValidator","MWEBODSUtils","QPLFlow","WACommsConnectionState","WAGlobals","WAHashStringToNumber","WAJids","WAStanzaUtils","WATimeUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","justknobx","performanceAbsoluteNow","qpl","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3_scheduler"])},h=null;function y(){return h!==null}var C;function b(){return C}var v={concurrency:1,maxTaskLimit:1,maxThrottleMs:r("justknobx")._("1453"),timeoutMs:r("justknobx")._("1460")};function S(){r("MAWEBLSInWorkerSwitch").onSet(function(e){e===!0&&R()}),o("WACommsConnectionState").WACommsConnectionState.onSet(function(e){e===!0&&R()}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().subscribe(function(e){e.type==="new_entities"&&R()}),R()}function R(){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(h!=null){g().DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload is already running"])));return}yield o("WAWaitForUserUnblocked").waitForUserUnblocked();var t=o("QPLFlow").startQPLFlow(r("qpl")._(521475028,"909"));if(!r("MAWEBLSInWorkerSwitch").isEnabled()){g().DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["EB is not enabled"]))),t.addPoint("eb_disabled"),t.endSuccess();return}if(!o("WACommsConnectionState").WACommsConnectionState.isConnected()){g().DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["WAComms connection is not established"]))),t.addPoint("wa_comms_not_connected"),t.endSuccess();return}h=o("WorkerScheduler").makeScheduler("EncryptedBackupsUploadQueueV3",v).task({fn:function(){return E(t)},name:"eb_upload_queue_v3",priority:o("WorkerScheduler").BACKGROUND_PRIORITY});try{var n=yield h.run();h=null,n&&R()}catch(e){h=null;var a=r("getErrorSafe")(e);g().FATAL(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Runtime error during EB upload run: ",""])),a.message),t.endFail("runtime_error"),R()}}),L.apply(this,arguments)}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=[],n=0,a=0,i=yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().readFromIndex("[attemptCount+addedAtMs]",{filter:function(i){return Date.now()-i.timestampMs>o("WATimeUtils").DAY_MILLISECONDS*30?(t.push(i.queueId),n++,!1):o("MAWProtobufValidator").isProtobufValid(i.payload)?i.attemptCount<r("justknobx")._("1596"):(t.push(i.queueId),a++,!1)},limit:r("justknobx")._("1676"),order:"asc"});if(e.addPoint("retrieved_entries",{int:{entriesCount:i.length}}),t.length>0&&(yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().delete(t),e.addPoint("deleted_invalid_entries",{int:{expiredEntryCount:n,invalidProtobufEntryCount:a}})),i.length===0)return e.endSuccess(),t.length>0;g().DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"])),i.length);var l=[],s=[];for(var u of i){var c;o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(u.messageId,"message_picked_from_queue",{is_retroactive:u.debugInfo.isRetroactive||!1,trigger_source:"upload-message-from-mps"});var _=o("WAHashStringToNumber").hashStringToNumber(r("uuidv4")()),h=$(u,_);l.push(h),s.push(_),o("MAWEBUploadTrackingUtils").startUploadTracking(o("WAStanzaUtils").toStanzaId(u.messageId),o("WAJids").threadIdForChatJid(o("WAJids").unsafeCoerceToChatJid(u.threadId)),void 0,(c=u.debugInfo.triggerSource)!=null?c:"unknown",_,!0,u.debugInfo.isRetroactive||!1,h.attachmentBackupContext,"protobuf_only",u.attemptCount);var y=/^\d*$/.test(h.messageId);if(o("MAWEBUploadTrackingUtils").addAnnotationsWorkerOnly(_,{bool:{message_id_valid:y}}),!y){var b;g().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Invalid message OTID: ",""])),h.messageId),o("MWEBODSUtils").markODSForEB("upload",((b=u.debugInfo.triggerSource)!=null?b:"unknown")+".invalid_otid")}}e.addPoint("generated_bridge_upload_messages"),s.forEach(function(e){return o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e,"fire_protobuf_only_upload_bridge_event")});try{var v=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(l,"EncryptedBackupsUploadQueueV3");if(e.addPoint("received_upload_response"),v.success){for(var S of i)o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(S.messageId,"message_uploaded_via_graphql",{action_type:S.backupDirective.actionType,upload_type:"protobuf_only"}),o("EncryptedBackupsUploadQueueV3").queryMediaRestoreProbe(S);yield I(i,s),C=(f||(f=r("performanceAbsoluteNow")))(),e.endSuccess()}else if(yield T(i,s,v.error,!0),e.endFail(v.error),v.error==="user_device_not_enrolled")return!1}catch(t){var R=r("getErrorSafe")(t);g().MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Runtime error when doing GraphQL upload, ",""])),R.message),yield T(i,s,R.message,!0),e.endFail("graphql_runtime_error")}return!0}),k.apply(this,arguments)}function I(e,t){return t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_queue_ack_worker_success")}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}function T(e,t,n,r){return D.apply(this,arguments)}function D(){return D=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){if(t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endFailWorkerOnly(e,"upload_queue_ack_worker_"+(r?"retriable":"non_retriable")+"_error",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_ACK_MESSAGE,reason:n}})}),r){yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().put(e.map(function(e){return babelHelpers.extends({},e,{attemptCount:e.attemptCount+1})}));return}yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}),D.apply(this,arguments)}var x=o("WAJids").createJidUtils({platform:"msgr"});function $(e,t){var n=e.backupDirective.actionType===3?e.backupDirective.originalMsgProtocolId.externalId:o("WAStanzaUtils").toStanzaId(e.messageId),r=x.toUserJid(e.senderId),a=o("WAJids").unsafeCoerceToChatJid(e.threadId),i=r===o("WAGlobals").getMyUserJid()?o("WAJids").AUTHOR_ME:r,l={author:i,chat:a,externalId:n},s=o("EncryptedBackupsCreateAttachmentContext").createAttachmentContext(o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload)),u=o("MAWBridgeUpload").createBridgeUploadAttachmentBackupContext(void 0,"msgr",s),c=s.map(function(e){return o("EBGenerateMessageTags").generateEBMessageTags(e.mediaType)}).filter(Boolean);return{actionType:e.backupDirective.actionType===3?2:1,attachmentBackupContext:u,authTs:void 0,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:e.backupDirective.originalMsgProtocolId.externalId,messageType:void 0,protoMsg:{backupActionType:e.backupDirective.actionType,msgId:l,originalMsgProtocolId:e.backupDirective.originalMsgProtocolId,protobuf:o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload),senderId:(_||(_=o("I64"))).of_string(o("WAJids").userIdFromJid(r)),serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(e.timestampMs),sortOrderMs:o("WATimeUtils").castToMillisTime(e.timestampMs),supplementalKey:e.backupDirective.supplementalKey,tags:c},sortOrderMs:e.timestampMs,threadId:o("WAJids").threadIdForChatJid(a),traceId:t.toString(),uploadTrackingInstanceKey:t}}l.isUploadTaskScheduled=y,l.getLastSuccessfulAckTimestampMs=b,l.subscribeToUploadQueueUpdates=S}),98);
__d("MAWAdminWriteUserDeviceMsgTxn",["MAWAckLevel","MAWAdminMsgHelpers","MAWDbMsgTxns","MAWDexieTable","MAWExternalId","MAWGetUserDeviceChangeAdminType","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e={add:"add",remove:"remove",update:"update"};function s(e,t,n,a,i){return o("MAWDbMsgTxns").getIsThreadEmpty(e,n.jid).then(function(l){if(l)return o("MAWDexieTable").dexieResolve();var s=t===o("MAWUserJidWrapper").getMyUserJid(),u=o("MAWGetUserDeviceChangeAdminType").getUserDeviceAdminType(a,s),c=s?[]:[o("WAJids").userIdFromJid(t)],d=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:c,adminType:u,version:1},n.jid,o("MAWExternalId").generateExternalId(),i);return o("MAWWriteMsgTxns").writeMsg(e,d,n).then(r("emptyFunction"))})}function u(e,t,n,a){var i=o("MAWAdminMsgHelpers").UNKNOWN_USER,l=t===o("MAWUserJidWrapper").getMyUserJid(),s={ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:l?o("WAJids").AUTHOR_ME:t,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.ICDC_ALERT_ADMIN_MESSAGE,authorName:i},threadJid:n.jid,ts:a!=null?a:o("WATimeUtils").unixTime(),type:o("MAWMsgType").MSG_TYPE.ICDC_ALERT};return o("MAWWriteMsgTxns").writeMsg(e,s,n).then(r("emptyFunction"))}l.DeviceChange=e,l.writeUserDeviceAdminMsg=s,l.writeICDCAlert=u}),98);
__d("MpsFutureProofKey",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({WCEPlaintextPayloadFutureProofPlaceholder:0,WCEPlaintextPayloadFutureProofNoPlaceholder:1,WCEPlaintextPayloadFutureProofIgnore:2});i.WCEPlaintextPayloadFutureProof=e}),66);
__d("WABuildMpsPayload",["MpsFutureProofKey","MpsTypes","WAArmadilloBackupMessage.pb","WAArmadilloMiTransportAdminMessage.pb","WAArmadilloTransportEvent.pb","WAGlobals","WAJids","WALogger","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=o("WAJids").extractUserId(t.senderJid),r;t.hideDecryptionFailure!=null&&(r=t.hideDecryptionFailure?o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder:o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofPlaceholder);var a=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloBackupMessage.pb").BackupMessageSpec,babelHelpers.extends({},e,{metadata:{frankingMetadata:{frankingTag:t.frankingTag,reportingTag:t.reportingTag},messageId:t.externalId,payloadVersion:2,senderId:n,futureProofBehavior:r,timestampMs:t.timestampMs}})).readBuffer();return a}function d(e,t){var n=o("WAJids").extractUserId(t.senderJid),r=o("MpsTypes").toThreadId(t.threadId),a=t.millisServerTs!=null?t.millisServerTs:t.serverTs*1e3+o("WAGlobals").getDependencies().extractMsFromStanzaId(t.externalId),i=c(e,{senderJid:t.senderJid,externalId:t.externalId,frankingTag:t.frankingTag,reportingTag:t.reportingTag,hideDecryptionFailure:t.hideDecryptionFailure,threadId:t.threadId,timestampMs:o("MpsTypes").toTimestamp(a)});return{messageId:o("MpsTypes").toMessageId(t.externalId),payload:o("MpsTypes").toBytes(i),senderId:n,threadId:r,timestampMs:o("MpsTypes").toTimestamp(a)}}function m(t,n,r){try{var a={};switch(r.type){case"message":a={encryptedTransportMessage:r.applicationPayload};break;case"ciphertext":a={encryptedTransportEvent:{payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;case"unavailable":a={encryptedTransportEvent:{payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;default:r.type}var i=n.type==="Available"?n.originalMsgTimestampMs:null;return d(a,babelHelpers.extends({senderJid:o("WAJids").extractUserJid(n.from),externalId:t.stanzaId},i!=null?{millisServerTs:o("WATimeUtils").castToMillisTime(i)}:{serverTs:t.serverTs},{frankingTag:t.frankingTag,reportingTag:t.reportingTag,hideDecryptionFailure:t.hideDecryptionFailure,threadId:n.chat}))}catch(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["buildMpsMessagePayload: ",""])),t),null}}function p(e,t,n){if(n.payload==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: No appdata payload"]))),null;try{return d({encryptedTransportMessage:n.payload},{senderJid:o("WAJids").extractUserJid(e.from),externalId:e.stanzaId,serverTs:t,threadId:o("WAJids").extractUserJid(e.from)})}catch(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: ",""])),e),null}}function _(e,t,n,r,a){var i={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupMembershipAddModeChanged:{mode:n}}).readBuffer(),version:3};return d({miTransportAdminMessage:i},{serverTs:r!=null?r:o("WATimeUtils").unixTime(),externalId:a,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function f(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupAdminChanged:{targetUserId:n.map(o("WAJids").extractUserId),action:r}}).readBuffer(),version:3};return d({miTransportAdminMessage:l},{serverTs:a!=null?a:o("WATimeUtils").unixTime(),externalId:i,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function g(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupParticipantChanged:{targetUserId:n.map(o("WAJids").extractUserId),action:r}}).readBuffer(),version:3};return d({miTransportAdminMessage:l},{serverTs:a!=null?a:o("WATimeUtils").unixTime(),externalId:i,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function h(e,t,n,r,a){var i={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupNameChanged:{groupName:n}}).readBuffer(),version:3};return d({miTransportAdminMessage:i},{serverTs:r!=null?r:o("WATimeUtils").unixTime(),externalId:a,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function y(e,t,n){var r={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{icdcAlert:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$IcdcAlert$Type.DETECTED}}}).readBuffer(),version:3};return d({encryptedTransportEvent:r},{serverTs:t!=null?t:o("WATimeUtils").unixTime(),externalId:n,hideDecryptionFailure:!1,senderJid:e,threadId:e})}function C(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{deviceChange:{type:r,devicePlatform:a,deviceModel:i}}}).readBuffer(),version:3};return d({encryptedTransportEvent:l},{serverTs:t!=null?t:o("WATimeUtils").unixTime(),externalId:n,hideDecryptionFailure:!1,senderJid:e,threadId:e})}l.buildBackupProtobufBytes=c,l.buildMpsMessage=d,l.buildMpsMessageFromIncomingMessage=m,l.buildMpsAppdataPayload=p,l.buildMpsGroupMemberAddType=_,l.buildMpsGroupAdminChangedMsg=f,l.buildMpsGroupParticipantsChanged=g,l.buildMpsGroupNameChangedMsg=h,l.buildMpsIcdcAdminMessage=y,l.buildMpsDeviceChangeAdminMessage=C}),98);
__d("EBMinosWriteKeyChangeAdminMessage",["EBMinosTypes","FBLogger","MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAppMeta","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWTransactionMode","MpsTypes","Promise","WAArmadilloTransportEvent.pb","WABuildMpsPayload","WADbContact","WAGlobals","WAJids","WAStanzaUtils","WebMps","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert}).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlert)!=null?t:!1})}function c(e,t){var n=o("WAGlobals").getMyUserJid()===t;return!n&&e}function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.deviceChangeType,n=t===void 0?o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED:t,a=e.epochHeadCreationTime,i=e.userJid;try{var l=o("MAWExternalId").generateExternalId(),s=o("WABuildMpsPayload").buildMpsDeviceChangeAdminMessage(i,a,o("WAStanzaUtils").toStanzaId(l),n),u={directive:null,insertionSource:o("MpsTypes").InsertionSource.Receive,message:s};yield o("WebMps").mps().saveNewMessages([u],{source:"eb-minos-device-change"}),r("FBLogger")("wmi_minos").info("Sent device change transport event for user %s with type %s",i,String(n))}catch(e){var c=r("getErrorSafe")(e);throw r("FBLogger")("wmi_minos").catching(c).mustfix("Failed to send device change transport event for user %s",i),c}}),m.apply(this,arguments)}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.contactId,i=t.epochHeadCreationTime,l=o("EBMinosTypes").userFbidToUserJid(a);if(l==null)return r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid userJid generated in writeKeyChangeAdminMessage"]))),(s||(s=n("Promise"))).resolve();var m=yield o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDbThreadTxns").getAllThreadsForUsers(e,[l])}})(),p=m.get(l),_=yield o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:[l]});if(p==null||(p==null?void 0:p.length)===0)return(s||(s=n("Promise"))).resolve();var f=p.filter(function(e){var t=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return"group"},user:function(){return"one_to_one"}});return t==="one_to_one"}),g=yield(s||(s=n("Promise"))).all([d({deviceChangeType:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED,epochHeadCreationTime:i,userJid:l}),o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY,ftsBackloggedMessages:o("MAWTransactionMode").READWRITE,groupInfo:o("MAWTransactionMode").READONLY,messages:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDexieTable").dexieAll(f.map(function(t){return u(e).then(function(n){c(n,l)&&_.get(l)===o("WADbContact").TWO_WAY_CONTACT?o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,l,t,"update",i):o("MAWDexieTable").dexieResolve()})}))}})()]),h=g[1];return h}),_.apply(this,arguments)}l.saveDeviceChangeTransportEvent=d,l.writeMinosKeyChangeAdminMessage=p}),98);
__d("MAWDbAddDeviceChangeAlertsTxn",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.deviceChangeAlerts.add(t)}i.addDeviceChangeAlertsTxn=e}),66);
__d("MAWDbDeviceChangeAlerts",[],(function(t,n,r,o,a,i){"use strict";var e="add",l="keyChange",s="remove";function u(e){return e}i.ADD=e,i.KEY_CHANGE=l,i.REMOVE=s,i.unsafeCoerceToDeviceChangeAlertsID=u}),66);
__d("WACryptoHkdf",["Promise","WABinary","WACryptoHmac","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s=255*o("WACryptoHmac").SHA256_BYTE_LENGTH;function u(t,a,i){if(i<0||i>s)return(e||(e=n("Promise"))).reject(r("err")("HKDF::expand given bad length "+i));for(var l,u=Math.ceil(i/o("WACryptoHmac").SHA256_BYTE_LENGTH),c=o("WABinary").Binary.build(a).readByteArrayView(),d=new(o("WABinary")).Binary,m=o("WACryptoHmac").encodeKeySha256(t).then(function(e){return l=e,new Uint8Array(0)}),p=function(t){m=m.then(function(e){return o("WACryptoHmac").sign(l,o("WABinary").Binary.build(e,c,t).readByteArrayView())}).then(function(e){var t=new Uint8Array(e);return d.writeByteArray(t),t})},_=1;_<=u;_++)p(_);return m.then(function(){return d.readBuffer(i)})}function c(e,t,n){return o("WACryptoHmac").extractSha256(null,e).then(function(e){return u(new Uint8Array(e),t,n)})}function d(e,t,n,r){return o("WACryptoHmac").extractSha256(t,e).then(function(e){return u(new Uint8Array(e),n,r)})}l.expand=u,l.extractAndExpand=c,l.extractWithSaltAndExpand=d}),98);
__d("WAXmlParsingFailure",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.parser=e,this.reason=t}var t=e.prototype;return t.toString=function(){return"XmlParsingFailure: "+this.parser+": "+this.reason},e})();i.XmlParsingFailure=e}),66);
__d("WAParsableXmlNode",["WAHasProperty","WAXmlParsingFailure","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){throw new TypeError('"'+e+'" is read-only')}var s=(function(){function e(e,t){var n=this;this.$1=e,this.$2=t,this.$3=Array.isArray(t.content)?t.content.map(function(t){return new n.constructor(e,t)}):null}var t=e.prototype;return t.name=function(){return this.$1},t.node=function(){return this.$2},t.hasAttr=function(t){return r("WAHasProperty")(this.$2.attrs,t)},t.assertTag=function(t){this.$2.tag!==t&&this.throw("to be <"+t+">")},t.tag=function(){return this.$2.tag},t.maybeChild=function(t){var e=this.$3;if(!e)return null;for(var n=0;n<e.length;n++)if(e[n].tag()===t)return e[n];return null},t.hasChild=function(t){return!!this.maybeChild(t)},t.child=function(t){var e=this.maybeChild(t);return e||this.throw("to have child <"+t+">")},t.assertAttr=function(t,n){var e=this.attrString(t);e!==n&&this.throw('to have "'+t+'"="'+n+'", but instead has "'+e+'"')},t.attrString=function(t){return r("WAHasProperty")(this.$2.attrs,t)?this.decodeAsString(this.$2.attrs[t]):this.throw('to have attribute "'+t+'"')},t.forEachAttributeKey=function(t){var e=this.$2.attrs;Object.keys(e).forEach(function(e){return t(e)})},t.maybeAttrString=function(t){return this.hasAttr(t)?this.decodeAsString(this.$2.attrs[t]):null},t.maybeAttrInt=function(t,n,r){return this.hasAttr(t)?this.attrInt(t,n,r):null},t.attrEnumValues=function(t,n,r){var e=new Set(n),o=this.attrString(t);if(!e.has(o)){if(r!=null)return r;var a=Array.from(e).join("|");return this.throw('to have "'+t+'"={'+a+'} but has value "'+o+'"')}return o},t.attrEnum=function(t,n){var e=this.attrString(t);if(!r("WAHasProperty")(n,e)){var o=Object.keys(n).join("|");return this.throw('to have "'+t+'"={'+o+'} but has value "'+e+'"')}return n[e]},t.attrEnumOrNullIfUnknown=function(t,n){var e=this.attrString(t);return r("WAHasProperty")(n,e)?n[e]:null},t.maybeAttrEnum=function(t,n){return this.hasAttr(t)?this.attrEnum(t,n):null},t.attrInt=function(t,n,r){var e=this.attrString(t);return this.$4(e,t,n,r)},t.$4=function(t,n,r,o){var e=parseInt(t,10);return Number.isNaN(e)?this.throw('to have "'+n+'"={integer} but has value "'+t+'"'):r!==void 0&&e<r?this.throw('to have "'+n+'"={at least '+r+"} but has value "+e):o!==void 0&&e>=o?this.throw('to have "'+n+'"={below '+o+"} but has value "+e):e},t.forEachChild=function(t){var e=this.$3;if(e)e.forEach(function(e){return t(e)});else if(this.$2.content!=null)return this.throw("to have children")},t.forEachChildWithTag=function(t,n){this.forEachChild(function(e){e.tag()===t&&n(e)})},t.mapChildren=function(t){var e=this.$3;return!e&&this.$2.content!=null?this.throw("to have children"):e?e.map(function(e){return t(e)}):[]},t.mapChildrenWithTag=function(t,n){var e=this.$3;return!e&&this.$2.content!=null?this.throw("to have children"):e?e.filter(function(e){return e.tag()===t}).map(function(e){return n(e)}):[]},t.mapFirstChild=function(t){var e=this.$3;return!e||e.length===0?this.throw("to have children"):t(e[0])},t.hasContent=function(){return!this.$3&&!!this.$2.content},t.hasChildren=function(){return this.$3!=null},t.getChildren=function(){return this.$3},t.mapAttrKeys=function(t){var e=this.getAttrKeys();return e&&e.length?e.map(t):[]},t.getAttrKeys=function(){return Object.keys(this.$2.attrs)},t.hasAttrs=function(){var e=this.$2.attrs?Object.keys(this.$2.attrs):[];return e.length>0},t.getNode=function(){return this.$2},t.unsafeSetChildren=function(t){this.$3=t},t.unsafeSetNodeContent=function(t){this.$2.content=t},t.contentUint=function(t){var e=this.contentBytes(t);return u(e,t)},t.contentBytes=function(t){if(t===void 0&&(t=-1),this.$3)return this.throw("to have binary content, but has children instead");if(this.$2.content!=null){var e=this.$2.content;return t!==-1&&e.length!==t?this.throw("to be "+t+" bytes, but got "+e.length+" instead"):e}else return this.throw("to have content")},t.contentString=function(){return this.$3?this.throw("to have string content, but has children instead"):this.$2.content!=null?this.$2.content:this.throw("to have content")},t.contentInt=function(t,n){var e=this.contentString();return this.$4(e,"content",t,n)},t.contentEnum=function(t){var e=this.contentString();if(!r("WAHasProperty")(t,e)){var n=Object.keys(t).join("|");return this.throw("to have content {"+n+'} but has value "'+e+'"')}return t[e]},t.decodeAsString=function(t){if(typeof t!="string")throw r("err")("decodeAsString: attribute is "+typeof t+" not a string: "+t);return t},t.throw=function(t){throw new(o("WAXmlParsingFailure")).XmlParsingFailure(this.$1,"expected <"+this.$2.tag+"> "+t)},t.toString=function(){return this.$2.toString()},e})();function u(e,t){for(var n=0,r=0;r<t;r++)n=n*256+e[r];return n}l.ParsableXmlNode=s,l.convertBytesToUint=u}),98);
__d("WASignalOther",["WACryptoDependencies","WACryptoHkdf","WACryptoUtils","WAParsableXmlNode","decodeProtobuf","encodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e={name:"AES-CBC"},s={name:"HMAC",hash:"SHA-256"};function u(e,t){if(e.length!==t)throw r("err")("Signal expected "+t+" bytes, given "+e.length);return e}function c(e,t){return u(new Uint8Array(e),t)}function d(e){var t=e.buffer,n=e.byteOffset,r=e.length;return n===0&&r===t.byteLength?t:t.slice(n,n+r)}function m(e,t){return e.readByteArrayView(t)}function p(e){return new Uint8Array(e)}function _(e,t,n){if(e.length-t<n)throw r("err")("Can not split off "+n+" bytes from index "+t+" of "+e.length+" bytes");return e.slice(t,t+n)}function f(e){var t=e==="extendedRange"?2147483646:16380;return o("WACryptoUtils").randomNumberLessThan(t)+1}function g(e){return b(e)}function h(e){return o("WAParsableXmlNode").convertBytesToUint(e,4)}function y(){var e=2147483647;return o("WACryptoUtils").randomNumberLessThan(e)+1}function C(e){return b(e)}function b(e,t,n){if(t===void 0&&(t=0),n===void 0&&(n=4294967296),typeof e=="number"&&t<=e&&e<n&&Math.floor(e)===e)return e;throw r("err")("Expected integer in range ["+t+", "+n+"), given "+String(e))}function v(e,t){return o("encodeProtobuf").encodeProtobuf(e,t).readByteArrayView()}function S(e,t,n){return n(o("decodeProtobuf").decodeProtobuf(e,t))}function R(e,t,n,r){return o("WACryptoHkdf").extractWithSaltAndExpand(e,t,n,r).then(function(e){return new Uint8Array(e)})}function L(t,n){var r,a;return n==="hmac-sha256"?(r=s,a=["sign"]):(r=e,a=["encrypt","decrypt"]),o("WACryptoDependencies").getCrypto().subtle.importKey("raw",t,r,!1,a)}function E(e){return e}function k(e){return e}function I(e,t){return o("WACryptoUtils").arrayBuffersEqual(e,t)}l.AES_CBC=e,l.HMAC_SHA256=s,l.ensureSize=u,l.toBytes=c,l.toBuffer=d,l.readBytes=m,l.makeBytes=p,l.sliceBytes=_,l.makeRegistrationId=f,l.castRegistrationId=g,l.castRegistrationIdFromBytes=h,l.makeSenderKeyId=y,l.castSenderKeyId=C,l.ensureIntInRange=b,l.encodeSignalProto=v,l.decodeSignalProto=S,l.hkdf=R,l.makeCryptoKey=L,l.castToByteEncoded=E,l.castToSessionHash=k,l.areSessionHashesEqual=I}),98);
__d("EBMinosWriteSecureStorageAlert",["EBMinosTypes","FBLogger","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWIndexedDb","MAWTransactionMode","MAWUnsafeCoerce","Promise","WAJids","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){var a=t.contactId,i=t.epochHead,l=t.epochHeadCreationTime,u=o("WAJids").validateDeviceJid(o("EBMinosTypes").userFbidToUserJid(o("EBMinosTypes").unsafeCastToUserFbId(a)));return u==null?(r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid deviceJid generated in writeMinosSecureStorageAlert"]))),(s||(s=n("Promise"))).resolve()):o("MAWIndexedDb").makeMsgrTransactor({deviceChangeAlerts:o("MAWTransactionMode").READWRITE},"writeMinosSecureStorageAlert",function(e){return function(){return o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:u,epochHead:i,identity:o("MAWUnsafeCoerce").unsafeCoerce(o("WASignalOther").toBytes(i,32)),isArchived:!1,model:"secure_storage",platform:"Meta",ts:l})}})()}l.writeMinosSecureStorageAlert=u}),98);
__d("EBSenderUploadQueue",["EBMinosLogger","PersistedQueueApi","Promise","WAPersistedQueue","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(t){return t},d=null;function m(){return d==null?p():d}function p(){d!=null&&o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebSenderUploadQueueV3",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return(u||(u=n("Promise"))).resolve();try{var t=m();yield t.addAndCommit(e)}catch(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebSenderUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)}}),f.apply(this,arguments)}l.toSendersQueueId=c,l.ebSenderUploadQueue=m,l.enqueueMessages=_}),98);
__d("EncryptedBackupTaskFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5725"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_failure",e),u=s;l.default=u}),98);
__d("EncryptedBackupTaskIssuedFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5726"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_issued",e),u=s;l.default=u}),98);
__d("EncryptedBackupsResignCdnUrl",["MAWBridge","MAWConfig","MAWLoggerUtils","WAJids","WAPromiseDelays","WAResolvable","WAResultOrError","asyncToGeneratorRuntime","cr:10071","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new Map;function u(e){return s.get(e)}function c(t){var n=t.deliveryObjectId,r=t.logger,a=t.mediaDownloadFlow,i=t.mediaKey,l=t.mediaType,s=t.msgId,u=t.protocolMsgId,c=t.sortOrderMs;return a.addPoint("resign_cdn_url_start"),d({deliveryObjectId:n,mediaDownloadFlow:{addAnnotations:function(t){a==null||a.addAnnotations(babelHelpers.extends({},t))},addPoint:function(t,n){a==null||a.addPoint(t,babelHelpers.extends({},n))}},mediaKey:i,mediaType:l,msgId:s,protocolMsgId:u,sortOrderMs:c}).then(function(e){return e.success?(a==null||a.addPoint("resign_cdn_url_end"),e):(a.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:e.error}}),e)}).catch(function(t){return r.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["resignCdnUrl runtime-error: ",""])),t),a.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(t)}}),o("WAResultOrError").makeError("resign-cdn-url-runtime-error")})}function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.deliveryObjectId,r=e.mediaDownloadFlow,a=e.mediaKey,i=e.mediaType,l=e.msgId,u=e.protocolMsgId,c=e.sortOrderMs;if(n("cr:10071")!==null){var d=yield n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:u.chat,deliveryObjectId:t,externalId:u.externalId,mediaDownloadFlow:r,mediaKey:a,mediaType:i,sortOrderMs:c});return d.success?o("WAResultOrError").makeResult(d.value):d}else{var m=o("MAWLoggerUtils").getInstanceKey(),p=new(o("WAResolvable")).Resolvable;return s.set(m,p),o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:t,mediaType:i,messageId:u.externalId,msgId:l,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,skipLegacyMediaDownloadFlow:!0,sortOrder:c,threadId:o("WAJids").threadIdForChatJid(u.chat),threadJid:u.chat,traceId:m}}]}),o("WAPromiseDelays").withTimeout(p.promise,900*1e3,function(){return o("WAResultOrError").makeError("resign-cdn-url-timeout")}).finally(function(){s.delete(m)})}}),m.apply(this,arguments)}l.getRestoredCdnUrlResolvable=u,l.resignCdnUrl=c}),98);
__d("LSWriteSupplementalMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeSupplementalMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[5])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeSupplementalMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeSupplementalMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteSupplementalMessageStoredProcedure",e.__tables__=["local_message_persistence_store_supplemental"],a.exports=e}),null);
__d("LSWriteSupplementalMessageStoredProcedure",["LSSynchronousPromise","LSWriteSupplementalMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteSupplementalMessage"),a.messagePayload,a.threadId,a.toplevelOfflineThreadingId,a.supplementalKey,a.offlineThreadingId,a.messageTimestampMs);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSWriteTopLevelMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeTopLevelMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[3])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=!1:(t=o.item,r[14]=!0)})},function(n){return r[14]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[16]=n[0],r[17]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[16]=t[0],r[17]=t[1],t}])},function(e){var t;return t=[r[16],r[17]],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[12]=!1:(t=o.item,r[12]=!0)})},function(n){return r[12]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[14]=n[0],r[15]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[14]=t[0],r[15]=t[1],t}])},function(e){var t;return t=[r[14],r[15]],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeTopLevelMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeTopLevelMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteTopLevelMessageStoredProcedure",e.__tables__=["local_message_persistence_store","local_message_persistence_store_deleted_messages"],a.exports=e}),null);
__d("LSWriteTopLevelMessageStoredProcedure",["LSSynchronousPromise","LSWriteTopLevelMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteTopLevelMessage"),a.messagePayload,a.threadId,a.offlineThreadingId,a.messageTimestampMs,a.isLocalOnlyMessage,a.extraData);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MessageBackupTagsDelimiter",[],(function(t,n,r,o,a,i){"use strict";var e=":";i.INSTAMADILLO_TAG_DELIMITER=e}),66);
__d("EncryptedBackupsWriteToMPSTables",["EncryptedBackupsUploadEntity","FBLogger","I64","IGDWEBUploadMessageUtils","LSFactory","LSWriteSupplementalMessageStoredProcedure","LSWriteTopLevelMessageStoredProcedure","MessageBackupTagsDelimiter","WAErrorMessage","WAResultOrError","asyncToGeneratorRuntime","getSafeQplErrorMessage","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("ReverbWriteFailureFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),u=r("requireDeferred")("ReverbWriteSuccessFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables");function c(e,t,n,o,a,i){o?r("promiseDone")(u.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,labyrinth_version:0,message_id:e,thread_id:t}})}):r("promiseDone")(s.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,failure_reason:i,labyrinth_version:0,message_id:e,thread_id:t}})})}function d(e,t,n,r,o){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var s=n.backupActionType,u=n.instamadilloItemId,d=n.msgId,m=n.originalMsgProtocolId,p=n.protobuf,_=n.serverTs,f=n.sortOrderMs,g=n.supplementalKey;l==null||l.addPoint("mps_tables_write_start");var h=d.externalId,y=m==null?void 0:m.externalId,C=u!=null?u:f;if(C==null)return l==null||l.addPoint("mps_tables_write_missing_protobuf_ts"),o("WAResultOrError").makeError({errorCode:null,errorMsg:"protobufTimestampMs is null when writing to MPS tables"});var b=(e||(e=o("I64"))).of_float(C),v=!1,S=i?"dual_upload":"open_eb_ttlc",R=null;switch(s){case 1:{l==null||l.addPoint("mps_top_level_write_start");try{var L=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(p),messageTimestampMs:b,offlineThreadingId:h,threadId:a}),E=L[0],k=L[1];R=k,E&&(v=!0),c(h,a,"upsert_top_level",E,S),l==null||l.addPoint("mps_top_level_write",{bool:{mps_top_level_write_succesful:E}})}catch(e){c(h,a,"upsert_top_level",!1,S,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_top_level_write_error",{string:{mps_top_level_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 2:{if(l==null||l.addPoint("mps_supplemental_write_start"),y==null||g==null)c(h,a,"upsert_supplemental",!1,S),r("FBLogger")("wmi_eb").warn("Missing toplevelOfflineThreadingId or supplementalKey when writing to MPS tables");else try{var I=yield r("LSWriteSupplementalMessageStoredProcedure")(r("LSFactory")(t),{messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(p),messageTimestampMs:b,offlineThreadingId:h,supplementalKey:g,threadId:a,toplevelOfflineThreadingId:y}),T=I[0],D=I[1];R=D,T&&(v=!0),c(h,a,"upsert_supplemental",T,S),l==null||l.addPoint("mps_supplemental_write",{bool:{mps_supplemental_write_successful:T}})}catch(e){c(h,a,"upsert_supplemental",!1,S,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_supplemental_write_error",{string:{mps_supplemental_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 4:{if(l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_start"),y==null)break;try{var x=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(p),messageTimestampMs:(e||(e=o("I64"))).of_float(o("IGDWEBUploadMessageUtils").generateProtobufServerTs(y,_)),offlineThreadingId:h,threadId:a}),$=x[0],P=x[1];R=P,$&&(v=!0),c(y,a,"delete_top_level",$,S),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write",{bool:{mps_delete_top_level_with_placeholder_write_successful:$}})}catch(e){c(y,a,"delete_top_level_with_placeholder",!1,S,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_error",{string:{mps_delete_top_level_with_placeholder_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 3:v=!0,y!=null&&c(y,a,"delete_top_level",!1,S);break;default:l==null||l.addPoint("mps_write_unsupported_backup_action_type"),r("FBLogger")("wmi_eb").warn("Unsupported backupActionType when writing to MPS tables")}return v?(l==null||l.addPoint("mps_write_successful"),o("WAResultOrError").makeResult(v)):(l==null||l.addPoint("mps_write_unsuccessful"),o("WAResultOrError").makeError({errorCode:R,errorMsg:"Unsuccessful writing to MPS tables"}))}),m.apply(this,arguments)}function p(e,t,n){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r){var a=n.msgId,i=n.sortOrderMs,l=n.tags;l!=null&&l.length!==0&&i!=null&&(yield t.local_message_persistence_store_tag_index.put({localMessagePersistenceStoreKey:(e||(e=o("I64"))).of_string(a.externalId),messageTimestampMs:e.of_float(i),offlineThreadingId:a.externalId,tag:l.join(o("MessageBackupTagsDelimiter").INSTAMADILLO_TAG_DELIMITER),threadId:r}))}),_.apply(this,arguments)}l.writeToMPSTables=d,l.writeTagsToMPSTables=p}),98);
__d("LSEBPayloadSerializerError",[],(function(t,n,r,o,a,i){var e=Object.freeze({INVALID_BACKUP_OPERATION:-7,INVALID_CONTENT_TYPE:-6,INVALID_PAYLOAD_FORMAT:-5,CQL_DB_ERROR:-4,REQUIRED_COLUMN_NOT_PRESENT_ON_CLIENT:-3,DEPRECATED_SPROC:-2,UNKNOWN_ERROR:-1,NOT_AN_ERROR:0,BACKUP_NOT_FOUND:1,REQUIRED_TABLE_NOT_FOUND:2,NATIVE_OP_NOT_FOUND:3,BACKUP_UPLOAD_KILLSWITCHED:4,TASK_ID_NOT_FOUND:5,NOT_IMPLEMENTED:6,NOT_SUPPORTED_ON_WEB:7,DUPLICATE_TASK:8,CLIENT_STATE_NOT_LOADED:9,RECOVERY_CODE_NOT_FOUND:10,EPOCH_KEYS_NOT_FOUND:11,DEVICE_PAYLOAD_NOT_CREATED:12,NULL_DEVICE_PAYLOAD:13,EPOCH_PAYLOAD_NOT_CREATED:14,NULL_EPOCH_PAYLOAD:15,VIRTUAL_DEVICE_PAYLOAD_NOT_CREATED:16,NULL_VIRTUAL_DEVICE_PAYLOAD:17,DEVICE_METADATA_NOT_FOUND:18,NO_MATCHING_DEVICE_PUBLIC_KEY:19,NULL_MAILBOX_ROOT_KEY:20,NULL_ENCRYPTION_VERSION:21,NULL_OCMF_KEY:22,NULL_EPOCH_KEYS:23,NULL_DEVICE_ID:24,OPE_KEY_DERIVATION_FAILED:25,MESSAGE_KEY_DERIVATION_FAILED:26,NULL_MAILBOX_ROOT_KEY_V2:27,ECHO_DOCUMENT_ENCODING_FAILED:30,ECHO_PAYLOAD_CREATION_DISABLED:31,ECHO_DOCUMENT_ENCODING_SKIPPED:32,MESSAGE_PAYLOAD_ENCRYPTION_FAILED:40,SERVER_THREAD_ID_NOT_FOUND_FOR_JID:52,UNKNOWN_PROTOBUF_TYPE:60,SUPPLEMENTARY_DATA_KEY_UNEXPECTED:61,PROTOBUF_ENCRYPTION_FAILED:62,PROTOBUF_NOT_FOUND_IN_TOPLEVEL_TABLE:63,PROTOBUF_NOT_FOUND_IN_SUPPLEMENTAL_TABLE:64,SUPPLEMENTAL_KEY_NOT_SET_IN_CONTEXT_TABLE:65,SUPPLEMENTAL_ENCRYPTION_FAILED:66,PROTOBUF_CONTEXT_ROW_NOT_FOUND:67,PROTOBUF_FORMATTING_FAILED:68,SUPPLEMENTAL_FORMATTING_FAILED:69,PROTOBUF_ALREADY_DELETED:70,PROTOBUF_NOT_FOUND_IN_DELETED_MESSAGES_TABLE:71,DELETION_PROTOBUF_IS_NULL:72,PROTOBUF_PAYLOAD_IN_CONTEXT_ROW_IS_NOT_FOUND:73,PROTOBUF_ENCRYPTION_FAILED_RETRYABLE:74,VALUE_SECRET_REF_INVALID:75,MINOS_ENCRYPTION_RESULT_NULL:76,SUPPLEMENTAL_OTID_NOT_SET_IN_CONTEXT_TABLE:77,SNAPSHOT_NOT_FOUND_FAILURE:78,THREAD_PK_NOT_FOUND_FOR_JID:100,MESSAGE_DECRYPTION_FAILED:101,EPOCH_KEY_FETCH_FAILED:102,TOO_MANY_OPEN_EPOCHS:103,MESSAGE_RANGE_PREPARE_FAILURE:104,ECHO_DOCUMENT_RESTORE_FAILED:105,MISMATCH_POINT_QUERY_MESSAGE_AND_RANGE_LENGTH:106,INITIAL_THREADS_FETCH_FOR_RESTORE_FAILED:107,MISSING_SUPPLEMENTAL_KEY_CIPHERTEXT:108,SUPPLEMENTAL_KEY_DECRYPTION_FAILURE:109,DEVICE_ID_MISMATCH:110,RESTORE_TO_TAM_INFO:111,MISSING_SERVER_THREAD_KEY:112,EB_ADD_DEVICE_FOUND_NO_LOCAL_THREADS:113,EB_MORE_THREADS_IN_MAPPING_TABLE:114,RESTORE_INTEGRITY_CHECK_FAILED:115,RESTORE_TOP_LEVEL_PROTOBUF_NULL:116,DECRYPT_MINOS_PROTOBUF_FAILURE:117,MESSAGE_PK_NOT_FOUND_IN_CLIENT_MESSAGES:200,OTID_NOT_FOUND_IN_ACT_MESSAGES:201,THREAD_ID_NOT_FOUND_IN_ACT_THREADS:202,THREAD_PK_NOT_FOUND_IN_CLIENT_THREADS:203,FAILED_TO_GET_THREAD_SORT_KEY:204,MEDIA_INFO_INVALID:205,REVERB_DB_NOT_ENABLED_FOR_INSTAMADILLO:206,SKIPPED_EB_DISABLED:300,SKIPPED_THREAD_NOT_ELIGIBLE:301,SKIPPED_MESSAGE_NOT_ELIGIBLE:302,NO_EPOCHS_FOUND:400,LATEST_EPOCH_QUERY_BY_ID_FAILED:401,FOUND_EPOCH_WITH_NULL_ROOT_KEY:402,FOUND_EPOCH_WITH_NULL_ANON_ID:403,NO_RECOVERY_CODE:501,NO_ERROR:601,ERROR_GENERAL:602,UNKNOWN:603,ONBOARDING_MATERIAL_DERIVATION_FAILURE:604,NULL_DEVICE_HMAC:605,MISSING_LATEST_EPOCH_AT_ONBOARDING:606,EPOCH_REPAIR_UNREACHABLE_EPOCH:607,NO_THREADS_TO_COMPARE:701,START_SORT_KEY_FAILURE:702,END_SORT_KEY_FAILURE:703,LOOPING_UPLOAD_PAYLOAD_NOT_FOUND:704,NULL_ECHO_IDENTIFIERS:705,ECHO_TIMESTAMP_CONVERSION_FAILED:706,ECHO_PROTOBUF_THREAD_ID_MISMATCH:707,ECHO_PROTOBUF_TIMESTAMP_MISMATCH:708,ECHO_PROTOBUF_OTID_MISMATCH:709,NULL_ECHO_DOCUMENT:710,INVALID_PROTOBUF_BACKUP_ACTION:711,EMPTY_ENCODED_ECHO_DOCUMENT:712,LOOPING_UPLOAD_TASK_QUEUE_FULL:713,ECHO_DOCUMENT_ENCODING_UNKNOWN_ENCODING_ERROR:750,ECHO_DOCUMENT_ENCODING_MESSAGE_PK_NOT_FOUND_ERROR:751,ECHO_DOCUMENT_ENCODING_DISK_WRITE_CHECK_FAILED:752,ECHO_DOCUMENT_ENCODING_THREAD_TRANSPORT_ID_FETCH_FAILED:753,ECHO_DOCUMENT_ENCODING_FILE_WRITE_FAILED:754,ECHO_DOCUMENT_ENCODING_DISK_WRITE_DISABLED:755,ECHO_DOCUMENT_ENCODING_SHOULD_NOT_PERSIST:756,MISSING_SUPPLEMENTAL_DATA:757,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REPLY_PROXY_ERROR:758,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_QUERY_ERROR:759,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_ERROR:760,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_RECEIPTS_ERROR:761,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REACTIONS_ERROR:762,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_VISUAL_MESSAGE_ACTIONS_ERROR:763,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_POLLS_ERROR:764,READ_CLIENT_STATE_FROM_MAIN_DB_ERROR:801,NOT_SUPPORTED_ON_MAIN_DB:802,SKIP_MPS_WRITE_DUE_TO_HIGHER_TIMESTAMP_AVAILABILITY:851,MESSAGE_ALREADY_DELETED:852});i.default=e}),66);
__d("WADbTransactor",["MAWDexie","MAWIndexedDb","MAWTransactionMode","WAExceededStorageQuota","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var r=Object.keys(e),a=r.some(function(t){return e[t]===o("MAWTransactionMode").READWRITE})?o("MAWTransactionMode").READWRITE:o("MAWTransactionMode").READONLY;return function(){for(var e=arguments.length,i=new Array(e),l=0;l<e;l++)i[l]=arguments[l];return o("MAWIndexedDb").getSignalDB(t).then(function(e){return s(a,r,function(){return n(e.stores).apply(void 0,i)})}).then(function(e){return e}).catch(function(e){throw m(e,t)})}}function s(e,t,n){if(r("MAWDexie").currentTransaction!=null)throw r("err")("protocolDB transactor %s cannot be called within another transaction");return o("MAWIndexedDb").getSignalDB().then(function(r){return r.transact(e,t,n)})}function u(e){return e instanceof Error?e:typeof e=="string"?r("err")(e):null}function c(e,t,n,r){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a=e+"_"+r,i=yield o("MAWIndexedDb").getDB(a);return i.transact(t,[e],function(){return n(i.stores[e])}).then(function(e){return e}).catch(function(e){throw m(e,a)})}),d.apply(this,arguments)}function m(e,t){var n;o("WAExceededStorageQuota").checkQuotaExceededError(e);var a=u(e);return a?(a.message="["+((n=a==null?void 0:a.toString())!=null?n:"unknown error")+"] Error performing %s transaction "+t,a):r("err")("[unknown error] Error performing %s transaction "+t)}l.makeSignalTransactor=e,l.persistedQueueTransactor=c}),98);
__d("WAClearSignalStores",["MAWDexieTable","MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({tasks:o("MAWTransactionMode").READWRITE},"clearSignalStores",function(e){return function(){return o("MAWDexieTable").dexieAll([e.tasks.clear()]).then(function(){})}});l.clearSignalStores=e}),98);
__d("WAClearSignalStoresV2",["Promise","WASignalDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(){return o("WASignalDB").getDb().runInTransaction(["identity","contacts","meta","prekey","prekeyGeneration","senderKeySessions","session","signedPrekey","personalSenderKeyStatuses"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){yield(e||(e=n("Promise"))).all([t.stores.identity.clear(),t.stores.contacts.clear(),t.stores.meta.clear(),t.stores.prekey.clear(),t.stores.prekeyGeneration.clear(),t.stores.senderKeySessions.clear(),t.stores.session.clear(),t.stores.signedPrekey.clear(),t.stores.personalSenderKeyStatuses.clear()])});return function(e){return t.apply(this,arguments)}})(),o("WASignalDB").signalOp("clearSignalStores"))};l.clearSignalStores=s}),98);
__d("MAWClearSignalAndTempStores",["MAWDeleteOldLogsFromDisk","MAWJobActionsV2","MAWJobsIndexedDb","MAWLoggingSwitches","MAWTransactionMode","Promise","WAClearSignalStores","WAClearSignalStoresV2","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWJobsIndexedDb").makeJobsTransactor("jobs",o("MAWTransactionMode").READWRITE,"clearJob")(o("MAWJobActionsV2").clearJobs),u=function(){return(e||(e=n("Promise"))).all([o("MAWLoggingSwitches").removeLoggingFromBridge&&o("MAWDeleteOldLogsFromDisk").clearLogs(),o("WAClearSignalStores").clearSignalStores(),s(),o("WAClearSignalStoresV2").clearSignalStores()]).then(r("emptyFunction"))};l.clearSignalAndTempStores=u}),98);
__d("MAWCreateMaybeAddPointForMediaRender",["MAWQplProxy","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return function(t,n){e!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25302828,"2195"),t,{annotations:n,instanceKey:e},!0)}}l.createMaybeAddPointForMediaRender=e}),98);
__d("WAFindMostRecentMediaEntry",["WAMediaUtils","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=null;for(var n of e){var r,a,i=n[0],l=n[1],s=o("WAMediaUtils").decodeMediaEntryData(l);(((r=t)==null?void 0:r[1].mediaKeyTimestamp)==null||s.mediaKeyTimestamp!=null&&s.mediaKeyTimestamp>((a=t)==null?void 0:a[1].mediaKeyTimestamp))&&(t=[i,s])}return t!=null?o("WAResultOrError").makeResult(t):o("WAResultOrError").makeError("no-media-entry")}l.findMostRecentMediaEntry=e}),98);
__d("MAWGetMostRescentDecodedMediaEntry",["MAWDbMediaTxns","MAWIndexedDb","MAWTransactionMode","MWFBLogger","WAFindMostRecentMediaEntry","WAHashUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MWFBLogger").MWMediaLogger().tags(["getMostRecentDecodedMediaEntry"]),u=o("MAWIndexedDb").makeMsgrTransactor({media:o("MAWTransactionMode").READONLY},"getMediaEntries",function(t){return function(n){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(t,n).then(function(t){return t?o("WAResultOrError").makeResult(t.mediaEntries):(s.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No existing media entry found for plaintextHash ",". Returning new MsgMap."])),o("WAHashUtils").sanitisePlaintextHash(n)),o("WAResultOrError").makeError("no-media-by-plaintext-hash"))})}});function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield u(e);if(t.success===!1)return t;var n=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(t.value);return n.success===!1?n:o("WAResultOrError").makeResult(n.value[1])}),d.apply(this,arguments)}l.getMediaEntries=u,l.getMostRecentDecodedMediaEntry=c}),98);
__d("MAWGetProtocolMsgIdAndSortOrderMsApi",["MAWIndexedDb","MAWTransactionMode","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"getProtocolMsgIdAndSortOrderMs",function(e){return function(t){return e.messages.get({msgId:t}).then(function(e){if(e==null)return null;var t=e.sortOrderMs;if(t==null||o("WAJids").isAuthorSystem(e.author))return null;var n={author:e.author,chat:e.threadJid,externalId:e.externalId};return{protocolMsgId:n,sortOrderMs:t}})}});l.getProtocolMsgIdAndSortOrderMs=e}),98);
__d("MAWMediaPreviewDownloadManager",["WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e=1e4,s=[],u=new Map;function c(e){if(!u.has(e)){_();var t=new(o("WAResolvable")).Resolvable;u.set(e,t),s.push(e)}}function d(e,t){var n=u.get(e);n!=null&&(n.reject(t),p(e))}function m(e){return u.get(e)}function p(e){u.delete(e)}function _(){if(s.length>=e){var t=s.shift();t!=null&&u.delete(t)}}function f(){s=[],u.clear()}l.markMediaPreviewAsDownloading=c,l.markMediaPreviewAsFailed=d,l.getMediaPreviewDownloadingResolvable=m,l.removeMediaPreviewDownloadingResolvable=p,l.clear=f}),98);
__d("WATypedArraysConcat",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){n===void 0&&(n=0);var r=t.reduce(function(e,t){return e+t.length},n),o=new e(r),a=0;return t.forEach(function(e){o.set(e,a),a+=e.length}),o}i.concatTypedArrays=e}),66);
__d("WACryptoAesCbc",["Promise","WABinary","WACryptoDependencies","WAPromiseDelays","WATypedArraysCast","WATypedArraysConcat","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s=16,u=1024,c=16,d=1024*1024,m=s*d,p=(function(){function e(e,t,n,r){this.$4=null,this.$6=!1,this.$1=e,this.$2=t,this.$3=n;var a={name:"AES-CBC",iv:r};this.$5=o("WACryptoDependencies").getCrypto().subtle.importKey("raw",n,"AES-CBC",!1,[t]).then(function(e){return{algo:a,key:e}})}var t=e.prototype;return t.append=function(t){var e=this;this.$7("append");var n,r=this.$4;if(r)if(r.writeByteArray(t),r.size()>u){var a=r.size()%s;n=r.readByteArrayView(r.size()-a),r.size()||(this.$4=null)}else n=null;else if(t.length>u){var i=t.length%s;i?(this.$4=new(o("WABinary")).Binary(t),n=this.$4.readByteArrayView(t.length-i)):n=t}else this.$4=new(o("WABinary")).Binary(t),n=null;var l=n;return l&&(this.$5=this.$5.then(function(t){var n=t.algo,r=t.key;if(e.$2==="encrypt")return o("WACryptoDependencies").getCrypto().subtle.encrypt(n,r,l).then(function(t){return e.$1.writeByteArray(new Uint8Array(t,0,t.byteLength-s)),new Uint8Array(t,t.byteLength-2*s,s)});var a=l.slice(-s);return o("WACryptoDependencies").getCrypto().subtle.decrypt(n,r,l).then(function(t){return e.$1.writeBuffer(t),a})}).then(function(t){var n={name:"AES-CBC",iv:t};return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",e.$3,"AES-CBC",!1,[e.$2]).then(function(e){return{algo:n,key:e}})})),this.$5.then(function(){})},t.finalize=function(t){var e=this;this.$7("finalize");var n;if(this.$4){var r=this.$4;t&&r.writeByteArray(t),n=r.readByteArrayView(),this.$4=null}else t&&(n=t);if(n){var a=n;return this.$5.then(function(t){var n=t.algo,r=t.key;return e.$2==="encrypt"?o("WACryptoDependencies").getCrypto().subtle.encrypt(n,r,a):o("WACryptoDependencies").getCrypto().subtle.decrypt(n,r,a)}).then(function(t){e.$1.writeBuffer(t)})}else return this.$5.then(function(){})},t.$7=function(t){if(this.$6)throw r("err")("AesCbcStream."+t+" called after finalize")},e})();function _(e){return{name:"AES-CBC",iv:o("WATypedArraysCast").castTypedArrays(Uint8Array,e)}}function f(e){return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",o("WATypedArraysCast").castTypedArrays(Uint8Array,e),"AES-CBC",!1,["encrypt"])}function g(e){if(e)return o("WATypedArraysCast").castTypedArrays(Uint8Array,e);var t=new Uint8Array(c);return o("WACryptoDependencies").getCrypto().getRandomValues(t),t}function h(e){var t=e.byteLength,n=s-t%s;return Number.isNaN(n)?t:t+n}function y(t,r,a){var i=_(r);return(e||(e=n("Promise"))).resolve(o("WACryptoDependencies").getCrypto().subtle.importKey("raw",o("WATypedArraysCast").castTypedArrays(Uint8Array,t),"AES-CBC",!1,["decrypt"])).then(function(e){return o("WACryptoDependencies").getCrypto().subtle.decrypt(i,e,a)})}function C(t,r){return(e||(e=n("Promise"))).resolve().then(function(){var e=r.slice(0,c),n=r.slice(c);return y(t,e,n)})}function b(t,r,a){return(e||(e=n("Promise"))).resolve().then(function(){var i=g(a),l=_(i);return(e||(e=n("Promise"))).resolve(f(t)).then(function(e){return o("WACryptoDependencies").getCrypto().subtle.encrypt(l,e,r)}).then(function(e){return o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[i,new Uint8Array(e)]).buffer})})}function v(e){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.encKey,n=e.plaintext,a=e.optionalIv,i=e.chunkSize,l=i===void 0?m:i,u=e.delayInBetween,c=u===void 0?!1:u;if(l%s!==0)throw r("err")("chunkSize must be a multiple of "+s+", "+l+" received");var d=yield f(t),p=new Uint8Array(n),_=Math.ceil(p.byteLength/l),y=g(a),C=new Uint8Array(h(p)+y.byteLength);C.set(y);for(var b=0,v=y,S;b<_;b++){var L=b===_-1,E=b*l;S=p.subarray(E,E+l);var k=yield R(L,S,v,d),I=k.encryptedChunk,T=k.nextIv;C.set(I,y.byteLength+b*l),v=T,c===!0&&(yield o("WAPromiseDelays").releaseToMainThread())}return C.buffer}),S.apply(this,arguments)}function R(e,t,n,r){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a=yield o("WACryptoDependencies").getCrypto().subtle.encrypt(_(n),r,t).then(function(t){return e?new Uint8Array(t):new Uint8Array(t).subarray(0,-s)}),i=a.slice(-s);return{encryptedChunk:a,nextIv:i}}),L.apply(this,arguments)}l.AES_CBC_BLOCK_SIZE=s,l.AesCbcStream=p,l.importRawKey=f,l.getIv=g,l.aesCbcDecrypt=y,l.aesCbcDecryptSplit=C,l.aesCbcEncrypt=b,l.aesCbcEncryptWithChunking=v,l.aesCbcEncryptChunk=R}),98);
__d("WAConcurrentIterate",["Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(t,r,o){for(var a=[],i=[],l=0,s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){for(;l<t;){var e=l;l++,i[e]=yield r(e)}});return function(){return e.apply(this,arguments)}})(),u=Math.min(t,o),c=0;c<u;c++)a.push(s());return(e||(e=n("Promise"))).all(a).then(function(){return i})}i.concurrentIterate=l}),66);
__d("WAMediaCryptoSidecar",["WAConcurrentIterate","WACryptoHmac","WAMediaUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e==="video"}var s=16,u=10,c=64*1024;function d(e,t,n){n===void 0&&(n=1);var r=t.buffer.byteLength,a=Math.ceil((r-s)/c),i=new Uint8Array(u*a);return o("WAConcurrentIterate").concurrentIterate(a,function(n){var r=n*c,a=r+s+c,l=t.subarray(r,a);return o("WACryptoHmac").sign(e,l).then(function(e){var t=new Uint8Array(e,0,u);i.set(t,n*u)})},n).then(function(){return o("WAMediaUtils").castToStreamingSidecar(i.buffer)})}l.shouldHaveStreamingSidecar=e,l.calculateStreamingSidecar=d}),98);
__d("WAMediaHkdfInfo",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"document":return"WhatsApp Document Keys";case"image":case"sticker":case"xma-image":return"WhatsApp Image Keys";case"video":case"gif":return"WhatsApp Video Keys";case"audio":case"ptt":return"WhatsApp Audio Keys";case"md-app-state":return"WhatsApp App State Keys";case"md-msg-hist":return"WhatsApp History Keys";default:throw r("err")("getMediaHkdfInfo: unexpected media type "+e)}}function s(){return"Messenger Preview Keys"}l.getMediaHkdfInfo=e,l.getPreviewMediaHkdfInfo=s}),98);
__d("WAMediaCrypto",["Promise","WABinary","WACryptoAesCbc","WACryptoDependencies","WACryptoHkdf","WACryptoHmac","WACryptoSha256","WACryptoUtils","WACustomError","WAHashUtils","WAMediaCryptoSidecar","WAMediaHkdfInfo","WATagsLogger","WATypedArraysConcat","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["WAMediaCrypto"]),d=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="HmacValidationError",n}return babelHelpers.inheritsLoose(t,e),t})(o("WACustomError").CustomError),m=new Uint8Array([2,2]);function p(e,t){return o("WACryptoHkdf").extractAndExpand(new Uint8Array(e),t,112).then(function(e){return{iv:new Uint8Array(e,0,16),cipherKey:new Uint8Array(e,16,32),hmacKey:new Uint8Array(e,48,32),refKey:new Uint8Array(e,80,32)}})}function _(e,t){var n=o("WAMediaHkdfInfo").getMediaHkdfInfo(t);return p(e,n)}function f(e){var t=o("WAMediaHkdfInfo").getPreviewMediaHkdfInfo();return p(e,t)}function g(e){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=new Map,r=yield f(e);t.set("preview",r);var o=["document","image","video","audio","md-app-state","md-msg-hist"];return yield(u||(u=n("Promise"))).all(o.map(function(n){return _(e,n).then(function(e){t.set(n,e)})})),t}),h.apply(this,arguments)}function y(e){switch(e){case"image":case"video":return e;default:return null}}var C=16,b=16,v=10,S=64*1024;function R(e,t,n,r,o){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=new(o("WABinary")).Binary;l.ensureCapacity(b+a.byteLength+C+v),l.writeByteArray(t);for(var s=new(o("WACryptoAesCbc")).AesCbcStream(l,"encrypt",e,t),c=0,d=c+S;d<a.byteLength;){var m=a.slice(c,d);yield s.append(new Uint8Array(m)),c=d,d+=S}var p=yield a.slice(c);yield s.finalize(new Uint8Array(p));var _=l.peek(function(e){return e.readByteArrayView()}),f=yield o("WACryptoHmac").encodeKeySha256(r),g=yield o("WACryptoHmac").sign(f,_);l.writeByteArray(new Uint8Array(g,0,v));var h=l.readByteArrayView(),y=h.subarray(b),R=yield(u||(u=n("Promise"))).all([o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",y),o("WAMediaCryptoSidecar").shouldHaveStreamingSidecar(i)?o("WAMediaCryptoSidecar").calculateStreamingSidecar(f,h):void 0]),L=R[0],E=R[1];return{ciphertext:y,ciphertextHash:L,sidecar:E,ivCiphertext:_,ivCiphertextHmac:h}}),L.apply(this,arguments)}function E(e,t,n){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield o("WACryptoHmac").encodeKeySha256(e),a=o("WABinary").Binary.build(t,n).readByteArrayView();return o("WACryptoHmac").sign(r,a)}),k.apply(this,arguments)}function I(e,t,n,r,o){return T.apply(this,arguments)}function T(){return T=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a){if(!(10<=a.length&&a.length<=32))throw new d("Bad hmac size "+a.length);var i=o("WABinary").Binary.build(t,n).readByteArrayView(),l=yield o("WACryptoHmac").hmacSha256(r,i).then(function(e){return new Uint8Array(e)}),s=l.slice(0,a.length);if(!N(s,a))throw new d("hmacAndDecrypt hmac mismatch");var u=yield o("WACryptoAesCbc").aesCbcDecrypt(e,t,n),c=yield o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",u);return{plaintextHash:o("WAHashUtils").toPlaintextHash(c),plaintext:u}}),T.apply(this,arguments)}function D(e,t,n,r,a){if(!(10<=a.length&&a.length<=32))throw new d("Bad hmac size "+a.length);var i=o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[t,n]);return o("WACryptoHmac").hmacSha256(r,i,a.length).then(function(e){return new Uint8Array(e)}).then(function(e){if(!o("WACryptoUtils").uint8ArraysEqual(e,a))throw new d("hmacAndDecrypt hmac mismatch")}).then(function(){var e=n.byteLength%C===v;return e===!0?n.subarray(0,-10):n}).then(function(n){return x(e,t,n)})}function x(e,t,n){var r=n.subarray(-C);return o("WACryptoAesCbc").aesCbcEncrypt(e,m,r).then(function(e){return e.slice(b)}).then(function(e){return o("WABinary").Binary.build(n,e).readByteArrayView()}).then(function(n){return o("WACryptoAesCbc").aesCbcDecrypt(e,t,n)}).then(function(e){return new Uint8Array(e,0,e.byteLength-m.byteLength)}).then(function(e){return{plaintext:e,nextIv:r}})}function $(e,t,n,r,o,a){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l,u){l>u.scanLengths.length&&c.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["decryptPartialChunks targetScan greater length of scanLength array"])));var d=Math.min(l,u.scanLengths.length);if(d<1)throw c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt partial due to invalid target scan"]))),r("err")("Unable to decrypt partial due to invalid target scan");for(var m=new(o("WABinary")).Binary,p=[],_=0;_<d;_++)p.push(new Uint8Array(u.sidecar,_*10,10));for(var f=0,g=n,h=0,y=0;y<d;y++){var C=u.alignedScanLengths[y],b=f+C,v=a.subarray(f,b),S=yield D(t,g,v,i,p[y]),R=S.nextIv,L=S.plaintext;m.write(L),f+=C,g=R,h+=u.scanLengths[y]}var E=m.readBuffer(h),k=yield o("WACryptoSha256").sha256(E);return{plaintextHash:o("WAHashUtils").toPlaintextHash(k),plaintext:E}}),P.apply(this,arguments)}function N(e,t){if(e.length!==t.length)return!1;for(var n=1,r=e.length,o=0;o<r;o++)n&=e[o]===t[o]?1:0;return n!==0}l.HmacValidationError=d,l.DEFAULT_PADDING=m,l.computeMediaKeys=_,l.computeMediaKeysForPreview=f,l.deprecated_getAllCommonComputedMediaKeys=g,l.convertServerMediaTypeToPreviewMediaType=y,l.CBC_BLOCK_SIZE=C,l.IV_LENGTH=b,l.HMAC_LENGTH=v,l.encryptAndHmac=R,l.hmacCiphertext=E,l.hmacAndDecrypt=I,l.hmacAndDecryptPartial=D,l.decryptPartialChunks=$}),98);
__d("WAAlignChunkLengthsToMultipleOfAesBlockSize",[],(function(t,n,r,o,a,i){"use strict";function e(e){return parseInt((e+15)/16,10)*16}function l(t,n){for(var r=[],o=0,a=0,i=0,l=0;l<t.length;++l)if(o+=t[l],l===t.length-1&&n!=null&&n>0){o>a?r.push(n-a):(r.pop(),r.push(n-i));break}else if(o>a){var s=e(o-a);i=a,r.push(s),a+=s}return r}i.alignChunkSizeToMultipleAesBlockSize=e,i.alignChunkLengthsToMultipleOfAesBlockSize=l}),66);
__d("WAProgressiveJpegAlignScanLengths",["WAAlignChunkLengthsToMultipleOfAesBlockSize"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.scanLengths,n=e.totalEncryptedBytes;return o("WAAlignChunkLengthsToMultipleOfAesBlockSize").alignChunkLengthsToMultipleOfAesBlockSize(t.map(function(e){return e}),n).map(function(e){return e})}function s(e){return e}l.progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize=e,l.toProgressiveJpegAlignedScanLength=s}),98);
__d("WAProgressiveJpegGetPJpegDetails",["WAMediaCrypto","WAProgressiveJpegAlignScanLengths","WAProgressiveJpegGetScanLengths","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS(["WAProgressiveJpegDetails"]);function m(e){var t=e.ciphertextLength,n=e.progressiveJpegDetails;return babelHelpers.extends({},n,{alignedScanLengths:o("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:n.scanLengths,totalEncryptedBytes:t})})}function p(e,t,n){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=t.byteLength-o("WAMediaCrypto").IV_LENGTH,a=o("WAProgressiveJpegGetScanLengths").getProgressiveJpegScanLengths(e),i=o("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:a,totalEncryptedBytes:r}),l=yield f(i,t,n);return{scanLengths:a,sidecar:l}}),_.apply(this,arguments)}function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){for(var r=new Uint8Array(e.length*10),a=0,i=0,l=t.slice(0,16),s=t.slice(16),u=0;u<e.length;u++){var c=e[u];i=a+c;var d=s.subarray(a,i),m=(yield o("WAMediaCrypto").hmacCiphertext(n,l,d)).slice(0,10);r.set(new Uint8Array(m),u*10),l=d.slice(d.length-16,d.length),a=i}return r.buffer}),g.apply(this,arguments)}function h(t){return t.sidecar.byteLength%o("WAMediaCrypto").HMAC_LENGTH!==0?(d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar has an invalid length"]))),o("WAResultOrError").makeError("pjpeg-check-sidecar-invalid-length")):t.scanLengths.length>0&&t.sidecar.byteLength===0?(d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar is missing"]))),o("WAResultOrError").makeError("pjpeg-check-no-sidecar")):t.scanLengths.length===0?o("WAResultOrError").makeResult(!1):t.scanLengths.length*o("WAMediaCrypto").HMAC_LENGTH!==t.sidecar.byteLength?(d.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar size mismatch"]))),o("WAResultOrError").makeError("pjpeg-check-scan-length-mismatch")):t.scanLengths.length<3?(d.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg has too few scans"]))),o("WAResultOrError").makeError("pjpeg-too-few-scans")):o("WAResultOrError").makeResult(!0)}function y(e,t){var n=0;if(t===0)return 0;for(var r=0;r<t;r++){var o=e[r];o!=null&&(n+=o)}return n}function C(e){var t=e.progressiveJpegDetails;if(t==null)return o("WAResultOrError").makeResult(null);var n=h(t);return n.success===!1?n:n.value===!0?o("WAResultOrError").makeResult({scanLengths:t.scanLengths,sidecar:t.sidecar}):o("WAResultOrError").makeResult(null)}l.getExtendedProgressiveJpegDetails=m,l.getProgressiveJpegDetails=p,l.isValidProgressiveJpegDetails=h,l.getTotalByteSizeForScan=y,l.maybeGetProgressiveJpegDetailsUsingMediaEntry=C}),98);
__d("WADownloadDownloadablePreview",["WADownloadMedia","WAMediaCrypto","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WADownloadMedia").mediaDownloadLogger.TAGS(["DownloadDownloadablePreview"]);function f(e,t,n,r,o,a,i){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l,f){var g=l.handleMediaPreviewBeforeDownload,h=l.handleMediaPreviewDownloadFailed,y=a.downloadableThumbnail,C=y==null?void 0:y.directPath,b=C!=null,v=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(a);if(_.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["thumbnail_available: ",""])),b),y==null||C==null)return _.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No downloadableThumbnail. Skipping..."]))),o("WAResultOrError").makeError("preview-not-supported");_.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["DownloadableThumbnail exists. Attempting to download."])));var S=y.fileEncSha256,R=y.fileSha256,L=y.mediaKey,E=y.objectId,k=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:t,downloadEntry:i,msgType:null,triggerUIView:f,isPreview:!0});if(k.addAnnotations({bool:{duplicateDirectPath:C===a.directPath,isProgressiveJpeg:v.success===!0,hasObjectId:E!=null},string:{mediaType:"preview",fullSizeMediaType:a.serverMediaType}}),k.addPoint("wa_protocol_media_download_start"),C==null||S==null||R==null||L==null)return _.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - mediaEntryData "," is incomplete for media preview"])),a),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-incomplete-media-entry"}}),o("WAResultOrError").makeError("media-entry-invalid");var I=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(r);if(I==null)return _.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""])),r),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-unsupported-type"}}),o("WAResultOrError").makeError("request-error");yield g(n);var T=yield o("WADownloadMedia").downloadMediaImpl({downloadFlow:k,mediaTypeDetails:{messageType:I,type:"preview"},directPath:C,fileEncSha256:S,fileSha256:R,mediaKey:L});return T.success===!1?(_.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["failed to download media. Reason: ",""])),T.error),h(n,T.error),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:T.error}}),T):(_.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["finished downloading"]))),k.addPoint("wa_protocol_media_download_end"),k.endSuccess(),o("WAResultOrError").makeResult(T.value))}),g.apply(this,arguments)}l.maybeDownloadDownloadablePreview=f}),98);
__d("WADecryptMedia",["WAMediaCrypto","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["WADecryptMedia"]);function f(e,t,n,r){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a){_.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Encountered enc-hash-mismatch - looking for a potential working hmac salt"])));var i=r.type==="preview"?"preview":r.mediaType,l=yield o("WAMediaCrypto").deprecated_getAllCommonComputedMediaKeys(a),d;for(var m of l){var p=m[0],f=m[1];try{if(p===i)continue;_.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Trying "," as an alternative hmac salt."])),p);var g=o("WAResultOrError").makeResult(yield o("WAMediaCrypto").hmacAndDecrypt(f.cipherKey,f.iv,t,f.hmacKey,n));return d={hmacAndDecryptResult:g,alternativeHmacSaltUsed:p},_.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Found a working hmac salt using ","."])),p),d}catch(e){_.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," is not a working hmac salt."])),p);continue}}return{hmacAndDecryptResult:o("WAResultOrError").makeError("enc-hash-mismatch")}}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.ciphertextHmac,n=e.mediaKey,r=e.mediaTypeDetails,a=e.plaintextHash;_.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Using default plaintext verifier"])));var i=t.byteLength-o("WAMediaCrypto").HMAC_LENGTH,l=new Uint8Array(t,i),s=new Uint8Array(t,0,i),u;r.type==="preview"?u=o("WAMediaCrypto").computeMediaKeysForPreview(n):u=o("WAMediaCrypto").computeMediaKeys(n,r.mediaType);var c,g=null;if(c=yield u.then(function(e){var t=e.cipherKey,n=e.hmacKey,r=e.iv;return o("WAMediaCrypto").hmacAndDecrypt(t,r,s,n,l)}).then(o("WAResultOrError").makeResult).catch(function(e){return _.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""])),e),e instanceof o("WAMediaCrypto").HmacValidationError?o("WAResultOrError").makeError("enc-hash-mismatch"):o("WAResultOrError").makeError("decryption-error")}),c.success===!1&&c.error==="enc-hash-mismatch"){var h=yield f(s,l,r,n);c=h.hmacAndDecryptResult,g=h.alternativeHmacSaltUsed}if(!c.success)return c;var y=c.value,C=y.plaintext,b=y.plaintextHash;return a!==b?o("WAResultOrError").makeError("hash-mismatch"):(_.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Success"]))),o("WAResultOrError").makeResult({plaintext:C,alternativeHmacSaltUsed:g}))}),y.apply(this,arguments)}l.decryptMedia=h}),98);
__d("WAArrayUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}function l(e,t){var n=e.pop();t<e.length&&(e[t]=n)}function*s(e,t){for(var n=0;n<e.length;n+=t)yield e.slice(n,n+t)}function u(t,n){return c(t,n,e)}function c(e,t,n){var r=new Map;for(var o of e){var a,i=t(o),l=(a=r.get(i))!=null?a:[];l.push(n(o)),r.set(i,l)}return r}i.removeIndexWithoutPreservingOrder=l,i.peekEvery=s,i.groupBy=u,i.groupByAndMap=c}),66);
__d("WABaseGlobals",["err"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){e=t}function u(){if(e==null)throw r("err")("Trying to access WAGlobals before being set");return e}function c(e){var t=u();t.myJids=e}function d(){var e,t=(e=u().myJids)==null?void 0:e.deviceJid;if(t==null)throw r("err")("Trying to access myDeviceJid, but it's not set");return t}function m(){var e,t=(e=u().myJids)==null?void 0:e.userJid;if(t==null)throw r("err")("Trying to access myUserJid, but it's not set");return t}function p(){return u().jidUtils}function _(){return u().qpl}function f(){return e==null?!1:u().newClockSkewCalculation()}l.setGlobals=s,l.setMyJids=c,l.getMyDeviceJid=d,l.getMyUserJid=m,l.getJidUtilsApi=p,l.getQplConfig=_,l.newClockSkewCalculation=f}),98);
__d("WAErrors",["WACustomError"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="BufferTooLargeError",n}return babelHelpers.inheritsLoose(t,e),t})((e=o("WACustomError")).CustomError),u=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Disconnected",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError),c=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Offline",n}return babelHelpers.inheritsLoose(t,e),t})(u),d=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="MaxRetries",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError),m=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Aborted",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError);l.BufferTooLargeError=s,l.Disconnected=u,l.Offline=c,l.MaxRetries=d,l.Aborted=m}),98);
__d("WANotifyConnectionChangeFactory",[],(function(t,n,r,o,a,i){"use strict";var e=15e3;function l(t,n,r){r===void 0&&(r=e);var o={timeoutID:null,connectionStatus:"disconnected",optimismLevel:"optimist"},a=function(){var e=o.connectionStatus,t=o.optimismLevel;t==="optimist"?o.timeoutID=setTimeout(function(){o.optimismLevel="realist",n(e)},r):n(e)};return function(e){o.connectionStatus=e,e==="disconnected"||e==="in_handshake"?a():(o.timeoutID!=null&&(clearTimeout(o.timeoutID),o.timeoutID=null),n(e)),t(e)}}i.notifyConnectionChangeFactory=l}),66);
__d("WAPromiseRetryLoop",["Promise","WALogger","WAPromiseBackoffs","WAPromiseDelays","WAResolvable","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=(function(){function t(e){var t=this;this.$2=new(o("WAResolvable")).Resolvable,this.$3=null,this.$4=null,this.$5=0,this.$6=new(o("WAResolvable")).Resolvable,this.endWithValue=function(e){t.$5++,t.$2.resolve(e)},this.$1=e}var a=t.prototype;return a.resetTimeoutAfter=function(t){this.$4=Date.now()+t},a.cancelReset=function(){this.$4=null},a.reset=function(){this.$2.resolveWasCalled()||(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: resetting ",""])),this.$1.name),this.$5++,this.$6.resolve(),this.$7())},a.start=function(){this.$2.resolveWasCalled()||(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: starting ",""])),this.$1.name),this.$5!==0&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop was called several times. You may have race conditions"]))),this.$5++,this.$6.resolve(),this.$7())},a.pauseOnNextIteration=function(){o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: pause requested on next iteration"]))),this.$6.resolve(),this.$6=new(o("WAResolvable")).Resolvable},a.unpause=function(){this.$6.resolveWasCalled()||o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: loop unpaused"]))),this.$6.resolve()},a.$7=function(){var e=this,t=this.$1,r=this.$5,a=o("WAPromiseBackoffs").createTimer(this.$1.timer);a();var i=function(){return e.$1.isPauseEnabled!==!0?(f||(f=n("Promise"))).resolve():(e.$6.resolveWasCalled()||o("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: loop paused - waiting for unpause"]))),e.$6.promise)},l=function(){if(!e.$2.resolveWasCalled()&&r===e.$5){var n=Date.now();return e.$3=(0,t.code)(e.endWithValue).then(function(){if(!e.$2.resolveWasCalled()){var r=t.resetDelay;(r!==void 0&&Date.now()>=n+r||e.$4!=null&&e.$4<=Date.now())&&(o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: resetting ",""])),t.name),a=o("WAPromiseBackoffs").createTimer(e.$1.timer)),e.$4=null;var s=a();return o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: retrying "," in ","ms"])),t.name,s),o("WAPromiseDelays").delayMs(s).then(i).then(l)}}),e.$3}};this.$3=(f||(f=n("Promise"))).resolve().then(l)},a.promise=function(){var e=this;return this.$2.resolveWasCalled()?this.$2.promise:this.$3?(f||(f=n("Promise"))).race([this.$2.promise,this.$3.then(function(){return e.$2.promise})]):(f||(f=n("Promise"))).reject(r("err")("PromiseRetryLoop "+this.$1.name+" had promise() called before start()"))},t})();l.PromiseRetryLoop=g}),98);
__d("WASmaxInPingsEnums",["WAJids"],(function(t,n,r,o,a,i,l){var e={validators:[o("WAJids").validateDomainJid,o("WAJids").validateUserJid],typeName:"DomainJid|UserJid"};l.DOMAINJID_USERJID=e}),98);
__d("WADeepEquals",[],(function(t,n,r,o,a,i){"use strict";function e(t,n){if(t===n)return!0;if(!t||!n||typeof t!="object"&&typeof n!="object")return!1;var r=Array.isArray(t),o=Array.isArray(n);if(r!==o)return!1;var a=!0;if(r){var i=t.length;if(i!==n.length)return!1;for(var l=0;a&&l<i;l++)a=e(t[l],n[l]);return a}for(var s=Object.keys(t),u=0;a&&u<s.length;u++){var c=s[u];a=n.propertyIsEnumerable(c)&&e(t[c],n[c])}return a&&Object.keys(n).length===s.length}i.deepEqual=e}),66);
__d("WAWapJid",["$InternalEnum","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e={JID:0,JID_U:1,JID_AD:1,JID_FB:3,JID_INTEROP:4},s=n("$InternalEnum")({WHATSAPP:0,LID:1,HOSTED:128,HOSTED_LID:129}),u=(function(){function t(e){this.$1=e}t.createAD=function(r,o,a){return new t({type:e.JID_AD,user:r,device:a==null?0:a,agent:o==null?0:o,domainType:s.WHATSAPP})},t.createJidU=function(r,o,a){return new t({type:e.JID_U,user:r,device:a==null?0:a,domainType:o==null?s.WHATSAPP:o})},t.createFbJid=function(r,o){var n=o==null?0:o;return new t({type:e.JID_FB,user:r,device:n})},t.createInteropJid=function(r,o,a){var n=o==null?0:o;return new t({type:e.JID_INTEROP,user:r,device:n,integrator:a})},t.create=function(r,o){return new t({type:e.JID,user:r,server:o})};var n=t.prototype;return n.toString=function(){if(this.$1.type===e.JID_AD||this.$1.type===e.JID_U){var t=this.$1,n=t.device,r=t.domainType,a=t.user,i="";return r===s.WHATSAPP?i=o("WAJids").WA_USER_JID_SUFFIX:r===s.HOSTED?i=o("WAJids").HOSTED_SUFFIX:r===s.HOSTED_LID?i=o("WAJids").HOSTED_LID_SUFFIX:i=o("WAJids").LID_SUFFIX,n===0?a+"@"+i:a+":"+n+"@"+i}else if(this.$1.type===e.JID_FB){var l=this.$1,u=l.device,c=l.user,d=o("WAJids").MSGR_USER_JID_SUFFIX;return c+":"+u+"@"+d}else if(this.$1.type===e.JID_INTEROP){var m=this.$1,p=m.device,_=m.integrator,f=m.user,g=o("WAJids").INTEROP_USER_JID_SUFFIX;return _+"-"+f+":"+p+"@"+g}else{this.$1.type;var h=this.$1,y=h.server,C=h.user;return C!=null?C+"@"+y:y}},n.getInnerJid=function(){return this.$1},t})();l.WAP_JID_SUBTYPE=e,l.DomainType=s,l.WapJid=u}),98);
__d("WASmaxParseUtils",["WABase64","WABinary","WACryptoUtils","WADeepEquals","WAHasProperty","WAResultOrError","WAStanzaUtils","WAWapJid","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WAResultOrError").makeResult();function s(t,n){return t.tag!==n?O(t,"to be <"+n+">"):e}function u(e,t){return B(e,t)?W(e,e.attrs[t]):O(e,'to have attribute "'+t+'"')}function c(e,t,n,r){var a=u(e,t);if(!a.success)return a;var i=n(a.value);return i!=null?o("WAResultOrError").makeResult(i):O(e,'to have "'+t+'"={'+r+'}, but instead has "'+a.value+'"')}function d(e,t,n){var r=P(e);if(!r.success)return r;var a=t(r.value);return a!=null?o("WAResultOrError").makeResult(a):O(e,"to have "+n+' content, but instead has "'+r.value+'"')}function m(t,n,r){var o=u(t,n);if(o.success){if(o.value!==r)return O(t,'to have "'+n+'"="'+r+'", but instead has "'+o.value+'"')}else return o;return e}function p(e,t){return c(e,t,o("WAStanzaUtils").toStanzaId,"stanzaID")}function _(e,t){return c(e,t,o("WAStanzaUtils").validateCallId,"callID")}function f(e,t){return c(e,t,q,"integer")}function g(e,t,n,r){var a=f(e,t);if(!a.success)return a;var i=a.value;return n!==void 0&&i<n?O(e,'to have "'+t+'"={at least '+n+"} but has value "+i):r!==void 0&&i>r?O(e,'to have "'+t+'"={at most '+r+"} but has value "+i):o("WAResultOrError").makeResult(i)}function h(e){var t=e.content;return t instanceof Uint8Array?O(e,"to have children"):o("WAResultOrError").makeResult(t)}function y(t,n){var r=h(t);if(!r.success)return r;var a=r.value;if(a==null)return e;for(var i=null,l=0;l<a.length;l++){var s=a[l];if(s.tag===n){if(i!=null)return O(t,"to have 1 child <"+n+">, but found more than 1");i=s}}return o("WAResultOrError").makeResult(i)}function C(t,n,r){var o=y(t,n);return o.success?o.value==null?e:r(o.value):o}function b(e,t,n){var r=C(e,t,n);if(!r.success)return r;var a=r.value;return a==null?O(e,"to have 1 child <"+t+">, but found 0"):o("WAResultOrError").makeResult(a)}function v(e,t){var n=y(e,t);return n.success?n.value==null?O(e,"to have 1 child <"+t+">, but found 0"):o("WAResultOrError").makeResult(n.value):n}function S(e,t,n,r,a){var i=U(e,t,n,r);if(!i.success)return i;for(var l=[],s=0;s<i.value.length;s++){var u=a(i.value[s]);if(!u.success)return u;l.push(u.value)}return o("WAResultOrError").makeResult(l)}function R(e,t,n,r,a){var i=U(e,t,n,r);if(!i.success)return i;for(var l=i.value.length,s=0;s<l;s++){var u=a(i.value[s]);if(!u.success)return u}return o("WAResultOrError").makeResult(l)}function L(e,t,n){var r=S(e,t,0,1/0,n);if(!r.success)return r;for(var a=0;a<r.value.length;a++)if(!o("WADeepEquals").deepEqual(r.value[0],r.value[a]))return O(e,"to have homogeneous children, but found two children that are not equal");return r}function E(e,t,n){var r=L(e,t,n);return r.success?o("WAResultOrError").makeResult(r.value.length):r}function k(t,n,r,o,a){return B(n,r)?t(n,r,o,a):e}function I(t,n,r,a){if(a==null)return e;var i=k(t,n,r);return i.success?i.value===a?o("WAResultOrError").makeResult(a):i.value==null?e:O(n,'to have "'+r+'"={'+a+'}, but instead has "'+i.value+'"'):i}function T(e,t,n,r){var a=e(t,n);return a.success?a.value===r?o("WAResultOrError").makeResult(r):O(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"'):a}function D(e,t,n){var r=e(t);return r.success?r.value===n?o("WAResultOrError").makeResult(n):O(t,'to have content "'+n+'", but instead has "'+r.value+'"'):r}function x(e,t,n){var r=u(e,t);if(!r.success)return r;var a=n[r.value];if(a!=null)return o("WAResultOrError").makeResult(a);var i=Object.values(n).join("|");return O(e,'to have "'+t+'"={'+i+'}, but instead has "'+r.value+'"')}function $(e,t){var n=P(e);if(!n.success)return n;var r=t[n.value];if(r!=null)return o("WAResultOrError").makeResult(r);var a=Object.values(t).join("|");return O(e,'to have content "'+a+'", but instead has "'+n.value+'"')}function P(e){var t=N(e);if(t.success)try{var n=new(o("WABinary")).Binary(t.value),a=n.readString(n.size());return o("WAResultOrError").makeResult(a)}catch(t){return O(e,"to have string content, but run into decoding error: "+r("getErrorSafe")(t).message)}else return t}function N(e){var t=e.content;return t==null?O(e,"to have content"):Array.isArray(t)?O(e,"to have content, but has children instead"):o("WAResultOrError").makeResult(t)}function M(e,t){var n=N(e);return n.success?o("WACryptoUtils").uint8ArraysEqual(n.value,t)?o("WAResultOrError").makeResult(t):O(e,'to have content ":binary:'+o("WABase64").encodeB64(t)+'", but instead has ":binary:'+o("WABase64").encodeB64(n.value)+'"'):n}function w(e,t,n){var r=e.content;if(r==null)return t===void 0||t<1?o("WAResultOrError").makeResult(new Uint8Array([])):O(e,"to have content");if(Array.isArray(r))return O(e,"to have content, but has children instead");var a=r.length;return t!==void 0&&a<t?O(e,"to have binary content at least "+t+" bytes but has "+a+" bytes"):n!==void 0&&a>n?O(e,"to have binary content at most "+n+" bytes but has "+a+" bytes"):o("WAResultOrError").makeResult(r)}function A(e){return d(e,q,"integer")}function F(e){return e}function O(e,t){return o("WAResultOrError").makeError("expected <"+e.tag+">: "+t)}function B(e,t){return r("WAHasProperty")(e.attrs,t)}function W(e,t){return t instanceof o("WAWapJid").WapJid?o("WAResultOrError").makeResult(t.toString()):typeof t=="string"?o("WAResultOrError").makeResult(t):O(e,"decodeAsString: attribute is "+typeof t+" not a string: "+String(t))}function q(e){var t=parseInt(e,10);return Number.isNaN(t)?null:t}function U(e,t,n,r){var a=h(e);if(!a.success)return a;var i=a.value;if(i==null)return n!==0?O(e,"to have at least "+n+" <"+t+"> children, but found 0"):o("WAResultOrError").makeResult([]);for(var l=[],s=0;s<i.length;s++){var u=i[s];u.tag===t&&l.push(u)}var c=l.length;return c<n?O(e,"to have at least "+n+" <"+t+"> children, but found "+c):c>r?O(e,"to have at most "+r+" <"+t+"> children, but found "+c):o("WAResultOrError").makeResult(l)}var V={};function H(e,t,n){var r=t.map(function(e,t){return e+": "+n[t].error});return O(e,["to match any of following mixins: "+t.join(", ")+", but all mixins failed."].concat(r).join(" "))}l.voidSuccess=e,l.assertTag=s,l.attrString=u,l.attrValidate=c,l.contentValidate=d,l.assertAttr=m,l.attrStanzaId=p,l.attrCallId=_,l.attrInt=f,l.attrIntRange=g,l.maybeChildren=h,l.optionalChild=y,l.optionalChildWithTag=C,l.childWithTag=b,l.flattenedChildWithTag=v,l.mapChildrenWithTag=S,l.countChildrenWithTag=R,l.mapHomogeneousChildrenWithTag=L,l.countHomogeneousChildrenWithTag=E,l.optional=k,l.optionalLiteral=I,l.literal=T,l.literalContent=D,l.attrStringEnum=x,l.contentStringEnum=$,l.contentString=P,l.contentBytes=N,l.contentLiteralBytes=M,l.contentBytesRange=w,l.contentInt=A,l.identity=F,l.errorMessage=O,l.emptyObject=V,l.errorMixinDisjunction=H}),98);
__d("WASmaxParseJid",["WAJids","WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateUserJid,"UserJid")}function s(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateLidUserJid,"LidUserJid")}function u(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateDeviceJid,"DeviceJid")}function c(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateGroupJid,"GroupJid")}function d(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateCallJid,"CallJid")}function m(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateDomainJid,"DomainJid")}function p(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateBroadcastJid,"BroadcastJid")}function _(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateStatusJid,"StatusJid")}function f(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateNewsletterJid,"NewsletterJid")}function g(e,t,n){var r=o("WASmaxParseUtils").attrString(e,t);if(!r.success)return r;for(var a=n.typeName,i=n.validators,l=0;l<i.length;l++){var s=i[l](r.value);if(s!=null)return o("WAResultOrError").makeResult(s)}return o("WASmaxParseUtils").errorMessage(e,'to have "'+t+'"={'+a+'}, but instead has "'+r.value+'"')}function h(e,t,n,r){var a=e(t,n);return!a.success||a.value===r?a:o("WASmaxParseUtils").errorMessage(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"')}function y(e,t,n,r){var a=o("WASmaxParseUtils").optional(e,t,n);return!a.success||a.value==null||a.value===r?a:o("WASmaxParseUtils").errorMessage(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"')}l.attrUserJid=e,l.attrLidUserJid=s,l.attrDeviceJid=u,l.attrGroupJid=c,l.attrCallJid=d,l.attrDomainJid=m,l.attrBroadcastJid=p,l.attrStatusJid=_,l.attrNewsletterJid=f,l.attrJidEnum=g,l.literalJid=h,l.optionalLiteralJid=y}),98);
__d("WASmaxParseReference",["WAHasProperty","WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,o){var a=m(t,n);if(!a.success)return _(a);var i=e(a.value,n[n.length-1],r,o);return i.success?i:_(i)}function s(t,n,r,a,i){return p(n,r)?e(t,n,r,a,i):o("WASmaxParseUtils").voidSuccess}function u(t,n){return e(o("WASmaxParseUtils").attrString,t,n)}function c(e,t){return p(e,t)?u(e,t):o("WASmaxParseUtils").voidSuccess}function d(e,t){var n=m(e,t);if(!n.success)return _(n);var r=o("WASmaxParseUtils").contentString(n.value);return r.success?r:_(r)}function m(e,t){for(var n=t.length,r=e,a=0;a<n-1;a++){var i=t[a],l=o("WASmaxParseUtils").flattenedChildWithTag(r,i);if(!l.success)return l;r=l.value}return o("WAResultOrError").makeResult(r)}function p(e,t){var n=m(e,t);return n.success&&r("WAHasProperty")(n.value.attrs,t[t.length-1])}function _(e){return o("WAResultOrError").makeError("in the reference, "+e.error)}l.attrFromReference=e,l.optionalAttrFromReference=s,l.attrStringFromReference=u,l.optionalAttrStringFromReference=c,l.contentStringFromReference=d}),98);
__d("WASmaxInPingsClientResponseServerResponse",["WAResultOrError","WASmaxInPingsEnums","WASmaxParseJid","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseJid").attrJidEnum(e,"from",o("WASmaxInPingsEnums").DOMAINJID_USERJID);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","result");if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").attrInt(e,"t");return s.success?o("WAResultOrError").makeResult({from:r.value,type:a.value,t:s.value}):s}l.parseClientResponseServerResponse=e}),98);
__d("WAWapDict",[],(function(t,n,r,o,a,i){"use strict";var e=3,l=["xmlstreamstart","xmlstreamend","s.whatsapp.net","type","participant","from","receipt","id","notification","disappearing_mode","status","jid","broadcast","user","devices","device_hash","to","offline","message","result","class","xmlns","duration","notify","iq","t","ack","g.us","enc","urn:xmpp:whatsapp:push","presence","config_value","picture","verified_name","config_code","key-index-list","contact","mediatype","routing_info","edge_routing","get","read","urn:xmpp:ping","fallback_hostname","0","chatstate","business_hours_config","unavailable","download_buckets","skmsg","verified_level","composing","handshake","device-list","media","text","fallback_ip4","media_conn","device","creation","location","config","item","fallback_ip6","count","w:profile:picture","image","business","2","hostname","call-creator","display_name","relaylatency","platform","abprops","success","msg","offline_preview","prop","key-index","v","day_of_week","pkmsg","version","1","ping","w:p","download","video","set","specific_hours","props","primary","unknown","hash","commerce_experience","last","subscribe","max_buckets","call","profile","member_since_text","close_time","call-id","sticker","mode","participants","value","query","profile_options","open_time","code","list","host","ts","contacts","upload","lid","preview","update","usync","w:stats","delivery","auth_ttl","context","fail","cart_enabled","appdata","category","atn","direct_connection","decrypt-fail","relay_id","mmg-fallback.whatsapp.net","target","available","name","last_id","mmg.whatsapp.net","categories","401","is_new","index","tctoken","ip4","token_id","latency","recipient","edit","ip6","add","thumbnail-document","26","paused","true","identity","stream:error","key","sidelist","background","audio","3","thumbnail-image","biz-cover-photo","cat","gcm","thumbnail-video","error","auth","deny","serial","in","registration","thumbnail-link","remove","00","gif","thumbnail-gif","tag","capability","multicast","item-not-found","description","business_hours","config_expo_key","md-app-state","expiration","fallback","ttl","300","md-msg-hist","device_orientation","out","w:m","open_24h","side_list","token","inactive","01","document","te2","played","encrypt","msgr","hide","direct_path","12","state","not-authorized","url","terminate","signature","status-revoke-delay","02","te","linked_accounts","trusted_contact","timezone","ptt","kyc-id","privacy_token","readreceipts","appointment_only","address","expected_ts","privacy","7","android","interactive","device-identity","enabled","attribute_padding","1080","03","screen_height"],s=["read-self","active","fbns","protocol","reaction","screen_width","heartbeat","deviceid","2:47DEQpj8","uploadfieldstat","voip_settings","retry","priority","longitude","conflict","false","ig_professional","replaced","preaccept","cover_photo","uncompressed","encopt","ppic","04","passive","status-revoke-drop","keygen","540","offer","rate","opus","latitude","w:gp2","ver","4","business_profile","medium","sender","prev_v_id","email","website","invited","sign_credential","05","transport","skey","reason","peer_abtest_bucket","America/Sao_Paulo","appid","refresh","100","06","404","101","104","107","102","109","103","member_add_mode","105","transaction-id","110","106","outgoing","108","111","tokens","followers","ig_handle","self_pid","tue","dec","thu","joinable","peer_pid","mon","features","wed","peer_device_presence","pn","delete","07","fri","audio_duration","admin","connected","delta","rcat","disable","collection","08","480","sat","phash","all","invite","accept","critical_unblock_low","group_update","signed_credential","blinded_credential","eph_setting","net","09","background_location","refresh_id","Asia/Kolkata","privacy_mode_ts","account_sync","voip_payload_type","service_areas","acs_public_key","v_id","0a","fallback_class","relay","actual_actors","metadata","w:biz","5","connected-limit","notice","0b","host_storage","fb_page","subject","privatestats","invis","groupadd","010","note.m4r","uuid","0c","8000","sun","372","1020","stage","1200","720","canonical","fb","011","video_duration","0d","1140","superadmin","012","Opening.m4r","keystore_attestation","dleq_proof","013","timestamp","ab_key","w:sync:app:state","0e","vertical","600","p_v_id","6","likes","014","500","1260","creator","0f","rte","destination","group","group_info","syncd_anti_tampering_fatal_exception_enabled","015","dl_bw","Asia/Jakarta","vp8/h.264","online","1320","fb:multiway","10","timeout","016","nse_retry","urn:xmpp:whatsapp:dirty","017","a_v_id","web_shops_chat_header_button_enabled","nse_call","inactive-upgrade","none","web","groups","2250","mms_hot_content_timespan_in_seconds","contact_blacklist","nse_read","suspended_group_deletion_notification","binary_version","018","https://www.whatsapp.com/otp/copy/","reg_push","shops_hide_catalog_attachment_entrypoint","server_sync",".","ephemeral_messages_allowed_values","019","mms_vcache_aggregation_enabled","iphone","America/Argentina/Buenos_Aires","01a","mms_vcard_autodownload_size_kb","nse_ver","shops_header_dropdown_menu_item","dhash","catalog_status","communities_mvp_new_iqs_serverprop","blocklist","default","11","ephemeral_messages_enabled","01b","original_dimensions","8","mms4_media_retry_notification_encryption_enabled","mms4_server_error_receipt_encryption_enabled","original_image_url","sync","multiway","420","companion_enc_static","shops_profile_drawer_entrypoint","01c","vcard_as_document_size_kb","status_video_max_duration","request_image_url","01d","regular_high","s_t","abt","share_ext_min_preliminary_image_quality","01e","32","syncd_key_rotation_enabled","data_namespace","md_downgrade_read_receipts2","patch","polltype","ephemeral_messages_setting","userrate","15","partial_pjpeg_bw_threshold","played-self","catalog_exists","01f","mute_v2"],u=["reject","dirty","announcement","020","13","9","status_video_max_bitrate","fb:thrift_iq","offline_batch","022","full","ctwa_first_business_reply_logging","h.264","smax_id","group_description_length","https://www.whatsapp.com/otp/code","status_image_max_edge","smb_upsell_business_profile_enabled","021","web_upgrade_to_md_modal","14","023","s_o","smaller_video_thumbs_status_enabled","media_max_autodownload","960","blocking_status","peer_msg","joinable_group_call_client_version","group_call_video_maximization_enabled","return_snapshot","high","America/Mexico_City","entry_point_block_logging_enabled","pop","024","1050","16","1380","one_tap_calling_in_group_chat_size","regular_low","inline_joinable_education_enabled","hq_image_max_edge","locked","America/Bogota","smb_biztools_deeplink_enabled","status_image_quality","1088","025","payments_upi_intent_transaction_limit","voip","w:g2","027","md_pin_chat_enabled","026","multi_scan_pjpeg_download_enabled","shops_product_grid","transaction_id","ctwa_context_enabled","20","fna","hq_image_quality","alt_jpeg_doc_detection_quality","group_call_max_participants","pkey","America/Belem","image_max_kbytes","web_cart_v1_1_order_message_changes_enabled","ctwa_context_enterprise_enabled","urn:xmpp:whatsapp:account","840","Asia/Kuala_Lumpur","max_participants","video_remux_after_repair_enabled","stella_addressbook_restriction_type","660","900","780","context_menu_ios13_enabled","mute-state","ref","payments_request_messages","029","frskmsg","vcard_max_size_kb","sample_buffer_gif_player_enabled","match_last_seen","510","4983","video_max_bitrate","028","w:comms:chat","17","frequently_forwarded_max","groups_privacy_blacklist","Asia/Karachi","02a","web_download_document_thumb_mms_enabled","02b","hist_sync","biz_block_reasons_version","1024","18","web_is_direct_connection_for_plm_transparent","view_once_write","file_max_size","paid_convo_id","online_privacy_setting","video_max_edge","view_once_read","enhanced_storage_management","multi_scan_pjpeg_encoding_enabled","ctwa_context_forward_enabled","video_transcode_downgrade_enable","template_doc_mime_types","hq_image_bw_threshold","30","body","u_aud_limit_sil_restarts_ctrl","other","participating","w:biz:directory","1110","vp8","4018","meta","doc_detection_image_max_edge","image_quality","1170","02c","smb_upsell_chat_banner_enabled","key_expiry_time_second","pid","stella_interop_enabled","19","linked_device_max_count","md_device_sync_enabled","02d","02e","360","enhanced_block_enabled","ephemeral_icon_in_forwarding","paid_convo_status","gif_provider","project_name","server-error","canonical_url_validation_enabled","wallpapers_v2","syncd_clear_chat_delete_chat_enabled","medianotify","02f","shops_required_tos_version","vote","reset_skey_on_id_change","030","image_max_edge","multicast_limit_global","ul_bw","21","25","5000","poll","570","22","031","1280","WhatsApp","032","bloks_shops_enabled","50","upload_host_switching_enabled","web_ctwa_context_compose_enabled","ptt_forwarded_features_enabled","unblocked","partial_pjpeg_enabled","fbid:devices","height","ephemeral_group_query_ts","group_join_permissions","order","033","alt_jpeg_status_quality","migrate","popular-bank","win_uwp_deprecation_killswitch_enabled","web_download_status_thumb_mms_enabled","blocking","url_text","035","web_forwarding_limit_to_groups","1600","val","1000","syncd_msg_date_enabled","bank-ref-id","max_subject","payments_web_enabled","web_upload_document_thumb_mms_enabled","size","request","ephemeral","24","receipt_agg","ptt_remember_play_position","sampling_weight","enc_rekey","mute_always","037","034","23","036","action","click_to_chat_qr_enabled","width","disabled","038","md_blocklist_v2","played_self_enabled","web_buttons_message_enabled","flow_id","clear","450","fbid:thread","bloks_session_state","America/Lima","attachment_picker_refresh","download_host_switching_enabled","1792","u_aud_limit_sil_restarts_test2","custom_urls","device_fanout","optimistic_upload","2000","key_cipher_suite","web_smb_upsell_in_biz_profile_enabled","e","039","siri_post_status_shortcut","pair-device","lg","lc","stream_attribution_url","model","mspjpeg_phash_gen","catalog_send_all","new_multi_vcards_ui","share_biz_vcard_enabled","-","clean","200","md_blocklist_v2_server","03b","03a","web_md_migration_experience","ptt_conversation_waveform","u_aud_limit_sil_restarts_test1"],c=["64","ptt_playback_speed_enabled","web_product_list_message_enabled","paid_convo_ts","27","manufacturer","psp-routing","grp_uii_cleanup","ptt_draft_enabled","03c","business_initiated","web_catalog_products_onoff","web_upload_link_thumb_mms_enabled","03e","mediaretry","35","hfm_string_changes","28","America/Fortaleza","max_keys","md_mhfs_days","streaming_upload_chunk_size","5541","040","03d","2675","03f","...","512","mute","48","041","alt_jpeg_quality","60","042","md_smb_quick_reply","5183","c","1343","40","1230","043","044","mms_cat_v1_forward_hot_override_enabled","user_notice","ptt_waveform_send","047","Asia/Calcutta","250","md_privacy_v2","31","29","128","md_messaging_enabled","046","crypto","690","045","enc_iv","75","failure","ptt_oot_playback","AIzaSyDR5yfaG7OG8sMTUj8kfQEb8T9pN8BM6Lk","w","048","2201","web_large_files_ui","Asia/Makassar","812","status_collapse_muted","1334","257","2HP4dm","049","patches","1290","43cY6T","America/Caracas","web_sticker_maker","campaign","ptt_pausable_enabled","33","42","attestation","biz","04b","query_linked","s","125","04a","810","availability","1411","responsiveness_v2_m1","catalog_not_created","34","America/Santiago","1465","enc_p","04d","status_info","04f","key_version","..","04c","04e","md_group_notification","1598","1215","web_cart_enabled","37","630","1920","2394","-1","vcard","38","elapsed","36","828","peer","pricing_category","1245","invalid","stella_ios_enabled","2687","45","1528","39","u_is_redial_audio_1104_ctrl","1025","1455","58","2524","2603","054","bsp_system_message_enabled","web_pip_redesign","051","verify_apps","1974","1272","1322","1755","052","70","050","1063","1135","1361","80","1096","1828","1851","1251","1921","key_config_id","1254","1566","1252","2525","critical_block","1669","max_available","w:auth:backup:token","product","2530","870","1022","participant_uuid","web_cart_on_off","1255","1432","1867","41","1415","1440","240","1204","1608","1690","1846","1483","1687","1749","69","url_number","053","1325","1040","365","59","Asia/Riyadh","1177","test_recommended","057","1612","43","1061","1518","1635","055","1034","1375","750","1430","event_code","1682","503","55","865","78","1309","1365","44","America/Guayaquil","535","LIMITED","1377","1613","1420","1599","1822","05a","1681","password","1111","1214","1376","1478","47","1082","4282","Europe/Istanbul","1307","46","058","1124","256","rate-overlimit","retail","u_a_socket_err_fix_succ_test","1292","1370","1388","520","861","psa","regular","1181","1766","05b","1183","1213","1304","1537"],d=["1724","profile_picture","1071","1314","1605","407","990","1710","746","pricing_model","056","059","061","1119","6027","65","877","1607","05d","917","seen","1516","49","470","973","1037","1350","1394","1480","1796","keys","794","1536","1594","2378","1333","1524","1825","116","309","52","808","827","909","495","1660","361","957","google","1357","1565","1967","996","1775","586","736","1052","1670","bank","177","1416","2194","2222","1454","1839","1275","53","997","1629","6028","smba","1378","1410","05c","1849","727","create","1559","536","1106","1310","1944","670","1297","1316","1762","en","1148","1295","1551","1853","1890","1208","1784","7200","05f","178","1283","1332","381","643","1056","1238","2024","2387","179","981","1547","1705","05e","290","903","1069","1285","2436","062","251","560","582","719","56","1700","2321","325","448","613","777","791","51","488","902","Asia/Almaty","is_hidden","1398","1527","1893","1999","2367","2642","237","busy","065","067","233","590","993","1511","54","723","860","363","487","522","605","995","1321","1691","1865","2447","2462","NON_TRANSACTIONAL","433","871","432","1004","1207","2032","2050","2379","2446","279","636","703","904","248","370","691","700","1068","1655","2334","060","063","364","533","534","567","1191","1210","1473","1827","069","701","2531","514","prev_dhash","064","496","790","1046","1139","1505","1521","1108","207","544","637","final","1173","1293","1694","1939","1951","1993","2353","2515","504","601","857","modify","spam_request","p_121_aa_1101_test4","866","1427","1502","1638","1744","2153","068","382","725","1704","1864","1990","2003","Asia/Dubai","508","531","1387","1474","1632","2307","2386","819","2014","066","387","1468","1706","2186","2261","471","728","1147","1372","1961"],m=[s,u,c,d];i.DICT_VERSION=e,i.SINGLE_BYTE_TOKEN=l,i.DICTIONARY_0_TOKEN=s,i.DICTIONARY_1_TOKEN=u,i.DICTIONARY_2_TOKEN=c,i.DICTIONARY_3_TOKEN=d,i.DICTIONARIES=m}),66);
__d("WAXmlFormatter",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=e.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns:/g,"~::~xmlns:").replace(/\s*xmlns=/g,"~::~xmlns=").split("~::~"),n=t.length,r=!1,o=0,a="",i=0,s=["\n"];for(i=0;i<100;i++)s.push(s[i]+"    ");var u=function(t,n){var e=/^<[\w:\-.,]+/.exec(t[n-1]),r=/^<\/[\w:\-.,]+/.exec(t[n]);return e!=null&&r!=null&&e[0]===r[0]};for(i=0;i<n;i++)t[i].search(/<!/)>-1?(a+=s[o]+t[i],r=!0,(t[i].search(/-->/)>-1||t[i].search(/\]>/)>-1||t[i].search(/!DOCTYPE/)>-1)&&(r=!1)):t[i].search(/-->/)>-1||t[i].search(/\]>/)>-1?(a+=t[i],r=!1):u(t,i)?(a+=t[i],r||o--):t[i].search(/<\w/)>-1&&t[i].search(/<\//)===-1&&t[i].search(/\/>/)===-1?(t[i]=l(t[i]),a=r?a+=t[i]:a+=s[o++]+t[i]):t[i].search(/<\w/)>-1&&t[i].search(/<\//)>-1?a=r?a+=t[i]:a+=s[o]+t[i]:t[i].search(/<\//)>-1?a=r?a+=t[i]:a+=s[o===0?o:--o]+t[i]:t[i].search(/\/>/)>-1?a=r?a+=t[i]:a+=s[o]+t[i]:t[i].search(/<\?/)>-1||t[i].search(/xmlns:/)>-1||t[i].search(/xmlns=/)>-1?a+=s[o]+t[i]:a+=t[i];return a[0]==="\n"?a.slice(1):a}function l(e){var t=e.match(/(<query.*>|<result>)(\{.*\})/);if(t===null)return e;try{var n=t[1],r=JSON.stringify(JSON.parse(t[2]),null,2);return n+"\n"+r}catch(t){return e+"[Error formatting JSON]"}}i.default=e}),66);
__d("WAXmlNode",["WAHex"],(function(t,n,r,o,a,i,l){"use strict";var e={},s=(function(){function t(t,n,r){n===void 0&&(n=e),r===void 0&&(r=null),this.tag=t,this.attrs=n,this.content=r}var n=t.prototype;return n.toString=function(){var e="<"+this.tag;e+=u(this.attrs);var t=this.content;return Array.isArray(t)?e+=">"+t.map(String).join("")+"</"+this.tag+">":t instanceof Uint8Array?e+=">"+c(t)+"</"+this.tag+">":t!=null?e+=">"+String(t)+"</"+this.tag+">":e+=" />",e},t})();function u(e){for(var t=Object.keys(e),n="",r=0;r<t.length;r++){var o=t[r];n+=" "+o+'="'+e[o].toString()+'"'}return n}function c(e){var t="";return e.length===0?t="<!-- empty binary -->":e.length<50?t=o("WAHex").bytesToDebugString(e):t="<!-- "+e.length+" bytes -->",t}l.XmlNode=s,l.attrsToString=u,l.uint8ArrayToDebugString=c}),98);
__d("WAWap",["WAAssertUnreachable","WABinary","WACryptoDependencies","WAJids","WALogger","WALongInt","WATextEncoding","WAWapDict","WAWapJid","WAXmlFormatter","WAXmlNode","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=(s=o("WAJids")).MSGR_USER_DOMAIN.replace("@",""),d=s.WA_USER_DOMAIN.replace("@",""),m=s.LID_DOMAIN.replace("@",""),p=s.INTEROP_DOMAIN.replace("@",""),_=s.HOSTED_DOMAIN.replace("@",""),f=2,g=128,h=0,y=236,C=237,b=238,v=239,S=[y,C,b,v],R=245,L=246,E=247,k=248,I=249,T=250,D=251,x=252,$=253,P=254,N=255,M=["0","1","2","3","4","5","6","7","8","9","-",".","\uFFFD","\uFFFD","\uFFFD","\uFFFD"],w=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],A="",F=1,O={sentinel:"DROP_ATTR"},B=(u=o("WAWapJid")).WapJid.create(null,"g.us"),W=u.WapJid.create(null,s.WA_SERVER_JID_SUFFIX),q=u.WapJid.create("status","broadcast"),U=u.WapJid.create(null,"newsletter"),V=u.WapJid.create(null,"hosted"),H=u.WapJid.create(null,"hosted.lid"),G=u.WapJid.create(null,"call"),z={},j=!1;function K(){j=!0}var Q=o("WATextEncoding").newTextEncoder(),X=(function(){function e(e,t,n){t===void 0&&(t=z),n===void 0&&(n=null),this.tag=e,this.attrs=t,this.content=n}var t=e.prototype;return t.toString=function(){var e="<"+this.tag;e+=o("WAXmlNode").attrsToString(this.attrs);var t=this.content;return Array.isArray(t)?e+=">"+t.map(String).join("")+"</"+this.tag+">":t?e+=">"+o("WAXmlNode").uint8ArrayToDebugString(t)+"</"+this.tag+">":e+=" />",j&&(e=r("WAXmlFormatter")(e)),e},e})();function Y(e,t,n){var a=null;if(t&&t.children!=null)throw r("err")('Children should not be passed via props (see eslint check "react/no-children-props")');if(Array.isArray(n))a=n.filter(Boolean);else if(typeof n=="string")a=o("WABinary").Binary.build(n).readByteArrayView();else if(n instanceof ArrayBuffer)a=new Uint8Array(n);else if(n instanceof Uint8Array)a=n;else{for(var i=[],l=2;l<arguments.length;l++){var s=arguments[l];s&&i.push(s)}a=i}Array.isArray(a)&&a.length===0&&(a=null);var u={};if(t){var c=t;Object.keys(c).forEach(function(t){if(!["__self","__source"].includes(t)){var n=c[t];if(n==null)throw r("err")("Attr "+t+" in <"+e+"> is null");n!==O&&(u[t]=n)}})}return new X(e,u,a)}var J=Y;function Z(e){return e instanceof o("WAWapJid").WapJid?e.toString():e}function ee(e){var t=e.content;return Array.isArray(t)?t=t.map(ee):typeof t=="string"&&(t=o("WABinary").Binary.build(t).readByteArrayView()),new X(e.tag,e.attrs||z,t)}function te(e){var t=e instanceof X?e:ee(e),n=new(o("WABinary")).Binary;ne(t,n);var r=0,a=n.readByteArrayView(),i=new Uint8Array(1+a.length);return i[0]=r,i.set(a,1),i}function ne(e,t){if(e==null)t.writeUint8(h);else if(e instanceof X)oe(e,t);else if(e instanceof o("WAWapJid").WapJid)re(e,t);else if(typeof e=="string")se(e,t);else if(e instanceof Uint8Array)ce(e,t);else{var n=typeof e;throw r("err")("Invalid payload type "+n)}}function re(e,t){var n=e.getInnerJid();if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_U){var r=n.device,a=n.domainType,i=n.user;t.writeUint8(E),t.writeUint8(a),t.writeUint8(r),ne(i,t)}else if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_FB){var l=n.device,s=n.user;t.writeUint8(L),ne(s,t),t.writeUint16(l),ne(c,t)}else if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_INTEROP){var u=n.device,d=n.integrator,m=n.user;t.writeUint8(R),ne(m,t),t.writeUint16(u),t.writeUint16(d)}else{var p=n.server,_=n.user;t.writeUint8(T),_!=null?ne(_,t):t.writeUint8(h),ne(p,t)}}function oe(e,t){if(e.tag===void 0){t.writeUint8(k),t.writeUint8(h);return}var n=1;e.attrs&&(n+=Object.keys(e.attrs).length*2),e.content&&n++,n<256?(t.writeUint8(k),t.writeUint8(n)):n<65536&&(t.writeUint8(I),t.writeUint16(n)),ne(e.tag,t),e.attrs&&Object.keys(e.attrs).forEach(function(n){se(n,t),ne(e.attrs[n],t)});var r=e.content;if(Array.isArray(r)){r.length<256?(t.writeUint8(k),t.writeUint8(r.length)):r.length<65536&&(t.writeUint8(I),t.writeUint16(r.length));for(var o=0;o<r.length;o++)oe(r[o],t)}else r&&ne(r,t)}var ae,ie;function le(e){for(var t=new Map,n=0;n<e.length;n++)t.set(e[n],n);return t}function se(e,t){if(e===""){t.writeUint8(x),t.writeUint8(0);return}ae==null&&(ae=le(o("WAWapDict").SINGLE_BYTE_TOKEN));var n=ae.get(e);if(n!=null){t.writeUint8(n+1);return}if(ie==null){ie=[];for(var r=0;r<o("WAWapDict").DICTIONARIES.length;++r)ie.push(le(o("WAWapDict").DICTIONARIES[r]))}for(var a=0;a<ie.length;++a){var i=ie[a].get(e);if(i!=null){t.writeUint8(S[a]),t.writeUint8(i);return}}var l=o("WABinary").numUtf8Bytes(e);if(l<128){var s=/[^0-9.-]+?/,u=/[^0-9A-F]+?/;if(s.exec(e)){if(!u.exec(e)){ue(e,D,t);return}}else{ue(e,N,t);return}}de(l,t),t.writeString(e)}function ue(e,t,n){var o=e.length%2===1;n.writeUint8(t);var a=Math.ceil(e.length/2);o&&(a|=g),n.writeUint8(a);for(var i=0,l=0;l<e.length;l++){var s=e.charCodeAt(l),u=null;if(48<=s&&s<=57?u=s-48:t===N?s===45?u=10:s===46&&(u=11):t===D&&65<=s&&s<=70&&(u=s-55),u==null)throw r("err")("Cannot nibble encode "+s);l%2===0?(i=u<<4,l===e.length-1&&(i|=15,n.writeUint8(i))):(i|=u,n.writeUint8(i))}}function ce(e,t){de(e.length,t),t.writeByteArray(e)}function de(e,t){if(e<256)t.writeUint8(x),t.writeUint8(e);else if(e<1048576)t.writeUint8($),t.writeUint8(e>>>16&255),t.writeUint8(e>>>8&255),t.writeUint8(e&255);else if(e<4294967296)t.writeUint8(P),t.writeUint32(e);else throw r("err")("Binary with length "+e+" is too big for WAP protocol")}function me(t,n){var r=new(o("WABinary")).Binary(t),a=r.readUint8(),i=a&f;return i?(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Decoding compressed stanza"]))),n(r.readByteArrayView()).then(function(e){return ge(new(o("WABinary")).Binary(e))})):Promise.resolve(ge(r))}function pe(e){var t=new(o("WABinary")).Binary(e),n=t.readUint8(),a=n&f;if(a)throw r("err")("Cannot pass compressed stanza to decodeStanzaDebug");return ge(t)}function _e(e,t){var n=e.readUint8();if(n===h)return null;if(n===k)return fe(e,e.readUint8());if(n===I)return fe(e,e.readUint16());if(n===x){var a=e.readUint8();return Re(e,a,t)}if(n===$){var i=e.readUint8(),l=e.readUint8(),s=e.readUint8(),u=((i&15)<<16)+(l<<8)+s;return Re(e,u,t)}if(n===P){var c=e.readUint32();return Re(e,c,t)}if(n===T)return Ce(e);if(n===L)return be(e);if(n===R)return ve(e);if(n===E)return Se(e);if(n===N){var d=e.readUint8(),m=d>>>7,p=d&127;return Le(e,M,m,p)}if(n===D){var _=e.readUint8(),f=_>>>7,g=_&127;return Le(e,w,f,g)}if(n<=0||n>=240)throw r("err")("Unable to decode WAP buffer");if(n>=y&&n<=v){var C=n-y,b=o("WAWapDict").DICTIONARIES[C];if(b===void 0)throw r("err")("Missing WAP dictionary "+C);var S=e.readUint8(),A=b[S];if(A===void 0)throw r("err")("Invalid value index "+S+" in dict "+C);return A}var F=o("WAWapDict").SINGLE_BYTE_TOKEN[n-1];if(F===void 0)throw r("err")("Undefined token with index "+n);return F}function fe(e,t){for(var n=[],r=0;r<t;r++)n.push(ge(e));return n}function ge(e){var t=e.readUint8(),n;if(t===k)n=e.readUint8();else if(t===I)n=e.readUint16();else throw r("err")("Failed to decode node since type byte "+String(t)+" is invalid");var a=void 0,i=null;if(n===0)throw r("err")("Failed to decode node, list cannot be empty");var l=he(e);for(n-=1;n>1;){a||(a={});var s=he(e),u=_e(e,!0);a[s]=u,n-=2}return n===1&&(i=_e(e,!1),i instanceof o("WAWapJid").WapJid&&(i=String(i)),typeof i=="string"&&(i=Q.encode(i))),new X(l,a,i)}function he(e){var t=_e(e,!0);if(typeof t!="string")throw r("err")("WAWap:decodeString got invalid value, string expected");return t}function ye(e){var t=_e(e,!0);if(t!=null&&typeof t!="string")throw r("err")("WAWap:decodeNullableString got invalid value, string expected");return t}function Ce(e){var t=ye(e),n=he(e);return o("WAWapJid").WapJid.create(t,n)}function be(e){var t=he(e),n=e.readUint16();return he(e),o("WAWapJid").WapJid.createFbJid(t,n)}function ve(e){var t=he(e),n=e.readUint16(),r=e.readUint16();return he(e),o("WAWapJid").WapJid.createInteropJid(t,n,r)}function Se(e){var t=null,n=e.readUint8();if(n===0)t=o("WAWapJid").DomainType.WHATSAPP;else if(n===1)t=o("WAWapJid").DomainType.LID;else if((1&n)===0&&(128&n)!==0)t=o("WAWapJid").DomainType.HOSTED;else if(n===129)t=o("WAWapJid").DomainType.HOSTED_LID;else throw r("err")("decodeJidU - Invalid domain type encoding "+n);var a=e.readUint8(),i=he(e);return o("WAWapJid").WapJid.createJidU(i,t,a)}function Re(e,t,n){return n===void 0&&(n=!1),n?e.readString(t):e.readByteArrayView(t)}function Le(e,t,n,r){for(var o=new Array(r*2-n),a=0;a<o.length-1;a+=2){var i=e.readUint8();o[a]=t[i>>>4],o[a+1]=t[i&15]}if(n){var l=e.readUint8();o[o.length-1]=t[l>>>4]}return o.join("")}function Ee(){if(!A){var e=new Uint16Array(2);o("WACryptoDependencies").getCrypto().getRandomValues(e),A=String(e[0])+"."+String(e[1])+"-"}return""+A+F++}function ke(e){switch(e.type){case"group":return e.groupJid;case"status":return o("WAJids").STATUS_JID;case"device":return e.deviceJid;case"newsletter":return e.newsletterJid;case"hosted":return e.hostedDeviceJid;case"hostedLid":return e.hostedLidDeviceJid;default:return e.type,e.broadcastJid}}function Ie(e){switch(e.type){case"group":return e.author;case"status":return e.author;case"broadcast":return e.author;default:return e.type,null}}function Te(e){return e.type==="status"||e.type==="group"||e.type==="broadcast"?xe(e.author):O}function De(e){return xe(ke(e))}function xe(e){var t=o("WAJids").validateDomainJid(e);if(t!=null)return $e(t);var n=e.split("@"),a=n[0],i=n[1],l=null,s=null;if((i===d||i===c||i===p||i===m||i===_||i===o("WAJids").HOSTED_LID_SUFFIX)&&a.indexOf(":")!==-1){var u=a.split(":");a=u[0],l=u[1],s=parseInt(l,10)}if(i===p){var f=a.split("-"),g=f[0],h=f[1];return o("WAWapJid").WapJid.createInteropJid(h,s,parseInt(g,10))}else if(i===c)return o("WAWapJid").WapJid.createFbJid(a,s);var y=null;if(i===m)y=o("WAWapJid").DomainType.LID;else if(i===_){if(s!==99)throw r("err")("wid unexpected deviceId");y=o("WAWapJid").DomainType.HOSTED}else if(i===o("WAJids").HOSTED_LID_SUFFIX){if(s!==99)throw r("err")("lid invalid deviceId");y=o("WAWapJid").DomainType.HOSTED_LID}else y=o("WAWapJid").DomainType.WHATSAPP;return s!=null&&s!==0?o("WAWapJid").WapJid.createJidU(a,y,s):o("WAWapJid").WapJid.create(a,i)}function $e(e){return e==="s.whatsapp.net"?W:e==="g.us"?B:e==="newsletter"?U:e==="call"?G:r("WAAssertUnreachable")(e)}function Pe(e){return xe(e)}function Ne(e){return xe(e)}function Me(e){return xe(e)}function we(e){return xe(e)}function Ae(e){return xe(e)}function Fe(e){return xe(e)}function Oe(e){return e.jidType==="phoneDevice"||e.jidType==="msgrDevice"||e.jidType==="lidDevice"?xe(e.deviceJid):e.jidType==="phoneUser"||e.jidType==="msgrUser"||e.jidType==="lidUser"?xe(e.userJid):e.jidType==="group"?xe(e.groupJid):e.jidType==="status"?xe(e.statusJid):e.jidType==="call"?xe(e.callJid):e.jidType==="interopDevice"?xe(e.deviceJid):e.jidType==="interopUser"?xe(e.userJid):e.jidType==="newsletter"?xe(e.newsletterJid):e.jidType==="hosted"?xe(e.hostedDeviceJid):e.jidType==="hostedLid"?xe(e.hostedLidDeviceJid):e.jidType==="bot"?xe(e.botJid):(e.jidType,xe(e.broadcastJid))}function Be(e){return e}function We(e){return e.toString()}function qe(e){return e}function Ue(e){return e}function Ve(e){return e==null?O:e}function He(e){return e.toString()}function Ge(e){return o("WALongInt").longIntToDecimalString(e)}function ze(e,t){t===void 0&&(t=4);for(var n=e,r=new Uint8Array(t),o=t-1;o>=0;o--)r[o]=n&255,n>>>=8;return r}l.DROP_ATTR=O,l.G_US=B,l.S_WHATSAPP_NET=W,l.STATUS_BROADCAST=q,l.NEWSLETTER=U,l.HOSTED=V,l.HOSTED_LID=H,l.CALL=G,l.enableXMLFormat=K,l.WapNode=X,l.makeWapNode=Y,l.wap=J,l.decodeAsString=Z,l.makeStanza=ee,l.encodeStanza=te,l.decodeStanza=me,l.decodeStanzaDebug=pe,l.generateId=Ee,l.extractToJid=ke,l.extractParticipantJid=Ie,l.PARTICIPANT_JID=Te,l.TO_JID=De,l.JID=xe,l.DOMAIN_JID=$e,l.USER_JID=Pe,l.DEVICE_JID=Ne,l.GROUP_JID=Me,l.BROADCAST_JID=we,l.CALL_JID=Ae,l.NEWSLETTER_JID=Fe,l.TO_WAP_JID=Oe,l.STANZA_ID=Be,l.SMAX_ID=We,l.CUSTOM_STRING=qe,l.CALL_ID=Ue,l.MAYBE_CUSTOM_STRING=Ve,l.INT=He,l.LONG_INT=Ge,l.BIG_ENDIAN_CONTENT=ze}),98);
__d("WASmaxJsx",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";l.smax=o("WAWap").wap}),98);
__d("WASmaxMixins",["WAArrayBufferUtils","WAWapJid"],(function(t,n,r,o,a,i,l){"use strict";var e="smax$any";function s(e,t){return c(e,t),d(e,t),t.content instanceof Uint8Array?p(e,t.content):t.content!=null&&_(e,t.content),e}function u(e,t,n,r){return n!=null?e(t,n,r):t}function c(t,n){var r=t.tag,o=n.tag;if(o!==e&&r!==o)throw new Error("tag mismatch: "+r+" != "+o)}function d(e,t){var n=e.attrs,r=t.attrs;Object.keys(r).forEach(function(e){var t=r[e],o=n[e];if(t!=null&&o!=null){if(m(t,o))return;throw new Error("conflict for key: "+e)}n[e]=t})}function m(e,t){return typeof e=="string"&&typeof t=="string"?e===t:e instanceof o("WAWapJid").WapJid&&t instanceof o("WAWapJid").WapJid?e.toString()===t.toString():!1}function p(e,t){var n=e.content;if(n instanceof Uint8Array){if(!o("WAArrayBufferUtils").uint8ArraysEqualUNSAFE(n,t))throw new Error("elementValue mismatch: bytes dose not equal");return}if(n!=null)throw new Error("elementValue mismatch: destination has children");e.content=t}function _(e,t){var n=e.content;if(n instanceof Uint8Array)throw new Error("children mismatch: destination has element value");if(n==null||n.length===0){e.content=t;return}if(!f(n,t))throw new Error("children mismatch: child counts are not compatible");var r=[],o=Array.from(n);t.forEach(function(e){var t=o.findIndex(function(t){return t.tag===e.tag});if(t===-1)r.push(e);else{var n=o.splice(t,1),a=s(n[0],e);r.push(a)}}),o.forEach(function(e){return r.push(e)}),e.content=r}function f(e,t){for(var n=g(t),r=g(e),o=Object.keys(n),a=0;a<o.length;a++){var i=o[a],l=n[i],s=r[i];if(l!=null&&s!=null&&l!==s)return!1}return!0}function g(e){return e.reduce(function(e,t){var n=t.tag,r=e[n];return e[n]=r==null?1:r+1,e},{})}l.mergeStanzas=s,l.optionalMerge=u}),98);
__d("WASmaxOutPingsClientWellFormedToMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("iq",{to:o("WAWap").S_WHATSAPP_NET});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeClientWellFormedToMixin=s}),98);
__d("WASmaxOutPingsClientRequest",["WASmaxJsx","WASmaxOutPingsClientWellFormedToMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutPingsClientWellFormedToMixin").mergeClientWellFormedToMixin(o("WASmaxJsx").smax("iq",{id:o("WAWap").generateId(),type:"get",xmlns:"w:p"}));return e}l.makeClientRequest=e}),98);
__d("WAComms",["Promise","WAArrayUtils","WABaseGlobals","WAErrors","WALogger","WANotifyConnectionChangeFactory","WAPromiseRetryLoop","WAResolvable","WAShiftTimer","WASmaxInPingsClientResponseServerResponse","WASmaxOutPingsClientRequest","WASmaxParseUtils","WATimeUtils","WAWap","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A=null,F=null,O=1,B=0,W=(function(){function t(t,n,r){var a=this,i,l,c;this.nextSocketId=1,this.pendingIqs=new Map,this.ackHandlers=[],this.pendingSmaxStanzas=new Map,this.$2=new(o("WAResolvable")).Resolvable,this.socketAbortController=null,this.activePing=null,this.$3=new Set,this.socketId=B,this.socket=null,this.softCloseSocket=null,this.handleStanza=function(t,n,r){var i=o("WASmaxParseUtils").attrString(t,"id");if(i.success&&t.tag!=="receipt"){var l=i.value,u=a.pendingSmaxStanzas.get(l);if(u)return a.pendingSmaxStanzas.delete(l),u.resolve(t),a.maybeScheduleHealthCheck(),"NO_ACK"}var c=ce(t);if(c!=null){var d=a.pendingIqs.get(c);d?(a.pendingIqs.delete(c),d.resolve(t),a.maybeScheduleHealthCheck()):(o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["handleIq no handler for iq with id ",""])),c),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleIq no handler for iq"]))))}else if(t.tag==="ack")a.handleAck(t);else return t.tag==="failure"&&a.config.shouldBlockReceivingUntilSuccess?a.$1(t,n,r):a.$2.promise.then(function(){return a.$1(t,n,r)});return"NO_ACK"},this.healthCheckTimer=new(o("WAShiftTimer")).ShiftTimer(function(){a.socketId&&a.sendPing()}),this.deadSocketTimer=new(o("WAShiftTimer")).ShiftTimer(function(e){e===a.socketId&&(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," expired"])),e),a.softCloseSocket&&a.softCloseSocket())}),this.$1=t,this.onConnectionChange=o("WANotifyConnectionChangeFactory").notifyConnectionChangeFactory((i=n.handlers.onConnectionChange)!=null?i:function(){},(l=n.handlers.onOptimisticConnectionChange)!=null?l:function(){}),this.gzipInflate=r,this.config=n,this.socketLoop=new(o("WAPromiseRetryLoop")).PromiseRetryLoop({name:"MainSocketLoop",code:J,timer:(c=n.socketReconnectBackoffAlgo)!=null?c:{jitter:.1,max:n.maxSocketLoopWaitTime,algo:{type:"fibonacci",first:1e4,second:1e4},relativeDelay:!0},resetDelay:3e4,isPauseEnabled:n.isPauseEnabled===!0})}var a=t.prototype;return a.filterPending=function(t){var e=[];function n(n){t(n)&&e.push(n)}return this.pendingIqs.forEach(n),this.ackHandlers.forEach(n),this.pendingSmaxStanzas.forEach(n),e},a.sendPendingStanza=function(t){t.cleanup==null||t.cleanup(),t.cleanup=void 0,this.callStanza(t.stanza)},a.maybeSendPendingStanza=function(t){if(t.attempt>=this.config.maxRetries){var e,n;(e=(n=this.config.handlers).onDropStanza)==null||e.call(n,t),t.cleanup==null||t.cleanup(),t.cleanup=void 0,this.removeHandler(t,"max-retries")}else if(this.socket){t.attempt+=1,this.sendPendingStanza(t);return}else o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will resend stanza when socket opens"])))},a.callStanzaAsync=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield this.callStanza(e,t);return n});function t(t,n){return e.apply(this,arguments)}return t})(),a.callStanza=function(t,n){var e=this.castStanza(t,n);return this.deadSocketTimer.onOrBefore(this.config.deadSocketTime,this.socketId),this.healthCheckTimer.cancel(),e},a.castStanzaAsync=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield this.castStanza(e);return t});function t(t){return e.apply(this,arguments)}return t})(),a.castStanza=function(t,r){var e=this;try{var a,i,l=(a=(i=this.config.handlers).onBeforeCastStanzaForE2E)==null?void 0:a.call(i,t,r);if(l!=null)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Dropping stanza since onBeforeCastStanza matched. We return mock response directly."]))),Array.isArray(l)?(w||(w=n("Promise"))).all(l.map(function(t){return(w||(w=n("Promise"))).resolve(e.handleStanza(t,e.socketId,B))})):(this.handleStanza(l,this.socketId,B),(w||(w=n("Promise"))).resolve())}catch(e){}var s=this.socketOrThrow("castStanza");try{return s.sendFrame(o("WAWap").encodeStanza(t)).then(function(){e.config.handlers.onCastStanza==null||e.config.handlers.onCastStanza(t,r)}).catch(function(e){if(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["castStanza async error ",""])),e),e instanceof o("WAErrors").BufferTooLargeError)return(w||(w=n("Promise"))).reject(e)})}catch(e){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["castStanza error ",""])),e)}return(w||(w=n("Promise"))).resolve()},a.socketOrThrow=function(t){var e=this.socket;if(e)return e;throw r("err")("Comms."+t+" called while no socket")},a.startHandlingRequests=function(){return o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Comms.startHandlingRequests"]))),this.$2.resolve(),this.$2.promise.then(function(){})},a.parseAndHandleStanza=function(t,n){var e=this;t===this.socketId&&(this.deadSocketTimer.cancel(),F&&(F.resolve(),F=null));var r=o("WAWap").decodeStanza(n,this.gzipInflate).catch(function(e){throw o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Failure parsing stanza!"]))),e}).then(function(r){e.config.handlers.onHandleStanza==null||e.config.handlers.onHandleStanza(r,t,n.byteLength);var o=e.activePing;return o&&o.socketId===t&&o.stanzaId===ce(r)?(e.activePing=null,o.handler.resolve(r),e.maybeScheduleHealthCheck(),"NO_ACK"):e.handleStanza(r,t,n.byteLength)}).then(function(n){if(t===e.socketId){if(n==="CLOSE_SOCKET"){o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[comms] job response is CLOSE_SOCKET"])));var r=e.socket;r&&r.close()}else n==="NO_ACK"||e.castStanza(n);return"NO_ACK"}});this.$3.add(r),r.finally(function(){return void e.$3.delete(r)})},a.handleAck=function(t){for(var e=this.ackHandlers,n=-1,r=null;!r&&++n<e.length;)r=e[n].parseAndTest(t);if(r){var a,i,l=e[n];o("WAArrayUtils").removeIndexWithoutPreservingOrder(e,n),(a=(i=this.config.handlers).onHandleAck)==null||a.call(i,t),l.resolve(r),this.maybeScheduleHealthCheck()}else o("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["handleAck: unrecognized ",""])),t)},a.removeHandler=function(t,r){if(r===void 0&&(r="disconnect"),t.type==="iq"||t.type==="smax"){var e=t.stanza.attrs.id;if(!e||typeof e!="string"||t.type==="iq"&&!this.pendingIqs.delete(e)||t.type==="smax"&&!this.pendingSmaxStanzas.delete(e))return}else{t.type;var a=this.ackHandlers.indexOf(t);if(a===-1)return;o("WAArrayUtils").removeIndexWithoutPreservingOrder(this.ackHandlers,a)}r==="disconnect"?t.resolve((w||(w=n("Promise"))).reject(new(o("WAErrors")).Disconnected)):r==="abort"?t.resolve((w||(w=n("Promise"))).reject(new(o("WAErrors")).Aborted)):t.resolve((w||(w=n("Promise"))).reject(new(o("WAErrors")).MaxRetries))},a.maybeScheduleHealthCheck=function(){if(!this.healthCheckTimer.isScheduled()&&!(this.activePing||this.ackHandlers.length||this.pendingIqs.size||this.pendingSmaxStanzas.size)){var e=this.config.healthCheckInterval,t=Math.ceil(e*1e3*(1+Math.random()));this.healthCheckTimer.onOrBefore(t)}},a.sendPing=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=ue("sendPing");if(!e.socketId)return o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[comms] sendPing when socket dead"]))),!1;if(e.activePing&&e.activePing.socketId===e.socketId)return o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[comms] sendPing ping still pending"]))),!1;e.activePing&&e.activePing.handler.resolve();var t=o("WASmaxOutPingsClientRequest").makeClientRequest(),n=t.attrs.id;if(typeof n!="string")return o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[comms] No stanzaId in ping request stanza"]))),!1;var r=new(o("WAResolvable")).Resolvable;e.activePing={socketId:e.socketId,stanzaId:n,handler:r};var a=Date.now();e.callStanza(t);var i=yield r.promise,l=Date.now();if(i){var s=o("WASmaxInPingsClientResponseServerResponse").parseClientResponseServerResponse(i,t);if(s.success){var u=l-a,c=Math.round(u/2),d=o("WATimeUtils").castToUnixTime(s.value.t),m=o("WABaseGlobals").newClockSkewCalculation()?Math.round((a+c)/1e3-d):Math.round(Date.now()/1e3-d);return e.config.handlers.onClockSkewUpdate==null||e.config.handlers.onClockSkewUpdate(m),!0}}return!1});function t(){return e.apply(this,arguments)}return t})(),t})();function q(){return A}function U(e,t,n,r){r===void 0&&(r=!0),!A&&(A=new W(e,t,n),r&&setTimeout(j,0))}function V(){var e=ue("stopComms");e.socketLoop.endWithValue(),e.socket&&Z(),A=null}function H(){var e=ue("closeSocketAndPreventRetry");e.socketLoop.endWithValue(),e.socket&&(o("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndPreventRetry called"]))),Z())}function G(){var e=ue("closeSocketAndPause");e.socketLoop.pauseOnNextIteration(),e.socket&&(o("WALogger").LOG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndPause called"]))),Z())}function z(){var e=ue("closeSocketAndResume");e.socketLoop.unpause(),e.socket&&(o("WALogger").LOG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndResume called"]))),Z())}function j(){ue("openSocketLoop").socketLoop.start()}function K(){o("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[comms] maybeResetSocketLoop"]))),Y()||ue("maybeResetSocketLoop").socketLoop.reset()}function Q(){ue("forceResetSocketLoop").socketLoop.reset()}function X(){var e,t=ue("socketAbortController");(e=t.socketAbortController)==null||e.abort(),t.softCloseSocket==null||t.softCloseSocket()}function Y(){var e;return!!((e=A)!=null&&e.socket)}function J(){var e,t=ue("socketLoopIteration"),n=t.nextSocketId++;o("WALogger").LOG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," opening"])),n);var r=function(){t.onConnectionChange("in_handshake")};return t.config.handlers.onSocketLoopIteration==null||t.config.handlers.onSocketLoopIteration(t.socketAbortController),typeof AbortController=="function"&&(t.socketAbortController=new AbortController),t.config.openChatSocket(r,(e=t.socketAbortController)==null?void 0:e.signal).then(function(e){if(e.success){var r=e.value;t.config.handlers.onSocketOpen==null||t.config.handlers.onSocketOpen();var a=new(o("WAResolvable")).Resolvable;return o("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," opened"])),n),t.socketId=n,t.socket=r,t.softCloseSocket=function(){t.softCloseSocket=null,t.socket&&t.config.shouldCloseStaleSocket&&(Z(),t.socket=null),a.resolve()},t.socketLoop.resetTimeoutAfter(1e4),t.deadSocketTimer.cancel(),t.maybeScheduleHealthCheck(),r.setOnFrame(function(e){return t.parseAndHandleStanza(n,e)}),r.setOnClose(function(){o("WALogger").LOG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," closed"])),n),t.activePing&&n===t.activePing.socketId&&(t.activePing.handler.resolve(),t.activePing=null),t.filterPending(function(e){return e.attachedToSocketId===n}).forEach(function(e){return void t.removeHandler(e)}),n===t.socketId&&(t.socketId=B,t.socket=null,t.onConnectionChange("disconnected"),t.config.handlers.onDisconnect==null||t.config.handlers.onDisconnect(),a.resolve())}),t.onConnectionChange("connected"),t.config.handlers.onConnect==null||t.config.handlers.onConnect(),t.filterPending(function(e){return!e.attachedToSocketId}).sort(function(e,t){return e.orderedId-t.orderedId}).forEach(function(e){switch(e.type){case"smax":case"iq":t.maybeSendPendingStanza(e);break;case"ack":t.callStanza(e.stanza);break;default:e.type;break}}),a.promise}else{var i=e.error;switch(i){case"max-hunters":o("WALogger").WARN(T||(T=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket closed while in noise handshake using treasureHunt strategy"])));break;case"disconnected":o("WALogger").WARN(D||(D=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket disconnected while in noise handshake"])));break;default:return}}}).catch(function(e){e instanceof o("WAErrors").Disconnected?o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket closed while in noise handshake"]))):o("WALogger").ERROR($||($=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration failed ",""])),e)})}function Z(){var e=ue("closeSocket");e.socket&&(o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," closed"])),e.socketId),o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocket called"]))),e.socket.close())}function ee(){ue("onStreamErrorReceived").socketLoop.cancelReset()}function te(){return ue("waitForConnection").sendPing(),F||(F=new(o("WAResolvable")).Resolvable),F.promise}function ne(e,t){var n=ue("castStanza");n.socket?n.castStanza(e,t):o("WALogger").LOG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket"])))}function re(e){var t=ue("castStanza");return t.socketId===e}function oe(e,t,a,i,l){return a===void 0&&(a=0),l===void 0&&(l="iq"),new(w||(w=n("Promise")))(function(s){var u=ue("sendIq"),c=e.attrs.id;if(!c||typeof c!="string")throw r("err")("[comms] sendIq given iq without id: "+String(e));var d=u.socketId;if(t&&!d){s((w||(w=n("Promise"))).reject(new(o("WAErrors")).Offline));return}var m=function(t){t===void 0&&(t="disconnect");var e=l==="iq"?u.pendingIqs.get(c):u.pendingSmaxStanzas.get(c);if(!e){s((w||(w=n("Promise"))).reject(r("err")("[comms] _sendIq unexisting stanza to be cancelled: "+c)));return}u.removeHandler(e,t)},p=null;if(a>0){var _=setTimeout(m,a*1e3);p=function(){clearTimeout(_)}}if(i!=null)if(i.aborted){s((w||(w=n("Promise"))).reject(new(o("WAErrors")).Disconnected));return}else{var f=function(){m("abort")};i.addEventListener("abort",f),p=function(){i.removeEventListener("abort",f)}}var g={resolve:s,stanza:e,attachedToSocketId:t?d:B,orderedId:O++,attempt:0,cleanup:p};if(l==="iq"){var h=babelHelpers.extends({type:l},g);u.pendingIqs.set(c,h),u.config.handlers.onSendIq==null||u.config.handlers.onSendIq(e),u.maybeSendPendingStanza(h)}else{var y=babelHelpers.extends({type:l},g);u.pendingSmaxStanzas.set(c,y),u.maybeSendPendingStanza(y)}})}function ae(e,t){var n,r,o,a=(n=t==null?void 0:t.withoutRetry)!=null?n:!1,i=(r=t==null?void 0:t.timeoutSeconds)!=null?r:0,l=(o=t==null?void 0:t.signal)!=null?o:null;return oe(e,a,i,l,"smax")}function ie(){var e=ue("sendPing");return e.sendPing()}function le(){return ue("startHandlingRequests").startHandlingRequests()}function se(){A&&A.deadSocketTimer.cancel()}function ue(e){if(A)return A;throw r("err")("[comms] "+e+" called before startComms")}function ce(e){if(e.tag==="iq"){var t=e.attrs.type;if(t==="result"||t==="error")return o("WAWap").decodeAsString(e.attrs.id)||null}return null}function de(){return O++}function me(){A=null,F=new(o("WAResolvable")).Resolvable,O=1}l.DEFAULT_SOCKET_ID=B,l.getComms=q,l.startComms=U,l.stopComms=V,l.closeSocketAndPreventRetry=H,l.closeSocketAndPause=G,l.closeSocketAndResume=z,l.openSocketLoop=j,l.maybeResetSocketLoop=K,l.forceResetSocketLoop=Q,l.forceAbortSocketConnection=X,l.isSocketConnected=Y,l.socketLoopIteration=J,l.closeSocket=Z,l.onStreamErrorReceived=ee,l.waitForConnection=te,l.castSmaxStanza=ne,l.isActiveSocket=re,l._sendIq=oe,l.sendSmaxStanza=ae,l.sendPing=ie,l.startHandlingRequests=le,l.cancelDeadSocketTimer=se,l.singletonOrThrowIfUninitialized=ue,l.getAndIncrementNextOrderedId=de,l.resetStateForTests=me}),98);
__d("WADecimalStringMod",["WALogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){if(!/^\d+$/.test(t))throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(['"','" is not a valid decimal string'])),t),r("err")("decimalStringMod is given an invalid decimal string");var a=t.length;if(a<16||a===16&&t<="9007199254740991")return Number(t)%n;if(a>20||a===20&&t>"18446744073709551615")throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(['"','" is over 64 bits'])),t),r("err")("decimalStringMod is given value over 64 bits");for(var i=0,l=0;l<t.length;l++){var u=Number(t[l]);i=(i*10+u)%n}return i}l.decimalStringMod=u}),98);
__d("WACreateGetVcaEnabledBucket",["WAArrayBufferUtils","WADecimalStringMod","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return function(){return t==null?null:o("WAArrayBufferUtils").arrayBufferMod(e,t)+100}}function u(t,n){return function(){if(n==null)return null;var r=t.split("/"),a=r[r.length-1],i=a.split("_")[1];return/^\d+$/.test(i)?i==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["mediaRouteSelection: can't get fbId from mediaDirectPath"]))),null):o("WADecimalStringMod").decimalStringMod(i,n)+100:null}}l.createGetVcaEnabledBucket=s,l.msgrCreateGetVcaEnabledBucket=u}),98);
__d("WAExtractNcHotTimestamp",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e==null)return null;var t=s(e);if(t.has("_nc_hot")){var n=parseInt(t.get("_nc_hot"),10);return Number.isInteger(n)?o("WATimeUtils").castToUnixTime(n):null}else return null}function s(e){var t=e.split("?");return new URLSearchParams(t.length===2?t[1]:"")}l.extractNcHotTimestamp=e}),98);
__d("WASignalLocalStorageProtocol.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={},b={},v={},S={};s.internalSpec={sessionVersion:[1,(e=o("WAProtoConst")).TYPES.UINT32],localIdentityPublic:[2,e.TYPES.BYTES],remoteIdentityPublic:[3,e.TYPES.BYTES],rootKey:[4,e.TYPES.BYTES],previousCounter:[5,e.TYPES.UINT32],senderChain:[6,e.TYPES.MESSAGE,d],receiverChains:[7,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d],pendingKeyExchange:[8,e.TYPES.MESSAGE,c],pendingPreKey:[9,e.TYPES.MESSAGE,u],remoteRegistrationId:[10,e.TYPES.UINT32],localRegistrationId:[11,e.TYPES.UINT32],needsRefresh:[12,e.TYPES.BOOL],aliceBaseKey:[13,e.TYPES.BYTES]},u.internalSpec={preKeyId:[1,e.TYPES.UINT32],signedPreKeyId:[3,e.TYPES.INT32],baseKey:[2,e.TYPES.BYTES]},c.internalSpec={sequence:[1,e.TYPES.UINT32],localBaseKey:[2,e.TYPES.BYTES],localBaseKeyPrivate:[3,e.TYPES.BYTES],localRatchetKey:[4,e.TYPES.BYTES],localRatchetKeyPrivate:[5,e.TYPES.BYTES],localIdentityKey:[7,e.TYPES.BYTES],localIdentityKeyPrivate:[8,e.TYPES.BYTES]},d.internalSpec={senderRatchetKey:[1,e.TYPES.BYTES],senderRatchetKeyPrivate:[2,e.TYPES.BYTES],chainKey:[3,e.TYPES.MESSAGE,p],messageKeys:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,m]},m.internalSpec={index:[1,e.TYPES.UINT32],cipherKey:[2,e.TYPES.BYTES],macKey:[3,e.TYPES.BYTES],iv:[4,e.TYPES.BYTES]},p.internalSpec={index:[1,e.TYPES.UINT32],key:[2,e.TYPES.BYTES]},_.internalSpec={currentSession:[1,e.TYPES.MESSAGE,s],previousSessions:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,s]},f.internalSpec={id:[1,e.TYPES.UINT32],publicKey:[2,e.TYPES.BYTES],privateKey:[3,e.TYPES.BYTES]},g.internalSpec={id:[1,e.TYPES.UINT32],publicKey:[2,e.TYPES.BYTES],privateKey:[3,e.TYPES.BYTES],signature:[4,e.TYPES.BYTES],timestamp:[5,e.TYPES.FIXED64]},h.internalSpec={publicKey:[1,e.TYPES.BYTES],privateKey:[2,e.TYPES.BYTES]},y.internalSpec={senderKeyId:[1,e.TYPES.UINT32],senderChainKey:[2,e.TYPES.MESSAGE,v],senderSigningKey:[3,e.TYPES.MESSAGE,C],senderMessageKeys:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,b]},C.internalSpec={public:[1,e.TYPES.BYTES],private:[2,e.TYPES.BYTES]},b.internalSpec={iteration:[1,e.TYPES.UINT32],seed:[2,e.TYPES.BYTES]},v.internalSpec={iteration:[1,e.TYPES.UINT32],seed:[2,e.TYPES.BYTES]},S.internalSpec={senderKeyStates:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,y]},l.SessionStructureSpec=s,l.SessionStructure$PendingPreKeySpec=u,l.SessionStructure$PendingKeyExchangeSpec=c,l.SessionStructure$ChainSpec=d,l.SessionStructure$Chain$MessageKeySpec=m,l.SessionStructure$Chain$ChainKeySpec=p,l.RecordStructureSpec=_,l.PreKeyRecordStructureSpec=f,l.SignedPreKeyRecordStructureSpec=g,l.IdentityKeyPairStructureSpec=h,l.SenderKeyStateStructureSpec=y,l.SenderKeyStateStructure$SenderSigningKeySpec=C,l.SenderKeyStateStructure$SenderMessageKeySpec=b,l.SenderKeyStateStructure$SenderChainKeySpec=v,l.SenderKeyRecordStructureSpec=S}),98);
__d("WASignalKeys",["WACryptoDependencies","WACryptoPrimitives","WASignalLocalStorageProtocol.pb","WASignalOther","decodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e=5,s=16777215;function u(e,t){return{publicKey:e,privateKey:t}}function c(e){var t=o("WACryptoPrimitives").keypairFromSecretKey(e),n=t.publicKey,r=t.secretKey;return u(o("WASignalOther").ensureSize(n,32),o("WASignalOther").ensureSize(r,32))}function d(e,t){return{publicKey:o("WASignalOther").toBytes(e,32),privateKey:o("WASignalOther").toBytes(t,32)}}function m(){var e=o("WACryptoPrimitives").keyPair(),t=e.publicKey,n=e.secretKey;return n[0]&=248,n[31]=64|n[31]&63,u(o("WASignalOther").ensureSize(t,32),o("WASignalOther").ensureSize(n,32))}function p(e,t){return u(o("WASignalOther").sliceBytes(t,1,32),e)}function _(e,t){return{serializedPubKey:t,privateKey:e}}function f(){var e=m();return _(e.privateKey,g(e))}function g(t){var n=o("WASignalOther").makeBytes(33);return n[0]=e,n.set(t.publicKey,1),n}function h(t){var n=o("WASignalOther").makeBytes(33);return n[0]=e,n.set(o("WASignalOther").ensureSize(t,32),1),n}function y(e){return _(e.privateKey,g(e))}function C(e,t){for(var n=e>=s?0:e-1,r=[],a=0;a<t;a++){var i=n+1>=s?1:n+1,l=m(),u=o("WASignalOther").encodeSignalProto(o("WASignalLocalStorageProtocol.pb").PreKeyRecordStructureSpec,{id:i,publicKey:g(l),privateKey:l.privateKey});r.push({plainObject:{id:i,keyPair:l},record:u}),n=i}return r}function b(e){try{var t=o("decodeProtobuf").decodeProtobuf(o("WASignalLocalStorageProtocol.pb").PreKeyRecordStructureSpec,e),n=t.id,r=t.privateKey,a=t.publicKey;return n==null||a==null||r==null?null:{id:v(n),keyPair:p(o("WASignalOther").toBytes(r,32),R(new Uint8Array(a)))}}catch(e){return null}}function v(e){return o("WASignalOther").ensureIntInRange(e,1,s)}function S(e){return o("WASignalOther").ensureIntInRange(e,0,s)}function R(t){if(t.length===0||t[0]!==e)throw r("err")("Unrecognized public key type");return o("WASignalOther").ensureSize(t,33)}function L(){var e=o("WASignalOther").makeBytes(32);return o("WACryptoDependencies").getCrypto().getRandomValues(e),e}function E(e,t){return o("WACryptoPrimitives").scalarMult(e,t.subarray(1)).buffer}l.KEY_TYPE=e,l.PRE_KEY_NON_INCLUSIVE_UPPER_BORDER=s,l.makeKeyPairFrom=c,l.makeKeyPairFromArrayBuffers=d,l.makeKeyPair=m,l.makeKeyPairFromSerialized=p,l.makeSerializedKeyPairFrom=_,l.makeSerializedKeyPair=f,l.serializePubKey=g,l.serializeIdentity=h,l.toSerializedKeyPair=y,l.makePreKeys=C,l.deserializePreKey=b,l.castToPreKeyId=v,l.castToSignedPreKeyId=S,l.castToSerializedPubKey=R,l.makeRawSenderKey=L,l.ecdh=E}),98);
__d("WAParsableWapNode",["WABinary","WAJids","WALogger","WALongInt","WAParsableXmlNode","WASignalKeys","WATimeUtils","WAWap","WAWapJid","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(e){function t(t,n){var r;return r=e.call(this,"XmppParsingFailure: "+t+": "+n)||this,r.name="XmppParsingFailure",r.parser=t,r.reason=n,r}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"XmppParsingFailure: "+this.parser+": "+this.reason},t})(babelHelpers.wrapNativeSuper(Error)),c=(function(t){function n(e,n){return t.call(this,e,n)||this}babelHelpers.inheritsLoose(n,t);var a=n.prototype;return a.assertFromServer=function(){var e=this.attrString("from");e!==o("WAJids").WA_SERVER_JID_SUFFIX&&this.throw('to have "from"="s.whatsapp.net", but instead has "'+e+'"')},a.attrUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.botJid!=null?n.botJid:n.userJid==null?this.throw('to have "'+t+'"={UserJid}, but instead has "'+e+'"'):n.userJid},a.attrPhoneUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneUser"?n.userJid:this.throw('to have "'+t+'"={PhoneUserJid}, but instead has "'+e+'"')},a.attrLidUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="lidUser"?n.userJid:this.throw('to have "'+t+'"={LidUserJid}, but instead has "'+e+'"')},a.maybeAttrUserJid=function(t){return this.hasAttr(t)?this.attrUserJid(t):null},a.maybeAttrPhoneUserJid=function(t){return this.hasAttr(t)?this.attrPhoneUserJid(t):null},a.maybeAttrLidUserJid=function(t){return this.hasAttr(t)?this.attrLidUserJid(t):null},a.attrGroupJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.groupJid==null?this.throw('to have "'+t+'"={GroupJid}, but instead has "'+e+'"'):n.groupJid},a.maybeAttrGroupJid=function(t){return this.hasAttr(t)?this.attrGroupJid(t):null},a.attrChatJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.userJid!=null?n.userJid:n.groupJid!=null?n.groupJid:n.botJid!=null?n.botJid:this.throw('to have "'+t+'"={ChatJid}, but instead has "'+e+'"')},a.attrPhoneChatJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneUser"?n.userJid:n.jidType==="group"?n.groupJid:this.throw('to have "'+t+'"={ChatJid}, but instead has "'+e+'"')},a.attrDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.deviceJid!=null?n.deviceJid:n.userJid!=null?o("WAJids").defaultDeviceJidForUser(n.userJid):n.hostedDeviceJid!=null?n.hostedDeviceJid:n.hostedLidDeviceJid!=null?n.hostedLidDeviceJid:n.botJid!=null?n.botJid:this.throw('to have "'+t+'"={DeviceJid}, but instead has "'+e+'"')},a.attrPhoneDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneDevice"?n.deviceJid:n.jidType==="phoneUser"?o("WAJids").defaultPhoneDeviceJidForUser(n.userJid):this.throw('to have "'+t+'"={PhoneDeviceJid}, but instead has "'+e+'"')},a.attrLidDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="lidDevice"?n.deviceJid:n.jidType==="lidUser"?o("WAJids").defaultLidDeviceJidForLidUserJid(n.userJid):this.throw('to have "'+t+'"={LidDeviceJid}, but instead has "'+e+'"')},a.attrDeviceId=function(t){var e=this.attrInt(t);return o("WAJids").interpretAsDeviceId(e)},a.attrFromJidChat=function(){var t=this.attrJidWithType();switch(t.jidType){case"msgrUser":{var n=t.userJid,a=o("WAJids").defaultDeviceJidForUser(n);return{type:"device",chat:n,deviceJid:a,author:a}}case"interopUser":{var i=t.userJid,l=o("WAJids").defaultDeviceJidForUser(i);return{type:"device",chat:i,deviceJid:l,author:l}}case"phoneUser":{var s=t.userJid,u=o("WAJids").defaultDeviceJidForUser(s);return{type:"device",chat:s,deviceJid:u,author:u}}case"lidUser":{var c=t.userJid,d=o("WAJids").defaultLidDeviceJidForLidUserJid(c);return{type:"device",chat:c,deviceJid:d,author:d}}case"phoneDevice":{var m=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(m),deviceJid:m,author:m}}case"msgrDevice":{var p=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(p),deviceJid:p,author:p}}case"interopDevice":{var _=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(_),deviceJid:_,author:_}}case"lidDevice":{var f=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(f),deviceJid:f,author:f}}case"group":{var g=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return g==null?this.throw("expected to have participant JID for group"):{type:"group",chat:t.groupJid,groupJid:t.groupJid,author:g}}case"broadcast":{var h=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return h==null?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:t.broadcastJid,chat:o("WAJids").extractUserJid(h),author:h}}case"hosted":{var y=t.hostedDeviceJid;return{type:"device",chat:o("WAJids").extractUserJid(y),deviceJid:y,author:y}}case"hostedLid":{var C=t.hostedLidDeviceJid;return{type:"device",chat:o("WAJids").extractUserJid(C),deviceJid:C,author:C}}case"call":throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""])),t.callJid),r("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:return t.jidType,this.throw("attrFromJidChat should not be used with jid of type "+t.jidType)}},a.attrFromJidPhoneChat=function(){var e=this.attrJidWithType();switch(e.jidType){case"phoneUser":{var t=e.userJid,n=o("WAJids").defaultPhoneDeviceJidForUser(t);return{type:"device",chat:t,deviceJid:n,author:n}}case"phoneDevice":{var a=e.deviceJid;return{type:"device",chat:o("WAJids").extractPhoneUserJid(a),deviceJid:a,author:a}}case"group":{var i=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return i==null?this.throw("expected to have participant JID for group"):{type:"group",chat:e.groupJid,groupJid:e.groupJid,author:i}}case"broadcast":{var l=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return l==null?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:e.broadcastJid,chat:o("WAJids").extractPhoneUserJid(l),author:l}}case"call":throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""])),e.callJid),r("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:return e.jidType,this.throw("attrFromJidChat should not be used with jid of type "+e.jidType)}},a.attrFromPhoneJid=function(){var e=this.attrJidWithType();if(e.jidType==="status"){var t=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return t==null?this.throw("to have participant for status msg"):{type:"status",author:t}}else return this.attrFromJidPhoneChat()},a.attrFromJid=function(){var e=this.attrJidWithType();if(e.jidType==="status"){var t=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return t==null?this.throw("to have participant for status msg"):{type:"status",author:t}}return e.jidType==="newsletter"?{type:"newsletter",newsletterJid:e.newsletterJid}:e.jidType==="hosted"?{type:"hosted",hostedDeviceJid:e.hostedDeviceJid}:e.jidType==="hostedLid"?{type:"hostedLid",hostedLidDeviceJid:e.hostedLidDeviceJid}:this.attrFromJidChat()},a.attrJidWithType=function(t){t===void 0&&(t="from");var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="unknown"?this.throw('to have "'+t+'"={Jid}, but instead has "'+e+'"'):n},a.attrWapJid=function(t){t===void 0&&(t="from");var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="unknown"?o("WAWapJid").WapJid.create(null,e):o("WAWap").JID(o("WAJids").extractFromJid(n))},a.attrLongInt=function(t){var e=this.attrString(t);return o("WALongInt").decimalStringToLongInt(e)},a.attrTime=function(t){return o("WATimeUtils").castToUnixTime(this.attrInt(t))},a.maybeAttrTime=function(t){return this.hasAttr(t)?this.attrTime(t):null},a.attrFutureTime=function(t){var e=this.attrInt(t);return o("WATimeUtils").futureUnixTime(e)},a.contentString=function(){if(this.hasChildren())return this.throw("to have string content, but has children instead");if(this.hasContent()){var e=new(o("WABinary")).Binary(this.contentBytes());return e.readString(e.size())}else return this.throw("to have content")},a.decodeAsString=function(t){return o("WAWap").decodeAsString(t)},a.contentSerializedPubKey=function(){return this.hasContent()?o("WASignalKeys").serializeIdentity(this.contentBytes()):this.throw("to have content")},a.createParseError=function(t){return new u(this.name(),"expected <"+this.tag()+"> "+t)},a.throw=function(t){throw this.createParseError(t)},n})(o("WAParsableXmlNode").ParsableXmlNode);l.XmppParsingFailure=u,l.ParsableWapNode=c}),98);
__d("WADeprecatedWapParser",["WAParsableWapNode","err"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t){this.$1=e,this.$2=t}var t=e.prototype;return t.parse=function(t){var e=new(o("WAParsableWapNode")).ParsableWapNode(this.$1,t);try{return{success:this.$2(e)}}catch(e){if(e instanceof o("WAParsableWapNode").XmppParsingFailure)return{error:e};throw e}},t.parseOrThrow=function(t){var e=this.parse(t);if(e.error)throw r("err")(String(e.error));return e.success},e})();l.default=e}),98);
__d("WAAckParser",["WADeprecatedWapParser","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("ack",function(e){return e.assertTag("ack"),{id:e.attrString("id"),ts:e.maybeAttrString("t"),class:e.attrString("class"),type:e.maybeAttrString("type"),from:e.attrJidWithType(),participant:e.hasAttr("participant")?e.attrDeviceJid("participant"):null,recipient:e.hasAttr("recipient")?e.attrUserJid("recipient"):null}});function s(e,t){return e.id===t.id&&(t.class===void 0||e.class===t.class)&&(t.type===void 0||e.type===t.type)&&(t.from===void 0||u(e.from,t.from))&&(t.participant===void 0||e.participant===t.participant)&&(t.recipient===void 0||e.recipient===t.recipient)&&(t.ts===void 0||e.ts===t.ts)}function u(e,t){if(o("WAJids").extractFromJid(e)===t)return!0;if(e.userJid!=null)return o("WAJids").defaultDeviceJidForUser(e.userJid)===t;if(e.deviceJid!=null){var n=e.deviceJid;return o("WAJids").extractDeviceId(n)===0&&o("WAJids").extractUserJid(n)===t}return!1}l.AckParser=e,l.ackMatchesTemplate=s,l.fromJidsAreEqual=u}),98);
__d("WAParseIqResponse",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var r=e.content;if(r&&Array.isArray(r)&&r[0]){var a=r[0];if(a.tag==="error"){var i=a.attrs||{},l;n&&(typeof n=="function"?l=n(e):l=n.parseOrThrow(a));var u=l;return{success:!1,errorCode:parseInt(i.code,10),errorText:o("WAWap").decodeAsString(i.text)||"",errorType:o("WAWap").decodeAsString(i.type)||"",errorBackoff:parseInt(i.backoff,10),toString:s,customError:u}}}return typeof t=="function"?{success:!0,result:t(e)}:{success:!0,result:t.parseOrThrow(e)}}function s(){return"IqError "+this.errorCode+": "+this.errorText}l.parseIqResponse=e}),98);
__d("WADeprecatedSendIq",["Promise","WAAckParser","WAArrayUtils","WAComms","WALogger","WAParseIqResponse"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){return o("WAComms")._sendIq(e,!1).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function c(e,t,n){return o("WAComms")._sendIq(e,!1).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t,n)})}function d(e,t,n){return o("WAComms")._sendIq(e,!1,n).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function m(e,t){return o("WAComms")._sendIq(e,!0).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function p(e,t){return _(e,t).then(function(){})}function _(t,r){return new(s||(s=n("Promise")))(function(a){var i=o("WAComms").singletonOrThrowIfUninitialized("deprecatedSendStanzaAndReturnAck"),l=function(t){var e=o("WAAckParser").AckParser.parse(t);return!e.error&&o("WAAckParser").ackMatchesTemplate(e.success,r)?t:null},u={type:"ack",parseAndTest:l,resolve:a,stanza:t,attachedToSocketId:o("WAComms").DEFAULT_SOCKET_ID,orderedId:o("WAComms").getAndIncrementNextOrderedId()};if(i.ackHandlers.push(u),!i.socket){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will send stanza when socket opens"])));return}i.callStanza(t).catch(function(e){var t=i.ackHandlers.indexOf(u);t!==-1&&(o("WAArrayUtils").removeIndexWithoutPreservingOrder(i.ackHandlers,t),u.resolve((s||(s=n("Promise"))).reject(e)))})})}function f(e,t){o("WAComms").castSmaxStanza(e,t)}l.deprecatedSendIq=u,l.deprecatedSendIqErrorParser=c,l.deprecatedSendIqIfConnectedWithin=d,l.deprecatedSendIqWithoutRetry=m,l.deprecatedSendStanzaAndWaitForAck=p,l.deprecatedSendStanzaAndReturnAck=_,l.deprecatedCastStanza=f}),98);
__d("WAMediaConnParser",["WADeprecatedWapParser","WAServerMediaType"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("mediaConnParser",function(e){var t,n,r=e.child("media_conn"),o=c(r);return{hosts:o,authToken:r.attrString("auth"),authTokenExpiryTs:r.attrFutureTime("auth_ttl"),routesExpiryTs:r.attrFutureTime("ttl"),maxBuckets:r.attrInt("max_buckets"),maxManualRetry:(t=r.maybeAttrInt("max_manual_retry",0,4))!=null?t:3,maxAutoDownloadRetry:(n=r.maybeAttrInt("max_auto_download_retry",0,4))!=null?n:3}});function s(e){var t,n;if(e.hasAttr("fallback_hostname"))return{domain:e.attrString("fallback_hostname"),class:e.maybeAttrString("fallback_class"),ip4:(t=e.maybeAttrString("fallback_ip4"))!=null?t:void 0,ip6:(n=e.maybeAttrString("fallback_ip6"))!=null?n:void 0}}function u(e){var t,n,r,o;return{domain:e.attrString("hostname"),fallback:s(e),uploadable:d(e,"upload"),downloadable:d(e,"download"),isFallback:e.maybeAttrString("type")==="fallback",downloadBuckets:(t=(n=e.maybeChild("download_buckets"))==null?void 0:n.mapChildren(function(e){return parseInt(e.tag(),10)}))!=null?t:[],class:e.maybeAttrString("class"),ip4:(r=e.maybeAttrString("ip4"))!=null?r:void 0,ip6:(o=e.maybeAttrString("ip6"))!=null?o:void 0}}function c(e){return e.mapChildrenWithTag("host",u)}function d(e,t){return e.hasChild(t)?e.child(t).mapChildren(function(e){var t=e.tag();return o("WAServerMediaType").castToServerMediaType(t)}).filter(Boolean):o("WAServerMediaType").SERVER_MEDIA}l.mediaConnParser=e}),98);
__d("WAGatherMediaInfo",["WADeprecatedSendIq","WAErrors","WALogger","WAMediaConnParser","WAPromiseManagement","WAPromiseRetryLoop","WAResultOrError","WAWap"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=507,p=o("WAPromiseManagement").cacheWhilePending(function(){return"gatherMediaInfo"},_);function _(){var e=new(o("WAPromiseRetryLoop")).PromiseRetryLoop({name:"gatherMediaInfo",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:g});return e.start(),e.promise()}var f=60;function g(t){var n,r=(n=o("WAWap")).wap("iq",{id:n.generateId(),to:n.S_WHATSAPP_NET,type:"set",xmlns:"w:m"},n.wap("media_conn",null));return o("WADeprecatedSendIq").deprecatedSendIqIfConnectedWithin(r,o("WAMediaConnParser").mediaConnParser,f).then(function(n){if(n.success)o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," hosts"])),n.result.hosts.length),t(o("WAResultOrError").makeResult(n.result));else if(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo failure ",""])),n),n.errorCode===m){var r=n.errorBackoff;o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," seconds backoff"])),r),t(o("WAResultOrError").makeError({type:"backoff",backoffMs:r*1e3}))}else n.errorCode<500&&(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got client error: ",""])),n.errorCode),t(o("WAResultOrError").makeError({type:"client-error",code:n.errorCode,text:n.errorText})))}).catch(function(e){e instanceof o("WAErrors").Disconnected?t(o("WAResultOrError").makeError("disconnected")):o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo error ",""])),e)})}l.gatherMediaInfo=p}),98);
__d("WAMediaRouteSelection",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=null,n=null,r=null,a=e.hosts,i=e.mediaType,l=e.operation;if(e.operation==="download"){var s,u=e.catHotTimespan,c=e.getVcaEnabledBucket,d=e.ncHot,m=new Map;a.forEach(function(e){e.downloadBuckets.forEach(function(t){m.set(t,e)})});var p=m.get(0);u>0&&d!=null&&o("WATimeUtils").happenedWithin(o("WATimeUtils").castToUnixTime(d),u)?t=1:c&&(t=c());var _=null;t!=null&&(_=m.get(t)),(s=_)!=null&&s.downloadable.includes(i)?n=_:p!=null&&p.downloadable.includes(i)&&(n=p)}for(var f=0;f<a.length;f++){var g=a[f];if((l==="upload"&&g.uploadable.includes(i)||l==="download"&&g.downloadable.includes(i))&&(n==null?n=g:g.isFallback&&r==null&&(r=g)),n!=null&&r!=null)break}return{selectedHost:n,fallbackHost:r,bucket:t}}l.mediaRouteSelection=e}),98);
__d("WAGetMediaRoute",["$InternalEnum","Promise","WACreateGetVcaEnabledBucket","WAExtractNcHotTimestamp","WAGatherMediaInfo","WAMediaRouteSelection","WAPromiseManagement","WAResultOrError","WATagsLogger","WATimeUtils","WAWaitForComms","WAWorkerGlobalScope","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=o("WATagsLogger").TAGS(["GetMediaRoute"]),h=86400,y=n("$InternalEnum")({Fresh:"fresh",Cached:"cached",Stale:"stale"}),C=null,b=!1,v=null;function S(e,t){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){t==null||t.addPoint("get_cached_or_fresh_media_access_start");var n=yield I();if(t==null||t.addPoint("get_cached_or_fresh_media_access_end"),!n.success)return g.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Failed to get mediaAccess: ",""])),n.error),t==null||t.addPoint("get_media_access_failed",{string:{mediaAccessStatus:n.error}}),n;t==null||t.addAnnotations({string:{mediaAccessStatus:n.value.state}});var r=n.value.mediaAccess,a=r.authToken,i=r.hosts,l=r.maxBuckets,s=e.operation==="upload"?o("WAMediaRouteSelection").mediaRouteSelection({operation:"upload",mediaType:e.serverMediaType,hosts:i}):o("WAMediaRouteSelection").mediaRouteSelection({operation:"download",mediaType:e.serverMediaType,hosts:i,catHotTimespan:h,ncHot:o("WAExtractNcHotTimestamp").extractNcHotTimestamp(e.directPath),getVcaEnabledBucket:o("WACreateGetVcaEnabledBucket").msgrCreateGetVcaEnabledBucket(e.directPath,l)}),u=s.bucket,c=s.fallbackHost,d=s.selectedHost;return d==null?(g.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Error: no media host"]))),o("WAResultOrError").makeError("no-host")):o("WAResultOrError").makeResult({authToken:a,selectedHost:d,fallbackHost:c,bucket:u})}),R.apply(this,arguments)}function L(){var e=v;e!=null&&(o("WAWorkerGlobalScope").workerGlobalScope.clearTimeout(e),v=null)}function E(t){L();var n=Math.max(t.authTokenExpiryTs-o("WATimeUtils").unixTime(),0);if(!(n<=300)){var r=o("WATimeUtils").pastUnixTime(300,t.authTokenExpiryTs),a=o("WATimeUtils").pastUnixTime(Math.floor(n*.2),t.authTokenExpiryTs),i=r<a?r:a,l=o("WATimeUtils").cappedMillisecondsUntil(i),u=Math.floor(Math.random()*o("WATimeUtils").MINUTE_MILLISECONDS),c=o("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){g.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["AuthTTL approaching expiry, refreshing MediaAccess routes"]))),k().catch(function(e){g.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error occurred during authTTL automatic refresh: ",""])),e)})},l+u);v=c}}var k=o("WAPromiseManagement").cacheWhilePending(function(){return"all"},n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(b)return g.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, but we are still locked by backoff"]))),o("WAResultOrError").makeError("backoff");yield o("WAWaitForComms").waitForComms(),g.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, gather a new one"]))),L();var e=yield o("WAGatherMediaInfo").gatherMediaInfo();if(e.success)return C=e.value,E(e.value),o("WAResultOrError").makeResult({mediaAccess:e.value,state:y.Fresh});var t=e.error,n=t==="disconnected"?"disconnected":t.type;return g.WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Can not get mediaAccess: ",""])),n),t==="disconnected"||t.type==="client-error"?o("WAResultOrError").makeError("disconnected"):(t.type,b=!0,o("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){b=!1,k().catch(function(e){g.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Error occurred on gather after backoff expiry: ",""])),e)})},t.backoffMs),o("WAResultOrError").makeError("backoff"))})),I=function(){var e=C;if(e==null)return k();if(o("WATimeUtils").isInFuture(e.routesExpiryTs))return(f||(f=n("Promise"))).resolve(o("WAResultOrError").makeResult({mediaAccess:e,state:y.Cached}));var t=k();return o("WATimeUtils").isInFuture(e.authTokenExpiryTs)?(f||(f=n("Promise"))).resolve(o("WAResultOrError").makeResult({mediaAccess:e,state:y.Stale})):t};function T(){C=null,b=!1,L()}l.getMediaRoute=S,l.getCachedOrFreshMediaAccess=I,l.clearCachedMediaAccessForTest=T}),98);
__d("WAMediaOperationsRetrier",["WALogger","WAPromiseBackoffs","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=4,u={algo:{type:"constant",delay:1e3},jitter:0},c=(function(){function t(e,t,n){this.$1=e,this.routesInfo=t,this.$2=o("WAPromiseBackoffs").createPromiseTimer(u),this.$3=0,this.$4=!1,this.$5=n}var r=t.prototype;return r.run=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){for(;this.$3<s;){yield this.$2();var r=void 0;if(this.$3>0){var a;r=this.$3>=s-2&&!this.$4,o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MediaOperationsRetrier:"," wait for internet, attempt = ",""])),this.$1,this.$3),yield(a=this.$5)==null?void 0:a.call(this)}else r=!1;var i=this.routesInfo;if(!i)return null;var l=i.host;r&&i.fallbackHost&&(l=i.fallbackHost);var u=yield t(l,i.authToken,this.$3,n);if(u.success)return u.value;++this.$3,this.$4=u.error.progressMade}return null});function r(e,n){return t.apply(this,arguments)}return r})(),t})();l.MAX_ATTEMPTS=s,l.BACKOFF_OPTIONS=u,l.MediaOperationsRetrier=c}),98);
__d("WACreateMediaDownloadRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.directPath,n=e.eventFlow,r=e.fileEncSha256,a=e.mediaTypeDetails,i=a.type==="regular"?a.mediaType:"preview";n==null||n.addPoint("get_media_route_start");var l=yield o("WAGetMediaRoute").getMediaRoute({operation:"download",serverMediaType:i,fileEncSha256:r,directPath:t},n);if(!l.success)return n==null||n.addPoint("get_media_route_fail"),l;n==null||n.addPoint("get_media_route_end");var s=l.value,u=s.authToken,c=s.fallbackHost,d=s.selectedHost,m=new(o("WAMediaOperationsRetrier")).MediaOperationsRetrier("download",{host:{domain:d.domain,class:d.class},fallbackHost:c&&{domain:c.domain,class:c.class},authToken:u,timeElapsed:null},o("WAComms").waitForConnection);return o("WAResultOrError").makeResult({retrier:m,mediaRouteDetails:l.value})}),s.apply(this,arguments)}l.createMediaDownloadRetrier=e}),98);
__d("WAHttpDownloadMedia",["WAErrorMessage","WALogger","WAMediaQplHelper","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="URL signature expired";function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var r=n!=null?n:{},a=r.abortSignal,i=r.mediaMetrics;i==null||i.addPoint("http_fetch_start");var l=yield self.fetch(t,{method:"GET",mode:"cors",cache:"no-store",signal:a}).then(function(e){return i==null||i.addPoint("http_fetch_end"),o("WAResultOrError").makeResult(e)}).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return i==null||i.addPoint("http_fetch_fail",{string:{httpFetchError:n}}),o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to initiate fetch: ",", message: ",""])),t,n),t.name==="AbortError"?o("WAResultOrError").makeError("http-fetch-aborted"):o("WAResultOrError").makeError("http-fetch-exception")});if(l.success===!1)return l;var m=l.value,p=m.headers.get("content-length"),_=m.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""])),_),i==null||i.addAnnotations({string:{ciphertextMediaSizeBucket:p!=null?o("WAMediaQplHelper").convertIntegerSizeToStringBucket(Number(p)):null},int:{httpStatus:_}}),_){case 200:case 206:return o("WAResultOrError").makeResult(m);case 401:return o("WAResultOrError").makeError("access-expired");case 403:return m.text().then(function(e){return e===d?o("WAResultOrError").makeError("signature-expired"):o("WAResultOrError").makeError("access-expired")}).catch(function(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body: ",""])),e),o("WAResultOrError").makeError("access-expired")});case 404:case 410:return o("WAResultOrError").makeError("media-not-found");case 408:return o("WAResultOrError").makeError("server-timeout");case 416:return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: can not resume from offset"]))),o("WAResultOrError").makeError("request-error");case 429:case 507:return o("WAResultOrError").makeError("download-throttled");default:return _>=400&&_<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}),p.apply(this,arguments)}l.httpDownloadMedia=m}),98);
__d("WAHttpUtils",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){if(!/^https:\/\/[-\w.]+\.\w+$/.test(e))throw r("err")('buildUrl given invalid host "'+e+'"');if(!t.startsWith("/"))throw r("err")('buildUrl given invalid path "'+t+'"');var o=n,a=""+e+t;if(!o)return a;var i=Object.keys(o).map(function(e){var t=o[e];t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n=t instanceof Uint8Array?Array.from(t).map(function(e){return"%"+e.toString(16)}).join(""):encodeURIComponent(t.toString());return encodeURIComponent(e)+"="+n});if(i.length>0){var l=i.join("&");return a.includes("?")?a+"&"+l:a+"?"+l}else return a}l.buildUrl=e}),98);
__d("WAMediaUrl",["WABase64","WAGlobals","WAHttpUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=1;function s(t,n,r,a,i,l,s){var u=o("WAGlobals").getDependencies().mediaUploadRoot(),c=o("WABase64").encodeB64UrlSafe(r),d=o("WABase64").encodeB64UrlSafe(n),m={auth:i,token:d};return l&&(m.resume=e),s!=null&&s>0&&(m.bytestart=s),o("WAHttpUtils").buildUrl("https://"+a,u+"/"+t+"/"+c,m)}function u(e,t,n,r,a,i,l){var s=o("WABase64").encodeB64UrlSafe(t),u={hash:s,mode:r};return a!=null&&(u._nc_cat=a),i!=null&&i>=0&&(u.bytestart=i),l!=null&&l>0&&(u.byteend=l),o("WAHttpUtils").buildUrl("https://"+n,e,u)}l.RESUME_PARAM=e,l.buildUploadUrl=s,l.buildDownloadUrl=u}),98);
__d("WADownloadCiphertext",["WAAssertUnreachable","WABase64","WACreateMediaDownloadRetrier","WACryptoSha256","WACryptoUtils","WAHashUtils","WAHttpDownloadMedia","WALogger","WAMediaUrl","WAPromiseManagement","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.abortSignal,a=t.directPath,i=t.eventFlow,l=t.fileEncSha256,p=t.fromBytes,_=t.mediaTypeDetails,f=t.plaintextHash,h=t.toBytes;o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Start download ciphertext for hash: ",""])),o("WAHashUtils").sanitisePlaintextHash(f)),i.addPoint("create_retrier_start");var y=yield o("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({mediaTypeDetails:_,directPath:a,eventFlow:i,fileEncSha256:l});if(!y.success)return i.addPoint("create_retrier_fail"),y;i.addPoint("create_retrier_end");var C=y.value,b=C.mediaRouteDetails,v=C.retrier,S=yield v.run(function(e,t,r){var d=e.domain,m="http_download_media_"+r,_=o("WAMediaUrl").buildDownloadUrl(a,l,d,"manual",b.bucket,p,h);return i.addPoint(m+"_start"),o("WAHttpDownloadMedia").httpDownloadMedia(_,{mediaMetrics:i,abortSignal:n,cachePolicy:r>0?"no-store":"force-cache"}).then(function(e){if(e.success)return e.value.arrayBuffer().then(function(e){return i.addPoint(m+"_end"),o("WAResultOrError").makeResult(o("WAResultOrError").makeResult(e))}).catch(function(e){return i.addPoint("response_array_buffer_error"),i.addPoint(m+"_fail"),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body ",""])),e),o("WAResultOrError").makeResult(o("WAResultOrError").makeError("body-network-error"))});i.addPoint(m+"_fail");var t=e.error;switch(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: ",""])),t),i.addPoint(t),t){case"signature-expired":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("signature-expired"));case"http-fetch-aborted":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("http-fetch-aborted"));case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":return o("WAResultOrError").makeError({progressMade:!0});default:return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(t))}}).catch(function(e){return i.addPoint(m+"_fail"),o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["downloadCiphertext http download exception: ",""])),e),o("WAResultOrError").makeError({progressMade:!1})})});if(S==null)return o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded");if(S.success===!1){var R=S.error;switch(o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext failed: ",""])),R),R){case"signature-expired":case"http-fetch-aborted":case"media-not-found":case"download-throttled":case"body-network-error":case"request-error":return o("WAResultOrError").makeError(R);case"access-expired":return o("WAResultOrError").makeError("disconnected");default:throw r("WAAssertUnreachable")(R)}}else{var L=S.value;return!g(p,h)&&!o("WACryptoUtils").arrayBuffersEqual(yield o("WACryptoSha256").sha256(L),l)?o("WAResultOrError").makeError("ciphertext-hash-mismatch"):(i.addPoint("download_finish",{int:{byteLength:L.byteLength},bool:{isPartialDownload:g(p,h)}}),o("WAResultOrError").makeResult(L))}}),_.apply(this,arguments)}var f=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.fileEncSha256,n=e.fromBytes,r=e.toBytes;return o("WABase64").encodeB64UrlSafe(t)+"-"+(n!=null?n:"X")+"-"+(r!=null?r:"X")},p);function g(e,t){return e!=null&&e>0?!0:t!=null}l.cachedDownloadCiphertext=f}),98);
__d("WADownloadAndDecryptMedia",["WADecryptMedia","WADownloadCiphertext","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,n=e.directPath,r=e.eventFlow,a=e.fileEncSha256,i=e.mediaKey,l=e.mediaTypeDetails,s=e.plaintextHash,u=yield o("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:t,mediaTypeDetails:l,fileEncSha256:a,directPath:n,eventFlow:r,plaintextHash:s});if(u.success!==!0)return u;var c=yield o("WADecryptMedia").decryptMedia({mediaKey:i,mediaTypeDetails:l,plaintextHash:s,ciphertextHmac:u.value});return c.success!==!0?c:(c.value.alternativeHmacSaltUsed!=null&&r.addAnnotations({string:{alternativeHmacSaltUsed:c.value.alternativeHmacSaltUsed}}),o("WAResultOrError").makeResult(c.value.plaintext))}),s.apply(this,arguments)}l.downloadAndDecryptMedia=e}),98);
__d("WACreateMediaDecrypterStream",["WABinary","WAMediaCrypto","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["WADecryptStream"]);function f(t,r,a,i,l){if(i.byteLength===0)return _.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs must have at least one element"]))),o("WAResultOrError").makeError("missing-expected-hmacs");if(i.byteLength!==l.length*o("WAMediaCrypto").HMAC_LENGTH)return _.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs and ciphertextLengths must have the same length"]))),o("WAResultOrError").makeError("hmac-chiphertext-array-mismatch");var m=g(i),p=r,f=new(o("WABinary")).Binary,y=0,C=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,n){for(f.writeByteArray(e);y<m.length&&f.size()>=l[y];y++){var r=f.readByteArrayView(l[y]);_.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," of size ",""])),y,r.length);var i=y===l.length-1;try{var s=yield o("WAMediaCrypto").hmacAndDecryptPartial(t,p,r,a,m[y]),d=s.nextIv,g=s.plaintext;i?n.enqueue(h(g)):n.enqueue(g),p=d}catch(e){_.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt chunk. isLastChunk: "," error: ",""])),i,e),e instanceof o("WAMediaCrypto").HmacValidationError?n.error("enc-hash-mismatch"):n.error("decryption-error")}}});return function(n,r){return e.apply(this,arguments)}})(),b=new TransformStream({transform:function(t,n){var e=t;return C(e,n)},flush:function(t){f.size()>0&&_.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unexpected ciphertext in buffer following flush"])))}});return o("WAResultOrError").makeResult(b)}function g(e){var t=[];if(e.byteLength%o("WAMediaCrypto").HMAC_LENGTH!==0)throw r("err")("Sidecar length is not a multiple of hmac length");for(var n=0;n<e.byteLength;n+=o("WAMediaCrypto").HMAC_LENGTH){var a=new Uint8Array(e,n,o("WAMediaCrypto").HMAC_LENGTH);t.push(a)}return t}function h(e){if(e.length<o("WAMediaCrypto").CBC_BLOCK_SIZE)return _.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Plaintext size is less than CBC_BLOCK_SIZE"]))),e;var t=e[e.length-1];return t===0||t>o("WAMediaCrypto").CBC_BLOCK_SIZE?(_.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Invalid PKCS padding length"]))),e):e.subarray(0,-t)}l.createDefaultDecryptStream=f}),98);
__d("WAMediaProgressiveJpegTransformStream",["WABinary"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.scanLengths,n=[],r=0;for(var a of t)r+=a,n.push(r);var i=new(o("WABinary")).Binary,l=0,s=0,u=new TransformStream({transform:function(r,o){var e=r;for(s+=e.byteLength,i.writeByteArray(e);l<t.length&&n[l]<s;l++){var a=i.readByteArrayView(t[l]);o.enqueue(a)}},flush:function(t){t.enqueue(i.readByteArrayView())}});return u}l.makeProgressiveJpegHandlerTransformStream=e}),98);
__d("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry",["WACreateMediaDecrypterStream","WAHttpDownloadMedia","WAMediaCrypto","WAMediaProgressiveJpegTransformStream","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function c(e){return e}function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.abortSignal,r=t.cachePolicy,a=t.downloadUrl,i=t.eventFlow,l=t.mediaKey,c=t.progressiveJpegDetails,d=t.serverMediaType,m=yield o("WAHttpDownloadMedia").httpDownloadMedia(a,{mediaMetrics:i,abortSignal:n,cachePolicy:r});if(m.success!==!0)return m;var p=m.value.body;if(p==null)return o("WAResultOrError").makeError("body-network-error");var _=m.value.headers.get("Content-Length");if(_==null)return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is missing"]))),o("WAResultOrError").makeError("missing-content-length-header");var f=Number(_);if(Number.isNaN(f))return u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is not a number"]))),o("WAResultOrError").makeError("invalid-content-length-header");var g=o("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:c,ciphertextLength:f}),h=yield o("WAMediaCrypto").computeMediaKeys(l,d),y=o("WACreateMediaDecrypterStream").createDefaultDecryptStream(h.cipherKey,h.iv,h.hmacKey,g.sidecar,g.alignedScanLengths);if(y.success!==!0)return y;var C=y.value,b=o("WAMediaProgressiveJpegTransformStream").makeProgressiveJpegHandlerTransformStream(g),v=p.pipeThrough(C).pipeThrough(b);return o("WAResultOrError").makeResult(v)}),m.apply(this,arguments)}l.unsafeCastToDownloadAndDecryptPJpegStream=c,l.downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry=d}),98);
__d("WADownloadProgressiveJpegPlaintextStreamer",["WAAssertUnreachable","WACreateMediaDownloadRetrier","WADownloadProgressiveJpegPlaintextStreamerWithoutRetry","WAMediaUrl","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.abortSignal,i=t.directPath,l=t.eventFlow,u=t.fileEncSha256,c=t.mediaKey,d=t.progressiveJpegDetails,m=t.serverMediaType,p=yield o("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({directPath:i,eventFlow:l,fileEncSha256:u,mediaTypeDetails:{type:"regular",mediaType:m}});if(!p.success)return p;var _=p.value,f=_.mediaRouteDetails,g=_.retrier,h=f.bucket,y=yield g.run((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var s=e.domain,p=o("WAMediaUrl").buildDownloadUrl(i,u,s,"manual",h),_=yield o("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry").downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry({abortSignal:a,downloadUrl:p,eventFlow:l,mediaKey:c,progressiveJpegDetails:d,serverMediaType:m,cachePolicy:n>0?"no-store":"force-cache"});if(_.success===!0)return o("WAResultOrError").makeResult(_);var f=_.error;switch(f){case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":case"invalid-content-length-header":case"missing-content-length-header":return o("WAResultOrError").makeError({progressMade:!0});case"access-expired":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("disconnected"));case"body-network-error":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("request-error"));case"media-not-found":case"request-error":case"download-throttled":case"signature-expired":case"http-fetch-aborted":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(f));case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(f));default:throw r("WAAssertUnreachable")(f)}});return function(t,n,r){return e.apply(this,arguments)}})());return y==null?(s.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Download with stream given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded")):y}),c.apply(this,arguments)}l.downloadProgressiveJpegPlaintextUsingStreams=u}),98);
__d("WAPrepareMediaDownload",["Promise","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAHashUtils","WAMediaQplHelper","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=typeof((e=navigator.storage)==null?void 0:e.getDirectory)=="function",m=typeof self.caches=="object",p=0;function _(e){var t,r=e.hash,a=e.logger,i=e.mediaDownloadFlow,l=e.mediaEntry,_=l.directPath,f=l.downloadableThumbnail,g=l.mediaKeyTimestamp,h=l.serverMediaType,y=l.size,C=o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(g);a.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start download ",". mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""])),o("WAHashUtils").sanitisePlaintextHash(r),C,y,h);var b=(t=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(l).value)!=null?t:null;return i.addPoint("wa_protocol_media_download_start",{string:{mediaType:h,mediaKeyTimestampAgeBucket:C,sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)},bool:{isOPFSSupported:d,isWebCacheSupported:m,duplicateDirectPath:(f==null?void 0:f.directPath)===_,hasDownloadableThumbnail:(f==null?void 0:f.directPath)!=null,isProgressiveJpeg:b!=null}}),{logDownloadResult:function(t){return p++,i.addAnnotations({int:{concurrentDownloadCount:p}}),t.then(function(e){if(e.success){var t=e.value.plaintext.byteLength;i.addPoint("wa_protocol_media_download_end",{string:{media_size:o("WAMediaQplHelper").convertIntegerSizeToStringBucket(t)}})}else i.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:e.error}});return e}).catch(function(e){i.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"runtime-error"}});var t=o("WAErrorMessage").maybeGetMessageFromError(e);return a.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""])),t),(c||(c=n("Promise"))).resolve(o("WAResultOrError").makeError("runtime-error"))}).finally(function(){p--})}}}l.prepareMediaDownload=_}),98);
__d("WAProgressiveJpegAddJPEGTrailingTag",["WATypedArraysConcat"],(function(t,n,r,o,a,i,l){"use strict";var e=new Uint8Array([255,217]);function s(t){return o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[new Uint8Array(t),e]).buffer}l.JPEG_TRAILING_TAG=e,l.addJPEGTrailingTag=s}),98);
__d("WAStreamAsyncIterator",[],(function(t,n,r,o,a,i){"use strict";function e(e){return l.apply(this,arguments)}function l(){return l=babelHelpers.wrapAsyncGenerator(function*(e){var t=e.getReader();try{for(;;){var n=yield babelHelpers.awaitAsyncGenerator(t.read()),r=n.done,o=n.value;if(r)return;yield o}}finally{t.releaseLock()}}),l.apply(this,arguments)}i.streamAsyncIterator=e}),66);
__d("WADownloadMedia",["Promise","WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadAndDecryptMedia","WADownloadDownloadablePreview","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAHashUtils","WAMediaCrypto","WAMediaUtils","WAPrepareMediaDownload","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAPromiseManagement","WAResultOrError","WAStreamAsyncIterator","WATagsLogger","WATypedArraysConcat","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["hash"],s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R=o("WATagsLogger").TAGS(["MediaDownload"]);function L(e){var t=e.downloadMediaMetric,n=e.handleMediaPreviewBeforeDownload,r=e.handleMediaPreviewDownload,a=e.handleMediaPreviewDownloadFailed,i=e.hash,l=e.mediaEntry,s=e.protocolMsgId,u=o("WAPrepareMediaDownload").prepareMediaDownload({mediaDownloadFlow:t,mediaEntry:l,hash:i,logger:R}),c=u.logDownloadResult;return c(k({downloadMediaMetric:t,hash:i,mediaEntry:l,protocolMsgId:s,handleMediaPreviewDownload:r,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:a}))}var E=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.downloadMediaMetric,r=e.handleMediaPreviewBeforeDownload,a=e.handleMediaPreviewDownload,i=e.handleMediaPreviewDownloadFailed,l=e.hash,p=e.mediaEntry,_=e.protocolMsgId,f=o("WAMediaUtils").validateDecodedMediaEntryForDownload(p);if(!f.success)return R.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mediaEntry is incomplete. ",""])),f.error),f;var g=f.value,h=g.directPath,y=g.fileEncSha256,C=g.fileSha256,b=g.mediaKey,v=g.serverMediaType,L=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(p);L.success===!1&&(R.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to get ProgressiveJpeg details: ",""])),L.error),t.addPoint(L.error));var E=L.success===!0?L.value:null,k=function(t){if(t==null)return(S||(S=n("Promise"))).resolve();var e=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(v);return e==null?(R.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""])),v),(S||(S=n("Promise"))).resolve()):a(l,t,e,_).then(function(){})};if(E!=null&&o("WAMediaUtils").isTransformStreamSupported()&&v==="image"){var T=yield P({directPath:h,downloadFlow:t,fileEncSha256:y,handleMediaPreviewBlob:k,hash:l,mediaKey:b,progressiveJpegDetails:E,serverMediaType:v,fileSha256:C,handleMediaPreviewBeforeDownload:r,handleMediaPreviewDownloadFailed:i});if(T.success)return o("WAResultOrError").makeResult({mimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(v),plaintext:T.value,serverMediaType:v});var D=T.error;switch(R.WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Media Streaming failed to download progressive jpeg. Reason: ",". PlaintextHash: ",""])),D,o("WAHashUtils").sanitisePlaintextHash(l)),D){case"signature-expired":case"request-error":return R.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Skipping fallback for ",". PlaintextHash: ",""])),D,o("WAHashUtils").sanitisePlaintextHash(l)),o("WAResultOrError").makeError(D)}}t==null||t.addPoint("fallback_to_non_streaming_download");var x=$({hash:l,mediaEntry:p,progressiveJpegDetails:E,protocolMsgId:_,serverMediaType:v,handleMediaPreviewBeforeDownload:r,handleMediaPreviewDownloadFailed:i,downloadEntry:t.downloadEntry,triggerUIView:t.triggerUIView});return x.then(function(e){return e.success===!1?k(null):k(e.value)}),I({downloadMediaMetric:t,mediaEntry:f.value})});return function(n){return e.apply(this,arguments)}})(),k=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.hash;return t},E),I=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,n=e.downloadMediaMetric,r=e.mediaEntry,a=r.directPath,i=r.fileEncSha256,l=r.fileSha256,s=r.mediaKey,u=r.serverMediaType,c=yield D({abortSignal:t,downloadFlow:n,mediaTypeDetails:{mediaType:u,type:"regular"},directPath:a,fileEncSha256:i,fileSha256:l,mediaKey:s});return c.success?o("WAResultOrError").makeResult({mimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(u),plaintext:c.value,serverMediaType:u}):c});return function(n){return e.apply(this,arguments)}})(),T=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.hash;return t},function(t){var n=t.hash,r=babelHelpers.objectWithoutPropertiesLoose(t,e),a=o("WAPrepareMediaDownload").prepareMediaDownload({hash:n,mediaDownloadFlow:r.downloadMediaMetric,mediaEntry:r.mediaEntry,logger:R}),i=a.logDownloadResult;return i(I(r))});function D(e){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,n=e.directPath,r=e.downloadFlow,a=e.fileEncSha256,i=e.fileSha256,l=e.mediaKey,s=e.mediaTypeDetails,u=o("WAHashUtils").toPlaintextHash(i),c=yield o("WADownloadAndDecryptMedia").downloadAndDecryptMedia({abortSignal:t,directPath:n,eventFlow:r,fileEncSha256:a,mediaKey:l,mediaTypeDetails:s,plaintextHash:u});if(c.success===!1){var d=c.error;switch(d){case"signature-expired":case"media-not-found":return o("WAResultOrError").makeError(d);case"enc-hash-mismatch":return R.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia: enc-hash-mismatch"]))),o("WAResultOrError").makeError(d);default:return o("WAResultOrError").makeError(d)}}else{var m=c.value;return o("WAResultOrError").makeResult(m)}}),x.apply(this,arguments)}function $(e){var t=e.downloadEntry,n=e.handleMediaPreviewBeforeDownload,r=e.handleMediaPreviewDownloadFailed,a=e.hash,i=e.mediaEntry,l=e.progressiveJpegDetails,s=e.protocolMsgId,u=e.serverMediaType,c=e.triggerUIView;return l==null?o("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(s,a,u,i,t,{handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r},c):o("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreview({protocolMsgId:s,hash:a,serverMediaType:u,mediaEntry:i,progressiveJpegDetails:l,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r,downloadEntry:t,triggerUIView:c}).then(function(e){return e.success!==!0?o("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(s,a,u,i,t,{handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r},c):e})}function P(e){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.directPath,n=e.downloadFlow,r=e.fileEncSha256,a=e.fileSha256,i=e.handleMediaPreviewBeforeDownload,l=e.handleMediaPreviewBlob,s=e.handleMediaPreviewDownloadFailed,u=e.hash,c=e.mediaKey,d=e.progressiveJpegDetails,m=e.serverMediaType,p=R.TAGS(["MediaStreaming"]);p.LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_start");var S=o("WADownloadProgressiveJpegPreview").getPreviewTargetScan(d.scanLengths)-1;p.LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Targeting scanIndex "," for preview. PlaintextHash: ",""])),S,o("WAHashUtils").sanitisePlaintextHash(u)),n.addAnnotations({int:{scans:d.scanLengths.length}}),i(u);var L=yield o("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({directPath:t,eventFlow:n,fileEncSha256:r,mediaKey:c,progressiveJpegDetails:d,serverMediaType:m});if(L.success===!1)return n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:L.error}}),s(u,L.error),L;n.addPoint("download_pjpeg_preview_start");var E=[],k=0;try{var I=!1,T=!1,D;try{for(var x=babelHelpers.asyncIterator(o("WAStreamAsyncIterator").streamAsyncIterator(L.value)),$;I=!($=yield x.next()).done;I=!1){var P=$.value;{if(P==null)continue;if(p.LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," for plaintextHash ",""])),k,o("WAHashUtils").sanitisePlaintextHash(u)),E.push(P),k===S){n.addPoint("media_streaming_preview_processed"),p.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Handling preview from scan "," for plaintextHash ",""])),k,o("WAHashUtils").sanitisePlaintextHash(u));var N=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(E,[o("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));l(N),n.addPoint("download_pjpeg_preview_end")}k++}}}catch(e){T=!0,D=e}finally{try{I&&x.return!=null&&(yield x.return())}finally{if(T)throw D}}k<S&&(p.ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["pjpeg stream ended before reaching previewTargetScanIndex for plaintextHash ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("download_pjpeg_preview_fail"));var M=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(E))),w=yield o("WACryptoSha256").sha256(M);return o("WACryptoUtils").arrayBuffersEqual(a,w)?(p.LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download successful. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_end"),o("WAResultOrError").makeResult(M)):(p.WARN(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:"hash-mismatch"}}),o("WAResultOrError").makeError("hash-mismatch"))}catch(e){return p.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""])),e),k<S&&(n.addPoint("download_pjpeg_preview_fail"),s(u,o("WAErrorMessage").maybeGetMessageFromError(e))),n==null||n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WAResultOrError").makeError("stream-error")}}),N.apply(this,arguments)}l.mediaDownloadLogger=R,l.downloadMedia=L,l.downloadFullMediaOnly=I,l.cachedDownloadFullMediaOnly=T,l.downloadMediaImpl=D}),98);
__d("WADownloadProgressiveJpegPlaintext",["WADownloadCiphertext","WAMediaCrypto","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["DownloadProgressiveJpeg"]);function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,n=e.directPath,r=e.eventFlow,a=e.fileEncSha256,i=e.mediaKey,l=e.mediaTypeDetails,s=e.plaintextHash,u=e.progressiveJpegDetails,c=e.size,d=e.targetScan,m=o("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:u,ciphertextLength:f(c)}),_=o("WAProgressiveJpegGetPJpegDetails").getTotalByteSizeForScan(m.alignedScanLengths,d),g=yield o("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:t,mediaTypeDetails:l,fileEncSha256:a,directPath:n,fromBytes:0,toBytes:_-1,eventFlow:r,plaintextHash:s});return g.success!==!0?g:p(i,l,d,m,g.value)}),m.apply(this,arguments)}function p(e,t,n,r,o){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i){c.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Using progressiveJpeg decryptAndVerify"])));var l=new Uint8Array(i),d;n.type==="preview"?d=o("WAMediaCrypto").computeMediaKeysForPreview(t):d=o("WAMediaCrypto").computeMediaKeys(t,n.mediaType);var m=yield d.then(function(e){var t=e.cipherKey,n=e.hmacKey,i=e.iv;return o("WAMediaCrypto").decryptPartialChunks(t,i,l,n,r,a)}).then(o("WAResultOrError").makeResult).catch(function(e){return c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""])),e),e instanceof o("WAMediaCrypto").HmacValidationError?o("WAResultOrError").makeError("enc-hash-mismatch"):o("WAResultOrError").makeError("decryption-error")});if(!m.success)return m;c.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ProgressiveJpeg download and decrypt successful. Partial: ",""])),r<a.scanLengths.length);var p=o("WAProgressiveJpegAddJPEGTrailingTag").addJPEGTrailingTag(m.value.plaintext);return o("WAResultOrError").makeResult(p)}),_.apply(this,arguments)}function f(e){if(e==null)return null;var t=o("WAMediaCrypto").CBC_BLOCK_SIZE-e%o("WAMediaCrypto").CBC_BLOCK_SIZE;return e+t+o("WAMediaCrypto").HMAC_LENGTH}l.downloadProgressiveJpegPlaintext=d}),98);
__d("WALoggerTag",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum").Mirrored(["CryptoManager","MediaPreview","PrekeyGenerateAndUpload","SignedPrekey","SignedPrekeyRotation","OneTimePrekey"]),l=e;i.default=l}),66);
__d("WAProgressiveJpegGetTargetScanLengthForBytes",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){for(var n=0,r=0,o=0;o<e.length&&(r=o+1,n+=e[o],!(n>=t));o++);return r}i.getTargetScanBasedOnByteSize=e}),66);
__d("WADownloadProgressiveJpegPreview",["WADownloadMedia","WADownloadProgressiveJpegPlaintext","WAGlobals","WALoggerTag","WAProgressiveJpegGetTargetScanLengthForBytes","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WADownloadMedia").mediaDownloadLogger.TAGS([r("WALoggerTag").MediaPreview]),c=3;function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.downloadEntry,r=t.handleMediaPreviewBeforeDownload,a=t.handleMediaPreviewDownloadFailed,i=t.hash,l=t.mediaEntry,c=t.progressiveJpegDetails,d=t.protocolMsgId,m=t.serverMediaType,_=t.triggerUIView,f=l.directPath,g=l.fileEncSha256,h=l.mediaKey,y=l.size;if(f==null||g==null||h==null)return o("WAResultOrError").makeError("pjpeg-failed");var C=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:d,downloadEntry:n,isPreview:!0,msgType:null,triggerUIView:_});C.addAnnotations({bool:{isProgressiveJpeg:!0},string:{mediaType:"preview",fullSizeMediaType:l.serverMediaType},int:{mediaEntrySize:l.size}}),u.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Starting progressiveJpeg preview download"]))),C.addPoint("wa_protocol_media_download_start");var b=o("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?c.scanLengths.length-1:c.scanLengths.length,v=Math.min(p(c.scanLengths,y),b);yield r(i);var S=yield o("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({directPath:f,eventFlow:C,fileEncSha256:g,mediaKey:h,mediaTypeDetails:{mediaType:m,type:"regular"},progressiveJpegDetails:c,plaintextHash:i,targetScan:v,size:y});if(!S.success)return a(i,S.error),C.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:S.error}}),o("WAResultOrError").makeError("pjpeg-failed");var R=S.value;return u.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Finished progressiveJpeg preview download"]))),C.addPoint("wa_protocol_media_download_end"),C.endSuccess(),o("WAResultOrError").makeResult(R)}),m.apply(this,arguments)}function p(e,t){var n=o("WAGlobals").getConfig().jpegThumbnailTargetByteSizeKB()*1024,r=o("WAProgressiveJpegGetTargetScanLengthForBytes").getTargetScanBasedOnByteSize(e,n);return(t==null||t===0)&&(r=Math.min(r,e.length-1)),r=Math.max(r,c),r}function _(e){var t=e.abortSignal,n=e.hash,r=e.mediaDownloadFlow,a=e.mediaEntry,i=e.progressiveJpegDetails,l=e.serverMediaType,s=a.directPath,u=a.fileEncSha256,c=a.mediaKey,d=a.size,m=o("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?i.scanLengths.length-1:i.scanLengths.length,_=Math.min(p(i.scanLengths,d),m);return o("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({abortSignal:t,directPath:s,fileEncSha256:u,mediaKey:c,mediaTypeDetails:{mediaType:l,type:"regular"},progressiveJpegDetails:i,plaintextHash:n,targetScan:_,size:d,eventFlow:r})}l.maybeDownloadProgressiveJpegPreview=d,l.getPreviewTargetScan=p,l.maybeDownloadProgressiveJpegPreviewV2=_}),98);
__d("WAGetKaleidoscopeWasm",["WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("33861")),s=function(){return o("WAWasmModuleCache").loadWasmModule(e)};l.getKaleidoscopeWasm=s}),98);
__d("WAMediaUtilsWasmUrl",["bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("237"));l.WAMediaUtilsWasmUrl=e}),98);
__d("WAPreloadWamediaUtilsWasm",["WAMediaUtilsWasmUrl","WAWasmModuleCache"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){o("WAWasmModuleCache").loadWasmModule(o("WAMediaUtilsWasmUrl").WAMediaUtilsWasmUrl)};l.preloadWamediaUtilsWasm=e}),98);
__d("WAPreloadWebpCheckWasm",["WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("6946")),s=function(){o("WAWasmModuleCache").loadWasmModule(e)};l.preloadWebpCheckWasm=s}),98);
__d("WAPrewarmMediaValidate",["WAGetKaleidoscopeWasm","WALogger","WAPreloadWamediaUtilsWasm","WAPreloadWebpCheckWasm","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){if(r("gkx")("3272")){o("WAGetKaleidoscopeWasm").getKaleidoscopeWasm().catch(function(t){var n=r("getErrorSafe")(t);o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["prewarm Kaleidoscop wasm failed with error: ",""])),n.message)});return}if(t==null){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["prewarmMediaValidate: serverMediaType is null"])));return}(t==="sticker"||t==="image")&&o("WAPreloadWebpCheckWasm").preloadWebpCheckWasm(),(t==="video"||t==="audio")&&o("WAPreloadWamediaUtilsWasm").preloadWamediaUtilsWasm()}l.prewarmMediaValidate=u}),98);
__d("WAMediaManagerPrepareMediaDownload",["Promise","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAHashUtils","WAMediaQplHelper","WAPrewarmMediaValidate","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=0;function d(t){var r,a=t.hash,i=t.logger,l=t.mediaDownloadFlow,d=t.mediaEntry,m=d.directPath,p=d.downloadableThumbnail,_=d.mediaKeyTimestamp,f=d.serverMediaType,g=d.size;o("WAPrewarmMediaValidate").prewarmMediaValidate(f);var h=o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(_);i.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start download ",". entry: "," mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),l.downloadEntry,h,g,f);var y=(r=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(d).value)!=null?r:null;return l.addPoint("wa_protocol_media_download_start",{bool:{duplicateDirectPath:(p==null?void 0:p.directPath)===m,hasDownloadableThumbnail:(p==null?void 0:p.directPath)!=null,isProgressiveJpeg:y!=null},string:{mediaKeyTimestampAgeBucket:h,mediaType:f}}),{logDownloadResult:function(t){return c++,l.addAnnotations({int:{concurrentDownloadCount:c}}),t.then(function(e){if(e.success){var t=e.value.validatedResult.validatedPlaintext.byteLength;l.addPoint("wa_protocol_media_download_end",{string:{media_size:o("WAMediaQplHelper").convertIntegerSizeToStringBucket(t)}})}else l.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:e.error}});return e}).catch(function(e){l.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"runtime-error"}});var t=o("WAErrorMessage").maybeGetMessageFromError(e);return i.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""])),t),(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("runtime-error"))}).finally(function(){c--})}}}l.mediaManagerPrepareMediaDownload=d}),98);
__d("WAIsMp4",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112}i.isMp4=e}),66);
__d("WAIsWebP",[],(function(t,n,r,o,a,i){"use strict";function e(e){return!(e.length<12||e[0]!==82||e[1]!==73||e[2]!==70||e[3]!==70||e[8]!==87||e[9]!==69||e[10]!==66||e[11]!==80)}i.isWebP=e}),66);
__d("WAKaleidoscopeLogger",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return r("FBLogger")("wmi").tags(["Kaleidoscope"])};l.ksLogger=e}),98);
__d("WAKaleidoscopeCheck",["WAGetKaleidoscopeWasm","WAKaleidoscopeLogger","WAResultOrError","WASI","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_="input",f="output",g="/"+_,h="/"+f;function y(e){var t,n=e.input,r=e.mediaType,o=e.rawMimeType,a=e.stderr,i=e.stdout;return{args:["kaleidoscope","check","--json-report="+f,"--mimetype-hint="+o,_],fs:(t={},t[g]={path:g,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(n)},t[h]={path:h,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"string",content:""},t),stdout:i,stderr:a,moduleName:"WAKaleidoscopeCheck_CLI"}}function C(t){var a=t.getWasmModule;return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n,i,l,_,f=t.input,g=t.mediaType,C=t.rawMimeType,b=o("WASI").createWasi(y({input:f,rawMimeType:C,mediaType:g,stderr:function(n){o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n)},stdout:function(t){o("WAKaleidoscopeLogger").ksLogger().DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)}})),v=b.getImportObject,S=b.start,R=yield a(),L=yield WebAssembly.instantiate(R,v()),E=S(L),k=E.exitCode,I=E.fs;if(k!==0)return o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed with exit code ",""])),k),o("WAResultOrError").makeError("wasm-runtime-error");var T=(n=I[h])==null?void 0:n.content;if(typeof T!="string")return o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed invalid result type"]))),o("WAResultOrError").makeError("wasm-result-not-json");var D={};try{D=JSON.parse(T)}catch(e){return o("WAKaleidoscopeLogger").ksLogger().catching(r("getErrorSafe")(e)).MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed to parse JSON"]))),o("WAResultOrError").makeError("wasm-invalid-json")}return typeof((i=D)==null?void 0:i.score)!="number"?(o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck score is null"]))),o("WAResultOrError").makeError("wasm-invalid-json")):(o("WAKaleidoscopeLogger").ksLogger().DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck called with rawMimeType: ",", mediaType: ",""])),C,g),o("WAResultOrError").makeResult({mimetype:((l=D)==null?void 0:l.mimetype)||"application/octet-stream",extension:((_=D)==null?void 0:_.extension)||null,score:D.score}))});function i(e){return t.apply(this,arguments)}return i})()}var b=C({getWasmModule:o("WAGetKaleidoscopeWasm").getKaleidoscopeWasm});l.kaleidoscopeCheck=b}),98);
__d("WAMp4Check",["WAMediaUtilsWasmUrl","WAResultOrError","WASI","WAWasmModuleCache","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e="input",s="output",u="/"+e,c="/"+s;function d(t){var n,r=t.input,o=t.stderr,a=t.stdout;return{args:["wamediautil","mp4check","--error-tolerance=2","--json-report="+s,e],fs:(n={},n[u]={path:u,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(r)},n[c]={path:c,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"string",content:""},n),stdout:a,stderr:o,moduleName:"WAMp4Check_CLI"}}function m(e){var t=e.getWasmModule,r=e.logError,a=e.logMessage;return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n,i,l,s,u,m,p,_,f,g,h,y,C,b=e.input,v=o("WASI").createWasi(d({input:b,stderr:r,stdout:a})),S=v.getImportObject,R=v.start,L=yield t(),E=yield WebAssembly.instantiate(L,S()),k=R(E),I=k.exitCode,T=k.fs;if(I!==0)return r("mp4Check failed with exit code "+I),o("WAResultOrError").makeError("invalid-media");var D=(n=T[c])==null?void 0:n.content;if(typeof D!="string")return r("mp4check failed invalid result type"),o("WAResultOrError").makeError("runtime-error");var x=(i=JSON.parse(D))!=null?i:{};return o("WAResultOrError").makeResult({videoStreamReport:(x==null?void 0:x.video_stream_report)==null?null:{streamType:(l=x.video_stream_report)==null?void 0:l.stream_type,calculatedFps:(s=x.video_stream_report)==null?void 0:s.calculated_fps,nominalFps:(u=x.video_stream_report)==null?void 0:u.nominal_fps,videoWidth:(m=x.video_stream_report)==null?void 0:m.video_width,videoHeight:(p=x.video_stream_report)==null?void 0:p.video_height,duration:(_=x.video_stream_report)==null?void 0:_.duration,avgBitsPerSecond:(f=x.video_stream_report)==null?void 0:f.avg_bits_per_second},audioStreamReport:(x==null?void 0:x.audio_stream_report)==null?null:{streamType:(g=x.audio_stream_report)==null?void 0:g.stream_type,samplingRate:(h=x.audio_stream_report)==null?void 0:h.sampling_rate,numberOfChannels:(y=x.audio_stream_report)==null?void 0:y.number_of_channels,avgBitsPerSecond:(C=x.audio_stream_report)==null?void 0:C.avg_bits_per_second}})});function i(t){return e.apply(this,arguments)}return i})()}var p=function(){return o("WAWasmModuleCache").loadWasmModule(o("WAMediaUtilsWasmUrl").WAMediaUtilsWasmUrl)};l.createMp4Check=m,l.getMp4CheckWasm=p}),98);
__d("WAParseWav",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=new DataView(e);return e.byteLength<44||t.getUint32(0)!==1380533830||t.getUint32(8)!==1463899717?null:e}function l(e){var t=new DataView(e),n=t.getUint16(22,!0),r=t.getUint32(24,!0);return{numChannels:n,sampleRate:r}}i.validateWav=e,i.parseWav=l}),66);
__d("WAWebPCheck",["WAResultOrError","WASI","WAWasmModuleCache","asyncToGeneratorRuntime","bx"],(function(t,n,r,o,a,i,l){"use strict";var e="input",s="/"+e;function u(t){var n,r=t.input,o=t.stderr,a=t.stdout;return{args:["webpcheck",e],fs:(n={},n[s]={path:s,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(r)},n),stdout:a,stderr:o,moduleName:"WAWebPCheck_CLI"}}function c(e){var t=e.getWasmModule,r=e.logError,a=e.logMessage;return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.input,i=o("WASI").createWasi(u({input:n,stderr:r,stdout:a})),l=i.getImportObject,s=i.start,c=yield t(),d=yield WebAssembly.instantiate(c,l()),m=s(d),p=m.exitCode;return p!==0?(r("WebPCheck failed with exit code "+p),o("WAResultOrError").makeError("invalid-media")):o("WAResultOrError").makeResult()});function i(t){return e.apply(this,arguments)}return i})()}var d=r("bx").getURL(r("bx")("6946")),m=function(){return o("WAWasmModuleCache").loadWasmModule(d)};l.createWebPCheck=c,l.getWebpCheckWasm=m}),98);
__d("WAValidateMedia",["FBLogger","Promise","WAIsMp4","WAIsOgg","WAIsWebP","WAKaleidoscopeCheck","WAMp4Check","WAParseWav","WAResultOrError","WAWebPCheck","asyncToGeneratorRuntime","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=function(){return r("FBLogger")("wmi").tags(["WAValidateMedia"])};function p(t,n){return n.addPoint("media_validation_start"),(r("gkx")("3272")?_(t):g(t)).then(function(e){return e.success?n.addPoint("media_validation_end",{bool:{is_validation_setup_failed:e.value.validationSetupFailed,is_validation_skipped:e.value.skipValidation},string:{validated_mime_type:e.value.mimeType}}):n.addPoint("media_validation_fail",{string:{validationError:e.error}}),e}).catch(function(a){var i=r("getErrorSafe")(a);return m().catching(i).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["validateMedia threw an exception: ",""])),i.message),n.addPoint("media_validation_fail",{string:{validationError:i.message}}),o("WAResultOrError").makeResult({skipValidation:!0,mimeType:null,validatedPlaintext:t,validationSetupFailed:!0})})}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WAKaleidoscopeCheck").kaleidoscopeCheck({input:e,rawMimeType:"application/octet-stream",mediaType:"unknown"});if(!t.success)return m().MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed with error: ",""])),t.error),o("WAResultOrError").makeError("runtime-error");var n=t.value,r=n.mimetype,a=n.score;return a>=80?o("WAResultOrError").makeError("invalid-media"):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:r,validatedPlaintext:e,validationSetupFailed:!1,isKaleidoscopeCheck:!0})}),f.apply(this,arguments)}function g(e){var t=new Uint8Array(e);if(o("WAIsWebP").isWebP(t))return C(e);if(o("WAIsMp4").isMp4(t))return v(e);if(o("WAIsOgg").isOgg(t))return(d||(d=n("Promise"))).resolve(o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/ogg",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:null}));var r=o("WAParseWav").validateWav(e);return r!=null?(d||(d=n("Promise"))).resolve(R(r)):(d||(d=n("Promise"))).resolve(o("WAResultOrError").makeResult({mimeType:null,skipValidation:!0,validatedPlaintext:e,validationSetupFailed:!1}))}var h=function(t){t!==""&&m().WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)},y=function(t){t!==""&&m().DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)};function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("WAWebPCheck").createWebPCheck({getWasmModule:o("WAWebPCheck").getWebpCheckWasm,logError:h,logMessage:y}),n=yield t({input:e});return n.success?o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"image/webp",validatedPlaintext:e,validationSetupFailed:!1}):n}),b.apply(this,arguments)}function v(e){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("WAMp4Check").createMp4Check({getWasmModule:o("WAMp4Check").getMp4CheckWasm,logError:h,logMessage:y}),n=yield t({input:e});if(!n.success)return o("WAResultOrError").makeError(n.error);var r=n.value,a=r.audioStreamReport,i=r.videoStreamReport;return i==null?a==null?o("WAResultOrError").makeError("invalid-media"):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/mp4",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:a}):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"video/mp4",validatedPlaintext:e,validationSetupFailed:!1,videoStreamReport:i,audioStreamReport:a})}),S.apply(this,arguments)}function R(e){var t=o("WAParseWav").parseWav(e),n=t.numChannels,r=t.sampleRate;return o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/wav",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:{streamType:"LPCM",samplingRate:r,numberOfChannels:n}})}l.validateMedia=p}),98);
__d("WADownloadFullSizeOnlyTask",["EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWEBSwitch","Promise","WADownloadMedia","WAFindMostRecentMediaEntry","WAIsMediaExpiredError","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAResultOrError","WAValidateMedia","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,r=e.dbCallbacks,a=e.fullSizePlaintextHash,i=e.logger,l=e.mediaDownloadFlow;l.addPoint("get_media_entries_start");var s=yield r.getMediaEntries(a);if(!s.success)return l.addPoint("get_media_entries_fail"),{fullsizePromise:(c||(c=n("Promise"))).resolve(o("WAResultOrError").makeError("missing-media-entry"))};var u=s.value;l.addPoint("get_media_entries_end");var d=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(u);if(!d.success)return{fullsizePromise:(c||(c=n("Promise"))).resolve(o("WAResultOrError").makeError("missing-media-entry"))};var m=d.value,_=m[0],f=m[1],g=o("WAMediaUtils").validateDecodedMediaEntryForDownload(f);if(!g.success)return{fullsizePromise:(c||(c=n("Promise"))).resolve(g)};var h=g.value,y=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:a,logger:i,mediaDownloadFlow:l,mediaEntry:h}),C=y.logDownloadResult,b=p({abortSignal:t,dbCallbacks:r,logger:i,mediaDownloadFlow:l,mediaEntries:u,msgIdOfRecentMediaEntry:_,recentMediaEntry:h}).then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(!e.success)return e;var t=yield o("WAValidateMedia").validateMedia(e.value.plaintext,l);return t.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:[_,h],serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.mimeType,validatedResult:t.value}):t});return function(t){return e.apply(this,arguments)}})());return{fullsizePromise:C(b)}}),m.apply(this,arguments)}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.abortSignal,a=t.dbCallbacks,i=t.logger,l=t.mediaDownloadFlow,c=t.mediaEntries,d=t.msgIdOfRecentMediaEntry,m=t.recentMediaEntry,p=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");p&&l.addPoint("forcing_eb_download");var _=p?o("WAResultOrError").makeError("signature-expired"):yield o("WADownloadMedia").downloadFullMediaOnly({abortSignal:n,downloadMediaMetric:l,mediaEntry:m});if(_.success||!o("WAIsMediaExpiredError").isMediaExpiredError(_.error)||!r("MAWEBSwitch").isEnabled())return _;var f=yield a.getProtocolMsgIdAndSortOrderMs(d);if(f==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var g=f.protocolMsgId,h=f.sortOrderMs,y=m,C=d,b=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(y.serverMediaType);if(b==null||y.objectId==null)return i.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and can not restore: ",""])),_.error),_;var v=yield o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:y.objectId,logger:i,mediaDownloadFlow:l,mediaKey:y.mediaKey,mediaType:b,msgId:C,protocolMsgId:g,sortOrderMs:h});if(!v.success)return i.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and restore failed: ",""])),v.error),v;var S=yield o("WADownloadMedia").downloadFullMediaOnly({abortSignal:n,downloadMediaMetric:babelHelpers.extends({},l,{addPoint:function(t,n){l.addPoint("second_"+t,n)}}),mediaEntry:babelHelpers.extends({},y,{directPath:v.value})});return S.success?o("WAResultOrError").makeResult(S.value):(i.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media after restore CDN URL: ",""])),S.error),S)}),_.apply(this,arguments)}l.startDownloadFullSizeTask=d,l.downloadOrRestoreFullSize=p}),98);
__d("WADownloadMediaPreviewV2",["WADownloadMedia","WADownloadProgressiveJpegPreview","WAMediaCrypto","WAMediaUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.abortSignal,r=t.hash,a=t.logger,i=t.mediaDownloadFlow,l=t.mediaEntry,s=t.progressiveJpegDetails,u=l.serverMediaType,c=o("WAMediaUtils").getMimeTypeFromServerMediaType(u),d=s==null?o("WAResultOrError").makeError("jpeg-stream-not-supported"):yield o("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreviewV2({abortSignal:n,hash:r,serverMediaType:u,mediaEntry:l,progressiveJpegDetails:s,mediaDownloadFlow:i});if(d.success===!0)return o("WAResultOrError").makeResult({plaintext:d.value,mimeType:c,serverMediaType:u});i.addPoint("fallback_to_downloadable_thumbnail");var m=l.downloadableThumbnail;if((m==null?void 0:m.directPath)==null)return o("WAResultOrError").makeError("media-not-found");var p=o("WAMediaUtils").validateDownloadableThumbnailForDownload(m);if(p.success===!1)return a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["preview mediaEntry is incomplete: ",""])),p.error),o("WAResultOrError").makeError(p.error[0]);var _=p.value,f=_.directPath,g=_.fileEncSha256,h=_.fileSha256,y=_.mediaKey,C=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(u);if(C==null)return o("WAResultOrError").makeError("request-error");var b=yield o("WADownloadMedia").downloadMediaImpl({abortSignal:n,downloadFlow:i,mediaTypeDetails:{messageType:C,type:"preview"},directPath:f,fileEncSha256:g,fileSha256:h,mediaKey:y});return b.success===!1?b:o("WAResultOrError").makeResult({plaintext:b.value,mimeType:c,serverMediaType:u})}),u.apply(this,arguments)}l.downloadMediaPreview=s}),98);
__d("WAIsPreviewSupported",["$InternalEnum","WAProgressiveJpegGetPJpegDetails"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["NO","YES"]),s=n("$InternalEnum").Mirrored(["NO","YES","DuplicatedWithFullSize"]);function u(t){var n=t.serverMediaType;switch(n){case"image":{var r,a,i=(r=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(t).value)!=null?r:null,l=i!=null?e.YES:e.NO;if(((a=t.downloadableThumbnail)==null?void 0:a.directPath)==null)return[l,s.NO];t.downloadableThumbnail.directPath;var u=t.downloadableThumbnail.directPath===t.directPath?s.DuplicatedWithFullSize:s.YES;return[l,u]}case"video":{var c;if(((c=t.downloadableThumbnail)==null?void 0:c.directPath)==null)return[e.NO,s.NO];t.downloadableThumbnail.directPath;var d=t.downloadableThumbnail.directPath===t.directPath?s.NO:s.YES;return[e.NO,d]}case"sticker":case"ptt":case"audio":case"document":case"gif":case"ppic":case"md-app-state":case"md-msg-hist":case"kyc-id":case"template":case"thumbnail-image":case"thumbnail-video":case"thumbnail-gif":case"thumbnail-document":case"thumbnail-link":case"novi-video":case"novi-image":case"payment-bg-image":case"xma-image":case"biz-cover-photo":case"preview":case"newsletter-audio":case"newsletter-document":case"newsletter-image":case"newsletter-gif":case"newsletter-music-artwork":case"newsletter-ptt":case"newsletter-sticker":case"newsletter-sticker-pack":case"newsletter-thumbnail-link":case"newsletter-video":case"newsletter-ptv":case"sticker-pack":case"thumbnail-sticker-pack":case"music-artwork":case"group-history":case"ads-image":case"ads-video":case"ptv":return[e.NO,s.NO];default:return[e.NO,s.NO]}}l.PjpegPreviewSupport=e,l.DownloadablePreviewSupport=s,l.checkPreviewSupport=u}),98);
__d("WADownloadPreviewOnlyTask",["EncryptedBackupsResignCdnUrl","MAWEBSwitch","Promise","WADownloadMediaPreviewV2","WAFindMostRecentMediaEntry","WAIsMediaExpiredError","WAIsPreviewSupported","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAValidateMedia","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,r=e.dbCallbacks,a=e.fullSizePlaintextHash,i=e.logger,l=e.mediaDownloadFlow;l.addPoint("get_media_entries_start");var s=yield r.getMediaEntries(a);if(!s.success)return l.addPoint("get_media_entries_fail"),{previewPromise:(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("missing-media-entry"))};l.addPoint("get_media_entries_end");var c=s.value,d=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(c);if(!d.success)return{previewPromise:(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("missing-media-entry"))};var p=d.value,_=p[0],f=p[1],g=o("WAMediaUtils").validateDecodedMediaEntryForDownload(f);if(!g.success)return{previewPromise:(u||(u=n("Promise"))).resolve(g)};var h=g.value,y=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:a,logger:i,mediaDownloadFlow:l,mediaEntry:h}),C=y.logDownloadResult,b=m({abortSignal:t,dbCallbacks:r,fullSizePlaintextHash:a,logger:i,mediaDownloadFlow:l,mediaEntries:s.value,msgIdOfRecentMediaEntry:_,recentMediaEntry:h}).then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(!e.success)return e;var t=yield o("WAValidateMedia").validateMedia(e.value.plaintext,l);return t.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:[_,h],serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.mimeType,validatedResult:t.value}):t});return function(t){return e.apply(this,arguments)}})());return{previewPromise:C(b)}}),d.apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a,i=t.abortSignal,l=t.dbCallbacks,c=t.fullSizePlaintextHash,d=t.logger,m=t.mediaDownloadFlow,p=t.mediaEntries,_=t.msgIdOfRecentMediaEntry,f=t.recentMediaEntry,g=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");g&&m.addPoint("forcing_eb_download");var h=o("WAIsPreviewSupported").checkPreviewSupport(f),y=h[0],C=h[1];if(y===o("WAIsPreviewSupported").PjpegPreviewSupport.NO&&C===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return o("WAResultOrError").makeError("preview-not-supported");var b=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(f),v=b.success===!0?b.value:null,S={abortSignal:i,hash:c,logger:d,mediaDownloadFlow:m,progressiveJpegDetails:v};m.addPoint("download_preview_start",{string:{preview_downloadable_support:C,preview_pjpeg_support:y}});var R=g?o("WAResultOrError").makeError("signature-expired"):yield o("WADownloadMediaPreviewV2").downloadMediaPreview(babelHelpers.extends({},S,{mediaEntry:f}));if(R.success)return m.addPoint("download_preview_end"),o("WAResultOrError").makeResult({mimeType:R.value.mimeType,plaintext:R.value.plaintext,serverMediaType:R.value.serverMediaType});if(m.addPoint("download_preview_fail"),!o("WAIsMediaExpiredError").isMediaExpiredError(R.error)||!r("MAWEBSwitch").isEnabled()||r("gkx")("1327")!==!0)return R;var L=yield l.getProtocolMsgIdAndSortOrderMs(_);if(L==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var E=L.protocolMsgId,k=L.sortOrderMs,I=f,T=_,D=C===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO||((a=I.downloadableThumbnail)==null?void 0:a.objectId)==null?null:o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:I.downloadableThumbnail.objectId,logger:d,mediaDownloadFlow:m,mediaKey:I.mediaKey,mediaType:"preview",msgId:T,protocolMsgId:E,sortOrderMs:k}),x=y===o("WAIsPreviewSupported").PjpegPreviewSupport.NO||I.objectId==null?null:o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:I.objectId,logger:d,mediaDownloadFlow:m,mediaKey:I.mediaKey,mediaType:"image",msgId:T,protocolMsgId:E,sortOrderMs:k}),$=yield(u||(u=n("Promise"))).all([D,x]),P=$[0],N=$[1];if((P==null?void 0:P.success)!==!0&&(N==null?void 0:N.success)!==!0){var M;return d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and restore failed. downloadableThumbnail error: ",". pjpegPreview error: ",""])),P==null?void 0:P.error,N==null?void 0:N.error),(M=N!=null?N:P)!=null?M:o("WAResultOrError").makeError("preview-not-supported")}m.addPoint("second_download_preview_start");var w=yield o("WADownloadMediaPreviewV2").downloadMediaPreview(babelHelpers.extends({},S,{mediaDownloadFlow:babelHelpers.extends({},m,{addPoint:function(t,n){m.addPoint("second_"+t,n)}}),mediaEntry:babelHelpers.extends({},I,{directPath:(N==null?void 0:N.success)===!0?N.value:I.directPath,downloadableThumbnail:I.downloadableThumbnail==null?null:babelHelpers.extends({},I.downloadableThumbnail,{directPath:(P==null?void 0:P.success)===!0?P.value:I.downloadableThumbnail.directPath})})}));return w.success?(m.addPoint("second_download_preview_end"),o("WAResultOrError").makeResult({mimeType:w.value.mimeType,plaintext:w.value.plaintext,serverMediaType:w.value.serverMediaType})):(d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media after restore CDN URL: ",""])),w.error),m.addPoint("second_download_preview_fail"),w)}),p.apply(this,arguments)}l.startDownloadPreviewTask=c,l.downloadOrRestorePreviewOnly=m}),98);
__d("WADownloadProgressiveJpegUsingMediaStreaming",["WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAMediaUtils","WAProgressiveJpegAddJPEGTrailingTag","WAResolvable","WAResultOrError","WAStreamAsyncIterator","WATypedArraysConcat","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.abortSignal,r=t.directPath,a=t.downloadFlow,i=t.fileEncSha256,l=t.fileSha256,m=t.logger,p=t.mediaKey,_=t.progressiveJpegDetails,f=t.serverMediaType,g=m.TAGS(["MediaStreaming"]);g.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg."]))),a.addPoint("create_pjpeg_stream_start");var y=yield o("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({abortSignal:n,directPath:r,eventFlow:a,fileEncSha256:i,mediaKey:p,progressiveJpegDetails:_,serverMediaType:f}).catch(function(e){return g.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["create DownloadAndDecryptPJpegStream unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});if(y.success===!1)return a.addPoint("create_pjpeg_stream_fail"),y;a.addPoint("create_pjpeg_stream_end");var C=new(o("WAResolvable")).Resolvable,b=!1,v=h({downloadFlow:a,fileSha256:l,mediaStreamingLogger:g,previewResolvable:C,progressiveJpegDetails:_,progressiveJpegDownloadStream:y.value,serverMediaType:f}).then(function(e){return b=!0,g.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handleProgressiveJpegDownloadStream completed"]))),e}).catch(function(e){return b=!0,g.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["handleProgressiveJpegDownloadStream unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),C.reject(e),o("WAResultOrError").makeError("runtime-error")}),S=o("WAMediaUtils").getMimeTypeFromServerMediaType(f);function R(e){return e.success===!1?e:o("WAResultOrError").makeResult({mimeType:S,plaintext:e.value,serverMediaType:f})}var L=v.then(R),E=C.promise.then(R),k=yield C.promise;if(k.success===!0&&b===!0&&g.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["fullsizeResolvable is settled before previewResolvable"]))),k.success===!0)return o("WAResultOrError").makeResult({fullsizePromise:L,previewPromise:E});var I=yield v;return k.success,I.success===!0?o("WAResultOrError").makeResult({fullsizePromise:L,previewPromise:E}):(I.success,I)}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.downloadFlow,n=e.fileSha256,r=e.mediaStreamingLogger,a=e.previewResolvable,i=e.progressiveJpegDetails,l=e.progressiveJpegDownloadStream;t.addPoint("download_pjpeg_preview_start");var s=0,u=o("WADownloadProgressiveJpegPreview").getPreviewTargetScan(i.scanLengths)-1;try{var c=[],d=!1,f=!1,g;try{for(var h=babelHelpers.asyncIterator(o("WAStreamAsyncIterator").streamAsyncIterator(l)),y;d=!(y=yield h.next()).done;d=!1){var C=y.value;{if(C==null)continue;if(c.push(C),s===u){t.addPoint("media_streaming_preview_processed");var b=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(c,[o("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));a.resolve(o("WAResultOrError").makeResult(b)),t.addPoint("download_pjpeg_preview_end")}s++}}}catch(e){f=!0,g=e}finally{try{d&&h.return!=null&&(yield h.return())}finally{if(f)throw g}}a.isSettled===!1&&(r.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["pjpeg stream ended before reaching previewTargetScanIndex"]))),a.resolve(o("WAResultOrError").makeError("runtime-error")),t.addPoint("download_pjpeg_preview_fail"));var v=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(c))),S=yield o("WACryptoSha256").sha256(v);return o("WACryptoUtils").arrayBuffersEqual(n,S)?o("WAResultOrError").makeResult(v):(r.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch."]))),o("WAResultOrError").makeError("hash-mismatch"))}catch(e){return r.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""])),e),a.isSettled===!1&&(a.resolve(o("WAResultOrError").makeError("runtime-error")),t.addPoint("download_pjpeg_preview_fail")),o("WAResultOrError").makeError("runtime-error")}}),y.apply(this,arguments)}l.downloadProgresiveJpegUsingMediaStreaming=f}),98);
__d("WADownloadFullSizeAndPreviewTask",["EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWEBSwitch","Promise","UserAgent","WADownloadFullSizeOnlyTask","WADownloadPreviewOnlyTask","WADownloadProgressiveJpegUsingMediaStreaming","WAErrorMessage","WAFindMostRecentMediaEntry","WAHashUtils","WAIsMediaExpiredError","WAIsPreviewSupported","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAStartMediaDownloadQplFlow","WAValidateMedia","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y;function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,r=e.dbCallbacks,a=e.fullSizePlaintextHash,i=e.logger,l=e.mediaDownloadFlow;l.addPoint("get_media_entries_start");var s=yield r.getMediaEntries(a);if(!s.success)return l.addPoint("get_media_entries_fail"),{fullsizePromise:(y||(y=n("Promise"))).resolve(o("WAResultOrError").makeError("missing-media-entry")),previewPromise:y.resolve(o("WAResultOrError").makeError("missing-media-entry"))};l.addPoint("get_media_entries_end");var m=s.value,p=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(m);if(!p.success)return{fullsizePromise:(y||(y=n("Promise"))).resolve(o("WAResultOrError").makeError("missing-media-entry")),previewPromise:y.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var _=p.value,f=_[0],g=_[1],h=o("WAMediaUtils").validateDecodedMediaEntryForDownload(g);return h.success?R({abortSignal:t,dbCallbacks:r,fullSizePlaintextHash:a,logger:i,mediaDownloadFlow:l,mediaEntries:m,msgIdOfRecentMediaEntry:f,recentMediaEntry:h.value}).then(function(e){return i.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["outter promise: ",""])),e.success===!0?"success":e.error),e.success?e.value:(i.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["outter promise failed: ",""])),e.error),{fullsizePromise:(y||(y=n("Promise"))).resolve(e),previewPromise:y.resolve(e)})}):(i.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaEntry for download: ",""])),h.error),{fullsizePromise:(y||(y=n("Promise"))).resolve(h),previewPromise:y.resolve(h)})}),b.apply(this,arguments)}function v(e,t,n){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r){var a=yield e;if(!a.success)return(y||(y=n("Promise"))).resolve(a);var i=yield o("WAValidateMedia").validateMedia(a.value.plaintext,r);return i.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:t,serverMediaType:a.value.serverMediaType,unvalidatedMimeType:a.value.mimeType,validatedResult:i.value}):i}),S.apply(this,arguments)}function R(e){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.logger,i=e.mediaDownloadFlow,l=e.mediaEntries,s=e.msgIdOfRecentMediaEntry,u=e.recentMediaEntry,c=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:a,mediaDownloadFlow:i,mediaEntry:u}),d=c.logDownloadResult,p={abortSignal:t,dbCallbacks:n,logger:a,mediaDownloadFlow:i,mediaEntries:l,msgIdOfRecentMediaEntry:s,recentMediaEntry:u},_=yield E(babelHelpers.extends({},p,{fullSizePlaintextHash:r}));if(_.success){var f=_.value,g=f.fullsizePromise,h=f.previewPromise,y=g.then(function(e){return e.success?e:(i.addPoint("fallback_to_non_streaming_download",{string:{streaming_fallback_reason:e.error}}),o("WADownloadFullSizeOnlyTask").downloadOrRestoreFullSize(p))}),C=[s,u];return o("WAResultOrError").makeResult({fullsizePromise:d(v(y,C,i)),previewPromise:v(h,C,i)})}var b=D(_.error);if(!b.shouldFallback)return o("WAResultOrError").makeError(b.error);i.addPoint("fallback_to_non_streaming_download",{string:{streaming_fallback_reason:b.error}}),a.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["fallback to non-streaming download"])));var S=v(o("WADownloadFullSizeOnlyTask").downloadOrRestoreFullSize(p),[s,u],i),R=I(babelHelpers.extends({},p,{fullSizePlaintextHash:r,fullsizePromise:S}));return o("WAResultOrError").makeResult({fullsizePromise:d(S),previewPromise:R})}),L.apply(this,arguments)}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.abortSignal,a=e.dbCallbacks,i=e.logger,l=e.mediaDownloadFlow,s=e.mediaEntries,u=e.msgIdOfRecentMediaEntry,c=e.recentMediaEntry,d=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");d&&l.addPoint("forcing_eb_download");var m=c.directPath,y=c.fileEncSha256,C=c.fileSha256,b=c.mediaKey,v=c.serverMediaType,S=(t=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(c).value)!=null?t:null;if(S==null||c.serverMediaType!=="image"||!o("WAMediaUtils").isTransformStreamSupported()||r("UserAgent").isBrowser("Safari < 18")||r("UserAgent").isBrowser("Mobile Safari < 18"))return c.serverMediaType==="image"&&S==null&&(i.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["skip pjpeg streaming because pjpeg metadata is null"]))),i.DEV(_||(_=babelHelpers.taggedTemplateLiteralLoose(["media entry: ",""])),c)),o("WAResultOrError").makeError("jpeg-stream-not-supported");l.addPoint("media_streaming_start");var R=d?o("WAResultOrError").makeError("signature-expired"):yield o("WADownloadProgressiveJpegUsingMediaStreaming").downloadProgresiveJpegUsingMediaStreaming({abortSignal:n,directPath:m,downloadFlow:l,fileEncSha256:y,fileSha256:C,logger:i,mediaKey:b,progressiveJpegDetails:S,serverMediaType:v}).catch(function(e){return i.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["downloadProgresiveJpegUsingMediaStreaming unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});if(R.success)return l.addPoint("media_streaming_end"),R;if(!o("WAIsMediaExpiredError").isMediaExpiredError(R.error)||!r("MAWEBSwitch").isEnabled())return T(l,R),R;var L=yield a.getProtocolMsgIdAndSortOrderMs(u);if(L==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var E=L.protocolMsgId,k=L.sortOrderMs,I=c,D=u,x=I.fileEncSha256,$=I.fileSha256,P=I.mediaKey,N=I.serverMediaType,M=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(N);if(M==null||I.objectId==null)return i.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and can not restore: ",""])),R.error),R;var w=yield o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:I.objectId,logger:i,mediaDownloadFlow:l,mediaKey:I.mediaKey,mediaType:M,msgId:D,protocolMsgId:E,sortOrderMs:k});if(!w.success)return w;l.addPoint("second_media_streaming_start");var A=yield o("WADownloadProgressiveJpegUsingMediaStreaming").downloadProgresiveJpegUsingMediaStreaming({abortSignal:n,directPath:w.value,downloadFlow:babelHelpers.extends({},l,{addPoint:function(t,n){l.addPoint("second_"+t,n)}}),fileEncSha256:x,fileSha256:$,logger:i,mediaKey:P,progressiveJpegDetails:S,serverMediaType:N}).catch(function(e){return i.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["downloadProgresiveJpegUsingMediaStreaming unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});return A.success?(l.addPoint("second_media_streaming_end"),A):(T(l,A),A)}),k.apply(this,arguments)}function I(t){var r=t.abortSignal,a=t.dbCallbacks,i=t.fullSizePlaintextHash,l=t.fullsizePromise,u=t.logger,c=t.mediaDownloadFlow,d=t.mediaEntries,m=t.msgIdOfRecentMediaEntry,p=t.recentMediaEntry,_=p.serverMediaType,f=o("WAIsPreviewSupported").checkPreviewSupport(p),g=f[0],h=f[1];if(g===o("WAIsPreviewSupported").PjpegPreviewSupport.NO&&h===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return u.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["preview not supported"]))),(y||(y=n("Promise"))).resolve(o("WAResultOrError").makeError("preview-not-supported"));if(h===o("WAIsPreviewSupported").DownloadablePreviewSupport.DuplicatedWithFullSize)return u.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["preview duplicated with fullsize"]))),l;var C=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:c.downloadEntry,isPreview:!0,msgType:null,protocolMsgId:null,triggerUIView:null}),b=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:i,logger:u,mediaDownloadFlow:C,mediaEntry:p}),S=b.logDownloadResult;C.addAnnotations({bool:{isMediaManager:!0},string:{downloadKind:"fullsizeAndPreview",fullSizeMediaType:_,mediaType:"preview",sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(i)}});var R=o("WADownloadPreviewOnlyTask").downloadOrRestorePreviewOnly({abortSignal:r,dbCallbacks:a,fullSizePlaintextHash:i,logger:u,mediaDownloadFlow:C,mediaEntries:d,msgIdOfRecentMediaEntry:m,recentMediaEntry:p});return S(v(R,[m,p],C)).then(function(e){return e.success?C.endSuccess():C.endFail(e.error,{string:{failReason:e.error}}),e}).catch(function(e){return C.endFail("runtime-error",{string:{failReason:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WAResultOrError").makeError("runtime-error")})}function T(e,t){e.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:o("WAErrorMessage").maybeGetMessageFromError(t.error)}})}function D(e){switch(e){case"runtime-error":case"jpeg-stream-not-supported":return{error:e,shouldFallback:!0};case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return{error:e,shouldFallback:!0};case"missing-media-entry":case"missing-media-entry-for-restore":case"missing-sort-order-ms-for-restore":case"preview-not-supported":return{error:e,shouldFallback:!1};case"derive-primary-key-secret-error":case"derive-access-token-secret-error":case"direct-path-undefined":case"direct-path-corrupted":case"direct-path-empty":case"create-payload-failed":case"resign-cdn-url-request-error":case"resign-cdn-url-runtime-error":case"resign-cdn-url-timeout":case"resign-cdn-url-gql-error":return{error:e,shouldFallback:!1};case"invalid-media":return{error:e,shouldFallback:!1};case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":return{error:e,shouldFallback:!0};case"access-expired":case"disconnected":case"backoff":case"body-network-error":case"http-fetch-exception":case"http-fetch-aborted":case"no-host":case"server-timeout":case"unspecified-http-error":case"media-not-found":case"download-throttled":case"request-error":case"max-attempts-exceeded":case"signature-expired":case"media-entry-invalid":return{error:e,shouldFallback:!1};case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":return{error:e,shouldFallback:!1}}}l.startDownloadFullSizeAndPreviewTask=C}),98);
__d("WAMediaManagerLogger",["WAHashUtils","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WATagsLogger").TAGS(["MediaManager"]);function s(t){var n=t.downloadKind,r=t.fullSizePlaintextHash,a=e.TAGS(["download","hash:"+o("WAHashUtils").sanitisePlaintextHash(r),n]);return a}function u(t){var n=t.plaintextHash,r=t.uploadKind,a=e.TAGS(["upload","hash:"+o("WAHashUtils").sanitisePlaintextHash(n),r]);return a}l.baseLogger=e,l.createDownloadLogger=s,l.createUploadLogger=u}),98);
__d("WAMediaManagerTypes",["WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.success?o("WAResultOrError").makeResult({serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.unvalidatedMimeType,validatedResult:e.value.validatedResult}):e}l.transformInternalMediaDownloadResult=e}),98);
__d("WAMediaManagerWorkerScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("MediaManager",{concurrency:16,maxTaskLimit:32,maxThrottleMs:3e4,timeoutMs:6e4})),e}l.mediaManagerWorkerScheduler=s}),98);
__d("WACreateRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("WAGetMediaRoute").getMediaRoute({operation:"upload",serverMediaType:e},t);if(!n.success)return n;var r=n.value,a=r.authToken,i=r.fallbackHost,l=r.selectedHost,s=new(o("WAMediaOperationsRetrier")).MediaOperationsRetrier("upload",{host:{domain:l.domain,class:l.class},fallbackHost:i&&{domain:i.domain,class:i.class},authToken:a,timeElapsed:null},o("WAComms").waitForConnection);return o("WAResultOrError").makeResult(s)}),s.apply(this,arguments)}l.createUploadRetrier=e}),98);
__d("WAHttpRegularUploadMedia",["WADirectPath","WALogger","WAResultOrError","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a;try{a=yield fetch(t,{method:"POST",mode:"cors",cache:"no-store",headers:{"Content-Type":"text/plain"},body:new Blob([n])})}catch(t){throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to initiate fetch ",""])),t),t}var i=a,l=i.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""])),l),l){case 200:return a.json().then(function(e){if(!Object.prototype.hasOwnProperty.call(e,"direct_path"))throw r("err")("direct_path not available in wa upload http response");if(typeof e.direct_path!="string")throw r("err")('directPath: "'+e.direct_path+'" is not a string');if(e.object_id&&typeof e.object_id!="string")throw r("err")('objectId: "'+e.object_id+'" is not a string');if(e.handle&&typeof e.handle!="string")throw r("err")('handle: "'+e.handle+'" is not a string');var t={directPath:o("WADirectPath").unsafeCastToDirectPath(e.direct_path),objectId:e.object_id,handle:e.handle};return o("WAResultOrError").makeResult(t)}).catch(function(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to parse request body ",""])),e),o("WAResultOrError").makeError("body-network-error")});case 408:return o("WAResultOrError").makeError("server-timeout");case 413:return o("WAResultOrError").makeError("payload-too-large");case 415:return o("WAResultOrError").makeError("invalid-media");case 429:case 507:return o("WAResultOrError").makeError("upload-throttled");default:return l>=400&&l<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}),d.apply(this,arguments)}l.httpRegularUploadMedia=c}),98);
__d("WAHttpResumeCheck",["WADirectPath","WALogger","WAMediaUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n;try{n=yield fetch(t,{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"text/plain"}})}catch(t){throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to initiate fetch ",""])),t),t}var r=n,a=r.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: response status ",""])),a),a){case 200:return n.json().then(function(e){var t=e.direct_path,n=e.object_id,r=e.resume;if(r==="complete")return t==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: direct_path is missing"]))),o("WAResultOrError").makeResult({type:"media-not-found"})):n==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: object_id is missing"]))),o("WAResultOrError").makeResult({type:"media-not-found"})):o("WAResultOrError").makeResult({type:"media-found",directPath:o("WADirectPath").unsafeCastToDirectPath(t),objectId:o("WAMediaUtils").stringToDeliveryObjectId(n)});var a=parseInt(r,10);return a===0?o("WAResultOrError").makeResult({type:"media-not-found"}):Number.isNaN(a)?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: resume is NaN: ",""])),r),o("WAResultOrError").makeResult({type:"media-not-found"})):o("WAResultOrError").makeResult({type:"media-partial-found",resumeFromBytes:a})}).catch(function(e){return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to parse request body ",""])),e),o("WAResultOrError").makeError("body-network-error")});case 404:return o("WAResultOrError").makeResult({type:"media-not-found"});case 408:return o("WAResultOrError").makeError("server-timeout");case 429:case 507:return o("WAResultOrError").makeError("upload-throttled");default:return a>=400&&a<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}),_.apply(this,arguments)}l.httpResumeCheck=p}),98);
__d("WAEncryptAndUploadPlaintext",["WABase64","WAErrorMessage","WAGlobals","WAHttpRegularUploadMedia","WAHttpResumeCheck","WALogger","WAMediaCrypto","WAMediaUrl","WAProgressiveJpegGetPJpegDetails","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r=t.fromOffset,a=r===void 0?0:r,i=t.mediaKey,l=t.mediaKeyTimestamp,f=t.mediaUploadFlow,g=t.plaintext,h=t.plaintextHash,y=t.serverMediaType,C=t.uploadRetrier,b=t.uploadToken;f.addPoint("encrypt_and_upload_plaintext_start"),f.addPoint("compute_media_keys_start");var v=y==="preview"?yield o("WAMediaCrypto").computeMediaKeysForPreview(i):yield o("WAMediaCrypto").computeMediaKeys(i,y),S=v.cipherKey,R=v.hmacKey,L=v.iv;f.addPoint("compute_media_keys_end"),f.addPoint("encrypt_and_hmac_start");var E=yield o("WAMediaCrypto").encryptAndHmac(S,L,R,g,y),k=E.ciphertext,I=E.ciphertextHash,T=E.ivCiphertextHmac,D=E.sidecar;f.addPoint("encrypt_and_hmac_end");var x=null;if(y==="image"){f.addPoint("get_progressive_jpeg_details_start");var $=yield o("WAProgressiveJpegGetPJpegDetails").getProgressiveJpegDetails(new Uint8Array(g),T,R),P=o("WAProgressiveJpegGetPJpegDetails").isValidProgressiveJpegDetails($);P.success===!1?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Created invalid progressiveJpeg details during encrypt and upload: ",""])),P.error),f.addPoint(P.error)):P.value===!0&&o("WAGlobals").getConfig().isProgressiveJpegSendEnabled()&&(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Found valid progressiveJpeg details. Adding to media entry."]))),x=$,f.addPoint("get_progressive_jpeg_details_end"))}var N={fileSha256:o("WABase64").decodeB64UrlSafe(h),fileEncSha256:I,mediaKey:i,mediaKeyTimestamp:l,serverMediaType:y,uploadToken:b,sidecar:D,progressiveJpegDetails:x,size:g.byteLength,filename:void 0,lastDownloadAttemptTimestamp:void 0,directPath:void 0},M,w=yield C.run((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=e.domain,i=a;if(n>0){f.addPoint("network_retry",{int:{network_retry_attempt:n}});try{f.addPoint("resume_check_start");var l=o("WAMediaUrl").buildUploadUrl(y,b,I,r,t,!0),s=yield o("WAHttpResumeCheck").httpResumeCheck(l);if(s.success){f.addPoint("resume_check_end");var p=s.value;if(p.type==="media-found")return f.addAnnotations({bool:{existingMediaFound:!0}}),o("WAResultOrError").makeResult(o("WAResultOrError").makeResult({directPath:p.directPath,objectId:null,handle:null}));p.type==="media-partial-found"&&(i=p.resumeFromBytes)}f.addPoint("resume_check_fail",{string:{resume_check_error:s.error}})}catch(e){f.addPoint("resume_check_fail",{string:{resume_check_error:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: error during retrier ",""])),e)}}i>0&&i<k.byteLength?(f.addAnnotations({int:{fromOffset:i},bool:{continuedFromOffset:!0}}),M=k.subarray(i)):M=k;var _=o("WAMediaUrl").buildUploadUrl(y,b,I,r,t,!1,i);return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: start upload media to ",""])),_),f.addPoint("http_upload_start"),o("WAHttpRegularUploadMedia").httpRegularUploadMedia(_,M).then(function(e){if(e.success)return f.addPoint("http_upload_end",{int:{attempt:n}}),o("WAResultOrError").makeResult(e);var t=e.error;switch(f.addPoint("http_upload_fail",{string:{http_upload_error:t}}),o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""])),t),t){case"server-timeout":case"unspecified-http-error":return o("WAResultOrError").makeError({progressMade:!0});default:return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(t))}}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return f.addPoint("http_upload_fail",{string:{http_upload_error:t}}),o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""])),t),o("WAResultOrError").makeError({progressMade:!1})})});return function(t,n,r){return e.apply(this,arguments)}})());if(w==null)return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded");if(w.success===!1)return w;var A=w.value,F=A.directPath,O=A.handle,B=A.objectId,W=babelHelpers.extends({},N,{directPath:F,handle:O,objectId:B});o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: upload success "," ",""])),{directPath:F},{objectId:B});var q="undefined";return B!=null&&(q=B.length>60?"new":"old"),f.addPoint("encrypt_and_upload_plaintext_end",{string:{object_id_type:q}}),o("WAResultOrError").makeResult(W)}),g.apply(this,arguments)}l.encryptAndUploadPlaintext=f}),98);
__d("WAUploadMediaQuick",["WACreateRetrier","WAEncryptAndUploadPlaintext","WAMediaUtils","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.logger,r=t.mediaUploadFlow,a=t.plaintext,i=t.plaintextHash,l=t.serverMediaType;n.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start uploadMediaQuick"]))),r.addPoint("create_upload_retrier_start");var s=yield o("WACreateRetrier").createUploadRetrier(l,r);if(!s.success)return r.addPoint("create_upload_retrier_fail"),s;r.addPoint("create_upload_retrier_end"),r.addPoint("create_media_key_start");var u=o("WAMediaUtils").createMediaKey(),c=o("WAMediaUtils").createUploadToken(),d=o("WATimeUtils").unixTime();r.addPoint("create_media_key_end");var m=yield o("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({mediaKey:u,mediaKeyTimestamp:d,serverMediaType:l,mediaUploadFlow:r,plaintext:a,plaintextHash:i,uploadRetrier:s.value,uploadToken:c});return m}),u.apply(this,arguments)}l.uploadMediaQuick=s}),98);
__d("mapWorkerSchedulerTask",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return babelHelpers.extends({},e,{promise:e.promise.then(t),run:function(){return e.run().then(t)}})}i.mapWorkerSchedulerTask=e}),66);
__d("WAMediaManager",["$InternalEnum","WADownloadFullSizeAndPreviewTask","WADownloadFullSizeOnlyTask","WADownloadPreviewOnlyTask","WAErrorMessage","WAHashUtils","WAMediaManagerCache","WAMediaManagerLogger","WAMediaManagerTypes","WAMediaManagerWorkerScheduler","WAResultOrError","WAUploadMediaQuick","WorkerScheduler","gkx","mapWorkerSchedulerTask","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S=n("$InternalEnum").Mirrored(["HIGH","MEDIUM","LOW"]);function R(){return{fullsizeCache:new Map,previewCache:new Map,uploadCache:new Map}}function L(t){var n=t.createCacheState,a=t.dbCallbacks,i=o("WAMediaManagerWorkerScheduler").mediaManagerWorkerScheduler(),l=o("WAMediaManagerCache").createAttachmentCache(a.getProtocolMsgIdAndSortOrderMs,n),v=function(n){var t=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"fullsize",fullSizePlaintextHash:n.fullSizePlaintextHash}),c=l.getFullsize(n);if(t.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),c.type),c.type==="cache-hit")return c.cache;var d=new AbortController,m=i.task({fn:function(){return o("WADownloadFullSizeOnlyTask").startDownloadFullSizeTask({abortSignal:d.signal,dbCallbacks:a,fullSizePlaintextHash:n.fullSizePlaintextHash,logger:t,mediaDownloadFlow:n.mediaDownloadFlow})},name:"media-manager-download-fullsize-only",priority:E(n.priority)}),p=m.run();return c.setDownloadCache({abortController:d,fullSizePlaintextHash:n.fullSizePlaintextHash,mediaDownloadFlow:n.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(m,function(e){return e.fullsizePromise})}),p.then(function(e){return e.fullsizePromise}).then(function(e){return x(n.fullSizePlaintextHash,e,c.setDownloadedAttachmentToUploadCache)}).catch(function(e){return r("vulture")("-KcmncnlVk3bH08uyEFarVxmbUY="),t.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){t.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["end"])))})},S=function(t){var e=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"preview",fullSizePlaintextHash:t.fullSizePlaintextHash}),n=l.getPreview(t);if(e.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",""])),n.type),n.type==="cache-hit")return n.cache;var r=new AbortController,s=i.task({fn:function(){return o("WADownloadPreviewOnlyTask").startDownloadPreviewTask({abortSignal:r.signal,dbCallbacks:a,fullSizePlaintextHash:t.fullSizePlaintextHash,logger:e,mediaDownloadFlow:t.mediaDownloadFlow})},name:"media-manager-download-preview-only",priority:E(t.priority)});n.setDownloadCache({abortController:r,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(s,function(e){return e.previewPromise})});var u=s.run();return u.then(function(e){return e.previewPromise}).then(function(e){return $(e,n.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["end"])))})},R=function(t){var e=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"fullsizeAndPreview",fullSizePlaintextHash:t.fullSizePlaintextHash}),n=l.getFullsizeAndPreview(t),r=n.fullsizeCacheResult,s=n.previewCacheResult;if(e.DEV(p||(p=babelHelpers.taggedTemplateLiteralLoose(["fullsize: ",", preview: ",""])),r.type,s.type),r.type==="cache-hit"&&s.type==="cache-hit")return{fullsizePromise:r.cache,previewPromise:s.cache};if(s.type==="cache-hit"){var u=v(t);return{fullsizePromise:u,previewPromise:s.cache}}if(r.type==="cache-hit"){var c=S(t);return{fullsizePromise:r.cache,previewPromise:c}}r.type,s.type;var d=new AbortController,m=i.task({fn:function(){return o("WADownloadFullSizeAndPreviewTask").startDownloadFullSizeAndPreviewTask({abortSignal:d.signal,dbCallbacks:a,fullSizePlaintextHash:t.fullSizePlaintextHash,logger:e,mediaDownloadFlow:t.mediaDownloadFlow})},name:"media-manager-download-fullsize-and-preview",priority:E(t.priority)});r.setDownloadCache({abortController:d,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(m,function(e){return e.fullsizePromise})}),s.setDownloadCache({abortController:d,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(m,function(e){return e.previewPromise})});var y=m.run();return{fullsizePromise:y.then(function(e){return e.fullsizePromise}).then(function(e){return x(t.fullSizePlaintextHash,e,r.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["fullsizePromise runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(f||(f=babelHelpers.taggedTemplateLiteralLoose(["fullsize end"])))}),previewPromise:y.then(function(e){return e.previewPromise}).then(function(e){return $(e,s.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["previewPromise runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["preview end"])))})}},L=function(t){var e=o("WAMediaManagerLogger").createUploadLogger({plaintextHash:t.plaintextHash,uploadKind:"fullsize"}),n;if(r("gkx")("19103")&&(n=l.getUploadedAttachment(t),e.DEV(y||(y=babelHelpers.taggedTemplateLiteralLoose(["cache result: ",""])),n.type),t.mediaUploadFlow.addAnnotations({string:{dedupe_result:n.type}}),n.type==="in-thread-cache-hit"))return n.cache;var a=o("WAUploadMediaQuick").uploadMediaQuick({logger:e,mediaUploadFlow:t.mediaUploadFlow,plaintext:t.plaintext,plaintextHash:t.plaintextHash,serverMediaType:t.serverMediaType}).catch(function(t){return e.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(b||(b=babelHelpers.taggedTemplateLiteralLoose(["upload end"])))});return n!=null&&r("gkx")("19103")&&n.setUploadCache({chatJid:t.chatJid,plaintextHash:t.plaintextHash,scheduledTask:a}),a};return{clearCache:l.clearCache,dequeueDownload:l.cancelTask,enqueueDownloadFullSize:T("fullsize",v),enqueueDownloadFullSizeAndPreview:T("fullsizeAndPreview",R),enqueueDownloadPreview:T("preview",S),enqueueUploadFullSize:D(L)}}function E(e){return e===S.HIGH?o("WorkerScheduler").BLOCKING_PRIORITY:e===S.MEDIUM?o("WorkerScheduler").REGULAR_PRIORITY:e===S.LOW?o("WorkerScheduler").BACKGROUND_PRIORITY:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}var k=typeof((v=navigator.storage)==null?void 0:v.getDirectory)=="function",I=typeof self.caches=="object";function T(e,t){return function(n){var r=n.fullSizePlaintextHash,a=n.mediaDownloadFlow;try{a.addPoint("enqueue_start",{bool:{isOPFSSupported:k,isWebCacheSupported:I},string:{downloadKind:e,sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var i=t(n);return a.addPoint("enqueue_end"),i}catch(e){throw a.addPoint("enqueue_fail"),e}}}function D(e){return function(t){var n=t.mediaUploadFlow,r=t.plaintextHash;try{n.addPoint("enqueue_start",{string:{sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var a=e(t);return n.addPoint("enqueue_end"),a}catch(e){throw n.addPoint("enqueue_fail"),e}}}function x(e,t,n){if(!t.success)return t;if(r("gkx")("19103")===!1)return o("WAMediaManagerTypes").transformInternalMediaDownloadResult(t);var a=t.value.msgIdAndMediaEntry,i=a[0],l=a[1];return n({mediaEntry:l,msgId:i,plaintextHash:e}),o("WAMediaManagerTypes").transformInternalMediaDownloadResult(t)}function $(e,t){if(!e.success)return e;if(r("gkx")("19103")===!1)return o("WAMediaManagerTypes").transformInternalMediaDownloadResult(e);var n=e.value.msgIdAndMediaEntry,a=n[0],i=n[1],l=i.downloadableThumbnail;return l==null||l.directPath==null||l.fileEncSha256==null||l.fileSha256==null||l.mediaKey==null||l.mediaKeyTimestamp==null||l.objectId==null||t({mediaEntry:babelHelpers.extends({},i,{directPath:l.directPath,downloadableThumbnail:null,fileSha256:l.fileSha256,mediaKey:l.mediaKey,mediaKeyTimestamp:l.mediaKeyTimestamp,objectId:l.objectId,serverMediaType:"preview",size:e.value.validatedResult.validatedPlaintext.byteLength}),msgId:a,plaintextHash:o("WAHashUtils").toPlaintextHash(l.fileSha256)}),o("WAMediaManagerTypes").transformInternalMediaDownloadResult(e)}l.MediaTaskPriority=S,l.createCacheState=R,l.createMediaManager=L,l.toWorkerSchedulerPriority=E}),98);
__d("WAMediaManagerCache",["Promise","WAErrorMessage","WAHashUtils","WAMediaManager","WAMediaManagerLogger","WAMediaManagerTypes","WAPromiseDelays","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["mediaKeyTimestamp","objectId","size"],s,u,c,d,m,p,_,f=3e4,g=1e3*60*60*24*2;function h(e,t){t===void 0&&(t=o("WAMediaManager").createCacheState);var r=t(),a=r.fullsizeCache,i=r.previewCache,l=r.uploadCache,h=function(t){var e=t.abortController,n=t.fullSizePlaintextHash,r=t.mediaDownloadFlow,i=t.scheduledTask;a.set(n,{abortController:e,mediaDownloadFlow:r,task:i}),i.promise.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(f):void 0}).finally(function(){a.delete(n)})},b=function(t){var e=t.abortController,n=t.fullSizePlaintextHash,r=t.mediaDownloadFlow,a=t.scheduledTask;i.set(n,{abortController:e,mediaDownloadFlow:r,task:a}),a.promise.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(f):void 0}).finally(function(){i.delete(n)})},v=function(t){var e=t.chatJid,n=t.plaintextHash,r=t.scheduledTask,a=t.cacheTtlMs,i=a===void 0?g:a,s=l.get(n)||new Map;s.set(e,r),l.set(n,s),r.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(i):void 0}).finally(function(){l.delete(n)})},S=function(r){var t=r.mediaEntry,a=r.msgId,i=r.plaintextHash;e(a).then(function(e){if(e==null){o("WAMediaManagerLogger").baseLogger.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["missing chatJid, skip setDownloadedAttachmentToUploadCache"])));return}var r=e.protocolMsgId.chat,a=C(t);if(a==null){o("WAMediaManagerLogger").baseLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["can not covert mediaEntry from download to upload for cache"])));return}var l=o("WATimeUtils").timeoutFor(a.mediaKeyTimestamp,g/1e3);if(l!==0){var c=o("WATimeUtils").pastUnixTime(o("WATimeUtils").DAY_SECONDS,a.mediaKeyTimestamp);o("WATimeUtils").isInFuture(c)||v({cacheTtlMs:l,chatJid:r,plaintextHash:i,scheduledTask:(_||(_=n("Promise"))).resolve(o("WAResultOrError").makeResult(a))})}}).catch(function(e){o("WAMediaManagerLogger").baseLogger.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["setDownloadedAttachmentToUploadCache getProtocolMsgIdAndSortOrderMs: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e))})};return{cancelTask:function(t){var e=o("WAMediaManagerLogger").baseLogger.TAGS(["hash:"+o("WAHashUtils").sanitisePlaintextHash(t),"cancelTask"]);e.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["start"])));var n=[a,i];for(var r of n){var l=r.get(t);if(l!=null){var s=l.task.cancel();l.mediaDownloadFlow.addPoint("cancel_download_triggered"),s===!1?(l.abortController.abort(),l.mediaDownloadFlow.addPoint("http_abort_cancel"),e.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["http abort cancel"])))):(l.mediaDownloadFlow.addPoint("worker_task_cancel_cancel"),e.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["worker task cancel"])))),r.delete(t)}}},clearCache:function(){i.clear(),a.clear(),l.clear()},getFullsize:function(t){var e=a.get(t.fullSizePlaintextHash);return e!=null?(y(t.mediaDownloadFlow,"hit","fullsize"),e.task.promote(o("WAMediaManager").toWorkerSchedulerPriority(t.priority)),{cache:e.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}):(y(t.mediaDownloadFlow,"miss","fullsize"),{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"})},getFullsizeAndPreview:function(t){var e=o("WAMediaManager").toWorkerSchedulerPriority(t.priority),n=a.get(t.fullSizePlaintextHash),r=i.get(t.fullSizePlaintextHash);return n!=null&&r!=null?(y(t.mediaDownloadFlow,"hit","fullsize-and-preview"),n.task.promote(e),r.task.promote(e),{fullsizeCacheResult:{cache:n.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"},previewCacheResult:{cache:r.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}}):n!=null?(y(t.mediaDownloadFlow,"hit","fullsize"),n.task.promote(e),{fullsizeCacheResult:{cache:n.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"},previewCacheResult:{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"}}):r!=null?(y(t.mediaDownloadFlow,"hit","preview"),r.task.promote(e),{fullsizeCacheResult:{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"},previewCacheResult:{cache:r.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}}):(y(t.mediaDownloadFlow,"miss","fullsize-and-preview"),{fullsizeCacheResult:{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"},previewCacheResult:{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"}})},getPreview:function(t){var e=i.get(t.fullSizePlaintextHash);return e!=null?(y(t.mediaDownloadFlow,"hit","preview"),e.task.promote(o("WAMediaManager").toWorkerSchedulerPriority(t.priority)),{cache:e.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}):(y(t.mediaDownloadFlow,"miss","preview"),{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"})},getUploadedAttachment:function(t){var e=l.get(t.plaintextHash);if(e==null)return{setUploadCache:v,type:"cache-miss-no-plaintext-hash"};var n=e.get(t.chatJid);return n==null?{setUploadCache:v,type:"cache-miss-no-thread"}:{cache:n,type:"in-thread-cache-hit"}}}}function y(e,t,n){e.addAnnotations({string:{media_manager_cache_result:t,media_manager_cache_type:n}})}function C(t){var n=t.mediaKeyTimestamp,r=t.objectId,o=t.size,a=babelHelpers.objectWithoutPropertiesLoose(t,e);return n==null||r==null||o==null?null:babelHelpers.extends({},a,{mediaKeyTimestamp:n,objectId:r,size:o})}l.DOWNLOAD_TASK_CACHE_TTL_MS=f,l.UPLOAD_TASK_CACHE_TTL_MS=g,l.createAttachmentCache=h}),98);
__d("blobToDataUri",["Promise","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var o=new FileReader,a=new(e||(e=n("Promise")))(function(e,t){o.onloadend=e,o.onerror=t});o.readAsDataURL(t),yield a;var i=o.result;if(typeof i!="string")throw r("err")('Unexpected result type "%s" when reading Blob as DataURL.',i instanceof ArrayBuffer?"ArrayBuffer":typeof i);return i}),u.apply(this,arguments)}l.default=s}),98);
__d("MAWGetThumbnailBlobDataUrlByMediaIdApi",["MAWCreateMaybeAddPointForMediaRender","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWIndexedDb","MAWMaybeWithTimeout","MAWMediaManager","MAWMediaPreviewDownloadManager","MAWMpsGating","MAWTransactionMode","MWFBLogger","MpsMediaEntryCache","Promise","WAErrorMessage","WAHashUtils","WAMediaManager","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime","blobToDataUri"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x=o("MWFBLogger").MWMediaLogger().tags(["getThumbnailBlobDataUrlByMediaId"]),$=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a){x.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from , from ",""])),t,n);var i=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(a),l={string:{description:n,fetch_by:"mediaId"}};i("fetch_thumbnail_blob_api_start",l),i("get_media_from_db_start",l);var g=yield w(t);if(i("get_media_from_db_finish",{bool:{db_media_found:g!=null}}),g==null)throw x.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No media found for ",""])),t),i("fetch_thumbnail_blob_api_fail_no_media_found_in_db",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because media is not in the media db. mediaId is %s, from %s",t,n);var h=F(g);if(h.success===!0){x.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Found jpegThumbnail entry for ",""])),t),i("fetch_thumbnail_blob_api_success",l);var y=yield r("blobToDataUri")(h.value);if(!y)throw x.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),t),i("fetch_thumbnail_blob_api_fail_no_data_uri",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",t,n);return x.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),t),y}var C=h.error;switch(C){case"missing_jpeg_thumbnail":if(g.mediaType===o("MAWDbMedia").MEDIA_TYPE.IMAGE||g.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO){var b=yield N(g,a);if(b!=null){i("fetch_thumbnail_blob_api_success",l);var v=yield r("blobToDataUri")(b);if(!v)throw x.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),t),i("fetch_thumbnail_blob_api_fail_no_data_uri",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",t,n);return x.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),t),v}if((g==null?void 0:g.mediaType)===o("MAWDbMedia").MEDIA_TYPE.VIDEO)throw i("fetch_thumbnail_blob_api_fail_not_able_to_generate_video_thumbnail_on_the_fly",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time (for video). mediaId is %s, from %s",t,n);var S=yield M(g,a);if(S==null)throw i("fetch_thumbnail_blob_api_fail_not_able_to_generate_image_thumbnail_on_the_fly",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time or to generate thumnbail on the fly. mediaId is %s, from %s",t,n);i("fetch_thumbnail_blob_api_success",l);var R=yield r("blobToDataUri")(S);if(!R)throw x.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),t),i("fetch_thumbnail_blob_api_fail_no_data_uri",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",t,n);return x.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),t),R}throw i("fetch_thumbnail_blob_api_fail_missing_thumbnail",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media (missing_jpeg_thumbnail). mediaId is %s, from %s",t,n);case"invalid_media":throw i("fetch_thumbnail_blob_api_fail_invalid_media",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media. mediaId is %s, from %s",t,n)}});return function(n,r,o){return t.apply(this,arguments)}})(),P=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=o("MpsMediaEntryCache").getEntry(e)!=null&&o("MAWMpsGating").isMpsMediaGalleryEnabled(),i=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(n),l={bool:{shouldUseMpsGalleryAndMpsMediaManager:a},string:{description:t,fetch_by:"hashedPlaintextHash"}};if(i("fetch_thumbnail_blob_api_start",l),x.DEBUG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from ",""])),o("WAHashUtils").sanitisePlaintextHash(e),t),o("MAWMpsGating").isMpsMessageRendering()||a){var s=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"UILayout",msgType:null,protocolMsgId:null,triggerUIView:null}),u=a?o("MAWMediaManager").getMpsMediaManager():o("MAWMediaManager").getMawMediaManager(),c=u.enqueueDownloadFullSizeAndPreview({fullSizePlaintextHash:e,mediaDownloadFlow:s,priority:o("WAMediaManager").MediaTaskPriority.HIGH}),d=yield c.previewPromise;if(d.success){var m;s.endSuccess();var p=d.value.validatedResult.validatedPlaintext,_=new Blob([p],{type:(m=d.value.validatedResult.mimeType)!=null?m:void 0}),f=yield r("blobToDataUri")(_);return f}if(d.error!=="preview-not-supported")throw s.endFail(d.error,{string:{failReason:d.error}}),o("MWFBLogger").MPSLogger().mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",o("WAHashUtils").sanitisePlaintextHash(e),t,d.error);var E=yield c.fullsizePromise;if(E.success){var k;s.endSuccess();var I=E.value.validatedResult.validatedPlaintext,T=new Blob([I],{type:(k=E.value.validatedResult.mimeType)!=null?k:void 0}),D=yield r("blobToDataUri")(T);return D}throw s.endFail(E.error,{string:{failReason:E.error}}),o("MWFBLogger").MPSLogger().mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",o("WAHashUtils").sanitisePlaintextHash(e),t,E.error)}var $=yield A(e);if($==null)throw x.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No media found for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),i("fetch_thumbnail_blob_api_fail_no_media_found_in_db",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash because media is not in the media db. plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t);var P=F($);if(P.success===!0){x.DEBUG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Found jpegThumbnail entry for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),i("fetch_thumbnail_blob_api_success",l);var w=yield r("blobToDataUri")(P.value);if(!w)throw x.MUSTFIX(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),i("fetch_thumbnail_blob_api_fail_no_data_uri",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t);return x.DEBUG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),w}var O=P.error;switch(O){case"missing_jpeg_thumbnail":if($.mediaType===o("MAWDbMedia").MEDIA_TYPE.IMAGE||$.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO){var B=yield N($,n);if(B!=null){i("fetch_thumbnail_blob_api_success",l);var W=yield r("blobToDataUri")(B);if(!W)throw x.MUSTFIX(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),i("fetch_thumbnail_blob_api_fail_no_data_uri",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t);return x.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),W}if(($==null?void 0:$.mediaType)===o("MAWDbMedia").MEDIA_TYPE.VIDEO)throw i("fetch_thumbnail_blob_api_fail_not_able_to_generate_video_thumbnail_on_the_fly",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash in time (for video). plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t);var q=yield M($,n);if(q==null)throw i("fetch_thumbnail_blob_api_fail_not_able_to_generate_image_thumbnail_on_the_fly",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash in time or to generate thumnbail on the fly. plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t);var U=yield r("blobToDataUri")(q);if(!U)throw x.MUSTFIX(R||(R=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),i("fetch_thumbnail_blob_api_fail_no_data_uri",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t);return x.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),o("WAHashUtils").sanitisePlaintextHash(e)),U}throw i("fetch_thumbnail_blob_api_fail_missing_thumbnail",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media (missing_jpeg_thumbnail). plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t);case"invalid_media":throw i("fetch_thumbnail_blob_api_fail_invalid_media",l),x.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media. plaintextHash is %s, from %s",o("WAHashUtils").sanitisePlaintextHash(e),t)}});return function(n,r,o){return e.apply(this,arguments)}})(),N=function(t,r){var e=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(r);e("fetch_thumbnail_blob_api_thumbnail_download_start");var a=o("MAWMediaPreviewDownloadManager").getMediaPreviewDownloadingResolvable(t.plaintextHash);return a==null?(e("fetch_thumbnail_blob_api_thumbnail_download_fail_no_resolvable"),(D||(D=n("Promise"))).resolve(null)):o("MAWMaybeWithTimeout").maybeWithTimeout(a.promise,1e4,function(){throw x.mustfixThrow("timeout waiting for thumbnail to download")}).then(function(t){return e("fetch_thumbnail_blob_api_thumbnail_download_success"),t}).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return x.MUSTFIX(E||(E=babelHelpers.taggedTemplateLiteralLoose(["Exception when waiting for thumbnail to download: ",""])),n),e("fetch_thumbnail_blob_api_thumbnail_download_fail_exception",{string:{wait_for_thumbnail_download_exception:n}}),null})},M=o("MAWIndexedDb").makeMsgrTransactor({chunk:(T=o("MAWTransactionMode")).READONLY,media:T.READONLY},"generateThumbnailFromMediaChunk",function(e){return function(t,n){var r=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(n);return r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_start"),o("MAWDbChunkTxns").maybeGetChunkFromHash(e,t.hashedPlaintextHash).then(function(e){if(e==null){x.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: unable to get a thumbnail as the media chunk is missing"]))),r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_fail_chunk_missing");return}return x.WARN(I||(I=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: using media chunk as the thumbnail"]))),r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_success"),new Blob([e.blobData],{type:e.mimetype})})}}),w=o("MAWIndexedDb").makeMsgrTransactor({media:T.READONLY},"getFullMedia",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t)}}),A=o("MAWIndexedDb").makeMsgrTransactor({media:T.READONLY},"getFullMedia",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,t)}}),F=function(t){var e=O(t);if(e.success===!1)return e;var n=e.value.jpegThumbnail;return n!=null?o("WAResultOrError").makeResult(new Blob([n],{type:"image/jpeg"})):o("WAResultOrError").makeError("missing_jpeg_thumbnail")},O=function(t){var e,n;switch(t.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return o("WAResultOrError").makeResult({jpegThumbnail:(e=t.validatedImageInfo)==null?void 0:e.jpegThumbnail});case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return o("WAResultOrError").makeResult({jpegThumbnail:(n=t.validatedVideoInfo)==null?void 0:n.jpegThumbnail});case o("MAWDbMedia").MEDIA_TYPE.PTT:case o("MAWDbMedia").MEDIA_TYPE.STICKER:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return o("WAResultOrError").makeError("invalid_media");default:return t.mediaType,o("WAResultOrError").makeError("invalid_media")}};l.getThumbnailBlobDataUrlByMediaId=$,l.getThumbnailBlobDataUrlByHashedPlaintextHash=P,l.getFullMediaWithPlaintextHash=A}),98);
__d("MAWMediaManager",["MAWGetMostRescentDecodedMediaEntry","MAWGetProtocolMsgIdAndSortOrderMsApi","MAWMpsGating","MpsMediaManager","WAMediaManager","memoize"],(function(t,n,r,o,a,i,l){"use strict";var e=r("memoize")(function(){return o("WAMediaManager").createCacheState()}),s=r("memoize")(function(){return o("MpsMediaManager").getMpsMediaManager(e)}),u=r("memoize")(function(){return o("WAMediaManager").createMediaManager({createCacheState:e,dbCallbacks:{getMediaEntries:o("MAWGetMostRescentDecodedMediaEntry").getMediaEntries,getProtocolMsgIdAndSortOrderMs:o("MAWGetProtocolMsgIdAndSortOrderMsApi").getProtocolMsgIdAndSortOrderMs}})}),c=function(){return o("MAWMpsGating").isMpsMessageRendering()?s():u()};l.getMpsMediaManager=s,l.getMawMediaManager=c}),98);
__d("WmiChunkApi",["CoalescingLoader","MAWDbChunkTxns","MAWDexieTable","MAWIndexedDb","MAWMediaUtils","MAWTransactionMode","asyncToGeneratorRuntime","emptyFunction","memoizeWithArgsLFUCache"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READONLY},"wms_getCachedChunkResult",function(e){return function(t){return o("MAWDbChunkTxns").maybeBulkGetChunksFromPlaintextHash(e,t)}}),a=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READWRITE},"wms_storeChunk",function(t){return function(n){return n.map(function(t){return e(t[0])}),o("MAWDexieTable").dexieAll(n.map(function(e){return o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(t,e[0],e[1],e[2],e[3])})).then(r("emptyFunction"))}}),i=new(o("CoalescingLoader")).CoalescingLoader((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=yield t(n);return n.map(function(t){var n=r.get(t);return n==null&&e(t),n})});return function(e){return r.apply(this,arguments)}})()),l=new(o("CoalescingLoader")).CoalescingLoader((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return yield a(e),[]});return function(t){return e.apply(this,arguments)}})()),s=r("memoizeWithArgsLFUCache")(function(e){return i.gen(e)},function(e){return e},1,function(t){e=t}),u=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READWRITE},"wms_deleteChunk",function(t){return function(n){n.map(e);var r=n.map(o("MAWMediaUtils").genHMACPlaintextHash);return t.chunk.where("hashedPlaintextHash").anyOf(r).delete()}});return{delete:u,get:s,store:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return l.gen(t)}}}l.getChunkApi=e}),98);
__d("MediaServiceLogger",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return r("FBLogger")("wmi_media_service",t)};l.MediaServiceLogger=e}),98);
__d("WmiMediaServiceSchema",["MAWWormOdsLogger","MediaServiceLogger","WAHex","Worm","WormEAR","WormIDbDriver","WormMemoryDriver"],(function(t,n,r,o,a,i,l){"use strict";var e={autoIncrement:!0,indexes:{"[plaintextHash+updatedAtMs]":{fields:["plaintextHash","updatedAtMs"],unique:!1},"[threadId+messageId+plaintextHash]":{fields:["threadId","messageId","plaintextHash"],unique:!0}},nonEncryptedFields:["updatedAtMs","messageId"],primaryKey:"pk",secure:!0},s={messageChunk:e};function u(e){var t=e.blockingErrorThreshold,n=e.dbName,r=e.onBlockingError,a=e.qplEvent,i=e.strEncKey,l=o("WAHex").parseHex(i),u="wmi_media_service",c=new(o("WormEAR")).WormEAR(s,u,l),d=new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(n,u,s,c,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:t,onBlockingError:r,onTransactionError:function(t){if(t instanceof o("WormEAR").DecryptionError){var e=t;o("MediaServiceLogger").MediaServiceLogger().mustfix("EAR decryption error in store: %s. Dropping corrupted entity %s",e.store,e.maybeHashedPk),d.runInTransaction([e.store],"readwrite",function(t){var n=t.stores[e.store];return e.maybeHashedPk!=null?n.delete(e.maybeHashedPk):n.clear()},"delete-corrupted-entity")}}}),a);return d}function c(e){return new(o("Worm")).WormDatabase(new(o("WormMemoryDriver")).WormMemoryDriver("wmi_media_service_test",s,o("MAWWormOdsLogger").wormOdsWorkerLogger),e)}l.SCHEMA=s,l.makeSchema=u,l.makeInMemorySchema_TEST_ONLY=c}),98);
__d("WmiMediaServiceDb",["MediaServiceLogger","WAResolvable","WmiMediaServiceSchema","asyncToGeneratorRuntime","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){try{var n=o("WmiMediaServiceSchema").makeSchema(t);return e=n,yield n.init(),s.resolve(n),n}catch(e){throw o("MediaServiceLogger").MediaServiceLogger().catching(r("getErrorSafe")(e)).mustfix("Error performing Media Service init"),e}}),c.apply(this,arguments)}function d(){if(e==null)throw r("err")("DB is not initialized");return e}l.makeMediaServiceDb=u,l.getDb=d}),98);
__d("WmiMediaServiceDownloadQueue",["WormPersistedQueue","WormPersistedQueueSchema"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WormPersistedQueueSchema").toWormPersistedQueueId(e)}var s=null;function u(){return s==null&&(s=new(o("WormPersistedQueue")).WormPersistedQueue("mediaDownloadQueue")),s}l.generateDownloadQueueId=e,l.getDownloadQueue=u}),98);
__d("WmiMediaService",["MpsTypes","WmiChunkApi","WmiMediaServiceDb","WmiMediaServiceDownloadQueue","asyncToGeneratorRuntime","err","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e){this.$1=e,this.$2=o("WmiChunkApi").getChunkApi()}var t=e.prototype;return t.enqueueMediaDownload=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){yield o("WmiMediaServiceDownloadQueue").getDownloadQueue().put(e.map(function(e){return{attemptCount:0,queueId:o("WmiMediaServiceDownloadQueue").generateDownloadQueueId(e)}}))});function t(t){return e.apply(this,arguments)}return t})(),t.getChunk=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=yield this.$2.get(e);return n==null?null:{blobData:n.blobData,isProgressivePreview:(t=n.isProgressivePreview)!=null?t:!1,mimetype:n.mimetype,plaintextHash:n.plaintextHash}});function t(t){return e.apply(this,arguments)}return t})(),t.getMessageChunkForHash=function(t){return this.$1.runInTransaction(["messageChunk"],"readonly",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=yield e.stores.messageChunk.readIndexRange("[plaintextHash+updatedAtMs]",{only:[t]},{limit:1,order:"desc"});return n.at(0)});return function(t){return e.apply(this,arguments)}})(),"WmiGetMessagesForHash")},t.handleMessageDeletion=function(t,n){return this.$3(function(e){return e.stores.messageChunk.readIndexRange("[threadId+messageId+plaintextHash]",{only:[t,n]})})},t.handleThreadDeletion=function(t){return this.$3(function(e){return e.stores.messageChunk.readIndexRange("[threadId+messageId+plaintextHash]",{only:[t]})})},t.storeChunk=function(t){var e=t.blobData,n=t.isProgressivePreview,r=t.mimetype,o=t.plaintextHash;return this.$2.store(o,e,r,n)},t.storeMessageChunks=function(t){return this.$1.runInTransaction(["messageChunk"],"readwrite",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){yield e.stores.messageChunk.bulkUpsert("[threadId+messageId+plaintextHash]",t.map(function(e){return{item:{messageId:e.messageId,plaintextHash:e.plaintextHash,threadId:e.threadId,updatedAtMs:o("MpsTypes").toTimestamp(Date.now())},selector:[e.threadId,e.messageId,e.plaintextHash]}}))});return function(t){return e.apply(this,arguments)}})(),"WmiMediaServiceStoreChunkMessage")},t.$3=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield this.$1.runInTransaction(["messageChunk"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield e(t);yield t.stores.messageChunk.bulkDelete(n.map(function(e){return e.pk}));var r=new Set(n.map(function(e){return e.plaintextHash})),o=yield t.stores.messageChunk.readIndexAnyOf("[plaintextHash+updatedAtMs]",Array.from(r).map(function(e){return[e]}));return o.forEach(function(e){return r.delete(e.plaintextHash)}),Array.from(r)});return function(e){return t.apply(this,arguments)}})(),"WmiMediaServiceDeleteMessageChunkEntries");t.length>0&&(yield this.$2.delete(Array.from(t)))});function t(t){return e.apply(this,arguments)}return t})(),e})(),s=null;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(s!=null)throw r("err")("Media Service already initialised");var n=yield o("WmiMediaServiceDb").makeMediaServiceDb(t);s=new e(n)}),c.apply(this,arguments)}function d(){return r("nullthrows")(s,"Media Service not initialised")}function m(){s=null}l.MediaService=e,l.wmiMediaServiceSetup=u,l.mediaService=d,l.wmiMediaServiceClear__TESTONLY=m}),98);
__d("MpsMediaManager",["MAWGetThumbnailBlobDataUrlByMediaIdApi","MpsMediaEntryCache","MpsMessageToBridgeWrapper","MpsToBridgeMessageId","Promise","WAIsPreviewSupported","WAJids","WAMediaManager","WAMediaManagerCache","WAMediaUtils","WAResultOrError","WAStanzaUtils","WAValidateMedia","WebMps","WmiMediaService","asyncToGeneratorRuntime","getErrorSafe","memoize","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=["kind"],s;function u(e){throw new TypeError('"'+e+'" is read-only')}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.fullSizePlaintextHash,n=e.mediaDownloadFlow,r=o("MpsMediaEntryCache").getEntry(t);if(r!=null)return n.addPoint("media_entry_cache_hit"),r;var a=yield o("WmiMediaService").mediaService().getMessageChunkForHash(t);if(a==null){n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"missing_message_chunk"}});return}var i=yield o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"MpsMediaManager-getEntryWithFallback"},messageId:a.messageId,threadId:a.threadId}),l=i.value;if(l==null){n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"missing_reverb_message"}});return}o("MpsMediaEntryCache").hydrateCache(l.toplevelProtobuf);var s=o("MpsMediaEntryCache").getEntry(t);return s==null?(n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"unable_to_cache"}}),null):(n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"success"}}),s)}),d.apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("MpsToBridgeMessageId").bridgeMsgIdToMps(e),n=t.messageId,r=t.threadId,a=yield o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-first"},debug:{purpose:"mps_media_manager"},messageId:n,threadId:r});if(a.value){var i=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.value.toplevelProtobuf),l=i.getAuthor();if(!o("WAJids").isAuthorSystem(l))return{protocolMsgId:{author:l,chat:i.getChatJid(),externalId:o("WAStanzaUtils").toStanzaId(i.getExternalId())},sortOrderMs:i.message.timestampMs}}}),p.apply(this,arguments)}var _=function(t){return o("WAMediaManager").createMediaManager({createCacheState:t,dbCallbacks:{getMediaEntries:function(t){var e=o("MpsMediaEntryCache").getEntry(t);if(e==null)return(s||(s=n("Promise"))).resolve(o("WAResultOrError").makeError("no-media-by-plaintext-hash"));var r=e.mediaEntry,a=e.message,i=o("MpsToBridgeMessageId").mpsToBridgeMsgId(a.threadId,a.messageId);return(s||(s=n("Promise"))).resolve(o("WAResultOrError").makeResult(new Map([[i,r]])))},getProtocolMsgIdAndSortOrderMs:m}})};function f(e){var t=o("WAIsPreviewSupported").checkPreviewSupport(e.decodedMediaEntry),n=t[0],r=t[1];return(function(t){if(Array.isArray(t)&&t.length===2&&t[0]===o("WAIsPreviewSupported").PjpegPreviewSupport.YES)return{kind:"progressive",thumbnailHash:e.plaintextHash};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.YES)return e.thumbnailHash!=null?{kind:"withThumbnail",thumbnailHash:e.thumbnailHash}:{kind:"noPreview"};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.DuplicatedWithFullSize)return{kind:"duplicatedWithFullSize",thumbnailHash:e.plaintextHash};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return{kind:"noPreview"};throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+t)})([n,r])}function g(e,t,n){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){if(e!=null){var r=yield o("WAValidateMedia").validateMedia(e,t);if(r.value!=null)return o("WAResultOrError").makeResult({serverMediaType:n,unvalidatedMimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(n),validatedResult:r.value})}}),h.apply(this,arguments)}function y(e,t,n){return C.apply(this,arguments)}function C(){return C=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield o("WmiMediaService").mediaService().getChunk(e),a=yield g(r==null?void 0:r.blobData,t,n);if(!(r==null||a==null))return t.addAnnotations({bool:{from_chunk:!0}}),{chunk:r,result:a}}),C.apply(this,arguments)}function b(e,t,n,a){if(n.success===!0){var i;o("WmiMediaService").mediaService().storeChunk({blobData:n.value.validatedResult.validatedPlaintext,isProgressivePreview:a,mimetype:(i=n.value.validatedResult.mimeType)!=null?i:n.value.unvalidatedMimeType,plaintextHash:e}).then(function(){return t.addAnnotations({string:{chunk_store_result:"success"}})}).catch(function(e){var n=r("getErrorSafe")(e).message;t.addAnnotations({string:{chunk_store_result:n}})})}}function v(e,t,n){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r,a=n.fullSizePlaintextHash,i=n.mediaDownloadFlow;if(e.success||e.error!=="signature-expired")return e;var l=yield o("MAWGetThumbnailBlobDataUrlByMediaIdApi").getFullMediaWithPlaintextHash(a);if(l==null)return i.addAnnotations({string:{signature_expired_fallback:"media not found"}}),e;var s=(r=l.validatedAudioInfo)!=null?r:l.validatedVideoInfo,u=s==null?void 0:s.jpegThumbnail;if(u==null)return i.addAnnotations({string:{signature_expired_fallback:"thumbnail not found"}}),e;var c=yield o("WAValidateMedia").validateMedia(u,i);return c.value==null?(i.addAnnotations({string:{signature_expired_fallback:"validation failed"}}),e):(i.addAnnotations({string:{signature_expired_fallback:"success"}}),o("WAResultOrError").makeResult({serverMediaType:t.serverMediaType,unvalidatedMimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType("image"),validatedResult:c.value}))}),S.apply(this,arguments)}var R=function(a){var t=_(a),i=o("WAMediaManagerCache").createAttachmentCache(m,a),l={clearCache:t.clearCache,dequeueDownload:t.dequeueDownload,enqueueDownloadFullSize:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){e.mediaDownloadFlow.addAnnotations({string:{downloadKind:"fullsize"}});var n=i.getFullsize(e);if(n.type==="cache-hit")return n.cache;var r=yield c(e);if(!r)return o("WAResultOrError").makeError("missing-media-entry");var a=yield y(e.fullSizePlaintextHash,e.mediaDownloadFlow,r.serverMediaType);if(a!=null&&!a.chunk.isProgressivePreview)return a.result;e.mediaDownloadFlow.addPoint("mps_actual_download");var l=yield t.enqueueDownloadFullSize(e);return b(e.fullSizePlaintextHash,e.mediaDownloadFlow,l,!1),l});function r(t){return e.apply(this,arguments)}return r})(),enqueueDownloadFullSizeAndPreview:function(l){l.mediaDownloadFlow.addAnnotations({string:{downloadKind:"fullsizeAndPreview"}});var a=i.getFullsizeAndPreview(l),s=a.fullsizeCacheResult,u=a.previewCacheResult;if(s.type==="cache-hit"&&u.type==="cache-hit")return{fullsizePromise:s.cache,previewPromise:u.cache};var d=r("memoize")(function(){return c(l)}),m=r("memoize")(n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=r("nullthrows")(yield d()),t=y(l.fullSizePlaintextHash,l.mediaDownloadFlow,e.serverMediaType);return t}));l.mediaDownloadFlow.addPoint("mps_actual_download");var p=r("memoize")(function(){return t.enqueueDownloadFullSizeAndPreview(l)});return{fullsizePromise:n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield d();if(e==null)return o("WAResultOrError").makeError("missing-media-entry");var t=yield m();if(t!=null&&!t.chunk.isProgressivePreview)return t.result;var n=yield p().fullsizePromise;return b(l.fullSizePlaintextHash,l.mediaDownloadFlow,n,!1),n})(),previewPromise:n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield d();if(t==null)return o("WAResultOrError").makeError("missing-media-entry");var n=f(t);if(n.kind==="noPreview")return o("WAResultOrError").makeError("preview-not-supported");var r=yield(function(n){if((typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="duplicatedWithFullSize"||(typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="progressive")return m();if((typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="withThumbnail"){var r=n.kind,o=babelHelpers.objectWithoutPropertiesLoose(n,e);return y(o.thumbnailHash,l.mediaDownloadFlow,t.serverMediaType)}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n)})(n);if(r!=null)return r.result;var a=yield p().previewPromise,i=yield v(a,t,l);return n.kind==="withThumbnail"&&b(n.thumbnailHash,l.mediaDownloadFlow,i,!1),i})()}},enqueueDownloadPreview:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){e.mediaDownloadFlow.addAnnotations({string:{downloadKind:"preview"}});var n=i.getPreview(e);if(n.type==="cache-hit")return n.cache;var r=yield c(e);if(r==null)return o("WAResultOrError").makeError("missing-media-entry");var a=f(r),l=a.kind==="progressive";if(a.kind==="noPreview")return o("WAResultOrError").makeError("preview-not-supported");var s=a.thumbnailHash,u=yield y(s,e.mediaDownloadFlow,r.serverMediaType);if(u!=null)return u.result;e.mediaDownloadFlow.addPoint("mps_actual_download");var d=yield t.enqueueDownloadPreview(e),m=yield v(d,r,e);return b(s,e.mediaDownloadFlow,m,l),m});function r(t){return e.apply(this,arguments)}return r})(),enqueueUploadFullSize:function(){return t.enqueueUploadFullSize.apply(t,arguments)}};return l};l.getMpsMediaManager=R}),98);
__d("MAWTraceUtils",["LSDataTraceTag","LSRequestId","MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";var e="backup_upload",s="media_backup",u="vesta_registration",c="vesta_login";function d(){return r("LSRequestId").generate()}function m(e){return e}function p(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("LSDataTraceTag").messageTypeText;case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return o("LSDataTraceTag").messageTypeFutureproof;case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return o("LSDataTraceTag").messageTypeCiphertext;case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:return o("LSDataTraceTag").messageTypeUnavailable;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("LSDataTraceTag").messageTypeImage;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("LSDataTraceTag").messageTypeVideo;case o("MAWMsgType").MSG_TYPE.PTT:return o("LSDataTraceTag").messageTypePtt;case o("MAWMsgType").MSG_TYPE.ADMIN:return o("LSDataTraceTag").messageTypeAdmin;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("LSDataTraceTag").messageTypeRevoked;case o("MAWMsgType").MSG_TYPE.GIF:return o("LSDataTraceTag").messageTypeGif;case o("MAWMsgType").MSG_TYPE.STICKER:return o("LSDataTraceTag").messageTypeSticker;case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:return o("LSDataTraceTag").messageTypeExpiredEphemeral;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("LSDataTraceTag").messageTypeEphemeralSettingAdmin;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("LSDataTraceTag").messageTypeEphemeralSyncResponse;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return o("LSDataTraceTag").messageTypeEphemeralScreenshotAction;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("LSDataTraceTag").messageTypeDeleteForMe;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:return o("LSDataTraceTag").messageTypeEphemeralSettingChangeFromCurrentDevice;case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:return o("LSDataTraceTag").messageTypeAlertICDC;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("LSDataTraceTag").messageTypeGroupInvite;case o("MAWMsgType").MSG_TYPE.XMA:return o("LSDataTraceTag").messageTypeXMA;case o("MAWMsgType").MSG_TYPE.REACTION:return o("LSDataTraceTag").messageTypeReaction;case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return o("LSDataTraceTag").messageTypeSenderKeyDistribution;default:return o("LSDataTraceTag").messageTypeNone}}l.CONTEXT_BACKUP_UPLOAD=e,l.CONTEXT_MEDIA_BACKUP=s,l.CONTEXT_VESTA_REGISTRATION=u,l.CONTEXT_VESTA_LOGIN=c,l.createTraceId=d,l.stringToTraceId=m,l.getTagForMsgType=p}),98);
__d("WACryptoCurve25519Dependencies",["Promise","WACryptoPrimitives","WASignalKeys","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return(e||(e=n("Promise"))).resolve().then(function(){return o("WASignalKeys").makeKeyPair()})}function u(t,r){return(e||(e=n("Promise"))).resolve().then(function(){return o("WACryptoPrimitives").scalarMult(o("WASignalOther").ensureSize(r,32),o("WASignalOther").ensureSize(t,32)).buffer})}var c={generateIdentityKeyPair:s,calculateAgreement:u};l.calculateAgreement=u,l.CURVE25519_SIGNAL_DEPENDENCIES=c}),98);
__d("WASmaxInPreKeysIQErrorItemNotFoundMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","item-not-found");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",404);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorItemNotFoundMixin=e}),98);
__d("WASmaxInPreKeysRequestErrorsFetchDigest",["WAResultOrError","WASmaxInPreKeysIQErrorFallbackClientMixin","WASmaxInPreKeysIQErrorItemNotFoundMixin","WASmaxInPreKeysIQErrorNotAcceptableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysIQErrorNotAcceptableMixin").parseIQErrorNotAcceptableMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorNotAcceptable",value:t.value});var n=o("WASmaxInPreKeysIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(e);if(n.success)return o("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:n.value});var r=o("WASmaxInPreKeysIQErrorFallbackClientMixin").parseIQErrorFallbackClientMixin(e);return r.success?o("WAResultOrError").makeResult({name:"IQErrorFallbackClient",value:r.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorNotAcceptable","IQErrorItemNotFound","IQErrorFallbackClient"],[t,n,r])}l.parseRequestErrorsFetchDigest=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrorsFetchDigest","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrorsFetchDigest").parseRequestErrorsFetchDigest(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrorsFetchDigest:i.value})):i}l.parseFetchDigestResponseRequestError=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseFetchDigestResponseServerError=e}),98);
__d("WASmaxInPreKeysKeysHashMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"hash");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytesRange(t.value,20,20);return n.success?o("WAResultOrError").makeResult({hashElementValue:n.value}):n}l.parseKeysHashMixin=e}),98);
__d("WASmaxInPreKeysPreKeyIDListMixin",["WAResultOrError","WASmaxInPreKeysKeyIDMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"id");if(!t.success)return t;var n=o("WASmaxInPreKeysKeyIDMixin").parseKeyIDMixin(e);return n.success,n}function s(t){var n=o("WASmaxParseUtils").flattenedChildWithTag(t,"list");if(!n.success)return n;var r=o("WASmaxParseUtils").mapChildrenWithTag(n.value,"id",0,2e4,e);return r.success?o("WAResultOrError").makeResult({listId:r.value}):r}l.parsePreKeyIDListListId=e,l.parsePreKeyIDListMixin=s}),98);
__d("WASmaxInPreKeysIdentityDigestBundleMixin",["WAResultOrError","WASmaxInPreKeysIdentityKeyMixin","WASmaxInPreKeysKeyTypeMixin","WASmaxInPreKeysKeysHashMixin","WASmaxInPreKeysPreKeyIDListMixin","WASmaxInPreKeysRegistrationIDMixin","WASmaxInPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysRegistrationIDMixin").parseRegistrationIDMixin(e);if(!t.success)return t;var n=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(e);if(!n.success)return n;var r=o("WASmaxInPreKeysPreKeyIDListMixin").parsePreKeyIDListMixin(e);if(!r.success)return r;var a=o("WASmaxInPreKeysSignedPreKeyMixin").parseSignedPreKeyMixin(e);if(!a.success)return a;var i=o("WASmaxInPreKeysKeyTypeMixin").parseKeyTypeMixin(e),l=o("WASmaxInPreKeysKeysHashMixin").parseKeysHashMixin(e);return l.success?o("WAResultOrError").makeResult(babelHelpers.extends({},t.value,n.value,r.value,a.value,{keyTypeMixin:i.success?i.value:null},l.value)):l}l.parseIdentityDigestBundleMixin=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseSuccess",["WAResultOrError","WASmaxInPreKeysIQResultResponseMixin","WASmaxInPreKeysIdentityDigestBundleMixin","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"digest");if(!r.success)return r;var a=o("WASmaxParseReference").optionalAttrStringFromReference(t,["digest","identity_type"]);if(!a.success)return a;var i=o("WASmaxParseUtils").optionalLiteral(o("WASmaxParseUtils").attrString,r.value,"identity_type",a.value);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityDigestBundleMixin").parseIdentityDigestBundleMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({hasDigestIdentityType:i.value!=null,digestIdentityDigestBundleMixin:l.value},s.value)):s}l.parseFetchDigestResponseSuccess=e}),98);
__d("WASmaxOutPreKeysFetchDigestRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"get"},o("WASmaxJsx").smax("digest",null)));return e}l.makeFetchDigestRequest=e}),98);
__d("WASmaxPreKeysFetchDigestRPC",["WAComms","WASmaxInPreKeysFetchDigestResponseRequestError","WASmaxInPreKeysFetchDigestResponseServerError","WASmaxInPreKeysFetchDigestResponseSuccess","WASmaxOutPreKeysFetchDigestRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("WASmaxOutPreKeysFetchDigestRequest").makeFetchDigestRequest(),n=yield o("WAComms").sendSmaxStanza(t,e),r=o("WASmaxInPreKeysFetchDigestResponseSuccess").parseFetchDigestResponseSuccess(n,t);if(r.success)return{name:"FetchDigestResponseSuccess",value:r.value};var a=o("WASmaxInPreKeysFetchDigestResponseRequestError").parseFetchDigestResponseRequestError(n,t);if(a.success)return{name:"FetchDigestResponseRequestError",value:a.value};var i=o("WASmaxInPreKeysFetchDigestResponseServerError").parseFetchDigestResponseServerError(n,t);if(i.success)return{name:"FetchDigestResponseServerError",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("FetchDigest",{Success:r,RequestError:a,ServerError:i}))}),s.apply(this,arguments)}l.sendFetchDigestRPC=e}),98);
__d("WARequestPreKeyDigestProtocol",["WABinary","WAConvertRegistrationIdMixin","WAConvertSignedPreKeyMixin","WACryptoDependencies","WACryptoUtils","WAParsableXmlNode","WAResultOrError","WASignalKeys","WASmaxPreKeysFetchDigestRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["requestPreKeyDigestProtocol"]);function c(t){return o("WASmaxPreKeysFetchDigestRPC").sendFetchDigestRPC({withoutRetry:!1}).then(function(n){switch(n.name){case"FetchDigestResponseServerError":{var r=n.value.errorServerErrors.name;return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,r),o("WAResultOrError").makeError({type:"server-error",payload:r})}case"FetchDigestResponseRequestError":{var a=n.value.errorRequestErrorsFetchDigest.name;return u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,a),o("WAResultOrError").makeError({type:"request-error",payload:a})}default:{n.name;var i=d(n.value.digestIdentityDigestBundleMixin);return m(i,t).then(function(e){return e==="ok"?o("WAResultOrError").makeResult():o("WAResultOrError").makeError({type:"compare-error",payload:e})})}}})}function d(e){var t=o("WAConvertRegistrationIdMixin").registrationIdMixin(e),n=o("WAConvertSignedPreKeyMixin").convertSignedPreKeyMixin(e),r=e.listId.map(function(e){return o("WASignalKeys").castToPreKeyId(o("WAParsableXmlNode").convertBytesToUint(e.elementValue,3))}),a=e.hashElementValue;return{regId:t,skeyId:n.id,preKeyIds:r,hash:a}}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if(e.regId!==t.regInfo.regId)return"RegIdMismatch";if(e.skeyId!==t.signedPreKey.id)return"SignedPreKeyIdMismatch";var n=new Map;t.preKeys.forEach(function(e){return n.set(e.id,e)});var r=e.preKeyIds.some(function(e){return!n.has(e)});if(r)return"UnknownPreKey";var a=e.preKeyIds.map(function(e){return n.get(e)}).filter(Boolean),i=yield _(t,a);return o("WACryptoUtils").uint8ArraysEqual(i,e.hash)?"ok":"HashMismatch"}),p.apply(this,arguments)}function _(e,t){var n=new(o("WABinary")).Binary;return n.writeByteArray(e.regInfo.staticKeyPair.publicKey),n.writeByteArray(e.signedPreKey.keyPair.publicKey),n.writeByteArray(e.signedPreKey.signature),t.forEach(function(e){n.writeByteArray(e.keyPair.publicKey)}),o("WACryptoDependencies").getCrypto().subtle.digest("SHA-1",n.readByteArrayView()).then(function(e){return new Uint8Array(e)})}l.requestPreKeyDigestProtocol=c}),98);
__d("WARequestPreKeyDigest",["WABridge","WAGenerateAndUploadPreKeys","WAGetKeysForUpload","WAGlobals","WALogger","WAOdsEnums","WARequestPreKeyDigestProtocol","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t(function(e){var t=e.cryptoManager;return o("WAGetKeysForUpload").getKeysForUpload(t)}),a=yield o("WARequestPreKeyDigestProtocol").requestPreKeyDigestProtocol(n.value);if(a.success===!1){if(o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"fail"}),a.error.type==="compare-error"){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["PreKey digest comparison failed: ",""])),a.error.payload),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys({reason:"prekey digest comparison failed"}).catch(function(e){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)});return}throw r("err")("Error while requesting key digest: "+a.error.type+" "+a.error.payload)}a.success,o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"success"})}),c.apply(this,arguments)}function d(){return u(function(e){return o("WAGlobals").getWaOneQueue().enqueue(e,{operationType:"request_prekey_digest",flush:!1})})}l.requestPreKeyDigestFn=u,l.requestPreKeyDigest=d}),98);
__d("WASmaxInPreKeysRotateSignedResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrors").parseRequestErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrors:i.value})):i}l.parseRotateSignedResponseRequestError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseRotateSignedResponseServerError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseSuccess",["WASmaxInPreKeysIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return r.success,r}l.parseRotateSignedResponseSuccess=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseValidationError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysIdentityKeyMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxParseUtils").attrString(r.value,"text");if(!a.success)return a;var i=o("WASmaxParseUtils").attrIntRange(r.value,"code",400,499);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({errorText:a.value,errorCode:i.value,errorIdentityKeyMixin:l.value},s.value)):s}l.parseRotateSignedResponseValidationError=e}),98);
__d("WASmaxOutPreKeysRotateSignedRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin","WASmaxOutPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.signedPreKeyMixinArgs,n=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"set"},o("WASmaxOutPreKeysSignedPreKeyMixin").mergeSignedPreKeyMixin(o("WASmaxJsx").smax("rotate",null),t)));return n}l.makeRotateSignedRequest=e}),98);
__d("WASmaxPreKeysRotateSignedRPC",["WAComms","WASmaxInPreKeysRotateSignedResponseRequestError","WASmaxInPreKeysRotateSignedResponseServerError","WASmaxInPreKeysRotateSignedResponseSuccess","WASmaxInPreKeysRotateSignedResponseValidationError","WASmaxOutPreKeysRotateSignedRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=o("WASmaxOutPreKeysRotateSignedRequest").makeRotateSignedRequest(e),r=yield o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInPreKeysRotateSignedResponseSuccess").parseRotateSignedResponseSuccess(r,n);if(a.success)return{name:"RotateSignedResponseSuccess",value:a.value};var i=o("WASmaxInPreKeysRotateSignedResponseValidationError").parseRotateSignedResponseValidationError(r,n);if(i.success)return{name:"RotateSignedResponseValidationError",value:i.value};var l=o("WASmaxInPreKeysRotateSignedResponseRequestError").parseRotateSignedResponseRequestError(r,n);if(l.success)return{name:"RotateSignedResponseRequestError",value:l.value};var s=o("WASmaxInPreKeysRotateSignedResponseServerError").parseRotateSignedResponseServerError(r,n);if(s.success)return{name:"RotateSignedResponseServerError",value:s.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("RotateSigned",{Success:a,ValidationError:i,RequestError:l,ServerError:s}))}),s.apply(this,arguments)}l.sendRotateSignedRPC=e}),98);
__d("WARotateSignedPreKeyProtocol",["WACryptoManager","WAErrorMessage","WAGlobals","WAHandleFailureUtils","WAMakeSignedPreKeyMixin","WAResultOrError","WASmaxPreKeysRotateSignedRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("WATagsLogger").TAGS(["rotateSignedPreKeyProtocol"]);function _(){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){p.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start generating skey..."])));try{var t=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WACryptoManager").generateSignedPreKey(t)},{operationType:"generate_signed_prekey",flush:!0,afterInit:!0});p.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["generated skey. Start rotating skey..."])));var n=yield o("WASmaxPreKeysRotateSignedRPC").sendRotateSignedRPC({signedPreKeyMixinArgs:o("WAMakeSignedPreKeyMixin").makeSignedPreKeyMixin(t)});switch(n.name){case"RotateSignedResponseValidationError":{var r=n.value,a=r.errorCode,i=r.errorIdentityKeyMixin,l=r.errorText;return p.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ValidationError: "," ",""])),a,l),o("WAResultOrError").makeError({type:"validation-error",identity:i.elementValue})}case"RotateSignedResponseRequestError":{var _=n.value.errorRequestErrors.value.code,f=n.value.errorRequestErrors.name;return p.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["RequestError: "," ",""])),_,f),o("WAResultOrError").makeError({type:"request-error"})}case"RotateSignedResponseServerError":{var g=n.value.errorServerErrors.value.code,h=n.value.errorServerErrors.name;return p.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["ServerError: "," ",""])),g,h),o("WAResultOrError").makeError({type:"server-error"})}default:return n.name,p.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["successfully rotated new skey"]))),o("WAResultOrError").makeResult()}}catch(e){var y=o("WAErrorMessage").maybeGetMessageFromError(e);if(y.includes("No lastSignedPrekeyId and registration"))return yield o("WAHandleFailureUtils").reregisterPhone(),o("WAResultOrError").makeError({type:"no-prekey-reregistered"});throw e}}),f.apply(this,arguments)}l.rotateSignedPreKeyProtocol=_}),98);
__d("WARotateSignedPreKey",["Promise","WAGenerateAndUploadPreKeys","WALoggerTag","WARotateSignedPreKeyProtocol","WATagsLogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS([r("WALoggerTag").SignedPrekeyRotation,r("WALoggerTag").SignedPrekey]);function m(){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield o("WARotateSignedPreKeyProtocol").rotateSignedPreKeyProtocol();if(!(t.success||t.error.type==="no-prekey-reregistered")){if(t.error.type==="validation-error")return d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Signed prekey failed server validation. need to upload all keys."]))),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys({reason:"signed prekey failed server validation"}).catch(function(e){d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)}),(c||(c=n("Promise"))).resolve();throw d.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["rotateSignedPreKey failed."]))),r("err")("rotateSignedPreKey RPC failed: "+t.error.type)}}),p.apply(this,arguments)}l.rotateSignedPreKey=m}),98);